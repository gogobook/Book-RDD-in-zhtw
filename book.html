<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Test-Driven Development with Python</title>
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="book">
<div id="header">
<h1>Test-Driven Development with Python</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_praise_for_em_test_driven_development_with_python_em">Praise for <em>Test-Driven Development with Python</em></a></li>
<li><a href="#preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#_why_i_wrote_a_book_about_test_driven_development">Why I Wrote a Book About Test-Driven Development</a></li>
<li><a href="#_aims_of_this_book">Aims of This Book</a></li>
<li><a href="#_outline">Outline</a></li>
<li><a href="#_conventions_used_in_this_book">Conventions Used in This Book</a></li>
<li><a href="#_submitting_errata">Submitting Errata</a></li>
<li><a href="#_using_code_examples">Using Code Examples</a></li>
<li><a href="#_o_reilly_safari">O&#8217;Reilly Safari</a></li>
<li><a href="#_contacting_o_reilly">Contacting O&#8217;Reilly</a></li>
</ul>
</li>
<li><a href="#pre-requisites">Prerequisites and Assumptions</a>
<ul class="sectlevel2">
<li><a href="#_python_3_6_and_programming">Python 3.6 and Programming</a></li>
<li><a href="#_how_html_works">How HTML Works</a></li>
<li><a href="#_django">Django</a></li>
<li><a href="#_javascript">JavaScript</a></li>
<li><a href="#_required_software_installations">Required Software Installations</a></li>
<li><a href="#_setting_up_your_virtualenv">Setting Up Your Virtualenv</a></li>
<li><a href="#_installing_django_and_selenium">Installing Django and Selenium</a></li>
<li><a href="#_some_error_messages_you_re_likely_to_see_when_you_em_inevitably_em_fail_to_activate_your_virtualenv">Some Error Messages You&#8217;re Likely to See When You <em>Inevitably</em> Fail to Activate Your Virtualenv</a></li>
</ul>
</li>
<li><a href="#video_plug">Companion Video</a></li>
<li><a href="#_acknowledgments">Acknowledgments</a>
<ul class="sectlevel2">
<li><a href="#_additional_thanks_for_the_second_edition">Additional Thanks for the Second Edition</a></li>
</ul>
</li>
<li><a href="#chapter_01">1. Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a>
<ul class="sectlevel2">
<li><a href="#_obey_the_testing_goat_do_nothing_until_you_have_a_test">1.1. Obey the Testing Goat! Do Nothing Until You Have a Test</a></li>
<li><a href="#_getting_django_up_and_running">1.2. Getting Django Up and Running</a></li>
<li><a href="#_starting_a_git_repository">1.3. Starting a Git Repository</a></li>
</ul>
</li>
<li><a href="#chapter_02_unittest">2. Extending Our Functional Test Using <span class="keep-together">the unittest Module</span></a>
<ul class="sectlevel2">
<li><a href="#_using_a_functional_test_to_scope_out_a_minimum_span_class_keep_together_viable_app_span">2.1. Using a Functional Test to Scope Out a Minimum <span class="keep-together">Viable App</span></a></li>
<li><a href="#_the_python_standard_library_s_unittest_module">2.2. The Python Standard Library&#8217;s unittest Module</a></li>
<li><a href="#_commit">2.3. Commit</a></li>
</ul>
</li>
<li><a href="#chapter_unit_test_first_view">3. Testing a Simple Home Page with <span class="keep-together">Unit Tests</span></a>
<ul class="sectlevel2">
<li><a href="#_our_first_django_app_and_our_first_unit_test">3.1. Our First Django App, and Our First Unit Test</a></li>
<li><a href="#_unit_tests_and_how_they_differ_from_functional_tests">3.2. Unit Tests, and How They Differ from Functional Tests</a></li>
<li><a href="#_unit_testing_in_django">3.3. Unit Testing in Django</a></li>
<li><a href="#_django_s_mvc_urls_and_view_functions">3.4. Django&#8217;s MVC, URLs, and View Functions</a></li>
<li><a href="#_at_last_we_actually_write_some_application_code">3.5. At Last! We Actually Write Some Application Code!</a></li>
<li><a href="#_urls_py">3.6. urls.py</a></li>
<li><a href="#_unit_testing_a_view">3.7. Unit Testing a View</a></li>
</ul>
</li>
<li><a href="#chapter_philosophy_and_refactoring">4. What Are We Doing with All These Tests? (And, Refactoring)</a>
<ul class="sectlevel2">
<li><a href="#_programming_is_like_pulling_a_bucket_of_water_up_span_class_keep_together_from_a_well_span">4.1. Programming Is Like Pulling a Bucket of Water Up <span class="keep-together">from a Well</span></a></li>
<li><a href="#_using_selenium_to_test_user_interactions">4.2. Using Selenium to Test User Interactions</a></li>
<li><a href="#_the_don_t_test_constants_rule_and_templates_to_the_rescue">4.3. The &#8220;Don&#8217;t Test Constants&#8221; Rule, and Templates to the Rescue</a></li>
<li><a href="#_on_refactoring">4.4. On Refactoring</a></li>
<li><a href="#_a_little_more_of_our_front_page">4.5. A Little More of Our Front Page</a></li>
<li><a href="#_recap_the_tdd_process">4.6. Recap: The TDD Process</a></li>
</ul>
</li>
<li><a href="#chapter_post_and_database">5. Saving User Input: Testing the Database</a>
<ul class="sectlevel2">
<li><a href="#_wiring_up_our_form_to_send_a_post_request">5.1. Wiring Up Our Form to Send a POST Request</a></li>
<li><a href="#_processing_a_post_request_on_the_server">5.2. Processing a POST Request on the Server</a></li>
<li><a href="#_passing_python_variables_to_be_rendered_in_the_template">5.3. Passing Python Variables to Be Rendered in the Template</a></li>
<li><a href="#_three_strikes_and_refactor">5.4. Three Strikes and Refactor</a></li>
<li><a href="#_the_django_orm_and_our_first_model">5.5. The Django ORM and Our First Model</a></li>
<li><a href="#_saving_the_post_to_the_database">5.6. Saving the POST to the Database</a></li>
<li><a href="#_redirect_after_a_post">5.7. Redirect After a POST</a></li>
<li><a href="#_rendering_items_in_the_template">5.8. Rendering Items in the Template</a></li>
<li><a href="#_creating_our_production_database_with_migrate">5.9. Creating Our Production Database with migrate</a></li>
<li><a href="#_recap">5.10. Recap</a></li>
</ul>
</li>
<li><a href="#chapter_explicit_waits_1">6. Improving Functional Tests: Ensuring Isolation and Removing Voodoo Sleeps</a>
<ul class="sectlevel2">
<li><a href="#_ensuring_test_isolation_in_functional_tests">6.1. Ensuring Test Isolation in Functional Tests</a></li>
<li><a href="#_aside_upgrading_selenium_and_geckodriver">6.2. Aside: Upgrading Selenium and Geckodriver</a></li>
<li><a href="#_on_implicit_and_explicit_waits_and_voodoo_time_sleeps">6.3. On Implicit and Explicit Waits, and Voodoo time.sleeps</a></li>
</ul>
</li>
<li><a href="#chapter_working_incrementally">7. Working Incrementally</a>
<ul class="sectlevel2">
<li><a href="#_small_design_when_necessary">7.1. Small Design When Necessary</a></li>
<li><a href="#_implementing_the_new_design_incrementally_using_tdd">7.2. Implementing the New Design Incrementally Using TDD</a></li>
<li><a href="#_ensuring_we_have_a_regression_test">7.3. Ensuring We Have a Regression Test</a></li>
<li><a href="#_iterating_towards_the_new_design">7.4. Iterating Towards the New Design</a></li>
<li><a href="#_taking_a_first_self_contained_step_one_new_url">7.5. Taking a First, Self-Contained Step: One New URL</a></li>
<li><a href="#_green_refactor">7.6. Green? Refactor</a></li>
<li><a href="#_another_small_step_a_separate_template_for_viewing_lists">7.7. Another Small Step: A Separate Template for Viewing Lists</a></li>
<li><a href="#_a_third_small_step_a_url_for_adding_list_items">7.8. A Third Small Step: A URL for Adding List Items</a></li>
<li><a href="#_biting_the_bullet_adjusting_our_models">7.9. Biting the Bullet: Adjusting Our Models</a></li>
<li><a href="#_each_list_should_have_its_own_url">7.10. Each List Should Have Its Own URL</a></li>
<li><a href="#_the_functional_tests_detect_another_regression">7.11. The Functional Tests Detect Another Regression</a></li>
<li><a href="#_one_more_view_to_handle_adding_items_to_an_existing_list">7.12. One More View to Handle Adding Items to an Existing List</a></li>
<li><a href="#_a_final_refactor_using_url_includes">7.13. A Final Refactor Using URL includes</a></li>
</ul>
</li>
<li><a href="#chapter_prettification">8. Prettification: Layout and Styling, and What to Test About It</a>
<ul class="sectlevel2">
<li><a href="#_what_to_functionally_test_about_layout_and_style">8.1. What to Functionally Test About Layout and Style</a></li>
<li><a href="#_prettification_using_a_css_framework">8.2. Prettification: Using a CSS Framework</a></li>
<li><a href="#_django_template_inheritance">8.3. Django Template Inheritance</a></li>
<li><a href="#_integrating_bootstrap">8.4. Integrating Bootstrap</a></li>
<li><a href="#_static_files_in_django">8.5. Static Files in Django</a></li>
<li><a href="#_using_bootstrap_components_to_improve_the_look_of_the_site">8.6. Using Bootstrap Components to Improve the Look of the Site</a></li>
<li><a href="#_using_our_own_css">8.7. Using Our Own CSS</a></li>
<li><a href="#_what_we_glossed_over_collectstatic_and_other_static_directories">8.8. What We Glossed Over: collectstatic and Other Static Directories</a></li>
<li><a href="#_a_few_things_that_didn_t_make_it">8.9. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="#chapter_manual_deployment">9. Testing Deployment Using a Staging Site</a>
<ul class="sectlevel2">
<li><a href="#_tdd_and_the_danger_areas_of_deployment">9.1. TDD and the Danger Areas of Deployment</a></li>
<li><a href="#_as_always_start_with_a_test">9.2. As Always, Start with a Test</a></li>
<li><a href="#_getting_a_domain_name">9.3. Getting a Domain Name</a></li>
<li><a href="#_manually_provisioning_a_server_to_host_our_site">9.4. Manually Provisioning a Server to Host Our Site</a></li>
<li><a href="#_deploying_our_code_manually">9.5. Deploying Our Code Manually</a></li>
<li><a href="#_debugging_a_deployment_that_doesn_t_seem_to_work_at_all">9.6. Debugging a Deployment That Doesn&#8217;t Seem to Work at All</a></li>
<li><a href="#_hacking_allowed_hosts_in_settings_py">9.7. Hacking ALLOWED_HOSTS in settings.py</a></li>
<li><a href="#_creating_the_database_with_migrate">9.8. Creating the Database with migrate</a></li>
<li><a href="#_success_our_hack_deployment_works">9.9. Success!  Our Hack Deployment Works</a></li>
</ul>
</li>
<li><a href="#chapter_making_deployment_production_ready">10. Getting to a Production-Ready Deployment</a>
<ul class="sectlevel2">
<li><a href="#_what_we_need_to_do">10.1. What We Need to Do</a></li>
<li><a href="#_switching_to_nginx">10.2. Switching to Nginx</a></li>
<li><a href="#_switching_to_gunicorn">10.3. Switching to Gunicorn</a></li>
<li><a href="#_getting_nginx_to_serve_static_files">10.4. Getting Nginx to Serve Static Files</a></li>
<li><a href="#_switching_to_using_unix_sockets">10.5. Switching to Using Unix Sockets</a></li>
<li><a href="#_using_environment_variables_to_adjust_settings_for_production">10.6. Using Environment Variables to Adjust Settings for Production</a></li>
<li><a href="#_essential_googling_the_error_message">10.7. Essential Googling the Error Message</a></li>
<li><a href="#_using_a_env_file_to_store_our_environment_variables">10.8. Using a .env File to Store Our Environment Variables</a></li>
<li><a href="#_using_systemd_to_make_sure_gunicorn_starts_on_boot">10.9. Using Systemd to Make Sure Gunicorn Starts on Boot</a></li>
<li><a href="#_thinking_about_automating">10.10. Thinking About Automating</a></li>
<li><a href="#_saving_our_progress">10.11. Saving Our Progress</a></li>
</ul>
</li>
<li><a href="#chapter_automate_deployment_with_fabric">11. Automating Deployment with Fabric</a>
<ul class="sectlevel2">
<li><a href="#_breakdown_of_a_fabric_script_for_our_deployment">11.1. Breakdown of a Fabric Script for Our Deployment</a></li>
<li><a href="#_trying_it_out">11.2. Trying It Out</a></li>
<li><a href="#_provisioning_nginx_and_gunicorn_config_using_sed">11.3. Provisioning: Nginx and Gunicorn Config Using sed</a></li>
<li><a href="#_git_tag_the_release">11.4. Git Tag the Release</a></li>
<li><a href="#_further_reading">11.5. Further Reading</a></li>
</ul>
</li>
<li><a href="#chapter_organising_test_files">12. Splitting Our Tests into Multiple Files, and a Generic Wait Helper</a>
<ul class="sectlevel2">
<li><a href="#_start_on_a_validation_ft_preventing_blank_items">12.1. Start on a Validation FT: Preventing Blank Items</a></li>
<li><a href="#_a_new_functional_test_tool_a_generic_explicit_wait_helper">12.2. A New Functional Test Tool: A Generic Explicit Wait Helper</a></li>
<li><a href="#_finishing_off_the_ft">12.3. Finishing Off the FT</a></li>
<li><a href="#_refactoring_unit_tests_into_several_files">12.4. Refactoring Unit Tests into Several Files</a></li>
</ul>
</li>
<li><a href="#chapter_database_layer_validation">13. Validation at the Database Layer</a>
<ul class="sectlevel2">
<li><a href="#_model_layer_validation">13.1. Model-Layer Validation</a></li>
<li><a href="#_surfacing_model_validation_errors_in_the_view">13.2. Surfacing Model Validation Errors in the View</a></li>
<li><a href="#_django_pattern_processing_post_requests_in_the_same_view_as_renders_the_form">13.3. Django Pattern: Processing POST Requests in the Same View as Renders the Form</a></li>
<li><a href="#_refactor_removing_hardcoded_urls">13.4. Refactor: Removing Hardcoded URLs</a></li>
</ul>
</li>
<li><a href="#chapter_simple_form">14. A Simple Form</a>
<ul class="sectlevel2">
<li><a href="#_moving_validation_logic_into_a_form">14.1. Moving Validation Logic into a Form</a></li>
<li><a href="#_using_the_form_in_our_views">14.2. Using the Form in Our Views</a></li>
<li><a href="#_using_the_form_in_a_view_that_takes_post_requests">14.3. Using the Form in a View That Takes POST Requests</a></li>
<li><a href="#_using_the_form_in_the_other_view">14.4. Using the Form in the Other View</a></li>
<li><a href="#_a_pat_on_the_back">14.5. A Pat on the Back</a></li>
<li><a href="#_but_have_we_wasted_a_lot_of_time">14.6. But Have We Wasted a Lot of Time?</a></li>
<li><a href="#_using_the_form_s_own_save_method">14.7. Using the Form&#8217;s Own Save Method</a></li>
</ul>
</li>
<li><a href="#chapter_advanced_forms">15. More Advanced Forms</a>
<ul class="sectlevel2">
<li><a href="#_another_ft_for_duplicate_items">15.1. Another FT for Duplicate Items</a></li>
<li><a href="#_experimenting_with_duplicate_item_validation_at_the_views_layer">15.2. Experimenting with Duplicate Item Validation at the Views Layer</a></li>
<li><a href="#_a_more_complex_form_to_handle_uniqueness_validation">15.3. A More Complex Form to Handle Uniqueness Validation</a></li>
<li><a href="#_using_the_existing_list_item_form_in_the_list_view">15.4. Using the Existing List Item Form in the List View</a></li>
<li><a href="#_wrapping_up_what_we_ve_learned_about_testing_django">15.5. Wrapping Up: What We&#8217;ve Learned About Testing Django</a></li>
</ul>
</li>
<li><a href="#chapter_javascript">16. Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></a>
<ul class="sectlevel2">
<li><a href="#_starting_with_an_ft">16.1. Starting with an FT</a></li>
<li><a href="#_setting_up_a_basic_javascript_test_runner">16.2. Setting Up a Basic JavaScript Test Runner</a></li>
<li><a href="#_using_jquery_and_the_fixtures_div">16.3. Using jQuery and the Fixtures Div</a></li>
<li><a href="#_building_a_javascript_unit_test_for_our_desired_functionality">16.4. Building a JavaScript Unit Test for Our Desired Functionality</a></li>
<li><a href="#_fixtures_execution_order_and_global_state_key_challenges_of_js_testing">16.5. Fixtures, Execution Order, and Global State: Key Challenges of JS Testing</a></li>
<li><a href="#_columbo_says_onload_boilerplate_and_namespacing">16.6. Columbo Says: Onload Boilerplate and Namespacing</a></li>
<li><a href="#_javascript_testing_in_the_tdd_cycle">16.7. JavaScript Testing in the TDD Cycle</a></li>
<li><a href="#_a_few_things_that_didn_t_make_it_2">16.8. A Few Things That Didn&#8217;t Make It</a></li>
</ul>
</li>
<li><a href="#chapter_deploying_validation">17. Deploying Our New Code</a>
<ul class="sectlevel2">
<li><a href="#_staging_deploy">17.1. Staging Deploy</a></li>
<li><a href="#_live_deploy">17.2. Live Deploy</a></li>
<li><a href="#_what_to_do_if_you_see_a_database_error">17.3. What to Do If You See a Database Error</a></li>
<li><a href="#_wrap_up_git_tag_the_new_release">17.4. Wrap-Up: git tag the New Release</a></li>
</ul>
</li>
<li><a href="#chapter_spiking_custom_auth">18. User Authentication, Spiking, and <span class="keep-together">De-Spiking</span></a>
<ul class="sectlevel2">
<li><a href="#_passwordless_auth">18.1. Passwordless Auth</a></li>
<li><a href="#_exploratory_coding_aka_spiking">18.2. Exploratory Coding, aka "Spiking"</a></li>
<li><a href="#_de_spiking">18.3. De-spiking</a></li>
<li><a href="#_a_minimal_custom_user_model">18.4. A Minimal Custom User Model</a></li>
<li><a href="#_a_token_model_to_link_emails_with_a_unique_id">18.5. A Token Model to Link Emails with a Unique ID</a></li>
</ul>
</li>
<li><a href="#chapter_mocking">19. Using Mocks to Test External Dependencies or Reduce Duplication</a>
<ul class="sectlevel2">
<li><a href="#_before_we_start_getting_the_basic_plumbing_in">19.1. Before We Start: Getting the Basic Plumbing In</a></li>
<li><a href="#_mocking_manually_aka_monkeypatching">19.2. Mocking Manually, aka Monkeypatching</a></li>
<li><a href="#_the_python_mock_library">19.3. The Python Mock Library</a></li>
<li><a href="#_de_spiking_our_custom_authentication_backend">19.4. De-spiking Our Custom Authentication Backend</a></li>
<li><a href="#_an_alternative_reason_to_use_mocks_reducing_duplication">19.5. An Alternative Reason to Use Mocks: Reducing Duplication</a></li>
<li><a href="#_the_moment_of_truth_will_the_ft_pass">19.6. The Moment of Truth:  Will the FT Pass?</a></li>
<li><a href="#_it_works_in_theory_does_it_work_in_practice">19.7. It Works in Theory!  Does It Work in Practice?</a></li>
<li><a href="#_finishing_off_our_ft_testing_logout">19.8. Finishing Off Our FT, Testing Logout</a></li>
</ul>
</li>
<li><a href="#chapter_fixtures_and_wait_decorator">20. Test Fixtures and a Decorator for <span class="keep-together">Explicit Waits</span></a>
<ul class="sectlevel2">
<li><a href="#_skipping_the_login_process_by_pre_creating_a_session">20.1. Skipping the Login Process by Pre-creating a Session</a></li>
<li><a href="#_our_final_explicit_wait_helper_a_wait_decorator">20.2. Our Final Explicit Wait Helper: A Wait Decorator</a></li>
</ul>
</li>
<li><a href="#chapter_server_side_debugging">21. Server-Side Debugging</a>
<ul class="sectlevel2">
<li><a href="#_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">21.1. The Proof Is in the Pudding: Using Staging to Catch Final Bugs</a></li>
<li><a href="#_inspecting_logs_on_the_server">21.2. Inspecting Logs on the Server</a></li>
<li><a href="#_another_environment_variable">21.3. Another Environment Variable</a></li>
<li><a href="#_adapting_our_ft_to_be_able_to_test_real_emails_via_pop3">21.4. Adapting Our FT to Be Able to Test Real Emails via POP3</a></li>
<li><a href="#_managing_the_test_database_on_staging">21.5. Managing the Test Database on Staging</a></li>
<li><a href="#_updating_our_deploy_script">21.6. Updating our Deploy Script</a></li>
<li><a href="#_wrap_up">21.7. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_outside_in">22. Finishing "My Lists": Outside-In TDD</a>
<ul class="sectlevel2">
<li><a href="#_the_alternative_inside_out">22.1. The Alternative: "Inside-Out"</a></li>
<li><a href="#_why_prefer_outside_in">22.2. Why Prefer "Outside-In"?</a></li>
<li><a href="#_the_ft_for_my_lists">22.3. The FT for "My Lists"</a></li>
<li><a href="#_the_outside_layer_presentation_and_templates">22.4. The Outside Layer: Presentation and Templates</a></li>
<li><a href="#_moving_down_one_layer_to_view_functions_the_controller">22.5. Moving Down One Layer to View Functions (the Controller)</a></li>
<li><a href="#_another_pass_outside_in">22.6. Another Pass, Outside-In</a></li>
<li><a href="#_the_next_requirement_from_the_views_layer_new_lists_should_record_owner">22.7. The Next "Requirement" from the Views Layer: New Lists Should Record Owner</a></li>
<li><a href="#_moving_down_to_the_model_layer">22.8. Moving Down to the Model Layer</a></li>
</ul>
</li>
<li><a href="#chapter_purist_unit_tests">23. Test Isolation, and "Listening to Your Tests"</a>
<ul class="sectlevel2">
<li><a href="#_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">23.1. Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</a></li>
<li><a href="#_a_first_attempt_at_using_mocks_for_isolation">23.2. A First Attempt at Using Mocks for Isolation</a></li>
<li><a href="#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">23.3. Listen to Your Tests: Ugly Tests Signal a Need to Refactor</a></li>
<li><a href="#_rewriting_our_tests_for_the_view_to_be_fully_isolated">23.4. Rewriting Our Tests for the View to Be Fully Isolated</a></li>
<li><a href="#_moving_down_to_the_forms_layer">23.5. Moving Down to the Forms Layer</a></li>
<li><a href="#_finally_moving_down_to_the_models_layer">23.6. Finally, Moving Down to the Models Layer</a></li>
<li><a href="#_the_moment_of_truth_and_the_risks_of_mocking">23.7. The Moment of Truth (and the Risks of Mocking)</a></li>
<li><a href="#_thinking_of_interactions_between_layers_as_contracts">23.8. Thinking of Interactions Between Layers as "Contracts"</a></li>
<li><a href="#_one_more_test">23.9. One More Test</a></li>
<li><a href="#_tidy_up_what_to_keep_from_our_integrated_test_suite">23.10. Tidy Up: What to Keep from Our Integrated Test Suite</a></li>
<li><a href="#_conclusions_when_to_write_isolated_versus_integrated_tests">23.11. Conclusions: When to Write Isolated Versus Integrated Tests</a></li>
</ul>
</li>
<li><a href="#chapter_CI">24. Continuous Integration (CI)</a>
<ul class="sectlevel2">
<li><a href="#_installing_jenkins">24.1. Installing Jenkins</a></li>
<li><a href="#_configuring_jenkins">24.2. Configuring Jenkins</a></li>
<li><a href="#_setting_up_our_project">24.3. Setting Up Our Project</a></li>
<li><a href="#_first_build">24.4. First Build!</a></li>
<li><a href="#_setting_up_a_virtual_display_so_the_fts_can_run_headless">24.5. Setting Up a Virtual Display So the FTs Can Run Headless</a></li>
<li><a href="#_taking_screenshots">24.6. Taking Screenshots</a></li>
<li><a href="#_if_in_doubt_try_bumping_the_timeout">24.7. If in Doubt, Try Bumping the Timeout!</a></li>
<li><a href="#_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">24.8. Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</a></li>
<li><a href="#_more_things_to_do_with_a_ci_server">24.9. More Things to Do with a CI Server</a></li>
</ul>
</li>
<li><a href="#chapter_page_pattern">25. The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>
<ul class="sectlevel2">
<li><a href="#_an_ft_with_multiple_users_and_addcleanup">25.1. An FT with Multiple Users, and addCleanup</a></li>
<li><a href="#_the_page_pattern">25.2. The Page Pattern</a></li>
<li><a href="#_extend_the_ft_to_a_second_user_and_the_my_lists_page">25.3. Extend the FT to a Second User, and the "My Lists" Page</a></li>
<li><a href="#_an_exercise_for_the_reader">25.4. An Exercise for the Reader</a></li>
</ul>
</li>
<li><a href="#chapter_hot_lava">26. Fast Tests, Slow Tests, and Hot Lava</a>
<ul class="sectlevel2">
<li><a href="#_thesis_unit_tests_are_superfast_and_good_besides_that">26.1. Thesis: Unit Tests Are Superfast and Good Besides That</a></li>
<li><a href="#_the_problems_with_pure_unit_tests">26.2. The Problems with "Pure" Unit Tests</a></li>
<li><a href="#_synthesis_what_do_we_want_from_our_tests_anyway">26.3. Synthesis: What Do We Want from Our Tests, Anyway?</a></li>
<li><a href="#_architectural_solutions">26.4. Architectural Solutions</a></li>
<li><a href="#_conclusion">26.5. Conclusion</a></li>
</ul>
</li>
<li><a href="#_obey_the_testing_goat">Appendix A: Obey the Testing Goat!</a>
<ul class="sectlevel2">
<li><a href="#_testing_is_hard">A.1. Testing Is Hard</a></li>
<li><a href="#_remember_to_tip_the_bar_staff">A.2. Remember to Tip the Bar Staff</a></li>
<li><a href="#_don_t_be_a_stranger">A.3. Don&#8217;t Be a Stranger!</a></li>
</ul>
</li>
<li><a href="#appendix1">Appendix B: PythonAnywhere</a>
<ul class="sectlevel2">
<li><a href="#_running_firefox_selenium_sessions_with_xvfb">B.1. Running Firefox Selenium Sessions with Xvfb</a></li>
<li><a href="#_setting_up_django_as_a_pythonanywhere_web_app">B.2. Setting Up Django as a PythonAnywhere Web App</a></li>
<li><a href="#_cleaning_up_tmp">B.3. Cleaning Up /tmp</a></li>
<li><a href="#_screenshots">B.4. Screenshots</a></li>
<li><a href="#_the_deployment_chapter">B.5. The Deployment Chapter</a></li>
</ul>
</li>
<li><a href="#appendix_Django_Class-Based_Views">Appendix C: Django Class-Based Views</a>
<ul class="sectlevel2">
<li><a href="#_class_based_generic_views">C.1. Class-Based Generic Views</a></li>
<li><a href="#_the_home_page_as_a_formview">C.2. The Home Page as a FormView</a></li>
<li><a href="#_using_form_valid_to_customise_a_createview">C.3. Using form_valid to Customise a CreateView</a></li>
<li><a href="#_a_more_complex_view_to_handle_both_viewing_and_adding_to_a_list">C.4. A More Complex View to Handle Both Viewing and Adding to a List</a></li>
<li><a href="#_compare_old_and_new">C.5. Compare Old and New</a></li>
<li><a href="#_best_practices_for_unit_testing_cbgvs">C.6. Best Practices for Unit Testing CBGVs?</a></li>
</ul>
</li>
<li><a href="#appendix3">Appendix D: Provisioning with Ansible</a>
<ul class="sectlevel2">
<li><a href="#_installing_system_packages_and_nginx">D.1. Installing System Packages and Nginx</a></li>
<li><a href="#_configuring_gunicorn_and_using_handlers_to_restart_services">D.2. Configuring Gunicorn, and Using Handlers to Restart Services</a></li>
<li><a href="#_what_to_do_next">D.3. What to Do Next</a></li>
</ul>
</li>
<li><a href="#data-migrations-appendix">Appendix E: Testing Database Migrations</a>
<ul class="sectlevel2">
<li><a href="#_an_attempted_deploy_to_staging">E.1. An Attempted Deploy to Staging</a></li>
<li><a href="#_running_a_test_migration_locally">E.2. Running a Test Migration Locally</a></li>
<li><a href="#_inserting_a_data_migration">E.3. Inserting a Data Migration</a></li>
<li><a href="#_testing_the_new_migrations_together">E.4. Testing the New Migrations Together</a></li>
<li><a href="#_conclusions">E.5. Conclusions</a></li>
</ul>
</li>
<li><a href="#appendix_bdd">Appendix F: Behaviour-Driven Development (BDD)</a>
<ul class="sectlevel2">
<li><a href="#_what_is_bdd">F.1. What Is BDD?</a></li>
<li><a href="#_basic_housekeeping">F.2. Basic Housekeeping</a></li>
<li><a href="#_writing_an_ft_as_a_feature_using_gherkin_syntax">F.3. Writing an FT as a "Feature" Using Gherkin Syntax</a></li>
<li><a href="#_coding_the_step_functions">F.4. Coding the Step Functions</a></li>
<li><a href="#_first_step_definition">F.5. First Step Definition</a></li>
<li><a href="#_setup_and_teardown_equivalents_in_environment_py">F.6. setUp and tearDown Equivalents in environment.py</a></li>
<li><a href="#_another_run">F.7. Another Run</a></li>
<li><a href="#_capturing_parameters_in_steps">F.8. Capturing Parameters in Steps</a></li>
<li><a href="#_comparing_the_inline_style_ft">F.9. Comparing the Inline-Style FT</a></li>
<li><a href="#_bdd_encourages_structured_test_code">F.10. BDD Encourages Structured Test Code</a></li>
<li><a href="#_the_page_pattern_as_an_alternative">F.11. The Page Pattern as an Alternative</a></li>
<li><a href="#_bdd_might_be_less_expressive_than_inline_comments">F.12. BDD Might Be Less Expressive than Inline Comments</a></li>
<li><a href="#_will_nonprogrammers_write_tests">F.13. Will Nonprogrammers Write Tests?</a></li>
<li><a href="#_some_tentative_conclusions">F.14. Some Tentative Conclusions</a></li>
</ul>
</li>
<li><a href="#appendix_rest_api">Appendix G: Building a REST API: JSON, Ajax, and Mocking with JavaScript</a>
<ul class="sectlevel2">
<li><a href="#_our_approach_for_this_appendix">G.1. Our Approach for This Appendix</a></li>
<li><a href="#_choosing_our_test_approach">G.2. Choosing Our Test Approach</a></li>
<li><a href="#_basic_piping">G.3. Basic Piping</a></li>
<li><a href="#_actually_responding_with_something">G.4. Actually Responding with Something</a></li>
<li><a href="#_adding_post">G.5. Adding POST</a></li>
<li><a href="#_testing_the_client_side_ajax_with_sinon_js">G.6. Testing the Client-Side Ajax with Sinon.js</a></li>
<li><a href="#_wiring_it_all_up_in_the_template_to_see_if_it_really_works">G.7. Wiring It All Up in the Template to See If It Really Works</a></li>
<li><a href="#_implementing_ajax_post_including_the_csrf_token">G.8. Implementing Ajax POST, Including the CSRF Token</a></li>
<li><a href="#_mocking_in_javascript">G.9. Mocking in JavaScript</a></li>
<li><a href="#_data_validation_an_exercise_for_the_reader">G.10. Data Validation:  An Exercise for the Reader?</a></li>
</ul>
</li>
<li><a href="#appendix_DjangoRestFramework">Appendix H: Django-Rest-Framework</a>
<ul class="sectlevel2">
<li><a href="#_installation_2">H.1. Installation</a></li>
<li><a href="#_serializers_well_modelserializers_really">H.2. Serializers (Well, ModelSerializers, Really)</a></li>
<li><a href="#_viewsets_well_modelviewsets_really_and_routers">H.3. Viewsets (Well, ModelViewsets, Really) and Routers</a></li>
<li><a href="#_a_different_url_for_post_item">H.4. A Different URL for POST Item</a></li>
<li><a href="#_adapting_the_client_side">H.5. Adapting the Client Side</a></li>
<li><a href="#_what_django_rest_framework_gives_you">H.6. What Django-Rest-Framework Gives You</a></li>
</ul>
</li>
<li><a href="#cheat-sheet">Appendix I: Cheat Sheet</a>
<ul class="sectlevel2">
<li><a href="#_initial_project_setup">I.1. Initial Project Setup</a></li>
<li><a href="#_the_basic_tdd_workflow">I.2. The Basic TDD Workflow</a></li>
<li><a href="#_moving_beyond_dev_only_testing">I.3. Moving Beyond Dev-Only Testing</a></li>
<li><a href="#_general_testing_best_practices">I.4. General Testing Best Practices</a></li>
<li><a href="#_selenium_functional_testing_best_practices">I.5. Selenium/Functional Testing Best Practices</a></li>
<li><a href="#_outside_in_test_isolation_versus_integrated_tests_and_mocking">I.6. Outside-In, Test Isolation Versus Integrated Tests, and Mocking</a></li>
</ul>
</li>
<li><a href="#appendix4">Appendix J: What to Do Next</a>
<ul class="sectlevel2">
<li><a href="#_notifications_both_on_the_site_and_by_email">J.1. Notifications&#8212;&#8203;Both on the Site and by Email</a></li>
<li><a href="#_switch_to_postgres">J.2. Switch to Postgres</a></li>
<li><a href="#_run_your_tests_against_different_browsers">J.3. Run Your Tests Against Different Browsers</a></li>
<li><a href="#_404_and_500_tests">J.4. 404 and 500 Tests</a></li>
<li><a href="#_the_django_admin_site">J.5. The Django Admin Site</a></li>
<li><a href="#_write_some_security_tests">J.6. Write Some Security Tests</a></li>
<li><a href="#_test_for_graceful_degradation">J.7. Test for Graceful Degradation</a></li>
<li><a href="#_caching_and_performance_testing">J.8. Caching and Performance Testing</a></li>
<li><a href="#_javascript_mvc_frameworks">J.9. JavaScript MVC Frameworks</a></li>
<li><a href="#_async_and_websockets">J.10. Async and Websockets</a></li>
<li><a href="#_switch_to_using_py_test">J.11. Switch to Using py.test</a></li>
<li><a href="#_check_out_coverage_py">J.12. Check Out coverage.py</a></li>
<li><a href="#_client_side_encryption">J.13. Client-Side Encryption</a></li>
<li><a href="#_your_suggestion_here">J.14. Your Suggestion Here</a></li>
</ul>
</li>
<li><a href="#appendix_github_links">Appendix K: Source Code Examples</a>
<ul class="sectlevel2">
<li><a href="#_full_list_of_links_for_each_chapter">K.1. Full List of Links for Each Chapter</a></li>
<li><a href="#_using_git_to_check_your_progress">K.2. Using Git to Check Your Progress</a></li>
<li><a href="#_downloading_a_zip_file_for_a_chapter">K.3. Downloading a ZIP File for a Chapter</a></li>
<li><a href="#_don_t_let_it_become_a_crutch">K.4. Don&#8217;t Let it Become a Crutch!</a></li>
</ul>
</li>
<li><a href="#_bibliography">Appendix L: Bibliography</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1 praise">
<h2 id="_praise_for_em_test_driven_development_with_python_em">Praise for <em>Test-Driven Development with Python</em></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>“In this book, Harry takes us on an adventure of discovery with Python and testing. It’s an excellent book, fun to read and full of vital information. It has my highest recommendations for anyone interested in testing with Python, learning Django or wanting to use Selenium. Testing is essential for developer sanity and it&#8217;s a notoriously difficult field, full of trade-offs. Harry does a fantastic job of holding our attention whilst exploring real world testing practices.”</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Michael Foord<br>
<cite>Python Core Developer and Maintainer of unittest</cite>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>“This book is far more than an introduction to Test Driven Development—it’s a complete best-practices crash course, from start to finish, into modern web application development with Python. Every web developer needs this book.”</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Kenneth Reitz<br>
<cite>Fellow at Python Software Foundation</cite>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>“Harry’s book is what we wish existed when we were learning Django. At a pace that’s achievable and yet delightfully challenging, it provides excellent instruction for Django and various test practices. The material on Selenium alone makes the book worth purchasing, but there&#8217;s so much more!”</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Daniel and Audrey Roy Greenfeld<br>
<cite>authors of "Two Scoops of Django" (Two Scoops Press)</cite>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book is my attempt to share with the world the journey I&#8217;ve taken from
"hacking" to "software engineering". It&#8217;s mainly about testing, but there&#8217;s a
lot more to it, as you&#8217;ll soon see.</p>
</div>
<div class="paragraph">
<p>I want to thank you for reading it.</p>
</div>
<div class="paragraph">
<p>If you bought a copy, then I&#8217;m very grateful.  If you&#8217;re reading the free
online version, then I&#8217;m <em>still</em> grateful that you&#8217;ve decided it&#8217;s worth
spending some of your time on. Who knows, perhaps once you get to the end,
you&#8217;ll decide it&#8217;s good enough to buy a real copy for yourself or for a friend.</p>
</div>
<div class="paragraph">
<p>If
you have any comments, questions, or suggestions, I&#8217;d love to hear from you.
You can reach me directly via <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>, or on Twitter
<a href="https://www.twitter.com/hjwp">@hjwp</a>.  You can also check out
<a href="http://www.obeythetestinggoat.com">the website and my blog</a>, and
there&#8217;s <a href="https://groups.google.com/forum/#!forum/obey-the-testing-goat-book">a
mailing list</a>.</p>
</div>
<div class="paragraph">
<p>I hope you&#8217;ll enjoy reading this book as much as I enjoyed writing it.</p>
</div>
<div class="sect2">
<h3 id="_why_i_wrote_a_book_about_test_driven_development">Why I Wrote a Book About Test-Driven Development</h3>
<div class="paragraph">
<p><em>&#8220;Who are you, why are you writing this book, and why should I
read it?&#8221;</em> I hear you ask.</p>
</div>
<div class="paragraph">
<p>I&#8217;m
still quite early on in my programming career.  They say that in any
discipline, you go from apprentice, to journeyman, and eventually, sometimes,
on to master.  I&#8217;d say that I&#8217;m&#8212;&#8203;at best&#8212;&#8203;a journeyman programmer.  But I
was lucky enough, early on in my career, to fall in with a bunch of TDD
fanatics, and it made such a big impact on my programming that I&#8217;m burning to
share it with everyone. You might say I have the enthusiasm of a recent
convert, and the learning experience is still a recent memory for me, so I hope
I can still empathise with beginners.</p>
</div>
<div class="paragraph">
<p>When I first learned Python (from Mark Pilgrim&#8217;s excellent
<a href="#dip"><em>Dive Into Python</em></a>), I came across the concept of TDD, and thought &#8220;Yes.
I can definitely see the sense in that.&#8221;  Perhaps you had a similar
reaction when you first heard about TDD?  It sounds like a really sensible
approach, a really good habit to get into&#8212;&#8203;like regularly flossing your
teeth.</p>
</div>
<div class="paragraph">
<p>Then came my first big project, and you can guess what happened&#8212;&#8203;there was a
client, there were deadlines, there was lots to do, and any good intentions
about TDD went straight out of the window.</p>
</div>
<div class="paragraph">
<p>And, actually, it was fine.  I was fine.</p>
</div>
<div class="paragraph">
<p>At first.</p>
</div>
<div class="paragraph">
<p>At first I knew I didn&#8217;t really need TDD because it was a small website, and I
could easily test whether things worked by just manually checking it out. Click
this link <em>here</em>, choose that drop-down item <em>there</em>, and <em>this</em> should happen.
Easy. This whole writing tests thing sounded like it would have taken <em>ages</em>,
and besides, I fancied myself, from the full height of my three weeks of adult
coding experience, as being a pretty good programmer. I could handle it. Easy.</p>
</div>
<div class="paragraph">
<p>Then came the fearful goddess Complexity. She soon showed me the limits of my
experience.</p>
</div>
<div class="paragraph">
<p>The project grew. Parts of the system started to depend on other parts. I did
my best to follow good principles like DRY (Don&#8217;t Repeat Yourself), but that
just led to some pretty dangerous territory.  Soon I was playing with multiple
inheritance. Class hierarchies eight levels deep. <code>eval</code> statements.</p>
</div>
<div class="paragraph">
<p>I became scared of making changes to my code.  I was no longer sure what
depended on what, and what might happen if I changed this code <em>over here</em>, oh
gosh, I think that bit over there inherits from it&#8212;&#8203;no, it doesn&#8217;t, it&#8217;s
overriden.  Oh, but it depends on that class variable.  Right, well, as long as
I override the override it should be fine. I&#8217;ll just check&#8212;&#8203;but checking was
getting much harder. There were lots of sections to the site now, and clicking
through them all manually was starting to get impractical.  Better to leave
well enough alone, forget refactoring, just make do.</p>
</div>
<div class="paragraph">
<p>Soon I had a hideous, ugly mess of code. New development became painful.</p>
</div>
<div class="paragraph">
<p>Not too long after this, I was lucky enough to get a job with a company called
Resolver Systems (now <a href="https://www.pythonanywhere.com">PythonAnywhere</a>), where
Extreme Programming (XP) was the norm. They introduced me to rigorous TDD.</p>
</div>
<div class="paragraph">
<p>Although my previous experience had certainly opened my mind to the possible
benefits of automated testing, I still dragged my feet at every stage.  &#8220;I
mean, testing in general might be a good idea, but <em>really</em>?  All these tests?
Some of them seem like a total waste of time&#8230;&#8203;  What? Functional tests
<em>as well as</em> unit tests? Come on, that&#8217;s overdoing it! And this TDD test/minimal-code-change/test cycle? This is just silly! We don&#8217;t need all these baby
steps! Come on, we can see what the right answer is, why don&#8217;t we just skip to
the end?&#8221;</p>
</div>
<div class="paragraph">
<p>Believe me, I second-guessed every rule, I suggested every shortcut, I demanded
justifications for every seemingly pointless aspect of TDD, and I came out
seeing the wisdom of it all. I&#8217;ve lost count of the number of times I&#8217;ve
thought &#8220;Thanks, tests&#8221;, as a functional test uncovers a regression we would
never have predicted, or a unit test saves me from making a really silly logic
error.  Psychologically, it&#8217;s made development a much less stressful
process. It produces code that&#8217;s a pleasure to work with.</p>
</div>
<div class="paragraph">
<p>So, let me tell you <em>all</em> about it!</p>
</div>
</div>
<div class="sect2">
<h3 id="_aims_of_this_book">Aims of This Book</h3>
<div class="paragraph">
<p>My main aim is to impart a methodology&#8212;&#8203;a way of doing web development, which
I think makes for better web apps and happier developers. There&#8217;s not much
point in a book that just covers material you could find by Googling, so this
book isn&#8217;t a guide to Python syntax, or a tutorial on web development <em>per se</em>.
Instead, I hope to teach you how to use TDD to get more reliably to our shared,
holy goal: <em>clean code that works.</em></p>
</div>
<div class="paragraph">
<p>With that said: I will constantly refer to a real practical example, by
building a web app from scratch using tools like Django, Selenium, jQuery,
and Mocks. I&#8217;m not assuming any prior knowledge of any of these, so you
should come out of the other end of this book with a decent introduction to
those tools, as well as the discipline of TDD.</p>
</div>
<div class="paragraph">
<p>In Extreme Programming we always pair-program, so I&#8217;ve imagined writing this
book as if I was pairing with my previous self, having to explain how the
tools work and answer questions about why we code in this particular way. So,
if I ever take a bit of a patronising tone, it&#8217;s because I&#8217;m not all that
smart, and I have to be very patient with myself. And if I ever sound
defensive, it&#8217;s because I&#8217;m the kind of annoying person that systematically
disagrees with whatever anyone else says, so sometimes it takes a lot of
justifying to convince myself of anything.</p>
</div>
</div>
<div class="sect2">
<h3 id="_outline">Outline</h3>
<div class="paragraph">
<p>I&#8217;ve split this book into three parts.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#part1">[part1]</a> (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_01">#chapter_01</a>–<a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_working_incrementally">#chapter_working_incrementally</a>): The basics</dt>
<dd>
<p>Dives straight into building a simple web app using TDD. We start by
writing a functional test (with Selenium), and then we go through the basics of
Django&#8212;&#8203;models, views, templates&#8212;&#8203;with rigorous unit testing at every
stage. I also introduce the Testing Goat.</p>
</dd>
<dt class="hdlist1"><a href="#part2">[part2]</a> (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_prettification">#chapter_prettification</a>–<a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_deploying_validation">#chapter_deploying_validation</a>): Web development essentials</dt>
<dd>
<p>Covers some of the trickier but unavoidable aspects of web development, and
shows how testing can help us with them: static files, deployment to
production, form data validation, database migrations, and the dreaded
JavaScript.</p>
</dd>
<dt class="hdlist1"><a href="#part3">[part3]</a> (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_spiking_custom_auth">#chapter_spiking_custom_auth</a>–<a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_hot_lava">#chapter_hot_lava</a>): More advanced testing topics</dt>
<dd>
<p>Mocking, integrating a third-party system, test fixtures, Outside-In TDD,
and Continuous Integration (CI).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>On to a little housekeeping&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_conventions_used_in_this_book">Conventions Used in This Book</h3>
<div class="paragraph">
<p>The
following typographical conventions are used in this book:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Italic</em></dt>
<dd>
<p>Indicates new terms, URLs, email addresses, filenames, and file
extensions.</p>
</dd>
<dt class="hdlist1"><code>Constant width</code></dt>
<dd>
<p>Used for program listings, as well as within paragraphs to
refer to program elements such as variable or function names, databases, data
types, environment variables, statements, and keywords.</p>
</dd>
<dt class="hdlist1"><code><strong>Constant width bold</strong></code></dt>
<dd>
<p>Shows commands or other text that should be typed
literally by the user.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Occasionally I will use the symbol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]</pre>
</div>
</div>
<div class="paragraph">
<p>to signify that some of the content has been skipped, to shorten long bits of
output, or to skip down to a relevant section.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This element signifies a tip or suggestion.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This element signifies a general note or aside.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This element indicates a warning or caution.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_submitting_errata">Submitting Errata</h3>
<div class="paragraph">
<p>Spotted
a mistake or a typo?  The sources for this book are available on
GitHub, and I&#8217;m always very happy to receive issues and pull requests:
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/" class="bare">https://github.com/hjwp/Book-TDD-Web-Dev-Python/</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_code_examples">Using Code Examples</h3>
<div class="paragraph">
<p>Code
examples are available at <a href="https://github.com/hjwp/book-example/" class="bare">https://github.com/hjwp/book-example/</a>; you&#8217;ll
find branches for each chapter there (e.g.,
<a href="https://github.com/hjwp/book-example/tree/chapter_unit_test_first_view" class="bare">https://github.com/hjwp/book-example/tree/chapter_unit_test_first_view</a>).
You&#8217;ll find a full list, and some suggestions on ways of working with this
repository, in <a href="#appendix_github_links">Source Code Examples</a>.</p>
</div>
<div class="paragraph">
<p>This book is here to help you get your job done. In general, if example code is
offered with this book, you may use it in your programs and documentation. You
do not need to contact us for permission unless you’re reproducing a
significant portion of the code. For example, writing a program that uses
several chunks of code from this book does not require permission. Selling or
distributing a CD-ROM of examples from O’Reilly books does require permission.
Answering a question by citing this book and quoting example code does not
require permission. Incorporating a significant amount of example code from
this book into your product’s documentation does require permission.</p>
</div>
<div class="paragraph">
<p>We appreciate, but do not require, attribution. An attribution usually includes
the title, author, publisher, and ISBN. For example: “<em>Test-Driven Development
with Python</em>, 2nd edition, by Harry J.W. Percival (O’Reilly). Copyright 2017 Harry Percival,
978-1-491-95870-4.”</p>
</div>
<div class="paragraph">
<p>If you feel your use of code examples falls outside fair use or the permission
given above, feel free to contact us at <a class="email"
href="mailto:permissions@oreilly.com"><em>permissions@oreilly.com</em></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_o_reilly_safari">O&#8217;Reilly Safari</h3>
<div class="admonitionblock note safarienabled">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="http://oreilly.com/safari" class="orm:hideurl"><em class="hyperlink">Safari</em></a> (formerly Safari Books Online) is a membership-based training and reference platform for enterprise, government, educators, and individuals.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Members have access to thousands of books, training videos, Learning Paths, interactive tutorials, and curated playlists from over 250 publishers, including O’Reilly Media, Harvard Business Review, Prentice Hall Professional, Addison-Wesley Professional, Microsoft Press, Sams, Que, Peachpit Press, Adobe, Focal Press, Cisco Press, John Wiley &amp; Sons, Syngress, Morgan Kaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New Riders, McGraw-Hill, Jones &amp; Bartlett, and Course Technology, among others.</p>
</div>
<div class="paragraph">
<p>For more information, please visit <a href="http://oreilly.com/safari" class="orm:hideurl"><em>http://oreilly.com/safari</em></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_contacting_o_reilly">Contacting O&#8217;Reilly</h3>
<div class="paragraph">
<p>If you&#8217;d like to get in touch with my beloved publisher with any questions
about this book, contact details follow:</p>
</div>
<ul class="simplelist">
<li>O’Reilly Media, Inc.</li>
<li>1005 Gravenstein Highway North</li>
<li>Sebastopol, CA 95472</li>
<li>800-998-9938 (in the United States or Canada)</li>
<li>707-829-0515 (international or local)</li>
<li>707-829-0104 (fax)</li>
</ul>
<div class="paragraph">
<p>We have a web page for this book, where we list errata, examples, and any additional information. You can access this page at <a href="http://bit.ly/tdd_py_2e" class="bare">http://bit.ly/tdd_py_2e</a>.</p>
</div>
<!--Don't forget to update the link above.-->
<div class="paragraph">
<p>To comment or ask technical questions about this book, send email to <a class="email" href="mailto:bookquestions@oreilly.com"><em>bookquestions@oreilly.com</em></a>.</p>
</div>
<div class="paragraph">
<p>For more information about books, courses, conferences, and news, see
O&#8217;Reilly&#8217;s website at <a href="http://www.oreilly.com" class="bare">http://www.oreilly.com</a>.</p>
</div>
<div class="paragraph">
<p>Facebook: <a href="http://facebook.com/oreilly" class="bare">http://facebook.com/oreilly</a></p>
</div>
<div class="paragraph">
<p>Twitter: <a href="http://twitter.com/oreillymedia" class="bare">http://twitter.com/oreillymedia</a></p>
</div>
<div class="paragraph">
<p>YouTube: <a href="http://www.youtube.com/oreillymedia" class="bare">http://www.youtube.com/oreillymedia</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pre-requisites">Prerequisites and Assumptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here&#8217;s
an outline of what I&#8217;m assuming about you and what you already know,
as well as what software you&#8217;ll need ready and installed on your computer.</p>
</div>
<div class="sect2">
<h3 id="_python_3_6_and_programming">Python 3.6 and Programming</h3>
<div class="paragraph">
<p>I&#8217;ve
tried to write this book with beginners in mind, but if you&#8217;re new to
programming, I&#8217;m assuming that you&#8217;ve already learned the basics of Python. So
if you haven&#8217;t already, do run through a Python beginner&#8217;s tutorial or get an
introductory book like <a href="http://www.diveintopython.net/"><em>Dive Into Python</em></a>  or
<a href="http://learnpythonthehardway.org/"><em>Learn Python the Hard Way</em></a>, or, just for
fun, <a href="http://inventwithpython.com/"><em>Invent Your Own Computer Games with
Python</em></a>, all of which are excellent introductions.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re an experienced programmer but new to Python, you should get along
just fine.  Python is joyously simple to understand.</p>
</div>
<div class="paragraph">
<p>I&#8217;m using <em>Python 3</em> for this book. When I wrote the first edition in 2013&ndash;14, Python 3
had been around for several years, and the world was just about on the tipping
point at which it was the preferred choice.  You should be able to follow this
book on Mac, Windows, or Linux.  Detailed installation instructions for each OS
follow.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This book was tested against Python 3.6. If you&#8217;re on an earlier version,
    you will find minor differences (the f-string syntax, for example), so
    you&#8217;re best off upgrading if you can.  However, for the time being you can&#8217;t
    use Python3.7 because the version of Django we&#8217;re using is not compatible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I
wouldn&#8217;t recommend trying to use Python 2, as the differences are more
substantial. You&#8217;ll still be able to carry across all the lessons you learn
in this book if your next project happens to be in Python 2.  But spending
time figuring out whether the reason your program output looks different from
mine is because of Python 2, or because you made an actual mistake, won&#8217;t be
time spent productively.</p>
</div>
<div class="paragraph">
<p>If
you are thinking of using <a href="http://www.pythonanywhere.com">PythonAnywhere</a> (the
PaaS startup I work for), rather than a locally installed Python, you should go
and take a quick look at <a href="#appendix1">PythonAnywhere</a> before you get started.</p>
</div>
<div class="paragraph">
<p>In any case, I expect you to have access to Python, to know how to launch it
from a command line, and to know how to edit a Python file and run it.  Again,
have a look at the three books I recommended previously if you&#8217;re in any doubt.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you already have Python 2 installed, and you&#8217;re worried that
    installing Python 3 will break it in some way, don&#8217;t!  Python 3 and 2 can
    coexist peacefully on the same system, particularly if you&#8217;re using
    a virtualenv, which we will be.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_how_html_works">How HTML Works</h3>
<div class="paragraph">
<p>I&#8217;m
also assuming you have a basic grasp of how the web works&#8212;&#8203;what HTML is,
what a POST request is, and so on.  If you&#8217;re not sure about those, you&#8217;ll need to
find a basic HTML tutorial; there are a few at <a href="http://www.webplatform.org/" class="bare">http://www.webplatform.org/</a>.  If
you can figure out how to create an HTML page on your PC and look at it in your
browser, and understand what a form is and how it might work, then you&#8217;re
probably OK.</p>
</div>
</div>
<div class="sect2">
<h3 id="_django">Django</h3>
<div class="paragraph">
<p>The
book uses the Django framework, which is (probably) the most
well-established web framework in the Python world.  I&#8217;ve written the book
assuming that the reader has no prior knowledge of Django, but if you&#8217;re
new to Python <em>and</em> new to web development <em>and</em> new to testing,  you may
occasionally find that there&#8217;s just one too many topics and sets of concepts
to try and take on board.  If that&#8217;s the case, I recommend taking a break from
the book, and taking a look at a Django tutorial.
<a href="https://tutorial.djangogirls.org/">DjangoGirls</a> is the best, most
beginner-friendly tutorial I know of.  The
<a href="https://docs.djangoproject.com/en/1.11/intro/tutorial01/">official tutorial</a>
is also excellent for more experienced programmers (make sure you follow the
1.11 tutorial rather than a 2.x one though).</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Don&#8217;t use Django 2</div>
<div class="paragraph">
<p>This book was published before Django 2.0 came out, and as such is
written for Django v1.11 (which is a "long-term-support" or LTS edition).</p>
</div>
<div class="paragraph">
<p>Now I know what you&#8217;re thinking.  You&#8217;re thinking, come on, what&#8217;s the
point in learning an old version, I may as well learn the latest one,
I&#8217;ll follow along with Django 2 and just figure it out for myself when
things are different.  How hard can it be?  I know you&#8217;re thinking this
because it&#8217;s exactly what I&#8217;d be thinking.</p>
</div>
<div class="paragraph">
<p>Actually, it&#8217;s never <em>that</em> hard.  But look, this is not a short book,
there&#8217;s a lot of code to follow along with, and at several points I
<em>guarantee</em> you are going to be staring at something on your screen that
looks nothing like what I say it should in the book.  At those points,
it&#8217;s hard enough debugging all the moving parts for any mistakes you
might have made, without having to add in the extra possibility that
it&#8217;s something to do with Django 2 vs Django 1.11.</p>
</div>
<div class="paragraph">
<p>So my strong recommendation is, stick with 1.11.  The new version is
not that different, and if you need to learn Django 2 for your next project,
it&#8217;ll take you all of 2 hours to go through the official tutorial. Plus if you
get stuck and you&#8217;re on Django 2, I won&#8217;t be able to help you.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Read on for installation instructions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_javascript">JavaScript</h3>
<div class="paragraph">
<p>There&#8217;s a little bit of JavaScript in the second half of the book.  If you
don&#8217;t know JavaScript, don&#8217;t worry about it until then, and if you find
yourself a little confused, I&#8217;ll recommend a couple of guides at that point.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">A Note on IDEs</div>
<div class="paragraph">
<p>If
you&#8217;ve come from the world of Java or .NET, you may be keen to use an IDE
for your Python coding.  They have all sorts of useful tools, including VCS
integration, and there are some excellent ones out there for Python.  I used
one myself when I was starting out, and I found it very useful for my first
couple of projects.</p>
</div>
<div class="paragraph">
<p>Can I suggest (and it&#8217;s only a suggestion) that you <em>don&#8217;t</em> use an IDE, at
least for the duration of this tutorial? IDEs are much less necessary in the
Python world, and I&#8217;ve written this whole book with the assumption that you&#8217;re
just using a basic text editor and a command line.  Sometimes, that&#8217;s all you
have&#8212;&#8203;when you&#8217;re working on a server, for example&#8212;&#8203;so it&#8217;s always worth
learning how to use the basic tools first and understanding how they work.
It&#8217;ll be something you always have, even if you decide to go back to your IDE
and all its helpful tools, after you&#8217;ve finished this book.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_required_software_installations">Required Software Installations</h3>
<div class="paragraph">
<p>Aside
from Python, you&#8217;ll need:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The Firefox web browser</dt>
<dd>
<p>    Selenium
can actually drive any of the major browsers, but Firefox is the
    best to use as an example because it&#8217;s reliably cross-platform and, as a
    bonus, is less sold out to corporate interests.</p>
</dd>
<dt class="hdlist1">The Git version control system</dt>
<dd>
<p>    This
is available for any platform, at <a href="http://git-scm.com/" class="bare">http://git-scm.com/</a>.   On Windows,
    this comes with the <em>Bash</em> command line, which is needed for the book.</p>
</dd>
<dt class="hdlist1">A virtualenv with Python 3, Django 1.11, and Selenium 3 in it</dt>
<dd>
<p>Python&#8217;s virtualenv and pip tools now come bundled with Python 3.4+ (they
didn&#8217;t always used to, so this is a big hooray).  Detailed instructions for
preparing your virtualenv follow.</p>
</dd>
<dt class="hdlist1">Geckodriver</dt>
<dd>
<p>This is the driver that will let us remotely control Firefox via
Selenium.  I&#8217;ll point to a download link in <a href="#firefox_gecko">Installing Firefox and Geckodriver</a>.</p>
</dd>
</dl>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Windows Notes</div>
<div class="paragraph">
<p>Windows
users can sometimes feel a little neglected in the open source world,
since macOS and Linux are so prevalent, making it easy to forget there&#8217;s a world
outside the Unix paradigm.  Backslashes as directory separators?  Drive
letters?  What?   Still, it is absolutely possible to follow along with this
book on Windows.  Here are a few tips:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When you install Git for Windows, make sure you choose <strong>"Run Git and
included Unix tools from the Windows command prompt"</strong>. You&#8217;ll then get
access to a program called "Git Bash". Use this as your main command prompt
and you&#8217;ll get all the useful GNU command-line tools like <code>ls</code>, <code>touch</code>,
and <code>grep</code>, plus forward-slash directory separators.</p>
</li>
<li>
<p>Also in the Git installer, choose <strong>"Use Windows' default console"</strong>;
otherwise, Python won&#8217;t work properly in the Git-Bash window.</p>
</li>
<li>
<p>When you install Python 3, unless you already have Python 2 and want to keep
it as your default, tick the option that says <strong>"Add Python 3.6 to PATH"</strong> as
in <a href="#add-python-to-path">Add Python to the system path from the installer</a>, so that you can easily run Python from the
command line.</p>
</li>
</ol>
</div>
<div id="add-python-to-path" class="imageblock">
<div class="content">
<img src="images/twp2_0001.png" alt="Screenshot of python installer">
</div>
<div class="title">Figure 1. Add Python to the system path from the installer</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The test for all this is that you should be able to go to a Git-Bash
    command prompt and just run <code>python</code> or <code>pip</code> from any folder.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">MacOS Notes</div>
<div class="paragraph">
<p>MacOS
is a bit more sane than Windows, although getting <code>pip</code> installed was
still fairly challenging up until recently. Since the arrival of 3.4, things
are now quite <span class="keep-together">straightforward</span>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Python 3.6 should install without a fuss from its
<a href="http://www.python.org">downloadable installer</a>.  It will automatically install
<code>pip</code>, too.</p>
</li>
<li>
<p>Git&#8217;s installer should also "just work".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similarly to Windows, the test for all this is that you should be able to open
a terminal and just run <code>git</code>, <code>python3</code>, or <code>pip</code> from anywhere.  If you run
into any trouble, the search terms "system path" and "command not found" should
provide good troubleshooting resources.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You might also want to check out <a href="http://brew.sh//">Homebrew</a>. It used to be
    the only reliable way of installing lots of Unixy tools (including Python
    3) on a Mac.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>
    Although the normal Python installer is now fine, you may find Homebrew
    useful in future. It does require you to download all 1.1 GB of Xcode, but
    that also gives you a C compiler, which is a useful side effect.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Linux Notes</div>
<div class="paragraph">
<p>If you&#8217;re on Linux, I&#8217;m assuming you&#8217;re already a glutton for punishment,
so you don&#8217;t need detailed installation instructions. But in brief, if Python
3.6 isn&#8217;t available directly from your package manager:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you&#8217;re on an older Ubuntu that doesn&#8217;t have 3.6, I recommend the
<a href="https://launchpad.net/~deadsnakes/+archive/ubuntu/ppa">Deadsnakes PPA</a>.
Make sure you <code>apt install python3.6-venv</code> as well as just <code>python3.6</code> to
un-break the default Debian version of Python.</p>
</li>
<li>
<p>Alternatively, compiling Python 3.6 from source is actually surprisingly
easy!</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="git-default-editor">Git&#8217;s Default Editor, and Other Basic Git Config</h4>
<div class="paragraph">
<p>I&#8217;ll
provide step-by-step instructions for Git, but it may be a good idea to
get a bit of configuration done now.  For example, when you do your first
commit, by default <em>vi</em> will pop up, at which point you may have no idea what
to do with it. Well, much as vi has two modes, you then have two choices. One
is to learn some minimal vi commands <em>(press the i key to go into insert mode,
type your text, press <code>&lt;Esc&gt;</code> to go back to normal mode, then write the file
and quit with <code>:wq&lt;Enter&gt;</code>)</em>. You&#8217;ll then have joined the great fraternity of
people who know this ancient, revered text editor.</p>
</div>
<div class="paragraph">
<p>Or you can point-blank refuse to be involved in such a ridiculous throwback to
the 1970s, and configure Git to use an editor of your choice. Quit vi using
<code>&lt;Esc&gt;</code> followed by <code>:q!</code>, then change your Git default editor. See the Git
documentation on
<a href="http://git-scm.com/book/en/Customizing-Git-Git-Configuration">basic Git configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="firefox_gecko">Installing Firefox and Geckodriver</h4>
<div class="paragraph">
<p>Firefox
is available as a download for Windows and macOS from
<a href="https://www.mozilla.org/firefox/" class="bare">https://www.mozilla.org/firefox/</a>.  On Linux, you probably already have it
installed, but otherwise your package manager will have it.</p>
</div>
<div class="paragraph">
<p>Geckodriver is available from <a href="https://github.com/mozilla/geckodriver/releases" class="bare">https://github.com/mozilla/geckodriver/releases</a>.
You need to download and extract it and put it somewhere on your system path.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For Windows, you can just put it in the same folder as your code for this
book—or if you put it in your Python <em>Scripts</em> folder, it&#8217;ll be available
for other projects.</p>
</li>
<li>
<p>For macOS or Linux, one convenient place to put it is <em>/usr/local/bin</em>
(you&#8217;ll need <code>sudo</code> for this).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To test that you&#8217;ve got this working, open up a Bash console and you should be
able to run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>geckodriver --version</strong>
geckodriver 0.21.0

The source code of this program is available at
https://github.com/mozilla/geckodriver.

This program is subject to the terms of the Mozilla Public License 2.0.
You can obtain a copy of the license at https://mozilla.org/MPL/2.0/.</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_your_virtualenv">Setting Up Your Virtualenv</h3>
<div class="paragraph">
<p>A
Python virtualenv (short for virtual environment) is how you set up your
environment for different Python projects.  It allows you to use different
packages (e.g., different versions of Django, and even different versions of
Python) in each project.  And because you&#8217;re not installing things
system-wide, it means you don&#8217;t need root <span class="keep-together">permissions</span>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a Python 3 virtualenv. I&#8217;m assuming you&#8217;re working in a folder
called <em>python-tdd-book</em>, but you can name your work folder whatever you like.
Stick to the name "virtualenv" for the virtualenv, though.</p>
</div>
<div class="listingblock">
<div class="title">on Windows:</div>
<div class="content">
<pre>$ <strong>cd python-tdd-book</strong>
$ <strong>py -3.6 -m venv virtualenv</strong></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows, the <code>py</code> executable is a shortcut for different Python versions.  On
Mac or Linux, we use <code>python3.6</code>:</p>
</div>
<div class="listingblock">
<div class="title">on Mac/Linux:</div>
<div class="content">
<pre>$ <strong>cd python-tdd-book</strong>
$ <strong>python3.6 -m venv virtualenv</strong></pre>
</div>
</div>
<div class="sect3">
<h4 id="_activating_and_deactivating_the_virtualenv">Activating and Deactivating the Virtualenv</h4>
<div class="paragraph">
<p>Whenever you work on the book, you&#8217;ll want to make sure your virtualenv has
been "activated".  You can always tell when your virtualenv is active because
you&#8217;ll see <code>(virtualenv)</code> in parentheses, in your prompt.  But you can
also check by running <code>which python</code> to check whether Python is currently
the system-installed one, or the virtualenv one.</p>
</div>
<div class="paragraph">
<p>The command to activate the virtualenv is <code>source virtualenv/Scripts/activate</code> on
Windows and <code>source virtualenv/bin/activate</code> on Mac/Linux. The command to
deactivate is just <code>deactivate</code>.</p>
</div>
<div class="paragraph">
<p>Try it out like this:</p>
</div>
<div class="listingblock">
<div class="title">on Windows</div>
<div class="content">
<pre>$ <strong>source virtualenv/Scripts/activate</strong>
(virtualenv)$
(virtualenv)$ <strong>which python</strong>
/C/Users/harry/python-tdd-book/virtualenv/Scripts/python
(virtualenv)$ <strong>deactivate</strong>
$
$ <strong>which python</strong>
/c/Users/harry/AppData/Local/Programs/Python/Python36-32/python</pre>
</div>
</div>
<div class="listingblock">
<div class="title">on Mac/Linux</div>
<div class="content">
<pre>$ <strong>source virtualenv/bin/activate</strong>
(virtualenv)$
(virtualenv)$ <strong>which python</strong>
/home/myusername/python-tdd-book/virtualenv/bin/python
(virtualenv)$ <strong>deactivate</strong>
$
$ <strong>which python</strong>
/usr/bin/python</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Always make sure your virtualenv is active when working on the book. Look
    out for the <code>(virtualenv)</code> in your prompt, or run <code>which python</code> to check.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Activate Not Working on Windows?</div>
<div class="paragraph">
<p>If
you see an error like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bash: virtualenv/Scripts/activate: No such file or directory</pre>
</div>
</div>
<div class="paragraph">
<p>First, double-check you&#8217;re in the right folder.  Assuming you are,
or if you see an error like this:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>bash: @echo: command not found
bash: virtualenv/Scripts/activate.bat: line 4:
      syntax error near unexpected token `(
bash: virtualenv/Scripts/activate.bat: line 4: `if not defined PROMPT ('</pre>
</div>
</div>
<div class="paragraph">
<p>Then you&#8217;ve probably run into a old bug where Python wouldn&#8217;t install an
activate script that was compatible with Git-Bash. Reinstall the latest Python
3, making sure you have 3.6.3 or later, then delete and re-create your
virtualenv.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installing_django_and_selenium">Installing Django and Selenium</h3>
<div class="paragraph">
<p>We&#8217;ll
install Django 1.11 and the latest Selenium, Selenium 3.</p>
</div>
<div class="paragraph">
<p>Remember to make sure your virtualenv is active first!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(virtualenv) $ <strong>pip install "django&lt;1.12" "selenium&lt;4"</strong>
Collecting django==1.11.16
  Using cached Django-1.11.16-py2.py3-none-any.whl
Collecting selenium&lt;4
  Using cached selenium-3.14.1-py2.py3-none-any.whl
Installing collected packages: django, selenium
Successfully installed django-1.11.16 selenium-3.14.1</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_some_error_messages_you_re_likely_to_see_when_you_em_inevitably_em_fail_to_activate_your_virtualenv">Some Error Messages You&#8217;re Likely to See When You <em>Inevitably</em> Fail to Activate Your Virtualenv</h3>
<div class="paragraph">
<p>If
you&#8217;re new to virtualenvs&#8212;&#8203;or even if you&#8217;re not, to be honest&#8212;&#8203;at some
point you&#8217;re <em>guaranteed</em> to forget to activate it, and then you&#8217;ll be
staring at an error message.  Happens to me all the time.  Here are some of the
things to look out for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ImportError: No module named selenium</pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ImportError: No module named django.core.management</pre>
</div>
</div>
<div class="paragraph">
<p>As always, look out for that <code>(virtualenv)</code> in your command prompt, and a
quick <code>source virtualenv/Scripts/activate</code> or <code>source
virtualenv/bin/activate</code> is probably what you need to get it working again.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a couple more, for good measure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bash: virtualenv/Scripts/activate: No such file or directory</pre>
</div>
</div>
<div class="paragraph">
<p>This means you&#8217;re not currently in the right directory for working on the
project.  Try a <code>cd tdd-python-book</code>, or similar.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you&#8217;re sure you&#8217;re in the right place, you may have run into
a bug from an older version of Python, where it wouldn&#8217;t install
an activate script that was compatible with Git-Bash.  Reinstall Python 3, and
make sure you have version 3.6.3 or later, and then delete and re-create your
virtualenv.</p>
</div>
<div class="paragraph">
<p>If you see something like this, it&#8217;s probably the same issue, you need to
upgrade Python:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bash: @echo: command not found
bash: virtualenv/Scripts/activate.bat: line 4:
      syntax error near unexpected token `(
bash: virtualenv/Scripts/activate.bat: line 4: `if not defined PROMPT ('</pre>
</div>
</div>
<div class="paragraph">
<p>Final one!  If you see this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>'source' is not recognized as an internal or external command,
operable program or batch file.</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because you&#8217;ve launched the default Windows command prompt, <code>cmd</code>,
instead of Git-Bash.  Close it and open the latter.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On Anaconda</div>
<div class="paragraph">
<p>Anaconda is another tool for managing different Python environments.  It&#8217;s
particularly popular on Windows and for scientific computing, where it can
be hard to get some of the compiled libraries to install.</p>
</div>
<div class="paragraph">
<p>In the world of web programming it&#8217;s much less necessary, so <em>I recommend you do not use Anaconda for this book</em>.</p>
</div>
<div class="paragraph">
<p>Apart from anything else I don&#8217;t know enough about it to help you debug any
problems with it if they occur!</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Happy coding!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Did these instructions not work for you? Or have you got better ones? Get
    in touch: <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="video_plug">Companion Video</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I&#8217;ve
recorded a
<a href="http://oreil.ly/1svTFqB">10-part video series to accompany this
book</a>.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnote_2" title="View footnote.">2</a>]</sup>
It covers the content of <a href="#part1">[part1]</a>.  If you find you learn well from
video-based material, then I encourage you to check it out.  Over and above
what&#8217;s in the book, it should give you a feel for what the "flow" of TDD is
like, flicking between tests and code, explaining the thought process as we go.</p>
</div>
<div class="paragraph">
<p>Plus I&#8217;m wearing a delightful yellow T-shirt.</p>
</div>
<div id="video-screengrab" class="imageblock">
<div class="content">
<img src="images/twp2_00in01.png" alt="screengrab from video">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgments">Acknowledgments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lots of people to thank, without whom this book would never have happened,
and/or would have been even worse than it is.</p>
</div>
<div class="paragraph">
<p>Thanks first to "Greg" at $OTHER_PUBLISHER, who was the first person to
encourage me to believe it really could be done. Even though your employers
turned out to have overly regressive views on copyright, I&#8217;m forever grateful
that you believed in me.</p>
</div>
<div class="paragraph">
<p>Thanks to Michael Foord, another ex-employee of Resolver Systems, for providing
the original inspiration by writing a book himself, and thanks for his ongoing
support for the project.  Thanks also to my boss Giles Thomas, for foolishly
allowing another one of his employees to write a book (although I believe he&#8217;s
now changed the standard employment contract to say "no books").  Thanks also
for your ongoing wisdom and for setting me off on the testing path.</p>
</div>
<div class="paragraph">
<p>Thanks to my other colleagues, Glenn Jones and Hansel Dunlop, for being
invaluable sounding boards, and for your patience with my one-track record
conversation over the last year.</p>
</div>
<div class="paragraph">
<p>Thanks to my wife Clementine, and to both my families, without whose support
and patience I would never have made it.  I apologise for all the time spent
with nose in computer on what should have been memorable family occasions. I
had no idea when I set out what the book would do to my life ("Write it in my
spare time, you say?  That sounds reasonable&#8230;&#8203;").  I couldn&#8217;t have done it
without you.</p>
</div>
<div class="paragraph">
<p>Thanks to my tech reviewers, Jonathan Hartley, Nicholas Tollervey, and Emily
Bache, for your encouragements and invaluable feedback.   Especially Emily,
who actually conscientiously read every single chapter.  Partial credit
to Nick and Jon, but that should still be read as eternal gratitude. Having
y&#8217;all around made the whole thing less of a lonely endeavour. Without all of
you the book would have been little more than the nonsensical ramblings of an
idiot.</p>
</div>
<div class="paragraph">
<p>Thanks to everyone else who&#8217;s given up some of their time to give some
feedback on the book, out of nothing more than the goodness of their heart:
Gary Bernhardt, Mark Lavin, Matt O&#8217;Donnell, Michael Foord, Hynek Schlawack,
Russell Keith-Magee, Andrew Godwin, Kenneth Reitz, and Nathan Stocks.  Thanks
for being much smarter than I am, and for preventing me from saying several
stupid things.  Naturally, there are still plenty of stupid things left in the
book, for which y&#8217;all can absolutely not be held responsible.</p>
</div>
<div class="paragraph">
<p>Thanks to my editor Meghan Blanchette, for being a very friendly and likeable
slave driver, and for keeping the book on track, both in terms of timescales
and by restraining my sillier ideas.  Thanks to all the others at
O&#8217;Reilly for your help, including Sarah Schneider, Kara Ebrahim, and
Dan Fauxsmith for letting me keep British English. Thanks to Charles
Roumeliotis for your help with style and grammar.  We may never see eye-to-eye
on the merits of Chicago School quotation/punctuation rules, but I sure am
glad you were around.  And thanks to the design department for giving us a goat
for the cover!</p>
</div>
<div class="paragraph">
<p>And thanks most especially to all my Early Release readers, for all your help
picking out typos, for your feedback and suggestions, for all the ways in
which you helped to smooth out the learning curve in the book, and most of
all for your kind words of encouragement and support that kept me going.
Thank you Jason Wirth, Dave Pawson, Jeff Orr, Kevin De Baere, crainbf,
dsisson, Galeran, Michael Allan, James O&#8217;Donnell, Marek Turnovec, SoonerBourne,
julz, Cody Farmer, William Vincent, Trey Hunner, David Souther, Tom Perkin,
Sorcha Bowler, Jon Poler, Charles Quast, Siddhartha Naithani, Steve Young,
Roger Camargo, Wesley Hansen, Johansen Christian Vermeer, Ian Laurain, Sean
Robertson, Hari Jayaram, Bayard Randel, Konrad Korżel, Matthew Waller, Julian
Harley, Barry McClendon, Simon Jakobi, Angelo Cordon, Jyrki Kajala, Manish
Jain, Mahadevan Sreenivasan, Konrad Korżel, Deric Crago, Cosmo Smith, Markus
Kemmerling, Andrea Costantini, Daniel Patrick, Ryan Allen, Jason Selby, Greg
Vaughan, Jonathan Sundqvist, Richard Bailey, Diane Soini, Dale Stewart, Mark
Keaton, Johan Wärlander, Simon Scarfe, Eric Grannan, Marc-Anthony Taylor,
Maria McKinley, John McKenna, Rafał Szymański, Roel van der Goot,
Ignacio Reguero, TJ Tolton, Jonathan Means, Theodor Nolte, Jungsoo Moon,
Craig Cook, Gabriel Ewilazarus, Vincenzo Pandolfo, David "farbish2", Nico
Coetzee, Daniel Gonzalez, Jared Contrascere, Zhao 赵亮,
and many, many more. If I&#8217;ve missed your name, you have an absolute right to be
aggrieved; I am incredibly grateful to you too, so write to me and I will try
and make it up to you in any way I can.</p>
</div>
<div class="paragraph">
<p>And finally thanks to you, the latest reader, for deciding to check out
the book!  I hope you enjoy it.</p>
</div>
<div class="sect2">
<h3 id="_additional_thanks_for_the_second_edition">Additional Thanks for the Second Edition</h3>
<div class="paragraph">
<p>Thanks to my wonderful editor for the second edition, Nan Barber, and to
Susan Conant, Kristen Brown, and the whole team at O&#8217;Reilly.
Thanks once again to Emily and Jonathan for tech reviewing, as well as to
Edward Wong for his very thorough notes.  Any remaining errors and
inadequacies are all my own.</p>
</div>
<div class="paragraph">
<p>Thanks also to the readers of the free edition who contributed comments,
suggestions, and even some pull requests. I have definitely missed some of
you on this list,  so apologies if your name isn&#8217;t here, but thanks to Emre
Gonulates, Jésus Gómez, Jordon Birk, James Evans, Iain Houston, Jason DeWitt,
Ronnie Raney, Spencer Ogden, Suresh Nimbalkar, Darius, Caco,
LeBodro, Jeff, Duncan Betts, wasabigeek, joegnis, Lars, Mustafa, Jared, Craig,
Sorcha, TJ, Ignacio, Roel, Justyna, Nathan, Andrea, Alexandr, bilyanhadzhi,
mosegontar, sfarzy, henziger, hunterji, das-g, juanriaza, GeoWill, Windsooon,
gonulate, Margie Roswell, Ben Elliott, Ramsay Mayka, peterj, 1hx, Wi, Duncan
Betts, Matthew Senko, Neric "Kasu" Kaz, Dominic Scotto, and many, many more.</p>
</div>
<div class="paragraph">
<p>Unresolved directive in book.asciidoc - include::part1.harry.asciidoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_01">1. Getting Django Set Up Using a <span class="keep-together">Functional Test</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TDD isn&#8217;t something that comes naturally. It&#8217;s a
discipline, like a martial art, and just like in a Kung Fu movie, you
need a bad-tempered and unreasonable master to force you to learn the
discipline.  Ours is the Testing Goat.</p>
</div>
<div class="sect2">
<h3 id="_obey_the_testing_goat_do_nothing_until_you_have_a_test">1.1. Obey the Testing Goat! Do Nothing Until You Have a Test</h3>
<div class="paragraph">
<p>The
Testing Goat is the unofficial mascot of TDD in the Python testing
community.  It probably means different things to different people, but, to me,
the Testing Goat is a voice inside my head that keeps me on the True Path of
Testing&#8212;&#8203;like one of those little angels or demons that pop up above your
shoulder in the cartoons, but with a very niche set of concerns. I hope, with
this book, to install the Testing Goat inside your head too.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve decided to build a website, even if we&#8217;re not quite sure what it&#8217;s
going to do yet. Normally the first step in web development is getting
your web framework installed and configured. <em>Download this, install that,
configure the other, run the script</em>&#8230;&#8203;but TDD requires a different mindset.
When you&#8217;re doing TDD, you always have the Testing Goat inside you&#8212;&#8203;single-minded as goats are&#8212;&#8203;bleating &#8220;Test first, test first!&#8221;</p>
</div>
<div class="paragraph">
<p>In TDD the first step is always the same: <em>write a test</em>.</p>
</div>
<div class="paragraph">
<p><em>First</em> we write the test; <em>then</em> we run it and check that it fails as
expected.  <em>Only then</em> do we go ahead and build some of our app.  Repeat
that to yourself in a goat-like voice.  I know I do.</p>
</div>
<div class="paragraph">
<p>Another thing about goats is that they take one step at a time.  That&#8217;s why
they seldom fall off mountains, see, no matter how steep they are.  As you
can see in <a href="#tree_goat">Goats are more agile than you think (source: <a href="http://www.flickr.com/photos/caitlinstewart/2846642630/">Caitlin Stewart, on Flickr</a>)</a>.</p>
</div>
<div id="tree_goat" class="imageblock">
<div class="content">
<img src="images/twp2_0101.png" alt="A picture of a goat up a tree">
</div>
<div class="title">Figure 2. Goats are more agile than you think (source: <a href="http://www.flickr.com/photos/caitlinstewart/2846642630/">Caitlin Stewart, on Flickr</a>)</div>
</div>
<div class="paragraph">
<p>We&#8217;ll proceed with nice small steps; we&#8217;re going to use <em>Django</em>, which is
a popular Python web framework, to build our app.</p>
</div>
<div class="paragraph">
<p>The
first thing we want to do is check that we&#8217;ve got Django installed, and
that it&#8217;s ready for us to work with. The <em>way</em> we&#8217;ll check is by confirming
that we can spin up Django&#8217;s development server and actually see it serving up
a web page, in our web browser, on our local PC. We&#8217;ll use the <em>Selenium</em>
browser automation tool for this.</p>
</div>
<div id="first-FT" class="paragraph">
<p>Create
a new Python file called <em>functional_tests.py</em>, wherever you want to
keep the code for your project, and enter the following code.  If you feel like
making a few little goat noises as you do it, it may help:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver

browser = webdriver.Firefox()
browser.get('http://localhost:8000')

assert 'Django' in browser.title</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s our first <em>functional test</em> (FT); I&#8217;ll talk more about what I mean by
functional tests, and how they contrast with unit tests, in a bit.  For now, it&#8217;s enough
to assure ourselves that we understand what it&#8217;s doing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Starting a Selenium "webdriver" to pop up a real Firefox browser window</p>
</li>
<li>
<p>Using it to open up a web page which we&#8217;re expecting to be served from
the local PC</p>
</li>
<li>
<p>Checking (making a test assertion) that the page has the word "Django" in
its title</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s try running it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
Traceback (most recent call last):
  File "functional_tests.py", line 4, in &lt;module&gt;
    browser.get('http://localhost:8000')
  File ".../selenium/webdriver/remote/webdriver.py", line 333, in get
    self.execute(Command.GET, {'url': url})
  File ".../selenium/webdriver/remote/webdriver.py", line 321, in execute
    self.error_handler.check_response(response)
  File ".../selenium/webdriver/remote/errorhandler.py", line 242, in
check_response
    raise exception_class(message, screen, stacktrace)
selenium.common.exceptions.WebDriverException: Message: Reached error page: abo
ut:neterror?e=connectionFailure&amp;u=http%3A//localhost%3A8000/[...]</pre>
</div>
</div>
<div class="paragraph">
<p>You should see a browser window pop up and try to open <em>localhost:8000</em>, and
show the "Unable to connect" error page.  If you switch back to your console,
you&#8217;ll see the big ugly error message, telling us that Selenium hit
an error page. And then, you will probably be irritated at the fact that it
left the Firefox window lying around your desktop for you to tidy up.  We&#8217;ll
fix that later!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If, instead, you see an error trying to import Selenium, or an error
    trying to find "geckodriver", you might need
    to go back and have another look at the "<a href="#pre-requisites">Prerequisites and Assumptions</a>" section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For now though, we have a <em>failing test</em>, so that means we&#8217;re allowed to start
building our app.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Adieu to Roman Numerals!</div>
<div class="paragraph">
<p>So many introductions to TDD use Roman numerals as an example that it&#8217;s a
running joke&#8212;&#8203;I even started writing one myself. If you&#8217;re curious, you can
find it on <a href="https://github.com/hjwp/tdd-roman-numeral-calculator/">my GitHub page</a>.</p>
</div>
<div class="paragraph">
<p>Roman numerals, as an example, are both good and bad.  It&#8217;s a nice &#8220;toy&#8221;
problem, reasonably limited in scope, and you can explain TDD quite well with
it.</p>
</div>
<div class="paragraph">
<p>The problem is that it can be hard to relate to the real world.  That&#8217;s why
I&#8217;ve decided to use building a real web app, starting from nothing, as my
example.  Although it&#8217;s a simple web app, my hope is that it will be easier
for you to carry across to your next real project.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_getting_django_up_and_running">1.2. Getting Django Up and Running</h3>
<div class="paragraph">
<p>Since
you&#8217;ve definitely read &#x201c;<a href="#pre-requisites">Prerequisites and Assumptions</a>&#x201d; by now, you&#8217;ve
already got Django installed.  The first step in getting Django up and running
is to create a <em>project</em>, which will be the main container for our site.
Django provides a little command-line tool for this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>django-admin.py startproject superlists .</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget that "." at the end; it&#8217;s important!</p>
</div>
<div class="paragraph">
<p>That will create a file called <em>manage.py</em> in
your current folder, and a subfolder called <em>superlists</em>, with more
stuff inside it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>├── functional_tests.py
├── geckodriver.log
├── manage.py
├── superlists
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
└── virtualenv
    ├── [...]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure your project folder looks exactly like this!  If you
    see two nested folders called superlists, it&#8217;s because you forgot the "."
    above.  Delete them and try again.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>superlists</em> folder is intended for stuff that applies to the whole
project&#8212;&#8203;like <em>settings.py</em>, for example, which is used to store global
configuration information for the site.</p>
</div>
<div class="paragraph">
<p>But the main thing to notice is <em>manage.py</em>. That&#8217;s Django&#8217;s Swiss Army knife,
and one of the things it can do is run a development server.  Let&#8217;s try that
now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py runserver</strong>
Performing system checks...

System check identified no issues (0 silenced).

You have 13 unapplied migration(s). Your project may not work properly until
you apply the migrations for app(s): admin, auth, contenttypes, sessions.
Run 'python manage.py migrate' to apply them.

Django version 1.11.3, using settings 'superlists.settings'
Starting development server at <a href="http://127.0.0.1:8000/" class="bare">http://127.0.0.1:8000/</a>
Quit the server with CONTROL-C.</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s safe to ignore that message about "unapplied migrations" for now.
    We&#8217;ll look at migrations in <a href="#chapter_post_and_database">Saving User Input: Testing the Database</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s Django&#8217;s development server now up and running on our machine.</p>
</div>
<div class="paragraph">
<p>Leave it there and open another command shell.  Navigate to your project
folder, activate your virtualenv, and then try running our test again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
$</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you see an error saying "no module named selenium", you&#8217;ve
    forgotten to activate your virtualenv. Check the <a href="#pre-requisites">Prerequisites and Assumptions</a> section again
    if you need to.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Not much action on the command line, but you should notice two things: firstly,
there was no ugly <code>AssertionError</code> and secondly, the Firefox window that
Selenium popped up had a different-looking page on it.</p>
</div>
<div class="paragraph">
<p>Well, it may not look like much, but that was our first ever passing test!
Hooray!</p>
</div>
<div class="paragraph">
<p>If it all feels a bit too much like magic, like it wasn&#8217;t quite real, why not
go and take a look at the dev server manually, by opening a web browser
yourself and visiting <em>http://localhost:8000</em>?  You should see something like
<a href="#it_worked_screenshot">It worked!</a>.</p>
</div>
<div class="paragraph">
<p>You can quit the development server now if you like, back in the original
shell, using Ctrl-C.</p>
</div>
<div id="it_worked_screenshot" class="imageblock">
<div class="content">
<img src="images/twp2_0102.png" alt="Screenshot of Django It Worked screen">
</div>
<div class="title">Figure 3. It worked!</div>
</div>
</div>
<div class="sect2">
<h3 id="_starting_a_git_repository">1.3. Starting a Git Repository</h3>
<div class="paragraph">
<p>There&#8217;s
one last thing to do before we finish the chapter: start to commit our
work to a <em>version control system</em> (VCS).  If you&#8217;re an experienced programmer
you don&#8217;t need to hear me preaching about version control, but if you&#8217;re new to
it please believe me when I say that VCS is a must-have.  As soon as your
project gets to be more than a few weeks old and a few lines of code, having a
tool available to look back over old versions of code, revert changes, explore
new ideas safely, even just as a backup&#8230;&#8203;boy. TDD goes hand in hand with
version control, so I want to make sure I impart how it fits into the workflow.</p>
</div>
<div class="paragraph">
<p>So, our first commit! If anything it&#8217;s a bit late; shame on us. We&#8217;re using
<em>Git</em> as our VCS, &rsquo;cos it&#8217;s the best.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by doing the <code>git init</code> to start the repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ls</strong>
db.sqlite3
functional_tests.py
geckodriver.log
manage.py
superlists
virtualenv

$ <strong>git init .</strong>
Initialised empty Git repository in ...python-tdd-book/.git/</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Our Working Directory Is Always the Folder that Contains <em>manage.py</em></div>
<div class="paragraph">
<p>We&#8217;ll be using this same folder throughout the book as our working
directory&#8212;&#8203;if in doubt, it&#8217;s the one that contains <em>manage.py</em>.</p>
</div>
<div class="paragraph">
<p>(For simplicity, in my command listings, I&#8217;ll always show it as
<em>&#8230;&#8203;python-tdd-book/</em>, although it will probably actually be something like
<em>/home/kind-reader-username/my-python-projects/python-tdd-book/</em>.)</p>
</div>
<div class="paragraph">
<p>Whenever I show a command to type in, it will assume we&#8217;re in this directory.
Similarly, if I mention a path to a file, it will be relative to this
directory.  So for example, <em>superlists/settings.py</em> means the <em>settings.py</em>
inside the <em>superlists</em> folder.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now
let&#8217;s take a look and see what files we want to commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>ls</strong>
db.sqlite3
functional_tests.py
geckodriver.log
manage.py
superlists
virtualenv</pre>
</div>
</div>
<div class="paragraph">
<p>There are a few things in here that we <em>don&#8217;t</em> want under version control:
<em>db.sqlite3</em> is the database file, <em>geckodriver.log</em> contains Selenium
debug output, and finally our virtualenv shouldn&#8217;t be in git either.
We&#8217;ll add all of them to a special file called <em>.gitignore</em> which, um, tells
Git what to ignore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo "db.sqlite3" &gt;&gt; .gitignore</strong>
$ <strong>echo "geckodriver.log" &gt;&gt; .gitignore</strong>
$ <strong>echo "virtualenv" &gt;&gt; .gitignore</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Next we can add the rest of the contents of the current folder, ".":</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add .</strong>
$ <strong>git status</strong>
On branch master

Initial commit

Changes to be committed:
  (use "git rm --cached &lt;file&gt;..." to unstage)

        new file:   .gitignore
        new file:   functional_tests.py
        new file:   manage.py
        new file:   superlists/__init__.py
        new file:   superlists/__pycache__/__init__.cpython-36.pyc
        new file:   superlists/__pycache__/settings.cpython-36.pyc
        new file:   superlists/__pycache__/urls.cpython-36.pyc
        new file:   superlists/__pycache__/wsgi.cpython-36.pyc
        new file:   superlists/settings.py
        new file:   superlists/urls.py
        new file:   superlists/wsgi.py</pre>
</div>
</div>
<div class="paragraph">
<p>Oops!  We&#8217;ve got a bunch of <em>.pyc</em> files in there; it&#8217;s pointless to
commit those.  Let&#8217;s remove them from Git and add them to
<em>.gitignore</em> too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git rm -r --cached superlists/__pycache__</strong>
rm 'superlists/__pycache__/__init__.cpython-36.pyc'
rm 'superlists/__pycache__/settings.cpython-36.pyc'
rm 'superlists/__pycache__/urls.cpython-36.pyc'
rm 'superlists/__pycache__/wsgi.cpython-36.pyc'
$ <strong>echo "__pycache__" >> .gitignore</strong>
$ <strong>echo "*.pyc" >> .gitignore</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see where we are&#8230;&#8203; (You&#8217;ll see I&#8217;m using <code>git status</code> a lot&#8212;&#8203;so
much so that I often alias it to <code>git st</code>&#8230;&#8203;I&#8217;m not telling you how to do
that though; I leave you to discover the secrets of Git aliases on your own!):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
On branch master

Initial commit

Changes to be committed:
  (use "git rm --cached &lt;file&gt;..." to unstage)

        new file:   .gitignore
        new file:   functional_tests.py
        new file:   manage.py
        new file:   superlists/__init__.py
        new file:   superlists/settings.py
        new file:   superlists/urls.py
        new file:   superlists/wsgi.py

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

        modified:   .gitignore</pre>
</div>
</div>
<div class="paragraph">
<p>Looking good&#8212;&#8203;we&#8217;re ready to do our first commit!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add .gitignore</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>When you type <code>git commit</code>, it will pop up an editor window for you to write
your commit message in.  Mine looked like
<a href="#first_git_commit">First Git commit</a>.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnote_3" title="View footnote.">3</a>]</sup></p>
</div>
<div id="first_git_commit" class="imageblock">
<div class="content">
<img src="images/twp2_0103.png" alt="Screenshot of git commit vi window">
</div>
<div class="title">Figure 4. First Git commit</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to really go to town on Git, this is the time to also learn
    about how to push your work to a cloud-based VCS hosting service, like
    GitHub or Bitbucket.  They&#8217;ll be useful if you think you want to follow
    along with this book on different PCs.  I leave it to you to find out how
    they work; they have excellent documentation. Alternatively, you can wait
    until <a href="#chapter_manual_deployment">Testing Deployment Using a Staging Site</a> when we&#8217;ll be using one for deployment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s it for the VCS lecture. Congratulations!  You&#8217;ve written a
functional test using Selenium, and you&#8217;ve gotten Django installed and running,
in a certifiable, test-first, goat-approved TDD way.  Give yourself a
well-deserved pat on the back before moving on to <a href="#chapter_02_unittest">Extending Our Functional Test Using <span class="keep-together">the unittest Module</span></a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_02_unittest">2. Extending Our Functional Test Using <span class="keep-together">the unittest Module</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s
adapt our test, which currently checks for the default Django
"it worked" page, and check instead for some of the things we want to see on
the real front page of our site.</p>
</div>
<div class="paragraph">
<p>Time to reveal what kind of web app we&#8217;re building: a to-do lists site!  In
doing so we&#8217;re very much following fashion: a few years ago all web tutorials
were about building a blog.  Then it was forums and polls; nowadays it&#8217;s all
to-do lists.</p>
</div>
<div class="paragraph">
<p>The reason is that a to-do list is a really nice example. At its most basic
it is very simple indeed&#8212;&#8203;just a list of text strings&#8212;&#8203;so it&#8217;s easy to
get a "minimum viable" list app up and running.  But it can be extended in all
sorts of ways&#8212;&#8203;different persistence models, adding deadlines, reminders,
sharing with other users, and improving the client-side UI. There&#8217;s no reason
to be limited to just &#8220;to-do&#8221; lists either; they could be any kind of lists.
But the point is that it should allow me to demonstrate all of the main aspects
of web programming, and how you apply TDD to them.</p>
</div>
<div class="sect2 pagebreak-before">
<h3 id="_using_a_functional_test_to_scope_out_a_minimum_span_class_keep_together_viable_app_span">2.1. Using a Functional Test to Scope Out a Minimum <span class="keep-together">Viable App</span></h3>
<div class="paragraph">
<p>Tests that use Selenium let us drive a real web browser, so they really let
us see how the application <em>functions</em> from the user&#8217;s point of view. That&#8217;s
why they&#8217;re called <em>functional tests</em>.</p>
</div>
<div class="paragraph">
<p>This
means that an FT can be a sort of specification for your application. It
tends to track what you might call a <em>User Story</em>, and follows how the
user might work with a particular feature and how the app should respond to
them.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Terminology: <br/>Functional Test == Acceptance Test == End-to-End Test</div>
<div class="paragraph">
<p>What
I call functional tests, some people prefer to call <em>acceptance tests</em>, or
<em>end-to-end tests</em>. The main point is that these kinds of tests look
at how the whole application functions, from the outside.  Another term is
<em>black box test</em>, because the test doesn&#8217;t know anything about the internals
of the system under test.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>FTs should have a human-readable story that we can follow. We make it explicit
using comments that accompany the test code.  When creating a new FT,
we can write the comments first, to capture the key points of the User Story.
Being human-readable, you could even share them with nonprogrammers, as a way
of discussing the requirements and features of your app.</p>
</div>
<div class="paragraph">
<p>TDD and agile software development methodologies often go together, and one
of the things we often talk about is the minimum viable app; what is the
simplest thing we can build that is still useful?  Let&#8217;s start by building
that, so that we can test the water as quickly as possible.</p>
</div>
<div class="paragraph">
<p>A minimum viable to-do list really only needs to let the user enter some
to-do items, and remember them for their next visit.</p>
</div>
<div class="paragraph">
<p>Open up <em>functional_tests.py</em> and write a story a bit like this one:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver

browser = webdriver.Firefox()

# Edith has heard about a cool new online to-do app. She goes
# to check out its homepage
browser.get('http://localhost:8000')

# She notices the page title and header mention to-do lists
assert 'To-Do' in browser.title

# She is invited to enter a to-do item straight away

# She types "Buy peacock feathers" into a text box (Edith's hobby
# is tying fly-fishing lures)

# When she hits enter, the page updates, and now the page lists
# "1: Buy peacock feathers" as an item in a to-do list

# There is still a text box inviting her to add another item. She
# enters "Use peacock feathers to make a fly" (Edith is very methodical)

# The page updates again, and now shows both items on her list

# Edith wonders whether the site will remember her list. Then she sees
# that the site has generated a unique URL for her -- there is some
# explanatory text to that effect.

# She visits that URL - her to-do list is still there.

# Satisfied, she goes back to sleep

browser.quit()</code></pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">We Have a Word for Comments&#8230;&#8203;</div>
<div class="paragraph">
<p>When I first started at Resolver, I used to virtuously pepper my code with nice
descriptive comments.  My colleagues said to me: &#8220;Harry, we have a word for
comments. We call them lies.&#8221; I was shocked! But I learned in school that
comments are good practice?</p>
</div>
<div class="paragraph">
<p>They were exaggerating for effect. There is definitely a place for comments
that add context and intention.  But their point was that it&#8217;s pointless to
write a comment that just repeats what you&#8217;re doing with the code:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"># increment wibble by 1
wibble += 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Not only is it pointless, but there&#8217;s a danger that you&#8217;ll forget to update the
comments when you update the code, and they end up being misleading. The ideal
is to strive to make your code so readable, to use such good variable names and
function names, and to structure it so well that you no longer need any comments to
explain <em>what</em> the code is doing.  Just a few here and there to explain <em>why</em>.</p>
</div>
<div class="paragraph">
<p>There are other places where comments are very useful. We&#8217;ll see that Django
uses them a lot in the files it generates for us to use as a way of suggesting
helpful bits of its API. And, of course, we use comments to explain the User
Story in our functional tests&#8212;&#8203;by forcing us to make a coherent story out
of the test, it makes sure we&#8217;re always testing from the point of view of the
user.</p>
</div>
<div class="paragraph">
<p>There is more fun to be had in this area, things like
<em>Behaviour-Driven Development</em> (see <a href="#appendix_bdd">Behaviour-Driven Development (BDD)</a>) and testing DSLs, but
they&#8217;re topics for other books.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice that, apart from writing the test out as comments, I&#8217;ve
updated the <code>assert</code> to look for the word &#8220;To-Do&#8221; instead of &#8220;Django&#8221;.
That means we expect the test to fail now.  Let&#8217;s try running it.</p>
</div>
<div class="paragraph">
<p>First, start up the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py runserver</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then, in another shell, run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
Traceback (most recent call last):
  File "functional_tests.py", line 10, in &lt;module&gt;
    assert 'To-Do' in browser.title
AssertionError</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s
what we call an <em>expected fail</em>, which is actually good news—not
quite as good as a test that passes, but at least it&#8217;s failing for the right
reason; we can have some confidence we&#8217;ve written the test correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_python_standard_library_s_unittest_module">2.2. The Python Standard Library&#8217;s unittest Module</h3>
<div class="paragraph">
<p>There are a couple of little annoyances we should probably deal with.
Firstly, the message "AssertionError" isn&#8217;t very helpful&#8212;&#8203;it would be nice
if the test told us what it actually found as the browser title.  Also, it&#8217;s
left a Firefox window hanging around the desktop, so it would be nice if that
got cleared up for us automatically.</p>
</div>
<div class="paragraph">
<p>One option would be to use the second parameter to the <code>assert</code> keyword,
something like:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">assert 'To-Do' in browser.title, "Browser title was " + browser.title</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we could also use a <code>try/finally</code> to clean up the old Firefox window. But
these sorts of problems are quite common in testing, and there are some
ready-made <span class="keep-together">solutions</span> for us in the standard library&#8217;s <code>unittest</code> module. Let&#8217;s
use that!  In <span class="keep-together"><em>functional_tests.py</em></span>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver
import unittest

class NewVisitorTest(unittest.TestCase):  <i class="conum" data-value="1"></i><b>(1)</b>

    def setUp(self):  <i class="conum" data-value="3"></i><b>(3)</b>
        self.browser = webdriver.Firefox()

    def tearDown(self):  <i class="conum" data-value="3"></i><b>(3)</b>
        self.browser.quit()

    def test_can_start_a_list_and_retrieve_it_later(self):  <i class="conum" data-value="2"></i><b>(2)</b>
        # Edith has heard about a cool new online to-do app. She goes
        # to check out its homepage
        self.browser.get('http://localhost:8000')

        # She notices the page title and header mention to-do lists
        self.assertIn('To-Do', self.browser.title)  <i class="conum" data-value="4"></i><b>(4)</b>
        self.fail('Finish the test!')  <i class="conum" data-value="5"></i><b>(5)</b>

        # She is invited to enter a to-do item straight away
        [...rest of comments as before]

if __name__ == '__main__':  <i class="conum" data-value="6"></i><b>(6)</b>
    unittest.main(warnings='ignore')  <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll probably notice a few things here:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tests are organised into classes, which inherit from <code>unittest.TestCase</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The main body of the test is in a method called
<code>test_can_start_&#x200b;a_list_and_retrieve_it_later</code>. Any method
whose name starts with <code>test</code> is a test method, and will be run by the
test runner. You can have more than one <code>test_</code> method per class. Nice
descriptive names for our test methods are a good idea too.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>setUp</code> and <code>tearDown</code> are special methods which get
run before and after each test.  I&#8217;m using them to start and stop our
browser&#8212;&#8203;note that they&#8217;re a bit like a <code>try/finally</code>, in that <code>tearDown</code> will
run even if there&#8217;s an error during the test
itself.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnote_4" title="View footnote.">4</a>]</sup>
No more Firefox windows left lying around!</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We use <code>self.assertIn</code> instead of just <code>assert</code> to make our test
assertions. <code>unittest</code> provides lots of helper functions like this to make
test assertions, like <code>assertEqual</code>, <code>assertTrue</code>, <code>assertFalse</code>, and so
on. You can find more in the
<a href="http://docs.python.org/3/library/unittest.html"><code>unittest</code> documentation</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>self.fail</code> just fails no matter what, producing the error message given.
I&#8217;m using it as a reminder to finish the test.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Finally, we have the <code>if __name__ == '__main__'</code> clause (if you&#8217;ve not seen it
before, that&#8217;s how a Python script checks if it&#8217;s been executed from the
command line, rather than just imported by another script). We call
<code>unittest.main()</code>, which launches the <code>unittest</code> test runner, which will
automatically find test classes and methods in the file and run them.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>warnings='ignore'</code> suppresses a superfluous <code>ResourceWarning</code> which
was being emitted at the time of writing.  It may have disappeared by the
time you read this; feel free to try removing it!</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve read the Django testing documentation, you might have seen
something called <code>LiveServerTestCase</code>, and are wondering whether we should
use it now. Full points to you for reading the friendly manual!
<code>LiveServerTestCase</code> is a bit too complicated for now, but I promise I&#8217;ll
use it in a later chapter&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s try it!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 18, in
test_can_start_a_list_and_retrieve_it_later
    self.assertIn('To-Do', self.browser.title)
AssertionError: 'To-Do' not found in 'Welcome to Django'

 ---------------------------------------------------------------------
Ran 1 test in 1.747s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a bit nicer, isn&#8217;t it? It tidied up our Firefox window, it gives us a
nicely formatted report of how many tests were run and how many failed, and
the <code>assertIn</code> has given us a helpful error message with useful debugging info.
Bonzer!</p>
</div>
</div>
<div class="sect2">
<h3 id="_commit">2.3. Commit</h3>
<div class="paragraph">
<p>This
is a good point to do a commit; it&#8217;s a nicely self-contained change. We&#8217;ve
expanded our functional test to include comments that describe the task we&#8217;re
setting ourselves, our minimum viable to-do list. We&#8217;ve also rewritten it to
use the Python <code>unittest</code> module and its various testing helper functions.</p>
</div>
<div class="paragraph">
<p>Do a <strong><code>git status</code></strong>&mdash;that should assure you that the only file that has
changed is <em>functional_tests.py</em>.  Then do a <strong><code>git diff</code></strong>, which shows you the
difference between the last commit and what&#8217;s currently on disk. That should
tell you that <em>functional_tests.py</em> has changed quite substantially:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
diff --git a/functional_tests.py b/functional_tests.py
index d333591..b0f22dc 100644
--- a/functional_tests.py
+++ b/functional_tests.py
@@ -1,6 +1,45 @@
 from selenium import webdriver
+import unittest

-browser = webdriver.Firefox()
-browser.get('http://localhost:8000')
+class NewVisitorTest(unittest.TestCase):

-assert 'Django' in browser.title
+    def setUp(self):
+        self.browser = webdriver.Firefox()
+
+    def tearDown(self):
+        self.browser.quit()
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s do a:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-a</code> means &#8220;automatically add any changes to tracked files&#8221; (i.e., any
files that we&#8217;ve committed before). It won&#8217;t add any brand new files (you have
to explicitly <code>git add</code> them yourself), but often, as in this case, there aren&#8217;t
any new files, so it&#8217;s a useful shortcut.</p>
</div>
<div class="paragraph">
<p>When the editor pops up, add a descriptive commit message, like &#8220;First FT
specced out in comments, and now uses unittest.&#8221;</p>
</div>
<div class="paragraph">
<p>Now we&#8217;re in an excellent position to start writing some real code for our
lists app.  Read on!</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Useful TDD Concepts</div>
<div class="dlist">
<dl>
<dt class="hdlist1">User Story</dt>
<dd>
<p>A
description of how the application will work from the point of view
of the user.  Used to structure a functional test.</p>
</dd>
<dt class="hdlist1">Expected failure</dt>
<dd>
<p>When
a test fails in the way that we expected it to.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_unit_test_first_view">3. Testing a Simple Home Page with <span class="keep-together">Unit Tests</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>We finished the last chapter with a functional test failing, telling us that it
wanted the home page for our site to have &#8220;To-Do&#8221; in its title. It&#8217;s time to
start working on our application.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Warning: Things Are About to Get Real</div>
<div class="paragraph">
<p>The first two chapters were intentionally nice and light.  From now on, we
get into some more meaty coding.  Here&#8217;s a prediction:  at some point, things
are going to go wrong.  You&#8217;re going to see different results from what I say
you should see. This is a Good Thing, because it will be a genuine
character-building Learning Experience&#8482;.</p>
</div>
<div class="paragraph">
<p>One possibility is that I&#8217;ve given some ambiguous explanations, and you&#8217;ve
done something different from what I intended. Step back and have a think about
what we&#8217;re trying to achieve at this point in the book. Which file are we
editing, what do we want the user to be able to do, what are we testing and
why?  It may be that you&#8217;ve edited the wrong file or function, or are running
the wrong tests.  I reckon you&#8217;ll learn more about TDD from these "stop and think"
moments than you do from all the times when following instructions and
copy-pasting goes smoothly.</p>
</div>
<div class="paragraph">
<p>Or it may be a real bug. Be tenacious, read the error message carefully (see <a href="#read_tracebacks_aside">Reading Tracebacks</a> a little later on in the chapter), and
you&#8217;ll get to the bottom of it. It&#8217;s probably just a missing comma, or
trailing slash, or maybe a missing <em>s</em> in one of the Selenium find methods.
But, as <a href="#lpthw">Zed Shaw put it so well</a>, this kind of debugging is also an
absolutely vital part of learning, so do stick it out!</p>
</div>
<div class="paragraph">
<p>You
can always drop me an email (or try the
<a href="https://groups.google.com/forum/#!forum/obey-the-testing-goat-book">Google
Group</a>) if you get really stuck.  Happy debugging!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_our_first_django_app_and_our_first_unit_test">3.1. Our First Django App, and Our First Unit Test</h3>
<div class="paragraph">
<p>Django
encourages you to structure your code into <em>apps</em>: the theory is that
one project can have many apps, you can use third-party apps developed by other
people, and you might even reuse one of your own apps in a different
project&#8230;&#8203;although I admit I&#8217;ve never actually managed it myself!  Still, apps
are a good way to keep your code organised.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start an app for our to-do lists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py startapp lists</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That will create a folder called <em>lists</em>, next to <em>manage.py</em> and the existing
<em>superlists</em> folder , and within it a number of placeholder files for things
like models, views, and, of immediate interest to us, tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
├── db.sqlite3
├── functional_tests.py
├── lists
│   ├── admin.py
│   ├── apps.py
│   ├── __init__.py
│   ├── migrations
│   │   └── __init__.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── manage.py
├── superlists
│   ├── __init__.py
│   ├── __pycache__
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
└── virtualenv
    ├── [...]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unit_tests_and_how_they_differ_from_functional_tests">3.2. Unit Tests, and How They Differ from Functional Tests</h3>
<div class="paragraph">
<p>As
with so many of the labels we put on things, the line between unit tests and
functional tests can become a little blurry at times. The basic distinction,
though, is that functional tests test the application from the outside, from
the point of view of the user. Unit tests test the application from the
inside, from the point of view of the <span class="keep-together">programmer</span>.</p>
</div>
<div class="paragraph">
<p>The TDD approach I&#8217;m following wants our application to be covered by
both types of test. Our workflow will look a bit like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We start by writing a <em>functional test</em>, describing the new functionality
from the user&#8217;s point of view.</p>
</li>
<li>
<p>Once we have a functional test that fails, we start to think about how
to write code that can get it to pass (or at least to get past its current
failure). We now use one or more <em>unit tests</em> to define how we want our
code to behave&#8212;&#8203;the idea is that each line of production code we write
should be tested by (at least) one of our unit tests.</p>
</li>
<li>
<p>Once we have a failing unit test, we write the smallest amount of
<em>application code</em> we can, just enough to get the unit test to pass.
We may iterate between steps 2 and 3 a few times, until we think the
functional test will get a little further.</p>
</li>
<li>
<p>Now we can rerun our functional tests and see if they pass, or get a
little further.  That may prompt us to write some new unit tests, and
some new code, and so on.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can see that, all the way through, the functional tests are driving what
development we do from a high level, while the unit tests drive what we do
at a low level.</p>
</div>
<div class="paragraph">
<p>Does that seem slightly redundant? Sometimes it can feel that way, but
functional tests and unit tests do really have very different objectives, and
they will usually end up looking quite different.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Functional tests should help you build an application with the right
functionality, and guarantee you never accidentally break it.  Unit tests
should help you to write code that&#8217;s clean and bug free.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enough theory for now—let&#8217;s see how it looks in practice.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_in_django">3.3. Unit Testing in Django</h3>
<div class="paragraph">
<p>Let&#8217;s
see how to write a unit test for our home page view. Open up the new
file at <em>lists/tests.py</em>, and you&#8217;ll see something like this:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase

# Create your tests here.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django has helpfully suggested we use a special version of <code>TestCase</code>, which
it provides. It&#8217;s an augmented version of the standard <code>unittest.TestCase</code>,
with some additional Django-specific features, which we&#8217;ll discover over the
next few chapters.</p>
</div>
<div class="paragraph">
<p>You&#8217;ve already seen that the TDD cycle involves starting with a test that
fails, then writing code to get it to pass. Well, before we can even get that
far, we want to know that the unit test we&#8217;re writing will definitely be
run by our automated test runner, whatever it is.  In the case of
<em>functional_tests.py</em>, we&#8217;re running it directly, but this file made by Django
is a bit more like magic. So, just to make sure, let&#8217;s make a deliberately
silly failing test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase

class SmokeTest(TestCase):

    def test_bad_maths(self):
        self.assertEqual(1 + 1, 3)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s invoke this mysterious Django test runner. As usual, it&#8217;s a
<em>manage.py</em> <span class="keep-together">command</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
F
======================================================================
FAIL: test_bad_maths (lists.tests.SmokeTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests.py", line 6, in test_bad_maths
    self.assertEqual(1 + 1, 3)
AssertionError: 2 != 3

 ---------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (failures=1)
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Excellent.  The machinery seems to be working. This is a good point for a
commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>  # should show you lists/ is untracked
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>  # will show you the diff that you're about to commit
$ <strong>git commit -m "Add app for lists, with deliberately failing unit test"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>As you&#8217;ve no doubt guessed, the <code>-m</code> flag lets you pass in a commit message
at the command line, so you don&#8217;t need to use an editor. It&#8217;s up to you
to pick the way you like to use the Git command line; I&#8217;ll just show you
the main ones I&#8217;ve seen used.  The key rule is: <em>make sure you always review
what you&#8217;re about to commit before you do it</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_django_s_mvc_urls_and_view_functions">3.4. Django&#8217;s MVC, URLs, and View Functions</h3>
<div class="paragraph">
<p>Django
is structured along a classic <em>Model-View-Controller</em>
(MVC) pattern.  Well, <em>broadly</em>.  It definitely does have models, but its
views are more like a controller, and it&#8217;s the templates that are actually the
view part, but the general idea is there.  If you&#8217;re interested, you can
look up the finer points of the discussion
<a href="https://docs.djangoproject.com/en/1.11/faq/general/">in the Django FAQs</a>.</p>
</div>
<div class="paragraph">
<p>Irrespective of any of that, as with any web server, Django&#8217;s main job is to
decide what to do when a user asks for a particular URL on our site.
Django&#8217;s workflow goes something like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An HTTP <em>request</em> comes in for a particular <em>URL</em>.</p>
</li>
<li>
<p>Django uses some rules to decide which <em>view</em> function should deal with
the request (this is referred to as <em>resolving</em> the URL).</p>
</li>
<li>
<p>The view function processes the request and returns an HTTP <em>response</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So we want to test two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can we resolve the URL for the root of the site (&#8220;/&#8221;) to a particular
view function we&#8217;ve made?</p>
</li>
<li>
<p>Can we make this view function return some HTML which will get the
functional test to pass?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the first. Open up <em>lists/tests.py</em>, and change our silly
test to something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.urls import resolve
from django.test import TestCase
from lists.views import home_page  <i class="conum" data-value="2"></i><b>(2)</b>

class HomePageTest(TestCase):

    def test_root_url_resolves_to_home_page_view(self):
        found = resolve('/')  <i class="conum" data-value="1"></i><b>(1)</b>
        self.assertEqual(found.func, home_page)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s going on here?</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>resolve</code> is the function Django uses internally to resolve
URLs and find what view function they should map to.  We&#8217;re checking that
<code>resolve</code>, when called with &#8220;/&#8221;, the root of the site, finds a function
called <code>home_page</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>What function is that?  It&#8217;s the view function we&#8217;re going to
write next, which will actually return the HTML we want.  You can see from
the <code>import</code> that we&#8217;re planning to store it in <em>lists/views.py</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So, what do you think will happen when we run the tests?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
ImportError: cannot import name 'home_page'</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a very predictable and uninteresting error: we tried to import something
we haven&#8217;t even written yet. But it&#8217;s still good news&#8212;&#8203;for the purposes of
TDD, an exception which was predicted counts as an expected failure.
Since we have both a failing functional test and a failing unit test, we have
the Testing Goat&#8217;s full blessing to code away.</p>
</div>
</div>
<div class="sect2">
<h3 id="_at_last_we_actually_write_some_application_code">3.5. At Last! We Actually Write Some Application Code!</h3>
<div class="paragraph">
<p>It is exciting, isn&#8217;t it?  Be warned, TDD means that long periods of
anticipation are only defused very gradually, and by tiny increments.
Especially since we&#8217;re learning and only just starting out, we only allow
ourselves to change (or add) one line of code at a time&#8212;&#8203;and each time, we
make just the minimal change required to address the current test failure.</p>
</div>
<div class="paragraph">
<p>I&#8217;m being deliberately extreme here, but what&#8217;s our current test failure?
We can&#8217;t import <code>home_page</code> from <code>lists.views</code>?  OK, let&#8217;s fix that&#8212;&#8203;and only
that.  In <em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.shortcuts import render

# Create your views here.
home_page = None</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><em>"You must be joking!"</em> I can hear you say.</p>
</div>
<div class="paragraph">
<p>I can hear you because it&#8217;s what I used to say (with feeling) when
my colleagues first demonstrated TDD to me.  Well, bear with me, and we&#8217;ll talk
about whether or not this is all taking it too far in a little while.  But for
now, let yourself follow along, even if it&#8217;s with some exasperation, and see
if our tests can help us write the correct code, one tiny step at a time.</p>
</div>
<div class="paragraph">
<p>We run the tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
E
======================================================================
ERROR: test_root_url_resolves_to_home_page_view (lists.tests.HomePageTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests.py", line 8, in
test_root_url_resolves_to_home_page_view
    found = resolve('/')
  File ".../django/urls/base.py", line 27, in resolve
    return get_resolver(urlconf).resolve(path)
  File ".../django/urls/resolvers.py", line 394, in resolve
    raise Resolver404({'tried': tried, 'path': new_path})
django.urls.exceptions.Resolver404: {'tried': [[&lt;RegexURLResolver
&lt;RegexURLPattern list&gt; (admin:admin) ^admin/&gt;]], 'path': ''}

 ---------------------------------------------------------------------
Ran 1 test in 0.002s

FAILED (errors=1)
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div id="read_tracebacks_aside" class="sidebarblock">
<div class="content">
<div class="title">Reading Tracebacks</div>
<div class="paragraph">
<p>Let&#8217;s
spend a moment talking about how to read tracebacks, since it&#8217;s something
we have to do a lot in TDD. You soon learn to scan through them and pick up
relevant clues:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>======================================================================
ERROR: test_root_url_resolves_to_home_page_view (lists.tests.HomePageTest)  <i class="conum" data-value="2"></i><b>(2)</b>
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests.py", line 8, in
test_root_url_resolves_to_home_page_view
    found = resolve('/')  <i class="conum" data-value="3"></i><b>(3)</b>
  File ".../django/urls/base.py", line 27, in resolve
    return get_resolver(urlconf).resolve(path)
  File ".../django/urls/resolvers.py", line 394, in resolve
    raise Resolver404({'tried': tried, 'path': new_path})
django.urls.exceptions.Resolver404: {'tried': [[&lt;RegexURLResolver  <i class="conum" data-value="1"></i><b>(1)</b>
&lt;RegexURLPattern list&gt; (admin:admin) ^admin/&gt;]], 'path': ''}  <i class="conum" data-value="1"></i><b>(1)</b>
 ---------------------------------------------------------------------
[...]</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first place you look is usually <em>the error itself</em>. Sometimes that&#8217;s
all you need to see, and it will let you identify the problem immediately.
But sometimes, like in this case, it&#8217;s not quite self-evident.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The next thing to double-check is: <em>which test is failing?</em> Is it
definitely the one we expected&#8212;&#8203;that is, the one we just wrote?  In this case,
the answer is yes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then we look for the place in <em>our test code</em> that kicked off the failure.
We work our way down from the top of the traceback, looking for the
filename of the tests file, to check which test function, and what line of
code, the failure is coming from.  In this case it&#8217;s the line where we call
the <code>resolve</code> function for the "/" URL.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is ordinarily a fourth step, where we look further down for any
of <em>our own application code</em> which was involved with the problem.  In this
case it&#8217;s all Django code, but we&#8217;ll see plenty of examples of this fourth step
later in the book.</p>
</div>
<div class="paragraph">
<p>Pulling it all together, we interpret the traceback as telling us that, when
trying to resolve &#8220;/&#8221;, Django raised a 404 error&#8212;&#8203;in other words, Django
can&#8217;t find a URL mapping for &#8220;/&#8221;.  Let&#8217;s help it out.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_urls_py">3.6. urls.py</h3>
<div class="paragraph">
<p>Our
tests are telling us that we need a URL mapping. Django uses a file called
<em>urls.py</em> to map URLs to view functions. There&#8217;s a main <em>urls.py</em> for the whole
site in the <em>superlists/superlists</em> folder. Let&#8217;s go take a look:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">"""superlists URL Configuration

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/1.11/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  url(r'^$', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  url(r'^$', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.conf.urls import url, include
    2. Add a URL to urlpatterns:  url(r'^blog/', include('blog.urls'))
"""
from django.conf.urls import url
from django.contrib import admin

urlpatterns = [
    url(r'^admin/', admin.site.urls),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As usual, lots of helpful comments and default suggestions from Django.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If your <em>urls.py</em> looks different or if it mentions a function called
    <code>path</code> instead of <code>url</code>, it&#8217;s because you&#8217;ve got the wrong version of
    Django.  This book is written for Django v1.11.  Take another look at
    the "<a href="#pre-requisites">Prerequisites and Assumptions</a>" section and get the right version before you
    go any further.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>url</code> entry starts with a regular expression that defines which URLs it
applies to, and goes on to say where it should send those requests&#8212;&#8203;either to
a view function you&#8217;ve imported, or maybe to another <em>urls.py</em> file somewhere
else.</p>
</div>
<div class="paragraph">
<p>The first example entry has the regular expression <code>^$</code>, which means
an empty string&#8212;&#8203;could this be the same as the root of our site, which we&#8217;ve
been testing with &#8220;/&#8221;?  Let&#8217;s find out&#8212;&#8203;what happens if we include it?</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve never come across regular expressions, you can get away with
    just taking my word for it, for now&#8212;&#8203;but you should make a mental note to
    go learn about them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll also get rid of the admin URL, because we won&#8217;t be using the Django
admin site for now:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch03l003">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import url
from lists import views

urlpatterns = [
    url(r'^$', views.home_page, name='home'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Run the unit tests again, with <strong><code>python manage.py test</code></strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
TypeError: view must be a callable or a list/tuple in the case of include().</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s progress!  We&#8217;re no longer getting a 404.</p>
</div>
<div class="paragraph">
<p>The traceback is messy, but the message at the end is telling us what&#8217;s going
on: the unit tests have actually made the link between the URL "/" and the
<code>home_page = None</code> in <em>lists/views.py</em>, and are now complaining that the
<code>home_page</code> view is not callable. And that gives us a justification for
changing it from being <code>None</code> to being an actual function. Every single code
change is driven by the tests!</p>
</div>
<div class="paragraph">
<p>Back in <em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.shortcuts import render

# Create your views here.
def home_page():
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
.
 ---------------------------------------------------------------------
Ran 1 test in 0.003s

OK
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray! Our first ever unit test pass!  That&#8217;s so momentous that I think it&#8217;s
worthy of a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>  # should show changes to urls.py, tests.py, and views.py
$ <strong>git commit -am "First unit test and url mapping, dummy view"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That was the last variation on <code>git commit</code> I&#8217;ll show, the <code>a</code> and <code>m</code> flags
together, which adds all changes to tracked files and uses the commit message
from the command line.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>git commit -am</code> is the quickest formulation, but also gives you the
    least feedback about what&#8217;s being committed, so make sure you&#8217;ve done a
    <code>git status</code> and a <code>git diff</code> beforehand, and are clear on what changes are
    about to go in.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_a_view">3.7. Unit Testing a View</h3>
<div class="paragraph">
<p>On
to writing a test for our view, so that it can be something more than a
do-nothing function, and instead be a function that returns a real response
with HTML to the browser. Open up <em>lists/tests.py</em>, and add a new
<em>test method</em>. I&#8217;ll explain each bit:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.urls import resolve
from django.test import TestCase
from django.http import HttpRequest

from lists.views import home_page


class HomePageTest(TestCase):

    def test_root_url_resolves_to_home_page_view(self):
        found = resolve('/')
        self.assertEqual(found.func, home_page)


    def test_home_page_returns_correct_html(self):
        request = HttpRequest()  <i class="conum" data-value="1"></i><b>(1)</b>
        response = home_page(request)  <i class="conum" data-value="2"></i><b>(2)</b>
        html = response.content.decode('utf8')  <i class="conum" data-value="3"></i><b>(3)</b>
        self.assertTrue(html.startswith('&lt;html&gt;'))  <i class="conum" data-value="4"></i><b>(4)</b>
        self.assertIn('&lt;title&gt;To-Do lists&lt;/title&gt;', html)  <i class="conum" data-value="5"></i><b>(5)</b>
        self.assertTrue(html.endswith('&lt;/html&gt;'))  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s going on in this new test?</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create an <code>HttpRequest</code> object, which is what Django will see when
a user&#8217;s browser asks for a page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We pass it to our <code>home_page</code> view, which gives us a response. You won&#8217;t be
surprised to hear that this object is an instance of a class called
<code>HttpResponse</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then, we extract the <code>.content</code> of the response.  These are the raw bytes,
the ones and zeros that would be sent down the wire to the user&#8217;s browser.
We call <code>.decode()</code> to convert them into the string of HTML that&#8217;s being
sent to the user.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We want it to start with an <code>&lt;html&gt;</code> tag which gets closed at the end.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And we want a <code>&lt;title&gt;</code> tag somewhere in the middle, with the words
"To-Do lists" in it&#8212;&#8203;because that&#8217;s what we specified in our functional test.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once again, the unit test is driven by the functional test, but it&#8217;s also
much closer to the actual code&#8212;&#8203;we&#8217;re thinking like programmers now.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s run the unit tests now and see how we get on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: home_page() takes 0 positional arguments but 1 was given</pre>
</div>
</div>
<div class="sect3">
<h4 id="_the_unit_test_code_cycle">3.7.1. The Unit-Test/Code Cycle</h4>
<div class="paragraph">
<p>We
can start to settle into the TDD <em>unit-test/code cycle</em> now:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal, run the unit tests and see how they fail.</p>
</li>
<li>
<p>In the editor, make a minimal code change to address the current test failure.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And repeat!</p>
</div>
<div class="paragraph">
<p>The more nervous we are about getting our code right, the smaller and more
minimal we make each code change&#8212;&#8203;the idea is to be absolutely sure that each
bit of code is justified by a test.</p>
</div>
<div class="paragraph">
<p>This may seem laborious, and at first, it will be.  But once you get into the
swing of things, you&#8217;ll find yourself coding quickly even if you take
microscopic steps&#8212;&#8203;this is how we write all of our production code at work.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how fast we can get this cycle going:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Minimal code change:</p>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    pass</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Tests:</p>
<div class="listingblock">
<div class="content">
<pre>html = response.content.decode('utf8')
AttributeError: 'NoneType' object has no attribute 'content'</pre>
</div>
</div>
</li>
<li>
<p>Code&#8212;&#8203;we use <code>django.http.HttpResponse</code>, as predicted:</p>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.http import HttpResponse

# Create your views here.
def home_page(request):
    return HttpResponse()</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Tests again:</p>
<div class="listingblock">
<div class="content">
<pre>    self.assertTrue(html.startswith('&lt;html&gt;'))
AssertionError: False is not true</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>Code again:</p>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return HttpResponse('&lt;html&gt;')</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Tests:</p>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '&lt;title&gt;To-Do lists&lt;/title&gt;' not found in '&lt;html&gt;'</pre>
</div>
</div>
</li>
<li>
<p>Code:</p>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return HttpResponse('&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;')</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Tests&#8212;&#8203;almost there?</p>
<div class="listingblock">
<div class="content">
<pre>    self.assertTrue(html.endswith('&lt;/html&gt;'))
AssertionError: False is not true</pre>
</div>
</div>
</li>
<li>
<p>Come on, one last effort:</p>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return HttpResponse('&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;&lt;/html&gt;')</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Surely?</p>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
..
 ---------------------------------------------------------------------
Ran 2 tests in 0.001s

OK
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Yes!  Now, let&#8217;s run our functional tests.  Don&#8217;t forget to spin up the dev
server again, if it&#8217;s not still running. It feels like the final heat
of the race here; surely this is it&#8230;&#8203;could it be?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 19, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 1.609s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Failed? What? Oh, it&#8217;s just our little reminder? Yes? Yes! We have a web page!</p>
</div>
<div class="paragraph">
<p>Ahem.  Well, <em>I</em> thought it was a thrilling end to the chapter. You may still
be a little baffled, perhaps keen to hear a justification for all these tests,
and don&#8217;t worry, all that will come, but I hope you felt just a tinge of
excitement near the end there.</p>
</div>
<div class="paragraph">
<p>Just a little commit to calm down, and reflect on what we&#8217;ve covered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>  # should show our new test in tests.py, and the view in views.py
$ <strong>git commit -am "Basic view now returns minimal HTML"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That
was quite a chapter! Why not try typing <code>git log</code>, possibly using the
<code>--oneline</code> flag, for a reminder of what we got up to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git log --oneline</strong>
a6e6cc9 Basic view now returns minimal HTML
450c0f3 First unit test and url mapping, dummy view
ea2b037 Add app for lists, with deliberately failing unit test
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Not bad&#8212;&#8203;we covered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Starting a Django app</p>
</li>
<li>
<p>The Django unit test runner</p>
</li>
<li>
<p>The difference between FTs and unit tests</p>
</li>
<li>
<p>Django URL resolving and <em>urls.py</em></p>
</li>
<li>
<p>Django view functions, request and response objects</p>
</li>
<li>
<p>And returning basic HTML</p>
</li>
</ul>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Useful Commands and Concepts</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Running the Django dev server</dt>
<dd>
<p><strong><code>python manage.py runserver</code></strong></p>
</dd>
<dt class="hdlist1">Running the functional tests</dt>
<dd>
<p><strong><code>python functional_tests.py</code></strong></p>
</dd>
<dt class="hdlist1">Running the unit tests</dt>
<dd>
<p><strong><code>python manage.py test</code></strong></p>
</dd>
<dt class="hdlist1">The unit-test/code cycle</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the unit tests in the terminal.</p>
</li>
<li>
<p>Make a minimal code change in the editor.</p>
</li>
<li>
<p>Repeat!</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_philosophy_and_refactoring">4. What Are We Doing with All These Tests? (And, Refactoring)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now
that we&#8217;ve seen the basics of TDD in action, it&#8217;s time to pause
and talk about why we&#8217;re doing it.</p>
</div>
<div class="paragraph">
<p>I&#8217;m imagining several of you, dear readers, have been holding back
some seething frustration&#8212;&#8203;perhaps some of you have done a bit of unit
testing before, and perhaps some of you are just in a hurry. You&#8217;ve been
biting back questions like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Aren&#8217;t all these tests a bit excessive?</p>
</li>
<li>
<p>Surely some of them are redundant? There&#8217;s duplication between
the functional tests and the unit tests.</p>
</li>
<li>
<p>I mean, what are you doing importing <code>django.urls.resolve</code> in your
unit tests?  Isn&#8217;t that testing Django&#8212;&#8203;that is, testing third-party code? I
thought that was a no-no?</p>
</li>
<li>
<p>Those unit tests seemed way too trivial&#8212;&#8203;testing one line of declaration,
and a one-line function that returns a constant! Isn&#8217;t that just a waste of
time? Shouldn&#8217;t we save our tests for more complex things?</p>
</li>
<li>
<p>What about all those tiny changes during the unit-test/code cycle?  Surely we
could have just skipped to the end? I mean, <code>home_page = None</code>!? Really?</p>
</li>
<li>
<p>You&#8217;re not telling me you <em>actually</em> code like this in real life?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ah, young grasshopper. I too was once full of questions like these.  But only
because they&#8217;re perfectly good questions.  In fact, I still ask myself
questions like these, all the time. Does all this stuff really have value? Is
this a bit of a cargo cult?</p>
</div>
<div class="sect2">
<h3 id="_programming_is_like_pulling_a_bucket_of_water_up_span_class_keep_together_from_a_well_span">4.1. Programming Is Like Pulling a Bucket of Water Up <span class="keep-together">from a Well</span></h3>
<div class="paragraph">
<p>Ultimately, programming is hard.  Often, we are smart, so we succeed.  TDD is
there to help us out when we&#8217;re not so smart.  Kent Beck (who basically
invented TDD) uses the metaphor of lifting a bucket of water out of a well
with a rope:  when the well isn&#8217;t too deep, and the bucket isn&#8217;t very full,
it&#8217;s easy. And even lifting a full bucket is pretty easy at first.  But after a
while, you&#8217;re going to get tired. TDD is like having a ratchet that lets you
save your progress, take a break, and make sure you never slip backwards.  That
way you don&#8217;t have to be smart <em>all</em> the time.</p>
</div>
<div id="figure4-1" class="imageblock" style="float: right">
<div class="content">
<img src="images/twp2_0401.png" alt="Test ALL the things">
</div>
<div class="title">Figure 5. Test ALL the things (original illustration source: <a href="http://bit.ly/1iXxdYp">Allie Brosh, Hyperbole and a Half</a>)</div>
</div>
<div class="paragraph">
<p>OK, perhaps <em>in general</em>, you&#8217;re prepared to concede that TDD is a good
idea, but maybe you still think I&#8217;m overdoing it?  Testing the tiniest thing,
and taking ridiculously many small steps?</p>
</div>
<div class="paragraph">
<p>TDD is a <em>discipline</em>, and that means it&#8217;s not something that comes naturally;
because many of the payoffs aren&#8217;t immediate but only come in the longer term,
you have to force yourself to do it in the moment. That&#8217;s what the image of the
Testing Goat is supposed to illustrate&#8212;&#8203;you need to be a bit bloody-minded
about it.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">On the Merits of Trivial Tests for Trivial Functions</div>
<div class="paragraph">
<p>In the short term it may feel a bit silly to write tests for simple
functions and <span class="keep-together">constants</span>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s perfectly possible to imagine still doing
&#8220;mostly&#8221; TDD, but following more relaxed rules where you don&#8217;t unit test
<em>absolutely</em> everything.  But in this book my aim is to demonstrate full,
rigorous TDD. Like a kata in a martial art, the idea is to learn the motions
in a controlled context, when there is no adversity, so that the techniques
are part of your muscle memory. It seems trivial now, because we&#8217;ve started
with a very simple example. The problem comes when your application gets
complex&#8212;&#8203;that&#8217;s when you really need your tests.  And the danger is that
complexity tends to sneak up on you, gradually.  You may not notice it
happening, but quite soon you&#8217;re a boiled frog.</p>
</div>
<div class="paragraph">
<p>There are two other things to say in favour of tiny, simple tests for simple
functions.</p>
</div>
<div class="paragraph">
<p>Firstly, if they&#8217;re really trivial tests, then they won&#8217;t take you that long to
write them. So stop moaning and just write them already.</p>
</div>
<div class="paragraph">
<p>Secondly, it&#8217;s always good to have a placeholder.  Having a test <em>there</em> for a
simple function means it&#8217;s that much less of a psychological barrier to
overcome when the simple function gets a tiny bit more complex&#8212;&#8203;perhaps it
grows an <code>if</code>. Then a few weeks later it grows a <code>for</code> loop. Before you know
it, it&#8217;s a recursive metaclass-based polymorphic tree parser factory.  But
because it&#8217;s had tests from the very beginning, adding a new test each time has
felt quite natural, and it&#8217;s well tested.  The alternative involves trying to
decide when a function becomes &#8220;complicated enough&#8221;, which is highly
subjective, but worse, because there&#8217;s no placeholder, it seems like that
much more effort, and you&#8217;re tempted each time to put it off a little longer,
and pretty soon&#8212;&#8203;frog soup!</p>
</div>
<div class="paragraph">
<p>Instead of trying to figure out some hand-wavy subjective rules for when
you should write tests, and when you can get away with not bothering, I suggest
following the discipline for now&#8212;&#8203;as with any discipline, you have to take the
time to learn the rules before you can break them.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, back to our onions.</p>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_using_selenium_to_test_user_interactions">4.2. Using Selenium to Test User Interactions</h3>
<div class="paragraph">
<p>Where
were we at the end of the last chapter? Let&#8217;s rerun the test and find
out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 19, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 1.609s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Did you try it, and get an error saying <em>Problem loading page</em> or
<em>Unable to connect</em>?  So did I. It&#8217;s because we forgot to spin up the dev
server first using <code>manage.py runserver</code>.  Do that, and you&#8217;ll get the failure
message we&#8217;re after.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of the great things about TDD is that you never have to worry about
    forgetting what to do next&#8212;&#8203;just rerun your tests and they will tell
    you what you need to work on.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>&#8220;Finish the test&#8221;, it says, so let&#8217;s do just that!  Open up
<em>functional_tests.py</em> and we&#8217;ll extend our FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver
from selenium.webdriver.common.keys import Keys
import time
import unittest

class NewVisitorTest(unittest.TestCase):

    def setUp(self):
        self.browser = webdriver.Firefox()

    def tearDown(self):
        self.browser.quit()

    def test_can_start_a_list_and_retrieve_it_later(self):
        # Edith has heard about a cool new online to-do app. She goes
        # to check out its homepage
        self.browser.get('http://localhost:8000')

        # She notices the page title and header mention to-do lists
        self.assertIn('To-Do', self.browser.title)
        header_text = self.browser.find_element_by_tag_name('h1').text  <i class="conum" data-value="1"></i><b>(1)</b>
        self.assertIn('To-Do', header_text)

        # She is invited to enter a to-do item straight away
        inputbox = self.browser.find_element_by_id('id_new_item')  <i class="conum" data-value="1"></i><b>(1)</b>
        self.assertEqual(
            inputbox.get_attribute('placeholder'),
            'Enter a to-do item'
        )

        # She types "Buy peacock feathers" into a text box (Edith's hobby
        # is tying fly-fishing lures)
        inputbox.send_keys('Buy peacock feathers')  <i class="conum" data-value="2"></i><b>(2)</b>

        # When she hits enter, the page updates, and now the page lists
        # "1: Buy peacock feathers" as an item in a to-do list table
        inputbox.send_keys(Keys.ENTER)  <i class="conum" data-value="3"></i><b>(3)</b>
        time.sleep(1)  <i class="conum" data-value="4"></i><b>(4)</b>

        table = self.browser.find_element_by_id('id_list_table')
        rows = table.find_elements_by_tag_name('tr')  <i class="conum" data-value="1"></i><b>(1)</b>
        self.assertTrue(
            any(row.text == '1: Buy peacock feathers' for row in rows)
        )

        # There is still a text box inviting her to add another item. She
        # enters "Use peacock feathers to make a fly" (Edith is very
        # methodical)
        self.fail('Finish the test!')

        # The page updates again, and now shows both items on her list
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;re using several of the methods that Selenium provides to examine web
pages: <code>find_element_by_tag_name</code>, <code>find_element_by_id</code>, and
<code>find&#x2060;_ele&#x2060;ment&#x2060;<strong>s</strong>&#x2060;_by&#x2060;_&#x200b;tag_name</code> (notice the extra <code>s</code>, which means it will
return several elements rather than just one).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We also use <code>send_keys</code>, which is Selenium&#8217;s way of typing into input
elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>Keys</code> class (don&#8217;t forget to import it) lets us send special keys
like Enter.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnote_5" title="View footnote.">5</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When we hit Enter, the page will refresh. The <code>time.sleep</code> is there to make
sure the browser has finished loading before we make any assertions about
the new page.  This is called an "explicit wait" (a very simple one; we&#8217;ll
improve it in <a href="#chapter_explicit_waits_1">Improving Functional Tests: Ensuring Isolation and Removing Voodoo Sleeps</a>).</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Watch out for the difference between the Selenium <code>find_element_...</code>
    and <code>find_elements_...</code> functions.  One returns an element and raises
    an exception if it can&#8217;t find it, whereas the other returns a list, which
    may be empty.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also, just look at that <code>any</code> function. It&#8217;s a little-known Python built-in.
I don&#8217;t even need to explain it, do I? Python is such a joy.</p>
</div>
<div class="paragraph">
<p>Although, if you&#8217;re one of my readers who doesn&#8217;t know Python, what&#8217;s happening
inside the <code>any</code> is a <em>generator expression</em>, which is like a <em>list
comprehension</em> but awesomer. You need to read up on this. If you Google it,
you&#8217;ll find <a href="http://bit.ly/1iXxD18">Guido himself explaining it nicely</a>.
Come back and tell me that&#8217;s not pure joy!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how it gets on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: h1</pre>
</div>
</div>
<div class="paragraph">
<p>Decoding that, the test is saying it can&#8217;t find an <code>&lt;h1&gt;</code> element on the page.
Let&#8217;s see what we can do to add that to the HTML of our home page.</p>
</div>
<div class="paragraph">
<p>Big
changes to a functional test are usually a good thing to commit on their
own. I failed to do so in my first draft, and I regretted it later when I
changed my mind and had the change mixed up with a bunch of others.  The more
atomic your commits, the better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>  # should show changes to functional_tests.py
$ <strong>git commit -am "Functional test now checks we can input a to-do item"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_don_t_test_constants_rule_and_templates_to_the_rescue">4.3. The &#8220;Don&#8217;t Test Constants&#8221; Rule, and Templates to the Rescue</h3>
<div class="paragraph">
<p>Let&#8217;s
take a look at our unit tests, <em>lists/tests.py</em>.  Currently we&#8217;re looking
for specific HTML strings, but that&#8217;s not a particularly efficient way of
testing HTML.  In general, one of the rules of unit testing is <em>Don&#8217;t test
constants</em>, and testing HTML as text is a lot like testing a constant.</p>
</div>
<div class="paragraph">
<p>In other words, if you have some code that says:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">wibble = 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s not much point in a test that says:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from myprogram import wibble
assert wibble == 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unit tests are really about testing logic, flow control, and configuration.
Making assertions about exactly what sequence of characters we have in our HTML
strings isn&#8217;t doing that.</p>
</div>
<div class="paragraph">
<p>What&#8217;s more, mangling raw strings in Python really isn&#8217;t a great way of dealing
with HTML.  There&#8217;s a much better solution, which is to use templates.  Quite
apart from anything else, if we can keep HTML to one side in a file whose name
ends in <em>.html</em>, we&#8217;ll get better syntax highlighting! There are lots of Python
templating frameworks out there, and Django has its own which works very well.
Let&#8217;s use that.</p>
</div>
<div class="sect3">
<h4 id="_refactoring_to_use_a_template">4.3.1. Refactoring to Use a Template</h4>
<div class="paragraph">
<p>What
we want to do now is make our view function return exactly the same HTML,
but just using a different process. That&#8217;s a refactor&#8212;&#8203;when we try to
improve the code <em>without changing its functionality</em>.</p>
</div>
<div class="paragraph">
<p>That last bit is really important. If you try to add new functionality at the
same time as refactoring, you&#8217;re much more likely to run into trouble.
Refactoring is actually a whole discipline in itself, and it even has a
reference book: Martin Fowler&#8217;s <a href="http://refactoring.com/"><em>Refactoring</em></a>.</p>
</div>
<div class="paragraph">
<p>The first rule is that you can&#8217;t refactor without tests.  Thankfully, we&#8217;re doing
TDD, so we&#8217;re way ahead of the game.  Let&#8217;s check that our tests pass; they will
be what makes sure that our refactoring is behaviour preserving:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great! We&#8217;ll start by taking our HTML string and putting it into its own file.
Create a directory called <em>lists/templates</em> to keep templates in, and then open
a file at <em>lists/templates/home.html</em>, to which we&#8217;ll transfer our
HTML:<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnote_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;html&gt;
    &lt;title&gt;To-Do lists&lt;/title&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Mmmh, syntax-highlighted&#8230;&#8203;much nicer! Now to change our view function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.shortcuts import render

def home_page(request):
    return render(request, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Instead of building our own <code>HttpResponse</code>, we now use the Django <code>render</code>
function.  It takes the request as its first parameter (for reasons we&#8217;ll go
into later) and the name of the template to render.  Django will automatically
search folders called <em>templates</em> inside any of your apps' directories.  Then
it builds an <code>HttpResponse</code> for you, based on the content of the template.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Templates are a very powerful feature of Django&#8217;s, and their main
    strength consists of substituting Python variables into HTML text. We&#8217;re
    not using this feature yet, but we will in future chapters.  That&#8217;s
    why we use <code>render</code> and (later) <code>render_to&#8203;_string</code> rather
    than, say, manually reading the file from disk with the built-in <code>open</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see if it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
======================================================================
ERROR: test_home_page_returns_correct_html (lists.tests.HomePageTest)<i class="conum" data-value="2"></i><b>(2)</b>
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests.py", line 17, in
test_home_page_returns_correct_html
    response = home_page(request)<i class="conum" data-value="3"></i><b>(3)</b>
  File "...python-tdd-book/lists/views.py", line 5, in home_page
    return render(request, 'home.html')<i class="conum" data-value="4"></i><b>(4)</b>
  File "/usr/local/lib/python3.6/dist-packages/django/shortcuts.py", line 48,
in render
    return HttpResponse(loader.render_to_string(*args, **kwargs),
  File "/usr/local/lib/python3.6/dist-packages/django/template/loader.py", line
170, in render_to_string
    t = get_template(template_name, dirs)
  File "/usr/local/lib/python3.6/dist-packages/django/template/loader.py", line
144, in get_template
    template, origin = find_template(template_name, dirs)
  File "/usr/local/lib/python3.6/dist-packages/django/template/loader.py", line
136, in find_template
    raise TemplateDoesNotExist(name)
django.template.base.TemplateDoesNotExist: home.html<i class="conum" data-value="1"></i><b>(1)</b>

 ---------------------------------------------------------------------
Ran 2 tests in 0.004s</pre>
</div>
</div>
<div class="paragraph">
<p>Another chance to analyse a traceback:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We start with the error: it can&#8217;t find the template.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we double-check what test is failing: sure enough, it&#8217;s our test
of the view HTML.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then we find the line in our tests that caused the failure: it&#8217;s when
we call the <code>home_page</code> function.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, we look for the part of our own application code that caused the
failure: it&#8217;s when we try to call <code>render</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So why can&#8217;t Django find the template?  It&#8217;s right where it&#8217;s supposed to be,
in the <em>lists/templates</em> folder.</p>
</div>
<div class="paragraph">
<p>The thing is that we haven&#8217;t yet <em>officially</em> registered our lists app with
Django. Unfortunately, just running the <code>startapp</code> command and
having what is obviously an app in your project folder isn&#8217;t quite enough.  You
have to tell Django that you <em>really</em> mean it, and add it to <em>settings.py</em> as
well. Belt and braces. Open it up and look for a variable called
<code>INSTALLED_APPS</code>, to which we&#8217;ll add <code>lists</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"># Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'lists',
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can see there&#8217;s lots of apps already in there by default.  We just need to
add ours, <code>lists</code>, to the bottom of the list.  Don&#8217;t forget the trailing
comma&#8212;&#8203;it may not be required, but one day you&#8217;ll be really annoyed when you
forget it and Python concatenates two strings on different lines&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Now we can try running the tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
    [...]
    self.assertTrue(html.endswith('&lt;/html&gt;'))
AssertionError: False is not true</pre>
</div>
</div>
<div class="paragraph">
<p>Darn, not quite.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Depending on whether your text editor insists on adding newlines to the
      end of files, you may not even see this error.  If so, you can safely
      ignore the next bit, and skip straight to where you can see the listing
      says OK.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But it did get further!  It seems it managed to find our template, but
the last of the three assertions is failing. Apparently there&#8217;s something wrong
at the end of the output. I had to do a little <code>print(repr(html))</code>
to debug this, but it turns out that the switch to templates has introduced an
additional newline (<code>\n</code>) at the end. We can get them to pass like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">self.assertTrue(html.strip().endswith('&lt;/html&gt;'))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a tiny bit of a cheat, but whitespace at the end of an HTML file really
shouldn&#8217;t matter to us. Let&#8217;s try running the tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Our refactor of the code is now complete, and the tests mean we&#8217;re happy that
behaviour is preserved. Now we can change the tests so that they&#8217;re no longer
testing constants; instead, they should just check that we&#8217;re rendering the
right template.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_django_test_client">4.3.2. The Django Test Client</h4>
<div class="paragraph">
<p>One
way we could test this is to manually render the template ourselves in the
test, and then compare that to what the view returns.  Django has a function
called <span class="keep-together"><code>render_to_string</code></span> which will let us do that:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.template.loader import render_to_string
[...]

    def test_home_page_returns_correct_html(self):
        request = HttpRequest()
        response = home_page(request)
        html = response.content.decode('utf8')
        expected_html = render_to_string('home.html')
        self.assertEqual(html, expected_html)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But that&#8217;s a bit of an unwieldy way of testing that we use the right template.
And all this faffing about with <code>.decode()</code> and <code>.strip()</code> is distracting.
Instead, Django gives us a tool called the
<a href="https://docs.djangoproject.com/en/1.11/topics/testing/tools/#the-test-client">Django
Test Client</a>, which has built-in ways of checking what templates are used.
Here&#8217;s how it looks:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_home_page_returns_correct_html(self):
        response = self.client.get('/')  <i class="conum" data-value="1"></i><b>(1)</b>

        html = response.content.decode('utf8')  <i class="conum" data-value="2"></i><b>(2)</b>
        self.assertTrue(html.startswith('&lt;html&gt;'))
        self.assertIn('&lt;title&gt;To-Do lists&lt;/title&gt;', html)
        self.assertTrue(html.strip().endswith('&lt;/html&gt;'))

        self.assertTemplateUsed(response, 'home.html')  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instead of manually creating an <code>HttpRequest</code> object and calling the view
function directly, we call <code>self.client.get</code>, passing it the URL we want
to test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;ll leave the old tests there for now, just to make sure everything is
working the way we think it is.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>.assertTemplateUsed</code> is the test method that the Django <code>TestCase</code> class
provides us.  It lets us check what template was used to render a response
(NB—it will only work for responses that were retrieved by the test
client).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And that test will still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 2 tests in 0.016s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Just because I&#8217;m always suspicious of a test I haven&#8217;t seen fail, let&#8217;s
deliberately break it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        self.assertTemplateUsed(response, 'wrong.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That way we&#8217;ll also learn what its error messages look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Template 'wrong.html' was not a template
used to render the response. Actual template(s) used: home.html</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s very helpful!  Let&#8217;s change the assert back to the right thing.  While
we&#8217;re at it, we can delete our old assertions.  And we can also delete the
old <code>test_root_&#x200b;url_resolves</code> test, because that&#8217;s tested implicitly by the
Django Test Client.  We&#8217;ve combined two long-winded tests into one!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch04l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase

class HomePageTest(TestCase):

    def test_uses_home_template(self):
        response = self.client.get('/')
        self.assertTemplateUsed(response, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The main point, though, is that instead of testing constants we&#8217;re testing our
implementation.
Great!<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnote_7" title="View footnote.">7</a>]</sup></p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Why Didn&#8217;t We Just Use the Django Test Client All Along?</div>
<div class="paragraph">
<p>You may be asking yourself, "Why didn&#8217;t we just use the Django Test Client from
the very beginning?"  In real life, that&#8217;s what I would do.  But I wanted to
show you the "manual" way of doing it first for a couple of reasons.  Firstly
because it allowed me to introduce concepts one by one, and keep the learning
curve as shallow as possible.  Secondly, because you may not always be using
Django to build your apps, and testing tools may not always be available&#8212;&#8203;but
calling functions directly and examining their responses is always possible!</p>
</div>
<div class="paragraph">
<p>The Django Test Client does also have disadvantages;
<a href="#chapter_purist_unit_tests">later in the book</a> we&#8217;ll discuss the difference
between fully isolated unit tests and the "integrated" tests that the test
client pushes us towards.  But for now, it&#8217;s very much the pragmatic choice.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_on_refactoring">4.4. On Refactoring</h3>
<div class="paragraph">
<p>That
was an absolutely trivial example of refactoring. But, as Kent Beck puts
it in <a href="#tddbe"><em>Test-Driven Development: By Example</em></a>, "Am I recommending that
you actually work this way? No. I&#8217;m recommending that you be <em>able</em> to work
this way".</p>
</div>
<div class="paragraph">
<p>In fact, as I was writing this my first instinct was to dive in and change the
test first&#8212;&#8203;make it use the <code>assertTemplateUsed</code> function straight away;
delete the three superfluous assertions, leaving just a check of the contents
against the expected render; and then go ahead and make the code change.  But
notice how that actually would have left space for me to break things: I could
have defined the template as containing <em>any</em> arbitrary string, instead of
the string with the right <code>&lt;html&gt;</code> and <code>&lt;title&gt;</code> tags.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When refactoring, work on either the code or the tests, but not both at
     once.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There&#8217;s always a tendency to skip ahead a couple of steps, to make a couple of
tweaks to the behaviour while you&#8217;re refactoring, but pretty soon you&#8217;ve got
changes to half a dozen different files, you&#8217;ve totally lost track of where you
are, and nothing works any more.  If you don&#8217;t want to end up like
<a href="http://bit.ly/1iXyRt4">Refactoring Cat</a> (<a href="#RefactoringCat">Refactoring Cat&#8212;&#8203;be sure to look up the full animated GIF (source: 4GIFs.com)</a>), stick to small
steps; keep refactoring and functionality changes entirely separate.</p>
</div>
<div id="RefactoringCat" class="imageblock">
<div class="content">
<img src="images/twp2_0402.png" alt="An adventurous cat, trying to refactor its way out of a slippery bathtub">
</div>
<div class="title">Figure 6. Refactoring Cat&#8212;&#8203;be sure to look up the full animated GIF (source: 4GIFs.com)</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;ll come across &#8220;Refactoring Cat&#8221; again during this book,
    as an example of what happens when we get carried away and want to change
    too many things at once. Think of it as the little cartoon demon
    counterpart to the Testing Goat, popping up over your other shoulder and
    giving you bad advice&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s a good idea to do a commit after any refactoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # see tests.py, views.py, settings.py, + new templates folder
$ <strong>git add .</strong>  # will also add the untracked templates folder
$ <strong>git diff --staged</strong> # review the changes we're about to commit
$ <strong>git commit -m "Refactor home page view to use a template"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_little_more_of_our_front_page">4.5. A Little More of Our Front Page</h3>
<div class="paragraph">
<p>In the meantime, our functional test is still failing.  Let&#8217;s now make an
actual code change to get it passing.  Because our HTML is now in a template,
we can feel free to make changes to it, without needing to write any extra unit
tests.  We wanted an <code>&lt;h1&gt;</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;To-Do lists&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Your To-Do list&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see if our functional test likes it a little better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_new_item"]</pre>
</div>
</div>
<div class="paragraph">
<p>OK&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    [...]
        &lt;h1&gt;Your To-Do list&lt;/h1&gt;
        &lt;input id="id_new_item" /&gt;
    &lt;/body&gt;
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '' != 'Enter a to-do item'</pre>
</div>
</div>
<div class="paragraph">
<p>We add our placeholder text&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;input id="id_new_item" placeholder="Enter a to-do item" /&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Which gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]</pre>
</div>
</div>
<div class="paragraph">
<p>So we can go ahead and put the table onto the page. At this stage it&#8217;ll just be
empty&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;input id="id_new_item" placeholder="Enter a to-do item" /&gt;
    &lt;table id="id_list_table"&gt;
    &lt;/table&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now what does the FT say?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "functional_tests.py", line 43, in
test_can_start_a_list_and_retrieve_it_later
    any(row.text == '1: Buy peacock feathers' for row in rows)
AssertionError: False is not true</pre>
</div>
</div>
<div class="paragraph">
<p>Slightly cryptic. We can use the line number to track it down, and it turns out
it&#8217;s that <code>any</code> function I was so smug about earlier&#8212;&#8203;or, more precisely, the
<code>assertTrue</code>, which doesn&#8217;t have a very explicit failure message.  We can pass
a custom error message as an argument to most <code>assertX</code> methods in <code>unittest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    self.assertTrue(
        any(row.text == '1: Buy peacock feathers' for row in rows),
        "New to-do item did not appear in table"
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you run the FT again, you should see our message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : New to-do item did not appear in table</pre>
</div>
</div>
<div class="paragraph">
<p>But now, to get this to pass, we will need to actually process the user&#8217;s
form submission.  And that&#8217;s a topic for the next chapter.</p>
</div>
<div class="paragraph">
<p>For now let&#8217;s do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -am "Front page HTML now generated from a template"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to a bit of refactoring, we&#8217;ve got our view set up to render a template,
we&#8217;ve stopped testing constants, and we&#8217;re now well placed to start processing
user input.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recap_the_tdd_process">4.6. Recap: The TDD Process</h3>
<div class="paragraph">
<p>We&#8217;ve
now seen all the main aspects of the TDD process, in practice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functional tests</p>
</li>
<li>
<p>Unit tests</p>
</li>
<li>
<p>The unit-test/code cycle</p>
</li>
<li>
<p>Refactoring</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s time for a little recap, and perhaps even some flowcharts.  Forgive me,
years misspent as a management consultant have ruined me. On the plus side,
it will feature recursion.</p>
</div>
<div class="paragraph">
<p>What is the overall TDD process? See <a href="#simple-TDD-diagram">Overall TDD process</a>.</p>
</div>
<div class="paragraph">
<p>We write a test. We run the test and see it fail.  We write some minimal code
to get it a little further.  We rerun the test and repeat until it passes.
Then, optionally, we might refactor our code, using our tests to make sure we
don&#8217;t break anything.</p>
</div>
<div id="simple-TDD-diagram" class="imageblock">
<div class="content">
<img src="images/twp2_0403.png" alt="A flowchart showing tests, coding and refactoring">
</div>
<div class="title">Figure 7. Overall TDD process</div>
</div>
<div class="paragraph">
<p>But how does this apply when we have functional tests <em>and</em> unit tests?  Well,
you can think of the functional test as being a high-level view of the cycle,
where "writing the code" to get the functional tests to pass actually involves
using another, smaller TDD cycle which uses unit tests. See
<a href="#Double-Loop-TDD-diagram">The TDD process with functional and unit tests</a>.</p>
</div>
<div class="paragraph">
<p>We write a functional test and see it fail.  Then, the process of "writing
code" to get it to pass is a mini-TDD cycle of its own:  we write one or more
unit tests, and go into the unit-test/code cycle until the unit tests pass.
Then, we go back to our FT to check that it gets a little further, and we
can write a bit more of our application&#8212;&#8203;using more unit tests, and so on.</p>
</div>
<div class="paragraph">
<p>What about refactoring, in the context of functional tests?  Well, that means
we use the functional test to check that we&#8217;ve preserved the behaviour of
our application, but we can change or add and remove unit tests, and use
a unit test cycle to actually change the implementation.</p>
</div>
<div class="paragraph">
<p>The functional tests are the ultimate judge of whether your application works
or not.  The unit tests are a tool to help you along the way.</p>
</div>
<div class="paragraph">
<p>This way of looking at things is sometimes called "Double-Loop TDD". One of my
eminent tech reviewers, Emily Bache, wrote <a href="http://bit.ly/1iXzoLR">a blog post</a>
on the topic, which I recommend for a different perspective.</p>
</div>
<div id="Double-Loop-TDD-diagram" class="imageblock">
<div class="content">
<img src="images/twp2_0404.png" alt="A flowchart showing functional tests as the overall cycle, and unit tests helping to code">
</div>
<div class="title">Figure 8. The TDD process with functional and unit tests</div>
</div>
<div class="paragraph">
<p>We&#8217;ll explore all of the different parts of this workflow in more detail
over the coming chapters.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How to "Check" Your Code, or Skip Ahead (If You Must)</div>
<div class="paragraph">
<p>All
of the code examples I&#8217;ve used in
the book are available in <a href="https://github.com/hjwp/book-example/">my repo</a> on
GitHub.  So, if you ever want to compare your code against mine, you can take a
look at it there.</p>
</div>
<div class="paragraph">
<p>Each chapter has its own branch which is named after its short name. The one
for this chapter is
<a href="https://github.com/hjwp/book-example/tree/chapter_philosophy_and_refactoring">here</a>,
for example.  It is a snapshot of the code as it should be at the <em>end</em> of the
chapter.</p>
</div>
<div class="paragraph">
<p>You can find a full list of them in <a href="#appendix_github_links">Source Code Examples</a>, as well as
instructions on how to download them or use Git to compare your code to
mine.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_post_and_database">5. Saving User Input: Testing the Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We
want to take the to-do item input from the user and send it to the server,
so that we can save it somehow and display it back to her later.</p>
</div>
<div class="paragraph">
<p>As I started writing this chapter, I immediately skipped to what I thought was
the right design: multiple models for lists and list items, a bunch of
different URLs for adding new lists and items, three new view functions, and about
half a dozen new unit tests for all of the above. But I stopped myself.
Although I was pretty sure I was smart enough to handle all those problems at
once, the point of TDD is to allow you to do one thing at a time, when you
need to.  So I decided to be deliberately short-sighted, and at any given
moment only do what was necessary to get the functional tests a little further.</p>
</div>
<div class="paragraph">
<p>It&#8217;s
a demonstration of how TDD can support an iterative style of
development&#8212;&#8203;it may not be the quickest route, but you do get there in the end.
There&#8217;s a neat side benefit, which is that it allows me to introduce new
concepts like models, dealing with POST requests, Django template tags, and so
on <em>one at a time</em> rather than having to dump them on you all at once.</p>
</div>
<div class="paragraph">
<p>None of this says that you <em>shouldn&#8217;t</em> try to think ahead, and be clever.  In
the next chapter we&#8217;ll use a bit more design and up-front thinking, and show
how that fits in with TDD. But for now let&#8217;s plough on mindlessly and just do
what the tests tell us to.</p>
</div>
<div class="sect2">
<h3 id="_wiring_up_our_form_to_send_a_post_request">5.1. Wiring Up Our Form to Send a POST Request</h3>
<div class="paragraph">
<p>At
the end of the last chapter, the tests were telling us we weren&#8217;t able to
save the user&#8217;s input. For now, we&#8217;ll use a standard HTML POST request.  A
little boring, but also nice and easy to deliver&#8212;&#8203;we can use all sorts of sexy
HTML5 and JavaScript later in the book.</p>
</div>
<div class="paragraph">
<p>To get our browser to send a POST request, we need to do two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Give the <code>&lt;input&gt;</code> element a <code>name=</code> attribute.</p>
</li>
<li>
<p>Wrap it in a <code>&lt;form&gt;</code> tag with <code>method="POST"</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s adjust our template at <em>lists/templates/home.html</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;h1&gt;Your To-Do list&lt;/h1&gt;
&lt;form method="POST"&gt;
    &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
&lt;/form&gt;

&lt;table id="id_list_table"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now, running our FTs gives us a slightly cryptic, unexpected error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
[...]
Traceback (most recent call last):
  File "functional_tests.py", line 40, in
test_can_start_a_list_and_retrieve_it_later
    table = self.browser.find_element_by_id('id_list_table')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]</pre>
</div>
</div>
<div class="paragraph">
<p>When
a functional test fails with an unexpected failure, there are several
things we can do to debug it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>print</code> statements, to show, for example, what the current page text is.</p>
</li>
<li>
<p>Improve the <em>error message</em> to show more info about the current state.</p>
</li>
<li>
<p>Manually visit the site yourself.</p>
</li>
<li>
<p>Use <code>time.sleep</code> to pause the test during execution.<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnote_8" title="View footnote.">8</a>]</sup></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll look at all of these over the course of this book, but the <code>time.sleep</code>
option is one I find myself using very often.  Let&#8217;s try it now.</p>
</div>
<div class="paragraph">
<p>Conveniently, we&#8217;ve already got a sleep just before the error occurs; let&#8217;s just extend
it a little:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # When she hits enter, the page updates, and now the page lists
    # "1: Buy peacock feathers" as an item in a to-do list table
    inputbox.send_keys(Keys.ENTER)
    time.sleep(10)

    table = self.browser.find_element_by_id('id_list_table')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Depending
on how fast Selenium runs on your PC, you may have caught a glimpse
of this already, but when we run the functional tests again, we&#8217;ve got time to
see what&#8217;s going on:  you should see a page that looks like
<a href="#csrf_error_screenshot">Django DEBUG page showing CSRF error</a>, with lots of Django debug information.</p>
</div>
<div id="csrf_error_screenshot" class="imageblock">
<div class="content">
<img src="images/twp2_0501.png" alt="Django DEBUG page showing CSRF error">
</div>
<div class="title">Figure 9. Django DEBUG page showing CSRF error</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Security: Surprisingly Fun!</div>
<div class="paragraph">
<p>If
you&#8217;ve never heard of a <em>Cross-Site Request Forgery</em> exploit, why not look
it up now? Like all security exploits, it&#8217;s entertaining to read about, being
an ingenious use of a system in unexpected ways&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>When I went back to university to get my Computer Science degree, I signed up
for the Security module out of a sense of duty:  <em>Oh well, it&#8217;ll probably be
very dry and boring, but I suppose I&#8217;d better take it</em>.  It turned out to be
one of the most fascinating modules of the whole course&#8212;&#8203;absolutely full of
the joy of hacking, of the particular mindset it takes to think about how
systems can be used in unintended ways.</p>
</div>
<div class="paragraph">
<p>I want to recommend the textbook for my course, Ross Anderson&#8217;s
<a href="#seceng"><em>Security Engineering</em></a>. It&#8217;s quite light on pure crypto, but it&#8217;s
absolutely full of interesting discussions of unexpected topics like
lock picking, forging bank notes, inkjet printer cartridge <span class="keep-together">economics</span>, and
spoofing South African Air Force jets with replay attacks.  It&#8217;s a huge tome,
about three inches thick, and I promise you it&#8217;s an absolute page-turner.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Django&#8217;s CSRF protection involves placing a little auto-generated token into
each generated form, to be able to identify POST requests as having come from
the original site.  So far our template has been pure HTML, and in this step we
make the first use of Django&#8217;s template magic. To
add the CSRF token we
use a <em>template tag</em>, which has the curly-bracket/percent syntax,
<code>{% ... %}</code>&mdash;famous for being the world&#8217;s most annoying two-key touch-typing
combination:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;form method="POST"&gt;
    &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
    {% csrf_token %}
&lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django will substitute that during rendering with an <code>&lt;input type="hidden"&gt;</code>
containing the CSRF token. Rerunning the functional test will now give us an
expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : New to-do item did not appear in table</pre>
</div>
</div>
<div class="paragraph">
<p>Since our long <code>time.sleep</code> is still there, the test will pause on the final
screen, showing us that the new item text disappears after the form is
submitted, and the page refreshes to show an empty form again.  That&#8217;s because
we haven&#8217;t wired up our server to deal with the POST request yet&#8212;&#8203;it just
ignores it and displays the normal home page.</p>
</div>
<div class="paragraph">
<p>We
can put our normal short <code>time.sleep</code> back now though:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # "1: Buy peacock feathers" as an item in a to-do list table
    inputbox.send_keys(Keys.ENTER)
    time.sleep(1)

    table = self.browser.find_element_by_id('id_list_table')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processing_a_post_request_on_the_server">5.2. Processing a POST Request on the Server</h3>
<div class="paragraph">
<p>Because
we haven&#8217;t specified an <code>action=</code> attribute in the form, it is
submitting back to the same URL it was rendered from by default (i.e., <code>/</code>),
which is dealt with by our <code>home_page</code> function. Let&#8217;s adapt the view to be
able to deal with a POST request.</p>
</div>
<div class="paragraph">
<p>That means a new unit test for the <code>home_page</code> view. Open up <em>lists/tests.py</em>,
and add a new method to <code>HomePageTest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch05l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_uses_home_template(self):
    response = self.client.get('/')
    self.assertTemplateUsed(response, 'home.html')


def test_can_save_a_POST_request(self):
    response = self.client.post('/', data={'item_text': 'A new list item'})
    self.assertIn('A new list item', response.content.decode())</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To do a POST, we call <code>self.client.post</code>, and as you can see it takes
a <code>data</code> argument which contains the form data we want to send.
Then we check that the text from our POST request ends up in the rendered HTML.
That gives us our expected fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
AssertionError: 'A new list item' not found in '&lt;html&gt;\n    &lt;head&gt;\n
&lt;title&gt;To-Do lists&lt;/title&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n        &lt;h1&gt;Your To-Do
list&lt;/h1&gt;\n        &lt;form method="POST"&gt;\n            &lt;input name="item_text"
[...]
&lt;/body&gt;\n&lt;/html&gt;\n'</pre>
</div>
</div>
<div class="paragraph">
<p>We can get the test to pass by adding an <code>if</code> and providing a different code
path for POST requests. In typical TDD style, we start with a deliberately
silly return value:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.http import HttpResponse
from django.shortcuts import render

def home_page(request):
    if request.method == 'POST':
        return HttpResponse(request.POST['item_text'])
    return render(request, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets our unit tests passing, but it&#8217;s not really what we want.  What we
really want to do is add the POST submission to the table in the home page
template.</p>
</div>
</div>
<div class="sect2">
<h3 id="_passing_python_variables_to_be_rendered_in_the_template">5.3. Passing Python Variables to Be Rendered in the Template</h3>
<div class="paragraph">
<p>We&#8217;ve
already had a hint of it, and now it&#8217;s time to start to get to know the real
power of the Django template syntax, which is to pass variables from our Python
view code into HTML templates.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by seeing how the template syntax lets us include a Python object
in our template. The notation is <code>{{ ... }}</code>, which displays the object as a
string:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;body&gt;
    &lt;h1&gt;Your To-Do list&lt;/h1&gt;
    &lt;form method="POST"&gt;
        &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
        {% csrf_token %}
    &lt;/form&gt;

    &lt;table id="id_list_table"&gt;
        &lt;tr&gt;&lt;td&gt;{{ new_item_text }}&lt;/td&gt;&lt;/tr&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/table&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s our template variable.  <code>new_item_text</code> will be the variable name
for the user input we display in the template, to help distinguish it from
<code>item_text</code>, which is the name of the form field which we use in the POST
request.  That just reminds us that transforming the one into the other
doesn&#8217;t happen automatically; it&#8217;s something we do ourselves in the view&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s adjust our unit test so that it checks whether we are still using the
template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_can_save_a_POST_request(self):
        response = self.client.post('/', data={'item_text': 'A new list item'})
        self.assertIn('A new list item', response.content.decode())
        self.assertTemplateUsed(response, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that will fail as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: No templates used to render the response</pre>
</div>
</div>
<div class="paragraph">
<p>Good, our deliberately silly return value is now no longer fooling our tests,
so we are allowed to rewrite our view, and tell it to pass the POST
parameter to the template.  The <code>render</code> function takes, as its third argument,
a dictionary which maps template variable names to their values, so we can
use it for the POST case as well as the normal case.  Let&#8217;s simplify our view
right down to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch05l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return render(request, 'home.html', {
        'new_item_text': request.POST['item_text'],
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Running the unit tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_uses_home_template (lists.tests.HomePageTest)
[...]
  File "...python-tdd-book/lists/views.py", line 5, in home_page
    'new_item_text': request.POST['item_text'],
[...]
django.utils.datastructures.MultiValueDictKeyError: "'item_text'"</pre>
</div>
</div>
<div class="sect3">
<h4 id="_an_unexpected_failure">5.3.1. An Unexpected Failure</h4>
<div class="paragraph">
<p>Oops,
an <em>unexpected failure</em>.</p>
</div>
<div class="paragraph">
<p>If you remember the rules for reading tracebacks, you&#8217;ll spot that it&#8217;s
actually a failure in a <em>different</em> test.  We got the actual test we
were working on to pass, but the unit tests have picked up an unexpected
consequence, a regression: we broke the code path where there is no POST
request.</p>
</div>
<div class="paragraph">
<p>This is the whole point of having tests.  Yes, we could have predicted
this would happen, but imagine if we&#8217;d been having a bad day or weren&#8217;t paying
attention: our tests have just saved us from accidentally breaking our
application, and, because we&#8217;re using TDD, we found out immediately.  We didn&#8217;t
have to wait for a QA team, or switch to a web browser and click through our
site manually, and we can get on with fixing it straight away.  Here&#8217;s how:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return render(request, 'home.html', {
        'new_item_text': request.POST.get('item_text', ''),
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We use <a href="http://docs.python.org/3/library/stdtypes.html#dict.get"><code>dict.get</code></a> to
supply a default value, for the case where we are doing a normal GET request,
so the POST dictionary is empty.</p>
</div>
<div class="paragraph">
<p>The unit tests should now pass.  Let&#8217;s see what the functional tests say:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : New to-do item did not appear in table</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If your functional tests show you a different error at this point,
    or at any point in this chapter, complaining about a
    <code>StaleElementReferenceException</code>, you may need to increase the
    <code>time.sleep</code> explicit wait&#8212;&#8203;try 2 or 3 seconds instead of 1;
    then read on to the next chapter for a more robust solution.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hmm, not a wonderfully helpful
error.  Let&#8217;s use another of our FT debugging techniques: improving the error
message.  This is probably the most constructive technique, because those
improved error messages stay around to help debug any future errors:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py (ch05l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">self.assertTrue(
    any(row.text == '1: Buy peacock feathers' for row in rows),
    f"New to-do item did not appear in table. Contents were:\n{table.text}"  <i class="conum" data-value="1"></i><b>(1)</b>
)</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If
you&#8217;ve not seen this syntax before, it&#8217;s the new Python "f-string"
syntax (probably the most exciting new feature from Python 3.6). You just
prepend a string with an f, and then you can use the curly-bracket syntax
to insert local variables.  There&#8217;s more info in the
<a href="https://docs.python.org/3/whatsnew/3.6.html#pep-498-formatted-string-literals">Python 3.6 release notes</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us a more helpful error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : New to-do item did not appear in table.
Contents were:
Buy peacock feathers</pre>
</div>
</div>
<div class="paragraph">
<p>You know what could be even better than that?  Making that assertion a bit less
clever.  As you may remember, I was very pleased with myself for using the
<code>any</code> function, but one of my Early Release readers (thanks, Jason!) suggested
a much simpler implementation.  We can replace all four lines of the
<code>assertTrue</code> with a single <code>assertIn</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py (ch05l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    self.assertIn('1: Buy peacock feathers', [row.text for row in rows])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Much better.  You should always be very worried whenever you think you&#8217;re being
clever, because what you&#8217;re probably being is <em>overcomplicated</em>. And we get
the error message for free:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertIn('1: Buy peacock feathers', [row.text for row in rows])
AssertionError: '1: Buy peacock feathers' not found in ['Buy peacock feathers']</pre>
</div>
</div>
<div class="paragraph">
<p>Consider me suitably chastened.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If, instead, your FT seems to be saying the table is empty ("not found in
    []"), check your <code>&lt;input&gt;</code> tag&#8212;&#8203;does it have the correct
    <code>name="item_text"</code> attribute?  And does it have <code>method="POST"</code>?  Without
    them, the user&#8217;s input won&#8217;t be in the right place in <code>request.POST</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The
point is that the FT wants us to enumerate list items with a "1:" at the
beginning of the first list item. The fastest way to get that to pass is with a
quick "cheating" change to the template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;tr&gt;&lt;td&gt;1: {{ new_item_text }}&lt;/td&gt;&lt;/tr&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Red/Green/Refactor and Triangulation</div>
<div class="paragraph">
<p>The
unit-test/code cycle is sometimes taught as <em>Red, Green, Refactor</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start by writing a unit test which fails (<em>Red</em>).</p>
</li>
<li>
<p>Write the simplest possible code to get it to pass (<em>Green</em>), <em>even if
that means <span class="keep-together">cheating</span></em>.</p>
</li>
<li>
<p><em>Refactor</em> to get to better code that makes more sense.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So what do we do during the Refactor stage?  What justifies moving from
an implementation where we "cheat" to one we&#8217;re happy with?</p>
</div>
<div class="paragraph">
<p>One
methodology is <em>eliminate duplication</em>: if your test uses a magic constant
(like the "1:" in front of our list item), and your application code also uses
it, that counts as duplication, so it justifies refactoring. Removing the magic
constant from the application code usually means you have to stop cheating.</p>
</div>
<div class="paragraph">
<p>I find that leaves things a little too vague, so I usually like to
use a second technique, which is called <em>triangulation</em>: if your
tests let you get away with writing "cheating" code that you&#8217;re not happy
with, like returning a magic constant, <em>write another test</em> that forces you to
write some better code.  That&#8217;s what we&#8217;re doing when we extend the FT to
check that we get a "2:" when inputting a <em>second</em> list item.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get to the <code>self.fail('Finish the test!')</code>.  If we extend our FT to
check for adding a second item to the table (copy and paste is our friend), we
begin to see that our first cut solution really isn&#8217;t going to, um, cut it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # There is still a text box inviting her to add another item. She
    # enters "Use peacock feathers to make a fly" (Edith is very
    # methodical)
    inputbox = self.browser.find_element_by_id('id_new_item')
    inputbox.send_keys('Use peacock feathers to make a fly')
    inputbox.send_keys(Keys.ENTER)
    time.sleep(1)

    # The page updates again, and now shows both items on her list
    table = self.browser.find_element_by_id('id_list_table')
    rows = table.find_elements_by_tag_name('tr')
    self.assertIn('1: Buy peacock feathers', [row.text for row in rows])
    self.assertIn(
        '2: Use peacock feathers to make a fly',
         [row.text for row in rows]
    )

    # Edith wonders whether the site will remember her list. Then she sees
    # that the site has generated a unique URL for her -- there is some
    # explanatory text to that effect.
    self.fail('Finish the test!')

    # She visits that URL - her to-do list is still there.</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Sure
enough, the functional tests return an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_three_strikes_and_refactor">5.4. Three Strikes and Refactor</h3>
<div class="paragraph">
<p>Before
we go further&#8212;&#8203;we&#8217;ve got a bad
<em>code smell</em><sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnote_9" title="View footnote.">9</a>]</sup>
in this FT. We have three
almost identical code blocks checking for new items in the list table. There&#8217;s
a principle called <em>Don&#8217;t Repeat Yourself</em> (DRY), which we like to apply by
following the mantra <em>three strikes and refactor</em>. You can copy and paste code
once, and it may be premature to try to remove the duplication it causes, but
once you get three occurrences, it&#8217;s time to remove duplication.</p>
</div>
<div class="paragraph">
<p>We start by committing what we have so far. Even though we know our site
has a major flaw&#8212;&#8203;it can only handle one list item&#8212;&#8203;it&#8217;s still further ahead
than it was. We may have to rewrite it all, and we may not, but the rule
is that before you do any refactoring, always do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
# should show changes to functional_tests.py, home.html,
# tests.py and views.py
$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Back to our functional test refactor: we could use an inline function, but that
upsets the flow of the test slightly. Let&#8217;s use a helper method&#8212;&#8203;remember,
only methods that begin with <code>test_</code> will get run as tests, so you can use
other methods for your own purposes:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def tearDown(self):
        self.browser.quit()


    def check_for_row_in_list_table(self, row_text):
        table = self.browser.find_element_by_id('id_list_table')
        rows = table.find_elements_by_tag_name('tr')
        self.assertIn(row_text, [row.text for row in rows])


    def test_can_start_a_list_and_retrieve_it_later(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I like to put helper methods near the top of the class, between the <code>tearDown</code>
and the first test. Let&#8217;s use it in the FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # When she hits enter, the page updates, and now the page lists
    # "1: Buy peacock feathers" as an item in a to-do list table
    inputbox.send_keys(Keys.ENTER)
    time.sleep(1)
    self.check_for_row_in_list_table('1: Buy peacock feathers')

    # There is still a text box inviting her to add another item. She
    # enters "Use peacock feathers to make a fly" (Edith is very
    # methodical)
    inputbox = self.browser.find_element_by_id('id_new_item')
    inputbox.send_keys('Use peacock feathers to make a fly')
    inputbox.send_keys(Keys.ENTER)
    time.sleep(1)

    # The page updates again, and now shows both items on her list
    self.check_for_row_in_list_table('1: Buy peacock feathers')
    self.check_for_row_in_list_table('2: Use peacock feathers to make a fly')

    # Edith wonders whether the site will remember her list. Then she sees
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We run the FT again to check that it still behaves in the same way&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</pre>
</div>
</div>
<div class="paragraph">
<p>Good. Now we can commit the FT refactor as its own small, atomic change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong> # check the changes to functional_tests.py
$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And back to work.  If we&#8217;re ever going to handle more than one list item,
we&#8217;re going to need some kind of persistence, and databases are a stalwart
solution in this area.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_django_orm_and_our_first_model">5.5. The Django ORM and Our First Model</h3>
<div class="paragraph">
<p>An
<em>Object-Relational Mapper</em> (ORM) is a layer of abstraction for data stored in
a database with tables, rows, and columns. It lets us work with databases using
familiar object-oriented metaphors which work well with code.  Classes map to
database tables, attributes map to columns, and an individual instance of the
class represents a row of data in the database.</p>
</div>
<div class="paragraph">
<p>Django comes with an excellent ORM, and writing a unit test that uses it is
actually an excellent way of learning it, since it exercises code by specifying
how we want it to work.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new class in <em>lists/tests.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.models import Item
[...]

class ItemModelTest(TestCase):

    def test_saving_and_retrieving_items(self):
        first_item = Item()
        first_item.text = 'The first (ever) list item'
        first_item.save()

        second_item = Item()
        second_item.text = 'Item the second'
        second_item.save()

        saved_items = Item.objects.all()
        self.assertEqual(saved_items.count(), 2)

        first_saved_item = saved_items[0]
        second_saved_item = saved_items[1]
        self.assertEqual(first_saved_item.text, 'The first (ever) list item')
        self.assertEqual(second_saved_item.text, 'Item the second')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can see that creating a new record in the database is a relatively simple
matter of creating an object, assigning some attributes, and calling a
<code>.save()</code> function.  Django also gives us an API for querying the database via
a class attribute, <code>.objects</code>, and we use the simplest possible query,
<code>.all()</code>, which retrieves all the records for that table.  The results are
returned as a list-like object called a <code>QuerySet</code>, from which we can extract
individual objects, and also call further functions, like <code>.count()</code>. We then
check the objects as saved to the database, to check whether the right
information was saved.</p>
</div>
<div class="paragraph">
<p>Django&#8217;s
ORM has many other helpful and intuitive features; this might be a
good time to skim through the
<a href="https://docs.djangoproject.com/en/1.11/intro/tutorial01/">Django
tutorial</a>, which has an excellent intro to them.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve written this unit test in a very verbose style, as a way of
    introducing the Django ORM. I wouldn&#8217;t recommend writing your model
    tests like this "in real life".  We&#8217;ll actually rewrite this test to
    be much more concise <a href="#rewrite-model-test">later on</a>, in
    <a href="#chapter_advanced_forms">More Advanced Forms</a>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Terminology 2: Unit Tests Versus Integrated Tests, and the Database</div>
<div class="paragraph">
<p>Purists
will tell you that a "real" unit test should never touch the database,
and that the test I&#8217;ve just written should be more properly called an
integrated test, because it doesn&#8217;t only test our code, but also relies on
an external system&#8212;&#8203;that is, a database.</p>
</div>
<div class="paragraph">
<p>It&#8217;s OK to ignore this distinction for now&#8212;&#8203;we have two types of test,
the high-level functional tests which test the application from the user&#8217;s
point of view, and these lower-level tests which test it from the programmer&#8217;s
point of view.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll come back to this and talk about unit tests and integrated tests in
<a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>, towards the end of the book.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try running the unit test. Here comes another unit-test/code cycle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ImportError: cannot import name 'Item'</pre>
</div>
</div>
<div class="paragraph">
<p>Very well, let&#8217;s give it something to import from <em>lists/models.py</em>.  We&#8217;re
feeling confident so we&#8217;ll skip the <code>Item = None</code> step, and go straight to
creating a class:</p>
</div>
<div id="first-django-model" class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.db import models

class Item(object):
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets our test as far as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    first_item.save()
AttributeError: 'Item' object has no attribute 'save'</pre>
</div>
</div>
<div class="paragraph">
<p>To give our <code>Item</code> class a <code>save</code> method, and to make it into a real Django
model, we make it inherit from the <code>Model</code> class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.db import models

class Item(models.Model):
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_our_first_database_migration">5.5.1. Our First Database Migration</h4>
<div class="paragraph">
<p>The
next thing that happens is a database error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: lists_item</pre>
</div>
</div>
<div class="paragraph">
<p>In Django, the ORM&#8217;s job is to model the database, but there&#8217;s a second
system that&#8217;s in charge of actually building the database called <em>migrations</em>.
Its job is to give you the ability to add and remove tables and columns,
based on changes you make to your <em>models.py</em> files.</p>
</div>
<div class="paragraph">
<p>One way to think of it is as a version control system for your database.
As we&#8217;ll see later, it comes in particularly useful when we need to
upgrade a database that&#8217;s deployed on a live server.</p>
</div>
<div class="paragraph">
<p>For now all we need to know is how to build our first database migration,
which we do using the <code>makemigrations</code>
command:<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnote_10" title="View footnote.">10</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0001_initial.py
    - Create model Item
$ <strong>ls lists/migrations</strong>
0001_initial.py  __init__.py  __pycache__</pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re curious, you can go and take a look in the migrations file,
and you&#8217;ll see it&#8217;s a representation of our additions to <em>models.py</em>.</p>
</div>
<div class="paragraph">
<p>In the meantime, we should find our tests get a little further.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_test_gets_surprisingly_far">5.5.2. The Test Gets Surprisingly Far</h4>
<div class="paragraph">
<p>The test actually gets surprisingly far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
    self.assertEqual(first_saved_item.text, 'The first (ever) list item')
AttributeError: 'Item' object has no attribute 'text'</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a full eight lines later than the last failure&#8212;&#8203;we&#8217;ve been all the way
through saving the two <code>Item</code>s, and we&#8217;ve checked that they&#8217;re saved in the database, but
Django just doesn&#8217;t seem to have remembered the <code>.text</code> attribute.</p>
</div>
<div class="paragraph">
<p>Incidentally, if you&#8217;re new to Python, you might have been surprised we were
allowed to assign the <code>.text</code> attribute at all.  In a language like Java,
you would probably get a compilation error.  Python is more relaxed.</p>
</div>
<div class="paragraph">
<p>Classes that inherit from <code>models.Model</code> map to tables in the database.  By
default they get an auto-generated <code>id</code> attribute, which will be a primary key
column in the database, but you have to define any other columns you want
explicitly; here&#8217;s how we set up a text field:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Item(models.Model):
    text = models.TextField()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django has many other field types, like <code>IntegerField</code>, <code>CharField</code>,
<code>DateField</code>, and so on.  I&#8217;ve chosen <code>TextField</code> rather than <code>CharField</code> because
the latter requires a length restriction, which seems arbitrary at this point.
You can read more on field types in the Django
<a href="https://docs.djangoproject.com/en/1.11/intro/tutorial01/#creating-models">tutorial</a>
and in the
<a href="https://docs.djangoproject.com/en/1.11/ref/models/fields/">documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_field_means_a_new_migration">5.5.3. A New Field Means a New Migration</h4>
<div class="paragraph">
<p>Running the tests gives us another database error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such column: lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we&#8217;ve added another new field to our database, which means we need
to create another migration.  Nice of our tests to let us know!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
You are trying to add a non-nullable field 'text' to item without a default; we
can't do that (the database needs something to populate existing rows).
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null
value for this column)
 2) Quit, and let me add a default in models.py
Select an option:<strong>2</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Ah.  It won&#8217;t let us add the column without a default value.  Let&#8217;s pick option
2 and set a default in <em>models.py</em>.  I think you&#8217;ll find the syntax reasonably
self-explanatory:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Item(models.Model):
    text = models.TextField(default='')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now the migration should complete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0002_item_text.py
    - Add field text to item</pre>
</div>
</div>
<div class="paragraph">
<p>So, two new lines in <em>models.py</em>, two database migrations, and as a result,
the <code>.text</code> attribute on our model objects is now
recognised as a special attribute, so it does get saved to the database, and
the tests pass&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]

Ran 3 tests in 0.010s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>So
let&#8217;s do a commit for our first ever model!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # see tests.py, models.py, and 2 untracked migrations
$ <strong>git diff</strong> # review changes to tests.py and models.py
$ <strong>git add lists</strong>
$ <strong>git commit -m "Model for list Items and associated migration"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_saving_the_post_to_the_database">5.6. Saving the POST to the Database</h3>
<div class="paragraph">
<p>Let&#8217;s
adjust the test for our home page POST request, and say we want the view
to save a new item to the database instead of just passing it through to its
response. We can do that by adding three new lines to the existing test called
<code>test_can_save_&#x200b;a_POST_request</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_can_save_a_POST_request(self):
    response = self.client.post('/', data={'item_text': 'A new list item'})

    self.assertEqual(Item.objects.count(), 1)  <i class="conum" data-value="1"></i><b>(1)</b>
    new_item = Item.objects.first()  <i class="conum" data-value="2"></i><b>(2)</b>
    self.assertEqual(new_item.text, 'A new list item')  <i class="conum" data-value="3"></i><b>(3)</b>

    self.assertIn('A new list item', response.content.decode())
    self.assertTemplateUsed(response, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We check that one new <code>Item</code> has been saved to the database.
<code>objects.count()</code> is a shorthand for <code>objects.all().count()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>objects.first()</code> is the same as doing <code>objects.all()[0]</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We check that the item&#8217;s text is correct.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This
test is getting a little long-winded.  It seems to be testing lots of
different things.  That&#8217;s another <em>code smell</em>&mdash;a long unit test either
needs to be broken into two, or it may be an indication that the thing you&#8217;re
testing is too complicated.  Let&#8217;s add that to a little to-do list of our own,
perhaps on a piece of scrap paper:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Code smell: POST test is too long?</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Writing it down on a scratchpad like this reassures us that we won&#8217;t forget, so
we are comfortable getting back to what we were working on.  We rerun the
tests and see an expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s adjust our view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.shortcuts import render
from lists.models import Item

def home_page(request):
    item = Item()
    item.text = request.POST.get('item_text', '')
    item.save()

    return render(request, 'home.html', {
        'new_item_text': request.POST.get('item_text', ''),
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve coded a very naive solution and you can probably spot a very obvious
problem, which is that we&#8217;re going to be saving empty items with every request
to the home page.  Let&#8217;s add that to our list of things to fix later.  You
know, along with the painfully obvious fact that we currently have no way at
all of having different lists for different people.  That we&#8217;ll keep ignoring
for now.</p>
</div>
<div class="paragraph">
<p>Remember, I&#8217;m not saying you should always ignore glaring problems like this in
"real life". Whenever we spot problems in advance, there&#8217;s a judgement call
to make over whether to stop what you&#8217;re doing and start again, or leave them
until later.  Sometimes finishing off what you&#8217;re doing is still worth it, and
sometimes the problem may be so major as to warrant a stop and rethink.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how the unit tests get on&#8230;&#8203;they pass!  Good.  We can do a bit of
refactoring:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    return render(request, 'home.html', {
        'new_item_text': item.text
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s have a little look at our scratchpad. I&#8217;ve added a couple of the other
things that are on our mind:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Don&#8217;t save blank items for every request</em></p>
</li>
<li>
<p><em>Code smell: POST test is too long?</em></p>
</li>
<li>
<p><em>Display multiple items in the table</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the first one.  We could tack on an assertion to an existing
test, but it&#8217;s best to keep unit tests to testing one thing at a time, so let&#8217;s
add a new one:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class HomePageTest(TestCase):
    [...]

    def test_only_saves_items_when_necessary(self):
        self.client.get('/')
        self.assertEqual(Item.objects.count(), 0)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us a <code>1 != 0</code> failure.  Let&#8217;s fix it.  Watch out; although it&#8217;s
quite a small change to the logic of the view, there are quite a few little
tweaks to the implementation in code:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    if request.method == 'POST':
        new_item_text = request.POST['item_text']  <i class="conum" data-value="1"></i><b>(1)</b>
        Item.objects.create(text=new_item_text)  <i class="conum" data-value="2"></i><b>(2)</b>
    else:
        new_item_text = ''  <i class="conum" data-value="1"></i><b>(1)</b>

    return render(request, 'home.html', {
        'new_item_text': new_item_text,  <i class="conum" data-value="1"></i><b>(1)</b>
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use a variable called <code>new_item_text</code>, which will either
hold the POST contents, or the empty string.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>.objects.create</code> is a neat shorthand for creating a new <code>Item</code>, without
needing to call <code>.save()</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And
that gets the test passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 0.010s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_redirect_after_a_post">5.7. Redirect After a POST</h3>
<div class="paragraph">
<p>But, yuck, that whole <code>new_item_text = ''</code> dance is making me pretty unhappy.
Thankfully we now have an opportunity to fix it.  A view function has two
jobs: processing user input, and returning an appropriate response.  We&#8217;ve
taken care of the first part, which is saving the users' input to the database,
so now let&#8217;s work on the second part.</p>
</div>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Post/Redirect/Get">Always redirect after a POST</a>,
they say, so let&#8217;s do that.  Once again we change our unit test for
saving a POST request to say that, instead of rendering a response with
the item in it, it should redirect back to the home page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_can_save_a_POST_request(self):
        response = self.client.post('/', data={'item_text': 'A new list item'})

        self.assertEqual(Item.objects.count(), 1)
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'A new list item')

        self.assertEqual(response.status_code, 302)
        self.assertEqual(response['location'], '/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We no longer expect a response with a <code>.content</code> rendered by a template, so we
lose the assertions that look at that.  Instead, the response will represent
an HTTP <em>redirect</em>, which should have status code 302, and points the browser
towards a new location.</p>
</div>
<div class="paragraph">
<p>That gives us the error <code>200 != 302</code>.  We can now tidy up our view
substantially:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch05l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.shortcuts import redirect, render
from lists.models import Item

def home_page(request):
    if request.method == 'POST':
        Item.objects.create(text=request.POST['item_text'])
        return redirect('/')

    return render(request, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the tests should now pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 0.010s

OK</pre>
</div>
</div>
<div class="sect3">
<h4 id="_better_unit_testing_practice_each_test_should_test_one_thing">5.7.1. Better Unit Testing Practice: Each Test Should Test One Thing</h4>
<div class="paragraph">
<p>Our
view now does a redirect after a POST, which is good practice,
and we&#8217;ve shortened the unit test somewhat, but we can still do better.</p>
</div>
<div class="paragraph">
<p>Good unit testing practice says that each test should only test one thing. The
reason is that it makes it easier to track down bugs.  Having multiple
assertions in a test means that, if the test fails on an early assertion, you
don&#8217;t know what the status of the later assertions is. As we&#8217;ll see in the next
chapter, if we ever break this view accidentally, we want to know whether it&#8217;s
the saving of objects that&#8217;s broken, or the type of response.</p>
</div>
<div class="paragraph">
<p>You may not always write perfect unit tests with single assertions on your
first go, but now feels like a good time to separate out our concerns:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_can_save_a_POST_request(self):
        self.client.post('/', data={'item_text': 'A new list item'})

        self.assertEqual(Item.objects.count(), 1)
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'A new list item')


    def test_redirects_after_POST(self):
        response = self.client.post('/', data={'item_text': 'A new list item'})
        self.assertEqual(response.status_code, 302)
        self.assertEqual(response['location'], '/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And
we should now see five tests pass instead of four:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 5 tests in 0.010s

OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rendering_items_in_the_template">5.8. Rendering Items in the Template</h3>
<div class="paragraph">
<p>Much
better!  Back to our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Don&#8217;t save blank items for every request</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Code smell: POST test is too long?</span></em></p>
</li>
<li>
<p><em>Display multiple items in the table</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Crossing things off the list is almost as satisfying as seeing tests pass!</p>
</div>
<div class="paragraph">
<p>The
third item is the last of the "easy" ones. Let&#8217;s have a new unit test
that checks that the template can also display multiple list items:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class HomePageTest(TestCase):
    [...]

    def test_displays_all_list_items(self):
        Item.objects.create(text='itemey 1')
        Item.objects.create(text='itemey 2')

        response = self.client.get('/')

        self.assertIn('itemey 1', response.content.decode())
        self.assertIn('itemey 2', response.content.decode())</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Are you wondering about the line spacing in the test? I&#8217;m grouping
      together two lines at the beginning which set up the test, one line in
      the middle which actually calls the code under test, and the
      assertions at the end. This isn&#8217;t obligatory, but it does help see the
      structure of the test. Setup, Exercise, Assert is the typical structure
      for a unit test.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That fails as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'itemey 1' not found in '&lt;html&gt;\n    &lt;head&gt;\n [...]</pre>
</div>
</div>
<div class="paragraph">
<p>The
Django template syntax has a tag for iterating through lists,
 <code>{% for .. in .. %}</code>; we can use it like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;table id="id_list_table"&gt;
    {% for item in items %}
        &lt;tr&gt;&lt;td&gt;1: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;
    {% endfor %}
&lt;/table&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is one of the major strengths of the templating system. Now the template
will render with multiple <code>&lt;tr&gt;</code> rows, one for each item in the variable
<code>items</code>.  Pretty neat!  I&#8217;ll introduce a few more bits of Django template
magic as we go, but at some point you&#8217;ll want to go and read up on the rest of
them in the
<a href="https://docs.djangoproject.com/en/1.11/topics/templates/">Django docs</a>.</p>
</div>
<div class="paragraph">
<p>Just changing the template doesn&#8217;t get our tests to green; we need to actually
pass the items to it from our home page view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    if request.method == 'POST':
        Item.objects.create(text=request.POST['item_text'])
        return redirect('/')

    items = Item.objects.all()
    return render(request, 'home.html', {'items': items})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That does get the unit tests to pass&#8230;&#8203;moment of truth, will the functional
test pass?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python functional_tests.py</strong>
[...]
AssertionError: 'To-Do' not found in 'OperationalError at /'</pre>
</div>
</div>
<div class="paragraph">
<p>Oops, apparently not.  Let&#8217;s use another functional test debugging technique,
and it&#8217;s one of the most straightforward: manually visiting the site!  Open
up <em>http://localhost:8000</em> in your web browser, and you&#8217;ll see a Django debug
page saying "no such table: lists_item", as in <a href="#operationalerror">Another helpful debug message</a>.</p>
</div>
<div id="operationalerror" class="imageblock width-75">
<div class="content">
<img src="images/twp2_0502.png" alt="OperationalError at / no such table: lists_item">
</div>
<div class="title">Figure 10. Another helpful debug message</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_creating_our_production_database_with_migrate">5.9. Creating Our Production Database with migrate</h3>
<div class="paragraph">
<p>Another
helpful error message from Django, which is basically complaining that
we haven&#8217;t set up the database properly.  How come everything worked fine
in the unit tests, I hear you ask?  Because Django creates a special <em>test
database</em> for unit tests; it&#8217;s one of the magical things that Django&#8217;s
<code>TestCase</code> does.</p>
</div>
<div class="paragraph">
<p>To set up our "real" database, we need to create it.  SQLite databases
are just a file on disk, and you&#8217;ll see in <em>settings.py</em> that Django,
by default, will just put it in a file called <em>db.sqlite3</em> in the base
project directory:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
# Database
# https://docs.djangoproject.com/en/1.11/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve told Django everything it needs to create the database, first via
<em>models.py</em> and then when we created the migrations file.  To actually apply
it to creating a real database, we use another Django Swiss Army knife
<em>manage.py</em> command, <code>migrate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py migrate</strong>
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, lists, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying lists.0001_initial... OK
  Applying lists.0002_item_text... OK
  Applying sessions.0001_initial... OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can refresh the page on <em>localhost</em>, see that our error is gone, and try
running the functional tests
again:<sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnote_11" title="View footnote.">11</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers', '1: Use peacock feathers to make a fly']</pre>
</div>
</div>
<div class="paragraph">
<p>So close!  We just need to get our list numbering right.  Another awesome
Django template tag, <code>forloop.counter</code>, will help here:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    {% for item in items %}
        &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;
    {% endfor %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you try it again, you should now see the FT get to the end:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.fail('Finish the test!')
AssertionError: Finish the test!</pre>
</div>
</div>
<div class="paragraph">
<p>But, as it&#8217;s running, you may notice something is amiss, like in
<a href="#items_left_over_from_previous_run">There are list items left over from the last run of the test</a>.</p>
</div>
<div id="items_left_over_from_previous_run" class="imageblock">
<div class="content">
<img src="images/twp2_0503.png" alt="There are list items left over from the last run of the test">
</div>
<div class="title">Figure 11. There are list items left over from the last run of the test</div>
</div>
<div class="paragraph">
<p>Oh dear. It looks like previous runs of the test are leaving stuff lying around
in our database.  In fact, if you run the tests again, you&#8217;ll see it gets
worse:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1: Buy peacock feathers
2: Use peacock feathers to make a fly
3: Buy peacock feathers
4: Use peacock feathers to make a fly
5: Buy peacock feathers
6: Use peacock feathers to make a fly</pre>
</div>
</div>
<div class="paragraph">
<p>Grrr.  We&#8217;re so close! We&#8217;re going to need some kind of automated way of
tidying up after ourselves. For now, if you feel like it, you can do it
manually, by deleting the database and re-creating it fresh with <code>migrate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm db.sqlite3</strong>
$ <strong>python manage.py migrate --noinput</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then reassure yourself that the FT still passes.</p>
</div>
<div class="paragraph">
<p>Apart from that little bug in our functional testing, we&#8217;ve got some code
that&#8217;s more or less working.  Let&#8217;s do a commit.</p>
</div>
<div class="paragraph">
<p>Start by doing a <strong><code>git status</code></strong> and a <strong><code>git diff</code></strong>, and you should see changes
to <em>home.html</em>, <em>tests.py</em>, and <em>views.py</em>. Let&#8217;s add them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add lists</strong>
$ <strong>git commit -m "Redirect after POST, and show all items in template"</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You might find it useful to add markers for the end of each chapter, like
    <strong><code>git tag end-of-chapter-05</code></strong>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_recap">5.10. Recap</h3>
<div class="paragraph">
<p>Where are we?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We&#8217;ve got a form set up to add new items to the list using POST.</p>
</li>
<li>
<p>We&#8217;ve set up a simple model in the database to save list items.</p>
</li>
<li>
<p>We&#8217;ve learned about creating database migrations, both for the
test database (where they&#8217;re applied automatically) and for the real
database (where we have to apply them manually).</p>
</li>
<li>
<p>We&#8217;ve used our first couple of Django template tags:  <code>{% csrf_token %}</code>
and the <code>{% for ... endfor %}</code> loop.</p>
</li>
<li>
<p>And we&#8217;ve used at least three different FT debugging techniques: in-line
print statements, <code>time.sleep</code>s, and improving the error messages.</p>
</li>
</ul>
</div>
<div class="paragraph pagebreak-before">
<p>But we&#8217;ve got a couple of items on our own to-do list, namely getting the FT to
clean up after itself, and perhaps more critically, adding support for more
than one list.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Don&#8217;t save blank items for every request</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Code smell: POST test is too long?</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Display multiple items in the table</span></em></p>
</li>
<li>
<p><em>Clean up after FT runs</em></p>
</li>
<li>
<p><em>Support more than one list!</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>I mean, we <em>could</em> ship the site as it is, but people might find it
strange that the entire human population has to share a single to-do list.  I
suppose it might get people to stop and think about how connected we all are to
one another, how we all share a common destiny here on Spaceship Earth, and how
we must all work together to solve the global problems that we face.</p>
</div>
<div class="paragraph">
<p>But in practical terms, the site wouldn&#8217;t be very useful.</p>
</div>
<div class="paragraph">
<p>Ah well.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Useful TDD Concepts</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Regression</dt>
<dd>
<p>    When
new code breaks some aspect of the application which used to work.</p>
</dd>
<dt class="hdlist1">Unexpected failure</dt>
<dd>
<p>    When
a test fails in a way we weren&#8217;t expecting.  This either means that
    we&#8217;ve made a mistake in our tests, or that the tests have helped us find
    a regression, and we need to fix something in our code.</p>
</dd>
<dt class="hdlist1">Red/Green/Refactor</dt>
<dd>
<p>    Another
way of describing the TDD process. Write a test and see it fail
    (Red), write some code to get it to pass (Green), then Refactor to improve
    the <span class="keep-together">implementation</span>.</p>
</dd>
<dt class="hdlist1">Triangulation</dt>
<dd>
<p>    Adding
a test case with a new specific example for some existing code, to
    justify generalising the implementation (which may be a "cheat" until that
    point).</p>
</dd>
<dt class="hdlist1">Three strikes and refactor</dt>
<dd>
<p>    A
rule of thumb for when to remove duplication from code. When two pieces
    of code look very similar, it often pays to wait until you see a third
    use case, so that you&#8217;re more sure about what part of the code really
    is the common, re-usable part to refactor out.</p>
</dd>
<dt class="hdlist1">The scratchpad to-do list</dt>
<dd>
<p>    A
place to write down things that occur to us as we&#8217;re coding, so that
    we can finish up what we&#8217;re doing and come back to them later.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_explicit_waits_1">6. Improving Functional Tests: Ensuring Isolation and Removing Voodoo Sleeps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we dive in and fix our real problem, let&#8217;s take care of a couple
of housekeeping items. At the end of the last chapter, we made a note
that different test runs were interfering with each other, so we&#8217;ll fix
that.  I&#8217;m also not happy with all these <code>time.sleep</code>s peppered through
the code; they seem a bit unscientific, so we&#8217;ll replace them with something
more reliable.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Clean up after FT runs</em></p>
</li>
<li>
<p><em>Remove time.sleeps</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Both of these changes will be moving towards testing "best practices",
making our tests more deterministic and more reliable.</p>
</div>
<div class="sect2">
<h3 id="_ensuring_test_isolation_in_functional_tests">6.1. Ensuring Test Isolation in Functional Tests</h3>
<div class="paragraph">
<p>We
ended the last chapter with a classic testing problem:  how to ensure
<em>isolation</em> between tests.  Each run of our functional tests was leaving list
items lying around in the database, and that would interfere with the test
results when you next ran the tests.</p>
</div>
<div class="paragraph">
<p>When
we run <em>unit</em> tests, the Django test runner automatically creates a brand
new test database (separate from the real one), which it can safely reset
before each individual test is run, and then throw away at the end.  But our
functional tests currently run against the "real" database, <em>db.sqlite3</em>.</p>
</div>
<div class="paragraph">
<p>One way to tackle this would be to "roll our own" solution, and add some code
to <em>functional_tests.py</em> which would do the cleaning up. The <code>setUp</code> and
<code>tearDown</code> methods are perfect for this sort of thing.</p>
</div>
<div class="paragraph">
<p>Since
Django 1.4 though, there&#8217;s a new class called <code>LiveServerTestCase</code> which
can do this work for you. It will automatically create a test database (just
like in a unit test run), and start up a development server for the functional
tests to run against. Although as a tool it has some limitations which we&#8217;ll
need to work around later, it&#8217;s dead useful at this stage, so let&#8217;s check it
out.</p>
</div>
<div class="paragraph">
<p><code>LiveServerTestCase</code> expects to be run by the Django test runner using
<em>manage.py</em>. As of Django 1.6, the test runner will find any files whose name
begins with <em>test</em>.  To keep things neat and tidy, let&#8217;s make a folder for
our functional tests, so that it looks a bit like an app. All Django needs is
for it to be a valid Python package directory (i.e., one with a
<i>___init___.py</i> in it):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir functional_tests</strong>
$ <strong>touch functional_tests/__init__.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then
we <em>move</em> our functional tests, from being a standalone file called
<em>functional_tests.py</em>, to being the <em>tests.py</em> of the <code>functional_tests</code> app.
We use <strong><code>git mv</code></strong> so that Git notices that we&#8217;ve moved the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git mv functional_tests.py functional_tests/tests.py</strong>
$ <strong>git status</strong> # shows the rename to functional_tests/tests.py and __init__.py</pre>
</div>
</div>
<div class="paragraph">
<p>At this point your directory tree should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
├── db.sqlite3
├── functional_tests
│   ├── __init__.py
│   └── tests.py
├── lists
│   ├── admin.py
│   ├── apps.py
│   ├── __init__.py
│   ├── migrations
│   │   ├── 0001_initial.py
│   │   ├── 0002_item_text.py
│   │   ├── __init__.py
│   │   └── __pycache__
│   ├── models.py
│   ├── __pycache__
│   ├── templates
│   │   └── home.html
│   ├── tests.py
│   └── views.py
├── manage.py
├── superlists
│   ├── __init__.py
│   ├── __pycache__
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
└── virtualenv
    ├── [...]</pre>
</div>
</div>
<div class="paragraph">
<p><em>functional_tests.py</em> is gone, and has turned into <em>functional_tests/tests.py</em>.
Now, whenever we want to run our functional tests, instead of running <code>python
functional_tests.py</code>, we will use <code>python manage.py test functional_tests</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You could mix your functional tests into the tests for the <code>lists</code> app.
    I tend to prefer to keep them separate, because functional tests usually
    have cross-cutting concerns that run across different apps.  FTs are meant
    to see things from the point of view of your users, and your users don&#8217;t
    care about how you&#8217;ve split work between different apps!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s edit <em>functional_tests/tests.py</em> and change our <code>NewVisitorTest</code>
class to make it use <code>LiveServerTestCase</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import LiveServerTestCase
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
import time


class NewVisitorTest(LiveServerTestCase):

    def setUp(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, instead of hardcoding the visit to localhost port 8000,
<code>LiveServerTestCase</code> gives us an attribute called <code>live_server_url</code>:</p>
</div>
<div class="exampleblock dofirst-ch06l003 sourcecode">
<div class="title">functional_tests/tests.py (ch06l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_can_start_a_list_and_retrieve_it_later(self):
        # Edith has heard about a cool new online to-do app. She goes
        # to check out its homepage
        self.browser.get(self.live_server_url)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can also remove the <code>if __name__ == '__main__'</code> from the end if we want,
since we&#8217;ll be using the Django test runner to launch the FT.</p>
</div>
<div class="paragraph">
<p>Now we are able to run our functional tests using the Django test runner, by
telling it to run just the tests for our new <code>functional_tests</code> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
Creating test database for alias 'default'...
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 65, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 6.578s

FAILED (failures=1)
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>The FT gets through to the <code>self.fail</code>, just like it did before the refactor.
You&#8217;ll also notice that if you run the tests a second time, there aren&#8217;t any
old list items lying around from the previous test&#8212;&#8203;it has cleaned up after
itself.  Success! We should commit it as an atomic change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # functional_tests.py renamed + modified, new __init__.py
$ <strong>git add functional_tests</strong>
$ <strong>git diff --staged -M</strong>
$ <strong>git commit</strong>  # msg eg "make functional_tests an app, use LiveServerTestCase"</pre>
</div>
</div>
<div class="paragraph">
<p>The
<code>-M</code> flag on the <code>git diff</code> is a useful one. It means "detect moves", so it
will notice that <em>functional_tests.py</em> and <em>functional_tests/tests.py</em> are the
same file, and show you a more sensible diff (try it without the flag!).</p>
</div>
<div class="sect3">
<h4 id="_running_just_the_unit_tests">6.1.1. Running Just the Unit Tests</h4>
<div class="paragraph">
<p>Now
if we run <code>manage.py test</code>, Django will run both the functional and the
unit tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
......F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
[...]
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 7 tests in 6.732s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>In
order to run just the unit tests, we can specify that we want to
only run the tests for the <code>lists</code> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
Creating test database for alias 'default'...
......
 ---------------------------------------------------------------------
Ran 6 tests in 0.009s

OK
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Useful Commands Updated</div>
<div class="dlist">
<dl>
<dt class="hdlist1">To run the functional tests</dt>
<dd>
<p><strong><code>python manage.py test functional_tests</code></strong></p>
</dd>
<dt class="hdlist1">To run the unit tests</dt>
<dd>
<p><strong><code>python manage.py test lists</code></strong></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>What to do if I say "run the tests", and you&#8217;re not sure which ones I mean?
Have another look at the flowchart at the end of <a href="#chapter_philosophy_and_refactoring">What Are We Doing with All These Tests? (And, Refactoring)</a>, and try to
figure out where we are.  As a rule of thumb, we usually only run the
functional tests once all the unit tests are passing, so if in doubt, try both!</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_aside_upgrading_selenium_and_geckodriver">6.2. Aside: Upgrading Selenium and Geckodriver</h3>
<div class="paragraph">
<p>As
I was running through this chapter again today, I found the FTs hung when I
tried to run them.</p>
</div>
<div class="paragraph">
<p>It turns out that Firefox had auto-updated itself overnight, and my versions
of Selenium and Geckodriver needed upgrading too.  A quick visit to the
<a href="https://github.com/mozilla/geckodriver/releases">geckodriver releases page</a>
confirmed there was a new version out.  So a few downloads and upgrades were
in order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A quick <code>pip install --upgrade selenium</code> first.</p>
</li>
<li>
<p>Then a quick download of the new geckodriver.</p>
</li>
<li>
<p>I saved a backup copy of the old one somewhere, and put the new one in its
place somewhere on the <code>PATH</code>.</p>
</li>
<li>
<p>And a quick check with <code>geckodriver --version</code> confirms the new one was
ready to go.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The FTs were then back to running the way I expected them to.</p>
</div>
<div class="paragraph">
<p>There was no particular reason that it happened at this point in the book;
indeed, it&#8217;s quite unlikely that it&#8217;ll happen right now for you, but it may
happen at some point, and this seemed as good a place as any to talk about
it, since we&#8217;re doing some <span class="keep-together">housekeeping</span>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s one of the things you have to put up with when using Selenium. Although
it is possible to pin your browser and Selenium versions (on a CI server, for
example), browser versions don&#8217;t stand still out in the real world, and you
need to keep up with what your users have.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If something strange is going on with your FTs, it&#8217;s always worth
    trying to upgrade Selenium.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Back to our regular programming now.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_implicit_and_explicit_waits_and_voodoo_time_sleeps">6.3. On Implicit and Explicit Waits, and Voodoo time.sleeps</h3>
<div class="paragraph">
<p>Let&#8217;s
talk about the <code>time.sleep</code> in our FT:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        # When she hits enter, the page updates, and now the page lists
        # "1: Buy peacock feathers" as an item in a to-do list table
        inputbox.send_keys(Keys.ENTER)
        time.sleep(1)

        self.check_for_row_in_list_table('1: Buy peacock feathers')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is what&#8217;s called an "explicit wait".  That&#8217;s by contrast with
"implicit waits":  in certain cases, Selenium tries to wait "automatically" for
you when it thinks the page is loading.  It even provides a method called
<code>implicitly_wait</code> that lets you control how long it will wait if you ask it for
an element that doesn&#8217;t seem to be on the page yet.</p>
</div>
<div class="paragraph">
<p>In fact, in the first edition, I was able to rely entirely on implicit waits.
The problem is that implicit waits are always a little flakey, and with the
release of Selenium 3, implicit waits became even more unreliable. At the same
time, the general opinion from the Selenium team was that implicit waits were
just a bad idea, and to be <span class="keep-together">avoided</span>.</p>
</div>
<div class="paragraph">
<p>So this edition has explicit waits from the very beginning. But the problem
is that those <code>time.sleep</code>s have their own issues.  Currently we&#8217;re waiting
for one second, but who&#8217;s to say that&#8217;s the right amount of time?  For most
tests we run against our own machine, one second is way too long, and it&#8217;s
going to really slow down our FT runs. 0.1s would be fine.  But the problem is
that if you set it that low, every so often you&#8217;re going to get a spurious
failure because, for whatever reason, the laptop was being a bit slow just
then.  And even at 1s you can never be quite sure you&#8217;re not going to get
random failures that don&#8217;t indicate a real problem, and false positives
in tests are a real annoyance (there&#8217;s lots more on this in
<a href="https://martinfowler.com/articles/nonDeterminism.html">an article by Martin Fowler</a>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unexpected
<code>NoSuchElementException</code> and <code>StaleElementException</code> errors
    are the usual symptoms of forgetting an explicit wait.  Try removing the
    <code>time.sleep</code> and see if you get one.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So let&#8217;s replace our sleeps with a tool that will wait for just as long as is
needed, up to a nice long timeout to catch any glitches.  We&#8217;ll rename
<code>check_for_row_in_list_table</code> to <code>wait_for_row_in_list_table</code>, and add some
polling/retry logic to it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium.common.exceptions import WebDriverException

MAX_WAIT = 10  <i class="conum" data-value="1"></i><b>(1)</b>
[...]

    def wait_for_row_in_list_table(self, row_text):
        start_time = time.time()
        while True:  <i class="conum" data-value="2"></i><b>(2)</b>
            try:
                table = self.browser.find_element_by_id('id_list_table')  <i class="conum" data-value="3"></i><b>(3)</b>
                rows = table.find_elements_by_tag_name('tr')
                self.assertIn(row_text, [row.text for row in rows])
                return  <i class="conum" data-value="4"></i><b>(4)</b>
            except (AssertionError, WebDriverException) as e:  <i class="conum" data-value="5"></i><b>(5)</b>
                if time.time() - start_time &gt; MAX_WAIT:  <i class="conum" data-value="6"></i><b>(6)</b>
                    raise e  <i class="conum" data-value="6"></i><b>(6)</b>
                time.sleep(0.5)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;ll use a constant called <code>MAX_WAIT</code> to set the maximum
amount of time we&#8217;re prepared to wait.  10 seconds should be more than
enough to catch any glitches or random slowness.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s the loop, which will keep going forever, unless we get to
one of two possible exit routes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here are our three lines of assertions from the old version of the
method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If we get through them and our assertion passes, we return from the
function and escape the loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>But if we catch an exception, we wait a short amount of time and loop
around to retry.  There are two types of exceptions we want to catch:
<code>WebDriverException</code> for when the page hasn&#8217;t loaded and Selenium can&#8217;t
find the table element on the page, and <code>AssertionError</code> for when the
table is there, but it&#8217;s perhaps a table from before the page reloads,
so it doesn&#8217;t have our row in yet.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Here&#8217;s our second escape route. If we get to this point, that means our
code kept raising exceptions every time we tried it until we exceeded our
timeout.  So this time, we re-raise the exception and let it bubble up to
our test, and most likely end up in our traceback, telling us why the test
failed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Are you thinking this code is a little ugly, and makes it a bit harder to see
exactly what we&#8217;re doing?  I agree. <a href="#self.wait-for">Later on</a>, we&#8217;ll refactor
out a general <code>wait_for</code> helper, to separate the timing and re-raising logic
from the test assertions.  But we&#8217;ll wait until we need it in multiple places.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve used Selenium before, you may know that it has a few
    <a href="http://www.seleniumhq.org/docs/04_webdriver_advanced.jsp">helper functions to do waits</a>.
    I&#8217;m not a big fan of them. Over the course of the book we&#8217;ll build a couple
    of wait helper tools which I think will make for nice, readable code, but
    of course you should check out the homegrown Selenium waits in your own
    time, and see what you think of them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can rename our method calls, and remove the voodoo <code>time.sleep</code>s:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    [...]
    # When she hits enter, the page updates, and now the page lists
    # "1: Buy peacock feathers" as an item in a to-do list table
    inputbox.send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Buy peacock feathers')

    # There is still a text box inviting her to add another item. She
    # enters "Use peacock feathers to make a fly" (Edith is very
    # methodical)
    inputbox = self.browser.find_element_by_id('id_new_item')
    inputbox.send_keys('Use peacock feathers to make a fly')
    inputbox.send_keys(Keys.ENTER)

    # The page updates again, and now shows both items on her list
    self.wait_for_row_in_list_table('2: Use peacock feathers to make a fly')
    self.wait_for_row_in_list_table('1: Buy peacock feathers')
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And rerun the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
Creating test database for alias 'default'...
......F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 73, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 7 tests in 4.552s

FAILED (failures=1)
System check identified no issues (0 silenced).
Destroying test database for alias 'default'...</pre>
</div>
</div>
<div class="paragraph">
<p>We get to the same place, and notice we&#8217;ve shaved a couple of seconds off the
execution time too.  That might not seem like a lot right now, but it all adds
up.</p>
</div>
<div class="paragraph">
<p>Just to check we&#8217;ve done the right thing, let&#8217;s deliberately break the test
in a couple of ways and see some errors.  First let&#8217;s check that if we
look for some row text that will never appear, we get the right error:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        rows = table.find_elements_by_tag_name('tr')
        self.assertIn('foo', [row.text for row in rows])
        return</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We see we still get a nice self-explanatory test failure message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertIn('foo', [row.text for row in rows])
AssertionError: 'foo' not found in ['1: Buy peacock feathers']</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s put that back the way it was and break something else:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    try:
        table = self.browser.find_element_by_id('id_nothing')
        rows = table.find_elements_by_tag_name('tr')
        self.assertIn(row_text, [row.text for row in rows])
        return
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Sure enough, we get the errors for when the page doesn&#8217;t contain the element
we&#8217;re looking for too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_nothing"]</pre>
</div>
</div>
<div class="paragraph">
<p>Everything seems to be in order.  Let&#8217;s put our code back to way it should be,
and do one final test run:</p>
</div>
<div class="listingblock dofirst-ch06l008">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
AssertionError: Finish the test!</pre>
</div>
</div>
<div class="paragraph">
<p>Great. With that little interlude over, let&#8217;s crack on with getting our
application actually working for multiple lists.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Testing "Best Practices" Applied in this Chapter</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Ensuring test isolation and managing global state</dt>
<dd>
<p>Different
tests shouldn&#8217;t affect one another.  This means we need to
reset any permanent state at the end of each test. Django&#8217;s test runner
helps us do this by creating a test database, which it wipes clean in
between each test.  (See also <a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>.)</p>
</dd>
<dt class="hdlist1">Avoid "voodoo" sleeps</dt>
<dd>
<p>Whenever we need to wait for something to load, it&#8217;s always tempting to
throw in a quick-and-dirty <code>time.sleep</code>.  But the problem is that the
length of time we wait is always a bit of a shot in the dark, either too
short and vulnerable to spurious failures, or too long and it&#8217;ll slow down
our test runs.  Prefer a retry loop that polls our app and moves on as soon
as possible.</p>
</dd>
<dt class="hdlist1">Don&#8217;t rely on Selenium&#8217;s implicit waits</dt>
<dd>
<p>Selenium does theoretically do some "implicit" waits, but the
implementation varies between browsers, and at the time of writing was
highly unreliable in the Selenium 3 Firefox driver.  "Explicit is better
than implict", as the Zen of Python says, so prefer explicit waits.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_working_incrementally">7. Working Incrementally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now
let&#8217;s address our real problem, which is that our design only allows for
one global list.  In this chapter I&#8217;ll demonstrate a critical TDD technique:
how to adapt existing code using an incremental, step-by-step process which
takes you from working state to working state. Testing Goat, not Refactoring
Cat.</p>
</div>
<div class="sect2">
<h3 id="_small_design_when_necessary">7.1. Small Design When Necessary</h3>
<div class="paragraph">
<p>Let&#8217;s
have a think about how we want support for multiple lists to
work.  Currently the FT (which is the closest we have to a design document)
says this:</p>
</div>
<div class="exampleblock sourcecode currentcontents dofirst-ch07l000">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # Edith wonders whether the site will remember her list. Then she sees
    # that the site has generated a unique URL for her -- there is some
    # explanatory text to that effect.
    self.fail('Finish the test!')

    # She visits that URL - her to-do list is still there.

    # Satisfied, she goes back to sleep</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But really we want to expand on this, by saying that different users
don&#8217;t see each other&#8217;s lists, and each get their own URL as a way of
going back to their saved lists.  What might a new design look like?</p>
</div>
<div class="sect3">
<h4 id="_not_big_design_up_front">7.1.1. Not Big Design Up Front</h4>
<div class="paragraph">
<p>TDD
is closely associated with the agile movement in software development,
which includes a reaction against <em>Big Design Up Front</em>, the
traditional software engineering practice whereby, after a lengthy requirements
gathering exercise, there is an equally lengthy design stage where the
software is planned out on paper. The agile philosophy is that you learn more
from solving problems in practice than in theory, especially when you confront
your application with real users as soon as possible. Instead
of a long
up-front design phase, we try to put a <em>minimum viable application</em> out
there early, and let the design evolve gradually based on feedback from
real-world usage.</p>
</div>
<div class="paragraph">
<p>But that doesn&#8217;t mean that thinking about design is outright banned! In the
last big chapter we saw how just blundering ahead without thinking can
<em>eventually</em> get us to the right answer, but often a little thinking about
design can help us get there faster. So, let&#8217;s think about our minimum viable
lists app, and what kind of design we&#8217;ll need to deliver it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We want each user to be able to store their own list&#8212;&#8203;at least one, for now.</p>
</li>
<li>
<p>A list is made up of several items, whose primary attribute is a bit of
descriptive text.</p>
</li>
<li>
<p>We need to save lists from one visit to the next.  For now, we can give
each user a unique URL for their list.  Later on we may want some way of
automatically recognising users and showing them their lists.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To deliver the "for now" items, it sounds like we&#8217;re going to store
lists and their items in a database.  Each list will have a unique URL,
and each list item will be a bit of descriptive text, associated with a
particular list.</p>
</div>
</div>
<div class="sect3">
<h4 id="_yagni">7.1.2. YAGNI!</h4>
<div class="paragraph">
<p>Once
you start thinking about design, it can be hard to stop. All sorts of
other thoughts are occurring to us&#8212;&#8203;we might want to give each list
a name or title, we might want to recognise users using usernames and
passwords, we might want to add a longer notes field as well as short
descriptions to our list, we might want to store some kind of ordering, and so
on.  But we obey another tenet of the agile gospel:  "YAGNI" (pronounced
yag-knee), which stands for "You ain&#8217;t gonna need it!"  As software
developers, we have fun creating things, and sometimes it&#8217;s hard to resist
the urge to build things just because an idea occurred to us and we <em>might</em>
need it.  The trouble is that more often than not, no matter how cool the idea
was, you <em>won&#8217;t</em> end up using it. Instead you have a load of unused code,
adding to the complexity of your application. YAGNI is the mantra we use to
resist our overenthusiastic creative urges.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rest_ish">7.1.3. REST (ish)</h4>
<div class="paragraph">
<p>We
have an idea of the data structure we want&#8212;&#8203;the Model part of
Model-View-Controller (MVC).  What about the View and Controller parts?
How should the user interact with <code>List</code>s and their <code>Item</code>s using a web browser?</p>
</div>
<div class="paragraph">
<p>Representational State Transfer (REST) is an approach to web design that&#8217;s
usually used to guide the design of web-based APIs. When designing a
user-facing site, it&#8217;s not possible to stick <em>strictly</em> to the REST rules,
but they still provide some useful inspiration (skip ahead to
<a href="#appendix_rest_api">Building a REST API: JSON, Ajax, and Mocking with JavaScript</a> if you want to see a real REST API).</p>
</div>
<div class="paragraph">
<p>REST suggests that we have a URL structure that matches our data structure,
in this case lists and list items.  Each list can have its own URL:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/&lt;list identifier&gt;/</pre>
</div>
</div>
<div class="paragraph">
<p>That will fulfill the requirement we&#8217;ve specified in our FT. To view a list, we
use a GET request (a normal browser visit to the page).</p>
</div>
<div class="paragraph">
<p>To create a brand new list, we&#8217;ll have a special URL that accepts POST
requests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/new</pre>
</div>
</div>
<div class="paragraph">
<p>To add a new item to an existing list, we&#8217;ll have a separate URL, to which
we can send POST requests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    /lists/&lt;list identifier&gt;/add_item</pre>
</div>
</div>
<div class="paragraph">
<p>(Again, we&#8217;re not trying to perfectly follow the rules of REST, which would
use a PUT request here&#8212;&#8203;we&#8217;re just using REST for inspiration. Apart from
anything else, you can&#8217;t use PUT in a standard HTML form.)</p>
</div>
<div class="paragraph">
<p>In
summary, our scratchpad for this chapter looks something like this:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_new_design_incrementally_using_tdd">7.2. Implementing the New Design Incrementally Using TDD</h3>
<div class="paragraph">
<p>How
do we use TDD to implement the new design? Let&#8217;s take another look at
the flowchart for the TDD process in <a href="#TDD-double-loop">The TDD process with functional and unit tests</a>.</p>
</div>
<div class="paragraph">
<p>At the top level, we&#8217;re going to use a combination of adding new functionality
(by adding a new FT and writing new application code), and refactoring our
application&#8212;&#8203;that is, rewriting some of the existing implementation so that it
delivers the same functionality to the user but using aspects of our new
design. We&#8217;ll be able to use the existing functional test to verify we don&#8217;t
break what already works, and the new functional test to drive the new
features.</p>
</div>
<div class="paragraph">
<p>At the unit test level, we&#8217;ll be adding new tests or modifying existing ones to
test for the changes we want, and we&#8217;ll be able to similarly use the unit tests
we don&#8217;t touch to help make sure we don&#8217;t break anything in the process.</p>
</div>
<div id="TDD-double-loop" class="imageblock">
<div class="content">
<img src="images/twp2_0701.png" alt="A flowchart showing functional tests as the overall cycle, and unit tests helping to code. Tests passing and failing are marked as green and red respectively.">
</div>
<div class="title">Figure 12. The TDD process with functional and unit tests</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_ensuring_we_have_a_regression_test">7.3. Ensuring We Have a Regression Test</h3>
<div class="paragraph">
<p>Let&#8217;s
translate our scratchpad into a new functional test method, which
introduces a second user and checks that their to-do list is separate from
Edith&#8217;s.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start out very similarly to the first. Edith adds a first item to
create a to-do list, but we introduce our first new assertion—Edith&#8217;s
list should live at its own, unique URL:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch07l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_can_start_a_list_for_one_user(self):
    # Edith has heard about a cool new online to-do app. She goes
    [...]
    # The page updates again, and now shows both items on her list
    self.wait_for_row_in_list_table('2: Use peacock feathers to make a fly')
    self.wait_for_row_in_list_table('1: Buy peacock feathers')

    # Satisfied, she goes back to sleep


def test_multiple_users_can_start_lists_at_different_urls(self):
    # Edith starts a new to-do list
    self.browser.get(self.live_server_url)
    inputbox = self.browser.find_element_by_id('id_new_item')
    inputbox.send_keys('Buy peacock feathers')
    inputbox.send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Buy peacock feathers')

    # She notices that her list has a unique URL
    edith_list_url = self.browser.current_url
    self.assertRegex(edith_list_url, '/lists/.+')  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>assertRegex</code> is
a helper function from <code>unittest</code> that checks
    whether a string matches a regular expression. We use it to check that our
    new REST-ish design has been implemented. Find
out more in the <a href="http://docs.python.org/3/library/unittest.html"><code>unittest</code> documentation</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we imagine a new user coming along. We want to check that they don&#8217;t see
any of Edith&#8217;s items when they visit the home page, and that they get their own
unique URL for their list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch07l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    [...]
    self.assertRegex(edith_list_url, '/lists/.+')  <i class="conum" data-value="1"></i><b>(1)</b>

    # Now a new user, Francis, comes along to the site.

    ## We use a new browser session to make sure that no information
    ## of Edith's is coming through from cookies etc
    self.browser.quit()
    self.browser = webdriver.Firefox()

    # Francis visits the home page.  There is no sign of Edith's
    # list
    self.browser.get(self.live_server_url)
    page_text = self.browser.find_element_by_tag_name('body').text
    self.assertNotIn('Buy peacock feathers', page_text)
    self.assertNotIn('make a fly', page_text)

    # Francis starts a new list by entering a new item. He
    # is less interesting than Edith...
    inputbox = self.browser.find_element_by_id('id_new_item')
    inputbox.send_keys('Buy milk')
    inputbox.send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Buy milk')

    # Francis gets his own unique URL
    francis_list_url = self.browser.current_url
    self.assertRegex(francis_list_url, '/lists/.+')
    self.assertNotEqual(francis_list_url, edith_list_url)

    # Again, there is no trace of Edith's list
    page_text = self.browser.find_element_by_tag_name('body').text
    self.assertNotIn('Buy peacock feathers', page_text)
    self.assertIn('Buy milk', page_text)

    # Satisfied, they both go back to sleep</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I&#8217;m
using the convention of double-hashes (<code>##</code>) to indicate
    "meta-comments"&mdash;comments about <em>how</em> the test is working and why&#8212;&#8203;so
    that we can distinguish them from regular comments in FTs which explain the
    User Story. They&#8217;re a message to our future selves, which might otherwise
    be wondering why the heck we&#8217;re quitting the browser and starting a new
    one&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Other than that, the new test is fairly self-explanatory. Let&#8217;s see how we do
when we run our FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
.F
======================================================================
FAIL: test_multiple_users_can_start_lists_at_different_urls
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 83, in
test_multiple_users_can_start_lists_at_different_urls
    self.assertRegex(edith_list_url, '/lists/.+')
AssertionError: Regex didn't match: '/lists/.+' not found in
'http://localhost:8081/'

 ---------------------------------------------------------------------
Ran 2 tests in 5.786s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Good, our first test still passes, and the second one fails where we might
expect.  Let&#8217;s do a commit, and then go and build some new models and views:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -a</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_iterating_towards_the_new_design">7.4. Iterating Towards the New Design</h3>
<div class="paragraph">
<p>Being
all excited about our new design, I had an overwhelming urge to dive in
at this point and start changing <em>models.py</em>, which would have broken half the
unit tests, and then pile in and change almost every single line of code, all
in one go.  That&#8217;s a natural urge, and TDD, as a discipline, is a constant
fight against it. Obey the Testing Goat, not Refactoring Cat!  We don&#8217;t need to
implement our new, shiny design in a single big bang. Let&#8217;s make small changes
that take us from a working state to a working state, with our design guiding
us gently at each stage.</p>
</div>
<div class="paragraph">
<p>There are four items on our to-do list. The FT, with its <code>Regexp didn't
match</code>, is telling us that the second item&#8212;&#8203;giving lists their own URL and
identifier&#8212;&#8203;is the one we should work on next. Let&#8217;s have a go at fixing
that, and only that.</p>
</div>
<div class="paragraph">
<p>The URL comes from the redirect after POST.  In <em>lists/tests.py</em>, find
<code>test_redirects_after_POST</code>, and change the expected redirect
location:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">self.assertEqual(response.status_code, 302)
self.assertEqual(response['location'], '/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that seem slightly strange?  Clearly, <em>/lists/the-only-list-in-the-world</em>
isn&#8217;t a URL that&#8217;s going to feature in the final design of our application. But
we&#8217;re committed to changing one thing at a time.  While our application only
supports one list, this is the only URL that makes sense.  We&#8217;re still moving
forwards, in that we&#8217;ll have a different URL for our list and our home page,
which is a step along the way to a more REST-ful design. Later, when we have
multiple lists, it will be easy to change.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another way of thinking about it is as a problem-solving <span class="keep-together">technique</span>: our
    new URL design is currently not implemented, so it works for 0 items.
    Ultimately, we want to solve for <em>n</em> items, but solving for 1 item is a
    good step along the way.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the unit tests gives us an expected fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
AssertionError: '/' != '/lists/the-only-list-in-the-world/'</pre>
</div>
</div>
<div class="paragraph">
<p>We can go adjust our <code>home_page</code> view in <em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    if request.method == 'POST':
        Item.objects.create(text=request.POST['item_text'])
        return redirect('/lists/the-only-list-in-the-world/')

    items = Item.objects.all()
    return render(request, 'home.html', {'items': items})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Of course, that will now totally break the functional tests, because there is
no such URL on our site yet.  Sure enough, if you run them, you&#8217;ll find they
fail just after trying to submit the first item, saying that they can&#8217;t find
the list table; it&#8217;s because the URL
<span class="keep-together"><em>/the-only-list-in-the-world/</em></span> doesn&#8217;t exist yet!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "...python-tdd-book/functional_tests/tests.py", line 57, in
test_can_start_a_list_for_one_user
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]

[...]

  File "...python-tdd-book/functional_tests/tests.py", line 79, in
test_multiple_users_can_start_lists_at_different_urls
    self.wait_for_row_in_list_table('1: Buy peacock feathers')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]</pre>
</div>
</div>
<div class="paragraph">
<p>Not only is our new test failing, but the old one is too.  That tells
us we&#8217;ve introduced a <em>regression</em>.  Let&#8217;s try to get back to a working
state as quickly as possible by building a URL for our one and only list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_taking_a_first_self_contained_step_one_new_url">7.5. Taking a First, Self-Contained Step: One New URL</h3>
<div class="paragraph">
<p>Open
up <em>lists/tests.py</em>, and add a new test class called <code>ListViewTest</code>.  Then
copy the method called <code>test_displays_all_list_items</code> across from
<code>HomePageTest</code> into our new class, rename it, and adapt it slightly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):

    def test_displays_all_items(self):
        Item.objects.create(text='itemey 1')
        Item.objects.create(text='itemey 2')

        response = self.client.get('/lists/the-only-list-in-the-world/')

        self.assertContains(response, 'itemey 1')  <i class="conum" data-value="1"></i><b>(1)</b>
        self.assertContains(response, 'itemey 2')  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s
a new helper method: instead of using the slightly annoying
    <code>assertIn</code>/<code>response.content.decode()</code> dance, Django provides the
    <code>assertContains</code> method, which knows how to deal with responses and the
    bytes of their content.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s try running this test now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertContains(response, 'itemey 1')
[...]
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a nice side effect of using <code>assertContains</code>: it tells us straight
away that the test is failing because our new URL doesn&#8217;t exist yet, and
is returning a 404.</p>
</div>
<div class="sect3">
<h4 id="_a_new_url">7.5.1. A New URL</h4>
<div class="paragraph">
<p>Our singleton list URL doesn&#8217;t exist yet.  We fix that in <em>superlists/urls.py</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Watch
out for trailing slashes in URLs, both here in the tests and in
    <em>urls.py</em>. They&#8217;re a common source of bugs.
</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(r'^$', views.home_page, name='home'),
    url(r'^lists/the-only-list-in-the-world/$', views.view_list, name='view_list'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Running the tests again, we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: module 'lists.views' has no attribute 'view_list'</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_view_function">7.5.2. A New View Function</h4>
<div class="paragraph">
<p>Nicely self-explanatory.  Let&#8217;s create a dummy view function in
<em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request):
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The view lists.views.view_list didn't return an HttpResponse
object. It returned None instead.

[...]
FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Down to just one failure, and it&#8217;s pointing us in the right direction. Let&#8217;s
copy the two last lines from the <code>home_page</code> view and see if they&#8217;ll do the
trick:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request):
    items = Item.objects.all()
    return render(request, 'home.html', {'items': items})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests and they should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 7 tests in 0.016s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s try the FTs again and see what they tell us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_can_start_a_list_for_one_user
[...]
  File "...python-tdd-book/functional_tests/tests.py", line 67, in
test_can_start_a_list_for_one_user
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']

FAIL: test_multiple_users_can_start_lists_at_different_urls
[...]
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Both of them are getting a little further than they were before, but they&#8217;re
still failing.  It would be nice to get back to a working state and get that
first one passing again.  What&#8217;s it trying to tell us?</p>
</div>
<div class="paragraph">
<p>It&#8217;s
failing when we try to add the second item.  We have to put our debugging
hats on here.  We know the home page is working, because the test has got all
the way down to line 67 in the FT, so we&#8217;ve at least added a first item.  And
our unit tests are all passing, so we&#8217;re pretty sure the URLs and views are
doing what they should&#8212;&#8203;the home page displays the right template, and
can handle POST requests, and the <em>only-list-in-the-world</em> view knows how
to display all items&#8230;&#8203;but it doesn&#8217;t know how to handle POST requests. Ah,
that gives us a clue.</p>
</div>
<div class="paragraph">
<p>A second clue is the rule of thumb that, when all the unit tests are passing
but the functional tests aren&#8217;t, it&#8217;s often pointing at a problem that&#8217;s not
covered by the unit tests, and in our case, that&#8217;s often a template problem.</p>
</div>
<div class="paragraph">
<p>The answer is that our <em>home.html</em> input form currently doesn&#8217;t specify an
explicit URL to POST to:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">        &lt;form method="POST"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By default the browser sends the POST data back to the same URL it&#8217;s currently
on.  When we&#8217;re on the home page that works fine, but when we&#8217;re on our
<em>only-list-in-the-world</em> page, it doesn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Now we could dive in and add POST request handling to our new view, but that
would involve writing a bunch more tests and code, and at this point we&#8217;d like
to get back to a working state as quickly as possible.  Actually the quickest
thing we can do to get things fixed is to just use the existing home page view,
which already works, for all POST requests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">        &lt;form method="POST" action="/"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Try that, and we&#8217;ll see our FTs get back to a happier place:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_multiple_users_can_start_lists_at_different_urls
[...]
AssertionError: 'Buy peacock feathers' unexpectedly found in 'Your To-Do
list\n1: Buy peacock feathers'

Ran 2 tests in 8.541s
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Our original test passes once again, so we know we&#8217;re back to a working state.
The new functionality may not be working yet, but at least the old stuff works
as well as it used to.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_green_refactor">7.6. Green? Refactor</h3>
<div class="paragraph">
<p>Time
for a little tidying up.</p>
</div>
<div class="paragraph">
<p>In the <em>Red/Green/Refactor</em> dance, we&#8217;ve arrived at green, so we should see
what needs a refactor.  We now have two views, one for the home page, and one
for an individual list.  Both are currently using the same template, and
passing it all the list items currently in the database.  If we look through
our unit test methods, we can see some stuff we probably want to change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep -E "class|def" lists/tests.py</strong>
class HomePageTest(TestCase):
    def test_uses_home_template(self):
    def test_displays_all_list_items(self):
    def test_can_save_a_POST_request(self):
    def test_redirects_after_POST(self):
    def test_only_saves_items_when_necessary(self):
class ListViewTest(TestCase):
    def test_displays_all_items(self):
class ItemModelTest(TestCase):
    def test_saving_and_retrieving_items(self):</pre>
</div>
</div>
<div class="paragraph">
<p>We can definitely delete the <code>test_displays_all_list_items</code> method from
<code>HomePageTest</code>; it&#8217;s no longer needed.  If you run <strong><code>manage.py test lists</code></strong>
now, it should say it ran 6 tests instead of 7:</p>
</div>
<div class="listingblock dofirst-ch07l012">
<div class="content">
<pre>Ran 6 tests in 0.016s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Next, since we don&#8217;t actually need the home page template to display all list
items any more, it should just show a single input box inviting you to start a
new list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_another_small_step_a_separate_template_for_viewing_lists">7.7. Another Small Step: A Separate Template for Viewing Lists</h3>
<div class="paragraph">
<p>Since
the home page and the list view are now quite distinct pages,
they should be using different HTML templates; <em>home.html</em> can have the
single input box, whereas a new template, <em>list.html</em>, can take care
of showing the table of existing items.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a new test to check that it&#8217;s using a different template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):

    def test_uses_list_template(self):
        response = self.client.get('/lists/the-only-list-in-the-world/')
        self.assertTemplateUsed(response, 'list.html')


    def test_displays_all_items(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>assertTemplateUsed</code> is one of the more useful functions that the Django Test
Client gives us.  Let&#8217;s see what it says:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Template 'list.html' was not a template
used to render the response. Actual template(s) used: home.html</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  Let&#8217;s change the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request):
    items = Item.objects.all()
    return render(request, 'list.html', {'items': items})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But, obviously, that template doesn&#8217;t exist yet. If we run the unit tests, we
get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.template.exceptions.TemplateDoesNotExist: list.html</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new file at <em>lists/templates/list.html</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>touch lists/templates/list.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>A blank template, which gives us this error&#8212;&#8203;good to know the tests are
there to make sure we fill it in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
</div>
</div>
<div class="paragraph">
<p>The template for an individual list will reuse quite a lot of the stuff
we currently have in <em>home.html</em>, so we can start by just copying that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp lists/templates/home.html lists/templates/list.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That gets the tests back to passing (green).  Now let&#8217;s do a little more
tidying up (refactoring).  We said the home page doesn&#8217;t need to list items, it
only needs the new list input field, so we can remove some lines from
<em>lists/templates/home.html</em>, and maybe slightly tweak the <code>h1</code> to say "Start a
new To-Do list":</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;body&gt;
  &lt;h1&gt;Start a new To-Do list&lt;/h1&gt;
  &lt;form method="POST"&gt;
    &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
    {% csrf_token %}
  &lt;/form&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We rerun the unit tests to check that hasn&#8217;t broken anything&#8212;&#8203;good&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>There&#8217;s actually no need to pass all the items to the <em>home.html</em> template in
our <code>home_page</code> view, so we can simplify that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    if request.method == 'POST':
        Item.objects.create(text=request.POST['item_text'])
        return redirect('/lists/the-only-list-in-the-world/')
    return render(request, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests once more; they still pass. Time to run the functional
tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']</pre>
</div>
</div>
<div class="paragraph">
<p>Not bad!  Our regression test (the first FT) is passing, and our new test
is now getting slightly further forwards&#8212;&#8203;it&#8217;s telling us that Francis
isn&#8217;t getting his own list page (because he still sees some of Edith&#8217;s
list items).</p>
</div>
<div class="paragraph">
<p>It
may feel like we haven&#8217;t made much headway since, functionally, the site
still behaves almost exactly like it did when we started the chapter, but this
really is progress. We&#8217;ve started on the road to our new design, and we&#8217;ve
implemented a number of stepping stones <em>without making anything worse than it
was before</em>.  Let&#8217;s commit our progress so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # should show 4 changed files and 1 new file, list.html
$ <strong>git add lists/templates/list.html</strong>
$ <strong>git diff</strong> # should show we've simplified home.html,
           # moved one test to a new class in lists/tests.py added a new view
           # in views.py, and simplified home_page and made one addition to
           # urls.py
$ <strong>git commit -a</strong> # add a message summarising the above, maybe something like
                # "new URL, view and template to display lists"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_third_small_step_a_url_for_adding_list_items">7.8. A Third Small Step: A URL for Adding List Items</h3>
<div class="paragraph">
<p>Where
are we with our own to-do list?</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em> &#8230;&#8203;</p>
</li>
<li>
<p><em>Add a URL for creating a new list via POST</em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve <em>sort of</em> made progress on the second item, even if there&#8217;s still only
one list in the world. The first item is a bit scary.  Can we do something
about items 3 or 4?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a new URL for adding new list items.  If nothing else, it&#8217;ll
simplify the home page view.</p>
</div>
<div class="sect3">
<h4 id="_a_test_class_for_new_list_creation">7.8.1. A Test Class for New List Creation</h4>
<div class="paragraph">
<p>Open up <em>lists/tests.py</em>, and <em>move</em> the
<code>test_can_save_a_POST_request</code> and <code>test_redirects_after_POST</code> methods into a
new class, then change the URL they POST to:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/tests.py (ch07l021-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):

    def test_can_save_a_POST_request(self):
        self.client.post('/lists/new', data={'item_text': 'A new list item'})
        self.assertEqual(Item.objects.count(), 1)
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'A new list item')


    def test_redirects_after_POST(self):
        response = self.client.post('/lists/new', data={'item_text': 'A new list item'})
        self.assertEqual(response.status_code, 302)
        self.assertEqual(response['location'], '/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is another place to pay attention to trailing slashes, incidentally.
    It&#8217;s <code>/new</code>, with no trailing slash.  The convention I&#8217;m using is that URLs
    without a trailing slash are "action" URLs which modify the database.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While we&#8217;re at it, let&#8217;s learn a new Django Test Client method, <code>assertRedirects</code>:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/tests.py (ch07l021-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_redirects_after_POST(self):
        response = self.client.post('/lists/new', data={'item_text': 'A new list item'})
        self.assertRedirects(response, '/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s not much to it, but it just nicely replaces two asserts with a single
one&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Try running that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
    self.assertRedirects(response, '/lists/the-only-list-in-the-world/')
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
<div class="paragraph">
<p>The first failure tells us we&#8217;re not saving a new item to the database, and the
second says that, instead of returning a 302 redirect, our view is returning
a 404. That&#8217;s because we haven&#8217;t built a URL for <em>/lists/new</em>, so the
<code>client.post</code> is just getting a "not found" response.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Do you remember how we split this out into two tests earlier? If we
    only had one test that checked both the saving and the redirect, it would
    have failed on the <code>0 != 1</code> failure, which would have been much harder to
    debug.  Ask me how I know this.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_a_url_and_view_for_new_list_creation">7.8.2. A URL and View for New List Creation</h4>
<div class="paragraph">
<p>Let&#8217;s build our new URL now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(r'^$', views.home_page, name='home'),
    url(r'^lists/new$', views.new_list, name='new_list'),
    url(r'^lists/the-only-list-in-the-world/$', views.view_list, name='view_list'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we get a <code>no attribute 'new_list'</code>, so let&#8217;s fix that, in
<em>lists/views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l023-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we get "The view lists.views.new_list didn&#8217;t return an HttpResponse
object".  (This is getting rather familiar!)  We could return a raw
<code>HttpResponse</code>, but since we know we&#8217;ll need a redirect, let&#8217;s borrow a line
from <code>home_page</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l023-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    return redirect('/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>Seems reasonably straightforward. We borrow another line from <code>home_page</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l023-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    Item.objects.create(text=request.POST['item_text'])
    return redirect('/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And everything now passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 7 tests in 0.030s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And the FTs show me that I&#8217;m back to the working state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
Ran 2 tests in 8.972s
FAILED (failures=1)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_now_redundant_code_and_tests">7.8.3. Removing Now-Redundant Code and Tests</h4>
<div class="paragraph">
<p>We&#8217;re looking good. Since our new views are now doing most of the work that
<code>home_page</code> used to do, we should be able to massively simplify it. Can we
remove the whole <code>if request.method == 'POST'</code> section, for example?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return render(request, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yep!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we can remove the now-redundant
<code>test_only_saves_&#x200b;items_when_necessary</code> test too!</p>
</div>
<div class="paragraph">
<p>Doesn&#8217;t that feel good?  The view functions are looking much simpler. We rerun
the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock dofirst-ch07l025">
<div class="content">
<pre>Ran 6 tests in 0.016s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>and the FTs?</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_regression_pointing_our_forms_at_the_new_url">7.8.4. A Regression! Pointing Our Forms at the New URL</h4>
<div class="paragraph">
<p>Oops:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_can_start_a_list_for_one_user
[...]
  File "...python-tdd-book/functional_tests/tests.py", line 57, in
test_can_start_a_list_for_one_user
    self.wait_for_row_in_list_table('1: Buy peacock feathers')
  File "...python-tdd-book/functional_tests/tests.py", line 23, in
wait_for_row_in_list_table
    table = self.browser.find_element_by_id('id_list_table')
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]

ERROR: test_multiple_users_can_start_lists_at_different_urls
[...]
  File "...python-tdd-book/functional_tests/tests.py", line 79, in
test_multiple_users_can_start_lists_at_different_urls
    self.wait_for_row_in_list_table('1: Buy peacock feathers')
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]
[...]

Ran 2 tests in 11.592s
FAILED (errors=2)</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because our forms are still pointing to the old URL. In <em>both</em> <em>home.html</em>
and <em>lists.html</em>, let&#8217;s change them to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html, lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;form method="POST" action="/lists/new"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And that should get us back to working again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
[...]
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s another nicely self-contained commit, in that we&#8217;ve made a bunch
of changes to our URLs, our <em>views.py</em> is looking much neater and tidier, and
we&#8217;re sure the application is still working as well as it did before.  We&#8217;re
getting good at this working-state-to-working-state malarkey!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # 5 changed files
$ <strong>git diff</strong> # URLs for forms x2, moved code in views + tests, new URL
$ <strong>git commit -a</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And
we can cross out an item on the to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Adjust model so that items are associated with different lists</em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_biting_the_bullet_adjusting_our_models">7.9. Biting the Bullet: Adjusting Our Models</h3>
<div class="paragraph">
<p>Enough
housekeeping with our URLs. It&#8217;s time to bite the bullet and
change our models.  Let&#8217;s adjust the model unit test. Just for a change, I&#8217;ll
present the changes in the form of a diff:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -1,5 +1,5 @@
 from django.test import TestCase
-from lists.models import Item
+from lists.models import Item, List


 class HomePageTest(TestCase):
@@ -44,22 +44,32 @@ class ListViewTest(TestCase):



-class ItemModelTest(TestCase):
+class ListAndItemModelsTest(TestCase):

     def test_saving_and_retrieving_items(self):
+        list_ = List()
+        list_.save()
+
         first_item = Item()
         first_item.text = 'The first (ever) list item'
+        first_item.list = list_
         first_item.save()

         second_item = Item()
         second_item.text = 'Item the second'
+        second_item.list = list_
         second_item.save()

+        saved_list = List.objects.first()
+        self.assertEqual(saved_list, list_)
+
         saved_items = Item.objects.all()
         self.assertEqual(saved_items.count(), 2)

         first_saved_item = saved_items[0]
         second_saved_item = saved_items[1]
         self.assertEqual(first_saved_item.text, 'The first (ever) list item')
+        self.assertEqual(first_saved_item.list, list_)
         self.assertEqual(second_saved_item.text, 'Item the second')
+        self.assertEqual(second_saved_item.list, list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We create a new <code>List</code> object, and then we assign each item to it
by assigning it as its <code>.list</code> property.  We check that the list is properly
saved, and we check that the two items have also saved their relationship
to the list.  You&#8217;ll also notice that we can compare list objects with each
other directly (<code>saved_list</code> and <code>list_</code>)&mdash;behind the scenes, these
will compare themselves by checking that their primary key (the <code>.id</code> attribute)
is the same.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m using the variable name <code>list_</code> to avoid "shadowing" the Python
    built-in <code>list</code> function.  It&#8217;s ugly, but all the other options I tried
    were equally ugly or worse (<code>my_list</code>, <code>the_list</code>, <code>list1</code>, <code>listey</code>&#8230;&#8203;).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Time for another unit-test/code cycle.</p>
</div>
<div class="paragraph">
<p>For the first couple of iterations, rather than explicitly showing you what
code to enter in between every test run, I&#8217;m only going to show you the
expected error messages from running the tests.  I&#8217;ll let you figure out what
each minimal code change should be on your own.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Need a hint?  Go back and take a look at the steps we took to introduce
    the <code>Item</code> model in <a href="#first-django-model">the chapter before last</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Your first error should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ImportError: cannot import name 'List'</pre>
</div>
</div>
<div class="paragraph">
<p>Fix that, and then you should see:</p>
</div>
<div class="listingblock dofirst-ch07l028-1">
<div class="content">
<pre>AttributeError: 'List' object has no attribute 'save'</pre>
</div>
</div>
<div class="paragraph">
<p>Next you should see:</p>
</div>
<div class="listingblock dofirst-ch07l028-2">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: lists_list</pre>
</div>
</div>
<div class="paragraph">
<p>So we run a <code>makemigrations</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0003_list.py
    - Create model List</pre>
</div>
</div>
<div class="paragraph">
<p>And then you should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(first_saved_item.list, list_)
AttributeError: 'Item' object has no attribute 'list'</pre>
</div>
</div>
<div class="sect3">
<h4 id="_a_foreign_key_relationship">7.9.1. A Foreign Key Relationship</h4>
<div class="paragraph">
<p>How do we give our <code>Item</code> a list attribute?  Let&#8217;s just try naively making it
like the <code>text</code> attribute (and here&#8217;s your chance to see whether your
solution so far looks like mine by the way):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.db import models

class List(models.Model):
    pass

class Item(models.Model):
    text = models.TextField(default='')
    list = models.TextField(default='')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As usual, the tests tell us we need a migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
django.db.utils.OperationalError: no such column: lists_item.list

$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0004_item_list.py
    - Add field list to item</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see what that gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'List object' != &lt;List: List object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re not quite there. Look closely at each side of the <code>!=</code>.  Django has only
saved the string representation of the <code>List</code> object. To save the relationship
to the object itself, we tell Django about the relationship between the two
classes using a <code>ForeignKey</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.db import models

class List(models.Model):
    pass


class Item(models.Model):
    text = models.TextField(default='')
    list = models.ForeignKey(List, default=None)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;ll need a migration too.  Since the last one was a red herring, let&#8217;s
delete it and replace it with a new one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm lists/migrations/0004_item_list.py</strong>
$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0004_item_list.py
    - Add field list to item</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Deleting migrations is dangerous.  We do need to do it now and again,
    because we don&#8217;t always get our models code right on the first go. But if
    you delete a migration that&#8217;s already been applied to a database somewhere,
    Django will be confused about what state it&#8217;s in, and how to apply future
    migrations. You should only do it when you&#8217;re sure the migration hasn&#8217;t
    been used.  A good rule of thumb is that you should never delete or modify
    a migration that&#8217;s already been committed to your VCS.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_the_rest_of_the_world_to_our_new_models">7.9.2. Adjusting the Rest of the World to Our New Models</h4>
<div class="paragraph">
<p>Back in our tests, now what happens?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
ERROR: test_displays_all_items (lists.tests.ListViewTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_redirects_after_POST (lists.tests.NewListTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_can_save_a_POST_request (lists.tests.NewListTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id

Ran 6 tests in 0.021s

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Oh dear!</p>
</div>
<div class="paragraph">
<p>There is some good news. Although it&#8217;s hard to see, our model tests are
passing.  But three of our view tests are failing nastily.</p>
</div>
<div class="paragraph">
<p>The reason is because of the new relationship we&#8217;ve introduced between
<code>Item</code>s and <code>List</code>s, which requires each item to have a parent list, which
our old tests and code aren&#8217;t prepared for.</p>
</div>
<div class="paragraph">
<p>Still, this is exactly why we have tests! Let&#8217;s get them working again.  The
easiest is the <code>ListViewTest</code>; we just create a parent list for our two test
items:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):

    def test_displays_all_items(self):
        list_ = List.objects.create()
        Item.objects.create(text='itemey 1', list=list_)
        Item.objects.create(text='itemey 2', list=list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us down to two failing tests, both on tests that try to POST to our
<code>new_list</code> view. Decoding the tracebacks using our usual technique, working
back from error to line of test code to, buried in there somewhere, the line
of our own code that caused the failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>File "...python-tdd-book/lists/views.py", line 9, in new_list
Item.objects.create(text=request.POST['item_text'])</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s when we try to create an item without a parent list. So we make a similar
change in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.models import Item, List
[...]
def new_list(request):
    list_ = List.objects.create()
    Item.objects.create(text=request.POST['item_text'], list=list_)
    return redirect('/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gets our tests passing again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 6 tests in 0.030s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Are you cringing internally at this point?  <em>Arg! This feels so wrong; we
create a new list for every single new item submission, and we&#8217;re still just
displaying all items as if they belong to the same list!</em>
I know, I feel the same.  The
step-by-step approach, in which you go
from working code to working code, is counterintuitive. I always feel like
just diving in and trying to fix everything all in one go, instead of going
from one weird half-finished state to another.  But remember the Testing Goat!
When you&#8217;re up a mountain, you want to think very carefully about where you put
each foot, and take one step at a time, checking at each stage that the place
you&#8217;ve put it hasn&#8217;t caused you to fall off a cliff.</p>
</div>
<div class="paragraph">
<p>So just to reassure ourselves that things have worked, we rerun the FT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: '1: Buy milk' not found in ['1: Buy peacock feathers', '2: Buy
milk']
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Sure
enough, it gets all the way through to where we were before.  We haven&#8217;t broken
anything, and we&#8217;ve made a change to the database.  That&#8217;s something to be
pleased with! Let&#8217;s commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # 3 changed files, plus 2 migrations
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we can cross out another item on the to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em>Add unique URLs for each list</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_each_list_should_have_its_own_url">7.10. Each List Should Have Its Own URL</h3>
<div class="paragraph">
<p>What
shall we use as the unique identifier for our lists?  Probably the
simplest thing, for now, is just to use the auto-generated <code>id</code> field from the
database. Let&#8217;s change <code>ListViewTest</code> so that the two tests point at new
URLs.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also change the old <code>test_displays_all_items</code> test and call it
<code>test_displays_only_items_for_that_list</code> instead, and make it check that
only the items for a specific list are displayed:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):

    def test_uses_list_template(self):
        list_ = List.objects.create()
        response = self.client.get(f'/lists/{list_.id}/')
        self.assertTemplateUsed(response, 'list.html')


    def test_displays_only_items_for_that_list(self):
        correct_list = List.objects.create()
        Item.objects.create(text='itemey 1', list=correct_list)
        Item.objects.create(text='itemey 2', list=correct_list)
        other_list = List.objects.create()
        Item.objects.create(text='other list item 1', list=other_list)
        Item.objects.create(text='other list item 2', list=other_list)

        response = self.client.get(f'/lists/{correct_list.id}/')

        self.assertContains(response, 'itemey 1')
        self.assertContains(response, 'itemey 2')
        self.assertNotContains(response, 'other list item 1')
        self.assertNotContains(response, 'other list item 2')</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A couple more of those lovely f-strings in this listing!  If they&#8217;re
    still a bit of a mystery, take a look at the
<a href="https://docs.python.org/3/reference/lexical_analysis.html#f-strings">docs</a>
    (although if your formal CS education is as bad as mine, you&#8217;ll probably
    skip the formal grammar).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the unit tests gives an expected 404, and another related error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)
[...]
FAIL: test_uses_list_template (lists.tests.ListViewTest)
AssertionError: No templates used to render the response</pre>
</div>
</div>
<div class="sect3">
<h4 id="_capturing_parameters_from_urls">7.10.1. Capturing Parameters from URLs</h4>
<div class="paragraph">
<p>It&#8217;s time to learn how we can pass parameters from URLs to views:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(r'^$', views.home_page, name='home'),
    url(r'^lists/new$', views.new_list, name='new_list'),
    url(r'^lists/(.+)/$', views.view_list, name='view_list'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We adjust the regular expression for our URL to include a <em>capture group</em>,
<code>(.+)</code>, which will match any characters, up to the following <code>/</code>. The captured
text will get passed to the view as an argument.</p>
</div>
<div class="paragraph">
<p>In other words, if we go to the URL <em>/lists/1/</em>, <code>view_list</code> will get a second
argument after the normal <code>request</code> argument, namely the string <code>"1"</code>.
If we go to <em>/lists/foo/</em>, we get <code>view_list(request, "foo")</code>.</p>
</div>
<div class="paragraph">
<p>But our view doesn&#8217;t expect an argument yet! Sure enough, this causes problems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
[...]
TypeError: view_list() takes 1 positional argument but 2 were given
[...]
ERROR: test_uses_list_template (lists.tests.ListViewTest)
[...]
TypeError: view_list() takes 1 positional argument but 2 were given
[...]
ERROR: test_redirects_after_POST (lists.tests.NewListTest)
[...]
TypeError: view_list() takes 1 positional argument but 2 were given
FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>We can fix that easily with a dummy parameter in <em>views.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re down to our expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
[...]
AssertionError: 1 != 0 : Response should not contain 'other list item 1'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s make our view discriminate over which items it sends to the
template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    items = Item.objects.filter(list=list_)
    return render(request, 'list.html', {'items': items})</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_new_list_to_the_new_world">7.10.2. Adjusting new_list to the New World</h4>
<div class="paragraph">
<p>Oops, now we get errors in another test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_redirects_after_POST (lists.tests.NewListTest)
ValueError: invalid literal for int() with base 10:
'the-only-list-in-the-world'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at this test then, since it&#8217;s moaning:</p>
</div>
<div class="exampleblock sourcecode currentcontents small-code">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):
    [...]

    def test_redirects_after_POST(self):
        response = self.client.post('/lists/new', data={'item_text': 'A new list item'})
        self.assertRedirects(response, '/lists/the-only-list-in-the-world/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It looks like it hasn&#8217;t been adjusted to the new world of <code>List</code>s and <code>Item</code>s.
The test should be saying that this view redirects to the URL of the specific
new list it just <span class="keep-together">created</span>:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/tests.py (ch07l036-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_redirects_after_POST(self):
        response = self.client.post('/lists/new', data={'item_text': 'A new list item'})
        new_list = List.objects.first()
        self.assertRedirects(response, f'/lists/{new_list.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That still gives us the <em>invalid literal</em> error. We take a look at the view
itself, and change it so it redirects to a valid place:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch07l036-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    list_ = List.objects.create()
    Item.objects.create(text=request.POST['item_text'], list=list_)
    return redirect(f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us back to passing unit tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test lists</strong>
[...]
......
 ---------------------------------------------------------------------
Ran 6 tests in 0.033s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>What
about the functional tests?  We must be almost there?</p>
</div>
</div>
</div>
<div class="sect2 pagebreak-before">
<h3 id="_the_functional_tests_detect_another_regression">7.11. The Functional Tests Detect Another Regression</h3>
<div class="paragraph">
<p>Well, almost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>F.
======================================================================
FAIL: test_can_start_a_list_for_one_user
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 67, in
test_can_start_a_list_for_one_user
    self.wait_for_row_in_list_table('2: Use peacock feathers to make a fly')
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Use
peacock feathers to make a fly']

 ---------------------------------------------------------------------
Ran 2 tests in 8.617s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Our new test is actually passing, and different users can get different lists,
but the old test is warning us of a regression.  It looks like you can&#8217;t
add a second item to a list any more.  It&#8217;s because of our quick-and-dirty hack
where we create a new list for every single POST submission. This is exactly what
we have functional tests for!</p>
</div>
<div class="paragraph">
<p>And it correlates nicely with the last item on our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_more_view_to_handle_adding_items_to_an_existing_list">7.12. One More View to Handle Adding Items to an Existing List</h3>
<div class="paragraph">
<p>We need a URL and view to handle adding a new item to an existing list
(<em>/lists/&lt;list_id&gt;/add_item</em>).  We&#8217;re getting pretty good at these now, so
let&#8217;s knock one together quickly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewItemTest(TestCase):

    def test_can_save_a_POST_request_to_an_existing_list(self):
        other_list = List.objects.create()
        correct_list = List.objects.create()

        self.client.post(
            f'/lists/{correct_list.id}/add_item',
            data={'item_text': 'A new item for an existing list'}
        )

        self.assertEqual(Item.objects.count(), 1)
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'A new item for an existing list')
        self.assertEqual(new_item.list, correct_list)


    def test_redirects_to_list_view(self):
        other_list = List.objects.create()
        correct_list = List.objects.create()

        response = self.client.post(
            f'/lists/{correct_list.id}/add_item',
            data={'item_text': 'A new item for an existing list'}
        )

        self.assertRedirects(response, f'/lists/{correct_list.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Are you wondering about <code>other_list</code>?  A bit like in the tests for
    viewing a specific list, it&#8217;s important that we add items to a specific
    list.  Adding this second object to the database prevents me from using
    a hack like <code>List.objects.first()</code> in the implementation.  That would be
    a stupid thing to do, and you can go too far down the road of testing
    for all the stupid things you must not do (there are an infinite number
    of those, after all). It&#8217;s a judgement call, but this one feels worth it.
    There&#8217;s some more discussion of this in <a href="#testing-for-stupidity">An Aside on When to Test for Developer Stupidity</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 0 != 1
[...]
AssertionError: 301 != 302 : Response didn't redirect as expected: Response
code was 301 (expected 302)</pre>
</div>
</div>
<div class="sect3">
<h4 id="_beware_of_greedy_regular_expressions">7.12.1. Beware of Greedy Regular Expressions!</h4>
<div class="paragraph">
<p>That&#8217;s
a little strange. We haven&#8217;t actually specified a URL for
<em>/lists/1/add_item</em> yet, so our expected failure is <code>404 != 302</code>.  Why are we
getting a 301?</p>
</div>
<div class="paragraph">
<p>This was a bit of a puzzler! It&#8217;s because we&#8217;ve used a very "greedy"
regular expression in our URL:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    url(r'^lists/(.+)/$', views.view_list, name='view_list'),</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django
has some built-in code to issue a permanent redirect (301) whenever
someone asks for a URL which is <em>almost</em> right, except for a missing slash.
In this case, <span class="keep-together"><em>/lists/1/add_item/</em></span> would be a match for
<code>lists/(.+)/</code>, with the <code>(.+)</code> capturing <code>1/add_item</code>.  So Django "helpfully"
guesses that we actually wanted the URL with a trailing slash.</p>
</div>
<div class="paragraph">
<p>We can fix that by making our URL pattern explicitly capture only numerical
digits, by using the regular expression <code>\d</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    url(r'^lists/(\d+)/$', views.view_list, name='view_list'),</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us the failure we expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 0 != 1
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_last_new_url">7.12.2. The Last New URL</h4>
<div class="paragraph">
<p>Now we&#8217;ve got our expected 404, let&#8217;s add a new URL for adding new items to
existing lists:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(r'^$', views.home_page, name='home'),
    url(r'^lists/new$', views.new_list, name='new_list'),
    url(r'^lists/(\d+)/$', views.view_list, name='view_list'),
    url(r'^lists/(\d+)/add_item$', views.add_item, name='add_item'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Three very similar-looking URLs there.  Let&#8217;s make a note on our
to-do list; they look like good candidates for a refactoring:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em>Add URLs for adding a new item to an existing list via POST</em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Back to the tests, we get the usual missing module view objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: module 'lists.views' has no attribute 'add_item'</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_last_new_view">7.12.3. The Last New View</h4>
<div class="paragraph">
<p>Let&#8217;s try:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def add_item(request):
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Aha:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: add_item() takes 1 positional argument but 2 were given</pre>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def add_item(request, list_id):
    pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The view lists.views.add_item didn't return an HttpResponse object.
It returned None instead.</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>We can copy the <code>redirect</code> from <code>new_list</code> and the <code>List.objects.get</code> from
<code>view_list</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def add_item(request, list_id):
    list_ = List.objects.get(id=list_id)
    return redirect(f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That takes us to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>Finally we make it save our new list item:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def add_item(request, list_id):
    list_ = List.objects.get(id=list_id)
    Item.objects.create(text=request.POST['item_text'], list=list_)
    return redirect(f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re back to passing tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 8 tests in 0.050s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_response_context_objects_directly">7.12.4. Testing the Response Context Objects Directly</h4>
<div class="paragraph">
<p>We&#8217;ve
got our new view and URL for adding items to existing lists; now we just
need to actually use it in our <em>list.html</em> template. So we open it up to adjust
the form tag&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;form method="POST" action="but what should we put here?"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;oh. To get the URL for adding to the current list, the template needs to
know what list it&#8217;s rendering, as well as what the items are.  We want to
be able to do something like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;form method="POST" action="/lists/{{ list.id }}/add_item"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For that to work, the view will have to pass the list to the template.
Let&#8217;s create a new unit test in <code>ListViewTest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests.py (ch07l041)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_passes_correct_list_to_template(self):
        other_list = List.objects.create()
        correct_list = List.objects.create()
        response = self.client.get(f'/lists/{correct_list.id}/')
        self.assertEqual(response.context['list'], correct_list)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>response.context</code> represents the context we&#8217;re going to pass into
the render function&#8212;&#8203;the Django Test Client puts it on the <code>response</code>
object for us, to help with testing.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'list'</pre>
</div>
</div>
<div class="paragraph">
<p>because we&#8217;re not passing <code>list</code> into the template.  It actually gives us an
opportunity to simplify a little:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    return render(request, 'list.html', {'list': list_})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That, of course, will break one of our old tests, because the template
needed <code>items</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
[...]
AssertionError: False is not true : Couldn't find 'itemey 1' in response</pre>
</div>
</div>
<div class="paragraph">
<p>But we can fix it in <em>list.html</em>, as well as adjusting the form&#8217;s POST action:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch07l043)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;form method="POST" action="/lists/{{ list.id }}/add_item"&gt;  <i class="conum" data-value="1"></i><b>(1)</b>

      [...]

      {% for item in list.item_set.all %}  <i class="conum" data-value="2"></i><b>(2)</b>
        &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;
      {% endfor %}</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>There&#8217;s our new form action.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>.item_set</code> is called
a
    <a href="https://docs.djangoproject.com/en/1.11/topics/db/queries/#following-relationships-backward">reverse lookup</a>.
    It&#8217;s one of Django&#8217;s incredibly useful bits of ORM that lets you look up an
    object&#8217;s related items from a different table&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So that gets the unit tests to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 9 tests in 0.040s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>How about the FTs?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
..
 ---------------------------------------------------------------------
Ran 2 tests in 9.771s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>HOORAY!  Oh, and a quick check on our to-do list:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add unique URLs for each list</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Add URLs for adding a new item to an existing list via POST</span></em></p>
</li>
<li>
<p><em>Refactor away some duplication in urls.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Irritatingly, the Testing Goat is a stickler for tying up loose ends too, so
we&#8217;ve got to do this one final thing.</p>
</div>
<div class="paragraph">
<p>Before we start, we&#8217;ll do a commit&#8212;&#8203;always make sure you&#8217;ve got a commit
of a working state before embarking on a refactor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -am "new URL + view for adding to existing lists. FT passes :-)"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_final_refactor_using_url_includes">7.13. A Final Refactor Using URL includes</h3>
<div class="paragraph">
<p><em>superlists/urls.py</em> is really
meant for URLs that apply to your
entire site.  For URLs that only apply to the <code>lists</code> app, Django encourages us
to use a separate <em>lists/urls.py</em>, to make the app more self-contained.  The
simplest way to make one is to use a copy of the existing <em>urls.py</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp superlists/urls.py lists/</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then we replace three lines in <em>superlists/urls.py</em> with an <code>include</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import include, url
from lists import views as list_views  <i class="conum" data-value="1"></i><b>(1)</b>
from lists import urls as list_urls  <i class="conum" data-value="1"></i><b>(1)</b>

urlpatterns = [
    url(r'^$', list_views.home_page, name='home'),
    url(r'^lists/', include(list_urls)),  <i class="conum" data-value="2"></i><b>(2)</b>
]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>While we&#8217;re at it, we use the <code>import x as y</code> syntax to alias <code>views</code> and
<code>urls</code>.  This is good practice in your top-level <em>urls.py</em>, because it will
let us import <code>views</code> and <code>urls</code> from multiple apps if we want&#8212;&#8203;and indeed we
will need to later on in the book.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s the <code>include</code>. Notice that it can take a part of a URL regex as a
prefix, which will be applied to all the included URLs (this is the bit
where we reduce duplication, as well as giving our code a better
structure).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Back in <em>lists/urls.py</em> we can trim down to only include the latter part
of our three URLs, and none of the other stuff from the parent <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py (ch07l046)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import url
from lists import views

urlpatterns = [
    url(r'^new$', views.new_list, name='new_list'),
    url(r'^(\d+)/$', views.view_list, name='view_list'),
    url(r'^(\d+)/add_item$', views.add_item, name='add_item'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the unit tests to check that everything worked.</p>
</div>
<div class="paragraph">
<p>When I did it, I couldn&#8217;t quite believe I did it correctly on the first go. It
always pays to be skeptical of your own abilities, so I deliberately changed
one of the URLs slightly, just to check if it broke a test. It did. We&#8217;re
covered.</p>
</div>
<div class="paragraph">
<p>Feel free to try it yourself!  Remember to change it back, check that the tests
all pass again, and then do a final commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add lists/urls.py</strong>
$ <strong>git add superlists/urls.py</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Phew. A marathon chapter. But we covered a number of important topics, starting
with test isolation, and then some thinking about design. We covered some rules
of thumb like "YAGNI" and "three strikes then refactor". But, most importantly,
we saw how to adapt an existing site step by step, going from working state to
working state, in order to iterate towards a new design.</p>
</div>
<div class="paragraph">
<p>I&#8217;d say we&#8217;re pretty close to being able to ship this site, as the very first
beta of the superlists website that&#8217;s going to take over the world.  Maybe it
needs a little prettification first&#8230;&#8203;let&#8217;s look at what we need to do to
deploy it in the next couple of chapters.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Some More TDD Philosophy</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Working State to Working State (aka The Testing Goat vs. Refactoring Cat)</dt>
<dd>
<p>    Our
natural urge is often to dive in and fix everything at once&#8230;&#8203;but if
    we&#8217;re not careful, we&#8217;ll end up like Refactoring Cat, in a situation with
    loads of changes to our code and nothing working.  The Testing Goat
    encourages us to take one step at a time, and go from working state to
    working state.</p>
</dd>
<dt class="hdlist1">Split work out into small, achievable tasks</dt>
<dd>
<p>    Sometimes
this means starting with "boring" work rather than diving
    straight in with the fun stuff, but you&#8217;ll have to trust that YOLO-you
    in the parallel universe is probably having a bad time, having broken
    everything, and struggling to get the app working again.</p>
</dd>
<dt class="hdlist1">YAGNI</dt>
<dd>
<p>    You
ain&#8217;t gonna need it!  Avoid the temptation to write code that you
    think <em>might</em> be useful, just because it suggests itself at the time.
    Chances are, you won&#8217;t use it, or you won&#8217;t have anticipated your
    future requirements correctly.  See <a href="#chapter_outside_in">Finishing "My Lists": Outside-In TDD</a> for one
    methodology that helps us avoid this trap.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>Unresolved directive in book.asciidoc - include::part2.harry.asciidoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_prettification">8. Prettification: Layout and Styling, and What to Test About It</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re
starting to think about releasing the first version of our site, but
we&#8217;re a bit embarrassed by how ugly it looks at the moment.  In this
chapter, we&#8217;ll cover some of the basics of styling, including integrating an
HTML/CSS framework called Bootstrap.  We&#8217;ll learn how static files work
in Django, and what we need to do about testing them.</p>
</div>
<div class="sect2">
<h3 id="_what_to_functionally_test_about_layout_and_style">8.1. What to Functionally Test About Layout and Style</h3>
<div class="paragraph">
<p>Our
site is undeniably a bit unattractive at the moment
(<a href="#homepage-looking-ugly">Our home page, looking a little ugly&#8230;&#8203;</a>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you spin up your dev server with <code>manage.py runserver</code>, you
    may run into a database error "table lists_item has no column named
    list_id". You need to update your local database to reflect the changes we
    made in <em>models.py</em>.  Use <code>manage.py migrate</code>.  If it gives you any
    grief about <code>IntegrityErrors</code>, just
    delete<sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnote_12" title="View footnote.">12</a>]</sup>
    the database file and try again.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can&#8217;t be adding to Python&#8217;s reputation for being
<a href="http://grokcode.com/746/dear-python-why-are-you-so-ugly/">ugly</a>,
so let&#8217;s do a tiny bit of polishing.  Here&#8217;s a few things we might want:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A nice large input field for adding new and existing lists</p>
</li>
<li>
<p>A large, attention-grabbing, centered box to put it in</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>How
do we apply TDD to these things?  Most people will tell you you
shouldn&#8217;t test aesthetics, and they&#8217;re right.  It&#8217;s a bit like testing a
constant, in that tests usually wouldn&#8217;t add any value.</p>
</div>
<div id="homepage-looking-ugly" class="imageblock">
<div class="content">
<img src="images/twp2_0801.png" alt="Our home page, looking a little ugly.">
</div>
<div class="title">Figure 13. Our home page, looking a little ugly&#8230;&#8203;</div>
</div>
<div class="paragraph">
<p>But
we can test the implementation of our aesthetics&#8212;&#8203;just enough to
reassure ourselves that things are working.  For example, we&#8217;re going to use
Cascading Style Sheets (CSS) for our styling, and they are loaded as static
files.  Static files can be a bit tricky to configure (especially, as we&#8217;ll see
later, when you move off your own PC and onto a hosting site), so we&#8217;ll want
some kind of simple "smoke test" that the CSS has loaded.  We don&#8217;t have to
test fonts and colours and every single pixel, but we can do a quick check that
the main input box is aligned the way we want it on each page, and that will
give us confidence that the rest of the styling for that page is probably
loaded too.</p>
</div>
<div class="paragraph">
<p>We start with a new test method inside our functional test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch08l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewVisitorTest(LiveServerTestCase):
    [...]


    def test_layout_and_styling(self):
        # Edith goes to the home page
        self.browser.get(self.live_server_url)
        self.browser.set_window_size(1024, 768)

        # She notices the input box is nicely centered
        inputbox = self.browser.find_element_by_id('id_new_item')
        self.assertAlmostEqual(
            inputbox.location['x'] + inputbox.size['width'] / 2,
            512,
            delta=10
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A few new things here.  We start by setting the window size to a fixed
size. We then find the input element, look at its size and location, and
do a little maths to check whether it seems to be positioned in the middle
of the page.  <code>assertAlmostEqual</code> helps us to deal with rounding errors and the
occasional weirdness due to scrollbars and the like, by letting us specify that
we want our arithmetic to work to within plus or minus 10 pixels.</p>
</div>
<div class="paragraph">
<p>If we run the functional tests, we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
.F.
======================================================================
FAIL: test_layout_and_styling (functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 129, in
test_layout_and_styling
    delta=10
AssertionError: 117.0 != 512 within 10 delta

 ---------------------------------------------------------------------
Ran 3 tests in 9.188s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the expected failure.  Still, this kind of FT is easy to get wrong, so
let&#8217;s use a quick-and-dirty "cheat" solution, to check that the FT also passes
when the input box is centered.  We&#8217;ll delete this code again almost as soon
as we&#8217;ve used it to check the FT:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/home.html (ch08l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;form method="POST" action="/lists/new"&gt;
  &lt;p style="text-align: center;"&gt;
    &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
  &lt;/p&gt;
  {% csrf_token %}
&lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That passes, which means the FT works.  Let&#8217;s extend it to make sure that the
input box is also center-aligned on the page for a new list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch08l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # She starts a new list and sees the input is nicely
    # centered there too
    inputbox.send_keys('testing')
    inputbox.send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: testing')
    inputbox = self.browser.find_element_by_id('id_new_item')
    self.assertAlmostEqual(
        inputbox.location['x'] + inputbox.size['width'] / 2,
        512,
        delta=10
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us another test failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  File "...python-tdd-book/functional_tests/tests.py", line 141, in
test_layout_and_styling
    delta=10
AssertionError: 117.0 != 512 within 10 delta</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s commit just the FT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests/tests.py</strong>
$ <strong>git commit -m "first steps of FT for layout + styling"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now it feels like we&#8217;re justified in finding a "proper" solution to our need
for some better styling for our site.  We can back out our hacky
<code>&lt;p style="text-align: center"&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git reset --hard</strong></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>git reset --hard</code> is
the "take off and nuke the site from orbit" Git
    command, so be careful with it&#8212;&#8203;it blows away all your un-committed
    changes. Unlike almost everything else you can do with Git, there&#8217;s no way
    of going back after this one.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_prettification_using_a_css_framework">8.2. Prettification: Using a CSS Framework</h3>
<div class="paragraph">
<p>Design
is hard, and doubly so now that we have to deal with mobile, tablets, and
so forth.  That&#8217;s why many programmers, particularly lazy ones like me, are
turning to CSS frameworks to solve some of those problems for them.  There are
lots of frameworks out there, but one of the earliest and most popular is
Twitter&#8217;s Bootstrap.  Let&#8217;s use that.</p>
</div>
<div class="paragraph">
<p>You can find bootstrap at <a href="http://getbootstrap.com/" class="bare">http://getbootstrap.com/</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll download it and put it in a new folder called <em>static</em> inside the <code>lists</code>
app:<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnote_13" title="View footnote.">13</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>wget -O bootstrap.zip https://github.com/twbs/bootstrap/releases/download/\
v3.3.4/bootstrap-3.3.4-dist.zip</strong>
$ <strong>unzip bootstrap.zip</strong>
$ <strong>mkdir lists/static</strong>
$ <strong>mv bootstrap-3.3.4-dist lists/static/bootstrap</strong>
$ <strong>rm bootstrap.zip</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Bootstrap comes with a plain, uncustomised installation in the <em>dist</em> folder.
We&#8217;re going to use that for now, but you should really never do this for a
real site&#8212;&#8203;vanilla Bootstrap is instantly recognisable, and a big signal
to anyone in the know that you couldn&#8217;t be bothered to style your site. Learn
how to use LESS and change the font, if nothing else!  There is info in
Bootstrap&#8217;s docs, or there&#8217;s a
<a href="http://coding.smashingmagazine.com/2013/03/12/customizing-bootstrap/">good guide here</a>.</p>
</div>
<div class="paragraph">
<p>Our <em>lists</em> folder will end up looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>tree lists</strong>
lists
├── __init__.py
├── __pycache__
│   └── [...]
├── admin.py
├── models.py
├── static
│   └── bootstrap
│       ├── css
│       │   ├── bootstrap.css
│       │   ├── bootstrap.css.map
│       │   ├── bootstrap.min.css
│       │   ├── bootstrap-theme.css
│       │   ├── bootstrap-theme.css.map
│       │   └── bootstrap-theme.min.css
│       ├── fonts
│       │   ├── glyphicons-halflings-regular.eot
│       │   ├── glyphicons-halflings-regular.svg
│       │   ├── glyphicons-halflings-regular.ttf
│       │   ├── glyphicons-halflings-regular.woff
│       │   └── glyphicons-halflings-regular.woff2
│       └── js
│           ├── bootstrap.js
│           ├── bootstrap.min.js
│           └── npm.js
├── templates
│   ├── home.html
│   └── list.html
├── tests.py
├── urls.py
└── views.py</pre>
</div>
</div>
<div class="paragraph">
<p>Look
at the "Getting Started" section of the
<a href="http://bit.ly/2u1lROA">Bootstrap documentation</a>;
you&#8217;ll see it wants our HTML template to include something like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
    &lt;title&gt;Bootstrap 101 Template&lt;/title&gt;
    &lt;!-- Bootstrap --&gt;
    &lt;link href="css/bootstrap.min.css" rel="stylesheet"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello, world!&lt;/h1&gt;
    &lt;script src="http://code.jquery.com/jquery.js"&gt;&lt;/script&gt;
    &lt;script src="js/bootstrap.min.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We already have two HTML templates.  We don&#8217;t want to be adding a whole load
of boilerplate code to each, so now feels like the right time to apply
the "Don&#8217;t repeat yourself" rule, and bring all the common parts together.
Thankfully, the Django template language makes that easy using something
called template inheritance.</p>
</div>
</div>
<div class="sect2">
<h3 id="_django_template_inheritance">8.3. Django Template Inheritance</h3>
<div class="paragraph">
<p>Let&#8217;s
have a little review of what the differences are between <em>home.html</em> and
<em>list.html</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>diff lists/templates/home.html lists/templates/list.html</strong>
&lt;     &lt;h1&gt;Start a new To-Do list&lt;/h1&gt;
&lt;     &lt;form method="POST" action="/lists/new"&gt;
---
&gt;     &lt;h1&gt;Your To-Do list&lt;/h1&gt;
&gt;     &lt;form method="POST" action="/lists/{{ list.id }}/add_item"&gt;
[...]
&gt;     &lt;table id="id_list_table"&gt;
&gt;       {% for item in list.item_set.all %}
&gt;         &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;
&gt;       {% endfor %}
&gt;     &lt;/table&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>They have different header texts, and their forms use different URLs. On top
of that, <em>list.html</em> has the additional <code>&lt;table&gt;</code> element.</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;re clear on what&#8217;s in common and what&#8217;s not, we can make the two
templates inherit from a common "superclass" template.  We&#8217;ll start by
making a copy of <em>home.html</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cp lists/templates/home.html lists/templates/base.html</strong></pre>
</div>
</div>
<div class="paragraph">
<p>We make this into a base template which just contains the common boilerplate,
and mark out the "blocks", places where child templates can customise it:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;To-Do lists&lt;/title&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
    &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
      &lt;input name="item_text" id="id_new_item" placeholder="Enter a to-do item" /&gt;
      {% csrf_token %}
    &lt;/form&gt;
    {% block table %}
    {% endblock %}
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The base template defines a series of areas called "blocks", which will be
places that other templates can hook in and add their own content.  Let&#8217;s
see how that works in practice, by changing <em>home.html</em> so that it "inherits
from" <em>base.html</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% extends 'base.html' %}

{% block header_text %}Start a new To-Do list{% endblock %}

{% block form_action %}/lists/new{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can see that lots of the boilerplate HTML disappears, and we just
concentrate on the bits we want to customise. We do the same for <em>list.html</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% extends 'base.html' %}

{% block header_text %}Your To-Do list{% endblock %}

{% block form_action %}/lists/{{ list.id }}/add_item{% endblock %}

{% block table %}
  &lt;table id="id_list_table"&gt;
    {% for item in list.item_set.all %}
      &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;
    {% endfor %}
  &lt;/table&gt;
{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a refactor of the way our templates work.  We rerun the FTs to make
sure we haven&#8217;t broken anything&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 117.0 != 512 within 10 delta</pre>
</div>
</div>
<div class="paragraph">
<p>Sure
enough, they&#8217;re still getting to exactly where they were before.  That&#8217;s
worthy of a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff -b</strong>
# the -b means ignore whitespace, useful since we've changed some html indenting
$ <strong>git status</strong>
$ <strong>git add lists/templates</strong> # leave static, for now
$ <strong>git commit -m "refactor templates to use a base template"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_integrating_bootstrap">8.4. Integrating Bootstrap</h3>
<div class="paragraph">
<p>Now
it&#8217;s much easier to integrate the boilerplate code that Bootstrap wants&#8212;&#8203;we
won&#8217;t add the JavaScript yet, just the CSS:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch08l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
    &lt;title&gt;To-Do lists&lt;/title&gt;
    &lt;link href="css/bootstrap.min.css" rel="stylesheet"&gt;
  &lt;/head&gt;
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rows_and_columns">8.4.1. Rows and Columns</h4>
<div class="paragraph">
<p>Finally, let&#8217;s actually use some of the Bootstrap magic! You&#8217;ll have to read
the documentation yourself, but we should be able to use a combination
of the grid system and the <code>text-center</code> class to get what we want:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch08l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;body&gt;
    &lt;div class="container"&gt;

      &lt;div class="row"&gt;
        &lt;div class="col-md-6 col-md-offset-3"&gt;
          &lt;div class="text-center"&gt;
            &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
            &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
              &lt;input name="item_text" id="id_new_item"
                     placeholder="Enter a to-do item" /&gt;
              {% csrf_token %}
            &lt;/form&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="row"&gt;
        &lt;div class="col-md-6 col-md-offset-3"&gt;
          {% block table %}
          {% endblock %}
        &lt;/div&gt;
      &lt;/div&gt;

    &lt;/div&gt;
  &lt;/body&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(If you&#8217;ve never seen an HTML tag broken up over several lines, that <code>&lt;input&gt;</code>
may be a little shocking. It is definitely valid, but you don&#8217;t have to use
it if you find it offensive. ;)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Take the time to browse through the <a href="http://getbootstrap.com/">Bootstrap
    documentation</a>, if you&#8217;ve never seen it before.  It&#8217;s a shopping trolley
    brimming full of useful tools to use in your site.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Does that work?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 117.0 != 512 within 10 delta</pre>
</div>
</div>
<div class="paragraph">
<p>Hmm. No.  Why isn&#8217;t our CSS loading?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_static_files_in_django">8.5. Static Files in Django</h3>
<div class="paragraph">
<p>Django, and indeed any web server, needs to know two things to deal with static
files:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>How to tell when a URL request is for a static file, as opposed to for some
HTML that&#8217;s going to be served via a view function</p>
</li>
<li>
<p>Where to find the static file the user wants</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In other words, static files are a mapping from URLs to files on disk.</p>
</div>
<div class="paragraph">
<p>For
item 1, Django lets us define a URL
"prefix" to say that any URLs which
start with that prefix should be treated as requests for static files.  By
default, the prefix is <span class="keep-together"><em>/static/</em></span>. It&#8217;s defined in <em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.11/howto/static-files/

STATIC_URL = '/static/'</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The
rest of the settings we will add to this section are all to do with item 2:
finding the actual static files on disk.</p>
</div>
<div class="paragraph">
<p>While we&#8217;re using the Django development server (<code>manage.py runserver</code>), we can
rely on Django to magically find static files for us&#8212;&#8203;it&#8217;ll just look in any
subfolder of one of our apps called <em>static</em>.</p>
</div>
<div class="paragraph">
<p>You now see why we put all the Bootstrap static files into
<em>lists/static</em>.  So why are they not working at the moment?  It&#8217;s because we&#8217;re
not using the <code>/static/</code> URL prefix.  Have another look at the link to the CSS
in <em>base.html</em>:</p>
</div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/templates/base.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;link href="css/bootstrap.min.css" rel="stylesheet"&gt;</code></pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>To get this to work, we need to change it to:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When <code>runserver</code> sees the request, it knows that it&#8217;s for a static file because
it begins with <code>/static/</code>.  It then tries to find a file called
<em>bootstrap/css/bootstrap.min.css</em>, looking in each of our app folders for
subfolders called <em>static</em>, and it should find it at
<em>lists/static/bootstrap/css/bootstrap.min.css</em>.</p>
</div>
<div class="paragraph">
<p>So if you take a look manually, you should see it works, as in
<a href="#list-page-centered">Our site starts to look a little better&#8230;&#8203;</a>.</p>
</div>
<div id="list-page-centered" class="imageblock">
<div class="content">
<img src="images/twp2_0802.png" alt="The list page with centered header.">
</div>
<div class="title">Figure 14. Our site starts to look a little better&#8230;&#8203;</div>
</div>
<div class="sect3">
<h4 id="_switching_to_staticliveservertestcase">8.5.1. Switching to StaticLiveServerTestCase</h4>
<div class="paragraph">
<p>If
you run the FT though, it won&#8217;t pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 117.0 != 512 within 10 delta</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s because, although <code>runserver</code> automagically finds static files,
<code>LiveServerTestCase</code> doesn&#8217;t.  Never fear, though: the Django developers have
made a more magical test class called <code>StaticLiveServerTestCase</code> (see
<a href="http://bit.ly/Suv4Ip">the
docs</a>).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s switch to that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -1,14 +1,14 @@
-from django.test import LiveServerTestCase
+from django.contrib.staticfiles.testing import StaticLiveServerTestCase
 from selenium import webdriver
 from selenium.common.exceptions import WebDriverException
 from selenium.webdriver.common.keys import Keys
 import time

 MAX_WAIT = 10


-class NewVisitorTest(LiveServerTestCase):
+class NewVisitorTest(StaticLiveServerTestCase):

     def setUp(self):</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And
now it will find the new CSS, which will get our test to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
Creating test database for alias 'default'...
...
 ---------------------------------------------------------------------
Ran 3 tests in 9.764s</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At
this point, Windows users may see some (harmless, but distracting)
    error messages that say <code>socket.error: [WinError 10054] An existing
    connection was forcibly closed by the remote host</code>.  Add a
    <code>self.browser.refresh()</code> just before the <code>self.browser.quit()</code> in
    <code>tearDown</code> to get rid of them.  The issue is being tracked in a
    <a href="https://code.djangoproject.com/ticket/21227">bug on the Django tracker</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hooray!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_bootstrap_components_to_improve_the_look_of_the_site">8.6. Using Bootstrap Components to Improve the Look of the Site</h3>
<div class="paragraph">
<p>Let&#8217;s
see if we can do even better, using some of the other tools in
Bootstrap&#8217;s panoply.</p>
</div>
<div class="sect3">
<h4 id="_jumbotron">8.6.1. Jumbotron!</h4>
<div class="paragraph">
<p>Bootstrap
has a class called <code>jumbotron</code> for things that are meant to be
particularly prominent on the page.  Let&#8217;s use that to embiggen the main
page header and the input form:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch08l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;div class="col-md-6 col-md-offset-3 jumbotron"&gt;
      &lt;div class="text-center"&gt;
        &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
        &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
          [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When hacking about with design and layout, it&#8217;s best to have a window open
    that we can hit refresh on, frequently.  Use <code>python manage.py runserver</code>
    to spin up the dev server, and then browse to <em>http://localhost:8000</em> to
    see your work as we go.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_large_inputs">8.6.2. Large Inputs</h4>
<div class="paragraph">
<p>The
jumbotron is a good start, but now the input box has tiny text compared to
everything else.  Thankfully, Bootstrap&#8217;s form control classes offer an option
to set an input to be "large":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch08l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;input name="item_text" id="id_new_item"
           class="form-control input-lg"
           placeholder="Enter a to-do item" /&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_table_styling">8.6.3. Table Styling</h4>
<div class="paragraph">
<p>The
table text also looks too small compared to the rest of the page now.
Adding the Bootstrap <code>table</code> class improves things:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch08l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;table id="id_list_table" class="table"&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_our_own_css">8.7. Using Our Own CSS</h3>
<div class="paragraph">
<p>Finally
I&#8217;d like to just offset the input from the title text slightly. There&#8217;s
no ready-made fix for that in Bootstrap, so we&#8217;ll make one ourselves.  That
will require specifying our own CSS file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  [...]
    &lt;title&gt;To-Do lists&lt;/title&gt;
    &lt;link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet"&gt;
    &lt;link href="/static/base.css" rel="stylesheet"&gt;
  &lt;/head&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We create a new file at <em>lists/static/base.css</em>, with our new CSS rule.
We&#8217;ll use the <code>id</code> of the input element, <code>id_new_item</code>, to find it and give it
some styling:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/base.css</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">#id_new_item {
    margin-top: 2ex;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>All that took me a few goes, but I&#8217;m reasonably happy with it now
(<a href="#homepage-looking-better">The lists page, with all big chunks&#8230;&#8203;</a>).</p>
</div>
<div class="paragraph">
<p>If you want to go further with customising Bootstrap, you need to get into
compiling LESS. I <em>definitely</em> recommend taking the time to do that some
day. LESS and other pseudo-CSS-alikes like Sass are a great improvement on
plain old CSS, and a useful tool even if you don&#8217;t use Bootstrap. I won&#8217;t cover
it in this book, but you can find resources on the internets.
<a href="http://coding.smashingmagazine.com/2013/03/12/customizing-bootstrap/">Here&#8217;s one</a>,
for example.</p>
</div>
<div class="paragraph">
<p>A last run of the functional tests, to see if everything still works OK:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
...
 ---------------------------------------------------------------------
Ran 3 tests in 10.084s

OK</pre>
</div>
</div>
<div id="homepage-looking-better" class="imageblock">
<div class="content">
<img src="images/twp2_0803.png" alt="Screenshot of lists page with big styling.">
</div>
<div class="title">Figure 15. The lists page, with all big chunks&#8230;&#8203;</div>
</div>
<div class="paragraph pagebreak-before">
<p>That&#8217;s it! Definitely time for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # changes tests.py, base.html, list.html + untracked lists/static
$ <strong>git add .</strong>
$ <strong>git status</strong> # will now show all the bootstrap additions
$ <strong>git commit -m "Use Bootstrap to improve layout"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_we_glossed_over_collectstatic_and_other_static_directories">8.8. What We Glossed Over: collectstatic and Other Static Directories</h3>
<div class="paragraph">
<p>We
saw earlier that the Django dev server will magically find all your static
files inside app folders, and serve them for you. That&#8217;s fine during
development, but when you&#8217;re running on a real web server, you don&#8217;t want
Django serving your static content&#8212;&#8203;using Python to serve raw files is
slow and inefficient, and a web server like Apache or Nginx can do this all for
you. You might even decide to upload all your static files to a CDN, instead
of hosting them yourself.</p>
</div>
<div class="paragraph">
<p>For these reasons, you want to be able to gather up all your static files from
inside their various app folders, and copy them into a single location, ready
for deployment. This is what the <code>collectstatic</code> command is for.</p>
</div>
<div class="paragraph">
<p>The destination, the place where the collected static files go, is defined in
<em>settings.py</em> as <code>STATIC_ROOT</code>. In the next chapter we&#8217;ll be doing some
deployment, so let&#8217;s actually experiment with that now.  A common and
straightforward place to put it is in a folder called "static" in the root
of our repo:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>.
├── db.sqlite3
├── functional_tests/
├── lists/
├── manage.py
├── static/
├── superlists/
└── virtualenv/</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Here&#8217;s a neat way of specifying that folder, making it relative to the location
of the project base directory:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch08l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"># Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.11/howto/static-files/

STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Take a look at the top of the settings file, and you&#8217;ll see how that <code>BASE_DIR</code>
variable is helpfully defined for us, using <code>__file__</code> (which itself is a
really, really useful Python built-in<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnote_14" title="View footnote.">14</a>]</sup>).</p>
</div>
<div class="paragraph">
<p>Anyway, let&#8217;s try running <code>collectstatic</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py collectstatic</strong>
[...]
Copying '...python-tdd-book/lists/static/bootstrap/css/bootstrap-theme.css'
Copying '...python-tdd-book/lists/static/bootstrap/css/bootstrap.min.css'

76 static files copied to '...python-tdd-book/static'.</pre>
</div>
</div>
<div class="paragraph">
<p>And if we look in <em>./static</em>, we&#8217;ll find all our CSS files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>tree static/</strong>
static/
├── admin
│   ├── css
│   │   ├── base.css
[...]
│               └── xregexp.min.js
├── base.css
└── bootstrap
    ├── css
    │   ├── bootstrap.css
    │   ├── [...]
    │   └── bootstrap-theme.min.css
    ├── fonts
    │   ├── glyphicons-halflings-regular.eot
    │   ├── [...]
    │   └── glyphicons-halflings-regular.woff2
    └── js
        ├── bootstrap.js
        ├── bootstrap.min.js
        └── npm.js


14 directories, 76 files</pre>
</div>
</div>
<div class="paragraph">
<p><code>collectstatic</code> has also picked up all the CSS for the admin site. It&#8217;s one of
Django&#8217;s powerful features, and we&#8217;ll find out all about it one day, but we&#8217;re
not ready to use that yet, so let&#8217;s disable it for now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">INSTALLED_APPS = [
    #'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'lists',
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And we try again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm -rf static/</strong>
$ <strong>python manage.py collectstatic --noinput</strong>
Copying '...python-tdd-book/lists/static/base.css'
[...]
Copying '...python-tdd-book/lists/static/bootstrap/css/bootstrap-theme.css'
Copying '...python-tdd-book/lists/static/bootstrap/css/bootstrap.min.css'


15 static files copied to '...python-tdd-book/static'.</pre>
</div>
</div>
<div class="paragraph">
<p>Much better.</p>
</div>
<div class="paragraph">
<p>Now we know how to collect all the static files into a single folder,
where it&#8217;s easy for a web server to find them. We&#8217;ll find out all about that,
including how to test it, in the next chapter!</p>
</div>
<div class="paragraph">
<p>For
now let&#8217;s save our changes to <em>settings.py</em>.  We&#8217;ll also add the top-level
static folder to our gitignore, since it will only contain copies of files
we actually keep in individual apps' static folders.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong> # should show changes in settings.py plus the new directory*
$ <strong>echo /static &gt;&gt; .gitignore</strong>
$ <strong>git commit -am "set STATIC_ROOT in settings and disable admin"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_few_things_that_didn_t_make_it">8.9. A Few Things That Didn&#8217;t Make It</h3>
<div class="paragraph">
<p>Inevitably this was only a whirlwind tour of styling and CSS, and there were
several topics that I&#8217;d considered covering that didn&#8217;t make it.
Here are a few candidates for further study:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Customising bootstrap with LESS or SASS</p>
</li>
<li>
<p>The <code>{% static %}</code> template tag, for more DRY and fewer hardcoded URLs</p>
</li>
<li>
<p>Client-side packaging tools, like <code>npm</code> and <code>bower</code></p>
</li>
</ul>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Recap: On Testing Design and Layout</div>
<div class="paragraph">
<p>The
short answer is: you shouldn&#8217;t write tests for design and layout <em>per se</em>.
It&#8217;s too much like testing a constant, and the tests you write are often
brittle.</p>
</div>
<div class="paragraph">
<p>With that said, the <em>implementation</em> of design and layout involves something
quite tricky: CSS and static files.   As a result, it is valuable to have some
kind of minimal "smoke test" which checks that your static files and CSS are
working.  As we&#8217;ll see in the next chapter, it can help pick up problems when
you deploy your code to <span class="keep-together">production</span>.</p>
</div>
<div class="paragraph">
<p>Similarly, if a particular piece of styling required a lot of client-side
JavaScript code to get it to work (dynamic resizing is one I&#8217;ve spent a bit
of time on), you&#8217;ll definitely want some tests for that.</p>
</div>
<div class="paragraph">
<p>Try to write the minimal tests that will give you confidence that your design
and layout is working, without testing <em>what</em> it actually is.  Aim to leave
yourself in a position where you can freely make changes to the design and
layout, without having to go back and adjust tests all the time.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_manual_deployment">9. Testing Deployment Using a Staging Site</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Is all fun and game until you are need of put it in production.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="http://bit.ly/2uhCXnH">Devops Borat</a>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s
time to deploy the first version of our site and make it public.  They say
that if you wait until you feel ready to ship, then you&#8217;ve waited too long.</p>
</div>
<div class="paragraph">
<p>Is our site usable?  Is it better than nothing? Can we make lists on it? Yes,
yes, yes.</p>
</div>
<div class="paragraph">
<p>No, you can&#8217;t log in yet.  No, you can&#8217;t mark tasks as completed.  But do we
really need any of that stuff? Not really&#8212;&#8203;and you can never be sure what
your users are <em>actually</em> going to do with your site once they get their
hands on it. We think our users want to use the site for to-do lists, but maybe
they actually want to use it to make "top 10 best fly-fishing spots" lists, for
which you don&#8217;t need any kind of &#8220;mark completed&#8221; function. We won&#8217;t know
until we put it out there.</p>
</div>
<div class="paragraph">
<p>In this chapter we&#8217;re going to go through and actually deploy our site to a
real, live web server.</p>
</div>
<div class="paragraph">
<p>You might be tempted to skip this chapter&#8212;&#8203;there&#8217;s lots of daunting stuff
in it, and maybe you think this isn&#8217;t what you signed up for. But I <em>strongly</em>
urge you to give it a go.  This is one of the sections of the book I&#8217;m most
pleased with, and it&#8217;s one that people often write to me saying they were
really glad they stuck through it.</p>
</div>
<div class="paragraph">
<p>If you&#8217;ve never done a server deployment before, it will demystify a whole
world for you, and there&#8217;s nothing like the feeling of seeing your site live on
the actual internet. Give it a buzzword name like "DevOps" if that&#8217;s what it
takes to convince you it&#8217;s worth it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why not ping me a note once your site is live on the web, and send me
    the URL? It always gives me a warm and fuzzy feeling&#8230;&#8203;
    <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_tdd_and_the_danger_areas_of_deployment">9.1. TDD and the Danger Areas of Deployment</h3>
<div class="paragraph">
<p>Deploying
a site to a live web server can be a tricky topic.  Oft-heard is the
forlorn cry <em>"but it works on my machine!"</em></p>
</div>
<div class="paragraph">
<p>Some
of the danger areas of deployment include:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Networking</dt>
<dd>
<p>Once we&#8217;re off our own machine, networking issues come in: making
sure the DNS service is routing our domain to the correct IP address
for our server, making sure our server is configured to listen to
traffic coming in from the world, making sure it&#8217;s using the right
ports, and making sure any firewalls in the way are configured to let
traffic through.</p>
</dd>
<dt class="hdlist1">Dependencies</dt>
<dd>
<p>We need to make sure that the packages our software relies on (Python,
Django, and so on) are installed on the server, and have the correct
versions.</p>
</dd>
<dt class="hdlist1">The database</dt>
<dd>
<p>There can be permissions and path issues, and we need to be careful about
preserving data between deploys.</p>
</dd>
<dt class="hdlist1">Static files (CSS, JavaScript, images, etc.)</dt>
<dd>
<p>Web servers usually need special
configuration for serving these.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>But there are solutions to all of these.  In order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using a <em>staging site</em>, on the same infrastructure as the production site,
can help us test out our deployments and get things right before we go to
the "real" site.</p>
</li>
<li>
<p>We can also <em>run our functional tests against the staging site</em>. That will
reassure us that we have the right code and packages on the server, and
since we now have a "smoke test" for our site layout, we&#8217;ll know that the
CSS is loaded correctly.</p>
</li>
<li>
<p>Just
like on our own PC, a <em>virtualenv</em> is useful on the server for
managing packages and dependencies when you might be running more than one
Python <span class="keep-together">application</span>.</p>
</li>
</ul>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>And
finally, <em>automation, automation, automation</em>.  By using an automated
script to deploy new versions, and by using the same script to deploy to
staging <span class="keep-together">and production</span>, we can reassure ourselves that staging is as much
like live as
<span class="keep-together">possible</span>.<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnote_15" title="View footnote.">15</a>]</sup></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Over the next few pages I&#8217;m going to go through <em>a</em> deployment procedure.  It
isn&#8217;t meant to be the <em>perfect</em> deployment procedure, so please don&#8217;t take
it as being best practice, or a recommendation&#8212;&#8203;it&#8217;s meant to be an
illustration, to show the kinds of issues involved in deployment and where
testing fits in.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Deployment Chapters Overview</div>
<div class="paragraph">
<p>There&#8217;s lots of stuff in the next three chapters, so here&#8217;s an overview to help you
keep your bearings:</p>
</div>
<div class="paragraph">
<p><strong>This chapter: getting a basic manual deployment up and running</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adapt our FTs so they can run against a staging server.</p>
</li>
<li>
<p>Spin up a server, install all the required software on it, and point our
staging and live domains at it.</p>
</li>
<li>
<p>Upload our code to the server using Git.</p>
</li>
<li>
<p>Try and get a quick-and-dirty version of our site running on the staging domain
using the Django dev server.</p>
</li>
<li>
<p>Set up a virtualenv on the server and make sure the database and
static files are working.</p>
</li>
<li>
<p>As we go, we&#8217;ll keep running our FT, to tell us what&#8217;s working and what&#8217;s
not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Next chapter: moving to a production-ready config</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Move from our quick-and-dirty version to a production-ready configuration.</p>
</li>
<li>
<p>Stop using the Django dev server, use Nginx and Gunicorn as web servers,
configure efficient static file serving, set our app to start automatically
on boot with Systemd.</p>
</li>
<li>
<p>Security: Use environment variables to set <code>DEBUG</code> to <code>False</code>, change the
<code>SECRET_KEY</code>, and so on</p>
</li>
</ul>
</div>
<div class="paragraph pagebreak-before">
<p><strong>Third deployment chapter: automating the deployment</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Once we have a working config, we&#8217;ll write a script to automate the process
we&#8217;ve just been through manually, so that we can deploy our site
automatically in future.</p>
</li>
<li>
<p>Finally we&#8217;ll use this script to deploy the production version of our site
on its real domain.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_as_always_start_with_a_test">9.2. As Always, Start with a Test</h3>
<div class="paragraph">
<p>Let&#8217;s
adapt our functional tests slightly so that it can be run against
a staging site, instead of the local dev server. We&#8217;ll do it by checking for an
environment variable called <code>STAGING_SERVER</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch08l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import os
[...]

class NewVisitorTest(StaticLiveServerTestCase):

    def setUp(self):
        self.browser = webdriver.Firefox()
        staging_server = os.environ.get('STAGING_SERVER')  <i class="conum" data-value="1"></i><b>(1)</b>
        if staging_server:
            self.live_server_url = 'http://' + staging_server  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Do you remember I said that <code>LiveServerTestCase</code> had certain limitations?
Well, one is that it always assumes you want to use its own test server, which
it makes available at <code>self.live_server_url</code>.  I still want to be able to do
that sometimes, but I also want to be able to selectively tell it not to
bother, and to use a real server instead.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The way I decided to do it is using an environment variable called
<code>STAGING_SERVER</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s the hack: we replace <code>self.live_server_url</code> with the address of
our "real" server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We test that said hack hasn&#8217;t broken anything by running the functional
tests <span class="keep-together">"normally"</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
Ran 3 tests in 8.544s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now we can try them against our staging server URL.  I&#8217;m planning to
host my staging server at <em>superlists-staging.ottg.eu</em>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A clarification: in this chapter, we run tests <em>against</em> our staging
    server, not <em>on</em> our staging server.  So we still run the tests from our
    own laptop, but they target the site that&#8217;s running on the server.
</td>
</tr>
</table>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

EEE
======================================================================
ERROR: test_can_start_a_list_for_one_user
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 41, in
test_can_start_a_list_for_one_user
    self.browser.get(self.live_server_url)
[...]
selenium.common.exceptions.WebDriverException: Message: Reached error page: abo
ut:neterror?e=connectionFailure&amp;u=http%3A//superlists-staging.ottg.eu/&amp;c=UTF-8&amp;
f=regular&amp;d=Firefox%20can%27t%20establish%20a%20connection%20to%20the%20server%
20at%20superlists-staging.ottg.eu.


======================================================================
ERROR: test_layout_and_styling (functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 126, in
test_layout_and_styling
[...]
selenium.common.exceptions.WebDriverException: Message: Reached error page: abo
[...]


======================================================================
ERROR: test_multiple_users_can_start_lists_at_different_urls
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 80, in
test_multiple_users_can_start_lists_at_different_urls
[...]
selenium.common.exceptions.WebDriverException: Message: Reached error page: abo
[...]

Ran 3 tests in 10.518s

FAILED (errors=3)</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If, on Windows, you see an error saying something like
    "STAGING_SERVER is not recognized as a command", it&#8217;s probably because
    you&#8217;re not using Git-Bash.  Take another look at the
    &#x201c;<a href="#pre-requisites">Prerequisites and Assumptions</a>&#x201d; section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can see that all the tests are failing, as expected, since I haven&#8217;t
actually set up my domain yet. Selenium reports that Firefox is seeing an
error and "cannot establish connection to the server" (depending on your
registrar, you might see content from its default landing page instead).</p>
</div>
<div class="paragraph">
<p>The
FT seems to be testing the right things though, so let&#8217;s commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong> # should show changes to functional_tests.py
$ <strong>git commit -am "Hack FT runner to be able to test staging"</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don&#8217;t use <code>export</code> to set the <em>STAGING_SERVER</em> environment variable;
    otherwise, all your subsequent test runs in that terminal will be against
    staging (and that can be very confusing if you&#8217;re not expecting it).
    Setting it explicitly inline each time you run the FTs is best.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_a_domain_name">9.3. Getting a Domain Name</h3>
<div class="paragraph">
<p>We&#8217;re
going to need a couple of domain names at this point in the book&#8212;&#8203;they
can both be subdomains of a single domain.  I&#8217;m going to use
<em>superlists.ottg.eu</em> and <em>superlists-staging.ottg.eu</em>.
If you don&#8217;t already own a domain, this is the time to register one! Again,
this is something I really want you to <em>actually</em> do.  If you&#8217;ve never
registered a domain before, just pick any old registrar and buy a cheap one&#8212;&#8203;it
should only cost you $5 or so, and you can even find free ones.
I promise seeing your site on a "real" website will be a thrill.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manually_provisioning_a_server_to_host_our_site">9.4. Manually Provisioning a Server to Host Our Site</h3>
<div class="paragraph">
<p>We
can separate out "deployment" into two tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Provisioning</em> a new server to be able to host the code</p>
</li>
<li>
<p><em>Deploying</em> a new version of the code to an existing server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some people like to use a brand new server for every deployment&#8212;&#8203;it&#8217;s what we
do at PythonAnywhere.  That&#8217;s only necessary for larger, more complex sites
though, or major changes to an existing site. For a simple site like ours, it
makes sense to separate the two tasks.  And, although we eventually want both
to be completely automated, we can probably live with a manual provisioning
system for now.</p>
</div>
<div class="paragraph">
<p>As you go through this chapter, you should be aware that provisioning is
something that varies a lot, and that as a result there are few universal
best practices for deployment.  So, rather than trying to remember the
specifics of what I&#8217;m doing here, you should be trying to understand the
rationale, so that you can apply the same kind of thinking in the
specific future circumstances you encounter.</p>
</div>
<div class="sect3">
<h4 id="_choosing_where_to_host_our_site">9.4.1. Choosing Where to Host Our Site</h4>
<div class="paragraph">
<p>There
are loads of different solutions out there these days, but they broadly
fall into two camps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running your own (possibly virtual) server</p>
</li>
<li>
<p>Using a Platform-As-A-Service (PaaS)
offering like Heroku, OpenShift, or <span class="keep-together">PythonAnywhere</span></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Particularly
for small sites, a PaaS offers a lot of advantages, and I would
definitely recommend looking into them.  We&#8217;re not going to use a PaaS in this
book however, for several reasons.  Firstly, I have a conflict of interest, in
that I think PythonAnywhere is the best, but then again I would say that
because I work there.  Secondly, all the PaaS offerings are quite different,
and the procedures to deploy to each vary a lot&#8212;&#8203;learning about one doesn&#8217;t
necessarily tell you about the others. Any one of them might radically change their process or business model by the time you get to read this book.</p>
</div>
<div class="paragraph">
<p>Instead, we&#8217;ll learn just a tiny bit of good old-fashioned server admin,
including SSH and web server config.  They&#8217;re unlikely to ever go away, and
knowing a bit about them will get you some respect from all the grizzled
dinosaurs out there.</p>
</div>
<div class="paragraph">
<p>What I have done is to try to set up a server in such a way that&#8217;s a bit
like the environment you get from a PaaS, so you should be able to apply the
lessons we learn in the deployment section, no matter what provisioning
solution you choose.</p>
</div>
</div>
<div class="sect3">
<h4 id="_spinning_up_a_server">9.4.2. Spinning Up a Server</h4>
<div class="paragraph">
<p>I&#8217;m not going to dictate how you do this&#8212;&#8203;whether you choose Amazon AWS,
Rackspace, Digital Ocean, your own server in your own data centre or a
Raspberry Pi in a cupboard under the stairs, any solution should be fine, as
long as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Your server is running Ubuntu 18.04 (aka "Bionic/LTS").</p>
</li>
<li>
<p>You have root access to it.</p>
</li>
<li>
<p>It&#8217;s on the public internet.</p>
</li>
<li>
<p>You can SSH into it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I&#8217;m recommending Ubuntu as a distro because it&#8217;s easy to get Python 3.6 on it
and it has some specific ways of configuring Nginx, which I&#8217;m going to make use
of next.  If you know what you&#8217;re doing, you can probably get away with using
something else, but you&#8217;re on your own.</p>
</div>
<div class="paragraph">
<p>If
you&#8217;ve never started a Linux server before and you have absolutely no idea
where to start, I wrote a
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/blob/master/server-quickstart.md">very brief guide on GitHub</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some
    people get to this chapter, and are tempted to skip the domain bit,
    and the "getting a real server" bit, and just use a VM on their own PC.
    Don&#8217;t do this. It&#8217;s <em>not</em> the same, and you&#8217;ll have more difficulty
    following the instructions, which are complicated enough as it is.  If
    you&#8217;re worried about cost, have a look at the link above for free options.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_user_accounts_ssh_and_privileges">9.4.3. User Accounts, SSH, and Privileges</h4>
<div class="paragraph">
<p>In these instructions, I&#8217;m assuming that you have a nonroot user account set
up that has "sudo" privileges, so whenever we need to do something that
requires root access, we use sudo, and I&#8217;m explicit about that in the various
instructions that follow.</p>
</div>
<div class="paragraph">
<p>My user is called "elspeth", but you can call yours whatever you like!  Just
remember to substitute it in all the places I&#8217;ve hardcoded it below.
See the guide linked above if you need tips on creating a sudo user.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installing_python_3_6">9.4.4. Installing Python 3.6</h4>
<div class="paragraph">
<p>As
of the "Bionic Beaver" release, Python 3.6 is now available as standard on
Ubuntu.  Here&#8217;s how we install it (and make sure that the virtualenv tools are
available too):</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo apt update</strong>
elspeth@server:$ <strong>sudo apt install python3 python3-venv</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Look out for that <code>elspeth@server</code> in the command-line listings in this
    chapter. It indicates commands that must be run on the server, as opposed
    to commands you run on your own PC.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we&#8217;ll just make sure Git is installed too.</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo apt install git</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_domains_for_staging_and_live">9.4.5. Configuring Domains for Staging and Live</h4>
<div class="paragraph">
<p>We don&#8217;t want to be messing about with IP addresses all the time, so we should
point our staging and live domains to the server. At my registrar, the control
screens looked a bit like <a href="#registrar-control-screens">Domain setup</a>.</p>
</div>
<div id="registrar-control-screens" class="imageblock">
<div class="content">
<img src="images/twp2_0902.png" alt="Registrar control screens for two domains">
</div>
<div class="title">Figure 16. Domain setup</div>
</div>
<div class="paragraph">
<p>In
the DNS system, pointing a domain at a specific IP address is called an
"A-Record".  All registrars are slightly different, but a bit of clicking
around should get you to the right screen in yours.  You&#8217;ll need two A-records:
one for the staging address and one for the live one.  No need to worry about
any other type of record.</p>
</div>
<div class="paragraph">
<p>DNS records take some time to "propagate" around the world (it&#8217;s controlled
by a setting called "TTL", Time To Live), so once you&#8217;ve set up your A-record,
you can check its progress on a "propagation checking" service like this one: <a href="https://www.whatsmydns.net/#A/superlists-staging.ottg.eu" class="bare">https://www.whatsmydns.net/#A/superlists-staging.ottg.eu</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_our_code_manually">9.5. Deploying Our Code Manually</h3>
<div class="paragraph">
<p>The
next step is to get a basic copy of the staging site up and running.
As we do so, we&#8217;re starting to move into doing "deployment" rather than
provisioning, so we should be thinking about how we can automate the process as
we go.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One rule of thumb for distinguishing provisioning from deployment is
    that you tend to need root permissions for the former, but you don&#8217;t for
    the latter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need a directory for the source to live in.  We&#8217;ll put it somewhere
in the home folder of our nonroot user; in my case it would be at
<em>/home/elspeth</em> (this is likely to be the setup on any shared hosting system,
but you should always run your web apps as a nonroot user, in any case). I&#8217;m
going to set up my sites like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>/home/elspeth
├── sites
│   ├── www.live.my-website.com
│   │    ├── db.sqlite3
│   │    ├── manage.py
│   │    ├── [etc...]
│   │    ├── static
│   │    │    ├── base.css
│   │    │    ├── [etc...]
│   │    └── virtualenv
│   │         ├── lib
│   │         ├── [etc...]
│   │
│   ├── www.staging.my-website.com
│   │    ├── db.sqlite3
│   │    ├── [etc...]</pre>
</div>
</div>
<div class="paragraph">
<p>Each site (staging, live, or any other website) has its own folder, which
will contain a checkout of the source code (managed by git), along with the
database, static files and virtualenv (managed separately).</p>
</div>
<div class="paragraph">
<p>To get our code onto the server, we&#8217;ll use Git and go via one of the
code-sharing sites.  If you haven&#8217;t already, push your code up to GitHub,
BitBucket, GitLab, or similar.  They all have excellent instructions for
beginners on how to do that.</p>
</div>
<div class="paragraph">
<p>Here
are some Bash commands that will set this all up.</p>
</div>
<div class="listingblock server-commands small-code">
<div class="content">
<pre>elspeth@server:$ <strong>export SITENAME=superlists-staging.ottg.eu</strong>
# you should replace the URL in the next line with the URL for your own repo
elspeth@server:$ <strong>git clone https://github.com/hjwp/book-example.git ~/sites/$SITENAME</strong>
Resolving deltas: 100% [...]</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>export</code> command sets up a "local variable" in Bash; a bit like the
inline environment variable we used earlier, but it&#8217;s available to all
subsequent commands in that same shell.</p>
</li>
<li>
<p><code>git clone</code> takes your repo URL as its first argument, and an (optional)
destination as its second argument.  That will create the target folder
for us and get our code into the right place in one go.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Bash variable defined using <code>export</code> only lasts as long as that console
    session. If you log out of the server and log back in again, you&#8217;ll need to
    redefine it. It&#8217;s devious because Bash won&#8217;t error, it will just substitute
    the empty string for the variable, which will lead to weird results&#8230;&#8203;if in
    doubt, do a quick <strong><code>echo $SITENAME</code></strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we&#8217;ve got the code, let&#8217;s just try running the dev server, and
see how far we get:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>cd ~/sites/$SITENAME</strong>
$ <strong>python3.6 manage.py runserver</strong>
Traceback (most recent call last):
  File "manage.py", line 8, in &lt;module&gt;
    from django.core.management import execute_from_command_line
ModuleNotFoundError: No module named <em>django</em>
[...]
Couldn't import Django. Are you sure it's installed and available on your
PYTHONPATH environment variable? Did you forget to activate a virtual
environment?</pre>
</div>
</div>
<div class="paragraph">
<p>Ah. Django isn&#8217;t installed on the server.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_virtualenv_on_the_server_using_requirements_txt">9.5.1. Creating a Virtualenv on the Server Using requirements.txt</h4>
<div class="paragraph">
<p>Just
like on our own machine, a virtualenv is useful on the server to make
sure we have full control over the packages installed for a particular
project.  It can also let us run different projects with different (or
conflicting) dependencies on the same server.</p>
</div>
<div class="paragraph">
<p>To reproduce our local virtualenv, we can "save" the list of packages we&#8217;re
using by creating a <em>requirements.txt</em> file. Back on our own machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo "django==1.11.13" &gt; requirements.txt</strong>
$ <strong>git add requirements.txt</strong>
$ <strong>git commit -m "Add requirements.txt for virtualenv"</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may be wondering why we didn&#8217;t add our other dependency,
    Selenium, to our requirements.  The reason is that Selenium is
    only a dependency for the tests, not the application code (we&#8217;re
    never going to run the tests on the server itself).  Some
    people like to also create a file called <em>test-requirements.txt</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we do a <code>git push</code> to send our updates up to our code-sharing site:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we can pull those changes down to the server:</p>
</div>
<div class="listingblock server-commands skipme">
<div class="content">
<pre>elspeth@server:$ <strong>git pull</strong>  # may ask you to do some git config first</pre>
</div>
</div>
<div class="paragraph">
<p>We create our virtualenv just like we did on our own machine:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>pwd</strong>
/home/elspeth/sites/superlists-staging.ottg.eu
elspeth@server:$ <strong>python3.6 -m venv virtualenv</strong>
elspeth@server:$ <strong>ls virtualenv/bin</strong>
activate      activate.fish  easy_install-3.6  pip3    python   python3.6
activate.csh  easy_install   pip               pip3.6  python3</pre>
</div>
</div>
<div class="paragraph">
<p>If we wanted to activate the virtualenv, we could do so with
<code>source ./virtualenv/bin/activate</code> just like we do locally, but on the
server we don&#8217;t need that. We can actually do everything we want to by directly
calling the versions of Python, pip, and the other executables in the
virtualenv&#8217;s <em>bin</em> directory, as we&#8217;ll soon see.</p>
</div>
<div class="paragraph">
<p>For example, to install our requirements into the virtualenv, we use the
virtualenv pip:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/pip install -r requirements.txt</strong>
Collecting django==1.11.13 (from -r requirements.txt (line 1))
[...]
Successfully installed django-1.11.13 pytz-2018.4</pre>
</div>
</div>
<div class="paragraph">
<p>And to run Python in the virtualenv, we use the virtualenv <code>python</code>
binary:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/python manage.py runserver</strong>
Performing system checks...

System check identified no issues (0 silenced).
[...]
You have 15 unapplied migration(s). Your project may not work [...]
[...]
Starting development server at http://127.0.0.1:8000/</pre>
</div>
</div>
<div class="paragraph">
<p>If we ignore the ominous message about migrations for now, Django
certainly looks a lot happier.</p>
</div>
<div class="paragraph">
<p>Progress!  We&#8217;ve got a system for getting code to and from the server
(<code>git push</code> and <code>git pull</code>), we&#8217;ve got a virtualenv set up to match our local
one, and a single file, <em>requirements.txt</em>, to keep them in sync.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_ft_to_check_that_our_deployment_works">9.5.2. Using the FT to Check That Our Deployment Works</h4>
<div class="paragraph">
<p>Let&#8217;s see what our FTs think about this version of our site running on
the server. I&#8217;ll use the <code>--failfast</code> option to exit as soon as a single test
fails:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu ./manage.py test functional_tests \
    --failfast</strong>
[...]
selenium.common.exceptions.WebDriverException: Message: Reached error page: [...]</pre>
</div>
</div>
<div class="paragraph">
<p>Nope!  What&#8217;s going on here?  Time for a little debugging.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_a_deployment_that_doesn_t_seem_to_work_at_all">9.6. Debugging a Deployment That Doesn&#8217;t Seem to Work at All</h3>
<div class="paragraph">
<p>You may remember that Django&#8217;s runserver usually chooses to run on port 8000.
But a "normal" web server should run on port 80, and that&#8217;s where our FTs are
currently looking, on <em>superlists-staging.ottg.eu</em>.</p>
</div>
<div class="paragraph">
<p>But we can actually use our <code>STAGING_SERVER</code> variable to point the tests at
port 8000. Let&#8217;s try that:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu:8000 ./manage.py test functional_tests \
    --failfast</strong>

selenium.common.exceptions.WebDriverException: Message: Reached error page: [...]</pre>
</div>
</div>
<div class="paragraph">
<p>Nope, that didn&#8217;t work earlier.  Let&#8217;s try an even lower-level smoke test, the
traditional Unix utility "curl"&#8201;&#8212;&#8201;it&#8217;s a command-line tool for making web
requests.  Try it on your own computer first:</p>
</div>
<div class="listingblock ignore-errors">
<div class="content">
<pre>$ <strong>curl superlists-staging.ottg.eu</strong>
curl: (7) Failed to connect to superlists-staging.ottg.eu port 80: Connection
refused</pre>
</div>
</div>
<div class="paragraph">
<p>And maybe just to be sure, we could even open up our web browser and type in
<em><a href="http://superlists-staging.ottg.eu:8000" class="bare">http://superlists-staging.ottg.eu:8000</a></em>, and confirm using a familiar tool
that things aren&#8217;t working. Nope.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On Debugging</div>
<div class="paragraph">
<p>Let me let you in on a little secret.  I&#8217;m actually bad at debugging.  We all
have our psychological strengths and weakness, and one of my weaknesses is that
when I run into a problem I can&#8217;t see an obvious solution to, I want to throw
up my hands way too soon and say "well, this is hopeless, it can&#8217;t be fixed",
and give up.</p>
</div>
<div class="paragraph">
<p>Thankfully I have some good role models at work who are much better at it than
me (hi Glenn!).   Debugging needs the patience and tenacity of a bloodhound.
If at first you don&#8217;t succeed, you need to systematically rule out options,
check your assumptions, eliminate various aspects of the problem and simplify
things down, find the parts that do and don&#8217;t work, until you eventually find
the cause.</p>
</div>
<div class="paragraph">
<p>It always seems hopeless at first!  But eventually you get there.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re pretty sure the server is running and listening on port 8000, but we
can&#8217;t get to it from the outside.  What about from the inside?  Try
running <code>curl</code> on the server itself (you&#8217;ll need a second SSH shell onto your
server, so as not to interrupt the existing <code>runserver</code> process):</p>
</div>
<div class="listingblock server-commands small-code">
<div class="content">
<pre>elspeth@server:$ <strong>curl localhost:8000</strong>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;

    [...]
    &lt;title&gt;To-Do lists&lt;/title&gt;
    [...]

  &lt;/body&gt;
&lt;/html&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Ah-ha!  That looks like the HTML for our site.  So we <em>can</em> reach it from the
server itself, just not from the outside.  What could be going on?</p>
</div>
<div class="paragraph">
<p>Actually there&#8217;s clue in the output that Django printed out earlier when
we ran <code>runserver</code>:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>Starting development server at http://127.0.0.1:8000/</pre>
</div>
</div>
<div class="paragraph">
<p>Django&#8217;s development server is configured to listen on 127.0.0.1,
aka the "localhost" IP address.  But we&#8217;re trying to reach it from
the outside, via the server&#8217;s "real" public address.</p>
</div>
<div class="paragraph">
<p>But Django isn&#8217;t listening on that address by default.
Here&#8217;s how we tell it to listen on all addresses.  Use Ctrl-C to
interrupt the <code>runserver</code> process, and restart it like this:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/python manage.py runserver 0.0.0.0:8000</strong>
[...]
Starting development server at http://0.0.0.0:8000/</pre>
</div>
</div>
<div class="paragraph">
<p>And in a second SSH shell, we can confirm it works from the server:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>curl localhost:8000</strong>
&lt;!DOCTYPE html&gt;
[...]
&lt;/html&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>What about from our own laptop?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>curl superlists-staging.ottg.eu:8000</strong>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
[...]
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Looks good at first glance!  Let&#8217;s try our FTs again:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu:8000 ./manage.py test functional_tests \
    --failfast</strong>

======================================================================
FAIL: test_can_start_a_list_for_one_user
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/tests.py", line 44, in
test_can_start_a_list_for_one_user
    self.assertIn('To-Do', self.browser.title)
AssertionError: 'To-Do' not found in 'DisallowedHost at /'
 ---------------------------------------------------------------------
Ran 1 test in 4.010s

FAILED (failures=1)
[...]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this point, if your FTs still can&#8217;t talk to the server,
    something else must be in the way.  Check your provider&#8217;s firewall
    settings, and make sure ports 80 and 8000 are open to the world. On AWS,
    for example, you may need to configure the "security group" for your
    server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Oops, spoke too soon!  Another error.  We didn&#8217;t look closely enough at
that <code>curl</code> <span class="keep-together">output</span>&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_hacking_allowed_hosts_in_settings_py">9.7. Hacking ALLOWED_HOSTS in settings.py</h3>
<div class="paragraph">
<p>Don&#8217;t be disheartened!  We may have just fixed one problem only to run straight
into another, but this problem is definitely a much easier one.  At least we
can talk to the server!  And it&#8217;s giving us a helpful pointer.  Try opening the
site manually (<a href="#django-disallowedhosts-error">Another hitch along the way</a>):</p>
</div>
<div id="django-disallowedhosts-error" class="imageblock">
<div class="content">
<img src="images/twp2_0902a.png" alt="the Django debug page explaining the DisallowedHost error">
</div>
<div class="title">Figure 17. Another hitch along the way</div>
</div>
<div class="paragraph">
<p><code>ALLOWED_HOSTS</code> is a security setting designed to reject requests that are
likely to be forged, broken or malicious because they don&#8217;t appear to be
asking for your site (HTTP request contain the address they were intended for
in a header called "Host").</p>
</div>
<div class="paragraph">
<p>By default, when DEBUG=True, <code>ALLOWED_HOSTS</code> effectively allows <em>localhost</em>,
our own machine, so that&#8217;s why it was working OK in dev, and from the server
itself (where we ask for <em>localhost</em>), but not from our own machine (where we
ask for <em>superlists-staging.ottg.eu</em>)</p>
</div>
<div class="paragraph">
<p>There&#8217;s more information in the <a href="http://bit.ly/2u0R2d6">Django docs</a>.</p>
</div>
<div class="paragraph">
<p>The upshot is that we need to adjust <code>ALLOWED_HOSTS</code> in <em>settings.py</em>. Since
we&#8217;re just hacking for now, let&#8217;s set it to the totally insecure allow-everyone
"*" setting:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"># SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We commit that locally, then push it up to GitHub&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "hack ALLOWED_HOSTS to be *"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And pull it down on the server, and restart our <code>runserver</code> process:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>git pull</strong>
elspeth@server:$ <strong>./virtualenv/bin/python manage.py runserver 0.0.0.0:8000</strong></pre>
</div>
</div>
<div class="paragraph">
<p>A quick visual inspection confirms&#8212;&#8203;the site is up (<a href="#staging-is-up">The staging site is up!</a>)!</p>
</div>
<div id="staging-is-up" class="imageblock">
<div class="content">
<img src="images/twp2_0903.png" alt="The front page of the site, at least, is up">
</div>
<div class="title">Figure 18. The staging site is up!</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see what our functional tests say:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu:8000 ./manage.py test functional_tests \
    --failfast</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_list_table"]</pre>
</div>
</div>
<div class="paragraph">
<p>The tests are failing as soon as they try to submit a new item, because we
haven&#8217;t set up the database. You&#8217;ll probably have spotted the yellow Django
debug page (<a href="#django-debug-screen">But the database isn&#8217;t</a>) telling us as much as the tests went
through, or if you tried it manually.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The tests saved us from potential embarrassment there.  The site <em>looked</em>
    fine when we loaded its front page.  If we&#8217;d been a little hasty and only
    testing manually, we might have thought we were done, and it would have
    been the first users that discovered that nasty Django DEBUG page.  Okay,
    slight exaggeration for effect, maybe we <em>would</em> have checked, but what
    happens as the site gets bigger and more complex? You can&#8217;t check
    everything. The tests can.
</td>
</tr>
</table>
</div>
<div id="django-debug-screen" class="imageblock">
<div class="content">
<img src="images/twp2_0904.png" alt="Django DEBUG page showing database error">
</div>
<div class="title">Figure 19. But the database isn&#8217;t</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_database_with_migrate">9.8. Creating the Database with migrate</h3>
<div class="paragraph">
<p>We
run <code>migrate</code> using the <code>--noinput</code> argument to suppress the two little "are
you sure" prompts:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/python manage.py migrate --noinput</strong>
Operations to perform:
  Apply all migrations: auth, contenttypes, lists, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  [...]
  Applying lists.0004_item_list... OK
  Applying sessions.0001_initial... OK</pre>
</div>
</div>
<div class="paragraph">
<p>That looks good.  We restart the server:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/python manage.py runserver 0.0.0.0:8000</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And try the FTs again:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu:8000 ./manage.py test functional_tests</strong>
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 10.718s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray, that&#8217;s a working deploy!</p>
</div>
<div class="paragraph">
<p>Time for a well-earned tea break I think, and perhaps a
<a href="https://en.wikipedia.org/wiki/Digestive_biscuit">chocolate biscuit</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_success_our_hack_deployment_works">9.9. Success!  Our Hack Deployment Works</h3>
<div class="paragraph">
<p>Phew.  Well, it took a bit of hacking about, but now we can be reassured that
the basic piping works. Notice that the FT was able to guide us incrementally
towards a working site.</p>
</div>
<div class="paragraph">
<p>But we really can&#8217;t be using the Django dev server in production, or running on
port 8000 forever. In the next chapter, we&#8217;ll make our hacky deployment more
production-ready.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Test-Driving Server Configuration and Deployment</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Tests take some of the uncertainty out of deployment</dt>
<dd>
<p>For
developers, server administration is always "fun", by which I mean, a
process full of uncertainty and surprises. My aim during this chapter was
to show that a functional test suite can take some of the uncertainty out
of the process.</p>
</dd>
<dt class="hdlist1">Some typical pain points&#8212;&#8203;networking, ports, static files, and the database</dt>
<dd>
<p>The things that you need to keep an eye out for on any deployment include
making sure your database configuration, static files, software
dependencies, and custom settings that differ between development and
production.  You&#8217;ll need to think through each of these for your own
deployments.</p>
</dd>
<dt class="hdlist1">Tests allow us to experiment and work incrementally</dt>
<dd>
<p>Whenever we make a change to our server configuration, we can rerun the
test suite, and be confident that everything works as well as it did
before.  It allows us to experiment with our setup with less fear (as
we&#8217;ll see in the next chapter).</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_making_deployment_production_ready">10. Getting to a Production-Ready Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our
deployment is working fine but it&#8217;s not production-ready.  Let&#8217;s try
to get it there, using the tests to guide us.</p>
</div>
<div class="paragraph">
<p>In a way we&#8217;re applying the Red-Green-Refactor cycle to our server deployment.
Our hacky deployment got us to Green, and now we&#8217;re going to Refactor, working
incrementally (just as we would while coding), trying to move from working
state to working state, and using the FTs to detect any regressions.</p>
</div>
<div class="sect2">
<h3 id="_what_we_need_to_do">10.1. What We Need to Do</h3>
<div class="paragraph">
<p>What&#8217;s wrong with our hacky deployment?  A few things: first, we need to host
our app on the "normal" port 80 so that people can access it using a regular
URL.</p>
</div>
<div class="paragraph">
<p>Perhaps more importantly, we shouldn&#8217;t use the Django dev server for
production; it&#8217;s not designed for real-life workloads.  Instead, we&#8217;ll use the
popular combination of the Nginx web server and the Gunicorn Python/WSGI
server.</p>
</div>
<div class="paragraph">
<p>Several settings in <em>settings.py</em> are currently
unacceptable too. <code>DEBUG=True</code>, is strongly recommended against for production,
and we&#8217;ll want to fix <code>ALLOWED_HOSTS</code>, and set a unique <code>SECRET_KEY</code> too.</p>
</div>
<div class="paragraph">
<p>Finally, we don&#8217;t want to have to SSH in to our server to actually start the site.
Instead,  we&#8217;ll write a Systemd config file so that it starts up automatically
whenever the server (re)boots.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go through and see if we can fix each of these things one by one.</p>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_nginx">10.2. Switching to Nginx</h3>
<div class="sect3">
<h4 id="_installation">10.2.1. Installation</h4>
<div class="paragraph">
<p>We&#8217;ll
need a real web server, and all the cool kids are using Nginx these days,
so we will too.  Having fought with Apache for many years, I can tell
you it&#8217;s a blessed relief in terms of the readability of its config files,
if nothing else!</p>
</div>
<div class="paragraph">
<p>Installing Nginx on my server was a matter of doing an <code>apt install</code>, and I could
then see the default Nginx "Hello World" screen:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo apt install nginx</strong>
elspeth@server:$ <strong>sudo systemctl start nginx</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now you should be able to go to the normal port-80 URL address of your server, and see the
"Welcome to nginx" page at this point, as in <a href="#nginx-it-works">Nginx&#8212;&#8203;it works!</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don&#8217;t see it, it may be because your firewall does not open port 80
    to the world. On AWS, for example, you may need to configure the "security
    group" for your server to open port 80.
</td>
</tr>
</table>
</div>
<div id="nginx-it-works" class="imageblock">
<div class="content">
<img src="images/twp2_0901.png" alt="The default 'Welcome to nginx!' page">
</div>
<div class="title">Figure 20. Nginx&#8212;&#8203;it works!</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_ft_now_fails_but_show_nginx_is_running">10.2.2. The FT Now Fails, But Show Nginx Is Running</h4>
<div class="paragraph">
<p>We can also confirm that if
we run the FT <em>without</em> specifying port 8000, we see them fail again&#8212;&#8203;one of them
in particular should now mention Nginx:</p>
</div>
<div class="listingblock small-code against-server">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_new_item"]
[...]
AssertionError: 'To-Do' not found in 'Welcome to nginx!'</pre>
</div>
</div>
<div class="paragraph">
<p>Next we&#8217;ll configure the Nginx web server to talk to Django</p>
</div>
</div>
<div class="sect3">
<h4 id="_simple_nginx_configuration">10.2.3. Simple Nginx Configuration</h4>
<div class="paragraph">
<p>We
create an Nginx config file to tell it to send requests for our staging
site along to Django. A minimal config looks like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location / {
        proxy_pass http://localhost:8000;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This config says it will only listen for our staging domain, and will "proxy"
all requests to the local port 8000 where it expects to find Django
waiting to respond.</p>
</div>
<div class="paragraph">
<p>I saved this to a file called <em>superlists-staging.ottg.eu</em> inside the
<em>/etc/nginx/sites-available</em> folder.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Not sure how to edit a file on the server?  There&#8217;s always vi, which I&#8217;ll
    keep encouraging you to learn a bit of, but perhaps today is already too
    full of new things. Try the relatively beginner-friendly
    <a href="http://www.howtogeek.com/howto/42980/the-beginners-guide-to-nano-the-linux-command-line-text-editor/"><code>nano</code></a>
    instead. Note you&#8217;ll also need to use <code>sudo</code> because the file is in a
    system folder.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We then add it to the enabled sites for the server by creating a symlink to it:</p>
</div>
<div class="listingblock server-commands small-code">
<div class="content">
<pre># reset our env var (if necessary)
elspeth@server:$ <strong>export SITENAME=superlists-staging.ottg.eu</strong>

elspeth@server:$ <strong>cd /etc/nginx/sites-enabled/</strong>
elspeth@server:$ <strong>sudo ln -s /etc/nginx/sites-available/$SITENAME $SITENAME</strong>

# check our symlink has worked:
elspeth@server:$ <strong>readlink -f $SITENAME</strong>
/etc/nginx/sites-available/superlists-staging.ottg.eu</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the Debian/Ubuntu preferred way of saving Nginx configurations&#8212;&#8203;the real
config file in <em>sites-available</em>, and a symlink in <em>sites-enabled</em>; the idea is
that it makes it easier to switch sites on or off.</p>
</div>
<div class="paragraph">
<p>We also may as well remove the default "Welcome to nginx" config, to avoid any
<span class="keep-together">confusion</span>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo rm /etc/nginx/sites-enabled/default</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And now to test it.  First we reload nginx and restart our server:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>cd ~/sites/$SITENAME</strong>
elspeth@server:$ <strong>./virtualenv/bin/python manage.py runserver 8000</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If
    you ever find that Nginx isn&#8217;t behaving as expected, try the command
    <code>sudo nginx -t</code>, which does a config test and will warn you of any
    problems in your configuration files.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And now we can try our FTs without the port 8000:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu ./manage.py test functional_tests --failfast</strong>
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 10.718s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  Back to a working state.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I also had to edit <em>/etc/nginx/nginx.conf</em> and uncomment a line saying
    <code>server_names_hash_bucket_size 64;</code> to get my long domain name to work.
    You may not have this problem; Nginx will warn you when you do a <code>reload</code>
    if it has any trouble with its config files.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tips on Debugging Nginx</div>
<div class="paragraph">
<p>Deployments
are tricky!  If ever things don&#8217;t go exactly as expected, here are
a few tips and things to look out for, particularly around Nginx.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>I&#8217;m sure you already have, but double-check that each file is exactly where
it should be and has the right contents&#8212;&#8203;a single stray character can make
all the difference.</p>
</li>
<li>
<p>Nginx error logs go into <em>/var/log/nginx/error.log</em>.</p>
</li>
<li>
<p>You can ask Nginx to "check" its config using the <code>-t</code> flag: <code>nginx -t</code></p>
</li>
<li>
<p>Make sure your browser isn&#8217;t caching an out-of-date response.  Use
Ctrl-Refresh, or start a new private browser window.</p>
</li>
<li>
<p>This may be clutching at straws, but I&#8217;ve sometimes seen inexplicable
behaviour on the server that&#8217;s only been resolved when I fully restarted it
with a <code>sudo reboot</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you ever get completely stuck, there&#8217;s always the option of blowing away
your server and starting again from scratch!  It should go faster the second
time&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_gunicorn">10.3. Switching to Gunicorn</h3>
<div class="paragraph">
<p>Do
you know why the Django mascot is a pony?  The story is that Django
comes with so many things you want: an ORM, all sorts of middleware,
the admin site&#8230;&#8203; "What else do you want, a pony?" Well, Gunicorn stands
for "Green Unicorn", which I guess is what you&#8217;d want next if you already
had a pony&#8230;&#8203;</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/pip install gunicorn</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Gunicorn will need to know a path to a WSGI server, which is usually
a function called <code>application</code>.  Django provides one in <em>superlists/wsgi.py</em>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/gunicorn superlists.wsgi:application</strong>
2013-05-27 16:22:01 [10592] [INFO] Starting gunicorn 0.19.7.1
2013-05-27 16:22:01 [10592] [INFO] Listening at: http://127.0.0.1:8000 (10592)
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>But if we run the functional tests, once again you&#8217;ll see that they are
warning us of a problem. The test for adding list items passes happily, but the
test for layout + styling fails.  Good job, tests!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
AssertionError: 117.0 != 512 within 10 delta
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>And indeed, if you take a look at the site, you&#8217;ll find the CSS is all broken,
as in <a href="#site-with-broken-css">Broken CSS</a>.</p>
</div>
<div class="paragraph">
<p>The reason that the CSS is broken is that although the Django dev server will
serve static files magically for you, Gunicorn doesn&#8217;t.  Now is the time to
tell Nginx to do it instead.</p>
</div>
<div id="site-with-broken-css" class="imageblock">
<div class="content">
<img src="images/twp2_1001.png" alt="The site is up, but CSS is broken">
</div>
<div class="title">Figure 21. Broken CSS</div>
</div>
<div class="paragraph">
<p>One step forward, one step backward, but once again we&#8217;ve identified the
problem nice and early. Moving on!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
At this point if you see a "502 - Bad Gateway", it&#8217;s probably because you
    forgot to restart Gunicorn.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_nginx_to_serve_static_files">10.4. Getting Nginx to Serve Static Files</h3>
<div class="paragraph">
<p>First
we run <code>collectstatic</code> to copy all the static files to a folder where
Nginx can find them:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>./virtualenv/bin/python manage.py collectstatic --noinput</strong>
[...]
15 static files copied to '/home/elspeth/sites/superlists-staging.ottg.eu/static'
elspeth@server:$ <strong>ls static/</strong>
base.css  bootstrap</pre>
</div>
</div>
<div class="paragraph">
<p>Now we tell Nginx to start serving those static files for us, by
adding a second <code>location</code> directive to the config:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location /static {
        alias /home/elspeth/sites/superlists-staging.ottg.eu/static;
    }

    location / {
        proxy_pass http://localhost:8000;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Reload Nginx and restart Gunicorn&#8230;&#8203;</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>./virtualenv/bin/gunicorn superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And if you take another manual look at your site, things should look much
healthier. Let&#8217;s rerun our FTs:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]

...
 ---------------------------------------------------------------------
Ran 3 tests in 10.718s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Phew.</p>
</div>
</div>
<div class="sect2">
<h3 id="_switching_to_using_unix_sockets">10.5. Switching to Using Unix Sockets</h3>
<div class="paragraph">
<p>When
we want to serve both staging and live, we can&#8217;t have both servers trying
to use port 8000.  We could decide to allocate different ports, but that&#8217;s a
bit arbitrary, and it would be dangerously easy to get it wrong and start
the staging server on the live port, or vice versa.</p>
</div>
<div class="paragraph">
<p>A better solution is to use Unix domain sockets&#8212;&#8203;they&#8217;re like files on disk,
but can be used by Nginx and Gunicorn to talk to each other.  We&#8217;ll put our
sockets in <em>/tmp</em>.  Let&#8217;s change the proxy settings in Nginx:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location /static {
        alias /home/elspeth/sites/superlists-staging.ottg.eu/static;
    }

    location / {
        proxy_pass http://unix:/tmp/superlists-staging.ottg.eu.socket;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we restart Gunicorn, but this time telling it to listen on a socket instead
of on the default port:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>./virtualenv/bin/gunicorn --bind \
    unix:/tmp/superlists-staging.ottg.eu.socket superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And again, we rerun the functional test again, to make sure things still pass:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray, a change that went without a hitch for once!<sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnote_16" title="View footnote.">16</a>]</sup>
Moving on&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_environment_variables_to_adjust_settings_for_production">10.6. Using Environment Variables to Adjust Settings for Production</h3>
<div class="paragraph">
<p>We know there are several things in
<em>settings.py</em> that we want to change for production:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ALLOWED_HOSTS</code> is currently set to "*" which isn&#8217;t secure.  We want it
to be set to only match the site we&#8217;re supposed to be serving
(<em>superlists-staging.ottg.eu</em>).</p>
</li>
<li>
<p><code>DEBUG</code> mode is all very well for hacking about on your own server, but
leaving those pages full of tracebacks available to the world
<a href="https://docs.djangoproject.com/en/1.11/ref/settings/#debug">isn&#8217;t secure</a>.</p>
</li>
<li>
<p><code>SECRET_KEY</code> is used by Django uses for some of its crypto&#8212;&#8203;things like cookies
and CSRF protection. It&#8217;s good practice to make sure the secret key on the
server is different from the one in your source code repo, because that code
might be visible to strangers.  We&#8217;ll want to generate a new, random one but
then keep it the same for the foreseeable future (find out more in the
<a href="https://docs.djangoproject.com/en/1.11/topics/signing/">Django docs</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Development, staging and live sites always have some differences
in their configuration. Environment variables are a good place to
store those different settings.  See
<a href="http://www.clearlytech.com/2014/01/04/12-factor-apps-plain-english/">"the
12-factor app"</a>.<sup class="footnote">[<a id="_footnoteref_17" class="footnote" href="#_footnote_17" title="View footnote.">17</a>]</sup></p>
</div>
<div class="paragraph">
<p>Here&#8217;s one way to make it work:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch08l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">if 'DJANGO_DEBUG_FALSE' in os.environ:  <i class="conum" data-value="1"></i><b>(1)</b>
    DEBUG = False
    SECRET_KEY = os.environ['DJANGO_SECRET_KEY']  <i class="conum" data-value="2"></i><b>(2)</b>
    ALLOWED_HOSTS = [os.environ['SITENAME']]  <i class="conum" data-value="2"></i><b>(2)</b>
else:
    DEBUG = True  <i class="conum" data-value="3"></i><b>(3)</b>
    SECRET_KEY = 'insecure-key-for-dev'
    ALLOWED_HOSTS = []</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We say we&#8217;ll use an environment variable called <code>DJANGO_DEBUG_FALSE</code>
to switch debug mode off, and in effect require production settings
(it doesn&#8217;t matter what we set it to, just that it&#8217;s there).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And now we say that, if debug mode is off, we <em>require</em> the
<code>SECRET_KEY</code> and <code>ALLOWED_HOSTS</code> to be set by two more environment
variables (one of which can be the <code>$SITENAME</code> variable we&#8217;ve been
using at the command-line so far).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Otherwise we fall-back to the insecure, debug mode settings that
are useful for Dev.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are other ways you might set up the logic, making various variables
optional, but I think this gives us a little bit of protection against
accidentally forgetting to set one.  The end result is that you don&#8217;t
need to set any of them for dev, but production needs all three, and it
will error if any are missing.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Better to fail hard than allow a typo in an environment variable name to
    leave you running with insecure settings.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s do our usual dance of committing locally, and pushing to GitHub:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>git commit -am "use env vars for prod settings DEBUG, ALLOWED_HOSTS, SECRET_KEY"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Then pull it down on the server, export a couple of environment variables,
and restart Gunicorn:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>git pull</strong>
elspeth@server:$ <strong>export DJANGO_DEBUG_FALSE=y DJANGO_SECRET_KEY=abc123</strong>
# we'll set the secret to something more secure later!
elspeth@server:$ <strong>./virtualenv/bin/gunicorn --bind \
    unix:/tmp/superlists-staging.ottg.eu.socket superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And use a test run to reassure ourselves that things still work&#8230;&#8203;</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu ./manage.py test functional_tests --failfast</strong>
[...]
AssertionError: 'To-Do' not found in ''</pre>
</div>
</div>
<div class="paragraph">
<p>Oops.  Let&#8217;s take a look manually: <a href="#django-400-error">An ugly 400 error</a>.</p>
</div>
<div id="django-400-error" class="imageblock">
<div class="content">
<img src="images/twp2_1002.png" alt="An unfriendly page showing 400 Bad Request">
</div>
<div class="title">Figure 22. An ugly 400 error</div>
</div>
</div>
<div class="sect2">
<h3 id="_essential_googling_the_error_message">10.7. Essential Googling the Error Message</h3>
<div class="paragraph">
<p>Something&#8217;s gone wrong.  But once again, by running our FTs frequently,
we&#8217;re able to identify the problem early, before we&#8217;ve changed too many things.
In this case the only thing we&#8217;ve changed is <em>settings.py</em>. We&#8217;ve changed three
settings—which one might be at fault?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s use the tried and tested "Googling the error message" technique
(<a href="#googling-the-error">An indispensable publication (source: <a href="https://news.ycombinator.com/item?id=11459601" class="bare">https://news.ycombinator.com/item?id=11459601</a>)</a>).</p>
</div>
<div id="googling-the-error" class="imageblock">
<div class="content">
<img src="images/twp2_1003.png" alt="Cover of a fake O'Reilly book called Googling the Error Message" width="400">
</div>
<div class="title">Figure 23. An indispensable publication (source: <a href="https://news.ycombinator.com/item?id=11459601" class="bare">https://news.ycombinator.com/item?id=11459601</a>)</div>
</div>
<div class="paragraph">
<p>The very first link in my search results for
<a href="https://www.google.co.uk/?q=django+400+bad+request">Django 400 Bad Request</a> suggests that a 400 error is usually to do with <code>ALLOWED_HOSTS</code>.  In the
last chapter we had a nice Django Debug page saying "DisallowedHost error"
(<a href="#django-disallowedhosts-error">Another hitch along the way</a>), but now because we have <code>DEBUG=False</code>, we
just get the minimal, unfriendly 400 page.</p>
</div>
<div class="paragraph">
<p>But what&#8217;s wrong with <code>ALLOWED_HOSTS</code>? After double-checking it for typos, we
might do a little more Googling with some relevant keywords:
<a href="https://www.google.co.uk/search?q=django+allowed+hosts+nginx">Django
ALLOWED_HOSTS Nginx</a>. Once again, the
<a href="https://www.digitalocean.com/community/questions/bad-request-400-django-nginx-gunicorn-on-debian-7">first result</a>
gives us the clue we need.</p>
</div>
<div class="sect3">
<h4 id="_fixing_allowed_hosts_with_nginx_passing_on_the_host_header">10.7.1. Fixing ALLOWED_HOSTS with Nginx: passing on the Host header</h4>
<div class="paragraph">
<p>The problem turns out to be that, by default, Nginx strips out the Host
headers from requests it forwards, and it makes it "look like" they came
from <em>localhost</em> after all.  We can tell it to forward on the original host
header by adding the <code>proxy_set_header</code> directive:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">server: /etc/nginx/sites-available/superlists-staging.ottg.eu</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name superlists-staging.ottg.eu;

    location /static {
        alias /home/elspeth/sites/superlists-staging.ottg.eu/static;
    }

    location / {
        proxy_pass http://unix:/tmp/superlists-staging.ottg.eu.socket;
        proxy_set_header Host $host;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Reload Nginx once more:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl reload nginx</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then we try our FTs again:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Phew.  Back to working again.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_env_file_to_store_our_environment_variables">10.8. Using a .env File to Store Our Environment Variables</h3>
<div class="paragraph">
<p>Another little refactor.  Setting environment variables manually in various
shells is a pain, and it&#8217;d be nice to have them all available in a single
place.  The Python world (and other people out there too) seems to be
standardising around using the convention of a file called <em>.env</em> in the
project root.</p>
</div>
<div class="paragraph">
<p>First we add it <em>.env</em> to our <em>.gitignore</em>—this file is going to be used
for secrets, and we don&#8217;t ever want them ending up on GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo .env &gt;&gt; .gitignore</strong>
$ <strong>git commit -am"gitignore .env file"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Next let&#8217;s save our environment on the server:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>pwd</strong>
/home/elspeth/sites/superlists-staging.ottg.eu
elspeth@server:$ <strong>echo DJANGO_DEBUG_FALSE=y &gt;&gt; .env</strong>
elspeth@server:$ <strong>echo SITENAME=$SITENAME &gt;&gt;.env</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The way I&#8217;ve used the environment files in <em>settings.py</em> means
    that the <em>.env</em> file is not required on your own machine, only
    in staging/production.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_generating_a_secure_secret_key">10.8.1. Generating a secure SECRET_KEY</h4>
<div class="paragraph">
<p>While we&#8217;re at it we&#8217;ll also generate a more secure secret key using a little
Python one-liner.</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>echo DJANGO_SECRET_KEY=$(
python3.6 -c"import random; print(''.join(random.SystemRandom().
choices('abcdefghijklmnopqrstuvwxyz0123456789', k=50)))"
) &gt;&gt; .env</strong>
elspeth@server:$ <strong>cat .env</strong>
DJANGO_DEBUG_FALSE=y
SITENAME=superlists-staging.ottg.eu
DJANGO_SECRET_KEY=[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s check our env file works, and restart gunicorn:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>unset DJANGO_SECRET_KEY DJANGO_DEBUG_FALSE SITENAME</strong>
elspeth@server:$ <strong>echo $DJANGO_DEBUG_FALSE-none</strong>
-none
elspeth@server:$ <strong>set -a; source .env; set +a</strong>
elspeth@server:$ <strong>echo $DJANGO_DEBUG_FALSE-none</strong>
y-none
elspeth@server:$ <strong>./virtualenv/bin/gunicorn --bind \
    unix:/tmp/$SITENAME.socket superlists.wsgi:application</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we rerun our FTs to check that they agree, everything still works:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Excellent!  That went without a hitch :)</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I&#8217;ve shown the use of a <em>.env</em> file and manually extracting environment
    variables in <em>settings.py</em>, but there are some plugins that do this stuff
    for you that are definitely worth investigating.  Look into
    <a href="https://django-environ.readthedocs.io/en/latest/">django-environ</a>,
    <a href="https://github.com/jpadilla/django-dotenv">django-dotenv</a>, and
    <a href="https://docs.pipenv.org/">Pipenv</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_systemd_to_make_sure_gunicorn_starts_on_boot">10.9. Using Systemd to Make Sure Gunicorn Starts on Boot</h3>
<div class="paragraph">
<p>Our
final step is to make sure that the server starts up Gunicorn automatically
on boot, and reloads it automatically if it crashes. On Ubuntu, the way to do
this is using Systemd.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what a Systemd config file looks like</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">server: /etc/systemd/system/gunicorn-superlists-staging.ottg.eu.service</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[Unit]
Description=Gunicorn server for superlists-staging.ottg.eu

[Service]
Restart=on-failure  <i class="conum" data-value="1"></i><b>(1)</b>
User=elspeth  <i class="conum" data-value="2"></i><b>(2)</b>
WorkingDirectory=/home/elspeth/sites/superlists-staging.ottg.eu  <i class="conum" data-value="3"></i><b>(3)</b>
EnvironmentFile=/home/elspeth/sites/superlists-staging.ottg.eu/.env  <i class="conum" data-value="4"></i><b>(4)</b>

ExecStart=/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/bin/gunicorn \
    --bind unix:/tmp/superlists-staging.ottg.eu.socket \
    superlists.wsgi:application  <i class="conum" data-value="5"></i><b>(5)</b>

[Install]
WantedBy=multi-user.target <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Systemd is joyously simple to configure (especially if you&#8217;ve ever had the
dubious pleasure of writing an <code>init.d</code> script), and is fairly
self-explanatory.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Restart=on-failure</code> will restart the process automatically if it crashes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>User=elspeth</code> makes the process run as the "elspeth" user.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>WorkingDirectory</code> sets the current working directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>EnvironmentFile</code> points Systemd towards our <em>.env</em> file and tells it
to load environment variables from there.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>ExecStart</code> is the actual process to execute.  I&#8217;m using the <code>\</code> line
continuation characters to split the full command over multiple lines,
for readability, but it could all go on one line.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>WantedBy</code> in the <code>[Install]</code> section is what tells Systemd we want this
service to start on boot.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Systemd scripts live in <em>/etc/systemd/system</em>, and their names must end in
<em>.service</em>.</p>
</div>
<div class="paragraph">
<p>Now we tell Systemd to start Gunicorn with the <code>systemctl</code> command:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre># this command is necessary to tell Systemd to load our new config file
elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
# this command tells Systemd to always load our service on boot
elspeth@server:$ <strong>sudo systemctl enable gunicorn-superlists-staging.ottg.eu</strong>
# this command actually starts our service
elspeth@server:$ <strong>sudo systemctl start gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>(You should find the <code>systemctl</code> command responds to tab completion, including
of the service name, by the way.)</p>
</div>
<div class="paragraph">
<p>Now we can rerun the FTs to see that everything still works. You can even test
that the site comes back up if you reboot the server!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">More Debugging Tips and Commands</div>
<div class="paragraph">
<p>A few more places to look and things to try, now that we&#8217;ve introduced
Gunicorn and Systemd into the mix, should things not go according to plan:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can check the Systemd logs using
<code>sudo journalctl -u gunicorn-superlists-staging.ottg.eu</code>.</p>
</li>
<li>
<p>You can ask Systemd to check the validity of your service configuration:
<code>systemd-analyze verify /path/to/my.service</code>.</p>
</li>
<li>
<p>Remember to restart both services whenever you make changes.</p>
</li>
<li>
<p>If you make changes to the Systemd config file, you need to
run <code>daemon-reload</code> before <code>systemctl restart</code> to see the effect
of your changes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_saving_our_changes_adding_gunicorn_to_our_requirements_txt">10.9.1. Saving Our Changes: Adding Gunicorn to Our requirements.txt</h4>
<div class="paragraph">
<p>Back
in the <em>local</em> copy of your repo, we should add Gunicorn to the list
of packages we need in our virtualenvs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip install gunicorn</strong>
$ <strong>pip freeze | grep gunicorn &gt;&gt; requirements.txt</strong>
$ <strong>git commit -am "Add gunicorn to virtualenv requirements"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On
    Windows, at the time of writing, Gunicorn would <code>pip install</code> quite
    happily, but it wouldn&#8217;t actually work if you tried to use it.  Thankfully
    we only ever run it on the server, so that&#8217;s not a problem. And, Windows
    support is
    <a href="http://stackoverflow.com/questions/11087682/does-gunicorn-run-on-windows">being discussed</a>&#8230;&#8203;
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_thinking_about_automating">10.10. Thinking About Automating</h3>
<div class="paragraph">
<p>Let&#8217;s
recap our provisioning and deployment procedures:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Provisioning</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Assume we have a user account and home folder</p>
</li>
<li>
<p><code>add-apt-repository ppa:deadsnakes/ppa &amp;&amp; apt update</code></p>
</li>
<li>
<p><code>apt install nginx git python3.6 python3.6-venv</code></p>
</li>
<li>
<p>Add Nginx config for virtual host</p>
</li>
<li>
<p>Add Systemd job for Gunicorn (including unique <code>SECRET_KEY</code>)</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Deployment</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create directory in <em>~/sites</em></p>
</li>
<li>
<p>Pull down source code</p>
</li>
<li>
<p>Start virtualenv in <em>virtualenv</em></p>
</li>
<li>
<p><code>pip install -r requirements.txt</code></p>
</li>
<li>
<p><code>manage.py migrate</code> for database</p>
</li>
<li>
<p><code>collectstatic</code> for static files</p>
</li>
<li>
<p>Restart Gunicorn job</p>
</li>
<li>
<p>Run FTs to check everything works</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Assuming we&#8217;re not ready to entirely automate our provisioning process, how
should we save the results of our investigation so far?  I would say that
the Nginx and Systemd config files should probably be saved somewhere, in
a way that makes it easy to reuse them later.  Let&#8217;s save them in a new
subfolder in our repo.</p>
</div>
<div class="sect3">
<h4 id="_saving_templates_for_our_provisioning_config_files">10.10.1. Saving Templates for Our Provisioning Config Files</h4>
<div class="paragraph">
<p>First,
 we create the subfolder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir deploy_tools</strong></pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Here&#8217;s a generic template for our Nginx config:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/nginx.template.conf</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="nginx">server {
    listen 80;
    server_name DOMAIN;

    location /static {
        alias /home/elspeth/sites/DOMAIN/static;
    }

    location / {
        proxy_pass http://unix:/tmp/DOMAIN.socket;
        proxy_set_header Host $host;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s one for the Gunicorn Sytemd service:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/gunicorn-systemd.template.service</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[Unit]
Description=Gunicorn server for DOMAIN

[Service]
Restart=on-failure
User=elspeth
WorkingDirectory=/home/elspeth/sites/DOMAIN
EnvironmentFile=/home/elspeth/sites/DOMAIN/.env

ExecStart=/home/elspeth/sites/DOMAIN/virtualenv/bin/gunicorn \
    --bind unix:/tmp/DOMAIN.socket \
    superlists.wsgi:application

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s easy for us to use those two files to generate
a new site, by doing a find and replace on <code>DOMAIN</code>.</p>
</div>
<div class="paragraph">
<p>For the rest, just keeping a few notes is OK. Why not keep
them in a file in the repo too?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/provisioning_notes.md</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="rst">Provisioning a new site
=======================

## Required packages:

* nginx
* Python 3.6
* virtualenv + pip
* Git

eg, on Ubuntu:

    sudo add-apt-repository ppa:deadsnakes/ppa
    sudo apt update
    sudo apt install nginx git python36 python3.6-venv

## Nginx Virtual Host config

* see nginx.template.conf
* replace DOMAIN with, e.g., staging.my-domain.com

## Systemd service

* see gunicorn-systemd.template.service
* replace DOMAIN with, e.g., staging.my-domain.com

## Folder structure:

Assume we have a user account at /home/username

/home/username
└── sites
    ├── DOMAIN1
    │    ├── .env
    │    ├── db.sqlite3
    │    ├── manage.py etc
    │    ├── static
    │    └── virtualenv
    └── DOMAIN2
         ├── .env
         ├── db.sqlite3
         ├── etc</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can do a commit for those:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add deploy_tools</strong>
$ <strong>git status</strong> # see three new files
$ <strong>git commit -m "Notes and template config files for provisioning"</strong></pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Our
source tree will now look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>.
├── deploy_tools
│   ├── gunicorn-systemd.template.service
│   ├── nginx.template.conf
│   └── provisioning_notes.md
├── functional_tests
│   ├── [...]
├── lists
│   ├── __init__.py
│   ├── models.py
│   ├── [...]
│   ├── static
│   │   ├── base.css
│   │   └── bootstrap
│   │       ├── [...]
│   ├── templates
│   │   ├── base.html
│   │   ├── [...]
│   ├── tests.py
│   ├── urls.py
│   └── views.py
├── manage.py
├── requirements.txt
├── static
│   ├── [...]
├── superlists
│   ├── [...]
└── virtualenv
    ├── [...]</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_saving_our_progress">10.11. Saving Our Progress</h3>
<div class="paragraph">
<p>Being able to run our FTs against a staging server can be very reassuring.
But, in most cases, you don&#8217;t want to run your FTs against your "real" server.
In order to "save our work", and reassure ourselves that the production server
will work just as well as the real server, we need to make our deployment
process repeatable.</p>
</div>
<div class="paragraph">
<p>Automation is the answer, and it&#8217;s the topic of the next chapter.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Production-Readiness for Server Deployments</div>
<div class="paragraph">
<p>A
few things to think about when trying to build a production-ready server
<span class="keep-together">environment</span>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Don&#8217;t use the Django dev server in production</dt>
<dd>
<p>Something
like Gunicorn or uWSGI is a better tool for running Django; it
will let you run multiple workers, for example.</p>
</dd>
<dt class="hdlist1">Don&#8217;t use Django to serve your static files</dt>
<dd>
<p>There&#8217;s
no point in using a Python process to do the simple job of serving
static files. Nginx can do it, but so can other web servers like Apache or
uWSGI.</p>
</dd>
<dt class="hdlist1">Check your settings.py for dev-only settings</dt>
<dd>
<p><code>DEBUG=True</code>, <code>ALLOWED_HOSTS</code> and <code>SECRET_KEY</code> are the ones we came across,
but you will probably have others (we&#8217;ll see more when we start to send
emails from the server).</p>
</dd>
<dt class="hdlist1">Security</dt>
<dd>
<p>A
serious discussion of server security is beyond the scope of this book,
and I&#8217;d warn against running your own servers without learning a good bit
more about it. (One reason people choose to use a PaaS to host their
code is that it means a slightly fewer security issues to worry about.)
If you&#8217;d like a place to start, here&#8217;s as good a place as any:
<a href="https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers">My first 5 minutes on a server</a>.
I can definitely recommend the eye-opening experience of installing
fail2ban and watching its logfiles to see just how quickly it picks up on
random drive-by attempts to brute force your SSH login.  The internet is a
wild place!</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">General Server Debugging Tips</div>
<div class="paragraph">
<p>The most important lesson to remember from this chapter is to work
incrementally, make one change at a time, and run your tests frequently.</p>
</div>
<div class="paragraph">
<p>When things (inevitably) go wrong, resist the temptation to flail about and
make other unrelated changes in the hope that things will start working again;
instead, stop, go backward if necessary to get to a working state, and figure
out what went wrong before moving forward again.</p>
</div>
<div class="paragraph">
<p>It&#8217;s just as easy to fall into the Refactoring-Cat trap on the server!</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_automate_deployment_with_fabric">11. Automating Deployment with Fabric</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Automate, automate, automate.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Cay Horstman
</div>
</div>
<div class="paragraph">
<p>Automating
deployment is critical for our staging tests to mean anything.
By making sure the deployment procedure is repeatable, we give ourselves
assurances that everything will go well when we deploy to production. (These
days people sometimes use the words "infrastructure as code" to describe
automation of deployments, and provisioning.)</p>
</div>
<div class="paragraph">
<p>Fabric
is a tool which lets you automate commands that you want to run on
servers.  "fabric3" is the Python 3 fork:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip install fabric3</strong></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It&#8217;s safe to ignore any errors that say "failed building wheel" during
    the Fabric3 installation, as long as it says "Successfully installed&#8230;&#8203;"
    at the end.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The usual setup is to have a file called <em>fabfile.py</em>, which will
contain one or more functions that can later be invoked from a command-line
tool called <code>fab</code>, like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>fab function_name:host=SERVER_ADDRESS</pre>
</div>
</div>
<div class="paragraph">
<p>That will call <code>function_name</code>, passing in a connection to the server at
<code>SERVER_ADDRESS</code>.  There are lots of other options for specifying usernames and
passwords, which you can find out about using <code>fab --help</code>.</p>
</div>
<div class="sect2">
<h3 id="_breakdown_of_a_fabric_script_for_our_deployment">11.1. Breakdown of a Fabric Script for Our Deployment</h3>
<div class="paragraph">
<p>The
best way to see how it works is with an example.
<a href="http://www.bbc.co.uk/cult/classic/bluepeter/valpetejohn/trivia.shtml">Here&#8217;s one
I made earlier</a>, automating all the deployment steps we&#8217;ve been going through.
The main function is called <code>deploy</code>; that&#8217;s the one we&#8217;ll invoke from the
command line. It then calls out to several helper functions, which we&#8217;ll build
together one by one, explaining as we go.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/fabfile.py (ch09l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import random
from fabric.contrib.files import append, exists
from fabric.api import cd, env, local, run

REPO_URL = 'https://github.com/hjwp/book-example.git'  <i class="conum" data-value="1"></i><b>(1)</b>

def deploy():
    site_folder = f'/home/{env.user}/sites/{env.host}'  <i class="conum" data-value="2"></i><b>(2)</b>
    run(f'mkdir -p {site_folder}') <i class="conum" data-value="3"></i><b>(3)</b><i class="conum" data-value="4"></i><b>(4)</b>
    with cd(site_folder):  <i class="conum" data-value="5"></i><b>(5)</b>
        _get_latest_source()
        _update_virtualenv()
        _create_or_update_dotenv()
        _update_static_files()
        _update_database()</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You&#8217;ll want to update the <code>REPO_URL</code> variable with the URL of your
own Git repo on its code-sharing site.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>env.user</code> will contain the username you&#8217;re using to log in to the server;
<code>env.host</code> will be the address of the server we&#8217;ve specified at the command
line (e.g., <em>superlists.ottg.eu</em>).<sup class="footnote">[<a id="_footnoteref_18" class="footnote" href="#_footnote_18" title="View footnote.">18</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>run</code> is the most common Fabric command.  It says "run this shell command
on the server".  The <code>run</code> commands in this chapter will replicate many
of the commands we did manually in the last two.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>mkdir -p</code> is a useful flavour of <code>mkdir</code>, which is better in two ways: it
can create directories several levels deep, and it only creates them
if necessary.  So, <code>mkdir -p /tmp/foo/bar</code> will create the directory <em>bar</em>
but also its parent directory <em>foo</em> if it needs to.  It also won&#8217;t complain
if <em>bar</em> already exists.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>cd</code> is a fabric context manager that says "run all the following
statements inside this working directory".<sup class="footnote">[<a id="_footnoteref_19" class="footnote" href="#_footnote_19" title="View footnote.">19</a>]</sup></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hopefully all of those helper functions have fairly self-descriptive names.
Because any function in a fabfile can theoretically be invoked from the
command line, I&#8217;ve used the convention of a leading underscore to indicate
that they&#8217;re not meant to be part of the "public API" of the fabfile. Let&#8217;s
take a look at each one, in chronological order.</p>
</div>
<div class="sect3">
<h4 id="_pulling_down_our_source_code_with_git">11.1.1. Pulling Down Our Source Code with Git</h4>
<div class="paragraph">
<p>Next we want to download the latest version of our source code to the server,
like we did with <code>git pull</code> in the previous chapters:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/fabfile.py (ch09l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def _get_latest_source():
    if exists('.git'):  <i class="conum" data-value="1"></i><b>(1)</b>
        run('git fetch')  <i class="conum" data-value="2"></i><b>(2)</b>
    else:
        run(f'git clone {REPO_URL} .')  <i class="conum" data-value="3"></i><b>(3)</b>
    current_commit = local("git log -n 1 --format=%H", capture=True)  <i class="conum" data-value="4"></i><b>(4)</b>
    run(f'git reset --hard {current_commit}')  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>exists</code> checks whether a directory or file already exists on the server.
We look for the <em>.git</em> hidden folder to check whether the repo has already
been cloned in our site folder.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>git fetch</code> inside an existing repository pulls down all the latest commits
from the web (it&#8217;s like <code>git pull</code>, but without immediately updating the
live source tree).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Alternatively we use <code>git clone</code> with the repo URL to bring down a fresh
source tree.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fabric&#8217;s <code>local</code> command runs a command on your local machine&#8212;&#8203;it&#8217;s just
a wrapper around <code>subprocess.call</code> really, but it&#8217;s quite convenient.
Here we capture the output from that <code>git log</code> invocation to get the ID
of the current commit that&#8217;s on your local PC.  That means the server
will end up with whatever code is currently checked out on your machine
(as long as you&#8217;ve pushed it up to the server.  Another common gotcha!).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We <code>reset --hard</code> to that commit, which will blow away any current changes
in the server&#8217;s code directory.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The end result of this is that we either do a <code>git clone</code> if it&#8217;s a fresh
deploy, or we do a <code>git fetch + git reset --hard</code> if a previous version of
the code is already there; the equivalent of the <code>git pull</code> we used when we
did it manually, but with the <code>reset --hard</code> to force overwriting any local
changes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_updating_the_virtualenv">11.1.2. Updating the Virtualenv</h4>
<div class="paragraph">
<p>Next we create or update the virtualenv:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">deploy_tools/fabfile.py (ch09l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def _update_virtualenv():
    if not exists('virtualenv/bin/pip'):  <i class="conum" data-value="1"></i><b>(1)</b>
        run(f'python3.6 -m venv virtualenv')
    run('./virtualenv/bin/pip install -r requirements.txt')  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We look inside the virtualenv folder for the <code>pip</code> executable as a way of
checking whether it already exists.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we use <code>pip install -r</code> like we did earlier.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_new_env_file_if_necessary">11.1.3. Creating a New .env File if Necessary</h4>
<div class="paragraph">
<p>Our deploy script can also save us some of the manual work creating a <em>.env</em> script:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">deploy_tools/fabfile.py (ch09l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def _create_or_update_dotenv():
    append('.env', 'DJANGO_DEBUG_FALSE=y')  <i class="conum" data-value="1"></i><b>(1)</b>
    append('.env', f'SITENAME={env.host}')
    current_contents = run('cat .env')  <i class="conum" data-value="2"></i><b>(2)</b>
    if 'DJANGO_SECRET_KEY' not in current_contents:  <i class="conum" data-value="2"></i><b>(2)</b>
        new_secret = ''.join(random.SystemRandom().choices(  <i class="conum" data-value="3"></i><b>(3)</b>
            'abcdefghijklmnopqrstuvwxyz0123456789', k=50
        ))
        append('.env', f'DJANGO_SECRET_KEY={new_secret}')</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>append</code> command conditionally adds a line to a file,
if that line isn&#8217;t already there.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For the secret key we first manually check whether there&#8217;s already an entry
in the file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And if not, we use our little one-liner from earlier to generate
a new one (we can&#8217;t rely on the <code>append</code>'s conditional logic here
because our new key and any potential existing one won&#8217;t be the same).</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_updating_static_files">11.1.4. Updating Static Files</h4>
<div class="paragraph">
<p>Updating static files is a single command:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">deploy_tools/fabfile.py (ch09l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def _update_static_files():
    run('./virtualenv/bin/python manage.py collectstatic --noinput')  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use the virtualenv version of Python whenever we need to run a Django
<em>manage.py</em> command, to make sure we get the virtualenv version of Django,
not the system one.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_migrating_the_database_if_necessary">11.1.5. Migrating the Database If Necessary</h4>
<div class="paragraph">
<p>Finally, we update the database with <code>manage.py migrate</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/fabfile.py (ch09l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def _update_database():
    run('./virtualenv/bin/python manage.py migrate --noinput')  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>--noinput</code> removes any interactive yes/no confirmations that Fabric
would find hard to deal with.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we&#8217;re done!  Lots of new things to take in, I imagine, but I hope you
can see how this is all replicating the work we did manually earlier, with
a bit of logic to make it work both for brand new deployments and for existing
ones that just need updating. If you like words with Latin roots, you might
describe it as <em>idempotent</em>, which means it has the same effect whether you
run it once or multiple times.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trying_it_out">11.2. Trying It Out</h3>
<div class="paragraph">
<p>Before we try, we need to make sure our latest commits are up on GitHub,
or we won&#8217;t be able to sync the server with our local commits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s try
our Fabric script out on our existing staging site, and see it working to
update a deployment that already exists:</p>
</div>
<div class="listingblock small-code against-server">
<div class="content">
<pre>$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy:host=elspeth@superlists-staging.ottg.eu</strong>
[elspeth@superlists-staging.ottg.eu] Executing task 'deploy'
[elspeth@superlists-staging.ottg.eu] run: mkdir -p
/home/elspeth/sites/superlists-staging.ottg.eu
[elspeth@superlists-staging.ottg.eu] run: git fetch
[elspeth@superlists-staging.ottg.eu] out: remote: Counting objects: [...]
[elspeth@superlists-staging.ottg.eu] out: remote: Compressing objects: [...]
[localhost] local: git log -n 1 --format=%H
[elspeth@superlists-staging.ottg.eu] run: git reset --hard
[...]
[elspeth@superlists-staging.ottg.eu] out: HEAD is now at [...]
[elspeth@superlists-staging.ottg.eu] out:
[elspeth@superlists-staging.ottg.eu] run: ./virtualenv/bin/pip install -r
requirements.txt
[elspeth@superlists-staging.ottg.eu] out: Requirement already satisfied:
django==1.11.13 in ./virtualenv/lib/python3.6/site-packages (from -r
requirements.txt (line 1))
[elspeth@superlists-staging.ottg.eu] out: Requirement already satisfied:
gunicorn==19.8.1 in ./virtualenv/lib/python3.6/site-packages (from -r
requirements.txt (line 2))
[elspeth@superlists-staging.ottg.eu] out: Requirement already satisfied: pytz
in ./virtualenv/lib/python3.6/site-packages (from django==1.11.13->-r
requirements.txt (line 1))
[elspeth@superlists-staging.ottg.eu] out:
[elspeth@superlists-staging.ottg.eu] run: ./virtualenv/bin/python manage.py
collectstatic --noinput
[elspeth@superlists-staging.ottg.eu] out:
[elspeth@superlists-staging.ottg.eu] out: 0 static files copied to
'/home/elspeth/sites/superlists-staging.ottg.eu/static', 15 unmodified.
[elspeth@superlists-staging.ottg.eu] out:
[elspeth@superlists-staging.ottg.eu] run: ./virtualenv/bin/python manage.py
migrate --noinput
[elspeth@superlists-staging.ottg.eu] out: Operations to perform:
[elspeth@superlists-staging.ottg.eu] out:   Apply all migrations: auth,
contenttypes, lists, sessions
[elspeth@superlists-staging.ottg.eu] out: Running migrations:
[elspeth@superlists-staging.ottg.eu] out:   No migrations to apply.
[elspeth@superlists-staging.ottg.eu] out:</pre>
</div>
</div>
<div class="paragraph">
<p>Awesome.  I love making computers spew out pages and pages of output like that
(in fact I find it hard to stop myself from making little '70s computer
<em>&lt;brrp, brrrp, brrrp&gt;</em> noises like Mother in <em>Alien</em>).  If we look through
it we can see it is doing our bidding: the <code>mkdir -p</code> command goes through
happily, even though the directory already exist.  Next <code>git pull</code> pulls down
the couple of commits we just made.  Then <code>pip install -r requirements.txt</code>
completes happily, noting that the existing virtualenv already has all the
packages we need. <code>collectstatic</code> also notices that the static files are all
already there, and finally the <code>migrate</code> completes without needing to apply
anything.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For this script to work, you need to have done a <code>git push</code> of your
    current local commit, so that the server can pull it down and <code>reset</code> to
    it. If you see an error saying <code>Could not parse object</code>, try doing a <code>git
    push</code>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Fabric Configuration</div>
<div class="paragraph">
<p>If
you are using an SSH key to log in, are storing it in the default location,
and are using the same username on the server as locally, then Fabric should
"just work".  If you aren&#8217;t, there are several tweaks you may need to apply
in order to get the <code>fab</code> command to do your bidding. They revolve around the
username, the location of the SSH key to use, or the password.</p>
</div>
<div class="paragraph">
<p>You can pass these in to Fabric at the command line.  Check out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>fab --help</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Or
see the <a href="http://docs.fabfile.org">Fabric documentation</a> for more info.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deploying_to_live">11.2.1. Deploying to Live</h4>
<div class="paragraph">
<p>So, let&#8217;s try using it for our live site!</p>
</div>
<div class="listingblock small-code against-server">
<div class="content">
<pre>$ <strong>fab deploy:host=elspeth@superlists.ottg.eu</strong>
[elspeth@superlists.ottg.eu] Executing task 'deploy'
[elspeth@superlists.ottg.eu] run: mkdir -p
/home/elspeth/sites/superlists.ottg.eu
[elspeth@superlists.ottg.eu] run: git clone
https://github.com/hjwp/book-example.git .
[elspeth@superlists.ottg.eu] out: Cloning into '.'...
[...]
[elspeth@superlists.ottg.eu] out: Receiving objects: 100% [...]
[...]
[elspeth@superlists.ottg.eu] out: Resolving deltas: 100% [...]
[elspeth@superlists.ottg.eu] out:
[localhost] local: git log -n 1 --format=%H
[elspeth@superlists.ottg.eu] run: git reset --hard [...]
[elspeth@superlists.ottg.eu] out: HEAD is now at [...]
[elspeth@superlists.ottg.eu] out:</pre>
</div>
</div>
<div class="listingblock small-code against-server skipme">
<div class="content">
<pre>[elspeth@superlists.ottg.eu] run: python3.6 -m venv virtualenv
[elspeth@superlists.ottg.eu] run: ./virtualenv/bin/pip install -r
requirements.txt
[elspeth@superlists.ottg.eu] out: Collecting django==1.11.13 [...]
[elspeth@superlists.ottg.eu] out:   Using cached [...]
[elspeth@superlists.ottg.eu] out: Collecting gunicorn==19.8.1 [...]
[elspeth@superlists.ottg.eu] out:   Using cached [...]
[elspeth@superlists.ottg.eu] out: Collecting pytz [...]
[elspeth@superlists.ottg.eu] out:   Using cached [...]
[elspeth@superlists.ottg.eu] out: Installing collected packages: pytz, django,
gunicorn
[elspeth@superlists.ottg.eu] out: Successfully installed django-1.11
gunicorn-19.7.1 pytz-2017.3

[elspeth@superlists.ottg.eu] run: echo 'DJANGO_DEBUG_FALSE=y' >> "$(echo .env)"
[elspeth@superlists.ottg.eu] run: echo 'SITENAME=superlists.ottg.eu' >> "$(echo
.env)"
[elspeth@superlists.ottg.eu] run: echo
'DJANGO_SECRET_KEY=[...]
[elspeth@superlists.ottg.eu] run: ./virtualenv/bin/python manage.py
collectstatic --noinput
[elspeth@superlists.ottg.eu] out: Copying
'/home/elspeth/sites/superlists.ottg.eu/lists/static/base.css'
[...]
[elspeth@superlists.ottg.eu] out: 15 static files copied to
'/home/elspeth/sites/superlists.ottg.eu/static'.
[elspeth@superlists.ottg.eu] out:

[elspeth@superlists.ottg.eu] run: ./virtualenv/bin/python manage.py migrate
[...]
[elspeth@superlists.ottg.eu] out: Operations to perform:
[elspeth@superlists.ottg.eu] out:   Apply all migrations: auth, contenttypes,
lists, sessions
[elspeth@superlists.ottg.eu] out: Running migrations:
[elspeth@superlists.ottg.eu] out:   Applying contenttypes.0001_initial... OK
[elspeth@superlists.ottg.eu] out:   Applying
contenttypes.0002_remove_content_type_name... OK
[elspeth@superlists.ottg.eu] out:   Applying auth.0001_initial... OK
[elspeth@superlists.ottg.eu] out:   Applying
auth.0002_alter_permission_name_max_length... OK
[...]
[elspeth@superlists.ottg.eu] out:   Applying lists.0004_item_list... OK
[elspeth@superlists.ottg.eu] out:   Applying sessions.0001_initial... OK
[elspeth@superlists.ottg.eu] out:


Done.
Disconnecting from elspeth@superlists.ottg.eu... done.</pre>
</div>
</div>
<div class="paragraph">
<p><em>Brrp brrp brpp</em>. You can see the script follows a slightly different path,
doing a <code>git clone</code> to bring down a brand new repo instead of a <code>git pull</code>.
It also needs to set up a new virtualenv from scratch, including a fresh
install of pip and Django. The <code>collectstatic</code> actually creates new files this
time, and the <code>migrate</code> seems to have worked too.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_provisioning_nginx_and_gunicorn_config_using_sed">11.3. Provisioning: Nginx and Gunicorn Config Using sed</h3>
<div class="paragraph">
<p>What
else do we need to do to get our live site into production? We refer to
our provisioning notes, which tell us to use the template files to create our
Nginx virtual host and the Systemd service.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s use a little Unix command-line magic!</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>cat ./deploy_tools/nginx.template.conf \
    | sed "s/DOMAIN/superlists.ottg.eu/g" \
    | sudo tee /etc/nginx/sites-available/superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p><code>sed</code> ("stream editor") takes a stream of text and performs edits on it.
In this case we ask it to substitute the string <em>DOMAIN</em> for the address of our
site, with the <code>s/replaceme/withthis/g</code>
syntax.<sup class="footnote">[<a id="_footnoteref_20" class="footnote" href="#_footnote_20" title="View footnote.">20</a>]</sup>
<code>cat</code> prints out our file, and we pipe (<code>|</code>) that to our <code>sed</code> process,
and then we pipe the output of <em>that</em> to a root-user process (<code>sudo</code>), which
uses <code>tee</code> to write its input to a file, in this case the Nginx
<code>sites-available</code> virtualhost config file.  Wee!</p>
</div>
<div class="paragraph">
<p>Next we activate that file with a symlink:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo ln -s /etc/nginx/sites-available/superlists.ottg.eu \
    /etc/nginx/sites-enabled/superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we write the Systemd service, with another <code>sed</code>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server: <strong>cat ./deploy_tools/gunicorn-systemd.template.service \
    | sed "s/DOMAIN/superlists.ottg.eu/g" \
    | sudo tee /etc/systemd/system/gunicorn-superlists.ottg.eu.service</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we start both services:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl reload nginx</strong>
elspeth@server:$ <strong>sudo systemctl enable gunicorn-superlists.ottg.eu</strong>
elspeth@server:$ <strong>sudo systemctl start gunicorn-superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we take a look at our site: <a href="#working-production-deploy">Brrp, brrp, brrp&#8230;&#8203;it worked!</a>.  It
works&#8212;&#8203;hooray!</p>
</div>
<div id="working-production-deploy" class="imageblock">
<div class="content">
<img src="images/twp2_1101.png" alt="A screenshot of the production site, working">
</div>
<div class="title">Figure 24. Brrp, brrp, brrp&#8230;&#8203;it worked!</div>
</div>
<div class="paragraph">
<p>It&#8217;s done a good job.  Good fabfile, have a biscuit.  You have earned the
privilege of being added to the repo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add deploy_tools/fabfile.py</strong>
$ <strong>git commit -m "Add a fabfile for automated deploys"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_git_tag_the_release">11.4. Git Tag the Release</h3>
<div class="paragraph">
<p>One
final bit of admin.  In order to preserve a historical marker,
we&#8217;ll use Git tags to mark the state of the codebase that reflects
what&#8217;s currently live on the server:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>git tag LIVE</strong>
$ <strong>export TAG=$(date +DEPLOYED-%F/%H%M)</strong>  # this generates a timestamp
$ <strong>echo $TAG</strong> # should show "DEPLOYED-" and then the timestamp
$ <strong>git tag $TAG</strong>
$ <strong>git push origin LIVE $TAG</strong> # pushes the tags up</pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s easy, at any time, to check what the difference is between
our current codebase and what&#8217;s live on the servers.  This will come
in useful in a few chapters, when we look at database migrations. Have
a look at the tag in the history:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git log --graph --oneline --decorate</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Anyway, you now have a live website!  Tell all your friends!  Tell your mum, if
no one else is interested!  And, in the next chapter, it&#8217;s back to coding
again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_further_reading">11.5. Further Reading</h3>
<div class="paragraph">
<p>There&#8217;s
no such thing as the One True Way in deployment, and I&#8217;m no grizzled
expert in any case.  I&#8217;ve tried to set you off on a reasonably sane path, but
there&#8217;s plenty of things you could do differently, and lots, lots more to learn
besides.  Here are some resources I used for inspiration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://hynek.me/talks/python-deployments">Solid Python Deployments for Everybody</a> by Hynek Schlawack</p>
</li>
<li>
<p><a href="http://bit.ly/U6tUo5">Git-based fabric deployments are awesome</a> by Dan Bravender</p>
</li>
<li>
<p>The deployment chapter of <a href="#twoscoops">Two Scoops of Django</a> by Dan
Greenfeld and Audrey Roy</p>
</li>
<li>
<p><a href="http://12factor.net/">The 12-factor App</a> by the Heroku team</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_automating_provisioning_with_ansible">11.5.1. Automating Provisioning with Ansible</h4>
<div class="paragraph">
<p>For some ideas on how you might go about automating the provisioning step,
and an alternative to Fabric called Ansible, go check out <a href="#appendix3">Provisioning with Ansible</a>.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Automated Deployments</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fabric</dt>
<dd>
<p>    Fabric
lets you run commands on servers from inside Python scripts. This
    is a great tool for automating server admin tasks.</p>
</dd>
<dt class="hdlist1">Idempotency</dt>
<dd>
<p>    If
your deployment script is deploying to existing servers, you need to
    design them so that they work against a fresh installation <em>and</em> against
    a server that&#8217;s already configured.</p>
</dd>
<dt class="hdlist1">Keep config files under source control</dt>
<dd>
<p>Make sure your only copy of a config file isn&#8217;t on the server!  They
are critical to your application, and should be under version control
like anything else.</p>
</dd>
<dt class="hdlist1">Automating provisioning</dt>
<dd>
<p>Ultimately, <em>everything</em> should be automated, and that includes spinning up
brand new servers and ensuring they have all the right software installed.
This will involve interacting with the API of your hosting provider.</p>
</dd>
<dt class="hdlist1">Configuration management tools</dt>
<dd>
<p>    Fabric
is very flexible, but its logic is still based on scripting. More
    advanced tools take a more "declarative" approach, and can make your life
    even easier.  Ansible and Vagrant are two worth checking out (see
    <a href="#appendix3">Provisioning with Ansible</a>), but there are many more (Chef, Puppet, Salt, Juju&#8230;&#8203;).</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_organising_test_files">12. Splitting Our Tests into Multiple Files, and a Generic Wait Helper</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back to local development!  The next feature we might like to implement is a
little input validation. But as we start writing new tests, we&#8217;ll notice that
it&#8217;s getting hard to find our way around a single <em>functional_tests.py</em>, and
<em>tests.py</em>, so we&#8217;ll reorganise them into multiple files&#8212;&#8203;a little refactor of
our tests, if you will.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also build a generic explicit wait helper.</p>
</div>
<div class="sect2">
<h3 id="_start_on_a_validation_ft_preventing_blank_items">12.1. Start on a Validation FT: Preventing Blank Items</h3>
<div class="paragraph">
<p>As
our first few users start using the site, we&#8217;ve noticed they sometimes make
mistakes that mess up their lists, like accidentally submitting blank list
items, or inputting two identical items to a list.  Computers are meant to help
stop us from making silly mistakes, so let&#8217;s see if we can get our site to
help.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the outline of an FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch11l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_cannot_add_empty_list_items(self):
    # Edith goes to the home page and accidentally tries to submit
    # an empty list item. She hits Enter on the empty input box

    # The home page refreshes, and there is an error message saying
    # that list items cannot be blank

    # She tries again with some text for the item, which now works

    # Perversely, she now decides to submit a second blank list item

    # She receives a similar warning on the list page

    # And she can correct it by filling some text in
    self.fail('write me!')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all very well, but before we go any further&#8212;&#8203;our functional tests
file is beginning to get a little crowded.  Let&#8217;s split it out into several
files, in which each has a single test method.</p>
</div>
<div class="paragraph">
<p>Remember that functional tests are closely linked to "user stories". If you
were using some sort of project management tool like an issue tracker, you
might make it so that each file matched one issue or ticket, and its filename
contained the ticket ID.  Or, if you prefer to think about things in terms of
"features", where one feature may have several user stories, then you might
have one file and class for the feature, and several methods for each of its
user stories.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also have one base test class which they can all inherit from.  Here&#8217;s
how to get there step by step.</p>
</div>
<div class="sect3">
<h4 id="_skipping_a_test">12.1.1. Skipping a Test</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re back to local development now.  Double check that the
    <code>STAGING_SERVER</code> environment variable is unset in your terminal.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s
always nice, when doing refactoring, to have a fully passing test suite.
We&#8217;ve just written a test with a deliberate failure. Let&#8217;s temporarily switch
it off, using a decorator called "skip" from <code>unittest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch11l001-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest import skip
[...]

    @skip
    def test_cannot_add_empty_list_items(self):</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This tells the test runner to ignore this test.  You can see it works&#8212;&#8203;if we
rerun the tests, it&#8217;ll say it passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
Ran 4 tests in 11.577s
OK</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Skips are dangerous&#8212;&#8203;you need to remember to remove them before you
    commit your changes back to the repo.  This is why line-by-line reviews of
    each of your diffs are a good idea!
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Don&#8217;t Forget the "Refactor" in "Red, Green, Refactor"</div>
<div class="paragraph">
<p>A
criticism that&#8217;s sometimes levelled at TDD is that it leads to badly
architected code, as the developer just focuses on getting tests to pass
rather than stopping to think about how the whole system should be designed.
I think it&#8217;s slightly unfair.</p>
</div>
<div class="paragraph">
<p><em>TDD is no silver bullet</em>. You still have to spend time thinking about good
design.  But what often happens is that people forget the "Refactor" in "Red,
Green, Refactor". The methodology allows you to throw together any old code to
get your tests to pass, but it <em>also</em> asks you to then spend some time
refactoring it to improve its design.  Otherwise, it&#8217;s too easy to allow
<a href="https://martinfowler.com/bliki/TechnicalDebtQuadrant.html">"technical debt"</a>
to build up.</p>
</div>
<div class="paragraph">
<p>Often, however, the best ideas for how to refactor code don&#8217;t occur to you
straight away. They may occur to you days, weeks, even months after you
wrote a piece of code, when you&#8217;re working on something totally unrelated
and you happen to see some old code again with fresh eyes. But if you&#8217;re
halfway through something else, should you stop to refactor the old code?</p>
</div>
<div class="paragraph">
<p>The answer is that it depends.  In the case at the beginning of the chapter,
we haven&#8217;t even started writing our new code. We know we are in a working
state, so we can justify putting a skip on our new FT (to get back to fully
passing tests) and do a bit of refactoring straight away.</p>
</div>
<div class="paragraph">
<p>Later in the chapter we&#8217;ll spot other bits of code we want to alter.
In those cases, rather than taking the risk of refactoring an application
that&#8217;s not in a working state, we&#8217;ll make a note of the thing we want to
change on our scratchpad and wait until we&#8217;re back to a fully passing test
suite before refactoring.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_splitting_functional_tests_out_into_many_files">12.1.2. Splitting Functional Tests Out into Many Files</h4>
<div class="paragraph">
<p>We
start putting each test into its own class, still in the same file:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/tests.py (ch11l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class FunctionalTest(StaticLiveServerTestCase):

    def setUp(self):
        [...]
    def tearDown(self):
        [...]
    def wait_for_row_in_list_table(self, row_text):
        [...]


class NewVisitorTest(FunctionalTest):

    def test_can_start_a_list_for_one_user(self):
        [...]
    def test_multiple_users_can_start_lists_at_different_urls(self):
        [...]


class LayoutAndStylingTest(FunctionalTest):

    def test_layout_and_styling(self):
        [...]



class ItemValidationTest(FunctionalTest):

    @skip
    def test_cannot_add_empty_list_items(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point we can rerun the FTs and see they all still work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 11.577s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s labouring it a little bit, and we could probably get away with doing this
stuff in fewer steps, but, as I keep saying, practising the step-by-step method
on the easy cases makes it that much easier when we have a complex case.</p>
</div>
<div class="paragraph">
<p>Now we switch from a single tests file to using one for each class, and one
"base" file to contain the base class all the tests will inherit from.  We&#8217;ll
make four copies of <em>tests.py</em>, naming them appropriately, and then delete the
parts we don&#8217;t need from each:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git mv functional_tests/tests.py functional_tests/base.py</strong>
$ <strong>cp functional_tests/base.py functional_tests/test_simple_list_creation.py</strong>
$ <strong>cp functional_tests/base.py functional_tests/test_layout_and_styling.py</strong>
$ <strong>cp functional_tests/base.py functional_tests/test_list_item_validation.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p><em>base.py</em> can be cut down to just the <code>FunctionalTest</code> class.  We leave the
helper method on the base class, because we suspect we&#8217;re about to reuse
it in our new FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch11l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import os
from django.contrib.staticfiles.testing import StaticLiveServerTestCase
from selenium import webdriver
from selenium.common.exceptions import WebDriverException
import time

MAX_WAIT = 10



class FunctionalTest(StaticLiveServerTestCase):

    def setUp(self):
        [...]
    def tearDown(self):
        [...]
    def wait_for_row_in_list_table(self, row_text):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Keeping helper methods in a base <code>FunctionalTest</code> class is one useful way
    of preventing duplication in FTs.  Later in the book (in
    <a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>) we&#8217;ll use the "Page pattern", which is related,
    but prefers composition over inheritance&#8212;&#8203;always a good thing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our first FT is now in its own file, and should be just one class and one test
method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_simple_list_creation.py (ch11l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from .base import FunctionalTest
from selenium import webdriver
from selenium.webdriver.common.keys import Keys


class NewVisitorTest(FunctionalTest):

    def test_can_start_a_list_for_one_user(self):
        [...]
    def test_multiple_users_can_start_lists_at_different_urls(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I used a relative import (<code>from .base</code>). Some people like to use them a lot
in Django code (e.g., your views might import models using <code>from .models import
List</code>, instead of <code>from list.models</code>). Ultimately this is a
matter of personal preference.  I prefer to use relative imports only when I&#8217;m
super-super sure that the relative position of the thing I&#8217;m importing won&#8217;t
change.  That applies in this case because I know for sure all the tests will
sit next to <em>base.py</em>, which they inherit from.</p>
</div>
<div class="paragraph">
<p>The layout and styling FT should now be one file and one class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_layout_and_styling.py (ch11l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium.webdriver.common.keys import Keys
from .base import FunctionalTest


class LayoutAndStylingTest(FunctionalTest):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Lastly our new validation test is in a file of its own too:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium.webdriver.common.keys import Keys
from unittest import skip
from .base import FunctionalTest


class ItemValidationTest(FunctionalTest):

    @skip
    def test_cannot_add_empty_list_items(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we can test that everything worked by rerunning <code>manage.py test
functional_tests</code>, and checking once again that all four tests are run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 4 tests in 11.577s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now
we can remove our skip:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemValidationTest(FunctionalTest):

    def test_cannot_add_empty_list_items(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_a_single_test_file">12.1.3. Running a Single Test File</h4>
<div class="paragraph">
<p>As
a side bonus, we&#8217;re now able to run an individual test file, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
AssertionError: write me!</pre>
</div>
</div>
<div class="paragraph">
<p>Brilliant&#8212;&#8203;no need to sit around waiting for all the FTs when we&#8217;re only
interested in a single one. Although we need to remember to run all of them
now and again, to check for regressions.  Later in the book we&#8217;ll see how
to give that task over to an automated Continuous Integration loop. For now
let&#8217;s commit!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "Moved Fts into their own individual files"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Great.  We&#8217;ve split our functional tests nicely out into different files.
Next we&#8217;ll start writing our FT, but before long, as you may be guessing,
we&#8217;ll do something similar to our unit test files.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_new_functional_test_tool_a_generic_explicit_wait_helper">12.2. A New Functional Test Tool: A Generic Explicit Wait Helper</h3>
<div class="paragraph">
<p>First
let&#8217;s start implementing the test, or at least the beginning of it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_cannot_add_empty_list_items(self):
    # Edith goes to the home page and accidentally tries to submit
    # an empty list item. She hits Enter on the empty input box
    self.browser.get(self.live_server_url)
    self.browser.find_element_by_id('id_new_item').send_keys(Keys.ENTER)

    # The home page refreshes, and there is an error message saying
    # that list items cannot be blank
    self.assertEqual(
        self.browser.find_element_by_css_selector('.has-error').text,  <i class="conum" data-value="1"></i><b>(1)</b>
        "You can't have an empty list item"  <i class="conum" data-value="2"></i><b>(2)</b>
    )

    # She tries again with some text for the item, which now works
    self.fail('finish this test!')
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is how we might write the test naively:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We specify we&#8217;re going to use a CSS class called <code>.has-error</code> to mark our
error text.  We&#8217;ll see that Bootstrap has some useful styling for those.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And we can check that our error displays the message we want.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But can you guess what the potential problem is with the test as it&#8217;s written
now?</p>
</div>
<div class="paragraph">
<p>OK, I gave it away in the section header, but whenever we do something
that causes a page refresh, we need an explicit wait; otherwise, Selenium
might go looking for the <code>.has-error</code> element before the page has had a
chance to load.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Whenever you submit a form with <code>Keys.ENTER</code> or click something that
    is going to cause a page to load, you probably want an explicit wait
    for your next assertion.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our first explicit wait was built into a helper method.  For this one, we
might decide that building a specific helper method is overkill at this stage,
but it might be nice to have some generic way of saying, in our tests, "wait
until this assertion passes".  Something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
    # The home page refreshes, and there is an error message saying
    # that list items cannot be blank
    self.wait_for(lambda: self.assertEqual(  <i class="conum" data-value="1"></i><b>(1)</b>
        self.browser.find_element_by_css_selector('.has-error').text,
        "You can't have an empty list item"
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Rather than calling the assertion directly, we wrap it in a lambda
function, and we pass it to a new helper method we imagine called
<code>wait_for</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve never seen lambda functions in Python before, see <a href="#lamdbafunct">Lambda Functions</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So how would this magical <code>wait_for</code> method work?  Let&#8217;s head over to
<em>base.py</em>, and make a copy of our existing <code>wait_for_row_in_list_table</code> method,
and we&#8217;ll adapt it slightly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch11l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def wait_for(self, fn):  <i class="conum" data-value="1"></i><b>(1)</b>
        start_time = time.time()
        while True:
            try:
                table = self.browser.find_element_by_id('id_list_table')  <i class="conum" data-value="2"></i><b>(2)</b>
                rows = table.find_elements_by_tag_name('tr')
                self.assertIn(row_text, [row.text for row in rows])
                return
            except (AssertionError, WebDriverException) as e:
                if time.time() - start_time &gt; MAX_WAIT:
                    raise e
                time.sleep(0.5)</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We make a copy of the method, but we name it <code>wait_for</code>, and we change its
argument.  It is expecting to be passed a function.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For now we&#8217;ve still got the old code that&#8217;s checking table rows.  How to
transform this into something that works for any generic <code>fn</code> that&#8217;s been
passed in?</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Like this:</p>
</div>
<div id="self.wait-for" class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch11l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def wait_for(self, fn):
        start_time = time.time()
        while True:
            try:
                return fn()  <i class="conum" data-value="1"></i><b>(1)</b>
            except (AssertionError, WebDriverException) as e:
                if time.time() - start_time &gt; MAX_WAIT:
                    raise e
                time.sleep(0.5)</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The body of our try/except, instead of being the specific code for
examining table rows, just becomes a call to the function we passed
in.  We also <code>return</code> its return value to be able to exit the loop
immediately if no exception is raised.</td>
</tr>
</table>
</div>
<div id="lamdbafunct" class="sidebarblock">
<div class="content">
<div class="title">Lambda Functions</div>
<div class="paragraph">
<p><code>lambda</code> in Python
is the syntax for making a one-line, throwaway function&#8212;&#8203;it
saves you from having to use <code>def..():</code> and an indented block:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; myfn = lambda x: x+1
&gt;&gt;&gt; myfn(2)
3
&gt;&gt;&gt; myfn(5)
6
&gt;&gt;&gt; adder = lambda x, y: x + y
&gt;&gt;&gt; adder(3, 2)
5</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our case, we&#8217;re using it to transform a bit of code that would otherwise be
executed immediately into a function that we can pass as an argument, and that
can be executed later, and multiple times:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; def addthree(x):
...     return x + 3
...
&gt;&gt;&gt; addthree(2)
5
&gt;&gt;&gt; myfn = lambda: addthree(2)  # note addthree is not called immediately here
&gt;&gt;&gt; myfn
&lt;function &lt;lambda&gt; at 0x7f3b140339d8&gt;
&gt;&gt;&gt; myfn()
5
&gt;&gt;&gt; myfn()
5</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see our funky <code>wait_for</code> helper in action:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
======================================================================
ERROR: test_cannot_add_empty_list_items
(functional_tests.test_list_item_validation.ItemValidationTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_list_item_validation.py", line
15, in test_cannot_add_empty_list_items
    self.wait_for(lambda: self.assertEqual(  <i class="conum" data-value="1"></i><b>(1)</b>
  File "...python-tdd-book/functional_tests/base.py", line 37, in wait_for
    raise e  <i class="conum" data-value="2"></i><b>(2)</b>
  File "...python-tdd-book/functional_tests/base.py", line 34, in wait_for
    return fn()  <i class="conum" data-value="2"></i><b>(2)</b>
  File "...python-tdd-book/functional_tests/test_list_item_validation.py", line
16, in &lt;lambda&gt;  <i class="conum" data-value="3"></i><b>(3)</b>
    self.browser.find_element_by_css_selector('.has-error').text,  <i class="conum" data-value="3"></i><b>(3)</b>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error
 ---------------------------------------------------------------------
Ran 1 test in 10.575s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>The order of the traceback is a little confusing, but we can more or less follow
through what happened:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>At line 15 in our FT, we go into our <code>self.wait_for</code> helper, passing it the
<code>lambda</code>-ified version of the <code>assertEqual</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We go into <code>self.wait_for</code> in <em>base.py</em>, where we can see that we&#8217;ve called
the <code>lambda</code>, enough times that we&#8217;ve dropped out to the <code>raise e</code> because
our timeout expired.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>To explain where the exception has actually come from, the traceback takes us
back into <em>test_list_item_validation.py</em> and inside the body of the <code>lambda</code>
function, and tells us that it was trying to find the <code>.has-error</code> element
that failed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re
into the realm of functional programming now, passing functions as
arguments to other functions, and it can be a little mind-bending.  I know
it took me a little while to get used to!  Have a couple of read-throughs
of this code, and the code back in the FT, to let it sink in;  and if you&#8217;re
still confused, don&#8217;t worry about it too much, and let your confidence grow
from working with it.  We&#8217;ll use it a few more times in this book and make it
even more functionally fun, you&#8217;ll see.</p>
</div>
</div>
<div class="sect2">
<h3 id="_finishing_off_the_ft">12.3. Finishing Off the FT</h3>
<div class="paragraph">
<p>We&#8217;ll finish off the FT like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # The home page refreshes, and there is an error message saying
    # that list items cannot be blank
    self.wait_for(lambda: self.assertEqual(
        self.browser.find_element_by_css_selector('.has-error').text,
        "You can't have an empty list item"
    ))

    # She tries again with some text for the item, which now works
    self.browser.find_element_by_id('id_new_item').send_keys('Buy milk')
    self.browser.find_element_by_id('id_new_item').send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Buy milk')

    # Perversely, she now decides to submit a second blank list item
    self.browser.find_element_by_id('id_new_item').send_keys(Keys.ENTER)

    # She receives a similar warning on the list page
    self.wait_for(lambda: self.assertEqual(
        self.browser.find_element_by_css_selector('.has-error').text,
        "You can't have an empty list item"
    ))

    # And she can correct it by filling some text in
    self.browser.find_element_by_id('id_new_item').send_keys('Make tea')
    self.browser.find_element_by_id('id_new_item').send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Buy milk')
    self.wait_for_row_in_list_table('2: Make tea')</code></pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Helper Methods in FTs</div>
<div class="paragraph">
<p>We&#8217;ve
got two helper methods now, our generic <code>self.wait_for</code> helper, and
<code>wait_for_row_in_list_table</code>.  The former is a general utility&#8212;&#8203;any of our
FTs might need to do a wait.</p>
</div>
<div class="paragraph">
<p>The second also helps prevent duplication across your functional test code.
The day we decide to change the implementation of how our list table works, we
want to make sure we only have to change our FT code in one place, not in
dozens of places across loads of FTs&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>See also <a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a> and <a href="#appendix_bdd">Behaviour-Driven Development (BDD)</a> for more on structuring
your FT code.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll let you do your own "first-cut FT" commit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_unit_tests_into_several_files">12.4. Refactoring Unit Tests into Several Files</h3>
<div class="paragraph">
<p>When
we (finally!) start coding our solution, we&#8217;re going to want to add
another test for our <em>models.py</em>. Before we do so, it&#8217;s time to tidy up our
unit tests in a similar way to the functional tests.</p>
</div>
<div class="paragraph">
<p>A difference will be that, because the <code>lists</code> app contains real application
code as well as tests, we&#8217;ll separate out the tests into their own folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir lists/tests</strong>
$ <strong>touch lists/tests/__init__.py</strong>
$ <strong>git mv lists/tests.py lists/tests/test_all.py</strong>
$ <strong>git status</strong>
$ <strong>git add lists/tests</strong>
$ <strong>python manage.py test lists</strong>
[...]
Ran 9 tests in 0.034s

OK
$ <strong>git commit -m "Move unit tests into a folder with single file"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>If you get a message saying "Ran 0 tests", you probably forgot to add the
dunderinit&#8212;&#8203;it needs to be there or else the tests folder isn&#8217;t a valid Python
package&#8230;&#8203;<sup class="footnote">[<a id="_footnoteref_21" class="footnote" href="#_footnote_21" title="View footnote.">21</a>]</sup></p>
</div>
<div class="paragraph">
<p>Now we turn <em>test_all.py</em> into two files, one called <em>test_views.py</em>, which
will only contains view tests, and one called <em>test_models.py</em>.  I&#8217;ll start
by making two copies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git mv lists/tests/test_all.py lists/tests/test_views.py</strong>
$ <strong>cp lists/tests/test_views.py lists/tests/test_models.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And strip <em>test_models.py</em> down to being just the one test&#8212;&#8203;it means
it needs far fewer imports:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch11l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase
from lists.models import Item, List


class ListAndItemModelsTest(TestCase):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Whereas <em>test_views.py</em>  just loses one class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">--- a/lists/tests/test_views.py
+++ b/lists/tests/test_views.py
@@ -103,34 +104,3 @@ class ListViewTest(TestCase):
         self.assertNotContains(response, 'other list item 1')
         self.assertNotContains(response, 'other list item 2')

-
-
-class ListAndItemModelsTest(TestCase):
-
-    def test_saving_and_retrieving_items(self):
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We rerun the tests to check that everything is still there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 9 tests in 0.040s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great!   That&#8217;s another small, working step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add lists/tests</strong>
$ <strong>git commit -m "Split out unit tests into two files"</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some people like to make their unit tests into a tests folder straight
    away, as soon as they start a project. That&#8217;s a perfectly good idea; I just
    thought I&#8217;d wait until it became necessary, to avoid doing too much
    housekeeping all in the first chapter!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Well, that&#8217;s our FTs and unit test nicely reorganised.  In the next chapter
we&#8217;ll get down to some validation proper.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Tips on Organising Tests and Refactoring</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Use a tests folder</dt>
<dd>
<p>Just
as you use multiple files to hold your application code, you should
split your tests out into multiple files.</p>
<div class="ulist">
<ul>
<li>
<p>For functional tests, group them into tests for a particular feature or
user story.</p>
</li>
<li>
<p>For unit tests, use a folder called <em>tests</em>, with a <i>__init__.py</i>.</p>
</li>
<li>
<p>You probably want a separate test file for each tested source code
file. For Django, that&#8217;s typically <em>test_models.py</em>, <em>test_views.py</em>, and
<em>test_forms.py</em>.</p>
</li>
<li>
<p>Have at least a placeholder test for <em>every</em> function and class.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Don&#8217;t forget the "Refactor" in "Red, Green, Refactor"</dt>
<dd>
<p>The
whole point of having tests is to allow you to refactor your code!
Use them, and make your code (including your tests) as clean as you can.</p>
</dd>
<dt class="hdlist1">Don&#8217;t refactor against failing tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In general!</p>
</li>
<li>
<p>But the FT you&#8217;re currently working on doesn&#8217;t count.</p>
</li>
<li>
<p>You can occasionally put a skip on a test which is testing something you
haven&#8217;t written yet.</p>
</li>
<li>
<p>More commonly, make a note of the refactor you want to do, finish what
you&#8217;re working on, and do the refactor a little later, when you&#8217;re back
to a working state.</p>
</li>
<li>
<p>Don&#8217;t forget to remove any skips before you commit your code! You should
always review your diffs line by line to catch things like this.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Try a generic wait_for helper</dt>
<dd>
<p>Having
specific helper methods that do explicit waits is great, and it
helps to make your tests readable.  But you&#8217;ll also often need an ad-hoc
one-line assertion or Selenium interaction that you&#8217;ll want to add a wait
to.  <code>self.wait_for</code> does the job well for me, but you might find a slightly
different pattern works for you.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_database_layer_validation">13. Validation at the Database Layer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Over
the next few chapters we&#8217;ll talk about testing and implementing validation
of user inputs.</p>
</div>
<div class="paragraph">
<p>In terms of content, there&#8217;s going to be quite a lot of material here that&#8217;s
more about the specifics of Django, and less discussion of TDD philosophy. That
doesn&#8217;t mean you won&#8217;t be learning anything about testing&#8212;&#8203;there are plenty of
little testing tidbits in here, but perhaps it&#8217;s more about really getting into
the swing of things, the rhythm of TDD, and how we get work done.</p>
</div>
<div class="paragraph">
<p>Once we get through these three short chapters, I&#8217;ve saved a bit of fun with
JavaScript (!) for the end of <a href="#part2">[part2]</a>. Then it&#8217;s on to <a href="#part3">[part3]</a>, where I
promise we&#8217;ll get right back into some of the real nitty-gritty discussions in
TDD methodology&#8212;&#8203;unit tests versus integrated tests, mocking, and more.  Stay tuned!</p>
</div>
<div class="paragraph">
<p>But for now, a little validation. Let&#8217;s just remind ourselves where our FT is
pointing us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_list_item_validation</strong>
[...]
======================================================================
ERROR: test_cannot_add_empty_list_items
(functional_tests.test_list_item_validation.ItemValidationTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_list_item_validation.py", line
15, in test_cannot_add_empty_list_items
    self.wait_for(lambda: self.assertEqual(
[...]
  File "...python-tdd-book/functional_tests/test_list_item_validation.py", line
16, in &lt;lambda&gt;
    self.browser.find_element_by_css_selector('.has-error').text,
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s expecting to see an error message if the user tries to input an empty
item.</p>
</div>
<div class="sect2">
<h3 id="_model_layer_validation">13.1. Model-Layer Validation</h3>
<div class="paragraph">
<p>In
a web app, there are two places you can do validation: on the client side
(using JavaScript or HTML5 properties, as we&#8217;ll see later), and on the
server side.  The server side is "safer" because someone can always bypass
the client side, whether it&#8217;s maliciously or due to some bug.</p>
</div>
<div class="paragraph">
<p>Similarly on the server side, in Django, there are two levels at which you can
do validation. One is at the model level, and the other is higher up
at the forms level.  I like to use the lower level whenever possible, partially
because I&#8217;m a bit too fond of databases and database integrity rules, and
partially because, again, it&#8217;s safer&#8212;&#8203;you can sometimes forget which form you
use to validate input, but you&#8217;re always going to use the same database.</p>
</div>
<div class="sect3">
<h4 id="_the_self_assertraises_context_manager">13.1.1. The self.assertRaises Context Manager</h4>
<div class="paragraph">
<p>Let&#8217;s
go down and write a unit test at the models layer. Add a new test method
to <code>ListAndItemModelsTest</code>, which tries to create a blank list item.  This test
is interesting because it&#8217;s testing that the code under test should raise an
exception:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch11l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core.exceptions import ValidationError
[...]

class ListAndItemModelsTest(TestCase):
    [...]

    def test_cannot_save_empty_list_items(self):
        list_ = List.objects.create()
        item = Item(list=list_, text='')
        with self.assertRaises(ValidationError):
            item.save()</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If
you&#8217;re new to Python, you may never have seen the <code>with</code> statement.
    It&#8217;s used with what are called "context managers", which wrap a block of
    code, usually with some kind of setup, cleanup, or error-handling code.
    There&#8217;s a good write-up in the
    <a href="http://docs.python.org/release/2.5/whatsnew/pep-343.html">Python 2.5 release notes</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is a new unit testing technique: when we want to check that doing
something will raise an error, we can use the <code>self.assertRaises</code> context
manager.  We could have used something like this instead:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">try:
    item.save()
    self.fail('The save should have raised an exception')
except ValidationError:
    pass</code></pre>
</div>
</div>
<div class="paragraph">
<p>But the <code>with</code> formulation is neater.  Now, we can try running the test,
and see its expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    item.save()
AssertionError: ValidationError not raised</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_django_quirk_model_save_doesn_t_run_validation">13.1.2. A Django Quirk: Model Save Doesn&#8217;t Run Validation</h4>
<div class="paragraph">
<p>And
now we discover one of Django&#8217;s little quirks. <em>This test should already
pass</em>.  If you take a look at the
<a href="http://bit.ly/SuxPJO">docs for the Django model fields</a>,
you&#8217;ll see that <code>TextField</code> actually defaults to <code>blank=False</code>, which means
that it <em>should</em> disallow empty values.</p>
</div>
<div class="paragraph">
<p>So
why is the test still failing?  Well, for
<a href="http://bit.ly/2v3SfRq">slightly
counterintuitive historical reasons</a>, Django models don&#8217;t run full validation
on save.  As we&#8217;ll see later, any constraints that are actually implemented in
the database will raise errors on save, but SQLite doesn&#8217;t support enforcing
emptiness constraints on text columns, and so our save method is letting this
invalid value through silently.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a way of checking whether the constraint will happen at the database
level or not:  if it was at the database level, we would need a migration to
apply the constraint. But Django knows that SQLite doesn&#8217;t support this type
of constraint, so if we try to run <code>makemigrations</code>, it will report there&#8217;s
nothing to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
No changes detected</pre>
</div>
</div>
<div class="paragraph">
<p>Django
does have a method to manually run full validation, however, called
<code>full_clean</code> (more info in
<a href="http://bit.ly/2u5SIxA">the docs</a>).
Let&#8217;s hack it in to see it work:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    with self.assertRaises(ValidationError):
        item.save()
        item.full_clean()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets the unit test to pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Good. That taught us a little about Django validation, and the test is there to
warn us if we ever forget our requirement and set <code>blank=True</code> on the <code>text</code>
field (try it!).</p>
</div>
<div class="paragraph">
<p>The FTs will still fail though, because we&#8217;re not actually forcing these errors
to appear in our actual app, outside of this one unit test.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_surfacing_model_validation_errors_in_the_view">13.2. Surfacing Model Validation Errors in the View</h3>
<div class="paragraph">
<p>Let&#8217;s
try to enforce our model validation in the views layer and bring it up
through into our templates, so the user can see them. Here&#8217;s how we can
optionally display an error in our HTML&#8212;&#8203;we check whether the template has
been passed an error variable, and if so, we display it next to the form:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch11l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
    &lt;input name="item_text" id="id_new_item"
           class="form-control input-lg"
           placeholder="Enter a to-do item" /&gt;
    {% csrf_token %}
    {% if error %}
      &lt;div class="form-group has-error"&gt;
        &lt;span class="help-block"&gt;{{ error }}&lt;/span&gt;
      &lt;/div&gt;
    {% endif %}
  &lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Take
a look at the <a href="http://getbootstrap.com/css/#forms">Bootstrap docs</a> for more
info on form controls.</p>
</div>
<div class="paragraph">
<p>Passing this error to the template is the job of the view function. Let&#8217;s take
a look at the unit tests in the <code>NewListTest</code> class.  I&#8217;m going to use two
slightly different error-handling patterns here.</p>
</div>
<div class="paragraph">
<p>In the first case, our URL and view for new lists will optionally render the
same template as the home page, but with the addition of an error message.
Here&#8217;s a unit test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):
    [...]

    def test_validation_errors_are_sent_back_to_home_page_template(self):
        response = self.client.post('/lists/new', data={'item_text': ''})
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'home.html')
        expected_error = "You can't have an empty list item"
        self.assertContains(response, expected_error)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As we&#8217;re writing this test, we might get slightly offended by the <em>/lists/new</em>
URL, which we&#8217;re manually entering as a string. We&#8217;ve got a lot of URLs
hardcoded in our tests, in our views, and in our templates, which violates the
DRY principle.  I don&#8217;t mind a bit of duplication in tests, but we should
definitely be on the lookout for hardcoded URLs in our views and templates,
and make a note to refactor them out.  But we won&#8217;t do them straight away,
because right now our application is in a broken state. We want to get back
to a working state first.</p>
</div>
<div class="paragraph">
<p>Back to our test, which is failing because the view is currently returning a
302 redirect, rather than a "normal" 200 response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 302 != 200</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try calling <code>full_clean()</code> in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    list_ = List.objects.create()
    item = Item.objects.create(text=request.POST['item_text'], list=list_)
    item.full_clean()
    return redirect(f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As we&#8217;re looking at the view code, we find a good candidate for a hardcoded
URL to get rid of.  Let&#8217;s add that to our scratchpad:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Now the model validation raises an exception, which comes up through our view:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
  File "...python-tdd-book/lists/views.py", line 11, in new_list
    item.full_clean()
[...]
django.core.exceptions.ValidationError: {'text': ['This field cannot be
blank.']}</pre>
</div>
</div>
<div class="paragraph">
<p>So we try our first approach:  using a <code>try/except</code> to detect errors. Obeying
the Testing Goat, we start with just the <code>try/except</code> and nothing else.  The
tests should tell us what to code next&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core.exceptions import ValidationError
[...]

def new_list(request):
    list_ = List.objects.create()
    item = Item.objects.create(text=request.POST['item_text'], list=list_)
    try:
        item.full_clean()
    except ValidationError:
        pass
    return redirect(f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us back to the 302 != 200:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 302 != 200</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s return a rendered template then, which should take care of the template
check as well:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    except ValidationError:
        return render(request, 'home.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the tests now tell us to put the error message into the template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'You can't have an empty list
item' in response</pre>
</div>
</div>
<div class="paragraph">
<p>We do that by passing a new template variable in:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    except ValidationError:
        error = "You can't have an empty list item"
        return render(request, 'home.html', {"error": error})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hmm, it looks like that didn&#8217;t quite work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: False is not true : Couldn't find 'You can't have an empty list
item' in response</pre>
</div>
</div>
<div class="paragraph">
<p>A little print-based debug&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">expected_error = "You can't have an empty list item"
print(response.content.decode())
self.assertContains(response, expected_error)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;will show us the cause—Django has
<a href="https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#autoescape">HTML-escaped</a>
the apostrophe:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
&lt;span class="help-block"&gt;You can&amp;#39;t have an empty list
item&lt;/span&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>We could hack something like this into our test:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    expected_error = "You can&amp;#39;t have an empty list item"</code></pre>
</div>
</div>
<div class="paragraph">
<p>But using Django&#8217;s helper function is probably a better idea:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l029)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.utils.html import escape
[...]

        expected_error = escape("You can't have an empty list item")
        self.assertContains(response, expected_error)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That passes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 11 tests in 0.047s

OK</pre>
</div>
</div>
<div class="sect3">
<h4 id="_checking_that_invalid_input_isn_t_saved_to_the_database">13.2.1. Checking That Invalid Input Isn&#8217;t Saved to the Database</h4>
<div class="paragraph">
<p>Before
we go further though, did you notice a little logic error we&#8217;ve allowed
to creep into our implementation?  We&#8217;re currently creating an object, even
if validation fails:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    item = Item.objects.create(text=request.POST['item_text'], list=list_)
    try:
        item.full_clean()
    except ValidationError:
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a new unit test to make sure that empty list items don&#8217;t get
saved:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l030-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):
    [...]

    def test_validation_errors_are_sent_back_to_home_page_template(self):
        [...]

    def test_invalid_list_items_arent_saved(self):
        self.client.post('/lists/new', data={'item_text': ''})
        self.assertEqual(List.objects.count(), 0)
        self.assertEqual(Item.objects.count(), 0)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests/test_views.py", line 40, in
test_invalid_list_items_arent_saved
    self.assertEqual(List.objects.count(), 0)
AssertionError: 1 != 0</pre>
</div>
</div>
<div class="paragraph">
<p>We fix it like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l030-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    list_ = List.objects.create()
    item = Item(text=request.POST['item_text'], list=list_)
    try:
        item.full_clean()
        item.save()
    except ValidationError:
        list_.delete()
        error = "You can't have an empty list item"
        return render(request, 'home.html', {"error": error})
    return redirect(f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Do the FTs pass?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
File "...python-tdd-book/functional_tests/test_list_item_validation.py", line
29, in test_cannot_add_empty_list_items
    self.wait_for(lambda: self.assertEqual(
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="paragraph">
<p>Not quite, but they did get a little further.  Checking <em>line 29</em>, we can
see that we&#8217;ve got past the first part of the test, and are now onto the second
check&#8212;&#8203;that submitting a second empty item also shows an error.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve
got some working code though, so let&#8217;s have a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Adjust new list view to do model validation"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_django_pattern_processing_post_requests_in_the_same_view_as_renders_the_form">13.3. Django Pattern: Processing POST Requests in the Same View as Renders the Form</h3>
<div class="paragraph">
<p>This
time we&#8217;ll use a slightly different approach, one that&#8217;s actually a very
common pattern in Django, which is to use the same view to process POST
requests as to render the form that they come from.  Whilst this doesn&#8217;t fit
the REST-ful URL model quite as well, it has the important advantage that the
same URL can display a form, and display any errors encountered in processing
the user&#8217;s input.</p>
</div>
<div class="paragraph">
<p>The current situation is that we have one view and URL for displaying a list,
and one view and URL for processing additions to that list.  We&#8217;re going to
combine them into one. So, in <em>list.html</em>, our form will have a different
target:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch11l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% block form_action %}/lists/{{ list.id }}/{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Incidentally, that&#8217;s another hardcoded URL.  Let&#8217;s add it to our to-do list,
and while we&#8217;re thinking about it, there&#8217;s one in <em>home.html</em> too:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py</em></p>
</li>
<li>
<p><em>Remove hardcoded URL from forms in list.html and home.html</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>This will immediately break our original functional test, because the
<code>view_list</code> page doesn&#8217;t know how to process POST requests yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this section we&#8217;re performing a refactor at the application level.
    We execute our application-level refactor by changing or adding unit tests,
    and then adjusting our code. We use the functional tests to tell us when
    our refactor is complete and things are back to working as before.  Have
    another look at the diagram from the end of
    <a href="#chapter_philosophy_and_refactoring">What Are We Doing with All These Tests? (And, Refactoring)</a> if you need to get your bearings.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_refactor_transferring_the_new_item_functionality_into_view_list">13.3.1. Refactor: Transferring the new_item Functionality into view_list</h4>
<div class="paragraph">
<p>Let&#8217;s take all the old tests from <code>NewItemTest</code>, the ones that are about saving
POST requests to existing lists, and move them into <code>ListViewTest</code>. As we do
so, we also make them point at the base list URL, instead of <em>&#8230;&#8203;/add_item</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):

    def test_uses_list_template(self):
        [...]

    def test_passes_correct_list_to_template(self):
        [...]

    def test_displays_only_items_for_that_list(self):
        [...]

    def test_can_save_a_POST_request_to_an_existing_list(self):
        other_list = List.objects.create()
        correct_list = List.objects.create()

        self.client.post(
            f'/lists/{correct_list.id}/',
            data={'item_text': 'A new item for an existing list'}
        )

        self.assertEqual(Item.objects.count(), 1)
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'A new item for an existing list')
        self.assertEqual(new_item.list, correct_list)


    def test_POST_redirects_to_list_view(self):
        other_list = List.objects.create()
        correct_list = List.objects.create()

        response = self.client.post(
            f'/lists/{correct_list.id}/',
            data={'item_text': 'A new item for an existing list'}
        )
        self.assertRedirects(response, f'/lists/{correct_list.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>NewItemTest</code> class disappears completely.  I&#8217;ve also changed the
name of the redirect test to make it explicit that it only applies to POST
requests.</p>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_POST_redirects_to_list_view (lists.tests.test_views.ListViewTest)
AssertionError: 200 != 302 : Response didn't redirect as expected: Response
code was 200 (expected 302)
[...]
FAIL: test_can_save_a_POST_request_to_an_existing_list
(lists.tests.test_views.ListViewTest)
AssertionError: 0 != 1</pre>
</div>
</div>
<div class="paragraph">
<p>We change the <code>view_list</code> function to handle two types of request:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l032-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    if request.method == 'POST':
        Item.objects.create(text=request.POST['item_text'], list=list_)
        return redirect(f'/lists/{list_.id}/')
    return render(request, 'list.html', {'list': list_})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 12 tests in 0.047s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can delete the <code>add_item</code> view, since it&#8217;s no longer needed&#8230;&#8203;oops, an
unexpected failure:</p>
</div>
<div class="listingblock dofirst-ch11l032-2">
<div class="content">
<pre>[...]
AttributeError: module 'lists.views' has no attribute 'add_item'</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we&#8217;ve deleted the view, but it&#8217;s still being referred to in
<em>urls.py</em>.  We remove it from there:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py (ch11l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(r'^new$', views.new_list, name='new_list'),
    url(r'^(\d+)/$', views.view_list, name='view_list'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gets us to the <code>OK</code>. Let&#8217;s try a full FT run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
ERROR: test_cannot_add_empty_list_items
[...]

Ran 16 tests in 15.276s
FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re back to the one failure in our new functional test. Our refactor of the
<code>add_item</code> functionality is complete. We should commit there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Refactor list view to handle new item POSTs"</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
So did I break the rule about never refactoring against failing tests?
    In this case, it&#8217;s allowed, because the refactor is required to get our new
    functionality to work.  You should definitely never refactor against
    failing <em>unit</em> tests.  But in my book it&#8217;s OK for the FT for the current
    story you&#8217;re working on to be
    failing.<sup class="footnote">[<a id="_footnoteref_22" class="footnote" href="#_footnote_22" title="View footnote.">22</a>]</sup>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_enforcing_model_validation_in_view_list">13.3.2. Enforcing Model Validation in view_list</h4>
<div class="paragraph">
<p>We still want the addition of items to existing lists to be subject to our
model validation rules. Let&#8217;s write a new unit test for that; it&#8217;s very similar
to the one for the home page, with just a couple of tweaks:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l034)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):
    [...]

    def test_validation_errors_end_up_on_lists_page(self):
        list_ = List.objects.create()
        response = self.client.post(
            f'/lists/{list_.id}/',
            data={'item_text': ''}
        )
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'list.html')
        expected_error = escape("You can't have an empty list item")
        self.assertContains(response, expected_error)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That should fail, because our view currently does not do any validation, and
just redirects for all POSTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(response.status_code, 200)
AssertionError: 302 != 200</pre>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Here&#8217;s an implementation:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    error = None

    if request.method == 'POST':
        try:
            item = Item(text=request.POST['item_text'], list=list_)
            item.full_clean()
            item.save()
            return redirect(f'/lists/{list_.id}/')
        except ValidationError:
            error = "You can't have an empty list item"

    return render(request, 'list.html', {'list': list_, 'error': error})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s not deeply satisfying, is it? There&#8217;s definitely some duplication of code
here; that <code>try/except</code> occurs twice in <em>views.py</em>, and in general things are
feeling clunky.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 13 tests in 0.047s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s wait a bit before we do more refactoring though, because we know we&#8217;re
about to do some slightly different validation coding for duplicate items.
We&#8217;ll just add it to our scratchpad for now:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py</em></p>
</li>
<li>
<p><em>Remove hardcoded URL from forms in list.html and home.html</em></p>
</li>
<li>
<p><em>Remove duplication of validation logic in views</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One
of the reasons that the "three strikes and refactor" rule exists is
    that, if you wait until you have three use cases, each might be slightly
    different, and it gives you a better view for what the common functionality
    is. If you refactor too early, you may find that the third use case doesn&#8217;t
    quite fit with your refactored code&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At least our functional tests are back to passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re back to a working state, so we can take a look at some of the items on
our scratchpad.  This would be a good time for a commit. And possibly a
tea break.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "enforce model validation in list view"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactor_removing_hardcoded_urls">13.4. Refactor: Removing Hardcoded URLs</h3>
<div class="paragraph">
<p>Do
you remember those <code>name=</code> parameters in <em>urls.py</em>? We just copied
them across from the default example Django gave us, and I&#8217;ve been giving
them some reasonably descriptive names. Now we find out what they&#8217;re for:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    url(r'^new$', views.new_list, name='new_list'),
    url(r'^(\d+)/$', views.view_list, name='view_list'),</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_url_template_tag">13.4.1. The {% url %} Template Tag</h4>
<div class="paragraph">
<p>We can replace the hardcoded URL in <em>home.html</em> with a Django template tag
which refers to the URL&#8217;s "name":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/home.html (ch11l036-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% block form_action %}{% url 'new_list' %}{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We check that this doesn&#8217;t break the unit tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s do the other template.  This one is more interesting, because we pass it
a <span class="keep-together">parameter</span>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch11l036-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% block form_action %}{% url 'view_list' list.id %}{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>See the
<a href="http://bit.ly/2uKaMzA">Django
docs on reverse URL resolution</a> for more info. We run the tests again, and check that they all pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
OK
$ <strong>python manage.py test functional_tests</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Excellent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Refactor hard-coded URLs out of templates"</strong></pre>
</div>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Remove hardcoded URLs from views.py</em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove hardcoded URL from forms in list.html and home.html</span></em></p>
</li>
<li>
<p><em>Remove duplication of validation logic in views</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_get_absolute_url_for_redirects">13.4.2. Using get_absolute_url for Redirects</h4>
<div class="paragraph">
<p>Now
let&#8217;s tackle <em>views.py</em>. One way of doing it is just like in the
template, passing in the name of the URL and a positional argument:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l036-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    [...]
    return redirect('view_list', list_.id)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That would get the unit and functional tests passing, but the <code>redirect</code>
function can do even better magic than that!  In Django, because model objects
are often associated with a particular URL, you can define a special function
called <code>get_absolute_url</code> which says what page displays the item.  It&#8217;s useful
in this case, but it&#8217;s also useful in the Django admin (which I don&#8217;t cover in
the book, but you&#8217;ll soon discover for yourself): it will let you jump from
looking at an object in the admin view to looking at the object on the live
site. I&#8217;d always recommend defining a <code>get_absolute_url</code> for a model whenever
there is one that makes sense; it takes no time at all.</p>
</div>
<div class="paragraph">
<p>All it takes is a super-simple unit test in <em>test_models.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch11l036-4)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_get_absolute_url(self):
        list_ = List.objects.create()
        self.assertEqual(list_.get_absolute_url(), f'/lists/{list_.id}/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Which gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'List' object has no attribute 'get_absolute_url'</pre>
</div>
</div>
<div class="paragraph">
<p>The implementation is to use Django&#8217;s <code>reverse</code> function, which
essentially does the reverse of what Django normally does with <em>urls.py</em>
(see the
<a href="https://docs.djangoproject.com/en/1.11/topics/http/urls/#reverse-resolution-of-urls">docs</a>):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch11l036-5)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core.urlresolvers import reverse


class List(models.Model):

    def get_absolute_url(self):
        return reverse('view_list', args=[self.id])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now we can use it in the view&#8212;&#8203;the <code>redirect</code> function just takes the
object we want to redirect to, and it uses <code>get_absolute_url</code> under the
hood automagically!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l036-6)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    [...]
    return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s more info in the
<a href="https://docs.djangoproject.com/en/1.11/topics/http/shortcuts/#redirect">Django
docs</a>.  Quick check that the unit tests still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Then we do the same to <code>view_list</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l036-7)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    [...]

            item.save()
            return redirect(list_)
        except ValidationError:
            error = "You can't have an empty list item"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a full unit test and functional test run to assure ourselves that
everything still works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
OK
$ <strong>python manage.py test functional_tests</strong>
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Cross off our to-dos&#8230;&#8203;</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Remove hardcoded URLs from views.py</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Remove hardcoded URL from forms in list.html and home.html</span></em></p>
</li>
<li>
<p><em>Remove duplication of validation logic in views</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>And a commit&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "Use get_absolute_url on List model to DRY urls in views"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;re done with that bit!    We have working model-layer validation,
and we&#8217;ve taken the opportunity to do a few refactors along the way.</p>
</div>
<div class="paragraph">
<p>That final scratchpad item will be the subject of the next chapter&#8230;&#8203;</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On Database-Layer Validation</div>
<div class="paragraph">
<p>I
always like to push my validation logic down as low as possible.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Validation at the database layer is the ultimate guarantee of data integrity</dt>
<dd>
<p>    It
can ensure that, no matter how complex your code at the layers
    above gets, you have guarantees at the lowest level that your data is
    valid and consistent.</p>
</dd>
<dt class="hdlist1">But it comes at the expense of flexibility</dt>
<dd>
<p>This benefit doesn&#8217;t come for free! It&#8217;s now impossible, even temporarily,
to have inconsistent data.  Sometimes you might have a good reason for temporarily
storing data that breaks the rules rather than storing nothing at all.  Perhaps
you&#8217;re importing data from an external source in several stages, for
example.</p>
</dd>
<dt class="hdlist1">And it&#8217;s not designed for user-friendliness</dt>
<dd>
<p>Trying to store invalid data will cause a nasty <code>IntegrityError</code> to come
back from your database, and possibly the user will see a confusing 500
error page.
As we&#8217;ll see in later chapters, forms-layer validation is designed with the
user in mind, anticipating the kinds of helpful error messages we want to
send them.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_simple_form">14. A Simple Form</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the end of the last chapter, we were left with the thought that there
was too much duplication of code in the validation handling bits of our
views. Django encourages you to use form classes to do the work of validating
user input, and choosing what error messages to display. Let&#8217;s see how that
works.</p>
</div>
<div class="paragraph">
<p>As we go through the chapter, we&#8217;ll also spend a bit of time tidying up our
unit tests, and making sure each of them tests only one thing at a time.</p>
</div>
<div class="sect2">
<h3 id="_moving_validation_logic_into_a_form">14.1. Moving Validation Logic into a Form</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In Django, a complex view is a code smell.  Could some of that logic
    be pushed out to a form?  Or to some custom methods on the model class? Or
    maybe even to a non-Django module that represents your business logic?
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Forms
have several superpowers in Django:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They can process user input and validate it for errors.</p>
</li>
<li>
<p>They can be used in templates to render HTML input elements, and error
messages too.</p>
</li>
<li>
<p>And, as we&#8217;ll see later, some of them can even save data to the database
for you.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You don&#8217;t have to use all three form superpowers in every form.  You may prefer
to roll your own HTML, or do your own saving. But they are an excellent place
to keep validation logic.</p>
</div>
<div class="sect3">
<h4 id="_exploring_the_forms_api_with_a_unit_test">14.1.1. Exploring the Forms API with a Unit Test</h4>
<div class="paragraph">
<p>Let&#8217;s
do a little experimenting with forms by using a unit test.  My plan is to
iterate towards a complete solution, and hopefully introduce forms gradually
enough that they&#8217;ll make sense if you&#8217;ve never seen them before.</p>
</div>
<div class="paragraph">
<p>First we add a new file for our form unit tests, and we start with a test that
just looks at the form HTML:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase

from lists.forms import ItemForm


class ItemFormTest(TestCase):

    def test_form_renders_item_text_input(self):
        form = ItemForm()
        self.fail(form.as_p())</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>form.as_p()</code> renders the form as HTML.  This unit test is using a <code>self.fail</code>
for some exploratory coding.  You could just as easily use a <code>manage.py shell</code>
session, although you&#8217;d need to keep reloading your code for each change.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s make a minimal form.  It inherits from the base <code>Form</code> class, and has
a single field called <code>item_text</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django import forms

class ItemForm(forms.Form):
    item_text = forms.CharField()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We now see a failure message which tells us what the autogenerated form
HTML will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.fail(form.as_p())
AssertionError: &lt;p&gt;&lt;label for="id_item_text"&gt;Item text:&lt;/label&gt; &lt;input
type="text" name="item_text" required id="id_item_text" /&gt;&lt;/p&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s already pretty close to what we have in <em>base.html</em>.  We&#8217;re missing
the placeholder attribute and the Bootstrap CSS classes.  Let&#8217;s make our
unit test into a test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemFormTest(TestCase):

    def test_form_item_input_has_placeholder_and_css_classes(self):
        form = ItemForm()
        self.assertIn('placeholder="Enter a to-do item"', form.as_p())
        self.assertIn('class="form-control input-lg"', form.as_p())</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us a fail which justifies some real coding.  How can we customise
the input for a form field?  Using a "widget".  Here it is with just
the placeholder:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemForm(forms.Form):
    item_text = forms.CharField(
        widget=forms.fields.TextInput(attrs={
            'placeholder': 'Enter a to-do item',
        }),
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'class="form-control input-lg"' not found in '&lt;p&gt;&lt;label
for="id_item_text"&gt;Item text:&lt;/label&gt; &lt;input type="text" name="item_text"
placeholder="Enter a to-do item" required id="id_item_text" /&gt;&lt;/p&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>And then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    widget=forms.fields.TextInput(attrs={
        'placeholder': 'Enter a to-do item',
        'class': 'form-control input-lg',
    }),</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Doing
this sort of widget customisation would get tedious if we
    had a much larger, more complex form.  Check out
    <a href="https://django-crispy-forms.readthedocs.org/">django-crispy-forms</a> and
    <a href="http://bit.ly/1rR5eyD">django-floppyforms</a> for some help.
</td>
</tr>
</table>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Development-Driven Tests: Using Unit Tests for Exploratory Coding</div>
<div class="paragraph">
<p>Does
this feel a bit like development-driven tests?  That&#8217;s OK, now
and again.</p>
</div>
<div class="paragraph">
<p>When you&#8217;re exploring a new API, you&#8217;re absolutely allowed to mess about with
it for a while before you get back to rigorous TDD.  You might use the
interactive console, or write some exploratory code (but you have to promise
the Testing Goat that you&#8217;ll throw it away and rewrite it properly later).</p>
</div>
<div class="paragraph">
<p>Here we&#8217;re actually using a unit test as a way of experimenting with the
forms API. It&#8217;s actually a pretty good way of learning how it works.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_switching_to_a_django_modelform">14.1.2. Switching to a Django ModelForm</h4>
<div class="paragraph">
<p>What&#8217;s
next?  We want our form to reuse the validation code that we&#8217;ve already
defined on our model.  Django provides a special class which can autogenerate
a form for a model, called <code>ModelForm</code>.  As you&#8217;ll see, it&#8217;s configured using a
special attribute called <code>Meta</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django import forms

from lists.models import Item

class ItemForm(forms.models.ModelForm):

    class Meta:
        model = Item
        fields = ('text',)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In <code>Meta</code> we specify which model the form is for, and which fields we want it
to use.</p>
</div>
<div class="paragraph">
<p><code>ModelForm</code>s do all sorts of smart stuff, like assigning sensible HTML
form input types to different types of field, and applying default
validation.  Check out the
<a href="https://docs.djangoproject.com/en/1.11/topics/forms/modelforms/">docs</a> for more
info.</p>
</div>
<div class="paragraph">
<p>We now have some different-looking form HTML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'placeholder="Enter a to-do item"' not found in '&lt;p&gt;&lt;label
for="id_text"&gt;Text:&lt;/label&gt; &lt;textarea name="text" cols="40" rows="10" required
id="id_text"&gt;\n&lt;/textarea&gt;&lt;/p&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s lost our placeholder and CSS class. But you can also see that it&#8217;s using
<code>name="text"</code> instead of <code>name="item_text"</code>. We can probably live with that.
But it&#8217;s using a <code>textarea</code> instead of a normal input, and that&#8217;s not the UI we
want for our app. Thankfully, you can override widgets for <code>ModelForm</code> fields,
similarly to the way we did it with the normal form:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemForm(forms.models.ModelForm):

    class Meta:
        model = Item
        fields = ('text',)
        widgets = {
            'text': forms.fields.TextInput(attrs={
                'placeholder': 'Enter a to-do item',
                'class': 'form-control input-lg',
            }),
        }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets the test passing.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_and_customising_form_validation">14.1.3. Testing and Customising Form Validation</h4>
<div class="paragraph">
<p>Now let&#8217;s see if the <code>ModelForm</code> has picked up the same validation rules which we
defined on the model.  We&#8217;ll also learn how to pass data into the form, as if
it came from the user:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_form_validation_for_blank_items(self):
        form = ItemForm(data={'text': ''})
        form.save()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: The Item could not be created because the data didn't validate.</pre>
</div>
</div>
<div class="paragraph">
<p>Good: the form won&#8217;t allow you to save if you give it an empty item text.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if we can get it to use the specific error message that we
want.  The API for checking form validation <em>before</em> we try to save any
data is a function called <code>is_valid</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_form_validation_for_blank_items(self):
    form = ItemForm(data={'text': ''})
    self.assertFalse(form.is_valid())
    self.assertEqual(
        form.errors['text'],
        ["You can't have an empty list item"]
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Calling <code>form.is_valid()</code> returns <code>True</code> or <code>False</code>, but it also has the
side effect of validating the input data, and populating the <code>errors</code>
attribute.  It&#8217;s a dictionary mapping the names of fields to lists of
errors for those fields (it&#8217;s possible for a field to have more than
one error).</p>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: ['This field is required.'] != ["You can't have an empty list
item"]</pre>
</div>
</div>
<div class="paragraph">
<p>Django already has a default error message that we could present to the
user&#8212;&#8203;you might use it if you were in a hurry to build your web app,
but we care enough to make our message special.  Customising it means
changing <code>error_messages</code>, another <code>Meta</code> variable:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch11l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    class Meta:
        model = Item
        fields = ('text',)
        widgets = {
            'text': forms.fields.TextInput(attrs={
                'placeholder': 'Enter a to-do item',
                'class': 'form-control input-lg',
            }),
        }
        error_messages = {
            'text': {'required': "You can't have an empty list item"}
        }</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>You know what would be even better than messing about with all these
error strings?  Having a constant:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch11l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">EMPTY_ITEM_ERROR = "You can't have an empty list item"
[...]

        error_messages = {
            'text': {'required': EMPTY_ITEM_ERROR}
        }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the tests to see that they pass&#8230;&#8203;OK.  Now we change the test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import EMPTY_ITEM_ERROR, ItemForm
[...]

    def test_form_validation_for_blank_items(self):
        form = ItemForm(data={'text': ''})
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors['text'], [EMPTY_ITEM_ERROR])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the tests still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great.  Totes committable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong> # should show lists/forms.py and tests/test_forms.py
$ <strong>git add lists</strong>
$ <strong>git commit -m "new form for list items"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_in_our_views">14.2. Using the Form in Our Views</h3>
<div class="paragraph">
<p>I
had originally thought to extend this form to capture uniqueness validation
as well as empty-item validation.  But there&#8217;s a sort of corollary to the
"deploy as early as possible" lean methodology, which is "merge code as early
as possible".  In other words: while building this bit of forms code, it would
be easy to go on for ages, adding more and more functionality to the form&#8212;&#8203;I
should know, because that&#8217;s exactly what I did during the drafting of this
chapter, and I ended up doing all sorts of work making an all-singing,
all-dancing form class before I realised it wouldn&#8217;t really work for our most
basic use case.</p>
</div>
<div class="paragraph">
<p>So, instead, try to use your new bit of code as soon as possible.  This makes
sure you never have unused bits of code lying around, and that you start
checking your code against "the real world" as soon as possible.</p>
</div>
<div class="paragraph">
<p>We have a form class which can render some HTML and do validation of at
least one kind of error&#8212;&#8203;let&#8217;s start using it!  We should be able to use
it in our <em>base.html</em> template, and so in all of our views.</p>
</div>
<div class="sect3">
<h4 id="_using_the_form_in_a_view_with_a_get_request">14.2.1. Using the Form in a View with a GET Request</h4>
<div class="paragraph">
<p>Let&#8217;s
start in our unit tests for the home view. We&#8217;ll add a new method
that checks whether we&#8217;re using the right kind of form:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import ItemForm

class HomePageTest(TestCase):

    def test_uses_home_template(self):
        [...]

    def test_home_page_uses_item_form(self):
        response = self.client.get('/')
        self.assertIsInstance(response.context['form'], ItemForm)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>assertIsInstance</code> checks that our form is of the correct class.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'form'</pre>
</div>
</div>
<div class="paragraph">
<p>So we use the form in our home page view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
from lists.forms import ItemForm
from lists.models import Item, List

def home_page(request):
    return render(request, 'home.html', {'form': ItemForm()})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>OK, now let&#8217;s try using it in the template&#8212;&#8203;we replace the old <code>&lt;input ..&gt;</code>
with <code>{{ form.text }}</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch11l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
    {{ form.text }}
    {% csrf_token %}
    {% if error %}
      &lt;div class="form-group has-error"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>{{ form.text }}</code> renders just the HTML input for the <code>text</code> field of the form.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_big_find_and_replace">14.2.2. A Big Find and Replace</h4>
<div class="paragraph">
<p>One
thing we have done, though, is changed our form&#8212;&#8203;it no longer uses
the same <code>id</code> and <code>name</code> attributes.  You&#8217;ll see if we run our functional
tests that they fail the first time they try to find the input box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_new_item"]</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll need to fix this, and it&#8217;s going to involve a big find and replace.
Before we do that, let&#8217;s do a commit, to keep the rename separate from
the logic change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong> # review changes in base.html, views.py and its tests
$ <strong>git commit -am "use new form in home_page, simplify tests. NB breaks stuff"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s fix the functional tests.  A quick <code>grep</code> shows us there are several
places where we&#8217;re using <code>id_new_item</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep id_new_item functional_tests/test*</strong>
functional_tests/test_layout_and_styling.py:        inputbox =
self.browser.find_element_by_id('id_new_item')
functional_tests/test_layout_and_styling.py:        inputbox =
self.browser.find_element_by_id('id_new_item')
functional_tests/test_list_item_validation.py:
self.browser.find_element_by_id('id_new_item').send_keys(Keys.ENTER)
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a good call for a refactor.  Let&#8217;s make a new helper method
in <em>base.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch11l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class FunctionalTest(StaticLiveServerTestCase):
    [...]
    def get_item_input_box(self):
        return self.browser.find_element_by_id('id_text')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then we use it throughout&#8212;&#8203;I had to make four changes in
<em>test_simple_list_creation.py</em>, two in <em>test_layout_and_styling.py</em>, and six
in <em>test_list_item_validation.py</em>, for example:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch11l020 currentcontents">
<div class="title">functional_tests/test_simple_list_creation.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # She is invited to enter a to-do item straight away
    inputbox = self.get_item_input_box()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">functional_tests/test_list_item_validation.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # an empty list item. She hits Enter on the empty input box
    self.browser.get(self.live_server_url)
    self.get_item_input_box().send_keys(Keys.ENTER)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t show you every single one; I&#8217;m sure you can manage this for
yourself!  You can redo the <code>grep</code> to check that you&#8217;ve caught them all.</p>
</div>
<div class="paragraph">
<p>We&#8217;re past the first step, but now we have to bring the rest of the application
code in line with the change.  We need to find any occurrences of the old <code>id</code>
(<code>id_new_item</code>) and <code>name</code> (<code>item_text</code>) and replace them too, with <code>id_text</code> and
<code>text</code>, respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>grep -r id_new_item lists/</strong>
lists/static/base.css:#id_new_item {</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s one change, and similarly for the <code>name</code>:</p>
</div>
<div class="listingblock dofirst-ch11l021">
<div class="content">
<pre>$ <strong>grep -Ir item_text lists</strong>
[...]
lists/views.py:    item = Item(text=request.POST['item_text'], list=list_)
lists/views.py:            item = Item(text=request.POST['item_text'],
list=list_)
lists/tests/test_views.py:        self.client.post('/lists/new',
data={'item_text': 'A new list item'})
lists/tests/test_views.py:        response = self.client.post('/lists/new',
data={'item_text': 'A new list item'})
[...]
lists/tests/test_views.py:            data={'item_text': ''}
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Once we&#8217;re done, we rerun the unit tests to check that everything still works:</p>
</div>
<div class="listingblock dofirst-ch11l022">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
.................
 ---------------------------------------------------------------------
Ran 17 tests in 0.126s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And the functional tests too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
  File "...python-tdd-book/functional_tests/test_simple_list_creation.py", line
37, in test_can_start_a_list_for_one_user
    return self.browser.find_element_by_id('id_text')
  File "...python-tdd-book/functional_tests/base.py", line 51, in
get_item_input_box
    return self.browser.find_element_by_id('id_text')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [id="id_text"]
[...]
FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Not quite!  Let&#8217;s look at where this is happening&#8212;&#8203;if you check the line
number from one of the failures, you&#8217;ll see that each time after we&#8217;ve
submitted a first item, the input box has disappeared from the lists page.</p>
</div>
<div class="paragraph">
<p>Checking <em>views.py</em> and the <code>new_list</code> view we can see it&#8217;s because if we
detect a validation error, we&#8217;re not actually passing the form to the
<em>home.html</em> template:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">except ValidationError:
    list_.delete()
    error = "You can't have an empty list item"
    return render(request, 'home.html', {"error": error})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll
want to use the form in this view too. Before we make any more changes
though, let&#8217;s do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git commit -am "rename all item input ids and names. still broken"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_in_a_view_that_takes_post_requests">14.3. Using the Form in a View That Takes POST Requests</h3>
<div class="paragraph">
<p>Now
we want to adjust the unit tests for the <code>new_list</code> view, especially the
one that deals with validation. Let&#8217;s take a look at it now:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):
    [...]

    def test_validation_errors_are_sent_back_to_home_page_template(self):
        response = self.client.post('/lists/new', data={'text': ''})
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'home.html')
        expected_error = escape("You can't have an empty list item")
        self.assertContains(response, expected_error)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adapting_the_unit_tests_for_the_new_list_view">14.3.1. Adapting the Unit Tests for the new_list View</h4>
<div class="paragraph">
<p>For a start this test is testing too many things at once, so we&#8217;ve got
an opportunity to clarify things here.  We should split out two different
assertions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there&#8217;s a validation error, we should render the home template, with a 200.</p>
</li>
<li>
<p>If there&#8217;s a validation error, the response should contain our error text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And we can add a new one too:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there&#8217;s a validation error, we should pass our form object to the
template.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we&#8217;ll use our constant instead of the hardcoded string
for that error message:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import ItemForm, EMPTY_ITEM_ERROR
[...]

class NewListTest(TestCase):
    [...]

    def test_for_invalid_input_renders_home_template(self):
        response = self.client.post('/lists/new', data={'text': ''})
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'home.html')


    def test_validation_errors_are_shown_on_home_page(self):
        response = self.client.post('/lists/new', data={'text': ''})
        self.assertContains(response, escape(EMPTY_ITEM_ERROR))


    def test_for_invalid_input_passes_form_to_template(self):
        response = self.client.post('/lists/new', data={'text': ''})
        self.assertIsInstance(response.context['form'], ItemForm)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Much better.  Each test is now clearly testing one thing, and, with a
bit of luck, just one will fail and tell us what to do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
======================================================================
ERROR: test_for_invalid_input_passes_form_to_template
(lists.tests.test_views.NewListTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests/test_views.py", line 49, in
test_for_invalid_input_passes_form_to_template
    self.assertIsInstance(response.context['form'], ItemForm)
[...]
KeyError: 'form'

 ---------------------------------------------------------------------
Ran 19 tests in 0.041s

FAILED (errors=1)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_form_in_the_view">14.3.2. Using the Form in the View</h4>
<div class="paragraph">
<p>And here&#8217;s how we use the form in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)  <i class="conum" data-value="1"></i><b>(1)</b>
    if form.is_valid():  <i class="conum" data-value="2"></i><b>(2)</b>
        list_ = List.objects.create()
        Item.objects.create(text=request.POST['text'], list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We pass the <code>request.POST</code> data into the form&#8217;s constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use <code>form.is_valid()</code> to determine whether this is a good or a
bad <span class="keep-together">submission</span>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In the invalid case, we pass the form down to the template, instead of
our hardcoded error string.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That view is now looking much nicer!  And all our tests pass, except one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertContains(response, escape(EMPTY_ITEM_ERROR))
[...]
AssertionError: False is not true : Couldn't find 'You can&amp;#39;t have an empty
list item' in response</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_form_to_display_errors_in_the_template">14.3.3. Using the Form to Display Errors in the Template</h4>
<div class="paragraph">
<p>We&#8217;re failing because we&#8217;re not yet using the form to display errors in the
template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch11l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
    {{ form.text }}
    {% csrf_token %}
    {% if form.errors %}  <i class="conum" data-value="1"></i><b>(1)</b>
      &lt;div class="form-group has-error"&gt;
        &lt;div class="help-block"&gt;{{ form.text.errors }}&lt;/div&gt;  <i class="conum" data-value="2"></i><b>(2)</b>
      &lt;/div&gt;
    {% endif %}
  &lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>form.errors</code> contains a list of all the errors for the form.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>form.text.errors</code> is a list of just the errors for the <code>text</code> field.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What does that do to our tests?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_validation_errors_end_up_on_lists_page
(lists.tests.test_views.ListViewTest)
[...]
AssertionError: False is not true : Couldn't find 'You can&amp;#39;t have an empty
list item' in response</pre>
</div>
</div>
<div class="paragraph">
<p>An unexpected failure&#8212;&#8203;it&#8217;s actually in the tests for our final view,
<code>view_list</code>.  Because we&#8217;ve changed the way errors are displayed in <em>all</em>
templates, we&#8217;re no longer showing the error that we manually pass into the
template.</p>
</div>
<div class="paragraph">
<p>That means we&#8217;re going to need to rework <code>view_list</code> as well, before we can
get back to a working state.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_in_the_other_view">14.4. Using the Form in the Other View</h3>
<div class="paragraph">
<p>This
view handles both GET and POST requests.  Let&#8217;s start with checking
that the form is used in GET requests.  We can have a new test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):
    [...]

    def test_displays_item_form(self):
        list_ = List.objects.create()
        response = self.client.get(f'/lists/{list_.id}/')
        self.assertIsInstance(response.context['form'], ItemForm)
        self.assertContains(response, 'name="text"')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'form'</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a minimal implementation:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch11l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    [...]
    form = ItemForm()
    return render(request, 'list.html', {
        'list': list_, "form": form, "error": error
    })</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_helper_method_for_several_short_tests">14.4.1. A Helper Method for Several Short Tests</h4>
<div class="paragraph">
<p>Next
we want to use the form errors in the second view.
We&#8217;ll split our current single test for the
invalid case (<code>test_validation_errors_end_up_on_lists_page</code>) into several
separate ones:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch11l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):
    [...]

    def post_invalid_input(self):
        list_ = List.objects.create()
        return self.client.post(
            f'/lists/{list_.id}/',
            data={'text': ''}
        )

    def test_for_invalid_input_nothing_saved_to_db(self):
        self.post_invalid_input()
        self.assertEqual(Item.objects.count(), 0)

    def test_for_invalid_input_renders_list_template(self):
        response = self.post_invalid_input()
        self.assertEqual(response.status_code, 200)
        self.assertTemplateUsed(response, 'list.html')

    def test_for_invalid_input_passes_form_to_template(self):
        response = self.post_invalid_input()
        self.assertIsInstance(response.context['form'], ItemForm)

    def test_for_invalid_input_shows_error_on_page(self):
        response = self.post_invalid_input()
        self.assertContains(response, escape(EMPTY_ITEM_ERROR))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By making a little helper function, <code>post_invalid_input</code>, we can make four
separate tests without duplicating lots of lines of code.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve seen this several times now. It often feels more natural to write view
tests as a single, monolithic block of assertions&#8212;&#8203;the view should do this
and this and this, then return that with this.  But breaking things out into
multiple tests is definitely worthwhile; as we saw in previous chapters, it
helps you isolate the exact problem you may have, when you later come and
change your code and accidentally introduce a bug. Helper methods are one of
the tools that lower the psychological barrier.</p>
</div>
<div class="paragraph">
<p>For example, now we can see there&#8217;s just one failure, and it&#8217;s a clear one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_for_invalid_input_shows_error_on_page
(lists.tests.test_views.ListViewTest)
AssertionError: False is not true : Couldn't find 'You can&amp;#39;t have an empty
list item' in response</pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see if we can properly rewrite the view to use our form.  Here&#8217;s a
first cut:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    form = ItemForm()
    if request.method == 'POST':
        form = ItemForm(data=request.POST)
        if form.is_valid():
            Item.objects.create(text=request.POST['text'], list=list_)
            return redirect(list_)
    return render(request, 'list.html', {'list': list_, "form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets the unit tests passing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 23 tests in 0.086s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>How about the FTs?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_cannot_add_empty_list_items
(functional_tests.test_list_item_validation.ItemValidationTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
File "...python-tdd-book/functional_tests/test_list_item_validation.py", line
15, in test_cannot_add_empty_list_items
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="paragraph">
<p>Nope.</p>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_an_unexpected_benefit_free_client_side_validation_from_html5">14.4.2. An Unexpected Benefit: Free Client-Side Validation from HTML5</h4>
<div class="paragraph">
<p>What&#8217;s
going on here?  Let&#8217;s add our usual <code>time.sleep</code> before the
error, and take a look at what&#8217;s happening (or spin up the site
manually with <code>manage.py runserver</code> if you prefer (see <a href="#fig1401">HTML5 validation says no</a>).</p>
</div>
<div id="fig1401" class="imageblock">
<div class="content">
<img src="images/twp2_1401.png" alt="The input with a popup saying 'please fill out this field'">
</div>
<div class="title">Figure 25. HTML5 validation says no</div>
</div>
<div class="paragraph">
<p>It seems like the browser is preventing the user from even submitting
the input when it&#8217;s empty.</p>
</div>
<div class="paragraph">
<p>It&#8217;s because Django has added the <code>required</code> attribute to the HTML
input<sup class="footnote">[<a id="_footnoteref_23" class="footnote" href="#_footnote_23" title="View footnote.">23</a>]</sup>
(take another look at our <code>as_p()</code> printouts from earlier if you don&#8217;t
believe me).  This is a
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Input#attr-required">new feature of HTML5</a>,
and browsers nowadays will do some validation at the client side if they
see it, preventing users from even submitting invalid input.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s change our FT to reflect that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch11l032)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_cannot_add_empty_list_items(self):
        # Edith goes to the home page and accidentally tries to submit
        # an empty list item. She hits Enter on the empty input box
        self.browser.get(self.live_server_url)
        self.get_item_input_box().send_keys(Keys.ENTER)

        # The browser intercepts the request, and does not load the
        # list page
        self.wait_for(lambda: self.browser.find_elements_by_css_selector(
            '#id_text:invalid'  <i class="conum" data-value="1"></i><b>(1)</b>
        ))

        # She starts typing some text for the new item and the error disappears
        self.get_item_input_box().send_keys('Buy milk')
        self.wait_for(lambda: self.browser.find_elements_by_css_selector(
            '#id_text:valid'  <i class="conum" data-value="2"></i><b>(2)</b>
        ))

        # And she can submit it successfully
        self.get_item_input_box().send_keys(Keys.ENTER)
        self.wait_for_row_in_list_table('1: Buy milk')

        # Perversely, she now decides to submit a second blank list item
        self.get_item_input_box().send_keys(Keys.ENTER)

        # Again, the browser will not comply
        self.wait_for_row_in_list_table('1: Buy milk')
        self.wait_for(lambda: self.browser.find_elements_by_css_selector(
            '#id_text:invalid'
        ))

        # And she can correct it by filling some text in
        self.get_item_input_box().send_keys('Make tea')
        self.wait_for(lambda: self.browser.find_elements_by_css_selector(
            '#id_text:valid'
        ))
        self.get_item_input_box().send_keys(Keys.ENTER)
        self.wait_for_row_in_list_table('1: Buy milk')
        self.wait_for_row_in_list_table('2: Make tea')</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instead of checking for our custom error message, we check using the
CSS pseudoselector <code>:invalid</code>, which the browser applies to any
HTML5 input that has invalid input.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And its converse in the case of valid inputs.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See how useful and flexible our <code>self.wait_for</code> function is turning out to
be?</p>
</div>
<div class="paragraph">
<p>Our
FT does look quite different from how it started though, doesn&#8217;t it? I&#8217;m
sure that&#8217;s raising a lot of questions in your mind right now. Put a pin in
them for a moment; I promise we&#8217;ll talk. Let&#8217;s first see if we&#8217;re back to
passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
....
 ---------------------------------------------------------------------
Ran 4 tests in 12.154s

OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_pat_on_the_back">14.5. A Pat on the Back</h3>
<div class="paragraph">
<p>First let&#8217;s give ourselves a massive pat on the back: we&#8217;ve just made a major
change to our small app&#8212;&#8203;that input field, with its name and ID, is absolutely
critical to making everything work.  We&#8217;ve touched seven or eight different
files, doing a refactor that&#8217;s quite involved&#8230;&#8203;this is the kind of thing that,
without tests, would seriously worry me.  In fact, I might well have decided
that it wasn&#8217;t worth messing with code that works.  But, because we have a full
tests suite, we can delve around, tidying things up, safe in the knowledge
that the tests are there to spot any mistakes we make.  It just makes it that
much likelier that you&#8217;re going to keep refactoring, keep tidying up, keep
gardening, keep tending your code, keep everything neat and tidy and clean and
smooth and precise and concise and functional and good.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Remove duplication of validation logic in
views</span></em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>And it&#8217;s definitely time for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -am "use form in all views, back to working state"</strong></pre>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_but_have_we_wasted_a_lot_of_time">14.6. But Have We Wasted a Lot of Time?</h3>
<div class="paragraph">
<p>But
what about our custom error message?  What about all that effort
rendering the form in our HTML template?  We&#8217;re not even passing those
errors from Django to the user if the browser is intercepting the requests
before the user even makes them?  And our FT isn&#8217;t even testing that stuff
any more!</p>
</div>
<div class="paragraph">
<p>Well, you&#8217;re quite right.  But there are two or three reasons all our time
hasn&#8217;t been wasted.  Firstly, client-side validation isn&#8217;t enough to guarantee
you&#8217;re protected from bad inputs, so you always need the server side as well
if you really care about data integrity; using a form is a nice way of
encapsulating that logic.</p>
</div>
<div class="paragraph">
<p>Also, not all browsers (<em>cough&#8212;&#8203;Safari&#8212;&#8203;cough</em>) fully implement HTML5, so some
users are still going to see our custom error message. And if or when we come
to letting users access our data via an API (see <a href="#appendix_rest_api">Building a REST API: JSON, Ajax, and Mocking with JavaScript</a>), then
our validation messages will come back into use.</p>
</div>
<div class="paragraph">
<p>On top of that, we&#8217;ll be able to reuse all our validation and forms code and
the front-end <code>.has-error</code> classes in the next chapter, when we do some more
advanced validation that can&#8217;t be done by HTML5 magic.</p>
</div>
<div class="paragraph">
<p>But you know, even if all that wasn&#8217;t true, you still can&#8217;t beat yourself up
for occasionally going down a blind alley while you&#8217;re coding.  None of us
can see the future, and we should concentrate on finding the right solution
rather than the time "wasted" on the wrong solution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_form_s_own_save_method">14.7. Using the Form&#8217;s Own Save Method</h3>
<div class="paragraph">
<p>There
are a couple more things we can do to make our views even simpler.  I&#8217;ve
mentioned that forms are supposed to be able to save data to the database for
us.  Our case won&#8217;t quite work out of the box, because the item needs to know
what list to save to, but it&#8217;s not hard to fix that.</p>
</div>
<div class="paragraph">
<p>We start, as always, with a test.  Just to illustrate what the problem is,
let&#8217;s see what happens if we just try to call <code>form.save()</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch11l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_form_save_handles_saving_to_a_list(self):
        form = ItemForm(data={'text': 'do me'})
        new_item = form.save()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django isn&#8217;t happy, because an item needs to belong to a list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id</pre>
</div>
</div>
<div class="paragraph">
<p>Our solution is to tell the form&#8217;s save method what list it should save to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.models import Item, List
[...]

    def test_form_save_handles_saving_to_a_list(self):
        list_ = List.objects.create()
        form = ItemForm(data={'text': 'do me'})
        new_item = form.save(for_list=list_)
        self.assertEqual(new_item, Item.objects.first())
        self.assertEqual(new_item.text, 'do me')
        self.assertEqual(new_item.list, list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We then make sure that the item is correctly saved to the database, with
the right attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: save() got an unexpected keyword argument 'for_list'</pre>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s how we can implement our custom save method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch11l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def save(self, for_list):
        self.instance.list = for_list
        return super().save()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>.instance</code> attribute on a form represents the database object that is
being modified or created.  And I only learned that as I was writing this
chapter!  There are other ways of getting this to work, including manually
creating the object yourself, or using the <code>commit=False</code> argument to save,
but this is the neatest I think.  We&#8217;ll explore a different way of making
a form "know" what list it&#8217;s for in the next <span class="keep-together">chapter</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.086s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Finally we can refactor our views. <code>new_list</code> first:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)
    if form.is_valid():
        list_ = List.objects.create()
        form.save(for_list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the test to check that everything still passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.086s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now <code>view_list</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    form = ItemForm()
    if request.method == 'POST':
        form = ItemForm(data=request.POST)
        if form.is_valid():
            form.save(for_list=list_)
            return redirect(list_)
    return render(request, 'list.html', {'list': list_, "form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we still have full passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Ran 24 tests in 0.111s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="listingblock dofirst-ch11l037">
<div class="content">
<pre>Ran 4 tests in 14.367s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Great!  Our two views are now looking very much like "normal" Django views:
they take information from a user&#8217;s request, combine it with some custom logic
or information from the URL (<code>list_id</code>), pass it to a form for validation
and possible saving, and then redirect or render a template.</p>
</div>
<div class="paragraph">
<p>Forms and validation are really important in Django, and in web programming in
general, so let&#8217;s try to make a slightly more complicated one in the
next chapter.</p>
</div>
<div class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">Tips</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Thin views</dt>
<dd>
<p>If
you find yourself looking at complex views, and having to write a lot of
tests for them, it&#8217;s time to start thinking about whether that logic could
be moved elsewhere: possibly to a form, like we&#8217;ve done here.</p>
<div class="paragraph">
<p>Another possible place would be a custom method on the model class.
    And&#8212;&#8203;once the complexity of the app demands it&#8212;&#8203;out of Django-specific
    files and into your own classes and functions, that capture your core
    business logic.</p>
</div>
</dd>
<dt class="hdlist1">Each test should test one thing</dt>
<dd>
<p>The
heuristic is to be suspicious if there&#8217;s more than one assertion in a
test. Sometimes two assertions are closely related, so they belong
together. But often your first draft of a test ends up testing multiple
behaviours, and it&#8217;s worth rewriting it as several tests. Helper functions
can keep them from getting too bloated.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_advanced_forms">15. More Advanced Forms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s look at some more advanced forms usage.  We&#8217;ve helped our users
to avoid blank list items, so now let&#8217;s help them avoid duplicate items.</p>
</div>
<div class="paragraph">
<p>This chapter goes into more intricate details of Django&#8217;s form validation, and
you have my official permission to skip it if you already know all about
customising Django forms, or if you&#8217;re reading this book for the TDD rather
than for the Django.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re still learning Django, there&#8217;s good stuff in here.  If you
want to skip ahead, that&#8217;s OK too. Make sure you take a quick look at the aside
on developer stupidity, and the recap on testing views at the end.</p>
</div>
<div class="sect2">
<h3 id="_another_ft_for_duplicate_items">15.1. Another FT for Duplicate Items</h3>
<div class="paragraph">
<p>We
add a second test method to <code>ItemValidationTest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch13l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_cannot_add_duplicate_items(self):
    # Edith goes to the home page and starts a new list
    self.browser.get(self.live_server_url)
    self.get_item_input_box().send_keys('Buy wellies')
    self.get_item_input_box().send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Buy wellies')

    # She accidentally tries to enter a duplicate item
    self.get_item_input_box().send_keys('Buy wellies')
    self.get_item_input_box().send_keys(Keys.ENTER)

    # She sees a helpful error message
    self.wait_for(lambda: self.assertEqual(
        self.browser.find_element_by_css_selector('.has-error').text,
        "You've already got this in your list"
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Why have two test methods rather than extending one, or having a new file
and class?  It&#8217;s a judgement call.  These two feel closely related; they&#8217;re
both about validation on the same input field, so it feels right to
keep them in the same file.  On the other hand, they&#8217;re logically separate
enough that it&#8217;s practical to keep them in different methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error

Ran 2 tests in 9.613s</pre>
</div>
</div>
<div class="paragraph">
<p>OK, so we know the first of the two tests passes now. Is there a way to run
just the failing one, I hear you ask?  Why, yes indeed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.\
test_list_item_validation.ItemValidationTest.test_cannot_add_duplicate_items</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="sect3">
<h4 id="_preventing_duplicates_at_the_model_layer">15.1.1. Preventing Duplicates at the Model Layer</h4>
<div class="paragraph">
<p>Here&#8217;s
what we really wanted to do.  It&#8217;s a new test that checks that duplicate
items in the same list raise an error:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch09l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_duplicate_items_are_invalid(self):
    list_ = List.objects.create()
    Item.objects.create(list=list_, text='bla')
    with self.assertRaises(ValidationError):
        item = Item(list=list_, text='bla')
        item.full_clean()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, while it occurs to us, we add another test to make sure we don&#8217;t
overdo it on our integrity constraints:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch09l029)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_CAN_save_same_item_to_different_lists(self):
    list1 = List.objects.create()
    list2 = List.objects.create()
    Item.objects.create(list=list1, text='bla')
    item = Item(list=list2, text='bla')
    item.full_clean()  # should not raise</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I always like to put a little comment for tests which are checking
that a particular use case should <em>not</em> raise an error; otherwise,
it can be hard to see what&#8217;s being tested:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: ValidationError not raised</pre>
</div>
</div>
<div class="paragraph">
<p>If we want to get it deliberately wrong, we can do this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch09l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Item(models.Model):
    text = models.TextField(default='', unique=True)
    list = models.ForeignKey(List, default=None)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That lets us check that our second test really does pick up on this
problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Traceback (most recent call last):
  File "...python-tdd-book/lists/tests/test_models.py", line 62, in
test_CAN_save_same_item_to_different_lists
    item.full_clean()  # should not raise
    [...]
django.core.exceptions.ValidationError: {'text': ['Item with this Text already
exists.']}</pre>
</div>
</div>
<div id="testing-for-stupidity" class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">An Aside on When to Test for Developer Stupidity</div>
<div class="paragraph">
<p>One of the judgement calls in testing is when you should write tests that sound
like "check that we haven&#8217;t done something stupid".  In general, you should be wary
of these.</p>
</div>
<div class="paragraph">
<p>In this case, we&#8217;ve written a test to check that you can&#8217;t save duplicate items
to the same list.  Now, the simplest way to get that test to pass, the way in
which you&#8217;d write the fewest lines of code, would be to make it impossible to
save <em>any</em> duplicate items.  That justifies writing another test, despite the
fact that it would be a "stupid" or "wrong" thing for us to code.</p>
</div>
<div class="paragraph">
<p>But you can&#8217;t be writing tests for every possible way we could have coded
something wrong.  If you have a function that adds two numbers, you can write
a couple of tests:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">assert adder(1, 1) == 2
assert adder(2, 1) == 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>But you have the right to assume that the implementation isn&#8217;t deliberately
screwy or perverse:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def adder(a, b):
    # unlikely code!
    if a == 3:
        return 666
    else:
        return a + b</code></pre>
</div>
</div>
<div class="paragraph">
<p>One way of putting it is that you should trust yourself not to do something
<em>deliberately</em> stupid, but not something <em>accidentally</em> stupid.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Just
like <code>ModelForm</code>s, models have a <code>class Meta</code>, and that&#8217;s where we can
implement a constraint which says that an item must be unique for a
particular list, or in other words, that <code>text</code> and <code>list</code> must be unique
together:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch09l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Item(models.Model):
    text = models.TextField(default='')
    list = models.ForeignKey(List, default=None)

    class Meta:
        unique_together = ('list', 'text')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You might want to take a quick peek at the
<a href="https://docs.djangoproject.com/en/1.11/ref/models/options/">Django docs on model
<code>Meta</code> attributes</a> at this point.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_little_digression_on_queryset_ordering_and_string_representations">15.1.2. A Little Digression on Queryset Ordering and String Representations</h4>
<div class="paragraph">
<p>When
we run the tests they reveal an unexpected failure:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>======================================================================
FAIL: test_saving_and_retrieving_items
(lists.tests.test_models.ListAndItemModelsTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/lists/tests/test_models.py", line 31, in
test_saving_and_retrieving_items
    self.assertEqual(first_saved_item.text, 'The first (ever) list item')
AssertionError: 'Item the second' != 'The first (ever) list item'
- Item the second
[...]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Depending on your platform and its SQLite installation, you may
    not see this error. You can follow along anyway; the code and tests are
    interesting in their own right.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s a bit of a puzzler. A bit of print-based debugging:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/tests/test_models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    first_saved_item = saved_items[0]
    print(first_saved_item.text)
    second_saved_item = saved_items[1]
    print(second_saved_item.text)
    self.assertEqual(first_saved_item.text, 'The first (ever) list item')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>will show us&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>.....Item the second
The first (ever) list item
F.....</pre>
</div>
</div>
<div class="paragraph">
<p>It looks like our uniqueness constraint has messed with the default ordering
of queries like <code>Item.objects.all()</code>.  Although we already have a failing test,
it&#8217;s best to add a new test that explicitly tests for ordering:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch09l032)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_list_ordering(self):
        list1 = List.objects.create()
        item1 = Item.objects.create(list=list1, text='i1')
        item2 = Item.objects.create(list=list1, text='item 2')
        item3 = Item.objects.create(list=list1, text='3')
        self.assertEqual(
            Item.objects.all(),
            [item1, item2, item3]
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us a new failure, but it&#8217;s not a very readable one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: Item object&gt;, &lt;Item: Item object&gt;, &lt;Item:
Item object&gt;]&gt; != [&lt;Item: Item object&gt;, &lt;Item: Item object&gt;, &lt;Item: Item
object&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>We need a better string representation for our objects.  Let&#8217;s add another
unit test:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Ordinarily you would be wary of adding more failing tests when you
    already have some&#8212;&#8203;it makes reading test output that much more complicated,
    and just generally makes you nervous. Will we ever get back to a working
    state? In this case, they&#8217;re all quite simple tests, so I&#8217;m not worried.
</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch13l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_string_representation(self):
    item = Item(text='some text')
    self.assertEqual(str(item), 'some text')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: 'Item object' != 'some text'</pre>
</div>
</div>
<div class="paragraph">
<p>As well as the other two failures.  Let&#8217;s start fixing them all now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch09l034)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Item(models.Model):
    [...]

    def __str__(self):
        return self.text</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In Python 2.x versions of Django, the string representation method used
    to be <code>__unicode__</code>. Like much string handling, this is simplified in
    Python 3. See the
    <a href="https://docs.djangoproject.com/en/1.11/topics/python3/#str-and-unicode-methods">Django docs</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we&#8217;re down to two failures, and the ordering test has a more readable
failure message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]&gt; != [&lt;Item:
i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>We can fix that in the <code>class Meta</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch09l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    class Meta:
        ordering = ('id',)
        unique_together = ('list', 'text')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that work?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;QuerySet [&lt;Item: i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]&gt; != [&lt;Item:
i1&gt;, &lt;Item: item 2&gt;, &lt;Item: 3&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>Urp?  It has worked; you can see the items <em>are</em> in the same order, but the
tests are confused.  I keep running into this problem actually&#8212;&#8203;Django
querysets don&#8217;t compare well with lists.  We can fix it by converting the
queryset to a list<sup class="footnote">[<a id="_footnoteref_24" class="footnote" href="#_footnote_24" title="View footnote.">24</a>]</sup>
in our test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch09l036)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    self.assertEqual(
        list(Item.objects.all()),
        [item1, item2, item3]
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That
works; we get a fully passing test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rewrite-model-test">15.1.3. Rewriting the Old Model Test</h4>
<div class="paragraph">
<p>That long-winded model test did serendipitously help us find an unexpected
bug, but now it&#8217;s time to rewrite it. I wrote it in a very verbose style to
introduce the Django ORM, but in fact, now that we have the explicit test for
ordering, we can get the same coverage from a couple of much shorter tests.
Delete <code>test_saving_and_retrieving_items</code> and replace with this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch13l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListAndItemModelsTest(TestCase):

    def test_default_text(self):
        item = Item()
        self.assertEqual(item.text, '')


    def test_item_is_related_to_list(self):
        list_ = List.objects.create()
        item = Item()
        item.list = list_
        item.save()
        self.assertIn(item, list_.item_set.all())

    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s more than enough really&#8212;&#8203;a check of the default values of attributes
on a freshly initialized model object is enough to sanity-check that we&#8217;ve
probably set some fields up in <em>models.py</em>.  The "item is related to list" test
is a real "belt and braces" test to make sure that our foreign key relationship
works.</p>
</div>
<div class="paragraph">
<p>While we&#8217;re at it, we can split this file out into tests for <code>Item</code> and tests
for <code>List</code> (there&#8217;s only one of the latter, <code>test_get_absolute_url</code>):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch13l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemModelTest(TestCase):

    def test_default_text(self):
        [...]



class ListModelTest(TestCase):

    def test_get_absolute_url(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s neater and tidier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 29 tests in 0.092s

OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_some_integrity_errors_do_show_up_on_save">15.1.4. Some Integrity Errors Do Show Up on Save</h4>
<div class="paragraph">
<p>A
final aside before we move on. Do you remember I mentioned in
<a href="#chapter_database_layer_validation">Validation at the Database Layer</a> that some data integrity errors <em>are</em> picked up
on save?  It all depends on whether the integrity constraint is actually being
enforced by the database.</p>
</div>
<div class="paragraph">
<p>Try running <code>makemigrations</code> and you&#8217;ll see that Django wants to add the
<code>unique_together</code> constraint to the database itself, rather than just having
it as an application-layer constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0005_auto_20140414_2038.py
    - Change Meta options on item
    - Alter unique_together for item (1 constraint(s))</pre>
</div>
</div>
<div class="paragraph">
<p>Now if we change our duplicates test to do a <code>.save</code> instead of a
<code>.full_clean</code>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_duplicate_items_are_invalid(self):
        list_ = List.objects.create()
        Item.objects.create(list=list_, text='bla')
        with self.assertRaises(ValidationError):
            item = Item(list=list_, text='bla')
            # item.full_clean()
            item.save()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_duplicate_items_are_invalid (lists.tests.test_models.ItemModelTest)
[...]
    return Database.Cursor.execute(self, query, params)
sqlite3.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text
[...]
django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the error bubbles up from SQLite, and it&#8217;s a different
error from the one we want, an <code>IntegrityError</code> instead of a <code>ValidationError</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s revert our changes to the test, and see them all passing again:</p>
</div>
<div class="listingblock dofirst-ch13l013">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 29 tests in 0.092s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And
now it&#8217;s time to commit our model-layer changes:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>git status</strong> # should show changes to tests + models and new migration
# let's give our new migration a better name
$ <strong>mv lists/migrations/0005_auto* lists/migrations/0005_list_item_unique_together.py</strong>
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit -am "Implement duplicate item validation at model layer"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_experimenting_with_duplicate_item_validation_at_the_views_layer">15.2. Experimenting with Duplicate Item Validation at the Views Layer</h3>
<div class="paragraph">
<p>Let&#8217;s
try running our FT, just to see where we are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="paragraph">
<p>In case you didn&#8217;t see it as it flew past, the site is 500ing.<sup class="footnote">[<a id="_footnoteref_25" class="footnote" href="#_footnote_25" title="View footnote.">25</a>]</sup>
A quick unit test at the view level ought to clear this up:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch13l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):
    [...]

    def test_for_invalid_input_shows_error_on_page(self):
        [...]


    def test_duplicate_item_validation_errors_end_up_on_lists_page(self):
        list1 = List.objects.create()
        item1 = Item.objects.create(list=list1, text='textey')
        response = self.client.post(
            f'/lists/{list1.id}/',
            data={'text': 'textey'}
        )

        expected_error = escape("You've already got this in your list")
        self.assertContains(response, expected_error)
        self.assertTemplateUsed(response, 'list.html')
        self.assertEqual(Item.objects.all().count(), 1)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>We want to avoid integrity errors! Ideally, we want the call to <code>is_valid</code> to
somehow notice the duplication error before we even try to save, but to do
that, our form will need to know in advance what list it&#8217;s being used for.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s put a skip on that test for now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch13l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest import skip
[...]

    @skip
    def test_duplicate_item_validation_errors_end_up_on_lists_page(self):</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_more_complex_form_to_handle_uniqueness_validation">15.3. A More Complex Form to Handle Uniqueness Validation</h3>
<div class="paragraph">
<p>The
form to create a new list only needs to know one thing, the new item text.
A form which validates that list items are unique needs to know the list too.
Just as we overrode the save method on our <code>ItemForm</code>, this time we&#8217;ll
override the constructor on our new form class so that it knows what list it
applies to.</p>
</div>
<div class="paragraph">
<p>We duplicate our tests for the previous form, tweaking them slightly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch13l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import (
    DUPLICATE_ITEM_ERROR, EMPTY_ITEM_ERROR,
    ExistingListItemForm, ItemForm
)
[...]

class ExistingListItemFormTest(TestCase):

    def test_form_renders_item_text_input(self):
        list_ = List.objects.create()
        form = ExistingListItemForm(for_list=list_)
        self.assertIn('placeholder="Enter a to-do item"', form.as_p())


    def test_form_validation_for_blank_items(self):
        list_ = List.objects.create()
        form = ExistingListItemForm(for_list=list_, data={'text': ''})
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors['text'], [EMPTY_ITEM_ERROR])


    def test_form_validation_for_duplicate_items(self):
        list_ = List.objects.create()
        Item.objects.create(list=list_, text='no twins!')
        form = ExistingListItemForm(for_list=list_, data={'text': 'no twins!'})
        self.assertFalse(form.is_valid())
        self.assertEqual(form.errors['text'], [DUPLICATE_ITEM_ERROR])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we iterate through a few TDD cycles  until we get a form with a
custom constructor, which just ignores its <code>for_list</code> argument.
(I won&#8217;t show them all, but I&#8217;m sure you&#8217;ll do them, right? Remember, the Goat
sees all.)</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch09l071)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">DUPLICATE_ITEM_ERROR = "You've already got this in your list"
[...]
class ExistingListItemForm(forms.models.ModelForm):
    def __init__(self, for_list, *args, **kwargs):
        super().__init__(*args, **kwargs)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At this point our error should be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: ModelForm has no model class specified.</pre>
</div>
</div>
<div class="paragraph">
<p>Then let&#8217;s see if making it inherit from our existing form helps:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch09l072)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ExistingListItemForm(ItemForm):
    def __init__(self, for_list, *args, **kwargs):
        super().__init__(*args, **kwargs)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yes, that takes us down to just one failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_form_validation_for_duplicate_items
(lists.tests.test_forms.ExistingListItemFormTest)
    self.assertFalse(form.is_valid())
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>The next step requires a little knowledge of Django&#8217;s internals, but you
can read up on it in the Django docs on
<a href="https://docs.djangoproject.com/en/1.11/ref/models/instances/#validating-objects">model
validation</a> and
<a href="https://docs.djangoproject.com/en/1.11/ref/forms/validation/">form validation</a>.</p>
</div>
<div class="paragraph">
<p>Django uses a method called <code>validate_unique</code>, both on forms and models, and
we can use both, in conjunction with the <code>instance</code> attribute:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core.exceptions import ValidationError
[...]

class ExistingListItemForm(ItemForm):

    def __init__(self, for_list, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.instance.list = for_list


    def validate_unique(self):
        try:
            self.instance.validate_unique()
        except ValidationError as e:
            e.error_dict = {'text': [DUPLICATE_ITEM_ERROR]}
            self._update_errors(e)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a bit of Django voodoo right there, but we basically take the validation
error, adjust its error message, and then pass it back into the form.</p>
</div>
<div class="paragraph">
<p>And we&#8217;re there!  A quick commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git diff</strong>
$ <strong>git commit -a</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_existing_list_item_form_in_the_list_view">15.4. Using the Existing List Item Form in the List View</h3>
<div class="paragraph">
<p>Now
let&#8217;s see if we can put this form to work in our view.</p>
</div>
<div class="paragraph">
<p>We remove the skip, and while we&#8217;re at it, we can use our new constant. Tidy.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch13l049)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import (
    DUPLICATE_ITEM_ERROR, EMPTY_ITEM_ERROR,
    ExistingListItemForm, ItemForm,
)
[...]

    def test_duplicate_item_validation_errors_end_up_on_lists_page(self):
        [...]
        expected_error = escape(DUPLICATE_ITEM_ERROR)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That brings back our integrity error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: UNIQUE constraint failed: lists_item.list_id,
lists_item.text</pre>
</div>
</div>
<div class="paragraph">
<p>Our fix for this is to switch to using the new form class.  Before we implement
it, let&#8217;s find the tests where we check the form class, and adjust them:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch13l050)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):
[...]

    def test_displays_item_form(self):
        list_ = List.objects.create()
        response = self.client.get(f'/lists/{list_.id}/')
        self.assertIsInstance(response.context['form'], ExistingListItemForm)
        self.assertContains(response, 'name="text"')

    [...]

    def test_for_invalid_input_passes_form_to_template(self):
        response = self.post_invalid_input()
        self.assertIsInstance(response.context['form'], ExistingListItemForm)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;ItemForm bound=False, valid=False, fields=(text)&gt; is not an
instance of &lt;class 'lists.forms.ExistingListItemForm'&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>So we can adjust the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch13l051)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import ExistingListItemForm, ItemForm
[...]
def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    form = ExistingListItemForm(for_list=list_)
    if request.method == 'POST':
        form = ExistingListItemForm(for_list=list_, data=request.POST)
        if form.is_valid():
            form.save()
            [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that <em>almost</em> fixes everything, except for an unexpected fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: save() missing 1 required positional argument: 'for_list'</pre>
</div>
</div>
<div class="paragraph">
<p>Our custom save method from the parent <code>ItemForm</code> is no longer needed.
Let&#8217;s make a quick unit test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch13l053)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_form_save(self):
    list_ = List.objects.create()
    form = ExistingListItemForm(for_list=list_, data={'text': 'hi'})
    new_item = form.save()
    self.assertEqual(new_item, Item.objects.all()[0])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can make our form call the grandparent save method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch13l054)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def save(self):
        return forms.models.ModelForm.save(self)</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Personal opinion here: I could have used <code>super</code>, but I prefer not to use
    <code>super</code> when it requires arguments, say, to get a grandparent method. I find
    Python 3&#8217;s <code>super()</code> with no args awesome to get the immediate parent.
    Anything else is too error-prone, and I find it ugly besides. YMMV.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we&#8217;re there!  All the unit tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 34 tests in 0.082s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>And so does our FT for validation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
..
 ---------------------------------------------------------------------
Ran 2 tests in 12.048s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>As a final check, we rerun <em>all</em> the FTs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
.....
 ---------------------------------------------------------------------
Ran 5 tests in 19.048s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray! Time for a final commit, and a wrap-up of what we&#8217;ve learned about
testing views over the last few chapters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrapping_up_what_we_ve_learned_about_testing_django">15.5. Wrapping Up: What We&#8217;ve Learned About Testing Django</h3>
<div class="paragraph">
<p>We&#8217;re
now at a point where our app looks a lot more like a "standard"
Django app, and it implements the three common Django layers: models,
forms, and views.  We no longer have any "training wheels&#x201d;-style tests,
and our code looks pretty much like code we&#8217;d be happy to see in a
real app.</p>
</div>
<div class="paragraph">
<p>We have one unit test file for each of our key source code files.  Here&#8217;s
a recap of the biggest (and highest-level) one, <em>test_views</em> (the listing
shows just the key tests and assertions):</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What to Test in Views</div>
<div class="exampleblock sourcecode skipme small-code">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewTest(TestCase):
  def test_uses_list_template(self):
      response = self.client.get(f'/lists/{list_.id}/') <i class="conum" data-value="1"></i><b>(1)</b>
      self.assertTemplateUsed(response, 'list.html') <i class="conum" data-value="2"></i><b>(2)</b>
  def test_passes_correct_list_to_template(self):
      self.assertEqual(response.context['list'], correct_list) <i class="conum" data-value="3"></i><b>(3)</b>
  def test_displays_item_form(self):
      self.assertIsInstance(response.context['form'], ExistingListItemForm) <i class="conum" data-value="4"></i><b>(4)</b>
      self.assertContains(response, 'name="text"')
  def test_displays_only_items_for_that_list(self):
      self.assertContains(response, 'itemey 1') <i class="conum" data-value="5"></i><b>(5)</b>
      self.assertContains(response, 'itemey 2') <i class="conum" data-value="5"></i><b>(5)</b>
      self.assertNotContains(response, 'other list item 1') <i class="conum" data-value="5"></i><b>(5)</b>
  def test_can_save_a_POST_request_to_an_existing_list(self):
      self.assertEqual(Item.objects.count(), 1) <i class="conum" data-value="6"></i><b>(6)</b>
      self.assertEqual(new_item.text, 'A new item for an existing list') <i class="conum" data-value="6"></i><b>(6)</b>
  def test_POST_redirects_to_list_view(self):
      self.assertRedirects(response, f'/lists/{correct_list.id}/') <i class="conum" data-value="6"></i><b>(6)</b>
  def test_for_invalid_input_nothing_saved_to_db(self):
      self.assertEqual(Item.objects.count(), 0) <i class="conum" data-value="6"></i><b>(6)</b>
  def test_for_invalid_input_renders_list_template(self):
      self.assertEqual(response.status_code, 200)
      self.assertTemplateUsed(response, 'list.html') <i class="conum" data-value="6"></i><b>(6)</b>
  def test_for_invalid_input_passes_form_to_template(self):
      self.assertIsInstance(response.context['form'], ExistingListItemForm) <i class="conum" data-value="7"></i><b>(7)</b>
  def test_for_invalid_input_shows_error_on_page(self):
      self.assertContains(response, escape(EMPTY_ITEM_ERROR)) <i class="conum" data-value="7"></i><b>(7)</b>
  def test_duplicate_item_validation_errors_end_up_on_lists_page(self):
      self.assertContains(response, expected_error)
      self.assertTemplateUsed(response, 'list.html')
      self.assertEqual(Item.objects.all().count(), 1)</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the Django Test Client.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check the template used.  Then, check each item in the template context.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Check that any objects are the right ones, or querysets have the
correct items.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Check that any forms are of the correct class.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Think about testing template logic:  any <code>for</code> or <code>if</code> might deserve a
minimal test.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>For POST requests, make sure you test both the valid case and the invalid
case.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Optionally, sanity-check that your form is rendered, and its errors are
displayed.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Why these points?  Skip ahead to <a href="#appendix_Django_Class-Based_Views">Django Class-Based Views</a>, and I&#8217;ll show how
they are sufficient to ensure that our views are still correct if we refactor
them to start using class-based views.</p>
</div>
<div class="paragraph">
<p>Next we&#8217;ll try to make our data validation more friendly by using a bit
of client-side code.  Uh-oh, you know what that means&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_javascript">16. Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>If the Good Lord had wanted us to enjoy ourselves, he wouldn&#8217;t have granted us
his precious gift of relentless misery.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; John Calvin (as portrayed in <a href="http://onemillionpoints.blogspot.co.uk/2008/08/calvin-and-chipmunks.html">Calvin and the Chipmunks</a>)
</div>
</div>
<div class="paragraph">
<p>Our new validation logic is good, but wouldn&#8217;t it be nice if the duplicate item
error messages disappeared once the user started fixing the problem?  Just like
our nice HTML5 validation errors do? For that we&#8217;d need a teeny-tiny bit of
JavaScript.</p>
</div>
<div class="paragraph">
<p>We are utterly spoiled by programming every day in such a joyful language as
Python.  JavaScript is our punishment. For a web developer though, there&#8217;s
no way around it. So let&#8217;s dip our toes in, very gingerly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m
going to assume you know the basics of JavaScript syntax. If you
    haven&#8217;t read <a href="#jsgoodparts"><em>JavaScript: The Good Parts</em></a>, go and get
    yourself a copy right away!  It&#8217;s not a very long book.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_starting_with_an_ft">16.1. Starting with an FT</h3>
<div class="paragraph">
<p>Let&#8217;s
add a new functional test to the <code>ItemValidationTest</code> class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch14l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_error_messages_are_cleared_on_input(self):
    # Edith starts a list and causes a validation error:
    self.browser.get(self.live_server_url)
    self.get_item_input_box().send_keys('Banter too thick')
    self.get_item_input_box().send_keys(Keys.ENTER)
    self.wait_for_row_in_list_table('1: Banter too thick')
    self.get_item_input_box().send_keys('Banter too thick')
    self.get_item_input_box().send_keys(Keys.ENTER)

    self.wait_for(lambda: self.assertTrue(  <i class="conum" data-value="1"></i><b>(1)</b>
        self.browser.find_element_by_css_selector('.has-error').is_displayed()  <i class="conum" data-value="2"></i><b>(2)</b>
    ))

    # She starts typing in the input box to clear the error
    self.get_item_input_box().send_keys('a')

    # She is pleased to see that the error message disappears
    self.wait_for(lambda: self.assertFalse(
        self.browser.find_element_by_css_selector('.has-error').is_displayed()  <i class="conum" data-value="2"></i><b>(2)</b>
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use another of our <code>wait_for</code> invocations, this time with <code>assertTrue</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>is_displayed()</code> tells you whether an element is visible or not. We
can&#8217;t just rely on checking whether the element is present in the DOM,
because now we&#8217;re starting to hide elements.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That fails appropriately, but before we move on:  three strikes and refactor!
We&#8217;ve got several places where we find the error element using CSS. Let&#8217;s
move it to a helper function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch14l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemValidationTest(FunctionalTest):

    def get_error_element(self):
        return self.browser.find_element_by_css_selector('.has-error')

    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I like to keep helper functions in the FT class that&#8217;s using them, and
    only promote them to the base class when they&#8217;re actually needed elsewhere.
    It stops the base class from getting too cluttered. YAGNI.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we then make three replacements in <em>test_list_item_validation</em>, like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_list_item_validation.py (ch14l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    self.wait_for(lambda: self.assertEqual(
        self.get_error_element().text,
        "You've already got this in your list"
    ))
[...]
    self.wait_for(lambda: self.assertTrue(
        self.get_error_element().is_displayed()
    ))
[...]
    self.wait_for(lambda: self.assertFalse(
        self.get_error_element().is_displayed()
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We have an expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation</strong>
[...]
    self.get_error_element().is_displayed()
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>And we can commit this as the first cut of our FT.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_a_basic_javascript_test_runner">16.2. Setting Up a Basic JavaScript Test Runner</h3>
<div class="paragraph">
<p>Choosing
your testing tools in the Python and Django world is fairly
straightforward.  The standard library <code>unittest</code> package is perfectly
adequate, and the Django test runner also makes a good default choice.
There are some alternatives out there&mdash;<a href="http://nose.readthedocs.org/">nose</a>
is popular, <a href="https://github.com/CleanCut/green">Green</a> is the new kid on the
block, and I&#8217;ve personally found <a href="http://pytest.org/">pytest</a> to be very
impressive.  But there is a clear default option, and it&#8217;s just
fine.<sup class="footnote">[<a id="_footnoteref_26" class="footnote" href="#_footnote_26" title="View footnote.">26</a>]</sup></p>
</div>
<div class="paragraph">
<p>Not so in the JavaScript world!  We use YUI and Jest at work, but I thought I&#8217;d
go out and see whether there were any new tools out there.  I was overwhelmed
with options&#8212;&#8203;jsUnit, Qunit, Mocha, Chutzpah, Karma, Jasmine, and many more.
And it doesn&#8217;t end there either: as I had almost settled on one of them,
Mocha,<sup class="footnote">[<a id="_footnoteref_27" class="footnote" href="#_footnote_27" title="View footnote.">27</a>]</sup> I find out that I now need to
choose an <em>assertion framework</em> and a <em>reporter</em>, and maybe a <em>mocking
library</em>, and it never ends!</p>
</div>
<div class="paragraph">
<p>In
the end I decided we should use <a href="http://qunitjs.com/">QUnit</a> because it&#8217;s
simple, has a similar look and feel to Python unit tests,  and it works well
with jQuery.</p>
</div>
<div class="paragraph">
<p>Make a directory called <em>tests</em> inside <em>lists/static</em>, and download the QUnit
JavaScript and CSS files into it. We&#8217;ll also put a file called <em>tests.html</em> in
there:</p>
</div>
<div class="listingblock dofirst-ch14l004">
<div class="content">
<pre>$ <strong>tree lists/static/tests/</strong>
lists/static/tests/
├── qunit-2.6.0.css
├── qunit-2.6.0.js
└── tests.html</pre>
</div>
</div>
<div class="paragraph">
<p>The boilerplate for a QUnit HTML file looks like this, including a smoke test:</p>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;meta name="viewport" content="width=device-width"&gt;
  &lt;title&gt;Javascript tests&lt;/title&gt;
  &lt;link rel="stylesheet" href="qunit-2.6.0.css"&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="qunit"&gt;&lt;/div&gt;
  &lt;div id="qunit-fixture"&gt;&lt;/div&gt;
  &lt;script src="qunit-2.6.0.js"&gt;&lt;/script&gt;

  &lt;script&gt;

QUnit.test("smoke test", function (assert) {
  assert.equal(1, 1, "Maths works!");
});

  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dissecting that, the important things to pick up are the fact that we pull
in <em>qunit-2.6.0.js</em> using the first <code>&lt;script&gt;</code> tag, and then use the second one
to write the main body of tests.</p>
</div>
<div class="paragraph">
<p>If you open up the file using your web browser (no need to run the dev
server, just find the file on disk), you should see something like
<a href="#basic-qunit-screen">Basic QUnit screen</a>.</p>
</div>
<div id="basic-qunit-screen" class="imageblock">
<div class="content">
<img src="images/twp2_1601.png" alt="Qunit screen showing 1 passing test">
</div>
<div class="title">Figure 26. Basic QUnit screen</div>
</div>
<div class="paragraph">
<p>Looking at the test itself, we&#8217;ll find many similarities with the Python
tests we&#8217;ve been writing so far:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test("smoke test", function (assert) { <i class="conum" data-value="1"></i><b>(1)</b>
    assert.equal(1, 1, "Maths works!"); <i class="conum" data-value="2"></i><b>(2)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>QUnit.test</code> function defines a test case, a bit like
<code>def test_something(self)</code> did in Python. Its first argument is a name for
the test, and the second is a function for the body of the test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>assert.equal</code> function is an assertion; very much like <code>assertEqual</code>,
it compares two arguments. Unlike in Python, though, the message is
displayed both for failures and for passes, so it should be phrased as a
positive rather than a <span class="keep-together">negative</span>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Why not try changing those arguments to see a deliberate failure?</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_jquery_and_the_fixtures_div">16.3. Using jQuery and the Fixtures Div</h3>
<div class="paragraph">
<p>Let&#8217;s
get a bit more comfortable with what our testing framework can do,
and start using a bit of jQuery&#8212;&#8203;an almost indispensable library that
gives you a cross-browser-compatible API for manipulating the DOM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;ve never seen jQuery before, I&#8217;m going to try to explain it as we
    go, just enough so that you won&#8217;t be totally lost; but this isn&#8217;t a jQuery
    tutorial.  You may find it helpful to spend an hour or two investigating
    jQuery at some point during this chapter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Download the latest jQuery from <a href="https://jquery.com/download/">jquery.com</a> and
save it into the <em>lists/static</em> folder.</p>
</div>
<div class="paragraph">
<p>Then let&#8217;s start using it in our tests file, along with adding a couple of
HTML elements. We&#8217;ll start by seeing if we can show and hide an element,
and write some assertions about its visibility:</p>
</div>
<div class="exampleblock sourcecode dofirstch14l005">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;div id="qunit-fixture"&gt;&lt;/div&gt;

  &lt;form&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;input name="text" /&gt;
    &lt;div class="has-error"&gt;Error text&lt;/div&gt;
  &lt;/form&gt;

  &lt;script src="../jquery-3.3.1.min.js"&gt;&lt;/script&gt; <i class="conum" data-value="2"></i><b>(2)</b>
  &lt;script src="qunit-2.6.0.js"&gt;&lt;/script&gt;

  &lt;script&gt;

QUnit.test("smoke test", function (assert) {
  assert.equal($('.has-error').is(':visible'), true);  <i class="conum" data-value="3"></i><b>(3)</b><i class="conum" data-value="4"></i><b>(4)</b>
  $('.has-error').hide();  <i class="conum" data-value="5"></i><b>(5)</b>
  assert.equal($('.has-error').is(':visible'), false);  <i class="conum" data-value="6"></i><b>(6)</b>
});

  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>&lt;form&gt;</code> and its contents are there to represent what will be
on the real list page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here&#8217;s where we load jQuery.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>jQuery magic starts here!  <code>$</code> is the jQuery Swiss Army knife. It&#8217;s
used to find bits of the DOM.  Its first argument is a CSS selector; here,
we&#8217;re telling it to find all elements that have the class "has-error".  It
returns an object that represents one or more DOM elements. That, in turn,
has various useful methods that allow us to manipulate or find out about
those elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>One of which is <code>.is</code>, which can tell us whether an element matches a
particular CSS property. Here we use <code>:visible</code> to check whether the
element is displayed or hidden.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We then use jQuery&#8217;s <code>.hide()</code> method to hide the div.  Behind the
scenes, it dynamically sets a <code>style="display: none"</code> on the element.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>And finally we check that it&#8217;s worked, with a second <code>assert.equal</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you refresh the browser, you should see that all passes:</p>
</div>
<div class="exampleblock">
<div class="title">Expected results from QUnit in the browser</div>
<div class="content">
<div class="listingblock qunit-output">
<div class="content">
<pre>2 assertions of 2 passed, 0 failed.
1. smoke test (2)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Time to see how fixtures work. Let&#8217;s just dupe up this test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;script&gt;

QUnit.test("smoke test", function (assert) {
  assert.equal($('.has-error').is(':visible'), true);
  $('.has-error').hide();
  assert.equal($('.has-error').is(':visible'), false);
});
QUnit.test("smoke test 2", function (assert) {
  assert.equal($('.has-error').is(':visible'), true);
  $('.has-error').hide();
  assert.equal($('.has-error').is(':visible'), false);
});

  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Slightly unexpectedly, we find one of them fails&#8212;&#8203;see <a href="#one-test-is-failing">One of the two tests is failing</a>.</p>
</div>
<div id="one-test-is-failing" class="imageblock">
<div class="content">
<img src="images/twp2_1602.png" alt="Qunit screen showing only 1 passing test">
</div>
<div class="title">Figure 27. One of the two tests is failing</div>
</div>
<div class="paragraph">
<p>What&#8217;s happening here is that the first test hides the error div, so when
the second test runs, it starts out invisible.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
QUnit tests do not run in a predictable order, so you can&#8217;t rely on the
    first test running before the second one.  Try hitting refresh a few times,
    and you&#8217;ll find that the test which fails changes&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We need some way of tidying up between tests, a bit like <code>setUp</code> and
<code>tearDown</code>, or like the Django test runner would reset the database between
each test.  The <code>qunit-fixture</code> div is what we&#8217;re looking for.  Move the form
in there:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;div id="qunit"&gt;&lt;/div&gt;
  &lt;div id="qunit-fixture"&gt;
      &lt;form&gt;
          &lt;input name="text" /&gt;
          &lt;div class="has-error"&gt;Error text&lt;/div&gt;
      &lt;/form&gt;
  &lt;/div&gt;

  &lt;script src="../jquery-3.3.1.min.js"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As
you&#8217;ve probably guessed, jQuery resets the content of the fixtures div
before each test, so that gets us back to two neatly passing tests:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>4 assertions of 4 passed, 0 failed.
1. smoke test (2)
2. smoke test 2 (2)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_javascript_unit_test_for_our_desired_functionality">16.4. Building a JavaScript Unit Test for Our Desired Functionality</h3>
<div class="paragraph">
<p>Now
that we&#8217;re acquainted with our JavaScript testing tools, we can switch
back to just one test and start to write the real thing:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;script&gt;

QUnit.test("errors should be hidden on keypress", function (assert) {
  $('input[name="text"]').trigger('keypress'); <i class="conum" data-value="1"></i><b>(1)</b>
  assert.equal($('.has-error').is(':visible'), false);
});

  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The jQuery <code>.trigger</code> method is mainly used for testing.  It says "fire off
a JavScript DOM event on the element(s)".  Here we use the <em>keypress</em>
event, which is fired off by the browser behind the scenes whenever a user
types something into a particular input element.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
jQuery is hiding a lot of complexity behind the scenes here.  Check
    out <a href="http://www.quirksmode.org/dom/events/index.html">Quirksmode.org</a> for a
    view on the hideous nest of differences between the different browsers'
    interpretation of events.  The reason that jQuery is so popular is that it
    just makes all this stuff go away.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And that gives us:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>0 assertions of 1 passed, 1 failed.
1. errors should be hidden on keypress (1, 0, 1)
    1. failed
        Expected: false
        Result: true</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s say we want to keep our code in a standalone JavaScript file called
<em>list.js</em>.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;script src="../jquery-3.3.1.min.js"&gt;&lt;/script&gt;
  &lt;script src="../list.js"&gt;&lt;/script&gt;
  &lt;script src="qunit-2.6.0.js"&gt;&lt;/script&gt;

  &lt;script&gt;
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the minimal code to get that test to pass:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">$('.has-error').hide();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And it works&#8230;&#8203;</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>1 assertions of 1 passed, 0 failed.
1. errors should be hidden on keypress (1)</pre>
</div>
</div>
<div class="paragraph">
<p>But it has an obvious problem. We&#8217;d better add another test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test("errors should be hidden on keypress", function (assert) {
  $('input[name="text"]').trigger('keypress');
  assert.equal($('.has-error').is(':visible'), false);
});

QUnit.test("errors aren't hidden if there is no keypress", function (assert) {
  assert.equal($('.has-error').is(':visible'), true);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get an expected failure:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>1 assertions of 2 passed, 1 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1, 0, 1)
    1. failed
        Expected: true
        Result: false
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And we can make a more realistic implementation:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">$('input[name="text"]').on('keypress', function () { <i class="conum" data-value="1"></i><b>(1)</b>
  $('.has-error').hide();
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This line says: find any input elements whose name attribute is "text", and
add an event listener which reacts <em>on</em> keypress events.  The event
listener is the inline function, which hides all elements that have the
class <code>.has-error</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Does it work?  No.</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>1 assertions of 2 passed, 1 failed.
1. errors should be hidden on keypress (1, 0, 1)
    1. failed
        Expected: false
        Result: true
[...]
2. errors aren't hidden if there is no keypress (1)</pre>
</div>
</div>
<div class="paragraph">
<p>Curses!  Why is that?</p>
</div>
</div>
<div class="sect2">
<h3 id="_fixtures_execution_order_and_global_state_key_challenges_of_js_testing">16.5. Fixtures, Execution Order, and Global State: Key Challenges of JS Testing</h3>
<div class="paragraph">
<p>One
of the difficulties with JavaScript in general, and testing in particular,
is in understanding the order of execution of our code (i.e., what happens when).
When does our code in <em>list.js</em> run, and when does each of our tests run?  And
how does that interact with global state, that is, the DOM of our web page, and the
fixtures that we&#8217;ve already seen are supposed to be cleaned up after each test?</p>
</div>
<div class="sect3">
<h4 id="_console_log_for_debug_printing">16.5.1. console.log for Debug Printing</h4>
<div class="paragraph">
<p>Let&#8217;s
add a couple of debug prints, or "console.logs":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;script&gt;

console.log('qunit tests start');

QUnit.test("errors should be hidden on keypress", function (assert) {
  console.log('in test 1');
  $('input[name="text"]').trigger('keypress');
  assert.equal($('.has-error').is(':visible'), false);
});

QUnit.test("errors aren't hidden if there is no keypress", function (assert) {
  console.log('in test 2');
  assert.equal($('.has-error').is(':visible'), true);
});
  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the same in our actual JS code:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js (ch14l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">$('input[name="text"]').on('keypress', function () {
  console.log('in keypress handler');
  $('.has-error').hide();
});
console.log('list.js loaded');</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Rerun the tests, opening up the browser debug console (Ctrl-Shift-I usually)
and you should see something like <a href="#qunit-with-js-console">QUnit tests with console.log debug outputs</a>.</p>
</div>
<div id="qunit-with-js-console" class="imageblock">
<div class="content">
<img src="images/twp2_1603.png" alt="QUnit tests with console.log debug outputs">
</div>
<div class="title">Figure 28. QUnit tests with console.log debug outputs</div>
</div>
<div class="paragraph">
<p>What do we see?</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>list.js</em> loads first.  So our event listener should be attached to the
input element.</p>
</li>
<li>
<p>Then our QUnit tests file loads.</p>
</li>
<li>
<p>Then each test runs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But, thinking it through, each test is going to "reset" the fixtures div, which
means destroying and re-creating the input element.  So the input element that
<em>list.js</em> sees and attaches the event listener to will be replaced with a new
one by the time each test runs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_an_initialize_function_for_more_control_over_execution_time">16.5.2. Using an Initialize Function for More Control Over Execution Time</h4>
<div class="paragraph">
<p>We need more control over the order of execution of our JavaScript.  Rather
than just relying on the code in <em>list.js</em> running whenever it is loaded by
a <code>&lt;script&gt;</code> tag, we can use a common pattern, which is to define an
"initialize" function, and call that when we want to in our tests (and
later in real life):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">var initialize = function () {
  console.log('initialize called');
  $('input[name="text"]').on('keypress', function () {
    console.log('in keypress handler');
    $('.has-error').hide();
  });
};
console.log('list.js loaded');</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And in our tests file, we call <code>initialize</code> with each test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch14l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test("errors should be hidden on keypress", function (assert) {
  console.log('in test 1');
  initialize();
  $('input[name="text"]').trigger('keypress');
  assert.equal($('.has-error').is(':visible'), false);
});

QUnit.test("errors aren't hidden if there is no keypress", function (assert) {
  console.log('in test 2');
  initialize();
  assert.equal($('.has-error').is(':visible'), true);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we should see our tests pass, and our debug output should make
more sense:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>2 assertions of 2 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)

list.js loaded
qunit tests start
in test 1
initialize called
in keypress handler
in test 2
initialize called</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  Let&#8217;s strip out those console.logs:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">var initialize = function () {
  $('input[name="text"]').on('keypress', function () {
    $('.has-error').hide();
  });
};</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And from the tests too&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test("errors should be hidden on keypress", function (assert) {
  initialize();
  $('input[name="text"]').trigger('keypress');
  assert.equal($('.has-error').is(':visible'), false);
});

QUnit.test("errors aren't hidden if there is no keypress", function (assert) {
  initialize();
  assert.equal($('.has-error').is(':visible'), true);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And for the moment of truth, we&#8217;ll pull in jQuery, our script, and
invoke our initialize function on our real pages:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch14l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;/div&gt;
    &lt;script src="/static/jquery-3.3.1.min.js"&gt;&lt;/script&gt;
    &lt;script src="/static/list.js"&gt;&lt;/script&gt;

    &lt;script&gt;
      initialize();
    &lt;/script&gt;

  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s good practice to put your script loads at the end of your body HTML,
    as it means the user doesn&#8217;t have to wait for all your JavaScript to load
    before they can see something on the page.  It also helps to make sure most
    of the DOM has loaded before any scripts run.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Aaaand we run our FT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_list_item_validation.\
ItemValidationTest.test_error_messages_are_cleared_on_input</strong>
[...]

Ran 1 test in 3.023s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!  That&#8217;s a commit!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add lists/static</strong>
$ <strong>git commit -m"add jquery, qunit tests, list.js with keypress listeners"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_columbo_says_onload_boilerplate_and_namespacing">16.6. Columbo Says: Onload Boilerplate and Namespacing</h3>
<div class="paragraph">
<p><em>Oh, and one more thing</em>.  Our
<code>initialize</code> function name is too generic&#8212;&#8203;what
if we include some third-party JavaScript tool later that also defines a
function called <code>initialize</code>? Let&#8217;s give ourselves a "namespace" that&#8217;s
unlikely to be used by anyone else:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">window.Superlists = {}; <i class="conum" data-value="1"></i><b>(1)</b>
window.Superlists.initialize = function () { <i class="conum" data-value="2"></i><b>(2)</b>
  $('input[name="text"]').on('keypress', function () {
    $('.has-error').hide();
  });
};</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We explicitly declare an object as a property of the "window" global,
giving it a name that we think no one else is likely to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we make our <code>initialize</code> function an attribute of that namespace
object.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There are lots of other, much cleverer ways of dealing with namespaces in
    JavaScript, but they are all more complicated, and I&#8217;m not enough of an
    expert to be able to steer you around them.  If you do want to learn
    more, search for <em>require.js</em>, which seemed to be the done thing, or at
    least it was in the last JavaScript femtosecond.
</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;script&gt;
QUnit.test("errors should be hidden on keypress", function (assert) {
  window.Superlists.initialize();
  $('input[name="text"]').trigger('keypress');
  assert.equal($('.has-error').is(':visible'), false);
});

QUnit.test("errors aren't hidden if there is no keypress", function (assert) {
  window.Superlists.initialize();
  assert.equal($('.has-error').is(':visible'), true);
});
  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, whenever you have some JavaScript that interacts with the DOM, it&#8217;s
always good to wrap it in some "onload" boilerplate code to make sure that the
page has fully loaded before it tries to do anything. Currently it works
anyway, because we&#8217;ve placed the <code>&lt;script&gt;</code> tag right at the bottom of the
page, but we shouldn&#8217;t rely on that.</p>
</div>
<div class="paragraph">
<p>The jQuery <code>onload</code> boilerplate is quite minimal:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    &lt;script&gt;

$(document).ready(function () {
  window.Superlists.initialize();
});

    &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Read more in the <a href="http://api.jquery.com/ready/">jQuery <code>.ready()</code> docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_testing_in_the_tdd_cycle">16.7. JavaScript Testing in the TDD Cycle</h3>
<div class="paragraph">
<p>You
may be wondering how these JavaScript tests fit in with our "double loop"
TDD cycle.  The answer is that they play exactly the same role as our
Python unit tests.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write an FT and see it fail.</p>
</li>
<li>
<p>Figure out what kind of code you need next: Python or JavaScript?</p>
</li>
<li>
<p>Write a unit test in either language, and see it fail.</p>
</li>
<li>
<p>Write some code in either language, and make the test pass.</p>
</li>
<li>
<p>Rinse and repeat.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Want a little more practice with JavaScript?  See if you can get our
    error messages to be hidden when the user clicks inside the input element,
    as well as just when they type in it.  You should be able to FT it too.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re almost ready to move on to <a href="#part3">[part3]</a>.  The last step is to deploy our
new code to our servers. Don&#8217;t forget to do a final commit including
<em>base.html</em> first!</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_few_things_that_didn_t_make_it_2">16.8. A Few Things That Didn&#8217;t Make It</h3>
<div class="paragraph">
<p>In
this chapter I wanted to cover the very basics of JavaScript testing and how
it fits into our TDD workflow in this chapter.  Here are a few pointers for
further research:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the moment, our test only checks that the JavaScript works on one page.
It works because we&#8217;re including it in <em>base.html</em>, but if we&#8217;d only
added it to <em>home.html</em> the tests would still pass.  It&#8217;s a judgement
call, but you could choose to write an extra test here.</p>
</li>
<li>
<p>When
writing JavaScript, get as much help from your editor as you can to
  avoid common "gotchas".  Check out syntax/error-checking tools like
  "jslint" and "jshint", also known as "linters".</p>
</li>
<li>
<p>QUnit
mainly expects you to "run" your tests using an actual web browser.
  This has the advantage that it&#8217;s easy to create some HTML fixtures that
  match the kind of HTML your site actually contains, for tests to run against.
  But it&#8217;s also possible to run JS tests from the command line.  We&#8217;ll see
  an example in <a href="#chapter_CI">Continuous Integration (CI)</a>.</p>
</li>
<li>
<p>The
new shiny thing in the world of frontend development are MVC frameworks
  like <em>angular.js</em> and React.  Most
tutorials for these use an RSpec-like
  assertion library called <a href="https://jasmine.github.io/">Jasmine</a>.  If you&#8217;re
  going to use one of them, you&#8217;ll probably find life easier if you use Jasmine
  rather than QUnit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is more JavaScript fun in this book too!  Have a look at the
<a href="#appendix_rest_api">Rest API appendix</a> when you&#8217;re ready for it.</p>
</div>
<div class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">JavaScript Testing Notes</div>
<div class="ulist">
<ul>
<li>
<p>One
of the great advantages of Selenium is that it allows you to test that
  your JavaScript really works, just as it tests your Python code.</p>
</li>
<li>
<p>There
are many JavaScript test running libraries out there.  QUnit is closely
  tied to jQuery, which is the main reason I chose it.</p>
</li>
<li>
<p>No
matter which testing library you use, you&#8217;ll always need to find solutions
  to the main challenge of JavaScript testing, which is about <em>managing global
  state</em>.  That includes:</p>
<div class="ulist">
<ul>
<li>
<p>the DOM / HTML fixtures</p>
</li>
<li>
<p>namespacing</p>
</li>
<li>
<p>understanding and controlling execution order.</p>
</li>
</ul>
</div>
</li>
<li>
<p>I don&#8217;t really mean it when I say that JavaScript is awful. It can actually
be quite fun.  But I&#8217;ll say it again: make sure you&#8217;ve read
<a href="#jsgoodparts"><em>JavaScript: The Good Parts</em></a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_deploying_validation">17. Deploying Our New Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s
time to deploy our brilliant new validation code to our live servers.
This will be a chance to see our automated deploy scripts in action for the
second time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this point I want to say a huge thanks to Andrew Godwin and the whole
    Django team.  Up until Django 1.7, I used to have a whole long section,
    entirely devoted to migrations.  Migrations now "just work", so I was able to
    drop it altogether.  Thanks for all the great work, gang!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_staging_deploy">17.1. Staging Deploy</h3>
<div class="paragraph">
<p>We start with the staging server:</p>
</div>
<div class="listingblock against-server">
<div class="content">
<pre>$ <strong>git push</strong>
$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy:host=elspeth@superlists-staging.ottg.eu</strong>
[...]
Disconnecting from superlists-staging.ottg.eu... done.</pre>
</div>
</div>
<div class="paragraph">
<p>Restart Gunicorn:</p>
</div>
<div class="listingblock server-commands skipme">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And run the tests against staging:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
OK</pre>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_live_deploy">17.2. Live Deploy</h3>
<div class="paragraph">
<p>Assuming all is well, we then run our deploy against live:</p>
</div>
<div class="listingblock against-server">
<div class="content">
<pre>$ <strong>fab deploy:host=elspeth@superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo service gunicorn-superlists.ottg.eu restart</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_to_do_if_you_see_a_database_error">17.3. What to Do If You See a Database Error</h3>
<div class="paragraph">
<p>Because our migrations introduce a new integrity constraint, you may find
that it fails to apply because some existing data violates that constraint.</p>
</div>
<div class="paragraph">
<p>At this point you have two choices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete the database on the server and try again.  After all, it&#8217;s only a
toy project!</p>
</li>
<li>
<p>Learn about data migrations.  See <a href="#data-migrations-appendix">Testing Database Migrations</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_git_tag_the_new_release">17.4. Wrap-Up: git tag the New Release</h3>
<div class="paragraph">
<p>The last thing to do is to tag the release in our VCS&#8212;&#8203;it&#8217;s important that
we&#8217;re always able to keep track of what&#8217;s live:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git tag -f LIVE</strong>  # needs the -f because we are replacing the old tag
$ <strong>export TAG=`date +DEPLOYED-%F/%H%M`</strong>
$ <strong>git tag $TAG</strong>
$ <strong>git push -f origin LIVE $TAG</strong></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some people don&#8217;t like to use <code>push -f</code> and update an existing tag, and
    will instead use some kind of version number to tag their releases.  Use
    whatever works for you.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And on that note, we can wrap up <a href="#part2">[part2]</a>, and move on to the more exciting
topics that comprise <a href="#part3">[part3]</a>.  Can&#8217;t wait!</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Deployment Procedure Review</div>
<div class="paragraph">
<p>We&#8217;ve done a couple of deploys now, so this is a good time for a little recap:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>git push</code> latest code</p>
</li>
<li>
<p>Deploy to staging and run functional tests against staging</p>
</li>
<li>
<p>Deploy to live</p>
</li>
<li>
<p>Tag the release</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Deployment procedures evolve and get more complex as projects grow, and it&#8217;s
an area that can grow hard to maintain, full of manual checks and procedures,
if you&#8217;re not careful to keep things automated.  There&#8217;s lots more to say about
this, but it&#8217;s out of scope for this book.  Do be sure to check out
<a href="#appendix3">Provisioning with Ansible</a>, and have a read around on the topic of
"continuous deployment."</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Unresolved directive in book.asciidoc - include::part3.harry.asciidoc[]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_spiking_custom_auth">18. User Authentication, Spiking, and <span class="keep-together">De-Spiking</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our
beautiful lists site has been live for a few days, and our users are
starting to come back to us with feedback.  "We love the site", they say, "but
we keep losing our lists.  Manually remembering URLs is hard. It&#8217;d be great if
it could remember what lists we&#8217;d started".</p>
</div>
<div class="paragraph">
<p>Remember Henry Ford and faster horses. Whenever you hear a user requirement,
it&#8217;s important to dig a little deeper and think&#8212;&#8203;what is the real requirement
here?  And how can I make it involve a cool new technology I&#8217;ve been wanting
to try out?</p>
</div>
<div class="paragraph">
<p>Clearly the requirement here is that people want to have some kind of user
account on the site.  So, without further ado, let&#8217;s dive into authentication.</p>
</div>
<div class="paragraph">
<p>Naturally
we&#8217;re not going to mess about with remembering passwords
ourselves&#8212;&#8203;besides being <em>so</em> '90s, secure storage of user passwords is a
security nightmare we&#8217;d rather leave to someone else.  We&#8217;ll use something
fun called passwordless auth instead.</p>
</div>
<div class="paragraph">
<p>(If you <em>insist</em> on storing your own passwords, Django&#8217;s default auth
module is ready and waiting for you. It&#8217;s nice and straightforward, and I&#8217;ll
leave it to you to discover on your own.)</p>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_passwordless_auth">18.1. Passwordless Auth</h3>
<div class="paragraph">
<p>What
authentication system could we use to avoid storing passwords ourselves?
Oauth?  Openid?  "Login with Facebook"?   Ugh.  For me those all have
unacceptable creepy overtones; why should Google or Facebook know what sites
you&#8217;re logging into and when?</p>
</div>
<div class="paragraph">
<p>In the first edition I used an experimental project called "Persona",
cooked up by a some of the wonderful techno-hippy-idealists at Mozilla, but
sadly that project was abandoned.</p>
</div>
<div class="paragraph">
<p>Instead I&#8217;ve found a fun approach to authentication that goes by the name
of "Passwordless", but you might call it "just use email".</p>
</div>
<div class="paragraph">
<p>The system was invented by someone annoyed at having to create
new passwords for so many websites, who found himself just using random,
throwaway passwords, not even trying to remember them, and using the
"forgot my password" feature whenever he needed to log in again. You can
<a href="https://medium.com/@ninjudd/passwords-are-obsolete-9ed56d483eb#.cx8iber30">read
all about it on Medium</a>.</p>
</div>
<div class="paragraph">
<p>The concept is:  just use email to verify someone&#8217;s identity.  If you&#8217;re
going to have a "forgot my password" feature, then you&#8217;re trusting email
anyway, so why not just go the whole hog?  Whenever someone wants to log in,
we generate a unique URL for them to use, email it to them, and they then
click through that to get into the site.</p>
</div>
<div class="paragraph">
<p>It&#8217;s by no means a perfect system, and in fact there are lots of subtleties
to be thought through before it would really make a good login solution for
a production website, but this is just a fun toy project so let&#8217;s give it a go.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exploratory_coding_aka_spiking">18.2. Exploratory Coding, aka "Spiking"</h3>
<div class="paragraph">
<p>Before
I wrote this chapter all I knew about passwordless auth was the outline
I&#8217;d read in the article linked above.  I&#8217;d never seen any code for it, and didn&#8217;t really know where
to start in building it.</p>
</div>
<div class="paragraph">
<p>In Chapters <a data-type="xref" href="#chapter_database_layer_validation" data-xrefstyle="select:labelnumber">#chapter_database_layer_validation</a> and <a data-type="xref" href="#chapter_simple_form" data-xrefstyle="select:labelnumber">#chapter_simple_form</a> we saw that you
can use a unit test as a way of exploring a new API or tool, but sometimes you
just want to hack something together without any
tests at all, just to see if it works, to learn it or get a feel for it.
That&#8217;s absolutely fine.  When learning a new tool or exploring a new possible
solution, it&#8217;s often appropriate to leave the rigorous TDD process to one side,
and build a little prototype without tests, or perhaps with very few tests.
The goat doesn&#8217;t mind looking the other way for a bit.</p>
</div>
<div class="paragraph">
<p>This kind of prototyping activity is often called a "spike", for
<a href="http://stackoverflow.com/questions/249969/why-are-tdd-spikes-called-spikes">reasons
best known</a>.</p>
</div>
<div class="paragraph">
<p>The
first thing I did was take a look at existing Python and Django authentication
packages, like <a href="http://www.intenct.nl/projects/django-allauth/">django-allauth</a>
and <a href="https://github.com/omab/python-social-auth">python-social-auth</a>, but both of
them looked overcomplicated for this stage (and besides, it&#8217;ll be more fun to
code our own!).</p>
</div>
<div class="paragraph">
<p>So instead I dived in and hacked about, and after a few dead ends and wrong turns,
I had something which just about works.  I&#8217;ll take you on a tour, and then
we&#8217;ll go through and "de-spike" the implementation—that is, replace the prototype
with tested, production-ready code.</p>
</div>
<div class="paragraph">
<p>You should go ahead and add this code to your own site too, and then you can
have a play with it, try logging in with your own email address, and convince
yourself that it really does work.</p>
</div>
<div class="sect3">
<h4 id="_starting_a_branch_for_the_spike">18.2.1. Starting a Branch for the Spike</h4>
<div class="paragraph">
<p>Before
embarking on a spike, it&#8217;s a good idea to start a new branch, so you
can still use your VCS without worrying about your spike commits getting mixed
up with your production code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git checkout -b passwordless-spike</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s keep track of some of the things we&#8217;re hoping to learn from the
spike:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>How to send emails</em></p>
</li>
<li>
<p><em>Generating and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em></p>
</li>
<li>
<p><em>What steps will the user have to go through?</em></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_frontend_log_in_ui">18.2.2. Frontend Log in UI</h4>
<div class="paragraph">
<p>Let&#8217;s
start with the frontend, hacking in an actual form to be able to
enter your email address into the navbar, and a logout link for
users who are already authenticated:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch16l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;body&gt;
  &lt;div class="container"&gt;

    &lt;div class="navbar"&gt;
      {% if user.is_authenticated %}
        &lt;p&gt;Logged in as {{ user.email }}&lt;/p&gt;
        &lt;p&gt;&lt;a id="id_logout" href="{% url 'logout' %}"&gt;Log out&lt;/a&gt;&lt;/p&gt;
      {% else %}
        &lt;form method="POST" action ="{% url 'send_login_email' %}"&gt;
          Enter email to log in: &lt;input name="email" type="text" /&gt;
          {% csrf_token %}
        &lt;/form&gt;
      {% endif %}
    &lt;/div&gt;

    &lt;div class="row"&gt;
    [...]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sending_emails_from_django">18.2.3. Sending Emails from Django</h4>
<div class="paragraph">
<p>The
login theory will be something like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When someone wants to log in, we generate a unique secret token for them,
store it in the database linked to their email, and send it to them.</p>
</li>
<li>
<p>They then check their email, which will have a link to a URL that includes
that token.</p>
</li>
<li>
<p>When they click that link, we check whether the token exists in database,
and if so, they are logged in as the associated user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First we prep an app for our accounts stuff:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py startapp accounts</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;ll wire up <em>urls.py</em> with at least one URL.  In the top-level <em>superlists/urls.py</em>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch16l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import include, url
from lists import views as list_views
from lists import urls as list_urls
from accounts import urls as accounts_urls

urlpatterns = [
    url(r'^$', list_views.home_page, name='home'),
    url(r'^lists/', include(list_urls)),
    url(r'^accounts/', include(accounts_urls)),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And in the accounts module&#8217;s <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/urls.py (ch16l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import url
from accounts import views

urlpatterns = [
    url(r'^send_email$', views.send_login_email, name='send_login_email'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the view that&#8217;s in charge of creating a token associated with the email
address the user puts in our login form:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch16l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import uuid
import sys
from django.shortcuts import render
from django.core.mail import send_mail

from accounts.models import Token


def send_login_email(request):
    email = request.POST['email']
    uid = str(uuid.uuid4())
    Token.objects.create(email=email, uid=uid)
    print('saving uid', uid, 'for email', email, file=sys.stderr)
    url = request.build_absolute_uri(f'/accounts/login?uid={uid}')
    send_mail(
        'Your login link for Superlists',
        f'Use this link to log in:\n\n{url}',
        'noreply@superlists',
        [email],
    )
    return render(request, 'login_email_sent.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For that to work we&#8217;ll need a placeholder message confirming the email was
sent:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/templates/login_email_sent.html (ch16l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;html&gt;
&lt;h1&gt;Email sent&lt;/h1&gt;

&lt;p&gt;Check your email, you'll find a message with a link that will log you into
the site.&lt;/p&gt;

&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(You can see how hacky this code is—we&#8217;d want to integrate this template
with our <em>base.html</em> in the real version.)</p>
</div>
<div class="paragraph">
<p>More importantly, for the Django <code>send_mail</code> function to work, we need to tell
Django our email server address.  I&#8217;m just using my
Gmail<sup class="footnote">[<a id="_footnoteref_28" class="footnote" href="#_footnote_28" title="View footnote.">28</a>]</sup>
account for now.  You can use any email provider you like, as long as they
support SMTP:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch16l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">EMAIL_HOST = 'smtp.gmail.com'
EMAIL_HOST_USER = 'obeythetestinggoat@gmail.com'
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_PASSWORD')
EMAIL_PORT = 587
EMAIL_USE_TLS = True</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If
you want to use Gmail as well, you&#8217;ll probably have to visit your
    Google account security settings page.  If you&#8217;re using two-factor auth,
    you&#8217;ll want to set up an
    <a href="https://myaccount.google.com/apppasswords">app-specific password</a>.
    If you&#8217;re not, you will probably still need to
    <a href="https://www.google.com/settings/security/lesssecureapps">allow access
    for less secure apps</a>. You might want to consider creating a new Google
    account for this purpose, rather than using one containing sensitive data.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_another_secret_another_environment_variable">18.2.4. Another Secret, Another Environment Variable</h4>
<div class="paragraph">
<p>Once
again, we have a "secret" that we want to avoid keeping directly in
our source code or on GitHub, so another environment variable gets
used in the <code>os.environ.get</code>.</p>
</div>
<div class="paragraph">
<p>To get this to work, we need to set it in the shell that&#8217;s running my dev
server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>export EMAIL_PASSWORD="sekrit"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Later we&#8217;ll see about adding that to the <em>.env</em> on the staging server as well.</p>
</div>
</div>
<div class="sect3">
<h4 id="_storing_tokens_in_the_database">18.2.5. Storing Tokens in the Database</h4>
<div class="paragraph">
<p>How
are we doing?</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em>Generating and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em></p>
</li>
<li>
<p><em>What steps will the user have to go through?</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll need a model to store our tokens in the database—they link an
email address with a unique ID.  Pretty simple:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch16l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.db import models

class Token(models.Model):
    email = models.EmailField()
    uid = models.CharField(max_length=255)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_authentication_models">18.2.6. Custom Authentication Models</h4>
<div class="paragraph">
<p>While
we&#8217;re messing about with models, let&#8217;s start experimenting with
authentication in Django.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Generating</span> and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em>&#8230;&#8203;</p>
</li>
<li>
<p><em>What steps will the user have to go through?</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The first thing we&#8217;ll need is a user model.
When I first wrote this, custom user models were a new thing in
Django, so I dived into the
<a href="https://docs.djangoproject.com/en/1.11/topics/auth/customizing/">Django
auth documentation</a> and tried to hack in the simplest possible one:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch16l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
from django.contrib.auth.models import (
    AbstractBaseUser, BaseUserManager, PermissionsMixin
)


class ListUser(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(primary_key=True)
    USERNAME_FIELD = 'email'
    #REQUIRED_FIELDS = ['email', 'height']

    objects = ListUserManager()

    @property
    def is_staff(self):
        return self.email == 'harry.percival@example.com'

    @property
    def is_active(self):
        return True</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s what I call a minimal user model!  One field, none of this
firstname/lastname/username nonsense, and, pointedly, no password!
Somebody else&#8217;s problem!</p>
</div>
<div class="paragraph">
<p>But, again, you can see that this code isn&#8217;t ready
for production, from the commented-out lines to the hardcoded harry
email address.  We&#8217;ll neaten this up quite a lot when we de-spike.</p>
</div>
<div class="paragraph">
<p>To get it to work, you need a model manager for the user:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">accounts/models.py (ch16l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
class ListUserManager(BaseUserManager):

    def create_user(self, email):
        ListUser.objects.create(email=email)

    def create_superuser(self, email, password):
        self.create_user(email)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>No need to worry about what a model manager is at this stage;
for now we just need it because we need it, and it just works.  When we
de-spike, we&#8217;ll examine each bit of code that actually ends up in production
and make sure we understand it fully.</p>
</div>
</div>
<div class="sect3">
<h4 id="_finishing_the_custom_django_auth">18.2.7. Finishing the Custom Django Auth</h4>
<div class="paragraph">
<p>Almost
there—our last step combines recognising the token and then actually logging the user in.  Once we&#8217;ve done this,
we&#8217;ll be able to pretty much strike off all the items on
our scratchpad:</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">How to send emails</span></em></p>
</li>
<li>
<p><em><span class="strikethrough line-through">Generating</span> and recognising unique tokens</em></p>
</li>
<li>
<p><em>How to authenticate someone in Django</em></p>
</li>
<li>
<p><em>What steps will the user have to go through?</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>So here&#8217;s the view that actually handles the click through from the link in the
email:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">accounts/views.py (ch16l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import uuid
import sys
from django.contrib.auth import authenticate
from django.contrib.auth import login as auth_login
from django.core.mail import send_mail
from django.shortcuts import redirect, render
[...]

def login(request):
    print('login view', file=sys.stderr)
    uid = request.GET.get('uid')
    user = authenticate(uid=uid)
    if user is not None:
        auth_login(request, user)
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The "authenticate" function invokes Django&#8217;s authentication framework, which
we configure using a "custom authentication backend",
whose job it is to validate the UID and return a user with the right email.</p>
</div>
<div class="paragraph">
<p>We could have done this stuff directly in the view, but we may as well
structure things the way Django expects.  It makes for a reasonably neat
separation of concerns:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch16l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import sys
from accounts.models import ListUser, Token

class PasswordlessAuthenticationBackend(object):

    def authenticate(self, uid):
        print('uid', uid, file=sys.stderr)
        if not Token.objects.filter(uid=uid).exists():
            print('no token found', file=sys.stderr)
            return None
        token = Token.objects.get(uid=uid)
        print('got token', file=sys.stderr)
        try:
            user = ListUser.objects.get(email=token.email)
            print('got user', file=sys.stderr)
            return user
        except ListUser.DoesNotExist:
            print('new user', file=sys.stderr)
            return ListUser.objects.create(email=token.email)


    def get_user(self, email):
        return ListUser.objects.get(email=email)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Again, lots of debug prints in there, and some duplicated code, not something
we&#8217;d want in production, but it works&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Finally, a logout view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch16l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib.auth import login as auth_login, logout as auth_logout
[...]

def logout(request):
    auth_logout(request)
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Add login and logout to our <em>urls.py</em>&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/urls.py (ch16l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import url
from accounts import views

urlpatterns = [
    url(r'^send_email$', views.send_login_email, name='send_login_email'),
    url(r'^login$', views.login, name='login'),
    url(r'^logout$', views.logout, name='logout'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Almost there! We switch on the auth backend and our new accounts app in
<em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch16l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">INSTALLED_APPS = [
    #'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'lists',
    'accounts',
]

AUTH_USER_MODEL = 'accounts.ListUser'
AUTHENTICATION_BACKENDS = [
    'accounts.authentication.PasswordlessAuthenticationBackend',
]

MIDDLEWARE = [
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A quick <code>makemigrations</code> to make the token and user models real:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  accounts/migrations/0001_initial.py
    - Create model ListUser
    - Create model Token</pre>
</div>
</div>
<div class="paragraph">
<p>And a <code>migrate</code> to build the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py migrate</strong>
[...]
Running migrations:
  Applying accounts.0001_initial... OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we should be all done! Why not spin up a dev server with <code>runserver</code> and
see how it all looks (<a href="#spike-login-worked">It works! It works! Mwahahahaha.</a>)?</p>
</div>
<div id="spike-login-worked" class="imageblock">
<div class="content">
<img src="images/twp2_1801.png" alt="successful login">
</div>
<div class="title">Figure 29. It works! It works! Mwahahahaha.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you get an <code>SMTPSenderRefused</code> error message, don&#8217;t forget to set
    the <code>EMAIL_PASSWORD</code> environment variable in the shell that&#8217;s running
    <code>runserver</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s pretty much it! Along the way, I had to fight pretty hard, including
clicking around the Gmail account security UI for a while, stumbling over
several missing attributes on my custom user model (because I didn&#8217;t read the
docs properly), and even at one point switching to the dev version of Django to
overcome a bug, which thankfully turned out to be irrelevant.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Aside: Logging to stderr</div>
<div class="paragraph">
<p>While
spiking, it&#8217;s pretty critical to be able to see exceptions that are being
generated by your code. Annoyingly, Django doesn&#8217;t send all exceptions to the
terminal by default, but you can make it do so with a variable called <code>LOGGING</code>
in <em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch16l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['console'],
        },
    },
    'root': {'level': 'INFO'},
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Django uses the rather "enterprisey" logging package from the Python standard
library, which, although very fully featured, does suffer from a fairly steep
learning curve. It&#8217;s covered a little more in <a href="#chapter_server_side_debugging">Server-Side Debugging</a>,
and in the <a href="https://docs.djangoproject.com/en/1.11/topics/logging/">Django docs</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>But we now have a working solution!  Let&#8217;s commit it on our spike branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add accounts</strong>
$ <strong>git commit -am "spiked in custom passwordless auth backend"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Time to de-spike!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_de_spiking">18.3. De-spiking</h3>
<div class="paragraph">
<p>De-spiking means
rewriting your prototype code using TDD.  We now have enough information to "do
it properly".  So what&#8217;s the first step?  An FT, of course!</p>
</div>
<div class="paragraph">
<p>We&#8217;ll stay on the spike branch for now, to see our FT pass against our spiked
code.  Then we&#8217;ll go back to master and commit just the FT.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a first, simple version of the FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_login.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core import mail
from selenium.webdriver.common.keys import Keys
import re

from .base import FunctionalTest

TEST_EMAIL = 'edith@example.com'
SUBJECT = 'Your login link for Superlists'


class LoginTest(FunctionalTest):

    def test_can_get_email_link_to_log_in(self):
        # Edith goes to the awesome superlists site
        # and notices a "Log in" section in the navbar for the first time
        # It's telling her to enter her email address, so she does
        self.browser.get(self.live_server_url)
        self.browser.find_element_by_name('email').send_keys(TEST_EMAIL)
        self.browser.find_element_by_name('email').send_keys(Keys.ENTER)

        # A message appears telling her an email has been sent
        self.wait_for(lambda: self.assertIn(
            'Check your email',
            self.browser.find_element_by_tag_name('body').text
        ))

        # She checks her email and finds a message
        email = mail.outbox[0]  <i class="conum" data-value="1"></i><b>(1)</b>
        self.assertIn(TEST_EMAIL, email.to)
        self.assertEqual(email.subject, SUBJECT)

        # It has a url link in it
        self.assertIn('Use this link to log in', email.body)
        url_search = re.search(r'http://.+/.+$', email.body)
        if not url_search:
            self.fail(f'Could not find url in email body:\n{email.body}')
        url = url_search.group(0)
        self.assertIn(self.live_server_url, url)

        # she clicks it
        self.browser.get(url)

        # she is logged in!
        self.wait_for(
            lambda: self.browser.find_element_by_link_text('Log out')
        )
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertIn(TEST_EMAIL, navbar.text)</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic pagebreak-before">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Were you worried about how we were going to handle retrieving emails in our
tests?  Thankfully we can cheat for now! When running tests, Django gives
us access to any emails the server tries to send via the <code>mail.outbox</code>
attribute. We&#8217;ll save checking "real" emails for later (but we will do it!).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And if we run the FT, it works!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
Not Found: /favicon.ico
saving uid [...]
login view
uid [...]
got token
new user

.
 ---------------------------------------------------------------------
Ran 1 test in 3.729s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>You can even see some of the debug output I left in my spiked view
implementations.  Now it&#8217;s time to revert all of our temporary changes,
and reintroduce them one by one in a test-driven way.</p>
</div>
<div class="sect3">
<h4 id="_reverting_our_spiked_code">18.3.1. Reverting Our Spiked Code</h4>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git checkout master</strong> # switch back to master branch
$ <strong>rm -rf accounts</strong> # remove any trace of spiked code
$ <strong>git add functional_tests/test_login.py</strong>
$ <strong>git commit -m "FT for login via email"</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now we rerun the FT and let it drive our development:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [name="email"]
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>The first thing it wants us to do is add an email input element. Bootstrap has
some built-in classes for navigation bars, so we&#8217;ll use them, and include a
form for the login email:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch16l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;div class="container"&gt;

  &lt;nav class="navbar navbar-default" role="navigation"&gt;
    &lt;div class="container-fluid"&gt;
      &lt;a class="navbar-brand" href="/"&gt;Superlists&lt;/a&gt;
      &lt;form class="navbar-form navbar-right" method="POST" action="#"&gt;
        &lt;span&gt;Enter email to log in:&lt;/span&gt;
        &lt;input class="form-control" name="email" type="text" /&gt;
        {% csrf_token %}
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/nav&gt;

  &lt;div class="row"&gt;
  [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now our FT fails because the login form doesn&#8217;t actually do anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Check your email' not found in 'Superlists\nEnter email to log
in:\nStart a new To-Do list'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I recommend reintroducing the <code>LOGGING</code> setting from earlier at this
    point.  There&#8217;s no need for an explicit test for it; our current test
    suite will let us know in the unlikely event that it breaks anything. As
    we&#8217;ll find out in <a href="#chapter_server_side_debugging">Server-Side Debugging</a>, it&#8217;ll be useful for
    debugging later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Time to start writing some Django code. We begin by creating an app called
<code>accounts</code> to hold all the files related to login:</p>
</div>
<div class="listingblock dofirst-ch16l021-1">
<div class="content">
<pre>$ <strong>python manage.py startapp accounts</strong></pre>
</div>
</div>
<div class="paragraph">
<p>You could even do a commit just for that, to be able to distinguish the
placeholder app files from our modifications.</p>
</div>
<div class="paragraph">
<p>Next let&#8217;s rebuild our minimal user model, with tests this time, and see
if it turns out neater than it did in the spike.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_minimal_custom_user_model">18.4. A Minimal Custom User Model</h3>
<div class="paragraph">
<p>Django&#8217;s
built-in user model makes all sorts of assumptions about what
information you want to track about users, from explicitly recording
first name and last
name<sup class="footnote">[<a id="_footnoteref_29" class="footnote" href="#_footnote_29" title="View footnote.">29</a>]</sup>
to forcing you to use a username.   I&#8217;m a great believer in not storing
information about users unless you absolutely must, so a user model that
records an email address and nothing else sounds good to me!</p>
</div>
<div class="paragraph">
<p>By now I&#8217;m sure you can manage to create the tests folder and its <em>__init__.py</em>,
remove <em>tests.py</em>, and then add a <em>test_models.py</em> to say:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch16l022">
<div class="title">accounts/tests/test_models.py (ch16l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase
from django.contrib.auth import get_user_model

User = get_user_model()


class UserModelTest(TestCase):

    def test_user_is_valid_with_email_only(self):
        user = User(email='a@b.com')
        user.full_clean()  # should not raise</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us an expected failure:</p>
</div>
<div class="listingblock dofirst-ch16l023">
<div class="content">
<pre>django.core.exceptions.ValidationError: {'password': ['This field cannot be
blank.'], 'username': ['This field cannot be blank.']}</pre>
</div>
</div>
<div class="paragraph">
<p>Password?  Username?  Bah!  How about this?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.db import models

class User(models.Model):
    email = models.EmailField()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we wire it up inside <em>settings.py</em>, adding <code>accounts</code> to <code>INSTALLED_APPS</code>
and a variable called <code>AUTH_USER_MODEL</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch16l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">INSTALLED_APPS = [
    #'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'lists',
    'accounts',
]

AUTH_USER_MODEL = 'accounts.User'</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The next error is a database error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such table: accounts_user</pre>
</div>
</div>
<div class="paragraph">
<p>That prompts us, as usual, to do a migration&#8230;&#8203; When we try, Django complains
that our custom user model is missing a couple of bits of metadata:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Traceback (most recent call last):
[...]
    if not isinstance(cls.REQUIRED_FIELDS, (list, tuple)):
AttributeError: type object 'User' has no attribute 'REQUIRED_FIELDS'</pre>
</div>
</div>
<div class="paragraph">
<p>Sigh.  Come on, Django, it&#8217;s only got one field, so you should be able to figure
out the answers to these questions for yourself.  Here you go:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class User(models.Model):
    email = models.EmailField()
    REQUIRED_FIELDS = []</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next silly question?<sup class="footnote">[<a id="_footnoteref_30" class="footnote" href="#_footnote_30" title="View footnote.">30</a>]</sup></p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
[...]
AttributeError: type object 'User' has no attribute 'USERNAME_FIELD'</pre>
</div>
</div>
<div class="paragraph">
<p>And we go through a few more of these, until we get to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class User(models.Model):
    email = models.EmailField()

    REQUIRED_FIELDS = []
    USERNAME_FIELD = 'email'
    is_anonymous = False
    is_authenticated = True</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now we get a slightly different error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
SystemCheckError: System check identified some issues:

ERRORS:
accounts.User: (auth.E003) 'User.email' must be unique because it is named as
the 'USERNAME_FIELD'.</pre>
</div>
</div>
<div class="paragraph">
<p>Well, the simple way to fix that would be like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch16l028-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    email = models.EmailField(unique=True)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now the migration is successful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  accounts/migrations/0001_initial.py
    - Create model User</pre>
</div>
</div>
<div class="paragraph">
<p>And the test passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 1 tests in 0.001s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>But our model isn&#8217;t quite as simple as it could be.  It has the email field,
and also an autogenerated "ID" field as its primary key.  We could make it
even simpler!</p>
</div>
<div class="sect3">
<h4 id="_tests_as_documentation">18.4.1. Tests as Documentation</h4>
<div class="paragraph">
<p>Let&#8217;s
go all the way and make the email field into the primary
key,<sup class="footnote">[<a id="_footnoteref_31" class="footnote" href="#_footnote_31" title="View footnote.">31</a>]</sup>
and thus implicitly remove the autogenerated <code>id</code> column.</p>
</div>
<div class="paragraph">
<p>Although we could just do it and our test would still pass, and conceivably
claim it was "just a refactor", it would be better to have a specific test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_models.py (ch16l028-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_email_is_primary_key(self):
        user = User(email='a@b.com')
        self.assertEqual(user.pk, 'a@b.com')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;ll help us remember if we ever come back and look at the code again
in future:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(user.pk, 'a@b.com')
AssertionError: None != 'a@b.com'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Your tests can be a form of documentation for your code&#8212;&#8203;they express
    what your requirements are of a particular class or function. Sometimes, if
    you forget why you&#8217;ve done something a particular way, going back and
    looking at the tests will give you the answer.  That&#8217;s why it&#8217;s important
    to give your tests explicit, verbose method names.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And here&#8217;s the implementation (feel free to check what happens with
<code>unique=True</code> first):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch16l028-4)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    email = models.EmailField(primary_key=True)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we mustn&#8217;t forget to adjust our migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm accounts/migrations/0001_initial.py</strong>
$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  accounts/migrations/0001_initial.py
    - Create model User</pre>
</div>
</div>
<div class="paragraph">
<p>And
both our tests pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 2 tests in 0.001s
OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_token_model_to_link_emails_with_a_unique_id">18.5. A Token Model to Link Emails with a Unique ID</h3>
<div class="paragraph">
<p>Next
let&#8217;s build a token model.  Here&#8217;s a short unit test
that captures the essence—you should be able to link an
email to a unique ID, and that ID shouldn&#8217;t be the same two
times in a row:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_models.py (ch16l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from accounts.models import Token
[...]


class TokenModelTest(TestCase):

    def test_links_user_with_auto_generated_uid(self):
        token1 = Token.objects.create(email='a@b.com')
        token2 = Token.objects.create(email='a@b.com')
        self.assertNotEqual(token1.uid, token2.uid)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t show every single listing for creating the
Token class in <em>models.py</em>; I&#8217;ll let you do that yourself
instead. Driving Django models with basic TDD involves jumping
through a few hoops because of the migration, so you&#8217;ll
see a few iterations like this—minimal code change,
make migrations, get new error, delete migrations,
re-create new migrations, another code change, and so on&#8230;&#8203;</p>
</div>
<div class="listingblock dofirst-ch16l031">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  accounts/migrations/0002_token.py
    - Create model Token
$ <strong>python manage.py test accounts</strong>
[...]
TypeError: 'email' is an invalid keyword argument for this function</pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll trust you to go through these conscientiously—remember,
I may not be able to see you, but the Testing Goat can!</p>
</div>
<div class="listingblock dofirst-ch16l032">
<div class="content">
<pre>$ <strong>rm accounts/migrations/0002_token.py</strong>
$ <strong>python manage.py makemigrations</strong>
Migrations for 'accounts':
  accounts/migrations/0002_token.py
    - Create model Token
$ <strong>python manage.py test accounts</strong>
AttributeError: 'Token' object has no attribute 'uid'</pre>
</div>
</div>
<div class="paragraph">
<p>Eventually you should get to this code&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch16l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Token(models.Model):
    email = models.EmailField()
    uid = models.CharField(max_length=40)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And this error:</p>
</div>
<div class="listingblock dofirst-ch16l034">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]

    self.assertNotEqual(token1.uid, token2.uid)
AssertionError: '' == ''</pre>
</div>
</div>
<div class="paragraph">
<p>And here we have to decide how to generate our random unique ID field.  We
could use the <code>random</code> module, but Python actually comes with another module
specifically designed for generating unique IDs called "uuid" (for "universally
unique id").</p>
</div>
<div class="paragraph">
<p>We can use that like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch16l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import uuid
[...]

class Token(models.Model):
    email = models.EmailField()
    uid = models.CharField(default=uuid.uuid4, max_length=40)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, with a bit more wrangling of migrations, that should get us to passing
tests:</p>
</div>
<div class="listingblock dofirst-ch16l036">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 3 tests in 0.015s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Well,  that gets us on our way!  The models layer is done, at least.
In the next chapter, we&#8217;ll get into mocking, a key technique for testing
external dependencies like email.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exploratory Coding, Spiking, and De-spiking</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Spiking</dt>
<dd>
<p>    Exploratory
coding to find out about a new API, or to explore the
    feasibility   of a new solution.  Spiking can be done without tests.  It&#8217;s
    a good idea to do your spike on a new branch, and go back to master when
    de-spiking.</p>
</dd>
<dt class="hdlist1">De-spiking</dt>
<dd>
<p>Taking the work from a spike and making it part of the production codebase.
The idea is to throw away the old spike code altogether, and start again
from scratch, using TDD once again. De-spiked code can often come out
looking quite different from the original spike, and usually much nicer.</p>
</dd>
<dt class="hdlist1">Writing your FT against spiked code</dt>
<dd>
<p>    Whether
or not this is a good idea depends on your circumstances.  The
    reason it can be useful is because it can help you write the FT
    correctly&#8212;&#8203;figuring out how to test your spike can be just as challenging
    as the spike itself.  On the other hand, it might constrain you towards
    reimplementing a very similar solution to your spiked one&#8212;&#8203;something to
    watch out for.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_mocking">19. Using Mocks to Test External Dependencies or Reduce Duplication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In
this chapter we&#8217;ll start testing the parts of our code that send emails.
In the FT, you saw that Django gives us a way of retrieving any emails it
sends by using the <code>mail.outbox</code> attribute.  But
in this chapter, I want
to demonstrate a very important testing technique called <em>mocking</em>, so for
the purpose of these unit tests, we&#8217;ll pretend that this nice Django shortcut
doesn&#8217;t exist.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Am I telling you not to use Django&#8217;s <code>mail.outbox</code>?  No; use it, it&#8217;s a
    neat shortcut.  But
I want to teach mocks because they&#8217;re a useful
    general-purpose tool for unit testing external dependencies.  You
    may not always be using Django! And even if you are, you may not
    be sending email&#8212;&#8203;any interaction with a third-party API is a good
    candidate for testing with mocks.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_before_we_start_getting_the_basic_plumbing_in">19.1. Before We Start: Getting the Basic Plumbing In</h3>
<div class="paragraph">
<p>Let&#8217;s
just get a basic view and URL set up first.  We can do so with a simple
test that our new URL for sending the login email should eventually redirect
back to the home page:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch17l001">
<div class="title">accounts/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase


class SendLoginEmailViewTest(TestCase):

    def test_redirects_to_home_page(self):
        response = self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        })
        self.assertRedirects(response, '/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Wire up the <code>include</code> in <em>superlists/urls.py</em>, plus the <code>url</code> in
<em>accounts/urls.py</em>, and get the test passing with something a bit like this:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch17l002">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core.mail import send_mail
from django.shortcuts import redirect

def send_login_email(request):
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve added the import of the <code>send_mail</code> function as a placeholder for now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 4 tests in 0.015s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>OK, now we have a starting point, so let&#8217;s get mocking!</p>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_manually_aka_monkeypatching">19.2. Mocking Manually, aka Monkeypatching</h3>
<div class="paragraph">
<p>When
we call <code>send_mail</code> in real life we expect Django to be making a
connection to our email provider, and sending an actual email across the public
internet.  That&#8217;s not something we want to happen in our tests. It&#8217;s a similar
problem whenever you have code that has external side effects—calling an
API, sending out a tweet or an SMS or whatever it may be. In our unit tests, we
don&#8217;t want to be sending out real tweets or API calls across the internet.  But
we would still like a way of testing that our code is correct.
Mocks<sup class="footnote">[<a id="_footnoteref_32" class="footnote" href="#_footnote_32" title="View footnote.">32</a>]</sup>
 are the answer.</p>
</div>
<div class="paragraph">
<p>Actually, one of the great things about Python is that its dynamic nature makes
it very easy to do things like mocking, or what&#8217;s sometimes called
<a href="https://en.wikipedia.org/wiki/Monkey_patch">monkeypatching</a>.  Let&#8217;s suppose
that, as a first step, we want to get to some code that invokes <code>send_mail</code>
with the right subject line, from address, and to address.  That would look
something like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def send_login_email(request):
    email = request.POST['email']
    # send_mail(
    #     'Your login link for Superlists',
    #     'body text tbc',
    #     'noreply@superlists',
    #     [email],
    # )
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>How can we test this, without calling the <em>real</em> <code>send_mail</code> function?  The
answer is that our test can ask Python to replace the <code>send_mail</code> function with
a fake version, at runtime, before we invoke the <code>send_login_email</code> view.
Check this out:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase
import accounts.views  <i class="conum" data-value="2"></i><b>(2)</b>

class SendLoginEmailViewTest(TestCase):
    [...]

    def test_sends_mail_to_address_from_post(self):
        self.send_mail_called = False

        def fake_send_mail(subject, body, from_email, to_list):  <i class="conum" data-value="1"></i><b>(1)</b>
            self.send_mail_called = True
            self.subject = subject
            self.body = body
            self.from_email = from_email
            self.to_list = to_list

        accounts.views.send_mail = fake_send_mail  <i class="conum" data-value="2"></i><b>(2)</b>

        self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        })


        self.assertTrue(self.send_mail_called)
        self.assertEqual(self.subject, 'Your login link for Superlists')
        self.assertEqual(self.from_email, 'noreply@superlists')
        self.assertEqual(self.to_list, ['edith@example.com'])</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We define a <code>fake_send_mail</code> function, which looks like the real
<code>send_mail</code> function, but all it does is save some information
about how it was called, using some variables on <code>self</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, before we execute the code under test by doing the <code>self.client.post</code>,
we swap out the real <code>accounts.views.send_mail</code> with our fake version—it&#8217;s as simple as just assigning it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It&#8217;s important to realise that there isn&#8217;t really anything magical going on here; we&#8217;re just taking advantage of Python&#8217;s dynamic nature and scoping rules.</p>
</div>
<div class="paragraph">
<p>Up until we actually invoke a function, we can modify the variables it has
access to, as long as we get into the right namespace (that&#8217;s why we import the
top-level accounts module, to be able to get down to the <code>accounts.views</code> module,
which is the scope that the <code>accounts.views.send_login_email</code> function will run
in).</p>
</div>
<div class="paragraph">
<p>This isn&#8217;t even something that only works inside unit tests.  You can do this
kind of "monkeypatching" in any kind of Python code!</p>
</div>
<div class="paragraph">
<p>That may take a little time to sink in.  See if you can convince yourself that
it&#8217;s not all totally crazy, before reading a couple of bits of further detail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Why do we use <code>self</code> as a way of passing information around? It&#8217;s just a
convenient variable that&#8217;s available both inside the scope of the
<code>fake_send_mail</code> function and outside of it.   We could use any mutable
object, like a list or a dictionary, as long as we are making in-place
changes to an existing variable that exists outside our fake function.
(Feel free to have a play around with different ways of doing this, if
you&#8217;re curious, and see what works and doesn&#8217;t work.)</p>
</li>
<li>
<p>The "before" is critical! I can&#8217;t tell you how many times I&#8217;ve sat
there, wondering why a mock isn&#8217;t working, only to realise that I didn&#8217;t
mock <em>before</em> I called the code under test.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s see if our hand-rolled mock object will let us test-drive some code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
    self.assertTrue(self.send_mail_called)
AssertionError: False is not true</pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s call <code>send_mail</code>, naively:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def send_login_email(request):
    send_mail()
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: fake_send_mail() missing 4 required positional arguments: 'subject',
'body', 'from_email', and 'to_list'</pre>
</div>
</div>
<div class="paragraph">
<p>Looks like our monkeypatch is working!  We&#8217;ve called <code>send_mail</code>, and it&#8217;s gone
into our <code>fake_send_mail</code> function, which wants more arguments.  Let&#8217;s try
this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def send_login_email(request):
    send_mail('subject', 'body', 'from_email', ['to email'])
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(self.subject, 'Your login link for Superlists')
AssertionError: 'subject' != 'Your login link for Superlists'</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s working pretty well.  And now we can work all the way through to
something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def send_login_email(request):
    email = request.POST['email']
    send_mail(
        'Your login link for Superlists',
        'body text tbc',
        'noreply@superlists',
        [email]
    )
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>and passing tests!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>

Ran 5 tests in 0.016s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Brilliant!  We&#8217;ve managed to write tests for some code, that
ordinarily<sup class="footnote">[<a id="_footnoteref_33" class="footnote" href="#_footnote_33" title="View footnote.">33</a>]</sup> would go out and try to send real emails across the internet,
and by "mocking out" the <code>send_email</code> function, we&#8217;re able to write
the tests and code all the same.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_python_mock_library">19.3. The Python Mock Library</h3>
<div class="paragraph">
<p>The
popular <em>mock</em> package was added to the standard library as part of Python
3.3.<sup class="footnote">[<a id="_footnoteref_34" class="footnote" href="#_footnote_34" title="View footnote.">34</a>]</sup>
It provides a magical object called a <code>Mock</code>; try this out in a Python shell:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; from unittest.mock import Mock
&gt;&gt;&gt; m = Mock()
&gt;&gt;&gt; m.any_attribute
&lt;Mock name='mock.any_attribute' id='140716305179152'&gt;
&gt;&gt;&gt; type(m.any_attribute)
&lt;class 'unittest.mock.Mock'&gt;
&gt;&gt;&gt; m.any_method()
&lt;Mock name='mock.any_method()' id='140716331211856'&gt;
&gt;&gt;&gt; m.foo()
&lt;Mock name='mock.foo()' id='140716331251600'&gt;
&gt;&gt;&gt; m.called
False
&gt;&gt;&gt; m.foo.called
True
&gt;&gt;&gt; m.bar.return_value = 1
&gt;&gt;&gt; m.bar(42, var='thing')
1
&gt;&gt;&gt; m.bar.call_args
call(42, var='thing')</code></pre>
</div>
</div>
<div class="paragraph">
<p>A magical object that responds to any request for an attribute or method call
with other mocks, that you can configure to return specific values for its
calls, and that allows you to inspect what it was called with?  Sounds like a
useful thing to be able to use in our unit tests!</p>
</div>
<div class="sect3">
<h4 id="_using_unittest_patch">19.3.1. Using unittest.patch</h4>
<div class="paragraph">
<p>And
as if that weren&#8217;t enough, the <code>mock</code> module also provides a helper
function called <code>patch</code>, which we can use to do the monkeypatching we did
by hand earlier.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll explain how it all works shortly, but let&#8217;s see it in action first:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase
from unittest.mock import patch
[...]

    @patch('accounts.views.send_mail')
    def test_sends_mail_to_address_from_post(self, mock_send_mail):
        self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        })

        self.assertEqual(mock_send_mail.called, True)
        (subject, body, from_email, to_list), kwargs = mock_send_mail.call_args
        self.assertEqual(subject, 'Your login link for Superlists')
        self.assertEqual(from_email, 'noreply@superlists')
        self.assertEqual(to_list, ['edith@example.com'])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you rerun the tests, you&#8217;ll see they still pass.  And since we&#8217;re always
suspicious of any test that still passes after a big change, let&#8217;s deliberately
break it just to see:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        self.assertEqual(to_list, ['schmedith@example.com'])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And let&#8217;s add a little debug print to our view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def send_login_email(request):
    email = request.POST['email']
    print(type(send_mail))
    send_mail(
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And run the tests again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
&lt;class 'function'&gt;
&lt;class 'unittest.mock.MagicMock'&gt;
[...]
AssertionError: Lists differ: ['edith@example.com'] !=
['schmedith@example.com']
[...]

Ran 5 tests in 0.024s

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, the tests fail.  And we can see just before the failure
message that when we print the <code>type</code> of the <code>send_mail</code> function,
in the first unit test it&#8217;s a normal function, but in the second unit
test we&#8217;re seeing a mock object.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s remove the deliberate mistake and dive into exactly what&#8217;s going on:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch17l010">
<div class="title">accounts/tests/test_views.py (ch17l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@patch('accounts.views.send_mail')  <i class="conum" data-value="1"></i><b>(1)</b>
def test_sends_mail_to_address_from_post(self, mock_send_mail):  <i class="conum" data-value="2"></i><b>(2)</b>
    self.client.post('/accounts/send_login_email', data={
        'email': 'edith@example.com'  <i class="conum" data-value="3"></i><b>(3)</b>
    })

    self.assertEqual(mock_send_mail.called, True)  <i class="conum" data-value="4"></i><b>(4)</b>
    (subject, body, from_email, to_list), kwargs = mock_send_mail.call_args  <i class="conum" data-value="5"></i><b>(5)</b>
    self.assertEqual(subject, 'Your login link for Superlists')
    self.assertEqual(from_email, 'noreply@superlists')
    self.assertEqual(to_list, ['edith@example.com'])</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>patch</code> decorator takes a dot-notation name of an object to monkeypatch.
That&#8217;s the equivalent of manually replacing the <code>send_mail</code> in
<code>accounts.views</code>.  The advantage of the decorator is that, firstly, it
automatically replaces the target with a mock.  And secondly, it
automatically puts the original object back at the end!  (Otherwise, the
object stays monkeypatched for the rest of the test run, which might cause
problems in other tests.)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>patch</code> then injects the mocked object into the test as an argument to
the test method.  We can choose whatever name we want for it, but I
usually use a convention of <code>mock_</code> plus the original name of the
object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We call our function under test as usual, but everything inside this
test method has our mock applied to it, so the view won&#8217;t call the
real <code>send_mail</code> object; it&#8217;ll be seeing <code>mock_send_mail</code> instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we can now make assertions about what happened to that mock object
during the test.  We can see it was called&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>&#8230;&#8203;and we can also unpack its various positional and keyword call arguments,
and examine what it was called with. (We&#8217;ll discuss <code>call_args</code> in a bit
more detail later.)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All crystal-clear? No? Don&#8217;t worry, we&#8217;ll do a couple more tests with mocks, to
see if they start to make more sense as we use them more.</p>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_a_little_further_along">19.3.2. Getting the FT a Little Further Along</h4>
<div class="paragraph">
<p>First let&#8217;s get back to our FT and see where it&#8217;s failing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Check your email' not found in 'Superlists\nEnter email to log
in:\nStart a new To-Do list'</pre>
</div>
</div>
<div class="paragraph">
<p>Submitting the email address currently has no effect, because the form isn&#8217;t
sending the data anywhere.  Let&#8217;s wire it up in
<em>base.html</em>:<sup class="footnote">[<a id="_footnoteref_35" class="footnote" href="#_footnote_35" title="View footnote.">35</a>]</sup></p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html (ch17l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;form class="navbar-form navbar-right"
      method="POST"
      action="{% url 'send_login_email' %}"&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Does that help?  Nope, same error.  Why?  Because we&#8217;re not actually displaying
a success message after we send the user an email.   Let&#8217;s add a test for that.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_django_messages_framework">19.3.3. Testing the Django Messages Framework</h4>
<div class="paragraph">
<p>We&#8217;ll
use Django&#8217;s "messages framework", which is often used to display
ephemeral "success" or "warning" messages to show the results of an action.
Have a look at the
<a href="https://docs.djangoproject.com/en/1.11/ref/contrib/messages/">django messages docs</a>
if you haven&#8217;t come across it already.</p>
</div>
<div class="paragraph">
<p>Testing Django messages is a bit contorted&#8212;&#8203;we have to pass <code>follow=True</code> to
the test client to tell it to get the page after the 302-redirect, and examine
its context for a list of messages (which we have to listify before it&#8217;ll
play nicely).  Here&#8217;s what it looks like:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_adds_success_message(self):
        response = self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        }, follow=True)

        message = list(response.context['messages'])[0]
        self.assertEqual(
            message.message,
            "Check your email, we've sent you a link you can use to log in."
        )
        self.assertEqual(message.tags, "success")</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
    message = list(response.context['messages'])[0]
IndexError: list index out of range</pre>
</div>
</div>
<div class="paragraph">
<p>And we can get it passing with:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib import messages
[...]

def send_login_email(request):
    [...]
    messages.success(
        request,
        "Check your email, we've sent you a link you can use to log in."
    )
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div id="mocks-tightly-coupled-sidebar" class="sidebarblock">
<div class="content">
<div class="title">Mocks Can Leave You Tightly Coupled to the Implementation</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This sidebar is an intermediate-level testing tip.  If it goes over your
head the first time around, come back and take another look when you&#8217;ve
finished this chapter and <a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>I said testing messages is a bit contorted; it took me several goes to get it
right.  In fact, at work, we gave up on testing them like this and
decided to just use mocks.  Let&#8217;s see what that would look like in this case:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">accounts/tests/test_views.py (ch17l014-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest.mock import patch, call
[...]

    @patch('accounts.views.messages')
    def test_adds_success_message_with_mocks(self, mock_messages):
        response = self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        })

        expected = "Check your email, we've sent you a link you can use to log in."
        self.assertEqual(
            mock_messages.success.call_args,
            call(response.wsgi_request, expected),
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We mock out the <code>messages</code> module, and check that <code>messages.success</code> was
called with the right args: the original request, and the message we want.</p>
</div>
<div class="paragraph">
<p>And you could get it passing by using the exact same code as earlier.  Here&#8217;s
the problem though:  the <code>messages</code> framework gives you more than one way to
achieve the same result.  I could write the code like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l014-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    messages.add_message(
        request,
        messages.SUCCESS,
        "Check your email, we've sent you a link you can use to log in."
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the original, nonmocky test would still pass.  But our mocky test will
fail, because we&#8217;re no longer calling <code>messages.success</code>, we&#8217;re calling
<code>messages.add_message</code>. Even though the end result is the same and our code
is "correct," the test is broken.</p>
</div>
<div class="paragraph">
<p>This is what people mean when they say that using mocks can leave you "tightly
coupled with the implementation".   We usually say it&#8217;s better to test behaviour,
not implementation details; test what happens, not how you do it.  Mocks often
end up erring too much on the side of the "how" rather than the "what".</p>
</div>
<div class="paragraph">
<p>There&#8217;s more detailed discussion of the pros and cons of mocks in
<a href="#chapter_purist_unit_tests">later chapters</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_messages_to_our_html">19.3.4. Adding Messages to Our HTML</h4>
<div class="paragraph">
<p>What happens next in the functional test?  Ah.  Still nothing.  We
need to actually add the messages to the page.  Something like this:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch17l014-4">
<div class="title">lists/templates/base.html (ch17l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">      [...]
      &lt;/nav&gt;

      {% if messages %}
        &lt;div class="row"&gt;
          &lt;div class="col-md-8"&gt;
            {% for message in messages %}
              {% if message.level_tag == 'success' %}
                &lt;div class="alert alert-success"&gt;{{ message }}&lt;/div&gt;
              {% else %}
                &lt;div class="alert alert-warning"&gt;{{ message }}&lt;/div&gt;
              {% endif %}
            {% endfor %}
          &lt;/div&gt;
        &lt;/div&gt;
      {% endif %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now do we get a little further?  Yes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 6 tests in 0.023s

OK

$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: 'Use this link to log in' not found in 'body text tbc'</pre>
</div>
</div>
<div class="paragraph">
<p>We need to fill out the body text of the email, with a link that the
user can use to log in.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just cheat for now though, by changing the value in the view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    send_mail(
        'Your login link for Superlists',
        'Use this link to log in',
        'noreply@superlists',
        [email]
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets the FT a little further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
AssertionError: Could not find url in email body:
Use this link to log in</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_starting_on_the_login_url">19.3.5. Starting on the Login URL</h4>
<div class="paragraph">
<p>We&#8217;re going to have to build some kind of URL!  Let&#8217;s build one that, again,
just cheats:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class LoginViewTest(TestCase):

    def test_redirects_to_home_page(self):
        response = self.client.get('/accounts/login?token=abcd123')
        self.assertRedirects(response, '/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re imagining we&#8217;ll pass the token in as a GET parameter, after the <code>?</code>.
It doesn&#8217;t need to do anything for now.</p>
</div>
<div class="paragraph">
<p>I&#8217;m sure you can find your way through to getting the boilerplate in for a basic
URL and view, via errors like these:</p>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>No URL:</p>
<div class="listingblock small-code">
<div class="content">
<pre>AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</pre>
</div>
</div>
</li>
<li>
<p>No view:</p>
<div class="listingblock dofirst-ch17l018 small-code">
<div class="content">
<pre>AttributeError: module 'accounts.views' has no attribute 'login'</pre>
</div>
</div>
</li>
<li>
<p>Broken view:</p>
<div class="listingblock dofirst-ch17l019 small-code">
<div class="content">
<pre>ValueError: The view accounts.views.login didn't return an HttpResponse object.
It returned None instead.</pre>
</div>
</div>
</li>
<li>
<p>OK!</p>
<div class="listingblock dofirst-ch17l020 small-code">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]

Ran 7 tests in 0.029s
OK</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>And now we can give them a link to use.  It still won&#8217;t do much though, because
we still don&#8217;t have a token to give to the user.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_that_we_send_the_user_a_link_with_a_token">19.3.6. Checking That We Send the User a Link with a Token</h4>
<div class="paragraph">
<p>Back in our <code>send_login_email</code> view, we&#8217;ve tested the email subject, from, and
to fields.  The body is the part that will have to include a token or URL they
can use to log in.  Let&#8217;s spec out two tests for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from accounts.models import Token
[...]

    def test_creates_token_associated_with_email(self):
        self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        })
        token = Token.objects.first()
        self.assertEqual(token.email, 'edith@example.com')


    @patch('accounts.views.send_mail')
    def test_sends_link_to_login_using_token_uid(self, mock_send_mail):
        self.client.post('/accounts/send_login_email', data={
            'email': 'edith@example.com'
        })

        token = Token.objects.first()
        expected_url = f'http://testserver/accounts/login?token={token.uid}'
        (subject, body, from_email, to_list), kwargs = mock_send_mail.call_args
        self.assertIn(expected_url, body)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The first test is fairly straightforward; it checks that the token
we create in the database is associated with the email address from
the post request.</p>
</div>
<div class="paragraph">
<p>The second one is our second test using mocks.  We mock out the <code>send_mail</code>
function again using the <code>patch</code> decorator, but this time we&#8217;re interested
in the <code>body</code> argument from the call arguments.</p>
</div>
<div class="paragraph">
<p>Running them now will fail because we&#8217;re not creating any kind of token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
AttributeError: 'NoneType' object has no attribute 'email'
[...]
AttributeError: 'NoneType' object has no attribute 'uid'</pre>
</div>
</div>
<div class="paragraph">
<p>We can get the first one to pass by creating a token:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from accounts.models import Token
[...]

def send_login_email(request):
    email = request.POST['email']
    token = Token.objects.create(email=email)
    send_mail(
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now the second test prompts us to actually use the token in the body
of our email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
AssertionError:
'http://testserver/accounts/login?token=[...]
not found in 'Use this link to log in'

FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>So we can insert the token into our email like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.core.urlresolvers import reverse
[...]

def send_login_email(request):
    email = request.POST['email']
    token = Token.objects.create(email=email)
    url = request.build_absolute_uri(  <i class="conum" data-value="1"></i><b>(1)</b>
        reverse('login') + '?token=' + str(token.uid)
    )
    message_body = f'Use this link to log in:\n\n{url}'
    send_mail(
        'Your login link for Superlists',
        message_body,
        'noreply@superlists',
        [email]
    )
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>request.build_absolute_uri</code> deserves a mention—it&#8217;s one way to build
a "full" URL, including the domain name and the http(s) part, in Django.
There are other ways, but they usually involve getting into the "sites"
framework, and that gets overcomplicated pretty quickly.  You can find
lots more discussion on this if you&#8217;re curious by doing a bit of googling.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Two more pieces in the puzzle.  We need an authentication backend, whose
job it will be to examine tokens for validity and then return the corresponding
users; then we need to get our login view to actually log users in,
if they can authenticate.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_de_spiking_our_custom_authentication_backend">19.4. De-spiking Our Custom Authentication Backend</h3>
<div class="paragraph">
<p>Our
custom authentication backend is next.  Here&#8217;s how it looked in the spike:</p>
</div>
<div id="spike-reminder" class="listingblock skipme small-code">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class PasswordlessAuthenticationBackend(object):

    def authenticate(self, uid):
        print('uid', uid, file=sys.stderr)
        if not Token.objects.filter(uid=uid).exists():
            print('no token found', file=sys.stderr)
            return None
        token = Token.objects.get(uid=uid)
        print('got token', file=sys.stderr)
        try:
            user = ListUser.objects.get(email=token.email)
            print('got user', file=sys.stderr)
            return user
        except ListUser.DoesNotExist:
            print('new user', file=sys.stderr)
            return ListUser.objects.create(email=token.email)


    def get_user(self, email):
        return ListUser.objects.get(email=email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Decoding this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We take a UID and check if it exists in the database.</p>
</li>
<li>
<p>We return <code>None</code> if it doesn&#8217;t.</p>
</li>
<li>
<p>If it does exist, we extract an email address, and either find an existing
user with that address, or create a new one.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_1_if_1_more_test">19.4.1. 1 if = 1 More Test</h4>
<div class="paragraph">
<p>A rule of thumb for these sorts of tests:  any <code>if</code> means an extra test, and
any <code>try/except</code> means an extra test, so this should be about three tests.
How about something like this?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_authentication.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase
from django.contrib.auth import get_user_model
from accounts.authentication import PasswordlessAuthenticationBackend
from accounts.models import Token
User = get_user_model()


class AuthenticateTest(TestCase):

    def test_returns_None_if_no_such_token(self):
        result = PasswordlessAuthenticationBackend().authenticate(
            'no-such-token'
        )
        self.assertIsNone(result)


    def test_returns_new_user_with_correct_email_if_token_exists(self):
        email = 'edith@example.com'
        token = Token.objects.create(email=email)
        user = PasswordlessAuthenticationBackend().authenticate(token.uid)
        new_user = User.objects.get(email=email)
        self.assertEqual(user, new_user)


    def test_returns_existing_user_with_correct_email_if_token_exists(self):
        email = 'edith@example.com'
        existing_user = User.objects.create(email=email)
        token = Token.objects.create(email=email)
        user = PasswordlessAuthenticationBackend().authenticate(token.uid)
        self.assertEqual(user, existing_user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In <em>authenticate.py</em> we&#8217;ll just have a little placeholder:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class PasswordlessAuthenticationBackend(object):

    def authenticate(self, uid):
        pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>How do we get on?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>

.FE.........
======================================================================
ERROR: test_returns_new_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/accounts/tests/test_authentication.py", line 21, in
test_returns_new_user_with_correct_email_if_token_exists
    new_user = User.objects.get(email=email)
[...]
accounts.models.DoesNotExist: User matching query does not exist.

======================================================================
FAIL: test_returns_existing_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/accounts/tests/test_authentication.py", line 30, in
test_returns_existing_user_with_correct_email_if_token_exists
    self.assertEqual(user, existing_user)
AssertionError: None != &lt;User: User object&gt;

 ---------------------------------------------------------------------
Ran 12 tests in 0.038s

FAILED (failures=1, errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s a first cut:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from accounts.models import User, Token

class PasswordlessAuthenticationBackend(object):

    def authenticate(self, uid):
        token = Token.objects.get(uid=uid)
        return User.objects.get(email=token.email)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets one test passing but breaks another one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
ERROR: test_returns_None_if_no_such_token
(accounts.tests.test_authentication.AuthenticateTest)

accounts.models.DoesNotExist: Token matching query does not exist.

ERROR: test_returns_new_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
[...]
accounts.models.DoesNotExist: User matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s fix each of those in turn:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def authenticate(self, uid):
        try:
            token = Token.objects.get(uid=uid)
            return User.objects.get(email=token.email)
        except Token.DoesNotExist:
            return None</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us down to one failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_returns_new_user_with_correct_email_if_token_exists
(accounts.tests.test_authentication.AuthenticateTest)
[...]
accounts.models.DoesNotExist: User matching query does not exist.

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>And we can handle the final case like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def authenticate(self, uid):
        try:
            token = Token.objects.get(uid=uid)
            return User.objects.get(email=token.email)
        except User.DoesNotExist:
            return User.objects.create(email=token.email)
        except Token.DoesNotExist:
            return None</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s turned out neater than our spike!</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_get_user_method">19.4.2. The get_user Method</h4>
<div class="paragraph">
<p>We&#8217;ve
handled the <code>authenticate</code> function which Django will use to log new
users in.  The second part of the protocol we have to implement is the
<code>get_user</code> method, whose job is to retrieve a user based on their unique
identifier (the email address), or to return <code>None</code> if it can&#8217;t find one
(have another look at <a href="#spike-reminder">the spiked code</a> if you need a
reminder).</p>
</div>
<div class="paragraph">
<p>Here are a couple of tests for those two requirements:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_authentication.py (ch17l030)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class GetUserTest(TestCase):

    def test_gets_user_by_email(self):
        User.objects.create(email='another@example.com')
        desired_user = User.objects.create(email='edith@example.com')
        found_user = PasswordlessAuthenticationBackend().get_user(
            'edith@example.com'
        )
        self.assertEqual(found_user, desired_user)


    def test_returns_None_if_no_user_with_that_email(self):
        self.assertIsNone(
            PasswordlessAuthenticationBackend().get_user('edith@example.com')
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our first failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'PasswordlessAuthenticationBackend' object has no attribute
'get_user'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a placeholder one then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class PasswordlessAuthenticationBackend(object):

    def authenticate(self, uid):
        [...]

    def get_user(self, email):
        pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(found_user, desired_user)
AssertionError: None != &lt;User: User object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And (step by step, just to see if our test fails the way we think it will):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def get_user(self, email):
        return User.objects.first()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us past the first assertion, and onto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(found_user, desired_user)
AssertionError: &lt;User: User object&gt; != &lt;User: User object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And so we call <code>get</code> with the email as an argument:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l034)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def get_user(self, email):
        return User.objects.get(email=email)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now our test for the <code>None</code> case fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_returns_None_if_no_user_with_that_email
[...]
accounts.models.DoesNotExist: User matching query does not exist.</pre>
</div>
</div>
<div class="paragraph">
<p>Which prompts us to finish the method like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/authentication.py (ch17l035)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def get_user(self, email):
        try:
            return User.objects.get(email=email)
        except User.DoesNotExist:
            return None  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You could just use <code>pass</code> here, and the function would return <code>None</code>
by default.  However, because we specifically need the function to return
<code>None</code>, the "explicit is better than implicit" rule applies here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gets us to passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we have a working authentication backend!</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_our_auth_backend_in_the_login_view">19.4.3. Using Our Auth Backend in the Login View</h4>
<div class="paragraph">
<p>The final step is to use the backend in our login view.  First we add it
to <em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch17l036)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">AUTH_USER_MODEL = 'accounts.User'
AUTHENTICATION_BACKENDS = [
    'accounts.authentication.PasswordlessAuthenticationBackend',
]

[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next let&#8217;s write some tests for what should happen in our view. Looking
back at the spike again:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">accounts/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def login(request):
    print('login view', file=sys.stderr)
    uid = request.GET.get('uid')
    user = auth.authenticate(uid=uid)
    if user is not None:
        auth.login(request, user)
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We need the view to call <code>django.contrib.auth.authenticate</code>, and then,
if it returns a user, we call <code>django.contrib.auth.login</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This
is a good time to check out the
    <a href="https://docs.djangoproject.com/en/1.11/topics/auth/default/#how-to-log-a-user-in">Django
    docs on authentication</a> for a little more context.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_alternative_reason_to_use_mocks_reducing_duplication">19.5. An Alternative Reason to Use Mocks: Reducing Duplication</h3>
<div class="paragraph">
<p>So
far we&#8217;ve used mocks to test external dependencies, like Django&#8217;s
mail-sending function.  The main reason to use a mock was to isolate
ourselves from external side effects, in this case, to avoid sending out
actual emails during our tests.</p>
</div>
<div class="paragraph">
<p>In this section we&#8217;ll look at a different kind of use of mocks.  Here we
don&#8217;t have any side effects we&#8217;re worried about, but there are still some
reasons you might want to use a mock here.</p>
</div>
<div class="paragraph">
<p>The nonmocky way of testing this login view would be to see whether it does
actually log the user in, by checking whether the user gets assigned an
authenticated session cookie in the right circumstances.</p>
</div>
<div class="paragraph">
<p>But our authentication backend does have a few different code paths:
it returns <code>None</code> for invalid tokens, existing users if they already exist,
and creates new users for valid tokens if they don&#8217;t exist yet. So, to fully
test this view, I&#8217;d have to write tests for all three of those cases.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
One
good justification for using mocks is when they will reduce
    duplication between tests.  It&#8217;s one way of avoiding <em>combinatorial
    explosion</em>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On top of that, the fact that we&#8217;re using the Django
<code>auth.authenticate</code> function rather than calling our own code directly is
relevant: it allows us the option to add further backends in future.</p>
</div>
<div class="paragraph">
<p>So in this case (in contrast to the example in  <a href="#mocks-tightly-coupled-sidebar">Mocks Can Leave You Tightly Coupled to the Implementation</a>)
the implementation does matter, and using a mock will save us from having
duplication in our tests.  Let&#8217;s see how it looks:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">accounts/tests/test_views.py (ch17l037)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest.mock import patch, call
[...]

    @patch('accounts.views.auth')  <i class="conum" data-value="1"></i><b>(1)</b>
    def test_calls_authenticate_with_uid_from_get_request(self, mock_auth):  <i class="conum" data-value="2"></i><b>(2)</b>
        self.client.get('/accounts/login?token=abcd123')
        self.assertEqual(
            mock_auth.authenticate.call_args,  <i class="conum" data-value="3"></i><b>(3)</b>
            call(uid='abcd123')  <i class="conum" data-value="4"></i><b>(4)</b>
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We expect to be using the <code>django.contrib.auth</code> module in <em>views.py</em>,
and we mock it out here.  Note that this time, we&#8217;re not mocking out
a function, we&#8217;re mocking out a whole module, and thus implicitly
mocking out all the functions (and any other objects) that module contains.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As usual, the mocked object is injected into our test method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This time, we&#8217;ve mocked out a module rather than a function. So we examine
the <code>call_args</code> not of the <code>mock_auth</code> module, but of the
<code>mock_auth.authenticate</code> function.  Because all the attributes of a mock
are more mocks, that&#8217;s a mock too.  You can start to see why <code>Mock</code> objects
are so convenient, compared to trying to build your own.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now, instead of "unpacking" the call args, we use the <code>call</code> function
for a neater way of saying what it should have been called with&#8212;&#8203;that is,
the token from the GET request. (See the following sidebar.)</td>
</tr>
</table>
</div>
<div class="sidebarblock less_space pagebreak-before">
<div class="content">
<div class="title">On Mock call_args</div>
<div class="paragraph">
<p>The
<code>call_args</code> property on a mock represents the positional and keyword
arguments that the mock was called with.  It&#8217;s a special "call" object type,
which is essentially a tuple of <code>(positional_args, keyword_args)</code>.
<code>positional_args</code> is itself a tuple, consisting of the set of positional
arguments.  <code>keyword_args</code> is a dictionary.</p>
</div>
<div class="listingblock small-code skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; from unittest.mock import Mock, call
&gt;&gt;&gt; m = Mock()
&gt;&gt;&gt; m(42, 43, 'positional arg 3', key='val', thing=666)
&lt;Mock name='mock()' id='139909729163528'&gt;

&gt;&gt;&gt; m.call_args
call(42, 43, 'positional arg 3', key='val', thing=666)

&gt;&gt;&gt; m.call_args == ((42, 43, 'positional arg 3'), {'key': 'val', 'thing': 666})
True
&gt;&gt;&gt; m.call_args == call(42, 43, 'positional arg 3', key='val', thing=666)
True</code></pre>
</div>
</div>
<div class="paragraph">
<p>So in our test,  we could have done this instead:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">accounts/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    self.assertEqual(
        mock_auth.authenticate.call_args,
        ((,), {'uid': 'abcd123'})
    )
    # or this
    args, kwargs = mock_auth.authenticate.call_args
    self.assertEqual(args, (,))
    self.assertEqual(kwargs, {'uid': 'abcd123'})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But you can see how using the <code>call</code> helper is nicer.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>What happens when we run the test?   The first error is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
AttributeError: &lt;module 'accounts.views' from
'...python-tdd-book/accounts/views.py'&gt; does not have the attribute 'auth'</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>module foo does not have the attribute bar</code> is a common first failure
    in a test that uses mocks.  It&#8217;s telling you that you&#8217;re trying to mock
    out something that doesn&#8217;t yet exist (or isn&#8217;t yet imported) in the target
    module.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once we import <code>django.contrib.auth</code>, the error changes:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l038)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib import auth, messages
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: None != call(uid='abcd123')</pre>
</div>
</div>
<div class="paragraph">
<p>Now it&#8217;s telling us that the view doesn&#8217;t call the <code>auth.authenticate</code>
function at all.  Let&#8217;s fix that, but get it deliberately wrong, just to see:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l039)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def login(request):
    auth.authenticate('bang!')
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Bang indeed!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
AssertionError: call('bang!') != call(uid='abcd123')
[...]
FAILED (failures=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s give <code>authenticate</code> the arguments it expects then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l040)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def login(request):
    auth.authenticate(uid=request.GET.get('token'))
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us to passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
Ran 15 tests in 0.041s

OK</pre>
</div>
</div>
<div class="sect3">
<h4 id="_using_mock_return_value">19.5.1. Using mock.return_value</h4>
<div class="paragraph">
<p>Next
we want to check that if the authenticate function returns a user,
we pass that into <code>auth.login</code>.  Let&#8217;s see how that test looks:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l041)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@patch('accounts.views.auth')  <i class="conum" data-value="1"></i><b>(1)</b>
def test_calls_auth_login_with_user_if_there_is_one(self, mock_auth):
    response = self.client.get('/accounts/login?token=abcd123')
    self.assertEqual(
        mock_auth.login.call_args,  <i class="conum" data-value="2"></i><b>(2)</b>
        call(response.wsgi_request, mock_auth.authenticate.return_value)  <i class="conum" data-value="3"></i><b>(3)</b>
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock the <code>contrib.auth</code> module again.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This time we examine the call args for the <code>auth.login</code> function.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We check that it&#8217;s called with the request object that the view sees,
and the "user" object that the <code>authenticate</code> function returns.  Because
<code>authenticate</code> is also mocked out, we can use its special "return_value"
attribute.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you call a mock, you get another mock.  But you can also get a copy
of that returned mock from the original mock that you called.  Boy, it
sure is hard to explain this stuff without saying "mock" a lot! Another little
console illustration might help here:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">&gt;&gt;&gt; m = Mock()
&gt;&gt;&gt; thing = m()
&gt;&gt;&gt; thing
&lt;Mock name='mock()' id='140652722034952'&gt;
&gt;&gt;&gt; m.return_value
&lt;Mock name='mock()' id='140652722034952'&gt;
&gt;&gt;&gt; thing == m.return_value
True</code></pre>
</div>
</div>
<div class="paragraph">
<p>In any case, what do we get from running the test?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test accounts</strong>
[...]
    call(response.wsgi_request, mock_auth.authenticate.return_value)
AssertionError: None != call(&lt;WSGIRequest: GET '/accounts/login?t[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, it&#8217;s telling us that we&#8217;re not calling <code>auth.login</code> at all
yet.  Let&#8217;s try doing that.  Deliberately wrong as usual first!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l042)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def login(request):
    auth.authenticate(uid=request.GET.get('token'))
    auth.login('ack!')
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Ack indeed!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: login() missing 1 required positional argument: 'user'
[...]
AssertionError: call('ack!') != call(&lt;WSGIRequest: GET
'/accounts/login?token=[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s fix that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l043)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def login(request):
    user = auth.authenticate(uid=request.GET.get('token'))
    auth.login(request, user)
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we get this unexpected complaint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_redirects_to_home_page (accounts.tests.test_views.LoginViewTest)
[...]
AttributeError: 'AnonymousUser' object has no attribute '_meta'</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we&#8217;re still calling <code>auth.login</code> indiscriminately on any kind
of user, and that&#8217;s causing problems back in our original test for the
redirect, which <em>isn&#8217;t</em> currently mocking out <code>auth.login</code>.  We need to add an
<code>if</code> (and therefore another test), and while we&#8217;re at it we&#8217;ll learn about
patching at the class level.</p>
</div>
</div>
<div class="sect3">
<h4 id="_patching_at_the_class_level">19.5.2. Patching at the Class Level</h4>
<div class="paragraph">
<p>We
want to add another test, with another <code>@patch('accounts.views.auth')</code>,
and that&#8217;s starting to get repetitive.  We use the "three strikes" rule,
and we can move the patch decorator to the class level.  This will have
the effect of mocking out <code>accounts.views.auth</code> in every single test
method in that class.  That also means our original redirect test will
now also have the <code>mock_auth</code> variable injected:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_views.py (ch17l044)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@patch('accounts.views.auth')  <i class="conum" data-value="1"></i><b>(1)</b>
class LoginViewTest(TestCase):

    def test_redirects_to_home_page(self, mock_auth):  <i class="conum" data-value="2"></i><b>(2)</b>
        [...]

    def test_calls_authenticate_with_uid_from_get_request(self, mock_auth):  <i class="conum" data-value="3"></i><b>(3)</b>
        [...]

    def test_calls_auth_login_with_user_if_there_is_one(self, mock_auth):  <i class="conum" data-value="3"></i><b>(3)</b>
        [...]


    def test_does_not_login_if_user_is_not_authenticated(self, mock_auth):
        mock_auth.authenticate.return_value = None  <i class="conum" data-value="4"></i><b>(4)</b>
        self.client.get('/accounts/login?token=abcd123')
        self.assertEqual(mock_auth.login.called, False)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We move the patch to the class level&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>which means we get an extra argument injected into our first test method&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And we can remove the decorators from all the other tests.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In our new test, we explicitly set the <code>return_value</code> on the
<code>auth.authenticate</code> mock, <em>before</em> we call the <code>self.client.get</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We assert that, if <code>authenticate</code> returns <code>None</code>, we should not
call <code>auth.login</code> at all.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That cleans up the spurious failure, and gives us a specific, expected failure
to work on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(mock_auth.login.called, False)
AssertionError: True != False</pre>
</div>
</div>
<div class="paragraph">
<p>And we get it passing like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/views.py (ch17l045)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def login(request):
    user = auth.authenticate(uid=request.GET.get('token'))
    if user:
        auth.login(request, user)
    return redirect('/')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So are we there yet?</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Avoid Mock&#8217;s Magic assert_called&#8230;&#8203; Methods?</div>
<div class="paragraph">
<p>If you&#8217;ve used <code>unittest.mock</code> before, you may have come across its special
<code>assert_called...</code>
<a href="http://bit.ly/2F9AEMY">methods</a>, and you may be wondering why I didn&#8217;t use them. For example, instead of doing:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">self.assertEqual(a_mock.call_args, call(foo, bar))</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can just do:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">a_mock.assert_called_with(foo, bar)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the <em>mock</em> library will raise an <code>AssertionError</code> for you if there is a
mismatch.</p>
</div>
<div class="paragraph">
<p>Why not use that?  For me, the problem with these magic methods is that it&#8217;s too
easy to make a silly typo and end up with a test that always passes:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">a_mock.asssert_called_with(foo, bar)  # will always pass</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unless you get the magic method name exactly right, then you will
just get a "normal" mock method, which just silently return another
mock, and you may not realise that you&#8217;ve written a test that tests
nothing at all.</p>
</div>
<div class="paragraph">
<p>That&#8217;s why I prefer to always have an explicit <code>unittest</code> method in there.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_moment_of_truth_will_the_ft_pass">19.6. The Moment of Truth:  Will the FT Pass?</h3>
<div class="paragraph">
<p>I
think we&#8217;re just about ready to try our functional test!</p>
</div>
<div class="paragraph">
<p>Let&#8217;s just make sure our base template shows a different nav bar for logged-in
and non–logged-in users (which our FT relies on):</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html (ch17l046)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">&lt;nav class="navbar navbar-default" role="navigation"&gt;
  &lt;div class="container-fluid"&gt;
    &lt;a class="navbar-brand" href="/"&gt;Superlists&lt;/a&gt;
    {% if user.email %}
      &lt;ul class="nav navbar-nav navbar-right"&gt;
        &lt;li class="navbar-text"&gt;Logged in as {{ user.email }}&lt;/li&gt;
        &lt;li&gt;&lt;a href="#"&gt;Log out&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
    {% else %}
      &lt;form class="navbar-form navbar-right"
            method="POST"
            action="{% url 'send_login_email' %}"&gt;
        &lt;span&gt;Enter email to log in:&lt;/span&gt;
        &lt;input class="form-control" name="email" type="text" /&gt;
        {% csrf_token %}
      &lt;/form&gt;
    {% endif %}
  &lt;/div&gt;
&lt;/nav&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And see if that&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
Internal Server Error: /accounts/login
[...]
  File "...python-tdd-book/accounts/views.py", line 31, in login
    auth.login(request, user)
[...]
ValueError: The following fields do not exist in this model or are m2m fields:
last_login
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Log out</pre>
</div>
</div>
<div class="paragraph">
<p>Oh no!  Something&#8217;s not right.  But assuming you&#8217;ve kept the <code>LOGGING</code>
config in <em>settings.py</em>, you should see the explanatory traceback, as just
shown. It&#8217;s saying something about a <code>last_login</code> field.</p>
</div>
<div class="paragraph">
<p><a href="https://code.djangoproject.com/ticket/26823">In my opinion</a> this is a
bug in Django, but essentially the auth framework expects the user
model to have a <code>last_login</code> field.  We don&#8217;t have one.  But never fear!
There&#8217;s a way of handling this failure.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s write a unit test that reproduces the bug first. Since it&#8217;s to do
with our custom user model, as good a place to have it as any might be
<em>test_models.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/tests/test_models.py (ch17l047)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.test import TestCase
from django.contrib import auth
from accounts.models import Token
User = auth.get_user_model()


class UserModelTest(TestCase):

    def test_user_is_valid_with_email_only(self):
        [...]
    def test_email_is_primary_key(self):
        [...]

    def test_no_problem_with_auth_login(self):
        user = User.objects.create(email='edith@example.com')
        user.backend = ''
        request = self.client.request().wsgi_request
        auth.login(request, user)  # should not raise</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We create a request object and a user, and then we pass them into the
<code>auth.login</code> function.</p>
</div>
<div class="paragraph">
<p>That will raise our error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    auth.login(request, user)  # should not raise
[...]
ValueError: The following fields do not exist in this model or are m2m fields:
last_login</pre>
</div>
</div>
<div class="paragraph">
<p>The specific reason for this bug isn&#8217;t really important for the purposes of
this book, but if you&#8217;re curious about what exactly is going on here, take a
look through the Django source lines listed in the traceback, and have a read up
of Django&#8217;s <a href="https://docs.djangoproject.com/en/1.11/topics/signals/">docs on
signals</a>.</p>
</div>
<div class="paragraph">
<p>The upshot is that we can fix it like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/models.py (ch17l048)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import uuid
from django.contrib import auth
from django.db import models

auth.signals.user_logged_in.disconnect(auth.models.update_last_login)


class User(models.Model):
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>How does our FT look now?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
.
 ---------------------------------------------------------------------
Ran 1 test in 3.282s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_it_works_in_theory_does_it_work_in_practice">19.7. It Works in Theory!  Does It Work in Practice?</h3>
<div class="paragraph">
<p>Wow!
Can you believe it?  I scarcely can!  Time for a manual look around with
<code>runserver</code>:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py runserver</strong>
[...]
Internal Server Error: /accounts/send_login_email
Traceback (most recent call last):
  File "...python-tdd-book/accounts/views.py", line 20, in send_login_email

ConnectionRefusedError: [Errno 111] Connection refused</pre>
</div>
</div>
<div class="sect3">
<h4 id="_using_our_new_environment_variable_and_saving_it_to_env">19.7.1. Using Our New Environment Variable, and Saving It to .env</h4>
<div class="paragraph">
<p>You&#8217;ll probably get an error, like I did, when you try to run things manually.
It&#8217;s because of two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Firstly, we need to re-add the email configuration to <em>settings.py</em>.</p>
</li>
</ul>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py (ch17l049)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">EMAIL_HOST = 'smtp.gmail.com'
EMAIL_HOST_USER = 'obeythetestinggoat@gmail.com'
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_PASSWORD')
EMAIL_PORT = 587
EMAIL_USE_TLS = True</code></pre>
</div>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Secondly, we (probably) need to re-set the <code>EMAIL_PASSWORD</code> in our shell.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>export EMAIL_PASSWORD="yoursekritpasswordhere"</strong></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Using a Local .env File for Development</div>
<div class="paragraph">
<p>Until now we&#8217;ve only used the <em>.env</em> file on the server, because all the
other settings have sensible defaults for dev, but there&#8217;s just no way
to get a working login system without this one.</p>
</div>
<div class="paragraph">
<p>Just as we do on the server, you can also use a <em>.env</em> file to save
project-specific environment variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo EMAIL_PASSWORD="yoursekritpasswordhere" &gt;&gt; .env</strong>
$ <strong>set -a; source .env; set +a;</strong></pre>
</div>
</div>
<div class="paragraph">
<p>It does mean you have to remember to do that weird <code>set -a; source...</code> dance,
every time you start working on the project, as well as remembering to activate
your virtualenv.</p>
</div>
<div class="paragraph">
<p>If you search or ask around, you&#8217;ll find there are some tools and shell plugins
that load virtualenvs and <em>.env</em> files automatically, and/or django plugins
that do this stuff too.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Django-specific:
<a href="https://django-environ.readthedocs.io/en/latest/">django-environ</a> or
<a href="https://github.com/jpadilla/django-dotenv">django-dotenv</a></p>
</li>
<li>
<p>More general Python project management <a href="https://docs.pipenv.org/">Pipenv</a></p>
</li>
<li>
<p>Or even <a href="https://stackoverflow.com/questions/19331497/set-environment-variables-from-file/34093548#34093548">roll your own</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>And now&#8230;&#8203;</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py runserver</strong></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;you should see something like <a href="#despiked-success-message">Check your email&#8230;&#8203;.</a>.</p>
</div>
<div id="despiked-success-message" class="imageblock">
<div class="content">
<img src="images/twp2_1901.png" alt="de-spiked site with success message">
</div>
<div class="title">Figure 30. Check your email&#8230;&#8203;.</div>
</div>
<div class="paragraph">
<p>Woohoo!</p>
</div>
<div class="paragraph">
<p>I&#8217;ve been waiting to do a commit up until this moment, just to make sure
everything works.  At this point, you could make a series of separate
commits&#8212;&#8203;one for the login view, one for the auth backend, one for
the user model, one for wiring up the template.  Or you could decide that,
since they&#8217;re all interrelated, and none will work without the others,
you may as well just have one big commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git status</strong>
$ <strong>git add .</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit -m "Custom passwordless auth backend + custom user model"</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finishing_off_our_ft_testing_logout">19.8. Finishing Off Our FT, Testing Logout</h3>
<div class="paragraph">
<p>The
last thing we need to do before we call it a day is to test the logout
link.  We extend the FT with a couple more steps:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_login.py (ch17l050)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        [...]
        # she is logged in!
        self.wait_for(
            lambda: self.browser.find_element_by_link_text('Log out')
        )
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertIn(TEST_EMAIL, navbar.text)

        # Now she logs out
        self.browser.find_element_by_link_text('Log out').click()

        # She is logged out
        self.wait_for(
            lambda: self.browser.find_element_by_name('email')
        )
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertNotIn(TEST_EMAIL, navbar.text)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>With that, we can see that the test is failing because the logout button
doesn&#8217;t work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: [name="email"]</pre>
</div>
</div>
<div class="paragraph">
<p>Implementing a logout button is actually very simple:  we can use Django&#8217;s
<a href="http://bit.ly/SuI0hA">built-in logout view</a>, which clears down the user&#8217;s
session and redirects them to a page of our choice:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">accounts/urls.py (ch17l051)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib.auth.views import logout
[...]

urlpatterns = [
    url(r'^send_login_email$', views.send_login_email, name='send_login_email'),
    url(r'^login$', views.login, name='login'),
    url(r'^logout$', logout, {'next_page': '/'}, name='logout'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And in <em>base.html</em>, we just make the logout into a real URL link:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch17l052)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    &lt;li&gt;&lt;a href="{% url 'logout' %}"&gt;Log out&lt;/a&gt;&lt;/li&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gets us a fully passing FT&#8212;&#8203;indeed, a fully passing test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
OK
$ <strong>python manage.py test</strong>
[...]
Ran 59 tests in 78.124s

OK</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We&#8217;re
    nowhere near a truly secure or acceptable login system
    here.  Since this is just an example app for a book, we&#8217;ll leave it
    at that, but in "real life" you&#8217;d want to explore a lot more security
    and usability issues before calling the job done.  We&#8217;re dangerously
    close to "rolling our own crypto" here, and relying on a more established
    login system would be much safer.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the next chapter, we&#8217;ll start trying to put our login system to good use.
In the meantime, do a commit and enjoy this recap:</p>
</div>
<div id="mocking-py-sidebar" class="sidebarblock">
<div class="content">
<div class="title">On Mocking in Python</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mocking and external dependencies</dt>
<dd>
<p>We
use mocking in unit tests when we have an external dependency that we
don&#8217;t want to actually use in our tests.  A mock is used to simulate the
third-party API.   Whilst it is possible to "roll your own" mocks in
Python, a mocking framework like the <code>mock</code> module provides a lot of helpful
shortcuts which will make it easier to write (and more importantly, read)
your tests.</p>
</dd>
<dt class="hdlist1">Monkeypatching</dt>
<dd>
<p>Replacing
an object in a namespace at runtime.  We use it in our unit
tests to replace a real function which has undesirable side effects with a
mock object, using the <code>patch</code> decorator.</p>
</dd>
<dt class="hdlist1">The Mock library</dt>
<dd>
<p>Michael
Foord (who used to work for the company that spawned
PythonAnywhere, just before I joined) wrote the excellent "Mock"
library that&#8217;s now been integrated into the standard library of Python 3.
It contains most everything you might need for mocking in Python.</p>
</dd>
<dt class="hdlist1">The patch decorator</dt>
<dd>
<p><code>unittest.mock</code> provides
a function called <code>patch</code>, which can be used
to "mock out" any object from the module you&#8217;re testing.  It&#8217;s commonly
used as a decorator on a test method, or even at the class level, where
it&#8217;s applied to all the test methods of that class.</p>
</dd>
<dt class="hdlist1">Mocks can leave you tightly coupled to the implementation</dt>
<dd>
<p>As we saw in <a href="#mocks-tightly-coupled-sidebar">Mocks Can Leave You Tightly Coupled to the Implementation</a>,
mocks can leave you tightly coupled to your implementation. For that
reason, you shouldn&#8217;t use them unless you have a good reason.</p>
</dd>
<dt class="hdlist1">Mocks can save you from duplication in your tests</dt>
<dd>
<p>On
the other hand, there&#8217;s no point in duplicating all of your tests
for a function inside a higher-level piece of code that uses that
function.  Using a mock in this case reduces duplication.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>There&#8217;s lots more discussion of the pros and cons of mocks
<a href="#chapter_purist_unit_tests">coming up soon</a>.  Read on!</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_fixtures_and_wait_decorator">20. Test Fixtures and a Decorator for <span class="keep-together">Explicit Waits</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now
that we have a functional authentication system, we want to use it to
identify users, and be able to show them all the lists they have created.</p>
</div>
<div class="paragraph">
<p>To do that, we&#8217;re going to have to write FTs that have a logged-in user. Rather
than making each test go through the (time-consuming) login email dance, we
want to be able to skip that part.</p>
</div>
<div class="paragraph">
<p>This is about separation of concerns.  Functional tests aren&#8217;t like unit tests,
in that they don&#8217;t usually have a single assertion. But, conceptually, they
should be testing a single thing.  There&#8217;s no need for every single FT to test
the login/logout mechanisms. If we can figure out a way to "cheat" and skip
that part, we&#8217;ll spend less time waiting for duplicated test paths.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don&#8217;t overdo de-duplication in FTs.  One of the benefits of an FT is that
     it can catch strange and unpredictable interactions between different
     parts of your application.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter has only just been rewritten for the new edition, so let me
    know via <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a> if you spot any problems or have any
    suggestions for improvement!
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_skipping_the_login_process_by_pre_creating_a_session">20.1. Skipping the Login Process by Pre-creating a Session</h3>
<div class="paragraph">
<p>It&#8217;s
quite common for a user to return to a site and still have a cookie, which
means they are "pre-authenticated", so this isn&#8217;t an unrealistic cheat at all.
Here&#8217;s how you can set it up:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_my_lists.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf import settings
from django.contrib.auth import BACKEND_SESSION_KEY, SESSION_KEY, get_user_model
from django.contrib.sessions.backends.db import SessionStore
from .base import FunctionalTest
User = get_user_model()


class MyListsTest(FunctionalTest):

    def create_pre_authenticated_session(self, email):
        user = User.objects.create(email=email)
        session = SessionStore()
        session[SESSION_KEY] = user.pk <i class="conum" data-value="1"></i><b>(1)</b>
        session[BACKEND_SESSION_KEY] = settings.AUTHENTICATION_BACKENDS[0]
        session.save()
        ## to set a cookie we need to first visit the domain.
        ## 404 pages load the quickest!
        self.browser.get(self.live_server_url + "/404_no_such_url/")
        self.browser.add_cookie(dict(
            name=settings.SESSION_COOKIE_NAME,
            value=session.session_key, <i class="conum" data-value="2"></i><b>(2)</b>
            path='/',
        ))</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create a session object in the database.  The session key is the
primary key of the user object (which is actually the user&#8217;s email address).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We then add a cookie to the browser that matches the session on the
server&#8212;&#8203;on our next visit to the site, the server should recognise
us as a logged-in user.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that, as it is, this will only work because we&#8217;re using
<code>LiveServerTestCase</code>, so the <code>User</code> and <code>Session</code> objects we create will end up in
the same database as the test server.  Later we&#8217;ll need to modify it so that it
works against the database on the staging server too.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Django Sessions: How a User&#8217;s Cookies Tell the Server She Is Authenticated</div>
<div class="paragraph">
<p><em>Being an attempt to explain sessions, cookies, and authentication in Django.</em></p>
</div>
<div class="paragraph">
<p>Because
HTTP is stateless, servers need a way of recognising different clients
with <em>every single request</em>. IP addresses can be shared, so the usual
solution is to give each client a unique session ID, which it will store in a
cookie, and submit with every request.  The server will store that ID somewhere
(by default, in the database), and then it can recognise each request that
comes in as being from a particular client.</p>
</div>
<div class="paragraph">
<p>If you log in to the site using the dev server, you can actually take a look at
your session ID by hand if you like.  It&#8217;s stored under the key <code>sessionid</code> by
default. See <a href="#session-cookie-screenshot">Examining the session cookie in the Debug toolbar</a>.</p>
</div>
<div id="session-cookie-screenshot" class="imageblock">
<div class="content">
<img src="images/twp2_2001.png" alt="twp2 2001">
</div>
<div class="title">Figure 31. Examining the session cookie in the Debug toolbar</div>
</div>
<div class="paragraph">
<p>These session cookies are set for all visitors to a Django site, whether
they&#8217;re logged in or not.</p>
</div>
<div class="paragraph">
<p>When we want to recognise a client as being a logged-in and authenticated user,
again, rather than asking the client to send their username and password with every
single request, the server can actually just mark that client&#8217;s session as
being an authenticated session, and associate it with a user ID in its
database.</p>
</div>
<div class="paragraph">
<p>A session is a dictionary-like data structure, and the user ID is stored under
the key given by <code>django.contrib.auth.SESSION_KEY</code>.  You can check this out
in a <span class="keep-together"><code>./manage.py</code></span> <code>shell</code> if you like:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>python manage.py shell</strong>
[...]
In [1]: from django.contrib.sessions.models import Session

# substitute your session id from your browser cookie here
In [2]: session = Session.objects.get(
    session_key="8u0pygdy9blo696g3n4o078ygt6l8y0y"
)

In [3]: print(session.get_decoded())
{'_auth_user_id': '<a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>', '_auth_user_backend':
'accounts.authentication.PasswordlessAuthenticationBackend'}</pre>
</div>
</div>
<div class="paragraph">
<p>You can also store any other information you like on a user&#8217;s session,
as a way of temporarily keeping track of some state. This works for
non–logged-in users too.  Just use <code>request.session</code> inside any
view, and it works as a dict. There&#8217;s more information in the
<a href="http://bit.ly/2tGVbQE">Django docs on
sessions</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_checking_that_it_works">20.1.1. Checking That It Works</h4>
<div class="paragraph">
<p>To check that it works, it would be good to use some of the code from our previous
test.  Let&#8217;s make a couple of functions called <code>wait_to_be_logged_in</code> and
<code>wait_to_be_logged_out</code>. To access them from a different test, we&#8217;ll need
to pull them up into <code>FunctionalTest</code>. We&#8217;ll also tweak them slightly so that
they can take an arbitrary email address as a parameter:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class FunctionalTest(StaticLiveServerTestCase):
    [...]

    def wait_to_be_logged_in(self, email):
        self.wait_for(
            lambda: self.browser.find_element_by_link_text('Log out')
        )
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertIn(email, navbar.text)


    def wait_to_be_logged_out(self, email):
        self.wait_for(
            lambda: self.browser.find_element_by_name('email')
        )
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertNotIn(email, navbar.text)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Hm, that&#8217;s not bad, but I&#8217;m not quite happy with the amount of duplication
of <code>wait_for</code> stuff in here.  Let&#8217;s make a note to come back to it, and
get these helpers working.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em>Clean up wait_for stuff in base.py</em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>First we use them in <em>test_login.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_login.py (ch18l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_can_get_email_link_to_log_in(self):
        [...]
        # she is logged in!
        self.wait_to_be_logged_in(email=TEST_EMAIL)

        # Now she logs out
        self.browser.find_element_by_link_text('Log out').click()

        # She is logged out
        self.wait_to_be_logged_out(email=TEST_EMAIL)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Just to make sure we haven&#8217;t broken anything, we rerun the login test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_login</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now we can write a placeholder for the "My Lists" test, to see if
our pre-authenticated session creator really does work:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch18l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_logged_in_users_lists_are_saved_as_my_lists(self):
        email = 'edith@example.com'
        self.browser.get(self.live_server_url)
        self.wait_to_be_logged_out(email)

        # Edith is a logged-in user
        self.create_pre_authenticated_session(email)
        self.browser.get(self.live_server_url)
        self.wait_to_be_logged_in(email)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s
a good place for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "test_my_lists: precreate sessions, move login checks into base"</strong></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">JSON Test Fixtures Considered Harmful</div>
<div class="paragraph">
<p>When
we pre-populate the database with test data, as we&#8217;ve done here with the
<code>User</code> object and its associated <code>Session</code> object, what we&#8217;re doing is setting
up a "test fixture".</p>
</div>
<div class="paragraph">
<p>Django comes with built-in support for saving database objects as JSON (using
the <code>manage.py dumpdata</code>), and automatically loading them in your test runs
using the <code>fixtures</code> class attribute on <code>TestCase</code>.</p>
</div>
<div class="paragraph">
<p>More and more people are starting to say:
<a href="http://bit.ly/1kSTyrb">don&#8217;t use JSON fixtures</a>.
They&#8217;re a nightmare to maintain when your model changes.  Plus it&#8217;s difficult
for the reader to tell which of the many attribute values specified in the
JSON are critical for the behaviour under test, and which are just filler.
Finally, even if tests start out sharing fixtures, sooner or later one
test will want slightly different versions of the data, and you end up copying
the whole thing around to keep them isolated, and again it&#8217;s hard to tell
what&#8217;s relevant to the test and what is just happenstance.</p>
</div>
<div class="paragraph">
<p>It&#8217;s usually much more straightforward to just load the data directly
using the Django ORM.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Once you have more than a handful of fields on a model, and/or several
    related models, even using the ORM can be cumbersome.  In this case,
    there&#8217;s a tool that lots of people swear by called
    <a href="https://factoryboy.readthedocs.org/"><code>factory_boy</code></a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_our_final_explicit_wait_helper_a_wait_decorator">20.2. Our Final Explicit Wait Helper: A Wait Decorator</h3>
<div class="paragraph">
<p>We&#8217;ve
used decorators a few times in our code so far, but it&#8217;s time to learn
how they actually work by making one of our own.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s imagine how we might want our decorator to work.  It would be
nice to be able to replace all the custom wait/retry/timeout logic in
<code>wait_for_row_&#x200b;in_list_table</code> and the inline <code>self.wait_fors</code> in the
<code>wait_to_be_logged_in/out</code>.   Something like this would look lovely:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @wait
    def wait_for_row_in_list_table(self, row_text):
        table = self.browser.find_element_by_id('id_list_table')
        rows = table.find_elements_by_tag_name('tr')
        self.assertIn(row_text, [row.text for row in rows])


    @wait
    def wait_to_be_logged_in(self, email):
        self.browser.find_element_by_link_text('Log out')
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertIn(email, navbar.text)


    @wait
    def wait_to_be_logged_out(self, email):
        self.browser.find_element_by_name('email')
        navbar = self.browser.find_element_by_css_selector('.navbar')
        self.assertNotIn(email, navbar.text)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Are you ready to dive in?  Although decorators are quite difficult to
wrap your head around (I know it took me a long time before I was
comfortable with them, and I still have to think about them quite
carefully whenever I make one), the nice thing is that we&#8217;ve already
dipped our toes into functional programming in our <code>self.wait_for</code>
helper function.  That&#8217;s a function that takes another function as
an argument, and a decorator is the same.  The difference is that the
decorator doesn&#8217;t actually execute any code itself—it returns a
modified version of the function that it was given.</p>
</div>
<div class="paragraph">
<p>Our decorator wants to return a new function which will keep calling
the function it was given, catching our usual exceptions, until a
timeout occurs.  Here&#8217;s a first cut:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def wait(fn):  <i class="conum" data-value="1"></i><b>(1)</b>
    def modified_fn():  <i class="conum" data-value="3"></i><b>(3)</b>
        start_time = time.time()
        while True:  <i class="conum" data-value="4"></i><b>(4)</b>
            try:
                return fn()  <i class="conum" data-value="5"></i><b>(5)</b>
            except (AssertionError, WebDriverException) as e:  <i class="conum" data-value="4"></i><b>(4)</b>
                if time.time() - start_time &gt; MAX_WAIT:
                    raise e
                time.sleep(0.5)
    return modified_fn  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A decorator is a way of modifying a function; it takes a function
as an <span class="keep-together">argument&#8230;&#8203;</span></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>and returns another function as the modified (or "decorated") version.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here&#8217;s where we create our modified function.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And here&#8217;s our familiar loop, which will keep going, catching the usual
exceptions, until our timeout expires.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And as always, we call our function and return immediately if there are
no <span class="keep-together">exceptions</span>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s <em>almost</em> right, but not quite;  try running it?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
    self.wait_to_be_logged_out(email)
TypeError: modified_fn() takes 0 positional arguments but 2 were given</pre>
</div>
</div>
<div class="paragraph">
<p>Unlike in <code>self.wait_for</code>, the decorator is being applied to functions
that have <span class="keep-together">arguments</span>:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">functional_tests/base.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @wait
    def wait_to_be_logged_in(self, email):
        self.browser.find_element_by_link_text('Log out')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>wait_to_be_logged_in</code> takes <code>self</code> and <code>email</code> as positional arguments.
But when it&#8217;s decorated, it&#8217;s replaced with <code>modified_fn</code>, which takes
no arguments.  How do we magically make it so our <code>modified_fn</code> can handle
the same arguments as whatever <code>fn</code> the decorator gets given has?</p>
</div>
<div class="paragraph">
<p>The answer is a bit of Python magic, <code>*args</code> and <code>**kwargs</code>, more formally
known as
<a href="https://docs.python.org/3/tutorial/controlflow.html#keyword-arguments">"variadic
arguments"</a>, apparently (I only just learned that):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def wait(fn):
    def modified_fn(*args, **kwargs):  <i class="conum" data-value="1"></i><b>(1)</b>
        start_time = time.time()
        while True:
            try:
                return fn(*args, **kwargs)  <i class="conum" data-value="2"></i><b>(2)</b>
            except (AssertionError, WebDriverException) as e:
                if time.time() - start_time &gt; MAX_WAIT:
                    raise e
                time.sleep(0.5)
    return modified_fn</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using <code>*args</code> and <code>**kwargs</code>, we specify that <code>modified_fn</code> may take
any arbitrary positional and keyword arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>As we&#8217;ve captured them in the function definition, we make sure to
pass those same arguments to <code>fn</code> when we actually call it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One of the fun things this can be used for is to make a decorator that changes
the arguments of a function.  But we won&#8217;t get into that now.  The main thing
is that our decorator now works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And do you know what&#8217;s truly satisfying?  We can use our <code>wait</code> decorator
for our <code>self.wait_for</code> helper as well!  Like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @wait
    def wait_for(self, fn):
        return fn()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Lovely!  Now all our wait/retry logic is encapsulated in a single place,
and we have a nice easy way of applying those waits, either inline in our
FTs using <code>self.wait_for</code>, or on any helper function using the <code>@wait</code>
decorator.</p>
</div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><em><span class="strikethrough line-through">Clean up wait_for stuff in base.py</span></em></p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>In the next chapter we&#8217;ll try to deploy our code to staging, and
use the pre-authenticated session fixtures on the server.  As we&#8217;ll see
it&#8217;ll help us catch a little bug or two!</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lessons Learned</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Decorators are nice</dt>
<dd>
<p>Decorators
can be a great way of abstracting out different levels of
concerns.  They let us write our test assertions without having to
think about waits at the same time.</p>
</dd>
<dt class="hdlist1">De-duplicate your FTs, with caution</dt>
<dd>
<p>Every
single FT doesn&#8217;t need to test every single part of your application.
In our case, we wanted to avoid going through the full login process for
every FT that needs an authenticated user, so we used a test fixture to
"cheat" and skip that part. You might find other things you want to skip
in your FTs.  A word of caution, however: functional tests are there to
catch unpredictable interactions between different parts of your
application, so be wary of pushing de-duplication to the extreme.</p>
</dd>
<dt class="hdlist1">Test fixtures</dt>
<dd>
<p>Test
fixtures refers to test data that needs to be set up as a precondition
before a test is run&#8212;&#8203;often this means populating the database with some
information, but as we&#8217;ve seen (with browser cookies), it can involve other
types of preconditions.</p>
</dd>
<dt class="hdlist1">Avoid JSON fixtures</dt>
<dd>
<p>Django
makes it easy to save and restore data from the database in JSON
format (and others) using the <code>dumpdata</code> and <code>loaddata</code> management
commands.  <span class="keep-together">Most people</span> recommend against using these for
test fixtures, as they are painful to manage when your database schema
changes. Use the ORM, or a tool like
<a href='https://factoryboy.readthedocs.org/'><span class="keep-together"><code>factory_boy</code></span></a>.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_server_side_debugging">21. Server-Side Debugging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Popping a few layers off the stack of things we&#8217;re working on: we have nice
wait-for helpers; what were we using them for?  Oh yes, waiting to be logged
in. And why was that?  Ah yes, we had just built a way of pre-authenticating
a user.</p>
</div>
<div class="sect2">
<h3 id="_the_proof_is_in_the_pudding_using_staging_to_catch_final_bugs">21.1. The Proof Is in the Pudding: Using Staging to Catch Final Bugs</h3>
<div class="paragraph">
<p>They&#8217;re
all very well for running the FTs locally, but how would they work
against the staging server?  Let&#8217;s try to deploy our site.  Along the way
we&#8217;ll catch an unexpected bug (that&#8217;s what staging is for!), and then we&#8217;ll
have to figure out a way of managing the database on the test server:</p>
</div>
<div class="listingblock against-server">
<div class="content">
<pre>$ <strong>git push</strong>  # if you haven't already
$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy --host=elspeth@superlists-staging.ottg.eu</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And restart Gunicorn&#8230;&#8203;</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what happens when we run the functional tests:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

======================================================================
ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_my_lists.py", line 34, in
test_logged_in_users_lists_are_saved_as_my_lists
    self.wait_to_be_logged_in(email)
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Log out


======================================================================
FAIL: test_can_get_email_link_to_log_in (functional_tests.test_login.LoginTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_login.py", line 22, in
test_can_get_email_link_to_log_in
    self.wait_for(lambda: self.assertIn(
[...]
AssertionError: 'Check your email' not found in 'Server Error (500)'

 ---------------------------------------------------------------------
Ran 8 tests in 68.602s

FAILED (failures=1, errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>We can&#8217;t log in&#8212;&#8203;either with the real email system or with our
pre-authenticated session.  Looks like our nice new authentication
system is crashing the server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s practice a bit of server-side debugging!</p>
</div>
</div>
<div class="sect2">
<h3 id="_inspecting_logs_on_the_server">21.2. Inspecting Logs on the Server</h3>
<div class="paragraph">
<p>In
order to track this problem down, we need to get some logging information
out of Django.</p>
</div>
<div class="paragraph">
<p>First, make sure your <em>settings.py</em> still contains the <code>LOGGING</code>
settings which will actually send stuff to the console:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['console'],
        },
    },
    'root': {'level': 'INFO'},
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Restart Gunicorn again if necessary, and then either rerun the FT, or just try
to log in manually.  While that happens, we watch the logs on the server with
<code>journalctl -f</code>:</p>
</div>
<div class="listingblock server-commands">
<div class="content">
<pre>elspeth@server:$ <strong>sudo journalctl -f -u gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an error like this:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>Internal Server Error: /accounts/send_login_email
Traceback (most recent call last):
  File "/home/elspeth/sites/superlists-staging.ottg.eu/virtualenv/lib/python3.6/[...]
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File
"/home/elspeth/sites/superlists-staging.ottg.eu/accounts/views.py", line
20, in send_login_email
    [email]
[...]
    self.connection.sendmail(from_email, recipients, message.as_bytes(linesep=<em>\r\n</em>))
  File "/usr/lib/python3.6/smtplib.py", line 862, in sendmail
    raise SMTPSenderRefused(code, resp, from_addr)
smtplib.SMTPSenderRefused: (530, b'5.5.1 Authentication Required. Learn more
at\n5.5.1  https://support.google.com/mail/?p=WantAuthError [...]
- gsmtp', <em>noreply@superlists</em>)</pre>
</div>
</div>
<div class="paragraph">
<p>Hm, Gmail is refusing to send our emails, is it?  Now why might that be?  Ah
yes, we haven&#8217;t told the server what our password is!</p>
</div>
</div>
<div class="sect2">
<h3 id="_another_environment_variable">21.3. Another Environment Variable</h3>
<div class="paragraph">
<p>Just
as in <a href="#chapter_making_deployment_production_ready">Getting to a Production-Ready Deployment</a>, the place we
set environment variables on the server is in the <em>.env</em> file:</p>
</div>
<div class="listingblock server-commands small-code">
<div class="content">
<pre>elspeth@server:$ <strong>cd ~/sites/superlists-staging.ottg.eu/</strong>
elspeth@server:$ <strong>echo EMAIL_PASSWORD=yoursekritpasswordhere &gt;&gt; .env</strong>
elspeth@server:$ <strong>sudo systemctl daemon-reload</strong>
elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists-staging.ottg.eu</strong>
elspeth@server:$ <strong>sudo journalctl -f -u gunicorn-superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we rerun our FTs, we see a change:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

[...]
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_login.py", line 28, in
test_can_get_email_link_to_log_in
    email = mail.outbox[0]
IndexError: list index out of range

[...]

selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Log out</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>my_lists</code> failure is still the same, but we have more information in our
login test: the FT gets further, and the site now looks like it&#8217;s sending
emails correctly (and the server log no longer shows any errors), but we can&#8217;t
check the email in the <code>mail.outbox</code>&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_adapting_our_ft_to_be_able_to_test_real_emails_via_pop3">21.4. Adapting Our FT to Be Able to Test Real Emails via POP3</h3>
<div class="paragraph">
<p>Ah.
That explains it. Now that we&#8217;re running against a real server rather than
the <code>LiveServerTestCase</code>, we can no longer inspect the local
<code>django.mail.outbox</code> to see sent emails.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;ll need to know, in our FTs, whether we&#8217;re running against
the staging server or not.  Let&#8217;s save the <code>staging_server</code> variable
on <code>self</code> in <em>base.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def setUp(self):
        self.browser = webdriver.Firefox()
        self.staging_server = os.environ.get('STAGING_SERVER')
        if self.staging_server:
            self.live_server_url = 'http://' + self.staging_server</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we build a helper function that can retrieve a real email from a real POP3
email server, using the horrifically tortuous Python standard library POP3
client:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_login.py (ch18l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import os
import poplib
import re
import time
[...]

    def wait_for_email(self, test_email, subject):
        if not self.staging_server:
            email = mail.outbox[0]
            self.assertIn(test_email, email.to)
            self.assertEqual(email.subject, subject)
            return email.body

        email_id = None
        start = time.time()
        inbox = poplib.POP3_SSL('pop.mail.yahoo.com')
        try:
            inbox.user(test_email)
            inbox.pass_(os.environ['YAHOO_PASSWORD'])
            while time.time() - start &lt; 60:
                # get 10 newest messages
                count, _ = inbox.stat()
                for i in reversed(range(max(1, count - 10), count + 1)):
                    print('getting msg', i)
                    _, lines, __ = inbox.retr(i)
                    lines = [l.decode('utf8') for l in lines]
                    print(lines)
                    if f'Subject: {subject}' in lines:
                        email_id = i
                        body = '\n'.join(lines)
                        return body
                time.sleep(5)
        finally:
            if email_id:
                inbox.dele(email_id)
            inbox.quit()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m using a Yahoo account for testing, but you can use any email service you
like, as long as it offers POP3 access. You will need to set the
<code>YAHOO_PASSWORD</code> environment variable in the console that&#8217;s running the FT.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>echo YAHOO_PASSWORD=otheremailpasswordhere &gt;&gt; .env</strong>
$ <strong>source .env</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And then we feed through the rest of the changes to the FT that are required
as a result.  Firstly, populating a <code>test_email</code> variable, differently for
local and staging tests:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/test_login.py (ch18l011-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -7,7 +7,7 @@ from selenium.webdriver.common.keys import Keys

 from .base import FunctionalTest

-TEST_EMAIL = 'edith@example.com'
+
 SUBJECT = 'Your login link for Superlists'


@@ -33,7 +33,6 @@ class LoginTest(FunctionalTest):
                     print('getting msg', i)
                     _, lines, __ = inbox.retr(i)
                     lines = [l.decode('utf8') for l in lines]
-                    print(lines)
                     if f'Subject: {subject}' in lines:
                         email_id = i
                         body = '\n'.join(lines)
@@ -49,6 +48,11 @@ class LoginTest(FunctionalTest):
         # Edith goes to the awesome superlists site
         # and notices a "Log in" section in the navbar for the first time
         # It's telling her to enter her email address, so she does
+        if self.staging_server:
+            test_email = 'edith.testuser@yahoo.com'
+        else:
+            test_email = 'edith@example.com'
+
         self.browser.get(self.live_server_url)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then modifications involving using that variable and calling our new helper
function:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/test_login.py (ch18l011-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -54,7 +54,7 @@ class LoginTest(FunctionalTest):
             test_email = 'edith@example.com'

         self.browser.get(self.live_server_url)
-        self.browser.find_element_by_name('email').send_keys(TEST_EMAIL)
+        self.browser.find_element_by_name('email').send_keys(test_email)
         self.browser.find_element_by_name('email').send_keys(Keys.ENTER)

         # A message appears telling her an email has been sent
@@ -64,15 +64,13 @@ class LoginTest(FunctionalTest):
         ))

         # She checks her email and finds a message
-        email = mail.outbox[0]
-        self.assertIn(TEST_EMAIL, email.to)
-        self.assertEqual(email.subject, SUBJECT)
+        body = self.wait_for_email(test_email, SUBJECT)

         # It has a url link in it
-        self.assertIn('Use this link to log in', email.body)
-        url_search = re.search(r'http://.+/.+$', email.body)
+        self.assertIn('Use this link to log in', body)
+        url_search = re.search(r'http://.+/.+$', body)
         if not url_search:
-            self.fail(f'Could not find url in email body:\n{email.body}')
+            self.fail(f'Could not find url in email body:\n{body}')
         url = url_search.group(0)
         self.assertIn(self.live_server_url, url)

@@ -80,11 +78,11 @@ class LoginTest(FunctionalTest):
         self.browser.get(url)

         # she is logged in!
-        self.wait_to_be_logged_in(email=TEST_EMAIL)
+        self.wait_to_be_logged_in(email=test_email)

         # Now she logs out
         self.browser.find_element_by_link_text('Log out').click()

         # She is logged out
-        self.wait_to_be_logged_out(email=TEST_EMAIL)
+        self.wait_to_be_logged_out(email=test_email)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, believe it or not, that&#8217;ll actually work, and give us an FT
that can actually check for logins that work, involving real emails!</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests.test_login</strong>
[...]
OK</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve just hacked this email-checking code together, and it&#8217;s currently
    pretty ugly and brittle (one common problem is picking up the wrong email
    from a previous test run).  With some cleanup and a few more retry loops it
    could grow into something more reliable. Alternatively, services like
    <em>mailinator.com</em> will give you throwaway email addresses and an API to
    check them, for a small fee.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_managing_the_test_database_on_staging">21.5. Managing the Test Database on Staging</h3>
<div class="paragraph">
<p>Now
we can rerun our full FT suite and get to the next failure: our attempt to
create pre-authenticated sessions doesn&#8217;t work, so the "My Lists" test fails:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>

ERROR: test_logged_in_users_lists_are_saved_as_my_lists
(functional_tests.test_my_lists.MyListsTest)
[...]
selenium.common.exceptions.TimeoutException: Message: Could not find element
with id id_logout. Page text was:
Superlists
Sign in
Start a new To-Do list

Ran 8 tests in 72.742s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because our test utility function <code>create_pre_authenticated_session</code> only
acts on the local database. Let&#8217;s find out how our tests can manage the
database on the server.</p>
</div>
<div class="sect3">
<h4 id="_a_django_management_command_to_create_sessions">21.5.1. A Django Management Command to Create Sessions</h4>
<div class="paragraph">
<p>To
do things on the server, we&#8217;ll need to build a self-contained script that
can be run from the command line on the server, most probably via Fabric.</p>
</div>
<div class="paragraph">
<p>When trying to build a standalone script that works with Django (i.e., can talk
to the database and so on), there are some fiddly issues you need to get right,
like setting the <code>DJANGO_SETTINGS_MODULE</code> environment variable, and getting
<code>sys.path</code> correctly.</p>
</div>
<div class="paragraph">
<p>Instead of messing about with all that, Django lets you create your own
"management commands" (commands you can run with <code>python manage.py</code>), which
will do all that path mangling for you. They live in a folder called
<em>management/commands</em> inside your apps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir -p functional_tests/management/commands</strong>
$ <strong>touch functional_tests/management/__init__.py</strong>
$ <strong>touch functional_tests/management/commands/__init__.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>The boilerplate in a management command is a class that inherits from
<code>django.core.management.BaseCommand</code>, and that defines a method called
<code>handle</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/management/commands/create_session.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf import settings
from django.contrib.auth import BACKEND_SESSION_KEY, SESSION_KEY, get_user_model
User = get_user_model()
from django.contrib.sessions.backends.db import SessionStore
from django.core.management.base import BaseCommand


class Command(BaseCommand):

    def add_arguments(self, parser):
        parser.add_argument('email')

    def handle(self, *args, **options):
        session_key = create_pre_authenticated_session(options['email'])
        self.stdout.write(session_key)


def create_pre_authenticated_session(email):
    user = User.objects.create(email=email)
    session = SessionStore()
    session[SESSION_KEY] = user.pk
    session[BACKEND_SESSION_KEY] = settings.AUTHENTICATION_BACKENDS[0]
    session.save()
    return session.session_key</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve taken the code for <code>create_pre_authenticated_session</code> from
<em>test_my_lists.py</em>. <code>handle</code> will pick up an email address from the parser,
and then return the session key that we&#8217;ll want to add to our browser cookies,
and the management command prints it out at the command line. Try it out:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>python manage.py create_session a@b.com</strong>
Unknown command: 'create_session'</pre>
</div>
</div>
<div class="paragraph">
<p>One more step: we need to add <code>functional_tests</code> to our <em>settings.py</em>
for it to recognise it as a real app that might have management commands as
well as tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">+++ b/superlists/settings.py
@@ -42,6 +42,7 @@ INSTALLED_APPS = [
     'lists',
     'accounts',
+    'functional_tests',
 ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py create_session a@b.com</strong>
qnslckvp2aga7tm6xuivyb0ob1akzzwl</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error saying the <code>auth_user</code> table is missing, you may need
    to run <code>manage.py migrate</code>.  In case that doesn&#8217;t work, delete the
    <em>db.sqlite3</em> file and run <code>migrate</code> again, to get a clean slate.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_getting_the_ft_to_run_the_management_command_on_the_server">21.5.2. Getting the FT to Run the Management Command on the Server</h4>
<div class="paragraph">
<p>Next we need to adjust <code>test_my_lists</code> so that it runs the local function
when we&#8217;re on the local server, and make it run the management command
on the staging server if we&#8217;re on that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch18l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf import settings
from .base import FunctionalTest
from .server_tools import create_session_on_server
from .management.commands.create_session import create_pre_authenticated_session

class MyListsTest(FunctionalTest):

    def create_pre_authenticated_session(self, email):
        if self.staging_server:
            session_key = create_session_on_server(self.staging_server, email)
        else:
            session_key = create_pre_authenticated_session(email)
        ## to set a cookie we need to first visit the domain.
        ## 404 pages load the quickest!
        self.browser.get(self.live_server_url + "/404_no_such_url/")
        self.browser.add_cookie(dict(
            name=settings.SESSION_COOKIE_NAME,
            value=session_key,
            path='/',
        ))

    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s also tweak <em>base.py</em>, to gather a bit more information
when we populate <code>self.against_staging</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch18l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from .server_tools import reset_database  <i class="conum" data-value="1"></i><b>(1)</b>
[...]

class FunctionalTest(StaticLiveServerTestCase):

    def setUp(self):
        self.browser = webdriver.Firefox()
        self.staging_server = os.environ.get('STAGING_SERVER')
        if self.staging_server:
            self.live_server_url = 'http://' + self.staging_server
            reset_database(self.staging_server)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This will be our function to reset the server database in between each
test.  We&#8217;ll write that next, using Fabric.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_fabric_directly_from_python">21.5.3. Using Fabric Directly from Python</h4>
<div class="paragraph">
<p>Rather
than using the <code>fab</code> command, Fabric provides an API that lets
you run Fabric server commands directly inline in your Python code.  You
just need to let it know the "host string" you&#8217;re connecting to:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/server_tools.py (ch18l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from fabric.api import run
from fabric.context_managers import settings, shell_env


def _get_manage_dot_py(host):
    return f'~/sites/{host}/virtualenv/bin/python ~/sites/{host}/manage.py'


def reset_database(host):
    manage_dot_py = _get_manage_dot_py(host)
    with settings(host_string=f'elspeth@{host}'):  <i class="conum" data-value="1"></i><b>(1)</b>
        run(f'{manage_dot_py} flush --noinput')  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s the context manager that sets the host string, in the form
<em>user@server-address</em> (I&#8217;ve hardcoded my server username, elspeth, so
adjust as necessary).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then, once we&#8217;re inside the context manager, we can just call
Fabric commands as if we&#8217;re in a fabfile.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For creating the session, we have a slightly more complex procedure,
because we need to extract the <code>SECRET_KEY</code> and other env vars from
the current running server, to be able to generate a session key that&#8217;s
cryptographically valid for the server:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/server_tools.py (ch18l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def _get_server_env_vars(host):
    env_lines = run(f'cat ~/sites/{host}/.env').splitlines()  <i class="conum" data-value="1"></i><b>(1)</b>
    return dict(l.split('=') for l in env_lines if l)


def create_session_on_server(host, email):
    manage_dot_py = _get_manage_dot_py(host)
    with settings(host_string=f'elspeth@{host}'):
        env_vars = _get_server_env_vars(host)
        with shell_env(**env_vars):  <i class="conum" data-value="2"></i><b>(2)</b>
            session_key = run(f'{manage_dot_py} create_session {email}')  <i class="conum" data-value="3"></i><b>(3)</b>
            return session_key.strip()</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We extract and parse the server&#8217;s current environment variables from the
<em>.env</em> file&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In order to use them in another fabric context manager, <code>shell_env</code>,
which sets the environment for the next command&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Which is to run our <code>create_session</code> management command, which calls the
same <code>create_pre_authenticated_session</code> function, but on the server.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_recap_creating_sessions_locally_versus_staging">21.5.4. Recap: Creating Sessions Locally Versus Staging</h4>
<div class="paragraph">
<p>Does
that all make sense?  Perhaps a little ascii-art diagram will help:</p>
</div>
<div class="sect4">
<h5 id="_locally">Locally:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+       +-------------------------------------+
| MyListsTest                       |  --&gt;  | .management.commands.create_session |
| .create_pre_authenticated_session |       |  .create_pre_authenticated_session  |
|            (locally)              |       |             (locally)               |
+-----------------------------------+       +-------------------------------------+</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_against_staging">Against staging:</h5>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+-----------------------------------+       +-------------------------------------+
| MyListsTest                       |       | .management.commands.create_session |
| .create_pre_authenticated_session |       |  .create_pre_authenticated_session  |
|            (locally)              |       |            (on server)              |
+-----------------------------------+       +-------------------------------------+
            |                                                   ^
            v                                                   |
+----------------------------+     +--------+      +------------------------------+
| server_tools               | --&gt; | fabric | --&gt;  | ./manage.py create_session   |
| .create_session_on_server  |     |  "run" |      |   (on server, using .env)    |
|        (locally)           |     +--------+      +------------------------------+
+----------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>In any case, let&#8217;s see if it works.  First, locally, to check that we didn&#8217;t
break anything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
[...]
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Next, against the server.  We push our code up first:</p>
</div>
<div class="listingblock against-server">
<div class="content">
<pre>$ <strong>git push</strong>  # you'll need to commit changes first.
$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy --host=elspeth@superlists-staging.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And now we run the test:</p>
</div>
<div class="listingblock against-server small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test \
 functional_tests.test_my_lists</strong>
[...]
[elspeth@superlists-staging.ottg.eu] run:
~/sites/superlists-staging.ottg.eu/virtualenv/bin/python
~/sites/superlists-staging.ottg.eu/manage.py flush --noinput
[...]
[elspeth@superlists-staging.ottg.eu] run:
~/sites/superlists-staging.ottg.eu/virtualenv/bin/python
~/sites/superlists-staging.ottg.eu/manage.py create_session edith@example.com
[...]
.
 ---------------------------------------------------------------------
Ran 1 test in 5.701s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Looking good!  We can rerun all the tests to make sure&#8230;&#8203;</p>
</div>
<div class="listingblock against-server small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
[elspeth@superlists-staging.ottg.eu] run:
~/sites/superlists-staging.ottg.eu/virtualenv/bin/python
[...]
Ran 8 tests in 89.494s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Hooray!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;ve shown one way of managing the test database, but you could
    experiment with others&#8212;&#8203;for example, if you were using MySQL or Postgres,
    you could open up an SSH tunnel to the server, and use port forwarding to
    talk to the database directly.  You could then amend <code>settings.DATABASES</code>
    during FTs to talk to the tunnelled port.  You&#8217;d still need some way of
    pulling in the staging server environment variables though.
</td>
</tr>
</table>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Warning: Be Careful Not to Run Test Code Against the Live Server</div>
<div class="paragraph">
<p>We&#8217;re
into dangerous territory, now that we have code that can directly
affect a database on the server.  You want to be very, very careful that you
don&#8217;t accidentally blow away your production database by running FTs against
the wrong host.</p>
</div>
<div class="paragraph">
<p>You might consider putting some safeguards in place at this point. For example,
you could put staging and production on different servers, and make it so they
use different keypairs for authentication, with different passphrases.</p>
</div>
<div class="paragraph">
<p>This is similarly dangerous territory to running tests against clones of
production data. I have a little story about accidentally sending
thousands of duplicate invoices to clients in <a href="#data-migrations-appendix">Testing Database Migrations</a>.
LFMF.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_our_deploy_script">21.6. Updating our Deploy Script</h3>
<div class="paragraph">
<p>Before
we finish, let&#8217;s update our deployment fabfile so that it can
automatically add the <code>EMAIL_PASSWORD</code> to the <em>.env</em> file on the server:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/fabfile.py (ch18l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import os
[...]


def _create_or_update_dotenv():
    append('.env', 'DJANGO_DEBUG_FALSE=y')
    append('.env', f'SITENAME={env.host}')
    current_contents = run('cat .env')
    if 'DJANGO_SECRET_KEY' not in current_contents:
        new_secret = ''.join(random.SystemRandom().choices(
            'abcdefghijklmnopqrstuvwxyz0123456789', k=50
        ))
        append('.env', f'DJANGO_SECRET_KEY={new_secret}')
    email_password = os.environ['EMAIL_PASSWORD']  <i class="conum" data-value="1"></i><b>(1)</b>
    append('.env', f'EMAIL_PASSWORD={email_password}')  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We just add two lines at the end of the script which will essentially
copy the local <code>EMAIL_PASSWORD</code> environment variable up to the server&#8217;s
<em>.env</em> file.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">21.7. Wrap-Up</h3>
<div class="paragraph">
<p>Actually getting your new code up and running on a server always tends to
flush out some last-minute bugs and unexpected issues.  We had to do a bit
of work to get through them, but we&#8217;ve ended up with several useful things
as a result.</p>
</div>
<div class="paragraph">
<p>We now have a lovely generic <code>wait</code> decorator which will be a nice Pythonic
helper for our FTs from now on.  We have test fixtures that work both
locally and on the server, including the ability to test "real" email
integration. And we&#8217;ve got some more robust logging configuration.</p>
</div>
<div class="paragraph">
<p>But before we can deploy our actual live site, we&#8217;d better actually give the
users what they wanted&#8212;&#8203;the next chapter describes how to give them
the ability to save their lists on a "My Lists" page.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Lessons Learned Catching Bugs in Staging</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fixtures also have to work remotely</dt>
<dd>
<p><code>LiveServerTestCase</code>
makes
it easy to interact with the test database
using the Django ORM for tests running locally.  Interacting with the
database on the staging server is not so straightforward. One solution
is Fabric and Django management commands, as I&#8217;ve shown, but you should
explore what works for you&#8212;&#8203;SSH tunnels, for example.</p>
</dd>
<dt class="hdlist1">Be very careful when resetting data on your servers</dt>
<dd>
<p>A
command that can remotely wipe the entire database on one of your
servers is a dangerous weapon, and you want to be really, really sure
it&#8217;s never accidentally going to hit your production data.</p>
</dd>
<dt class="hdlist1">Logging is critical to debugging issues on the server</dt>
<dd>
<p>At
the very least, you&#8217;ll want to be able to see any error messages
that are being generated by the server.  For thornier bugs, you&#8217;ll also
want to be able to do the occasional "debug print", and see it end up
in a file somewhere.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_outside_in">22. Finishing "My Lists": Outside-In TDD</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In
this chapter I&#8217;d like to talk about a technique called Outside-In TDD.
It&#8217;s pretty much what we&#8217;ve been doing all along. Our "double-loop" TDD
process, in which we write the functional test first and then the unit tests,
is already a manifestation of outside-in&#8212;&#8203;we design the system from the
outside, and build up our code in layers. Now I&#8217;ll make it explicit, and talk
about some of the common issues involved.</p>
</div>
<div class="sect2">
<h3 id="_the_alternative_inside_out">22.1. The Alternative: "Inside-Out"</h3>
<div class="paragraph">
<p>The alternative to "outside-in" is to work "inside-out", which is the way most
people intuitively work before they encounter TDD. After
coming up with a design, the natural inclination is sometimes to implement it
starting with the innermost, lowest-level components first.</p>
</div>
<div class="paragraph">
<p>For example, when faced with our current problem, providing users with a
"My Lists" page of saved lists, the temptation is to start by adding an "owner"
attribute to the <code>List</code> model object, reasoning that an attribute like this is
"obviously" going to be required. Once that&#8217;s in place, we would modify the
more peripheral layers of code, such as views and templates, taking advantage
of the new attribute, and then finally add URL routing to point to the new
view.</p>
</div>
<div class="paragraph">
<p>It feels comfortable because it means you&#8217;re never working on a bit of code
that is dependent on something that hasn&#8217;t yet been implemented. Each bit of
work on the inside is a solid foundation on which to build the next layer out.</p>
</div>
<div class="paragraph">
<p>But working inside-out like this also has some weaknesses.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_prefer_outside_in">22.2. Why Prefer "Outside-In"?</h3>
<div class="paragraph">
<p>The
most obvious problem with inside-out is that it requires us to stray from a
TDD workflow. Our functional test&#8217;s first failure might be due to missing URL
routing, but we decide to ignore that and go off adding attributes to our
database model objects instead.</p>
</div>
<div class="paragraph">
<p>We might have ideas in our head about the new desired behaviour of our inner
layers like database models, and often these ideas will be pretty good, but
they are actually just speculation about what&#8217;s really required, because
we haven&#8217;t yet built the outer layers that will use them.</p>
</div>
<div class="paragraph">
<p>One problem that can result is to build inner components that are more
general or more capable than we actually need, which is a waste of time,
and an added source of complexity for your project. Another common problem
is that you create inner components with an API which is convenient for their
own internal design, but which later turns out to be inappropriate for the
calls your outer layers would like to make&#8230;&#8203;worse still, you might end up
with inner components which, you later realise, don&#8217;t actually solve the
problem that your outer layers need solved.</p>
</div>
<div class="paragraph">
<p>In contrast, working outside-in allows you to use each layer to imagine the
most convenient API you could want from the layer beneath it. Let&#8217;s see it in
action.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_ft_for_my_lists">22.3. The FT for "My Lists"</h3>
<div class="paragraph">
<p>As
we work through the following functional test, we start with the most
outward-facing (presentation layer), through to the view functions (or
"controllers"), and lastly the innermost layers, which in this case will be
model code.</p>
</div>
<div class="paragraph">
<p>We know our <code>create_pre_authenticated_session</code> code works now, so we can just
write our FT to look for a "My Lists" page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch19l001-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_logged_in_users_lists_are_saved_as_my_lists(self):
        # Edith is a logged-in user
        self.create_pre_authenticated_session('edith@example.com')

        # She goes to the home page and starts a list
        self.browser.get(self.live_server_url)
        self.add_list_item('Reticulate splines')
        self.add_list_item('Immanentize eschaton')
        first_list_url = self.browser.current_url

        # She notices a "My lists" link, for the first time.
        self.browser.find_element_by_link_text('My lists').click()

        # She sees that her list is in there, named according to its
        # first list item
        self.wait_for(
            lambda: self.browser.find_element_by_link_text('Reticulate splines')
        )
        self.browser.find_element_by_link_text('Reticulate splines').click()
        self.wait_for(
            lambda: self.assertEqual(self.browser.current_url, first_list_url)
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We create a list with a couple of items, and then we check that this list
appears on a new "My Lists" page, and that it&#8217;s "named" after the first item
in the list.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s validate that it really works by creating a second list, and seeing that
appear on the My Lists page as well.  The FT continues, and while we&#8217;re at it,
we check that only logged-in users can see the "My Lists" page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_my_lists.py (ch19l001-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        [...]
        self.wait_for(
            lambda: self.assertEqual(self.browser.current_url, first_list_url)
        )

        # She decides to start another list, just to see
        self.browser.get(self.live_server_url)
        self.add_list_item('Click cows')
        second_list_url = self.browser.current_url

        # Under "my lists", her new list appears
        self.browser.find_element_by_link_text('My lists').click()
        self.wait_for(
            lambda: self.browser.find_element_by_link_text('Click cows')
        )
        self.browser.find_element_by_link_text('Click cows').click()
        self.wait_for(
            lambda: self.assertEqual(self.browser.current_url, second_list_url)
        )

        # She logs out.  The "My lists" option disappears
        self.browser.find_element_by_link_text('Log out').click()
        self.wait_for(lambda: self.assertEqual(
            self.browser.find_elements_by_link_text('My lists'),
            []
        ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Our FT uses a new helper method, <code>add_list_item</code>, which abstracts away entering
text into the right input box.  We define it in <em>base.py</em>:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/base.py (ch19l001-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium.webdriver.common.keys import Keys
[...]

    def add_list_item(self, item_text):
        num_rows = len(self.browser.find_elements_by_css_selector('#id_list_table tr'))
        self.get_item_input_box().send_keys(item_text)
        self.get_item_input_box().send_keys(Keys.ENTER)
        item_number = num_rows + 1
        self.wait_for_row_in_list_table(f'{item_number}: {item_text}')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it we can use it in a few of the other FTs, like this:</p>
</div>
<div class="exampleblock sourcecode currentcontents dofirst-ch19l001-4">
<div class="title">functional_tests/test_list_item_validation.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    self.add_list_item('Buy wellies')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I think it makes the FTs a lot more readable. I made a total of six
changes&#8212;&#8203;see if you agree with me.</p>
</div>
<div class="paragraph">
<p>A quick run of all FTs, a commit, and then back to the FT we&#8217;re working on.
The first error should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_my_lists</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: My lists</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_outside_layer_presentation_and_templates">22.4. The Outside Layer: Presentation and Templates</h3>
<div class="paragraph">
<p>The
test is currently failing saying that it can&#8217;t find a link saying "My
Lists". We can address that at the presentation layer, in <em>base.html</em>, in
our navigation bar. Here&#8217;s the minimal code change:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html (ch19l002-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  {% if user.email %}
    &lt;ul class="nav navbar-nav navbar-left"&gt;
      &lt;li&gt;&lt;a href="#"&gt;My lists&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
    &lt;ul class="nav navbar-nav navbar-right"&gt;
      &lt;li class="navbar-text"&gt;Logged in as {{ user.email }}&lt;/li&gt;
      &lt;li&gt;&lt;a href="{% url 'logout' %}"&gt;Log out&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Of course, that link doesn&#8217;t actually go anywhere, but it does get us along to
the next failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_my_lists</strong>
[...]
    lambda: self.browser.find_element_by_link_text('Reticulate splines')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Reticulate splines</pre>
</div>
</div>
<div class="paragraph">
<p>Which is telling us we&#8217;re going to have to build a page that lists all of a
user&#8217;s lists by title.  Let&#8217;s start with the basics&#8212;&#8203;a URL and a placeholder
template for it.</p>
</div>
<div class="paragraph">
<p>Again, we can go outside-in, starting at the presentation layer with just the
URL and nothing else:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch19l002-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;ul class="nav navbar-nav navbar-left"&gt;
      &lt;li&gt;&lt;a href="{% url 'my_lists' user.email %}"&gt;My lists&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_down_one_layer_to_view_functions_the_controller">22.5. Moving Down One Layer to View Functions (the Controller)</h3>
<div class="paragraph">
<p>That
will cause a template error, so we&#8217;ll start to move down from the
presentation layer and URLs down to the controller layer, Django&#8217;s view
functions.</p>
</div>
<div class="paragraph">
<p>As always, we start with a test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class MyListsTest(TestCase):

    def test_my_lists_url_renders_my_lists_template(self):
        response = self.client.get('/lists/users/a@b.com/')
        self.assertTemplateUsed(response, 'my_lists.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: No templates used to render the response</pre>
</div>
</div>
<div class="paragraph">
<p>And we fix it, still at the presentation level, in <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">urlpatterns = [
    url(r'^new$', views.new_list, name='new_list'),
    url(r'^(\d+)/$', views.view_list, name='view_list'),
    url(r'^users/(.+)/$', views.my_lists, name='my_lists'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us a test failure, which informs us of what we should do as we
move down to the next level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: module 'lists.views' has no attribute 'my_lists'</pre>
</div>
</div>
<div class="paragraph">
<p>We move in from the presentation layer to the views layer, and create a
minimal placeholder:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch19l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def my_lists(request, email):
    return render(request, 'my_lists.html')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a minimal template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/my_lists.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% extends 'base.html' %}

{% block header_text %}My Lists{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets our unit tests passing, but our FT is still at the same point,
saying that the "My Lists" page doesn&#8217;t yet show any lists.  It wants
them to be clickable links named after the first item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python3 manage.py test functional_tests.test_my_lists</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Reticulate splines</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_another_pass_outside_in">22.6. Another Pass, Outside-In</h3>
<div class="paragraph">
<p>At
each stage, we still let the FT drive what development we do.</p>
</div>
<div class="paragraph">
<p>Starting again at the outside layer, in the template, we begin to
write the template code we&#8217;d like to use to get the "My Lists" page to
work the  way we want it to. As we do so, we start to specify the API
we want from the code at the layers below.</p>
</div>
<div class="sect3">
<h4 id="_a_quick_restructure_of_the_template_inheritance_hierarchy">22.6.1. A Quick Restructure of the Template Inheritance Hierarchy</h4>
<div class="paragraph">
<p>Currently
there&#8217;s no place in our base template for us to put any new
content.  Also, the "My Lists" page doesn&#8217;t need the new item form, so
we&#8217;ll put that into a block too, making it optional:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch19l007-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">      &lt;div class="row"&gt;
        &lt;div class="col-md-6 col-md-offset-3 jumbotron"&gt;
          &lt;div class="text-center"&gt;
            &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
            {% block list_form %}
              &lt;form method="POST" action="{% block form_action %}{% endblock %}"&gt;
                {{ form.text }}
                {% csrf_token %}
                {% if form.errors %}
                  &lt;div class="form-group has-error"&gt;
                    &lt;div class="help-block"&gt;{{ form.text.errors }}&lt;/div&gt;
                  &lt;/div&gt;
                {% endif %}
              &lt;/form&gt;
            {% endblock %}
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html (ch19l007-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">      &lt;div class="row"&gt;
        &lt;div class="col-md-6 col-md-offset-3"&gt;
          {% block table %}
          {% endblock %}
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class="row"&gt;
        &lt;div class="col-md-6 col-md-offset-3"&gt;
          {% block extra_content %}
          {% endblock %}
        &lt;/div&gt;
      &lt;/div&gt;

    &lt;/div&gt;
    &lt;script src="/static/jquery-3.1.1.min.js"&gt;&lt;/script&gt;
    [...]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_designing_our_api_using_the_template">22.6.2. Designing Our API Using the Template</h4>
<div class="paragraph">
<p>Meanwhile, in <em>my_lists.html</em> we override the <code>list_form</code> and say it should
be empty&#8230;&#8203;</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/my_lists.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% extends 'base.html' %}

{% block header_text %}My Lists{% endblock %}

{% block list_form %}{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then we can just work inside the <code>extra_content</code> block:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/my_lists.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">[...]

{% block list_form %}{% endblock %}

{% block extra_content %}
    &lt;h2&gt;{{ owner.email }}'s lists&lt;/h2&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;ul&gt;
        {% for list in owner.list_set.all %}  <i class="conum" data-value="2"></i><b>(2)</b>
            &lt;li&gt;&lt;a href="{{ list.get_absolute_url }}"&gt;{{ list.name }}&lt;/a&gt;&lt;/li&gt;  <i class="conum" data-value="3"></i><b>(3)</b>
        {% endfor %}
    &lt;/ul&gt;
{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve made several design decisions in this template which are going
to filter their way down through the code:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We want a variable called <code>owner</code> to represent the user in our template.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want to be able to iterate through the lists created by the user using
<code>owner.list_set.all</code> (I happen to know we get this for free from the Django
ORM).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We want to use <code>list.name</code> to print out the "name" of the list, which is
currently specified as the text of its first element.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Outside-In TDD is sometimes called "programming by wishful thinking",
    and you can see why.  We start writing code at the higher levels based on
    what we wish we had at the lower levels, even though it doesn&#8217;t exist yet!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can rerun our FTs, to check that we didn&#8217;t break anything, and to see whether
we&#8217;ve got any further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Reticulate splines

 ---------------------------------------------------------------------
Ran 8 tests in 77.613s

FAILED (errors=1)</pre>
</div>
</div>
<div class="paragraph">
<p>Well, no further, but at least we didn&#8217;t break anything. Time for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit -m "url, placeholder view, and first-cut templates for my_lists"</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_moving_down_to_the_next_layer_what_the_view_passes_to_the_template">22.6.3. Moving Down to the Next Layer: What the View Passes to the Template</h4>
<div class="paragraph">
<p>Now
our views layer needs to respond to the requirements we&#8217;ve laid out in the template layer, by giving it the objects it needs.  In this case, the list owner:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib.auth import get_user_model
User = get_user_model()
[...]
class MyListsTest(TestCase):

    def test_my_lists_url_renders_my_lists_template(self):
        [...]

    def test_passes_correct_owner_to_template(self):
        User.objects.create(email='wrong@owner.com')
        correct_user = User.objects.create(email='a@b.com')
        response = self.client.get('/lists/users/a@b.com/')
        self.assertEqual(response.context['owner'], correct_user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>KeyError: 'owner'</pre>
</div>
</div>
<div class="paragraph">
<p>So:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch19l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib.auth import get_user_model
User = get_user_model()
[...]

def my_lists(request, email):
    owner = User.objects.get(email=email)
    return render(request, 'my_lists.html', {'owner': owner})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets our new test passing, but we&#8217;ll also see an error from
the previous test. We just need to add a user for it as well:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_my_lists_url_renders_my_lists_template(self):
        User.objects.create(email='a@b.com')
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And
we get to an OK:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_next_requirement_from_the_views_layer_new_lists_should_record_owner">22.7. The Next "Requirement" from the Views Layer: New Lists Should Record Owner</h3>
<div class="paragraph">
<p>Before
we move down to the model layer, there&#8217;s another part of the code
at the views layer that will need to use our model:  we need some way for
newly created lists to be assigned to an owner, if the current user is
logged in to the site.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a first crack at writing the test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch19l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):
    [...]

    def test_list_owner_is_saved_if_user_is_authenticated(self):
        user = User.objects.create(email='a@b.com')
        self.client.force_login(user)  <i class="conum" data-value="1"></i><b>(1)</b>
        self.client.post('/lists/new', data={'text': 'new item'})
        list_ = List.objects.first()
        self.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>force_login()</code> is the way you get the test client to make requests
with a logged-in user.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The test fails as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: 'List' object has no attribute 'owner'</pre>
</div>
</div>
<div class="paragraph">
<p>To fix this, we can try writing code like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch19l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)
    if form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But it won&#8217;t actually work, because we don&#8217;t know how to save a list owner yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(list_.owner, user)
AttributeError: 'List' object has no attribute 'owner'</pre>
</div>
</div>
<div class="sect3">
<h4 id="_a_decision_point_whether_to_proceed_to_the_next_layer_with_a_failing_test">22.7.1. A Decision Point: Whether to Proceed to the Next Layer with a Failing Test</h4>
<div class="paragraph">
<p>In
order to get this test passing, as it&#8217;s written now, we have to move
down to the model layer.  However, it means doing more work with a failing
test, which is not ideal.</p>
</div>
<div class="paragraph">
<p>The
alternative is to rewrite the test to make it more <em>isolated</em> from the
level below, using mocks.</p>
</div>
<div class="paragraph">
<p>On the one hand, it&#8217;s a lot more effort to use mocks, and it can lead to
tests that are harder to read.  On the other hand, imagine if our app was more
complex, and there were several more layers between the outside and the inside.
Imagine leaving three or four or five layers of tests, all failing while we
wait to get to the bottom layer to implement our critical feature.  While tests
are failing, we&#8217;re not sure that layer really works, on its own terms, or not.
We have to wait until we get to the bottom layer.</p>
</div>
<div class="paragraph">
<p>This is a decision point you&#8217;re likely to run into in your own projects. Let&#8217;s
investigate both approaches.  We&#8217;ll start by taking the shortcut, and leaving
the test failing.  In the next chapter, we&#8217;ll come back to this exact point,
and investigate how things would have gone if we&#8217;d used more isolation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do a commit, and then <em>tag</em> the commit as a way of remembering our
position for the next chapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git commit -am "new_list view tries to assign owner but cant"</strong>
$ <strong>git tag revisit_this_point_with_isolated_tests</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_down_to_the_model_layer">22.8. Moving Down to the Model Layer</h3>
<div class="paragraph">
<p>Our outside-in design has driven out two requirements for the model layer:
we want to be able to assign an owner to a list using the attribute
<code>.owner</code>, and we want to be able to access the list&#8217;s owner with
the API <code>owner.list_set.all</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s write a test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib.auth import get_user_model
User = get_user_model()
[...]

class ListModelTest(TestCase):

    def test_get_absolute_url(self):
        [...]

    def test_lists_can_have_owners(self):
        user = User.objects.create(email='a@b.com')
        list_ = List.objects.create(owner=user)
        self.assertIn(list_, user.list_set.all())</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gives us a new unit test failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    list_ = List.objects.create(owner=user)
    [...]
TypeError: 'owner' is an invalid keyword argument for this function</pre>
</div>
</div>
<div class="paragraph">
<p>The naive implementation would be this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf import settings
[...]

class List(models.Model):
    owner = models.ForeignKey(settings.AUTH_USER_MODEL)</code></pre>
</div>
</div>
<div class="paragraph">
<p>But we want to make sure the list owner is optional.  Explicit
is better than implicit, and tests are documentation, so let&#8217;s have a test for
that too:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l020)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_list_owner_is_optional(self):
        List.objects.create()  # should not raise</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The correct implementation is this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf import settings
[...]

class List(models.Model):
    owner = models.ForeignKey(settings.AUTH_USER_MODEL, blank=True, null=True)

    def get_absolute_url(self):
        return reverse('view_list', args=[self.id])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now running the tests gives the usual database error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    return Database.Cursor.execute(self, query, params)
django.db.utils.OperationalError: no such column: lists_list.owner_id</pre>
</div>
</div>
<div class="paragraph">
<p>Because we need to make some migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  lists/migrations/0006_list_owner.py
    - Add field owner to list</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re almost there; a couple more failures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_redirects_after_POST (lists.tests.test_views.NewListTest)
[...]
ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7f364795ef90&gt;&gt;":
"List.owner" must be a "User" instance.
ERROR: test_can_save_a_POST_request (lists.tests.test_views.NewListTest)

[...]
ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7f364795ef90&gt;&gt;":
"List.owner" must be a "User" instance.</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;re moving back up to the views layer now, just doing a little
tidying up. Notice that these are in the old test for the <code>new_list</code> view, when
we haven&#8217;t got a logged-in user.  We should only save the list owner when the
user is actually logged in.  The <code>.is_authenticated</code> attribute we defined in
<a href="#chapter_mocking">Using Mocks to Test External Dependencies or Reduce Duplication</a> comes in useful now (when they&#8217;re not logged in,
Django represents users using a class called <code>AnonymousUser</code>, whose
<code>.is_authenticated</code> is always <code>False</code>):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch19l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    if form.is_valid():
        list_ = List()
        if request.user.is_authenticated:
            list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gets us passing!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
.......................................
 ---------------------------------------------------------------------
Ran 39 tests in 0.237s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>This is a good time for a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add lists</strong>
$ <strong>git commit -m "lists can have owners, which are saved on creation."</strong></pre>
</div>
</div>
<div class="sect3">
<h4 id="_final_step_feeding_through_the_name_api_from_the_template">22.8.1. Final Step: Feeding Through the .name API from the Template</h4>
<div class="paragraph">
<p>The last thing our outside-in design wanted came from the templates,
which wanted to be able to access a list "name" based on the text of
its first item:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch19l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_list_name_is_first_item_text(self):
        list_ = List.objects.create()
        Item.objects.create(list=list_, text='first item')
        Item.objects.create(list=list_, text='second item')
        self.assertEqual(list_.name, 'first item')</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch19l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @property
    def name(self):
        return self.item_set.first().text</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that, believe it or not, actually gets us a passing test,
and a working "My Lists" page (<a href="#my-lists-page">The "My Lists" page, in all its glory (and proof I did test on Windows)</a>)!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
Ran 8 tests in 93.819s

OK</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The @property Decorator in Python</div>
<div class="paragraph">
<p>If
you haven&#8217;t seen it before, the <code>@property</code> decorator transforms a method
on a class to make it appear to the outside world like an attribute.</p>
</div>
<div class="paragraph">
<p>This
is a powerful feature of the language, because it makes it easy to
implement "duck typing", to change the implementation of a property without
changing the interface of the class.  In other words, if we decide to change
<code>.name</code> into being a "real" attribute on the model, which is stored as text in
the database, then we will be able to do so entirely transparently&#8212;&#8203;as far as
the rest of our code is concerned, they will still be able to just access
<code>.name</code> and get the list name, without needing to know about the
implementation. Raymond Hettinger gave a
<a href="https://www.youtube.com/watch?v=HTLu2DFOdTg">great, beginner-friendly talk on
this topic at Pycon a few years ago</a>, which I enthusiastically recommend (it
covers about a million good practices for Pythonic class design besides).</p>
</div>
<div class="paragraph">
<p>Of course, in the Django template language, <code>.name</code> would still call the method
even if it didn&#8217;t have <code>@property</code>, but that&#8217;s a particularity of Django, and
doesn&#8217;t apply to Python in general&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="paragraph">
<p>But
we know we cheated to get there.  The Testing Goat is eyeing us
suspiciously.  We left a test failing at one layer while we implemented its
dependencies at the lower layer. Let&#8217;s see how things would play out if we were
to use better test isolation&#8230;&#8203;</p>
</div>
<div id="my-lists-page" class="imageblock">
<div class="content">
<img src="images/twp2_2201.png" alt="Screenshot of new My Lists page">
</div>
<div class="title">Figure 32. The "My Lists" page, in all its glory (and proof I did test on Windows)</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Outside-In TDD</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Outside-In TDD</dt>
<dd>
<p>    A
methodology for building code, driven by tests, which proceeds by
    starting from the "outside" layers (presentation, GUI), and moving
    "inwards" step by step, via view/controller layers, down towards
    the model layer.  The idea is to drive the design of your code from
    the use to which it is going to be put, rather than trying to anticipate
    requirements from the ground up.</p>
</dd>
<dt class="hdlist1">Programming by wishful thinking</dt>
<dd>
<p>    The
outside-in process is sometimes called "programming by wishful
    thinking".  Actually, any kind of TDD involves some wishful thinking.
    We&#8217;re always writing tests for things that don&#8217;t exist yet.</p>
</dd>
<dt class="hdlist1">The pitfalls of outside-in</dt>
<dd>
<p>Outside-in isn&#8217;t a silver bullet.  It encourages us to focus on things
that are immediately visible to the user, but it won&#8217;t automatically
remind us to write other critical tests that are less user-visible&#8212;&#8203;things like security, for example. You&#8217;ll need to remember them yourself.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_purist_unit_tests">23. Test Isolation, and "Listening to Your Tests"</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In
the preceding chapter, we made the decision to leave a unit test failing in
the views layer while we proceeded to write more tests and more code at
the models layer to get it to pass.</p>
</div>
<div class="paragraph">
<p>We got away with it because our app was simple, but I should stress that,
in a more complex application, this would be a dangerous decision. Proceeding
to work on lower levels while you&#8217;re not sure that the higher levels are
<em>really</em> finished or not is a risky strategy.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
I&#8217;m grateful to Gary Bernhardt, who took a look at an early draft of the
    previous chapter, and encouraged me to get into a longer discussion of test
    isolation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensuring
isolation between layers does involve more effort (and more of the
dreaded mocks!), but it can also help to drive out improved design, as we&#8217;ll
see in this chapter.</p>
</div>
<div class="sect2">
<h3 id="_revisiting_our_decision_point_the_views_layer_depends_on_unwritten_models_code">23.1. Revisiting Our Decision Point: The Views Layer Depends on Unwritten Models Code</h3>
<div class="paragraph">
<p>Let&#8217;s
revisit the point we were at halfway through the last chapter, when we
couldn&#8217;t get the <code>new_list</code> view to work because lists didn&#8217;t have the <code>.owner</code>
attribute yet.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll actually go back in time and check out the old codebase using the tag we
saved earlier, so that we can see how things would have worked if we&#8217;d used
more isolated tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git checkout -b more-isolation</strong>  # a branch for this experiment
$ <strong>git reset --hard revisit_this_point_with_isolated_tests</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what our failing test looks like:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListTest(TestCase):
    [...]

    def test_list_owner_is_saved_if_user_is_authenticated(self):
        user = User.objects.create(email='a@b.com')
        self.client.force_login(user)
        self.client.post('/lists/new', data={'text': 'new item'})
        list_ = List.objects.first()
        self.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s what our attempted solution looked like:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)
    if form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And at this point, the view test is failing because we don&#8217;t have the model
layer yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertEqual(list_.owner, user)
AttributeError: 'List' object has no attribute 'owner'</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You won&#8217;t see this error unless you actually check out the old code
    and revert <em>lists/models.py</em>.  You should definitely do this; part of
    the objective of this chapter is to see whether we really can write
    tests for a models layer that doesn&#8217;t exist yet.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_a_first_attempt_at_using_mocks_for_isolation">23.2. A First Attempt at Using Mocks for Isolation</h3>
<div class="paragraph">
<p>Lists
don&#8217;t have owners yet, but we can let the views layer tests pretend they
do by using a bit of mocking:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest.mock import patch
[...]

    @patch('lists.views.List')  <i class="conum" data-value="1"></i><b>(1)</b>
    @patch('lists.views.ItemForm')  <i class="conum" data-value="2"></i><b>(2)</b>
    def test_list_owner_is_saved_if_user_is_authenticated(
        self, mockItemFormClass, mockListClass  <i class="conum" data-value="3"></i><b>(3)</b>
    ):
        user = User.objects.create(email='a@b.com')
        self.client.force_login(user)

        self.client.post('/lists/new', data={'text': 'new item'})

        mock_list = mockListClass.return_value  <i class="conum" data-value="4"></i><b>(4)</b>
        self.assertEqual(mock_list.owner, user)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock out the <code>List</code> class to be able to get access to any lists
that might be created by the view.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We also mock out the <code>ItemForm</code>. Otherwise, our form will
raise an error when we call <code>form.save()</code>, because it can&#8217;t use a
mock object as the foreign key for the <code>Item</code> it wants to create.
Once you start mocking, it can be hard to stop!</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The mock objects are injected into the test&#8217;s arguments in the
opposite order to which they&#8217;re declared. Tests with lots of mocks
often have this strange signature, with the dangling <code>):</code>.  You get
used to it!</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The list instance that the view will have access to
will be the return value of the mocked <code>List</code> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And we can make assertions about whether the <code>.owner</code> attribute is set on
it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we try to run this test now, it should pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 37 tests in 0.145s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t see a pass, make sure that your views code in <em>views.py</em> is
exactly as I&#8217;ve shown it, using <code>List()</code>, not <code>List.objects.create</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using mocks does tie you to specific ways of using an API.  This is one
    of the many trade-offs involved in the use of mock objects.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_using_mock_side_effects_to_check_the_sequence_of_events">23.2.1. Using Mock side_effects to Check the Sequence of Events</h4>
<div class="paragraph">
<p>The trouble with this test is that it can still let us get away with writing
the wrong code by mistake.  Imagine if we accidentally call <code>save</code> before we
we assign the owner:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    if form.is_valid():
        list_ = List()
        list_.save()
        list_.owner = request.user
        form.save(for_list=list_)
        return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The test, as it&#8217;s written now, still passes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>So strictly speaking, we need to check not just that the owner is assigned, but that
it&#8217;s assigned <em>before</em> we call <code>save</code> on our list object.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how we could test the sequence of events using mocks&#8212;&#8203;you can mock out
a function, and use it as a spy to check on the state of the world at the
moment it&#8217;s called:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @patch('lists.views.List')
    @patch('lists.views.ItemForm')
    def test_list_owner_is_saved_if_user_is_authenticated(
        self, mockItemFormClass, mockListClass
    ):
        user = User.objects.create(email='a@b.com')
        self.client.force_login(user)
        mock_list = mockListClass.return_value

        def check_owner_assigned():  <i class="conum" data-value="1"></i><b>(1)</b>
            self.assertEqual(mock_list.owner, user)
        mock_list.save.side_effect = check_owner_assigned  <i class="conum" data-value="2"></i><b>(2)</b>

        self.client.post('/lists/new', data={'text': 'new item'})

        mock_list.save.assert_called_once_with()  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We define a function that makes the assertion about the thing we
want to happen first: checking that the list&#8217;s owner has been set.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We assign that check function as a <code>side_effect</code> to the thing we
want to check happened second.  When the view calls our mocked
save function, it will go through this assertion.  We make sure to
set this up before we actually call the function we&#8217;re testing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we make sure that the function with the <code>side_effect</code> was
actually triggered&#8212;&#8203;that is, that we did <code>.save()</code>.  Otherwise, our
assertion may actually never have been run.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Two common mistakes when you&#8217;re using mock side effects are assigning the
    side effect too late (i.e., <em>after</em> you call the function under test), and
    forgetting to check that the side-effect function was actually called. And
    by common, I mean, "I made both these mistakes several times <em>while writing
    this chapter</em>.&rdquo;
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, if you&#8217;ve still got the "broken" code from earlier, where we
assign the owner but call <code>save</code> in the wrong order, you should now see a
fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_list_owner_is_saved_if_user_is_authenticated
(lists.tests.test_views.NewListTest)
[...]
  File "...python-tdd-book/lists/views.py", line 17, in new_list
    list_.save()
[...]
  File "...python-tdd-book/lists/tests/test_views.py", line 74, in
check_owner_assigned
    self.assertEqual(mock_list.owner, user)
AssertionError: &lt;MagicMock name='List().owner' id='140691452447208'&gt; != &lt;User:
User object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Notice how the failure happens when we try to save, and then go inside
our <code>side_effect</code> function.</p>
</div>
<div class="paragraph">
<p>We can get it passing again like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    if form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="paragraph">
<p>But, boy, that&#8217;s getting to be an ugly test!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">23.3. Listen to Your Tests: Ugly Tests Signal a Need to Refactor</h3>
<div class="paragraph">
<p>Whenever
you find yourself having to write a test like this, and you&#8217;re finding
it hard work, it&#8217;s likely that your tests are trying to tell you something.
Eight lines of setup (two lines for mocks, three to set up a user, and three more for our side-effect function) is way too many.</p>
</div>
<div class="paragraph">
<p>What this test is trying to tell us is that our view is doing too much work,
dealing with creating a form, creating a new list object, <em>and</em> deciding whether
or not to save an owner for the list.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already seen that we can make our views simpler and easier to understand
by pushing some of the work down to a form class. Why does the view need to
create the list object?  Perhaps our <code>ItemForm.save</code> could do that?  And why
does the view need to make decisions about whether or not to save the
<code>request.user</code>?  Again, the form could do that.</p>
</div>
<div class="paragraph">
<p>While we&#8217;re giving this form more responsibilities, it feels like it should
probably get a new name too.  We could call it <code>NewListForm</code> instead, since
that&#8217;s a better representation of what it does&#8230;&#8203;something like this?</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"># don't enter this code yet, we're only imagining it.

def new_list(request):
    form = NewListForm(data=request.POST)
    if form.is_valid():
        list_ = form.save(owner=request.user)  # creates both List and Item
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That would be neater!  Let&#8217;s see how we&#8217;d get to that state by using
fully isolated tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rewriting_our_tests_for_the_view_to_be_fully_isolated">23.4. Rewriting Our Tests for the View to Be Fully Isolated</h3>
<div class="paragraph">
<p>Our
first attempt at a test suite for this view was highly <em>integrated</em>.  It
needed the database layer and the forms layer to be fully functional in order
for it to pass.   We&#8217;ve started trying to make it more isolated, so let&#8217;s now go
all the way.</p>
</div>
<div class="sect3">
<h4 id="_keep_the_old_integrated_test_suite_around_as_a_sanity_check">23.4.1. Keep the Old Integrated Test Suite Around as a Sanity Check</h4>
<div class="paragraph">
<p>Let&#8217;s rename our old <code>NewListTest</code> class to <code>NewListViewIntegratedTest</code>,
and throw away our attempt at a mocky test for saving the owner, putting
back the integrated version, with a skip on it for now:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import unittest
[...]

class NewListViewIntegratedTest(TestCase):

    def test_can_save_a_POST_request(self):
        [...]

    @unittest.skip
    def test_list_owner_is_saved_if_user_is_authenticated(self):
        user = User.objects.create(email='a@b.com')
        self.client.force_login(user)
        self.client.post('/lists/new', data={'text': 'new item'})
        list_ = List.objects.first()
        self.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Have you heard the term "integration test" and are wondering what the
    difference is from an "integrated test"?  Go and take a peek at the
    definitions box in <a href="#chapter_hot_lava">Fast Tests, Slow Tests, and Hot Lava</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 37 tests in 0.139s
OK</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_test_suite_with_full_isolation">23.4.2. A New Test Suite with Full Isolation</h4>
<div class="paragraph">
<p>Let&#8217;s start with a blank slate, and see if we can use isolated tests to drive
a replacement of our <code>new_list</code> view.  We&#8217;ll call it <code>new_list2</code>, build it
alongside the old view, and when we&#8217;re ready, swap it in and see if
the old integrated tests all still pass:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    [...]

def new_list2(request):
    pass</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_thinking_in_terms_of_collaborators">23.4.3. Thinking in Terms of Collaborators</h4>
<div class="paragraph">
<p>In order to rewrite our tests to be fully isolated, we need to throw out our
old way of thinking about the tests in terms of the "real" effects of the view
on things like the database, and instead think of it in terms of the objects it
collaborates with, and how it interacts with them.</p>
</div>
<div class="paragraph">
<p>In the new world, the view&#8217;s main collaborator will be a form object, so we
mock that out in order to be able to fully control it, and in order to be able
to define, by wishful thinking, the way we want our form to work:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest.mock import patch
from django.http import HttpRequest
from lists.views import new_list2
[...]

@patch('lists.views.NewListForm')  <i class="conum" data-value="2"></i><b>(2)</b>
class NewListViewUnitTest(unittest.TestCase):  <i class="conum" data-value="1"></i><b>(1)</b>

    def setUp(self):
        self.request = HttpRequest()
        self.request.POST['text'] = 'new list item'  <i class="conum" data-value="3"></i><b>(3)</b>

    def test_passes_POST_data_to_NewListForm(self, mockNewListForm):
        new_list2(self.request)
        mockNewListForm.assert_called_once_with(data=self.request.POST)  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Django <code>TestCase</code> class makes it too easy to write integrated tests.
As a way of making sure we&#8217;re writing "pure", isolated unit tests, we&#8217;ll
only use <code>unittest.TestCase</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We mock out the <code>NewListForm</code> class (which doesn&#8217;t even exist yet). It&#8217;s
going to be used in all the tests, so we mock it out at the class level.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We set up a basic POST request in <code>setUp</code>, building up the request by
hand rather than using the (overly integrated) Django Test Client.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we check the first thing about our new view: it initialises its
collaborator, the <code>NewListForm</code>, with the correct constructor&#8212;&#8203;the
data from the request.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That will start with a failure, saying we don&#8217;t have a <code>NewListForm</code> in
our view yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: &lt;module 'lists.views' from '...python-tdd-book/lists/views.py'&gt;
does not have the attribute 'NewListForm'</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a placeholder for it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import ExistingListItemForm, ItemForm, NewListForm
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch20l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemForm(forms.models.ModelForm):
    [...]

class NewListForm(object):
    pass

class ExistingListItemForm(ItemForm):
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next we get a real failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: Expected 'NewListForm' to be called once. Called 0 times.</pre>
</div>
</div>
<div class="paragraph">
<p>And we implement like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l012-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list2(request):
    NewListForm(data=request.POST)</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 38 tests in 0.143s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s continue.  If the form is valid, we want to call <code>save</code> on it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from unittest.mock import patch, Mock
[...]

@patch('lists.views.NewListForm')
class NewListViewUnitTest(unittest.TestCase):

    def setUp(self):
        self.request = HttpRequest()
        self.request.POST['text'] = 'new list item'
        self.request.user = Mock()


    def test_passes_POST_data_to_NewListForm(self, mockNewListForm):
        new_list2(self.request)
        mockNewListForm.assert_called_once_with(data=self.request.POST)


    def test_saves_form_with_owner_if_form_valid(self, mockNewListForm):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = True
        new_list2(self.request)
        mock_form.save.assert_called_once_with(owner=self.request.user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>That takes us to this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list2(request):
    form = NewListForm(data=request.POST)
    form.save(owner=request.user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the case where the form is valid, we want the view to return a redirect,
to send us to see the object that the form has just created.  So we mock out
another of the view&#8217;s collaborators, the <code>redirect</code> function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @patch('lists.views.redirect')  <i class="conum" data-value="1"></i><b>(1)</b>
    def test_redirects_to_form_returned_object_if_form_valid(
        self, mock_redirect, mockNewListForm  <i class="conum" data-value="2"></i><b>(2)</b>
    ):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = True  <i class="conum" data-value="3"></i><b>(3)</b>

        response = new_list2(self.request)

        self.assertEqual(response, mock_redirect.return_value)  <i class="conum" data-value="4"></i><b>(4)</b>
        mock_redirect.assert_called_once_with(mock_form.save.return_value)  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock out the <code>redirect</code> function, this time at the method level.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>patch</code> decorators are applied innermost first, so the new mock is injected
to our method before the <code>mockNewListForm</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We specify that we&#8217;re testing the case where the form is valid.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We check that the response from the view is the result of the <code>redirect</code>
function.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And we check that the redirect function was called with the object that
the form returns on save.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That takes us to here:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list2(request):
    form = NewListForm(data=request.POST)
    list_ = form.save(owner=request.user)
    return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 40 tests in 0.163s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And now the failure case&#8212;&#8203;if the form is invalid, we want to render
the home page template:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l017)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @patch('lists.views.render')
    def test_renders_home_template_with_form_if_form_invalid(
        self, mock_render, mockNewListForm
    ):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = False

        response = new_list2(self.request)

        self.assertEqual(response, mock_render.return_value)
        mock_render.assert_called_once_with(
            self.request, 'home.html', {'form': mock_form}
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: &lt;HttpResponseRedirect status_code=302, "te[114 chars]%3E"&gt; !=
&lt;MagicMock name='render()' id='140244627467408'&gt;</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When using assert methods on mocks, like <code>assert_called_&#8203;once_with</code>,
    it&#8217;s doubly important to make sure you run the test and see it fail.
    It&#8217;s all too easy to make a typo in your assert function name and
    end up calling a mock method that does nothing (mine was to write
    <code>asssert_called_once_with</code> with three essses; try it!).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We make a deliberate mistake, just to make sure our tests are comprehensive:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l018)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list2(request):
    form = NewListForm(data=request.POST)
    list_ = form.save(owner=request.user)
    if form.is_valid():
        return redirect(list_)
    return render(request, 'home.html', {'form': form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That passes, but it shouldn&#8217;t!  One more test then:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_does_not_save_if_form_invalid(self, mockNewListForm):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = False
        new_list2(self.request)
        self.assertFalse(mock_form.save.called)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Which fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    self.assertFalse(mock_form.save.called)
AssertionError: True is not false</pre>
</div>
</div>
<div class="paragraph">
<p>And
we get to to our neat, small finished view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list2(request):
    form = NewListForm(data=request.POST)
    if form.is_valid():
        list_ = form.save(owner=request.user)
        return redirect(list_)
    return render(request, 'home.html', {'form': form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 42 tests in 0.163s
OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_moving_down_to_the_forms_layer">23.5. Moving Down to the Forms Layer</h3>
<div class="paragraph">
<p>So
we&#8217;ve built up our view function based on a "wishful thinking" version
of a form called <code>NewListForm</code>, which doesn&#8217;t even exist yet.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll need the form&#8217;s save method to create a new list, and a new item based on
the text from the form&#8217;s validated POST data.  If we were to just dive in and
use the ORM, the code might look something a bit like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListForm(models.Form):

    def save(self, owner):
        list_ = List()
        if owner:
            list_.owner = owner
        list_.save()
        item = Item()
        item.list = list_
        item.text = self.cleaned_data['text']
        item.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implementation depends on two classes from the model layer, <code>Item</code> and
<code>List</code>.  So, what would a well-isolated test look like?</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListFormTest(unittest.TestCase):

    @patch('lists.forms.List')  <i class="conum" data-value="1"></i><b>(1)</b>
    @patch('lists.forms.Item')  <i class="conum" data-value="1"></i><b>(1)</b>
    def test_save_creates_new_list_and_item_from_post_data(
        self, mockItem, mockList  <i class="conum" data-value="1"></i><b>(1)</b>
    ):
        mock_item = mockItem.return_value
        mock_list = mockList.return_value
        user = Mock()
        form = NewListForm(data={'text': 'new item text'})
        form.is_valid() <i class="conum" data-value="2"></i><b>(2)</b>

        def check_item_text_and_list():
            self.assertEqual(mock_item.text, 'new item text')
            self.assertEqual(mock_item.list, mock_list)
            self.assertTrue(mock_list.save.called)
        mock_item.save.side_effect = check_item_text_and_list  <i class="conum" data-value="3"></i><b>(3)</b>

        form.save(owner=user)

        self.assertTrue(mock_item.save.called)  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We mock out the two collaborators for our form from the models layer below.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We need to call <code>is_valid()</code> so that the form populates the <code>.cleaned_data</code>
dictionary where it stores validated data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the <code>side_effect</code> method to make sure that, when we save the new
item object, we&#8217;re doing so with a saved <code>List</code> and with the correct item
text.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As always, we double-check that our side-effect function was actually
called.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Yuck!  What an ugly test!  Let&#8217;s not even bother saving that to disk,
we can do better.</p>
</div>
<div class="sect3">
<h4 id="_keep_listening_to_your_tests_removing_orm_code_from_our_application">23.5.1. Keep Listening to Your Tests: Removing ORM Code from Our Application</h4>
<div class="paragraph">
<p>Again, these tests are trying to tell us something:  the Django ORM
is hard to mock out, and our form class needs to know too much about
how it works.  Programming by wishful thinking again, what would
be a simpler API that our form could use?  How about something like
this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def save(self):
        List.create_new(first_item_text=self.cleaned_data['text'])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our wishful thinking says: how about a helper method that
would live on the <code>List</code>
class<sup class="footnote">[<a id="_footnoteref_36" class="footnote" href="#_footnote_36" title="View footnote.">36</a>]</sup>
and encapsulate all the logic of saving a new list object and
its associated first item?</p>
</div>
<div class="paragraph">
<p>So let&#8217;s write a test for that instead:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch20l021)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import unittest
from unittest.mock import patch, Mock
from django.test import TestCase

from lists.forms import (
    DUPLICATE_ITEM_ERROR, EMPTY_ITEM_ERROR,
    ExistingListItemForm, ItemForm, NewListForm
)
from lists.models import Item, List
[...]


class NewListFormTest(unittest.TestCase):

    @patch('lists.forms.List.create_new')
    def test_save_creates_new_list_from_post_data_if_user_not_authenticated(
        self, mock_List_create_new
    ):
        user = Mock(is_authenticated=False)
        form = NewListForm(data={'text': 'new item text'})
        form.is_valid()
        form.save(owner=user)
        mock_List_create_new.assert_called_once_with(
            first_item_text='new item text'
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And while we&#8217;re at it, we can test the case where the user is an authenticated
user too:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch20l022)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @patch('lists.forms.List.create_new')
    def test_save_creates_new_list_with_owner_if_user_authenticated(
        self, mock_List_create_new
    ):
        user = Mock(is_authenticated=True)
        form = NewListForm(data={'text': 'new item text'})
        form.is_valid()
        form.save(owner=user)
        mock_List_create_new.assert_called_once_with(
            first_item_text='new item text', owner=user
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can see this is a much more readable test. Let&#8217;s start implementing
our new form.  We start with the import:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py (ch20l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.models import Item, List</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now mock tells us to create a placeholder for our <code>create_new</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AttributeError: &lt;class 'lists.models.List'&gt; does not have the attribute
'create_new'</pre>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class List(models.Model):

    def get_absolute_url(self):
        return reverse('view_list', args=[self.id])

    def create_new():
        pass</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And after a few steps, we should end up with a form save method like this:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/forms.py (ch20l025)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListForm(ItemForm):

    def save(self, owner):
        if owner.is_authenticated:
            List.create_new(first_item_text=self.cleaned_data['text'], owner=owner)
        else:
            List.create_new(first_item_text=self.cleaned_data['text'])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And passing tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
Ran 44 tests in 0.192s
OK</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Hiding ORM Code Behind Helper Methods</div>
<div class="paragraph">
<p>One
of the techniques that emerged from our use of isolated tests was the
"ORM helper method".</p>
</div>
<div class="paragraph">
<p>Django&#8217;s ORM lets you get things done quickly with a reasonably readable
syntax (it&#8217;s certainly much nicer than raw SQL!).  But some people like to
try to minimise the amount of ORM code in the application&#8212;&#8203;particularly
removing it from the views and forms layers.</p>
</div>
<div class="paragraph">
<p>One reason is that it makes it much easier to test those layers.  But another
is that it forces us to build helper functions that express our domain
logic more clearly. <span class="keep-together">Compare</span>:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        list_ = List()
        list_.save()
        item = Item()
        item.list = list_
        item.text = self.cleaned_data['text']
        item.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>With:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    List.create_new(first_item_text=self.cleaned_data['text'])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This applies to read queries as well as write. Imagine something like
this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    Book.objects.filter(in_print=True, pub_date__lte=datetime.today())</code></pre>
</div>
</div>
<div class="paragraph">
<p>Versus a helper method, like:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    Book.all_available_books()</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we build helper functions, we can give them names that express what we
are doing in terms of the business domain, which can actually make our code
more legible, as well as giving us the benefit of keeping all ORM calls at
the model layer, and thus making our whole application more loosely coupled.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finally_moving_down_to_the_models_layer">23.6. Finally, Moving Down to the Models Layer</h3>
<div class="paragraph">
<p>At
the models layer, we no longer need to write isolated tests&#8212;&#8203;the whole
point of the models layer is to integrate with the database, so it&#8217;s appropriate
to write integrated tests:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch20l026)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListModelTest(TestCase):

    def test_get_absolute_url(self):
        list_ = List.objects.create()
        self.assertEqual(list_.get_absolute_url(), f'/lists/{list_.id}/')


    def test_create_new_creates_list_and_first_item(self):
        List.create_new(first_item_text='new item text')
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'new item text')
        new_list = List.objects.first()
        self.assertEqual(new_item.list, new_list)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Which gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TypeError: create_new() got an unexpected keyword argument 'first_item_text'</pre>
</div>
</div>
<div class="paragraph">
<p>And that will take us to a first cut implementation that looks like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch20l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class List(models.Model):

    def get_absolute_url(self):
        return reverse('view_list', args=[self.id])

    @staticmethod
    def create_new(first_item_text):
        list_ = List.objects.create()
        Item.objects.create(text=first_item_text, list=list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice we&#8217;ve been able to get all the way down to the models layer,
driving a nice design for the views and forms layers, and the <code>List</code>
model still doesn&#8217;t support having an owner!</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s test the case where the list should have an owner, and
add:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch20l028)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.contrib.auth import get_user_model
User = get_user_model()
[...]

    def test_create_new_optionally_saves_owner(self):
        user = User.objects.create()
        List.create_new(first_item_text='new item text', owner=user)
        new_list = List.objects.first()
        self.assertEqual(new_list.owner, user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And while we&#8217;re at it, we can write the tests for the new owner attribute:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch20l029)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListModelTest(TestCase):
    [...]

    def test_lists_can_have_owners(self):
        List(owner=User())  # should not raise


    def test_list_owner_is_optional(self):
        List().full_clean()  # should not raise</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>These two are almost exactly the same tests we used in the last chapter,
but I&#8217;ve re-written them slightly so they don&#8217;t actually save objects&#8212;&#8203;just
having them as in-memory objects is enough for this test.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use in-memory (unsaved) model objects in your tests whenever you can; it
    makes your tests faster.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
ERROR: test_create_new_optionally_saves_owner
TypeError: create_new() got an unexpected keyword argument 'owner'
[...]
ERROR: test_lists_can_have_owners (lists.tests.test_models.ListModelTest)
TypeError: 'owner' is an invalid keyword argument for this function
[...]
Ran 48 tests in 0.204s
FAILED (errors=2)</pre>
</div>
</div>
<div class="paragraph">
<p>We implement, just like we did in the last chapter:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch20l030-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf import settings
[...]


class List(models.Model):
    owner = models.ForeignKey(settings.AUTH_USER_MODEL, blank=True, null=True)
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That will give us the usual integrity failures, until we do a migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.OperationalError: no such column: lists_list.owner_id</pre>
</div>
</div>
<div class="paragraph">
<p>Building the migration will get us down to three failures:</p>
</div>
<div class="listingblock dofirst-ch20l030-2">
<div class="content">
<pre>ERROR: test_create_new_optionally_saves_owner
TypeError: create_new() got an unexpected keyword argument 'owner'
[...]
ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7f5b2380b4e0&gt;&gt;":
"List.owner" must be a "User" instance.
ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7f5b237a12e8&gt;&gt;":
"List.owner" must be a "User" instance.</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s deal with the first one, which is for our <code>create_new</code> method:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch20l030-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @staticmethod
    def create_new(first_item_text, owner=None):
        list_ = List.objects.create(owner=owner)
        Item.objects.create(text=first_item_text, list=list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_back_to_views">23.6.1. Back to Views</h4>
<div class="paragraph">
<p>Two of our old integrated tests for the views layer are failing. What&#8217;s happening?</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ValueError: Cannot assign "&lt;SimpleLazyObject:
&lt;django.contrib.auth.models.AnonymousUser object at 0x7fbad1cb6c10&gt;&gt;":
"List.owner" must be a "User" instance.</pre>
</div>
</div>
<div class="paragraph">
<p>Ah, the old view isn&#8217;t discerning enough about what it does with list
owners yet:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    if form.is_valid():
        list_ = List()
        list_.owner = request.user
        list_.save()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is the point at which we realise that our old code wasn&#8217;t fit for purpose.
Let&#8217;s fix it to get all our tests passing:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)
    if form.is_valid():
        list_ = List()
        if request.user.is_authenticated:
            list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})


def new_list2(request):
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One
of the benefits of integrated tests is that they help you to catch
    less predictable interactions like this.  We&#8217;d forgotten to write a test
    for the case where the user is not authenticated, but because the
    integrated tests use the stack all the way down, errors from the model
    layer came up to let us know we&#8217;d forgotten something:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 48 tests in 0.175s
OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_moment_of_truth_and_the_risks_of_mocking">23.7. The Moment of Truth (and the Risks of Mocking)</h3>
<div class="paragraph">
<p>So
let&#8217;s try switching out our old view, and activating our new view. We
can make the swap in <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
    url(r'^new$', views.new_list2, name='new_list'),</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We should also remove the <code>unittest.skip</code> from our integrated test class, to
see if our new code for list owners really works:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l033)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListViewIntegratedTest(TestCase):

    def test_can_save_a_POST_request(self):
        [...]

    def test_list_owner_is_saved_if_user_is_authenticated(self):
        [...]
        self.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So what happens when we run our tests? Oh no!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ERROR: test_list_owner_is_saved_if_user_is_authenticated
[...]
ERROR: test_can_save_a_POST_request
[...]
ERROR: test_redirects_after_POST
(lists.tests.test_views.NewListViewIntegratedTest)
  File "...python-tdd-book/lists/views.py", line 30, in new_list2
    return redirect(list_)
[...]
TypeError: argument of type 'NoneType' is not iterable

FAILED (errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an important lesson to learn about test isolation: it might help you
to drive out good design for individual layers, but it won&#8217;t automatically
verify the integration <em>between</em> your layers.</p>
</div>
<div class="paragraph">
<p>What&#8217;s happened here is that the view was expecting the form to return
a list item:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        list_ = form.save(owner=request.user)
        return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But we forgot to make it return anything:</p>
</div>
<div class="exampleblock sourcecode currentcontents small-code">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def save(self, owner):
        if owner.is_authenticated:
            List.create_new(first_item_text=self.cleaned_data['text'], owner=owner)
        else:
            List.create_new(first_item_text=self.cleaned_data['text'])</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_thinking_of_interactions_between_layers_as_contracts">23.8. Thinking of Interactions Between Layers as "Contracts"</h3>
<div class="paragraph">
<p>Ultimately, even if we had been writing nothing but isolated unit tests, our
functional tests would have picked up this particular slip-up.  But ideally
we&#8217;d want our feedback cycle to be quicker&#8212;&#8203;functional tests may take a
couple of minutes to run, or even a few hours once your app starts to grow.  Is
there any way to avoid this sort of problem before it happens?</p>
</div>
<div class="paragraph">
<p>Methodologically, the way to do it is to think about the interaction between
your layers in terms of contracts.  Whenever we mock out the behaviour of one
layer, we have to make a mental note that there is now an implicit contract
between the layers, and that a mock on one layer should probably translate into
a test at the layer below.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the part of the contract that we missed:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @patch('lists.views.redirect')
    def test_redirects_to_form_returned_object_if_form_valid(
        self, mock_redirect, mockNewListForm
    ):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = True

        response = new_list2(self.request)

        self.assertEqual(response, mock_redirect.return_value)
        mock_redirect.assert_called_once_with(mock_form.save.return_value)  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The mocked <code>form.save</code> function is returning an object, which we expect
our view to be able to use.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_identifying_implicit_contracts">23.8.1. Identifying Implicit Contracts</h4>
<div class="paragraph">
<p>It&#8217;s worth reviewing each of the tests in <code>NewListViewUnitTest</code> and seeing
what each mock is saying about the implicit contract:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_passes_POST_data_to_NewListForm(self, mockNewListForm):
        [...]
        mockNewListForm.assert_called_once_with(data=self.request.POST)  <i class="conum" data-value="1"></i><b>(1)</b>


    def test_saves_form_with_owner_if_form_valid(self, mockNewListForm):
        mock_form = mockNewListForm.return_value
        mock_form.is_valid.return_value = True  <i class="conum" data-value="2"></i><b>(2)</b>
        new_list2(self.request)
        mock_form.save.assert_called_once_with(owner=self.request.user)  <i class="conum" data-value="3"></i><b>(3)</b>


    def test_does_not_save_if_form_invalid(self, mockNewListForm):
        [...]
        mock_form.is_valid.return_value = False  <i class="conum" data-value="2"></i><b>(2)</b>
        [...]


    @patch('lists.views.redirect')
    def test_redirects_to_form_returned_object_if_form_valid(
        self, mock_redirect, mockNewListForm
    ):
        [...]
        mock_redirect.assert_called_once_with(mock_form.save.return_value)  <i class="conum" data-value="4"></i><b>(4)</b>


    @patch('lists.views.render')
    def test_renders_home_template_with_form_if_form_invalid(
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We need to be able to initialise our form by passing it a POST request
as data.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It should have an <code>is_valid()</code> function which returns <code>True</code> or <code>False</code>
appropriately, based on the input data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The form should have a <code>.save</code> method which will accept a <code>request.user</code>,
which may or may not be a logged-in user, and deal with it appropriately.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The form&#8217;s <code>.save</code> method should return a new list object, for our view
to redirect the user to.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we have a look through our form tests, we&#8217;ll see that, actually, only item (3)
is tested explicitly.  On items (1) and (2) we were lucky&#8212;&#8203;they&#8217;re default
features of a Django <code>ModelForm</code>, and they are actually covered by our
tests for the parent <code>ItemForm</code> class.</p>
</div>
<div class="paragraph">
<p>But contract clause number (4) managed to slip through the net.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When doing Outside-In TDD with isolated tests, you need to keep track of
    each test&#8217;s implicit assumptions about the contract which the next layer
    should implement, and remember to test each of those in turn later.  You
    could use our scratchpad for this, or create a placeholder test with
    a <code>self.fail</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fixing_the_oversight">23.8.2. Fixing the Oversight</h4>
<div class="paragraph">
<p>Let&#8217;s add a new test that our form should return the new saved list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py (ch20l038-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @patch('lists.forms.List.create_new')
    def test_save_returns_new_list_object(self, mock_List_create_new):
        user = Mock(is_authenticated=True)
        form = NewListForm(data={'text': 'new item text'})
        form.is_valid()
        response = form.save(owner=user)
        self.assertEqual(response, mock_List_create_new.return_value)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And, actually, this is a good example&#8212;&#8203;we have an implicit contract
with the <code>List.create_new</code>; we want it to return the new list object.
Let&#8217;s add a placeholder test for that:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch20l038-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListModelTest(TestCase):
    [...]

    def test_create_returns_new_list_object(self):
        self.fail()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So, we have one test failure that&#8217;s telling us to fix the form save:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: None != &lt;MagicMock name='create_new()' id='139802647565536'&gt;
FAILED (failures=2, errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>Like this:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/forms.py (ch20l039-1)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListForm(ItemForm):

    def save(self, owner):
        if owner.is_authenticated:
            return List.create_new(first_item_text=self.cleaned_data['text'], owner=owner)
        else:
            return List.create_new(first_item_text=self.cleaned_data['text'])</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a start; now we should look at our placeholder test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
FAIL: test_create_returns_new_list_object
    self.fail()
AssertionError: None

FAILED (failures=1, errors=3)</pre>
</div>
</div>
<div class="paragraph">
<p>We flesh it out:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch20l039-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_create_returns_new_list_object(self):
        returned = List.create_new(first_item_text='new item text')
        new_list = List.objects.first()
        self.assertEqual(returned, new_list)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AssertionError: None != &lt;List: List object&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And we add our return value:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch20l039-3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @staticmethod
    def create_new(first_item_text, owner=None):
        list_ = List.objects.create(owner=owner)
        Item.objects.create(text=first_item_text, list=list_)
        return list_</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And
that gets us to a fully passing test suite:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
Ran 50 tests in 0.169s

OK</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_more_test">23.9. One More Test</h3>
<div class="paragraph">
<p>That&#8217;s our code for saving list owners, test-driven all the way down and
working.  But our functional test isn&#8217;t passing quite yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: Reticulate splines</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we have one last feature to implement, the <code>.name</code> attribute on list
objects.  Again, we can grab the test and code from the last chapter:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_models.py (ch20l040)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_list_name_is_first_item_text(self):
        list_ = List.objects.create()
        Item.objects.create(list=list_, text='first item')
        Item.objects.create(list=list_, text='second item')
        self.assertEqual(list_.name, 'first item')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(Again, since this is a model-layer test, it&#8217;s OK to use the ORM. You could
conceivably write this test using mocks, but there wouldn&#8217;t be much point.)</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch20l041)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    @property
    def name(self):
        return self.item_set.first().text</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that gets us to a passing FT!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_my_lists</strong>

Ran 1 test in 21.428s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tidy_up_what_to_keep_from_our_integrated_test_suite">23.10. Tidy Up: What to Keep from Our Integrated Test Suite</h3>
<div class="paragraph">
<p>Now
everything is working, we can remove some redundant tests, and decide
whether we want to keep any of our old integrated tests.</p>
</div>
<div class="sect3">
<h4 id="_removing_redundant_code_at_the_forms_layer">23.10.1. Removing Redundant Code at the Forms Layer</h4>
<div class="paragraph">
<p>We can get rid of the test for the old save method on the <code>ItemForm</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">--- a/lists/tests/test_forms.py
+++ b/lists/tests/test_forms.py
@@ -23,14 +23,6 @@ class ItemFormTest(TestCase):

         self.assertEqual(form.errors['text'], [EMPTY_ITEM_ERROR])


-    def test_form_save_handles_saving_to_a_list(self):
-        list_ = List.objects.create()
-        form = ItemForm(data={'text': 'do me'})
-        new_item = form.save(for_list=list_)
-        self.assertEqual(new_item, Item.objects.first())
-        self.assertEqual(new_item.text, 'do me')
-        self.assertEqual(new_item.list, list_)
-</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And in our actual code, we can get rid of two redundant save methods in
<em>forms.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/forms.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">--- a/lists/forms.py
+++ b/lists/forms.py
@@ -22,11 +22,6 @@ class ItemForm(forms.models.ModelForm):

         self.fields['text'].error_messages['required'] = EMPTY_ITEM_ERROR


-    def save(self, for_list):
-        self.instance.list = for_list
-        return super().save()
-
-

 class NewListForm(ItemForm):

@@ -52,8 +47,3 @@ class ExistingListItemForm(ItemForm):

             e.error_dict = {'text': [DUPLICATE_ITEM_ERROR]}
             self._update_errors(e)
-
-
-    def save(self):
-        return forms.models.ModelForm.save(self)
-</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_the_old_implementation_of_the_view">23.10.2. Removing the Old Implementation of the View</h4>
<div class="paragraph">
<p>We can now completely remove the old <code>new_list</code> view, and rename <code>new_list2</code> to
<code>new_list</code>:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">-from lists.views import new_list, new_list2
+from lists.views import new_list


 class HomePageTest(TestCase):
@@ -75,7 +75,7 @@ class NewListViewIntegratedTest(TestCase):
         request = HttpRequest()
         request.user = User.objects.create(email='a@b.com')
         request.POST['text'] = 'new list item'
-        new_list2(request)
+        new_list(request)
         list_ = List.objects.first()
         self.assertEqual(list_.owner, request.user)

@@ -91,21 +91,21 @@ class NewListViewUnitTest(unittest.TestCase):

     def test_passes_POST_data_to_NewListForm(self, mockNewListForm):
-        new_list2(self.request)
+        new_list(self.request)

[.. several more]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock sourcecode dofirst-ch20l045">
<div class="title">lists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">--- a/lists/urls.py
+++ b/lists/urls.py
@@ -3,7 +3,7 @@ from django.conf.urls import url
 from lists import views

 urlpatterns = [
-    url(r'^new$', views.new_list2, name='new_list'),
+    url(r'^new$', views.new_list, name='new_list'),
     url(r'^(\d+)/$', views.view_list, name='view_list'),
     url(r'^users/(.+)/$', views.my_lists, name='my_lists'),
 ]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch20l047)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = NewListForm(data=request.POST)
    if form.is_valid():
        list_ = form.save(owner=request.user)
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And a quick check that all the tests still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_removing_redundant_code_at_the_forms_layer_2">23.10.3. Removing Redundant Code at the Forms Layer</h4>
<div class="paragraph">
<p>Finally, we have to decide what (if anything) to keep from our integrated test
suite.</p>
</div>
<div class="paragraph">
<p>One option is to throw them all away, and decide that the FTs will pick up any
integration problems.  That&#8217;s perfectly valid.</p>
</div>
<div class="paragraph">
<p>On the other hand, we saw how integrated tests can warn you when you&#8217;ve made
small mistakes in integrating your layers.  We could keep just a couple of
tests around as "sanity checks", to give us a quicker feedback cycle.</p>
</div>
<div class="paragraph">
<p>How about these three:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_views.py (ch20l048)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListViewIntegratedTest(TestCase):

    def test_can_save_a_POST_request(self):
        self.client.post('/lists/new', data={'text': 'A new list item'})
        self.assertEqual(Item.objects.count(), 1)
        new_item = Item.objects.first()
        self.assertEqual(new_item.text, 'A new list item')


    def test_for_invalid_input_doesnt_save_but_shows_errors(self):
        response = self.client.post('/lists/new', data={'text': ''})
        self.assertEqual(List.objects.count(), 0)
        self.assertContains(response, escape(EMPTY_ITEM_ERROR))


    def test_list_owner_is_saved_if_user_is_authenticated(self):
        user = User.objects.create(email='a@b.com')
        self.client.force_login(user)
        self.client.post('/lists/new', data={'text': 'new item'})
        list_ = List.objects.first()
        self.assertEqual(list_.owner, user)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re going to keep any intermediate-level tests at all,  I like these
three because they feel like they&#8217;re doing the most "integration" jobs:  they
test the full stack, from the request down to the actual database, and they
cover the three most important use cases of our view.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusions_when_to_write_isolated_versus_integrated_tests">23.11. Conclusions: When to Write Isolated Versus Integrated Tests</h3>
<div class="paragraph">
<p>Django&#8217;s
testing tools make it very easy to quickly put together integrated
tests.  The test runner helpfully creates a fast, in-memory version of your
database and resets it for you in between each test.  The <code>TestCase</code> class
and the test client make it easy to test your views, from checking whether
database objects are modified, confirming that your URL mappings work, and
inspecting the rendering of the templates.  This lets you get started with
testing very easily and get good coverage across your whole stack.</p>
</div>
<div class="paragraph">
<p>On the other hand, these kinds of integrated tests won&#8217;t necessarily deliver
the full benefit that rigorous unit testing and Outside-In TDD are meant to
confer in terms of design.</p>
</div>
<div class="paragraph">
<p>If we look at the example in this chapter, compare the code we had before and
after:</p>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">Before</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)
    if form.is_valid():
        list_ = List()
        if not isinstance(request.user, AnonymousUser):
            list_.owner = request.user
        list_.save()
        form.save(for_list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})</code></pre>
</div>
</div>
<div class="listingblock sourcecode skipme">
<div class="title">After</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = NewListForm(data=request.POST)
    if form.is_valid():
        list_ = form.save(owner=request.user)
        return redirect(list_)
    return render(request, 'home.html', {'form': form})</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we hadn&#8217;t bothered to go down the isolation route, would we have bothered to
refactor the view function?  I know I didn&#8217;t in the first draft of this book.
I&#8217;d like to think I would have "in real life", but it&#8217;s hard to be sure.  But
writing isolated tests does make you very aware of where the complexities in
your code lie.</p>
</div>
<div class="sect3">
<h4 id="_let_complexity_be_your_guide">23.11.1. Let Complexity Be Your Guide</h4>
<div class="paragraph">
<p>I&#8217;d say the point at which isolated tests start to become worth it is to do
with complexity.  The example in this book is extremely simple, so it&#8217;s not
usually been worth it so far.  Even in the example in this chapter, I can
convince myself I didn&#8217;t really <em>need</em> to write those isolated tests.</p>
</div>
<div class="paragraph">
<p>But once an application gains a little more complexity&#8212;&#8203;if it starts growing
any more layers between views and models, if you find yourself writing  helper
methods, or if you&#8217;re writing your own classes, then you will probably gain from writing more
isolated tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="_should_you_do_both">23.11.2. Should You Do Both?</h4>
<div class="paragraph">
<p>We already have our suite of functional tests, which will serve the purpose
of telling us if we ever make any mistakes in integrating the different parts
of our code together.  Writing isolated tests can help us to drive out better
design for our code, and to verify correctness in finer detail.  Would a
middle layer of integration tests serve any additional purpose?</p>
</div>
<div class="paragraph">
<p>I think the answer is potentially yes, if they can provide a faster feedback
cycle, and help you identify more clearly what integration problems you suffer
from&#8212;&#8203;their tracebacks may provide you with better debug information than you
would get from a functional test, for example.</p>
</div>
<div class="paragraph">
<p>There may even be a case for building them as a separate test suite&#8212;&#8203;you
could have one suite of fast, isolated unit tests that don&#8217;t even use
<code>manage.py</code>, because they don&#8217;t need any of the database cleanup and teardown
that the Django test runner gives you, and then the intermediate layer that
uses Django, and finally the functional tests layer that, say, talks to a
staging server.  It may be worth it if each layer delivers incremental
benefits.</p>
</div>
<div class="paragraph">
<p>It&#8217;s a judgement call.  I hope that, by going through this chapter, I&#8217;ve given
you a feel for what the trade-offs are. There&#8217;s more discussion on this in
<a href="#chapter_hot_lava">Fast Tests, Slow Tests, and Hot Lava</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_onwards">23.11.3. Onwards!</h4>
<div class="paragraph">
<p>We&#8217;re happy with our new version, so let&#8217;s bring it across to master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add .</strong>
$ <strong>git commit -m "add list owners via forms. more isolated tests"</strong>
$ <strong>git checkout master</strong>
$ <strong>git checkout -b master-noforms-noisolation-bak</strong> # optional backup
$ <strong>git checkout master</strong>
$ <strong>git reset --hard more-isolation</strong>  # reset master to our branch.</pre>
</div>
</div>
<div class="paragraph">
<p>In the meantime&#8212;&#8203;those FTs are taking an annoyingly long time to run.  I
wonder if there&#8217;s something we can do about that?</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">On the Pros and Cons of Different Types of Tests, <br/>and Decoupling ORM Code</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Functional tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Provide
the best guarantee that your application really works correctly,
    from the point of view of the user</p>
</li>
<li>
<p>But: it&#8217;s a slower feedback cycle</p>
</li>
<li>
<p>And they don&#8217;t necessarily help you write clean code</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Integrated tests (reliant on, for example, the ORM or the Django Test Client)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Are
quick to write</p>
</li>
<li>
<p>Are easy to understand</p>
</li>
<li>
<p>Will warn you of any integration issues</p>
</li>
<li>
<p>But: may not always drive good design (that&#8217;s up to you!)</p>
</li>
<li>
<p>And are usually slower than isolated tests</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Isolated ("mocky") tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Involve
the most hard work</p>
</li>
<li>
<p>Can be harder to read and understand</p>
</li>
<li>
<p>But: are the best ones for guiding you towards better design</p>
</li>
<li>
<p>And run the fastest</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Decoupling our application from ORM code</dt>
<dd>
<p>    One
of the consequences of striving to write isolated tests is that we
    find ourselves forced to remove ORM code from places like views and forms,
    by hiding it behind helper functions or methods.  This can be beneficial in
    terms of decoupling your application from the ORM, but also just because it
    makes your code more readable. As with all things, it&#8217;s a judgement call as
    to whether the additional effort is worth it in particular circumstances.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_CI">24. Continuous Integration (CI)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As
our site grows, it takes longer and longer to run all of our functional
tests.  If this continues, the danger is that we&#8217;re going to stop bothering.</p>
</div>
<div class="paragraph">
<p>Rather than let that happen, we can automate the running of functional tests
by setting up a "Continuous Integration" or CI server.  That way, in day-to-day
development, we can just run the FT that we&#8217;re working on at that time, and
rely on the CI server to run all the tests automatically and let us know if
we&#8217;ve broken anything accidentally.  The unit tests should stay fast enough
that we can keep running them every few seconds.</p>
</div>
<div class="paragraph">
<p>The
CI server of choice these days is called Jenkins. It&#8217;s a bit Java, a bit
crashy, a bit ugly, but it&#8217;s what everyone uses, and it has a great plugin
ecosystem, so let&#8217;s get it up and running.</p>
</div>
<div class="sect2">
<h3 id="_installing_jenkins">24.1. Installing Jenkins</h3>
<div class="paragraph">
<p>There
are several hosted-CI services out there that essentially provide you
with a Jenkins server, ready to go.  I&#8217;ve come across Sauce Labs, Travis,
Circle-CI, ShiningPanda, and there are probably lots more.  But I&#8217;m going to
assume we&#8217;re installing everything on a server we control.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s not a good idea to install Jenkins on the same server as our
    staging or production servers.  Apart from anything else, we may want
    Jenkins to be able to reboot the staging server!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll install the latest version from the official Jenkins apt repo, because
the Ubuntu default still has a few annoying bugs with locale/unicode support,
and it also doesn&#8217;t set itself up to listen on the public internet by default:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>root@server:$ <strong>wget -q -O - https://pkg.jenkins.io/debian/jenkins-ci.org.key |\
     apt-key add -</strong>
root@server:$ <strong>echo deb http://pkg.jenkins.io/debian-stable binary/ | tee \
    /etc/apt/sources.list.d/jenkins.list</strong>
root@server:$ <strong>apt update</strong>
root@server:$ <strong>apt install jenkins</strong></pre>
</div>
</div>
<div class="paragraph">
<p>(Instructions lifted from the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu">Jenkins site</a>.)</p>
</div>
<div class="paragraph">
<p>While we&#8217;re at it, we&#8217;ll install a few other dependencies:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>root@server:$ <strong>add-apt-repository ppa:deadsnakes/ppa</strong>
root@server:$ <strong>apt update</strong>
root@server:$ <strong>apt install firefox python3.6-venv python3.6-dev xvfb</strong>
# and, to build fabric3:
root@server:$ <strong>apt install build-essential libssl-dev libffi-dev</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we&#8217;ll download, unzip, and install geckodriver too (it was v0.17 at
the time of writing, but substitute the latest version as you read this):</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>root@server:$ <strong>wget https://github.com/mozilla/geckodriver/releases\
/download/v0.17.0/geckodriver-v0.17.0-linux64.tar.gz</strong>
root@server:$ <strong>tar -xvzf geckodriver-v0.17.0-linux64.tar.gz</strong>
root@server:$ <strong>mv geckodriver /usr/local/bin</strong>
root@server:$ <strong>geckodriver --version</strong>
geckodriver 0.17.0</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Adding Some Swap</div>
<div class="paragraph">
<p>Jenkins is quite memory-hungry, and if  you&#8217;re running this on a small VM
with less than a couple of gigs for RAM, you&#8217;ll probably find it gets
OOM-killed unless you add some swap:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>fallocate -l 4G /swapfile</strong>
$ <strong>mkswap /swapfile</strong>
$ <strong>chmod 600 /swapfile</strong>
$ <strong>swapon /swapfile</strong></pre>
</div>
</div>
<div class="paragraph">
<p>That should be plenty.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_jenkins">24.2. Configuring Jenkins</h3>
<div class="paragraph">
<p>You
should now be able to visit Jenkins at the URL/IP for your server on port
<code>8080</code>, and see something like <a href="#jenkin-unlock">Jenkins unlock screen</a>.</p>
</div>
<div id="jenkin-unlock" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2401.png" alt="Jenkins' default unlock screen">
</div>
<div class="title">Figure 33. Jenkins unlock screen</div>
</div>
<div class="sect3">
<h4 id="_initial_unlock">24.2.1. Initial Unlock</h4>
<div class="paragraph">
<p>The unlock screen is telling us to read a file from disk to unlock
the server for first-time use.  I jumped over to a terminal and printed
it like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>root@server$ <strong>cat /var/lib/jenkins/secrets/initialAdminPassword</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_suggested_plugins_for_now">24.2.2. Suggested Plugins for Now</h4>
<div class="paragraph">
<p>Next we&#8217;re offered the choice to choose "suggested" plugins. Suggested
ones are fine for now. (As a self-respecting nerd, our instinct
is to hit "customize" immediately, and that&#8217;s what I did first time round,
but it turns out that screen won&#8217;t give us what we want. Don&#8217;t worry, we&#8217;ll add
some more plugins later.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_admin_user">24.2.3. Configuring the Admin User</h4>
<div class="paragraph">
<p>Next we set up a username and password to log in to Jenkins with; see <a href="#jenkins-user">Jenkins admin user config</a>.</p>
</div>
<div id="jenkins-user" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2402.png" alt="Jenkins screen asking for username and password">
</div>
<div class="title">Figure 34. Jenkins admin user config</div>
</div>
<div class="paragraph">
<p>And once we log in, we should see a welcome screen (<a href="#jenkin-welcome">A butler&#8212;&#8203;how quaint</a>).</p>
</div>
<div id="jenkin-welcome" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2403.png" alt="Jenkins welcome screen with invitation to create new job">
</div>
<div class="title">Figure 35. A butler&#8212;&#8203;how quaint</div>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_adding_plugins">24.2.4. Adding Plugins</h4>
<div class="paragraph">
<p>Follow the links for <em>Manage Jenkins</em> &#8594; <em>Manage Plugins</em> &#8594; <em>Available</em>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll want the plugins for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>ShiningPanda</em></p>
</li>
<li>
<p><em>Xvfb</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And hit install (<a href="#installing-plugins">Installing plugins&#8230;&#8203;</a>).</p>
</div>
<div id="installing-plugins" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2404.png" alt="Jenkins installing plugins">
</div>
<div class="title">Figure 36. Installing plugins&#8230;&#8203;</div>
</div>
</div>
<div class="sect3">
<h4 id="_telling_jenkins_where_to_find_python_3_and_xvfb">24.2.5. Telling Jenkins Where to Find Python 3 and Xvfb</h4>
<div class="paragraph">
<p>We need to tell the ShiningPanda plugin where Python 3 is installed
(usually <em>/usr/bin/python3</em>, but you can check with a <code>which python3</code>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Manage Jenkins</em> &#8594; <em>Global Tool Configuration</em></p>
</li>
<li>
<p><em>Python</em> &#8594; <em>Python installations</em> &#8594; <em>Add Python</em> (see <a href="#add-python-to-jenkins">Where did I leave that Python?</a>; it&#8217;s
safe to ignore the warning message)</p>
</li>
<li>
<p><em>Xvfb installation</em> &#8594; <em>Add Xvfb installation</em>; enter <strong><code>/usr/bin</code></strong> as the
installation directory</p>
</li>
</ul>
</div>
<div id="add-python-to-jenkins" class="imageblock">
<div class="content">
<img src="images/twp2_2405.png" alt="Adding Python 3">
</div>
<div class="title">Figure 37. Where did I leave that Python?</div>
</div>
</div>
<div class="sect3">
<h4 id="_finishing_off_with_https">24.2.6. Finishing Off with HTTPS</h4>
<div class="paragraph">
<p>To finish off securing your Jenkins instance, you&#8217;ll want to set up HTTPS, by
getting nginx HTTPS to use a self-signed cert, and proxy requests from port 443
to port 8080. Then you can even block port 8080 on the firewall.  I won&#8217;t go
into detail on that now, but here are a few links to instructions which I found
useful:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+on+Ubuntu">Official
Jenkins Ubuntu installation guide</a></p>
</li>
<li>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-create-an-ssl-certificate-on-nginx-for-ubuntu-14-04">How
to create a self-signed SSL certificate</a></p>
</li>
<li>
<p><a href="http://serverfault.com/questions/250476/how-to-force-or-redirect-to-ssl-in-nginx#424016">How
to redirect HTTP to HTTPS</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_our_project">24.3. Setting Up Our Project</h3>
<div class="paragraph">
<p>Now
we&#8217;ve got the basic Jenkins configured, let&#8217;s set up our project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hit the New Item button.</p>
</li>
<li>
<p>Enter <em>Superlists</em> as the name, and then choose "Freestyle project", and hit
OK.</p>
</li>
<li>
<p>Add the Git repo, as in <a href="#choose-git-repo">Get it from Git</a>.</p>
</li>
</ul>
</div>
<div id="choose-git-repo" class="imageblock">
<div class="content">
<img src="images/twp2_2406.png" alt="Setting the git repo">
</div>
<div class="title">Figure 38. Get it from Git</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set it to poll every hour (<a href="#poll-hourly">Poll GitHub for changes</a>; check out the help text here&#8212;&#8203;there are many other options for ways of triggering builds).</p>
</li>
</ul>
</div>
<div id="poll-hourly" class="imageblock">
<div class="content">
<img src="images/twp2_2407.png" alt="Config polling GitHub">
</div>
<div class="title">Figure 39. Poll GitHub for changes</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the tests inside a Python 3 virtualenv.</p>
</li>
<li>
<p>Run the unit tests and functional tests separately.  See
<a href="#virtualenv-buildstep">Virtualenv build steps</a>.</p>
</li>
</ul>
</div>
<div id="virtualenv-buildstep" class="imageblock">
<div class="content">
<img src="images/twp2_2408.png" alt="Adding Python 3">
</div>
<div class="title">Figure 40. Virtualenv build steps</div>
</div>
</div>
<div class="sect2">
<h3 id="_first_build">24.4. First Build!</h3>
<div class="paragraph">
<p>Hit
"Build Now", then go and take a look at the "Console Output". You
should see something like this:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>Started by user harry
Building in workspace /var/lib/jenkins/jobs/Superlists/workspace
Fetching changes from the remote Git repository
Fetching upstream changes from https://github.com/hjwp/book-example.git
Checking out Revision d515acebf7e173f165ce713b30295a4a6ee17c07 (origin/master)
[workspace] $ /bin/sh -xe /tmp/shiningpanda7260707941304155464.sh
+ pip install -r requirements.txt
Requirement already satisfied (use --upgrade to upgrade): Django==1.11 in
/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.6/site-packages
(from -r requirements.txt (line 1))

Requirement already satisfied (use --upgrade to upgrade): gunicorn==17.5 in
/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.6/site-packages
(from -r requirements.txt (line 3))
Downloading/unpacking requests==2.0.0 (from -r requirements.txt (line 4))
  Running setup.py egg_info for package requests

Installing collected packages: requests
  Running setup.py install for requests

Successfully installed requests
Cleaning up...
+ python manage.py test lists accounts
...................................................................
 ---------------------------------------------------------------------
Ran 67 tests in 0.429s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...
+ python manage.py test functional_tests
EEEEEE
======================================================================
ERROR: functional_tests.test_layout_and_styling (unittest.loader._FailedTest)
 ---------------------------------------------------------------------
ImportError: Failed to import test module: functional_tests.test_layout_and_styling
[...]
ImportError: No module named 'selenium'

Ran 6 tests in 0.001s

FAILED (errors=6)

Build step 'Virtualenv Builder' marked build as failure</pre>
</div>
</div>
<div class="paragraph">
<p>Ah.  We need Selenium in our virtualenv.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a manual installation of Selenium to our build
steps:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    pip install -r requirements.txt
    python manage.py test accounts lists
    pip install selenium fabric3
    python manage.py test functional_tests</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some people like to use a file called <em>test-requirements.txt</em> to specify
    packages that are needed for the tests, but not the main app.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And hit "Build Now" again.</p>
</div>
<div class="paragraph">
<p>Next one of two things will happen.  Either you&#8217;ll see some error messages
like this in your console output:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>    self.browser = webdriver.Firefox()
[...]
selenium.common.exceptions.WebDriverException: Message: 'The browser appears to
have exited before we could connect. The output was: b"\\n(process:19757):
GLib-CRITICAL **: g_slice_set_config: assertion \'sys_page_size == 0\'
failed\\nError: no display specified\\n"'
[...]
selenium.common.exceptions.WebDriverException: Message: connection refused</pre>
</div>
</div>
<div class="paragraph">
<p>Or possibly your build will just hang altogether (that happened to me at
least once).  The reason is that Firefox can&#8217;t start, because it doesn&#8217;t
have a display to run on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_a_virtual_display_so_the_fts_can_run_headless">24.5. Setting Up a Virtual Display So the FTs Can Run Headless</h3>
<div class="paragraph">
<p>As
you can see from the traceback, Firefox is unable to start because the
server doesn&#8217;t have a display.</p>
</div>
<div class="paragraph">
<p>There are two ways to deal with this problem. The first is to switch to using
a headless browser, like PhantomJS or SlimerJS.  Those tools definitely have
their place&#8212;&#8203;they&#8217;re faster, for one thing&#8212;&#8203;but they also have
disadvantages.  The first is that they&#8217;re not "real" web browsers, so you can&#8217;t
be sure you&#8217;re going to catch all the strange quirks and behaviours of the
actual browsers your users use.  The second is that they can behave quite
differently inside Selenium, and often require some rewriting of FT code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I would look into using headless browsers as a "dev-only" tool, to speed
    up the running of FTs on the developer&#8217;s machine, while the tests on the CI
    server use actual browsers.
</td>
</tr>
</table>
</div>
<div class="paragraph pagebreak-before">
<p>The alternative is to set up a virtual display:  we get the server to pretend
it has a screen attached to it, so Firefox runs happily. There are a few tools
out there to do this; we&#8217;ll use one called "Xvfb"
(X Virtual Framebuffer)<sup class="footnote">[<a id="_footnoteref_37" class="footnote" href="#_footnote_37" title="View footnote.">37</a>]</sup>
because it&#8217;s easy to install and use, and because it has a convenient Jenkins
plugin (now you know why we installed it earlier).</p>
</div>
<div class="paragraph">
<p>We go back to our project and hit "Configure" again, then find the section
called "Build Environment".  Using the virtual display is as simple as
ticking the box marked "Start Xvfb before the build, and shut it down after",
as in <a href="#xvfb-tickbox">Sometimes config is easy</a>.</p>
</div>
<div id="xvfb-tickbox" class="imageblock">
<div class="content">
<img src="images/twp2_2409.png" alt="Tickbox saying we want Xvfb">
</div>
<div class="title">Figure 41. Sometimes config is easy</div>
</div>
<div class="paragraph">
<p>The build does much better now:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>[...]
Xvfb starting$ /usr/bin/Xvfb :2 -screen 0 1024x768x24 -fbdir
/var/lib/jenkins/2013-11-04_03-27-221510012427739470928xvfb
[...]
+ python manage.py test lists accounts
...............................................................
 ---------------------------------------------------------------------
Ran 63 tests in 0.410s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...

+ pip install selenium
Requirement already satisfied (use --upgrade to upgrade): selenium in
/var/lib/jenkins/shiningpanda/jobs/ddc1aed1/virtualenvs/d41d8cd9/lib/python3.6/site-packages
Cleaning up...</pre>
</div>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>+ python manage.py test functional_tests
......F.
======================================================================
FAIL: test_can_start_a_list_for_one_user
(functional_tests.test_simple_list_creation.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_simple_list_creation.py", line
43, in test_can_start_a_list_for_one_user
    self.wait_for_row_in_list_table('2: Use peacock feathers to make a fly')
  File "...python-tdd-book/functional_tests/base.py", line 51, in
wait_for_row_in_list_table
    raise e
  File "...python-tdd-book/functional_tests/base.py", line 47, in
wait_for_row_in_list_table
    self.assertIn(row_text, [row.text for row in rows])
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']
 ---------------------------------------------------------------------
Ran 8 tests in 89.275s

FAILED (errors=1)
Creating test database for alias 'default'...
[{'secure': False, 'domain': 'localhost', 'name': 'sessionid', 'expiry':
1920011311, 'path': '/', 'value': 'a8d8bbde33nreq6gihw8a7r1cc8bf02k'}]
Destroying test database for alias 'default'...
Build step 'Virtualenv Builder' marked build as failure
Xvfb stopping
Finished: FAILURE</pre>
</div>
</div>
<div class="paragraph">
<p>Pretty
close!  To debug that failure, we&#8217;ll need screenshots though.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This error was due to the performance of my Jenkins instance&#8212;&#8203;you may see
    a different error, or none at all. In any case, the following tools for taking
    screenshots and dealing with race conditions will come in useful. Read on!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_taking_screenshots">24.6. Taking Screenshots</h3>
<div class="paragraph">
<p>To
be able to debug unexpected failures that happen on a remote PC, it
would be good to see a picture of the screen at the moment of the failure,
and maybe also a dump of the HTML of the page.  We can do that using some
custom logic in our FT class <code>tearDown</code>. We have to do a bit of introspection of
<code>unittest</code> internals, a private attribute called <code>_outcomeForDoCleanups</code>, but
this will work:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch21l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import os
from datetime import datetime
[...]

SCREEN_DUMP_LOCATION = os.path.join(
    os.path.dirname(os.path.abspath(__file__)), 'screendumps'
)
[...]

    def tearDown(self):
        if self._test_has_failed():
            if not os.path.exists(SCREEN_DUMP_LOCATION):
                os.makedirs(SCREEN_DUMP_LOCATION)
            for ix, handle in enumerate(self.browser.window_handles):
                self._windowid = ix
                self.browser.switch_to_window(handle)
                self.take_screenshot()
                self.dump_html()
        self.browser.quit()
        super().tearDown()


    def _test_has_failed(self):
        # slightly obscure but couldn't find a better way!
        return any(error for (method, error) in self._outcome.errors)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We first create a directory for our screenshots if necessary. Then we
iterate through all the open browser tabs and pages, and use some Selenium
methods, <code>get_screenshot_as_file</code> and <code>browser.page_source</code>, for our image and
HTML dumps:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/base.py (ch21l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def take_screenshot(self):
        filename = self._get_filename() + '.png'
        print('screenshotting to', filename)
        self.browser.get_screenshot_as_file(filename)


    def dump_html(self):
        filename = self._get_filename() + '.html'
        print('dumping page HTML to', filename)
        with open(filename, 'w') as f:
            f.write(self.browser.page_source)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>And finally here&#8217;s a way of generating a unique filename identifier, which
includes the name of the test and its class, as well as a timestamp:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/base.py (ch21l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def _get_filename(self):
        timestamp = datetime.now().isoformat().replace(':', '.')[:19]
        return '{folder}/{classname}.{method}-window{windowid}-{timestamp}'.format(
            folder=SCREEN_DUMP_LOCATION,
            classname=self.__class__.__name__,
            method=self._testMethodName,
            windowid=self._windowid,
            timestamp=timestamp
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can test this first locally by deliberately breaking one of the tests, with
a <code>self.fail()</code> for example, and you&#8217;ll see something like this:</p>
</div>
<div class="listingblock dofirst-ch21l009">
<div class="content">
<pre>[...]
screenshotting to ...python-tdd-book/functional_tests/screendumps/MyListsTest.t
est_logged_in_users_lists_are_saved_as_my_lists-window0-2014-03-09T11.19.12.png
dumping page HTML to ...python-tdd-book/functional_tests/screendumps/MyListsTes
t.test_logged_in_users_lists_are_saved_as_my_lists-window0-[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Revert the <code>self.fail()</code>, then commit and push:</p>
</div>
<div class="listingblock dofirst-ch21l010">
<div class="content">
<pre>$ <strong>git diff</strong>  # changes in base.py
$ <strong>echo "functional_tests/screendumps" &gt;&gt; .gitignore</strong>
$ <strong>git commit -am "add screenshot on failure to FT runner"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And when we rerun the build on Jenkins, we see something like this:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>screenshotting to /var/lib/jenkins/jobs/Superlists/.../functional_tests/
screendumps/LoginTest.test_login_with_persona-window0-2014-01-22T17.45.12.png
dumping page HTML to /var/lib/jenkins/jobs/Superlists/.../functional_tests/
screendumps/LoginTest.test_login_with_persona-window0-2014-01-22T17.45.12.html</pre>
</div>
</div>
<div class="paragraph">
<p>We can go and visit these in the "workspace", which is the folder Jenkins
uses to store our source code and run the tests in, as in
<a href="#screenshots-in-workspace">Visiting the project workspace</a>.</p>
</div>
<div id="screenshots-in-workspace" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2410.png" alt="workspace files including screenshot">
</div>
<div class="title">Figure 42. Visiting the project workspace</div>
</div>
<div class="paragraph">
<p>And then we look at the screenshot, as shown in <a href="#normal-screenshot">Screenshot looking normal</a>.</p>
</div>
<div id="normal-screenshot" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2411.png" alt="Screenshot of site page">
</div>
<div class="title">Figure 43. Screenshot looking normal</div>
</div>
</div>
<div class="sect2">
<h3 id="_if_in_doubt_try_bumping_the_timeout">24.7. If in Doubt, Try Bumping the Timeout!</h3>
<div class="paragraph">
<p>Hm.  No obvious clues there.  Well, when in doubt, bump the timeout, as the
old adage goes:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">functional_tests/base.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">MAX_WAIT = 20</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we can rerun the build on Jenkins using "Build Now", and confirm it now
works, as in <a href="#outlook-brighter">The outlook is brighter</a>.</p>
</div>
<div id="outlook-brighter" class="imageblock width-75">
<div class="content">
<img src="images/twp2_2412.png" alt="Build showing a recent pass and sun-peeking-through-clouds logo">
</div>
<div class="title">Figure 44. The outlook is brighter</div>
</div>
<div class="paragraph">
<p>Jenkins uses blue to indicate passing builds rather than green, which is a bit
disappointing, but look at the sun peeking through the clouds:  that&#8217;s cheery!
It&#8217;s an indicator of a moving average ratio of passing builds to failing
builds.  Things are looking up!</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_our_qunit_javascript_tests_in_jenkins_with_phantomjs">24.8. Running Our QUnit JavaScript Tests in Jenkins with PhantomJS</h3>
<div class="paragraph">
<p>There&#8217;s
a set of tests we almost forgot&#8212;&#8203;the JavaScript tests. Currently
our "test runner" is an actual web browser.  To get Jenkins to run them, we
need a command-line test runner.  Here&#8217;s a chance to use PhantomJS.</p>
</div>
<div class="sect3">
<h4 id="_installing_node">24.8.1. Installing node</h4>
<div class="paragraph">
<p>It&#8217;s time to stop pretending we&#8217;re not in the JavaScript game.  We&#8217;re doing
web development.  That means we do JavaScript.  That means we&#8217;re going to end
up with node.js on our computers.  It&#8217;s just the way it has to be.</p>
</div>
<div class="paragraph">
<p>Follow the instructions on the <a href="http://nodejs.org/">node.js homepage</a>. There are
installers for Windows and Mac, and repositories for popular Linux
distros.<sup class="footnote">[<a id="_footnoteref_38" class="footnote" href="#_footnote_38" title="View footnote.">38</a>]</sup></p>
</div>
<div class="paragraph">
<p>Once we have node, we can install phantom:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>npm install -g phantomjs-prebuilt</strong>  # the -g means "system-wide".</pre>
</div>
</div>
<div class="paragraph">
<p>Next we pull down a QUnit/PhantomJS test runner.  There are several out there
(I even wrote a basic one to be able to test the QUnit listings in this book),
but the best one to get is probably the one that&#8217;s linked from the
<a href="http://qunitjs.com/plugins/">QUnit plugins page</a>. At the time of writing, its
repo was at <a href="https://github.com/jonkemp/qunit-phantomjs-runner" class="bare">https://github.com/jonkemp/qunit-phantomjs-runner</a>.  The only file
you need is <em>runner.js</em>.</p>
</div>
<div class="paragraph">
<p>You should end up with this:</p>
</div>
<div class="listingblock dofirst-ch21l017">
<div class="content">
<pre>$ <strong>tree lists/static/tests/</strong>
lists/static/tests/
├── qunit-2.0.1.css
├── qunit-2.0.1.js
├── runner.js
└── tests.html

0 directories, 4 files</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>phantomjs lists/static/tests/runner.js lists/static/tests/tests.html</strong>
Took 24ms to run 2 tests. 2 passed, 0 failed.</pre>
</div>
</div>
<div class="paragraph">
<p>Just to be sure, let&#8217;s deliberately break something:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js (ch21l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">  $('input[name="text"]').on('keypress', function () {
    // $('.has-error').hide();
  });</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Sure enough:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>phantomjs lists/static/tests/runner.js lists/static/tests/tests.html</strong>

Test failed: errors should be hidden on keypress
    Failed assertion: expected: false, but was: true
file://...python-tdd-book/lists/static/tests/tests.html:27:15

Took 27ms to run 2 tests. 1 passed, 1 failed.</pre>
</div>
</div>
<div class="paragraph">
<p>All right!  Let&#8217;s unbreak that, commit and push the runner, and then add it to
our <span class="keep-together">Jenkins</span> build:</p>
</div>
<div class="listingblock dofirst-ch21l020">
<div class="content">
<pre>$ <strong>git checkout lists/static/list.js</strong>
$ <strong>git add lists/static/tests/runner.js</strong>
$ <strong>git commit -m "Add phantomjs test runner for javascript tests"</strong>
$ <strong>git push</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_the_build_steps_to_jenkins">24.8.2. Adding the Build Steps to Jenkins</h4>
<div class="paragraph">
<p>Edit the project configuration again, and add a step for each set of
JavaScript tests, as per <a href="#js-unit-tests-jenkey">Add a build step for our JavaScript unit tests</a>.</p>
</div>
<div id="js-unit-tests-jenkey" class="imageblock">
<div class="content">
<img src="images/twp2_2413.png" alt="Jenkins' default welcome screen">
</div>
<div class="title">Figure 45. Add a build step for our JavaScript unit tests</div>
</div>
<div class="paragraph">
<p>You&#8217;ll also need to install PhantomJS on the server:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>root@server:$ <strong>add-apt-repository -y ppa:chris-lea/node.js</strong>
root@server:$ <strong>apt update</strong>
root@server:$ <strong>apt install nodejs</strong>
root@server:$ <strong>npm install -g phantomjs-prebuilt</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And there we are!  A complete CI build featuring all of our tests!</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>Started by user harry
Building in workspace /var/lib/jenkins/jobs/Superlists/workspace
Fetching changes from the remote Git repository
Fetching upstream changes from https://github.com/hjwp/book-example.git
Checking out Revision 936a484038194b289312ff62f10d24e6a054fb29 (origin/chapter_1
Xvfb starting$ /usr/bin/Xvfb :1 -screen 0 1024x768x24 -fbdir /var/lib/jenkins/20
[workspace] $ /bin/sh -xe /tmp/shiningpanda7092102504259037999.sh

+ pip install -r requirements.txt
[...]

+ python manage.py test lists
.................................
 ---------------------------------------------------------------------
Ran 43 tests in 0.229s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...

+ python manage.py test accounts
..................
 ---------------------------------------------------------------------
Ran 18 tests in 0.078s

OK
Creating test database for alias 'default'...
Destroying test database for alias 'default'...

[workspace] $ /bin/sh -xe /tmp/hudson2967478575201471277.sh
+ phantomjs lists/static/tests/runner.js lists/static/tests/tests.html
Took 32ms to run 2 tests. 2 passed, 0 failed.
+ phantomjs lists/static/tests/runner.js accounts/static/tests/tests.html
Took 47ms to run 11 tests. 11 passed, 0 failed.

[workspace] $ /bin/sh -xe /tmp/shiningpanda7526089957247195819.sh
+ pip install selenium
Requirement already satisfied (use --upgrade to upgrade): selenium in /var/lib/

Cleaning up...
[workspace] $ /bin/sh -xe /tmp/shiningpanda2420240268202055029.sh
+ python manage.py test functional_tests
........
 ---------------------------------------------------------------------
Ran 8 tests in 76.804s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Nice
to know that, no matter how lazy I get about running the full test suite
on my own machine, the CI server will catch me.  Another one of the Testing
Goat&#8217;s agents in cyberspace, watching over us&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_more_things_to_do_with_a_ci_server">24.9. More Things to Do with a CI Server</h3>
<div class="paragraph">
<p>I&#8217;ve
only scratched the surface of what you can do with Jenkins and CI servers.
For example, you can make it much smarter about how it monitors your repo for
new commits.<sup class="footnote">[<a id="_footnoteref_39" class="footnote" href="#_footnote_39" title="View footnote.">39</a>]</sup></p>
</div>
<div class="paragraph">
<p>Perhaps more interestingly, you can use your CI server to automate your staging
tests as well as your normal functional tests.  If all the FTs pass, you can
add a build step that deploys the code to staging, and then reruns the FTs
against that&#8212;&#8203;automating one more step of the process, and ensuring that your
staging server is automatically kept up to date with the latest code.</p>
</div>
<div class="paragraph">
<p>Some people even use a CI server as the way of deploying their production
releases!</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tips on CI and Selenium Best Practices</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Set up CI as soon as possible for your project</dt>
<dd>
<p>    As
soon as your functional tests take more than a few seconds to run,
    you&#8217;ll find yourself avoiding running them all. Give this job to a CI
    server, to make sure that all your tests are getting run somewhere.</p>
</dd>
<dt class="hdlist1">Set up screenshots and HTML dumps for failures</dt>
<dd>
<p>    Debugging
test failures is easier if you can see what the page looked
    like when the failure occurred.  This is particularly useful for debugging
    CI failures, but it&#8217;s also very useful for tests that you run locally.</p>
</dd>
<dt class="hdlist1">Be prepared to bump your timeouts</dt>
<dd>
<p>A CI server may not be as speedy as your laptop, especially if it&#8217;s under
load, running multiple tests at the same time.  Be prepared to be even
more generous with your timeouts, in order to minimise the chance of
random failures.</p>
</dd>
<dt class="hdlist1">Look into hooking up CI and staging</dt>
<dd>
<p>    Tests
that use <code>LiveServerTestCase</code> are all very well for dev boxes,
    but the true reassurance comes from running your tests against a real
    server.  Look into getting your CI server to deploy to your staging server,
    and run the functional tests against that instead.  It has the side benefit
    of testing your automated deploy scripts.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_page_pattern">25. The Token Social Bit, the Page Pattern, and an Exercise for the Reader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Are
jokes about how "everything has to be social now" slightly old hat?
Everything has to be all A/B tested big data get-more-clicks lists of 10 Things
This Inspiring Teacher Said That Will Make You Change Your Mind About Blah Blah
now&#8230;&#8203;anyway. Lists, be they inspirational or otherwise, are often better
shared. Let&#8217;s allow our users to collaborate on their lists with other users.</p>
</div>
<div class="paragraph">
<p>Along the way we&#8217;ll improve our FTs by starting to implement something called
the Page object pattern.</p>
</div>
<div class="paragraph">
<p>Then, rather than showing you explicitly what to do, I&#8217;m going to let you write
your unit tests and application code by yourself.  Don&#8217;t worry, you won&#8217;t be
totally on your own!  I&#8217;ll give an outline of the steps to take, as well as
some hints and tips.</p>
</div>
<div class="sect2">
<h3 id="_an_ft_with_multiple_users_and_addcleanup">25.1. An FT with Multiple Users, and addCleanup</h3>
<div class="paragraph">
<p>Let&#8217;s
get started&#8212;&#8203;we&#8217;ll need two users for this FT:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch22l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver
from .base import FunctionalTest


def quit_if_possible(browser):
    try: browser.quit()
    except: pass


class SharingTest(FunctionalTest):

    def test_can_share_a_list_with_another_user(self):
        # Edith is a logged-in user
        self.create_pre_authenticated_session('edith@example.com')
        edith_browser = self.browser
        self.addCleanup(lambda: quit_if_possible(edith_browser))

        # Her friend Oniciferous is also hanging out on the lists site
        oni_browser = webdriver.Firefox()
        self.addCleanup(lambda: quit_if_possible(oni_browser))
        self.browser = oni_browser
        self.create_pre_authenticated_session('oniciferous@example.com')

        # Edith goes to the home page and starts a list
        self.browser = edith_browser
        self.browser.get(self.live_server_url)
        self.add_list_item('Get help')

        # She notices a "Share this list" option
        share_box = self.browser.find_element_by_css_selector(
            'input[name="sharee"]'
        )
        self.assertEqual(
            share_box.get_attribute('placeholder'),
            'your-friend@example.com'
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The interesting feature to note about this section is the <code>addCleanup</code>
function, whose documentation you can find
<a href="https://docs.python.org/3/library/unittest.html#unittest.TestCase.addCleanup">online</a>.
It can be used as an alternative to the <code>tearDown</code> function as a way of
cleaning up resources used during the test.  It&#8217;s most useful when the resource
is only allocated halfway through a test, so you don&#8217;t have to spend time in
<code>tearDown</code> figuring out what does or doesn&#8217;t need cleaning up.</p>
</div>
<div class="paragraph">
<p><code>addCleanup</code> is run after <code>tearDown</code>, which is why we need that
<code>try/except</code> formulation for <code>quit_if_possible</code>; whichever of <code>edith_browser</code>
and <code>oni_browser</code> is also assigned to <code>self.browser</code> at the point at which the
test ends will already have been quit by the <code>tearDown</code> function.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also need to move <code>create_pre_authenticated_session</code> from
<em>test_my_lists.py</em> into <em>base.py</em>.</p>
</div>
<div class="paragraph">
<p>OK, let&#8217;s see if that all works:</p>
</div>
<div class="listingblock dofirst-ch22l002">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_sharing</strong>
[...]
Traceback (most recent call last):
  File "...python-tdd-book/functional_tests/test_sharing.py", line 31, in
test_can_share_a_list_with_another_user
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: input[name="sharee"]</pre>
</div>
</div>
<div class="paragraph">
<p>Great! It seems to have got through creating the two user sessions, and
it gets onto an expected failure&#8212;&#8203;there is no input for an email address
of a person to share a list with on the page.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do a commit at this point, because we&#8217;ve got at least a placeholder
for our FT, we&#8217;ve got a useful modification of the
<code>create_pre_authenticated_session</code> function, and we&#8217;re about to embark on
a bit of an FT refactor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "New FT for sharing, move session creation stuff to base"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_page_pattern">25.2. The Page Pattern</h3>
<div class="paragraph">
<p>Before
we go any further, I want to show an alternative method for reducing
duplication in your FTs, called
<a href="http://bit.ly/2uWBvsM">"Page objects"</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already built several helper methods for our FTs, including
<code>add_list_item</code>, which we&#8217;ve used here, but if we just keep adding more and
more, it&#8217;s going to get very crowded. I&#8217;ve worked on a base FT class that was
over 1,500 lines long, and that got pretty unwieldy.</p>
</div>
<div class="paragraph">
<p>Page objects are an alternative which encourage us to store all the information
and helper methods about the different types of pages on our site in a single place.
Let&#8217;s see how that might look for our site, starting with a class to represent any
lists page:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">functional_tests/list_page.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium.webdriver.common.keys import Keys
from .base import wait


class ListPage(object):

    def __init__(self, test):
        self.test = test  <i class="conum" data-value="1"></i><b>(1)</b>


    def get_table_rows(self):  <i class="conum" data-value="3"></i><b>(3)</b>
        return self.test.browser.find_elements_by_css_selector('#id_list_table tr')


    @wait
    def wait_for_row_in_list_table(self, item_text, item_number):  <i class="conum" data-value="2"></i><b>(2)</b>
        expected_row_text = f'{item_number}: {item_text}'
        rows = self.get_table_rows()
        self.test.assertIn(expected_row_text, [row.text for row in rows])


    def get_item_input_box(self):  <i class="conum" data-value="2"></i><b>(2)</b>
        return self.test.browser.find_element_by_id('id_text')


    def add_list_item(self, item_text):  <i class="conum" data-value="2"></i><b>(2)</b>
        new_item_no = len(self.get_table_rows()) + 1
        self.get_item_input_box().send_keys(item_text)
        self.get_item_input_box().send_keys(Keys.ENTER)
        self.wait_for_row_in_list_table(item_text, new_item_no)
        return self  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It&#8217;s initialised with an object that represents the current test.  That
gives us the ability to make assertions, access the browser instance via
<code>self.test.browser</code>, and use the <code>self.test.wait_for</code> function.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>I&#8217;ve copied across some of the existing helper methods from <em>base.py</em>, but
I&#8217;ve tweaked them slightly&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For example, they make use of this new method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Returning <code>self</code> is just a convenience. It enables
<a href="https://en.wikipedia.org/wiki/Method_chaining">method chaining</a>,
which we&#8217;ll see in action immediately.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see how to use it in our test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch22l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from .list_page import ListPage
[...]

        # Edith goes to the home page and starts a list
        self.browser = edith_browser
        self.browser.get(self.live_server_url)
        list_page = ListPage(self).add_list_item('Get help')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s continue rewriting our test, using the Page object whenever
we want to access elements from the lists page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch22l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">        # She notices a "Share this list" option
        share_box = list_page.get_share_box()
        self.assertEqual(
            share_box.get_attribute('placeholder'),
            'your-friend@example.com'
        )

        # She shares her list.
        # The page updates to say that it's shared with Oniciferous:
        list_page.share_list_with('oniciferous@example.com')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We add the following three functions to our <code>ListPage</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/list_page.py (ch22l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def get_share_box(self):
        return self.test.browser.find_element_by_css_selector(
            'input[name="sharee"]'
        )


    def get_shared_with_list(self):
        return self.test.browser.find_elements_by_css_selector(
            '.list-sharee'
        )


    def share_list_with(self, email):
        self.get_share_box().send_keys(email)
        self.get_share_box().send_keys(Keys.ENTER)
        self.test.wait_for(lambda: self.test.assertIn(
            email,
            [item.text for item in self.get_shared_with_list()]
        ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The idea behind the Page pattern is that it should capture all the information
about a particular page in your site, so that if, later, you want to go and
make changes to that page&#8212;&#8203;even just simple tweaks to its HTML layout, for
example&#8212;&#8203;you have a single place to go to adjust your functional
tests, rather than having to dig through dozens of FTs.</p>
</div>
<div class="paragraph">
<p>The
next step would be to pursue the FT refactor through our other tests. I&#8217;m
not going to show that here, but it&#8217;s something you could do, for practice,
to get a feel for what the trade-offs between DRY and test readability
are like&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_extend_the_ft_to_a_second_user_and_the_my_lists_page">25.3. Extend the FT to a Second User, and the "My Lists" Page</h3>
<div class="paragraph">
<p>Let&#8217;s
spec out just a little more detail of what we want our sharing user
story to be.  Edith has seen on her list page that the list is now "shared
with" Oniciferous, and then we can have Oni log in and see the list on his "My
Lists" page, maybe in a section called "lists shared with me":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch22l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from .my_lists_page import MyListsPage
[...]

        list_page.share_list_with('oniciferous@example.com')

        # Oniciferous now goes to the lists page with his browser
        self.browser = oni_browser
        MyListsPage(self).go_to_my_lists_page()

        # He sees Edith's list in there!
        self.browser.find_element_by_link_text('Get help').click()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That means another function in our <code>MyListsPage</code> class:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/my_lists_page.py (ch22l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class MyListsPage(object):

    def __init__(self, test):
        self.test = test


    def go_to_my_lists_page(self):
        self.test.browser.get(self.test.live_server_url)
        self.test.browser.find_element_by_link_text('My lists').click()
        self.test.wait_for(lambda: self.test.assertEqual(
            self.test.browser.find_element_by_tag_name('h1').text,
            'My Lists'
        ))
        return self</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once again, this is a function that would be good to carry across into
<em>test_my_lists.py</em>, along with maybe a <code>MyListsPage</code> object.</p>
</div>
<div class="paragraph">
<p>In the meantime, Oniciferous can also add things to the list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/test_sharing.py (ch22l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # On the list page, Oniciferous can see says that it's Edith's list
    self.wait_for(lambda: self.assertEqual(
        list_page.get_list_owner(),
        'edith@example.com'
    ))

    # He adds an item to the list
    list_page.add_list_item('Hi Edith!')

    # When Edith refreshes the page, she sees Oniciferous's addition
    self.browser = edith_browser
    self.browser.refresh()
    list_page.wait_for_row_in_list_table('Hi Edith!', 2)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s another addition to our <code>ListPage</code> object:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">functional_tests/list_page.py (ch22l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListPage(object):
    [...]

    def get_list_owner(self):
        return self.test.browser.find_element_by_id('id_list_owner').text</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s long past time to run the FT and check if all of this works!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_sharing</strong>

    share_box = list_page.get_share_box()
    [...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: input[name="sharee"]</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the expected failure; we don&#8217;t have an input for email addresses
of people to share with. Let&#8217;s do a commit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git add functional_tests</strong>
$ <strong>git commit -m "Create Page objects for list pages, use in sharing FT"</strong></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_exercise_for_the_reader">25.4. An Exercise for the Reader</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I probably didn’t really understand what I was doing until after having
completed the "Exercise for the reader" in <a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Iain H. (reader)
</div>
</div>
<div class="paragraph">
<p>There&#8217;s
nothing that cements learning like taking the training wheels off,
and getting something working on your own, so I hope you&#8217;ll give this a go.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an outline of the steps you could take:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We&#8217;ll need a new section in <em>list.html</em>, with, at first, a form with an
input box for an email address.  That should get the FT one step further.</p>
</li>
<li>
<p>Next, we&#8217;ll need a view for the form to submit to. Start by defining the
URL in the template, maybe something like <em>lists/&lt;list_id&gt;/share</em>.</p>
</li>
<li>
<p>Then, our first unit test. It can be just enough to get a placeholder view
in. We want the view to respond to POST requests, and it should respond with
a redirect back to the list page, so the test could be called something like
<code>ShareListTest.test_post_redirects_to_lists_page</code>.</p>
</li>
<li>
<p>We build out our placeholder view, as just a two-liner that finds a list and
redirects to it.</p>
</li>
<li>
<p>We can then write a new unit test which creates a user and a list,
does a POST with their email address, and checks that the user is added to
<code>list_.shared_with.all()</code> (a similar ORM usage to "My Lists").  That
<code>shared_with</code> attribute won&#8217;t exist yet; we&#8217;re going outside-in.</p>
</li>
<li>
<p>So before we can get this test to pass, we have to move down to the model
layer.  The next test, in <em>test_models.py</em>, can check that a list has a
<code>shared_with.add</code> method, which can be called with a user&#8217;s email address and
then check the lists' <code>shared_with.all()</code> queryset, which will subsequently
contain that user.</p>
</li>
<li>
<p>You&#8217;ll then need a <code>ManyToManyField</code>.  You&#8217;ll probably see an error message
about a clashing <code>related_name</code>, which you&#8217;ll find a solution to if you look
around the Django docs.</p>
</li>
<li>
<p>It will need a database migration.</p>
</li>
<li>
<p>That should get the model tests passing. Pop back up to fix the view test.</p>
</li>
<li>
<p>You may find the redirect view test fails, because it&#8217;s not sending a valid
POST request.  You can either choose to ignore invalid inputs, or adjust the
test to send a valid POST.</p>
</li>
<li>
<p>Then back up to the template level; on the "My Lists" page we&#8217;ll want a
<code>&lt;ul&gt;</code> with a <code>for</code> loop of the lists shared with the user. On the lists
page, we also want to show who the list is shared with, as well as
mention of who the list owner is. Look back at the FT for the correct classes
and IDs to use. You could have brief unit tests for each of these if you
like, as well.</p>
</li>
<li>
<p>You might find that spinning up the site with <code>runserver</code> will help you
iron out any bugs, as well as fine-tune the layout and aesthetics.
If you use a private browser session, you&#8217;ll be able to log multiple users
in.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By the end, you might end up with something that looks like
<a href="#list-sharing-example">Sharing lists</a>.</p>
</div>
<div id="list-sharing-example" class="imageblock">
<div class="content">
<img src="images/twp2_2501.png" alt="Screenshot of list sharing UI">
</div>
<div class="title">Figure 46. Sharing lists</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The Page Pattern, and the Real Exercise for the Reader</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Apply DRY to your functional tests</dt>
<dd>
<p>    Once
your FT suite starts to grow, you&#8217;ll find that different tests will
    inevitably find themselves using similar parts of the UI. Try to avoid
    having constants, like the HTML IDs or classes of particular UI elements,
    duplicated between your FTs.</p>
</dd>
<dt class="hdlist1">The Page pattern</dt>
<dd>
<p>    Moving
helper methods into a base <code>FunctionalTest</code> class can become
    unwieldy.  Consider using individual Page objects to hold all the
    logic for dealing with particular parts of your site.</p>
</dd>
<dt class="hdlist1">An exercise for the reader</dt>
<dd>
<p>I hope you&#8217;ve actually tried this out!  Try to follow the outside-in
method, and occasionally try things out manually if you get stuck.
The real exercise for the reader, of course, is to apply TDD to your
next project.  I hope you&#8217;ll enjoy it!</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>In the next chapter, we&#8217;ll wrap up with a discussion of testing "best
practices."</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_hot_lava">26. Fast Tests, Slow Tests, and Hot Lava</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The database is Hot Lava!</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="https://www.youtube.com/watch?v=bsmFVb8guMU">Casey Kinsey</a>
</div>
</div>
<div class="paragraph">
<p>Right
up until <a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>, almost all of the "unit" tests in
the book should perhaps have been called <em>integrated</em> tests, because they
either rely on the database or use the Django Test Client, which does too
much magic with the middleware layers that sit between requests, responses, and
view functions.</p>
</div>
<div class="paragraph">
<p>There is an argument that a true unit test should always be isolated, because
it&#8217;s meant to test a single unit of software. If it touches the database, it
can&#8217;t be a unit test.  The database is hot lava!</p>
</div>
<div class="paragraph">
<p>Some TDD veterans say you should strive to write "pure", isolated unit tests
wherever possible, instead of writing integrated tests.  It&#8217;s one of the
ongoing (occasionally heated) debates in the testing community.</p>
</div>
<div class="paragraph">
<p>Being merely a young whippersnapper myself, I&#8217;m only partway towards all the
subtleties of the argument. But in this chapter, I&#8217;d like to talk about
why people feel strongly about it, and try to give you some idea of when you
can get away with muddling through with integrated tests (which I confess I do
a lot of!), and when it&#8217;s worth striving for more "pure" unit tests.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Terminology: Different Types of Test</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Isolated tests ("pure" unit tests) vs. integrated tests</dt>
<dd>
<p>The primary purpose of a unit test should be to verify the correctness
of the logic of your application.
An <em>isolated</em> test is one that tests exactly one chunk of code, and whose
success or failure does not depend on any other external code. This is what
I call a "pure" unit test:  a test for a single function, for example,
written in such a way that only that function can make it fail.  If the
function depends on another system, and breaking that system breaks our
test, we have an <em>integrated</em> test. That system could be an external
system, like a database, but it could also be another function which we
don&#8217;t control.  In either case, if breaking the system makes our test fail,
our test is not properly isolated; it is not a "pure" unit test.  That&#8217;s
not necessarily a bad thing, but it may mean the test is doing two jobs at
once.</p>
</dd>
<dt class="hdlist1">Integration tests</dt>
<dd>
<p>An integration test checks that the code you control is integrated
correctly with some external system which you don&#8217;t control.
<em>Integration</em> tests are typically also <em>integrated</em> tests.</p>
</dd>
<dt class="hdlist1">System tests</dt>
<dd>
<p>    If
an integration test checks the integration with one external system,
    a system test checks the integration of multiple systems in your
    application&#8212;&#8203;for example, checking that we&#8217;ve wired up our database,
    static files, and server config together in such a way that they all work.</p>
</dd>
<dt class="hdlist1">Functional tests and acceptance tests</dt>
<dd>
<p>    An
acceptance test is meant to test that our system works from the point
    of view of the user ("would the user accept this behaviour?").  It&#8217;s
    hard to write an acceptance test that&#8217;s not a full-stack, end-to-end test.
    We&#8217;ve been using our functional tests to play the role of both acceptance
    tests and system tests.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ll forgive the pretentious philosophical terminology, I&#8217;d like to
structure our discussion of these issues like a Hegelian dialectic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Thesis: the case for "pure", fast unit tests.</p>
</li>
<li>
<p>The Antithesis: some of the risks associated with a (naive) pure unit testing
approach.</p>
</li>
<li>
<p>The Synthesis: a discussion of best practices like "Ports and Adapters"
or "Functional Core, Imperative Shell", and of just what it is that we want
from our tests, anyway.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_thesis_unit_tests_are_superfast_and_good_besides_that">26.1. Thesis: Unit Tests Are Superfast and Good Besides That</h3>
<div class="paragraph">
<p>One
of the things you often hear about unit tests is that they&#8217;re much faster.
I don&#8217;t think that&#8217;s actually the primary benefit of unit tests, but it&#8217;s worth
exploring the theme of speed.</p>
</div>
<div class="sect3">
<h4 id="_faster_tests_mean_faster_development">26.1.1. Faster Tests Mean Faster Development</h4>
<div class="paragraph">
<p>Other things being equal, the faster your unit tests run, the better.  To a
lesser extent, the faster <em>all</em> your tests run, the better.</p>
</div>
<div class="paragraph">
<p>I&#8217;ve outlined the TDD test/code cycle in this book.  You&#8217;ve started to get a
feel for the TDD workflow, the way you flick between writing tiny amounts of
code and running your tests.  You end up running your unit tests several times
a minute, and your functional tests several times a day.</p>
</div>
<div class="paragraph">
<p>So, on a very basic level, the longer they take, the more time you spend
waiting for your tests, and that will slow down your development.  But
there&#8217;s more to it than that.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_holy_flow_state">26.1.2. The Holy Flow State</h4>
<div class="paragraph">
<p>Thinking sociology for a moment, we programmers have our own culture, and our
own tribal religion in a way. It has many congregations within it, such as the
cult of TDD to which you are now initiated.  There are the followers of vi and
the heretics of emacs. But one thing we all agree on, one particular spiritual
practice, our own transcendental meditation, is the holy flow state.  That
feeling of pure focus, of concentration, where hours pass like no time at all,
where code flows naturally from our fingers, where problems are just tricky
enough to be interesting but not so hard that they defeat us&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>There is absolutely no hope of achieving flow if you spend your time waiting
for a slow test suite to run.  Anything longer than a few seconds and you&#8217;re
going to let your attention wander, you context-switch, and the flow state is
gone.  And the flow state is a fragile dream. Once it&#8217;s gone, it takes at
least 15 minutes to live again.</p>
</div>
</div>
<div class="sect3">
<h4 id="_slow_tests_don_t_get_run_as_often_which_causes_bad_code">26.1.3. Slow Tests Don&#8217;t Get Run as Often, Which Causes Bad Code</h4>
<div class="paragraph">
<p>If your test suite is slow and ruins your concentration, the danger is that
you&#8217;ll start to avoid running your tests, which may lead to bugs getting
through. Or, it may lead to our being shy of refactoring the code,
since we know that any refactor will mean having to wait ages while all the
tests run. In either case, bad code can be the result.</p>
</div>
</div>
<div class="sect3">
<h4 id="_we_re_fine_now_but_integrated_tests_get_slower_over_time">26.1.4. We&#8217;re Fine Now, but Integrated Tests Get Slower Over Time</h4>
<div class="paragraph">
<p>You might be thinking, OK, but our test suite has lots of integrated
tests in it&#8212;&#8203;over 50 of them, and it only takes 0.2 seconds to run.</p>
</div>
<div class="paragraph">
<p>But remember, we&#8217;ve got a very simple app. Once it starts to get more
complex, as your database grows more and more tables and columns, integrated
tests will get slower and slower.  Having Django reset the database between
each test will take longer and longer.</p>
</div>
</div>
<div class="sect3">
<h4 id="_don_t_take_it_from_me">26.1.5. Don&#8217;t Take It from Me</h4>
<div class="paragraph">
<p>Gary Bernhardt, a man with far more experience of testing than me, put these
points eloquently in a talk called
<a href="https://www.youtube.com/watch?v=RAxiiRPHS9k">Fast Test, Slow Test</a>. I encourage
you to watch it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_and_unit_tests_drive_good_design">26.1.6. And Unit Tests Drive Good Design</h4>
<div class="paragraph">
<p>But perhaps more importantly than any of this, remember the lesson from
<a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>.  Going through the process of writing good, isolated
unit tests can help us drive out better designs for our code, by forcing us
to identify dependencies, and encouraging us towards a decoupled architecture
in a way that integrated tests don&#8217;t.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_problems_with_pure_unit_tests">26.2. The Problems with "Pure" Unit Tests</h3>
<div class="paragraph">
<p>All
of this comes with a huge "but". Writing isolated united tests comes with
its own hazards, particularly if, like you or me, we are not yet advanced
TDD&#8217;ers.</p>
</div>
<div class="sect3">
<h4 id="_isolated_tests_can_be_harder_to_read_and_write">26.2.1. Isolated Tests Can Be Harder to Read and Write</h4>
<div class="paragraph">
<p>Cast your mind back to the first isolated unit test we wrote.  Wasn&#8217;t it ugly?
Admittedly, things improved when we refactored things out into the forms, but
imagine if we hadn&#8217;t followed through?  We&#8217;d have been left with a rather
unreadable test in our codebase.  And even the final version of the tests we
ended up with contain some pretty mind-bending bits.</p>
</div>
</div>
<div class="sect3">
<h4 id="_isolated_tests_don_t_automatically_test_integration">26.2.2. Isolated Tests Don&#8217;t Automatically Test Integration</h4>
<div class="paragraph">
<p>As we saw a little later on, isolated tests by their nature only test the
unit under test, in isolation.  They won&#8217;t test the integration between
your units.</p>
</div>
<div class="paragraph">
<p>This problem is well known, and there are ways of mitigating it. But, as
we saw, those mitigations involve a fair bit of hard work on the part of
the programmer&#8212;&#8203;you need to remember to keep track of the interfaces
between your units, to identify the implicit contract that each component
needs to honour, and to write tests for those contracts as well
as for the internal functionality of your unit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_unit_tests_seldom_catch_unexpected_bugs">26.2.3. Unit Tests Seldom Catch Unexpected Bugs</h4>
<div class="paragraph">
<p>Unit tests will help you catch off-by-one errors and logic snafus, which are
the kinds of bugs we know we introduce all the time, so in a way we are
expecting them. But they don&#8217;t warn you about some of the more unexpected
bugs.  They won&#8217;t remind you when you forgot to create a database migration.
They won&#8217;t tell you when the middleware layer is doing some clever HTML-entity
escaping that&#8217;s interfering with the way your data is rendered&#8230;&#8203;something
like Donald Rumsfeld&#8217;s unknown unknowns?</p>
</div>
</div>
<div class="sect3">
<h4 id="_mocky_tests_can_become_closely_tied_to_implementation">26.2.4. Mocky Tests Can Become Closely Tied to Implementation</h4>
<div class="paragraph">
<p>And finally, mocky tests can become very tightly coupled with the implementation.
If you choose to use <code>List.objects.create()</code> to build your objects but your
mocks are expecting you to use <code>List()</code> and <code>.save()</code>, you&#8217;ll get failing tests
even though the actual effect of the code would be the same.   If you&#8217;re not
careful, this can start to work against one of the supposed benefits of having
tests, which was to encourage refactoring.  You can find yourself having to
change dozens of mocky tests and contract tests when you want to change an
internal API.</p>
</div>
<div class="paragraph">
<p>Notice that this may be more of a problem when you&#8217;re dealing with an API
you don&#8217;t control.  You may remember the contortions we had to go through
to test our form, mocking out two Django model classes and using <code>side_effect</code>
to check on the state of the world.  If you&#8217;re writing code that&#8217;s totally
under your own control, you&#8217;re likely to design your internal APIs so that
they are cleaner and require fewer contortions to test.</p>
</div>
</div>
<div class="sect3">
<h4 id="_but_all_these_problems_can_be_overcome">26.2.5. But All These Problems Can Be Overcome</h4>
<div class="paragraph">
<p>But, isolation advocates will come back and say, all that stuff can be
mitigated; you just need to get better at writing isolated tests, and, remember
the holy flow state?  The holy flow state!</p>
</div>
<div class="paragraph">
<p>So do we have to choose one side or the other?
</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_synthesis_what_do_we_want_from_our_tests_anyway">26.3. Synthesis: What Do We Want from Our Tests, Anyway?</h3>
<div class="paragraph">
<p>Let&#8217;s
step back and have a think about what benefits we want our tests to
deliver.  Why are we writing them in the first place?</p>
</div>
<div class="sect3">
<h4 id="_correctness">26.3.1. Correctness</h4>
<div class="paragraph">
<p>We want our application to be free of bugs&#8212;&#8203;both low-level logic errors,
like off-by-one errors, and high-level bugs like the software not ultimately delivering what our users want.  We want to find out if we ever introduce
regressions which break something that used to work, and we want to find
that out before our users see something broken.  We expect our tests to
tell us our application is correct.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clean_maintainable_code">26.3.2. Clean, Maintainable Code</h4>
<div class="paragraph">
<p>We want our code to obey rules like YAGNI and DRY.  We want code that
clearly expresses its intentions, which is broken up into sensible components
that have well-defined responsibilities and are easily understood.  We expect
our tests to give us the confidence to refactor our application constantly,
so that we&#8217;re never scared to try to improve its design, and we would also
like it if they would actively help us to find the right design.</p>
</div>
</div>
<div class="sect3">
<h4 id="_productive_workflow">26.3.3. Productive Workflow</h4>
<div class="paragraph">
<p>Finally, we want our tests to help enable a fast and productive workflow.
We want them to help take some of the stress out of development, and we want
them to protect us from stupid mistakes.  We want them to help keep us
in the "flow" state not just because we enjoy it, but because it&#8217;s highly
productive.  We want our tests to give us feedback about our work as quickly
as possible, so that we can try out new ideas and evolve them quickly.  And
we don&#8217;t want to feel like our tests are more of a hindrance than a help when
it comes to evolving our codebase.</p>
</div>
</div>
<div class="sect3">
<h4 id="_evaluate_your_tests_against_the_benefits_you_want_from_them">26.3.4. Evaluate Your Tests Against the Benefits You Want from Them</h4>
<div class="paragraph">
<p>I don&#8217;t think there are any universal rules about how many tests you should
write and what the correct balance between functional, integrated, and isolated
tests should be.  Circumstances vary between projects.  But, by thinking about
all of your tests and asking whether they are delivering the benefits you want,
you can make some <span class="keep-together">decisions</span>.</p>
</div>
<table id="test-types-tradeoffs" class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. How do different types of test help us achieve our objectives?</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Objective</th>
<th class="tableblock halign-left valign-top">Some considerations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Correctness</em></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Do I have enough functional tests to reassure myself that my application 'really' works, from the point of view of the user?</p>
</li>
<li>
<p>Am I testing all the edge cases thoroughly?  This feels like a job for low-level, isolated tests.</p>
</li>
<li>
<p>Do I have tests that check whether all my components fit together properly? Could some integrated tests do this, or are functional tests enough?</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Clean, maintainable code</em></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Are my tests giving me the confidence to refactor my code, fearlessly and frequently?</p>
</li>
<li>
<p>Are my tests helping me to drive out a good design?  If I have a lot of integrated tests and few isolated tests, are there any parts of my application where putting in the effort to write more isolated tests would give me better feedback about my design?</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Productive workflow</em></p></td>
<td class="tableblock halign-left valign-top"><div><div class="ulist">
<ul>
<li>
<p>Are my feedback cycles as fast as I would like them?  When do I get warned about bugs, and is there any practical way to make that happen sooner?</p>
</li>
<li>
<p>If I have a lot of high-level, functional tests that take a long time to run, and I have to wait overnight to get feedback about accidental regressions, is there some way I could write some faster tests, integrated tests perhaps, that would get me feedback quicker?</p>
</li>
<li>
<p>Can I run a subset of the full test suite when I need to?</p>
</li>
<li>
<p>Am I spending too much time waiting for tests to run, and thus less time in a productive flow state?</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_architectural_solutions">26.4. Architectural Solutions</h3>
<div class="paragraph">
<p>There
are also some architectural solutions that can help to get the most
out of your test suite, and particularly that help avoid some of the
disadvantages of isolated tests.</p>
</div>
<div class="paragraph">
<p>Mainly these involve trying to identify the boundaries of your system&#8212;&#8203;the
points at which your code interacts with external systems, like
the database or the filesystem, or the internet, or the UI&#8212;&#8203;and trying
to keep them separate from the core business logic of your application.</p>
</div>
<div class="sect3">
<h4 id="_ports_and_adapters_hexagonal_clean_architecture">26.4.1. Ports and Adapters/Hexagonal/Clean Architecture</h4>
<div class="paragraph">
<p>Integrated tests are most useful at the <em>boundaries</em> of a system&#8212;&#8203;at
the points where our code integrates with external systems, like a
database, filesystem, or UI components.</p>
</div>
<div class="paragraph">
<p>Similarly, it&#8217;s at the boundaries that the downsides of test isolation and
mocks are at their worst, because it&#8217;s at the boundaries that you&#8217;re most
likely to be annoyed if your tests are tightly coupled to an implementation,
or to need more reassurance that things are integrated properly.</p>
</div>
<div class="paragraph">
<p>Conversely, code at the <em>core</em> of our application&#8212;&#8203;code that&#8217;s purely
concerned with our business domain and business rules, code that&#8217;s
entirely under our control&#8212;&#8203;has less need for integrated
tests, since we control and understand all of it.</p>
</div>
<div class="paragraph">
<p>So one way of getting what we want is to try to minimise the amount
of our code that has to deal with boundaries. Then we test our core business
logic with isolated tests and test our integration points with integrated
tests.</p>
</div>
<div class="paragraph">
<p>Steve Freeman and Nat Pryce, in their book <a href="#GOOSGBT"><em>Growing Object-Oriented Software, Guided by Tests</em></a>, call this approach "Ports and Adapters" (see
<a href="#ports-and-adapters">Ports and Adapters (diagram by Nat Pryce)</a>).</p>
</div>
<div class="paragraph">
<p>We actually started moving towards a ports and adapters architecture in
<a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>, when we found that writing isolated unit tests was
encouraging us to push ORM code out of the main application, and hide it
in helper functions from the model layer.</p>
</div>
<div class="paragraph">
<p>This pattern is also sometimes known as the "clean architecture" or "hexagonal
architecture".  See <a href="#ch26_furtherreading">Further Reading</a> for more info.</p>
</div>
</div>
<div class="sect3">
<h4 id="_functional_core_imperative_shell">26.4.2. Functional Core, Imperative Shell</h4>
<div class="paragraph">
<p>Gary Bernhardt pushes this further, recommending an architecture he calls
"Functional Core, Imperative Shell", whereby the "shell" of the application,
the place where interaction with boundaries happens, follows the imperative
programming paradigm, and can be tested by integrated tests, acceptance tests,
or even (gasp!) not at all, if it&#8217;s kept minimal enough. But the core of the
application is actually written following the functional programming paradigm
(complete with the "no side effects" corollary), which actually allows fully
isolated, "pure" unit tests, <em>entirely without mocks</em>.</p>
</div>
<div class="paragraph">
<p>Check out Gary&#8217;s presentation titled
<a href="https://www.youtube.com/watch?v=eOYal8elnZk">"Boundaries"</a> for more on this
approach.</p>
</div>
<div id="ports-and-adapters" class="imageblock">
<div class="content">
<img src="images/twp2_2601.png" alt="Illustration of ports and adapaters architecture, with isolated core and integration points">
</div>
<div class="title">Figure 47. Ports and Adapters (diagram by Nat Pryce)</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">26.5. Conclusion</h3>
<div class="paragraph">
<p>I&#8217;ve tried to give an overview of some of the more advanced considerations
that come into the TDD process. Mastery of these topics is something
that comes from long years of practice, and I&#8217;m not there yet, by any means. So
I heartily encourage you to take everything I&#8217;ve said with a pinch of salt, to
go out there, try various approaches, listen to what other people have to say
too, and find out what works for you.</p>
</div>
<div class="paragraph">
<p>Here
are some places to go for further reading.</p>
</div>
<div class="sect3">
<h4 id="ch26_furtherreading">26.5.1. Further Reading</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Fast Test, Slow Test and Boundaries</dt>
<dd>
<p>Gary Bernhardt&#8217;s talks from Pycon
<a href="https://www.youtube.com/watch?v=RAxiiRPHS9k">2012</a> and
<a href="https://www.youtube.com/watch?v=eOYal8elnZk">2013</a>.  His
<a href="http://www.destroyallsoftware.com">screencasts</a> are also well worth a look.</p>
</dd>
<dt class="hdlist1">Ports and Adapters</dt>
<dd>
<p>Steve Freeman and Nat Pryce wrote about this in <a href="#GOOSGBT">their book</a>.
You can also catch a good discussion in
<a href="http://vimeo.com/83960706">this talk</a>. See also
<a href="http://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">Uncle
Bob&#8217;s description of the clean architecture</a>, and
<a href="http://alistair.cockburn.us/Hexagonal+architecture">Alistair Cockburn
coining the term "hexagonal architecture"</a>.</p>
</dd>
<dt class="hdlist1">Hot Lava</dt>
<dd>
<p><a href="https://www.youtube.com/watch?v=bsmFVb8guMU">Casey Kinsey&#8217;s memorable
phrase</a> encouraging you to avoid touching the database, whenever you can.</p>
</dd>
<dt class="hdlist1">Inverting the Pyramid</dt>
<dd>
<p>The idea that projects end up with too great a ratio of slow, high-level
tests to unit tests, and a
<a href="http://watirmelon.com/tag/testing-pyramid/">visual metaphor for the effort
to invert that ratio</a>.</p>
</dd>
<dt class="hdlist1">Integrated tests are a scam</dt>
<dd>
<p>J.B. Rainsberger has a
<a href="http://blog.thecodewhisperer.com/2010/10/16/integrated-tests-are-a-scam/">famous
rant</a> about the way integrated tests will
ruin your life. Then check out a couple of
follow-up posts, particularly
<a href="http://www.jbrains.ca/permalink/using-integration-tests-mindfully-a-case-study">this
defence of acceptance tests</a> (what I call functional tests), and
<a href="http://www.jbrains.ca/permalink/part-2-some-hidden-costs-of-integration-tests">this
analysis of how slow tests kill productivity</a>.</p>
</dd>
<dt class="hdlist1">The Test-Double testing wiki</dt>
<dd>
<p>Justin Searls&#8217;s online resource is a great source of definitions and
discussions of testing pros and cons, and arrives at its own conclusions of
the right way to do things:
<a href="https://github.com/testdouble/contributing-tests/wiki/Test-Driven-Development">testing
wiki</a>.</p>
</dd>
<dt class="hdlist1">A pragmatic view</dt>
<dd>
<p>Martin Fowler (author of <em>Refactoring</em>) presents a
<a href="http://martinfowler.com/bliki/UnitTest.html">reasonably balanced, pragmatic
approach</a>.</p>
</dd>
</dl>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">On Getting the Balance Right Between Different Types of Test</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Start out by being pragmatic</dt>
<dd>
<p>Spending a long time agonising about what kinds of test to write is a great
way to prevaricate.  Better to start by writing whichever type of test
occurs to you first, and change it later if you need to. Learn by doing.</p>
</dd>
<dt class="hdlist1">Focus on what you want from your tests</dt>
<dd>
<p>Your objectives are <em>correctness</em>, <em>good design</em>, and <em>fast feedback
cycles</em>. Different types of test will help you achieve each of these
in different measures. <a href="#test-types-tradeoffs">How do different types of test help us achieve our objectives?</a> has
some good questions to ask yourself.</p>
</dd>
<dt class="hdlist1">Architecture matters</dt>
<dd>
<p>Your architecture to some extent dictates the types of tests that you need.
The more you can separate your business logic from your external
dependencies, and the more modular your code, the closer you&#8217;ll get to a
nice balance between unit tests, integration tests and end-to-end tests.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 afterword">
<h2 id="_obey_the_testing_goat">Appendix A: Obey the Testing Goat!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back to the Testing Goat.</p>
</div>
<div class="paragraph">
<p><em>Groan</em>, I hear you say, <em>Harry, the Testing Goat stopped being funny about
17 chapters ago</em>.  Bear with me, I&#8217;m going to use it to make a serious point.</p>
</div>
<div class="sect2">
<h3 id="_testing_is_hard">A.1. Testing Is Hard</h3>
<div class="paragraph">
<p>I
think the reason the phrase "Obey the Testing Goat" first grabbed me when I
saw it was that it really spoke to the fact that testing is hard&#8212;&#8203;not hard to
do in and of itself, but hard to <em>stick to</em>, and hard to keep doing.</p>
</div>
<div class="paragraph">
<p>It always feels easier to cut corners and skip a few tests.  And it&#8217;s doubly
hard psychologically because the payoff is so disconnected from the point at
which you put in the effort.  A test you spend time writing now doesn&#8217;t reward
you immediately, it only helps much later&#8212;&#8203;perhaps months later when it saves
you from introducing a bug while refactoring, or catches a regression when you
upgrade a dependency.  Or, perhaps it pays you back in a way that&#8217;s hard to
measure, by encouraging you to write better designed code, but you convince
yourself you could have written it just as elegantly without tests.</p>
</div>
<div class="paragraph">
<p>I myself started slipping when I was writing the
<a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/tree/master/tests">test
framework for this book</a>.  Being a quite complex beast, it has tests of its
own, but I cut several corners, coverage isn&#8217;t perfect, and I now regret it
because it&#8217;s turned out quite unwieldy and ugly (go on, I&#8217;ve open sourced it
now, so you can all point and laugh).</p>
</div>
<div class="sect3">
<h4 id="_keep_your_ci_builds_green">A.1.1. Keep Your CI Builds Green</h4>
<div class="paragraph">
<p>Another
area that takes real hard work is continuous integration.  You saw in
<a href="#chapter_CI">Continuous Integration (CI)</a> that strange and unpredictable bugs sometimes occur on CI.
When you&#8217;re looking at these and thinking "it works fine on my machine",
there&#8217;s a strong temptation to just ignore them&#8230;&#8203;but, if you&#8217;re not careful,
you start to tolerate a failing test suite in CI, and pretty soon your CI build
is actually useless, and it feels like too much work to get it going again.
Don&#8217;t fall into that trap.  Persist, and you&#8217;ll find the reason that your test
is failing, and you&#8217;ll find a way to lock it down and make it deterministic,
and green, again.</p>
</div>
</div>
<div class="sect3">
<h4 id="_take_pride_in_your_tests_as_you_do_in_your_code">A.1.2. Take Pride in Your Tests, as You Do in Your Code</h4>
<div class="paragraph">
<p>One of the things that helps is to stop thinking of your tests as being an
incidental add-on to the "real" code, and to start thinking of them as being
a part of the finished product that you&#8217;re building&#8212;&#8203;a part that should be
just as finely polished, just as aesthetically pleasing, and a part you can
be justly proud of delivering&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>So do it because the Testing Goat says so.  Do it because you know the payoff
will be worth it, even if it&#8217;s not immediate.  Do it out of a sense of duty,
or professionalism, or OCD, or sheer bloody-mindedness.  Do it because it&#8217;s
a good thing to practice.  And, eventually, do it because it makes software
development more fun.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_remember_to_tip_the_bar_staff">A.2. Remember to Tip the Bar Staff</h3>
<div class="paragraph">
<p>This book wouldn&#8217;t have been possible without the backing of my publisher,
the wonderful O&#8217;Reilly Media.  If you&#8217;re reading the free edition online,
I hope you&#8217;ll consider
<a href="https://shop.oreilly.com/product/0636920051091.do">buying a real copy</a>&#8230;&#8203;if you
don&#8217;t need one for yourself, then maybe as a gift for a friend?</p>
</div>
</div>
<div class="sect2">
<h3 id="_don_t_be_a_stranger">A.3. Don&#8217;t Be a Stranger!</h3>
<div class="paragraph">
<p>I hope you enjoyed the book.  Do get in touch and tell me what you thought!</p>
</div>
<div class="paragraph">
<p>Harry.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://twitter.com/hjwp">@hjwp</a></p>
</li>
<li>
<p><a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix1">Appendix B: PythonAnywhere</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This
book is based on the assumption that you&#8217;re running Python and coding
on your own computer.  Of course, that&#8217;s not the only way to code Python
these days; you could use an online platform like PythonAnywhere (which is
where I work, incidentally).</p>
</div>
<div class="paragraph">
<p>It is possible to follow along with the book on PythonAnywhere, but it does
require several tweaks and changes—you&#8217;ll need to set up a web app instead
of the test server, you&#8217;ll need to use Xvfb to run the Functional Tests, and,
once you get to the deployment chapters, you&#8217;ll need to upgrade to a paying
account.  So, it is possible, but it might be easier to follow along on your
own PC.</p>
</div>
<div class="paragraph">
<p>With that caveat, if you&#8217;re still keen to give it a try, here are some details
on what you need to do.</p>
</div>
<div class="paragraph">
<p>If you haven&#8217;t already, you&#8217;ll need to sign up for a PythonAnywhere account. A
free one should be fine.</p>
</div>
<div class="paragraph">
<p>Then, start a <em>Bash Console</em> from the consoles page.  That&#8217;s where we&#8217;ll
do most of our work.</p>
</div>
<div class="sect2">
<h3 id="_running_firefox_selenium_sessions_with_xvfb">B.1. Running Firefox Selenium Sessions with Xvfb</h3>
<div class="paragraph">
<p>The
first thing is that PythonAnywhere is a console-only environment, so it
doesn&#8217;t have a display in which to pop up Firefox.  But we can use a virtual
display.</p>
</div>
<div class="paragraph">
<p>In <a href="#chapter_01">Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a>, <a href="#first-FT">when we write our first ever test</a>, you&#8217;ll find
things don&#8217;t work as expected.  The first test looks like this, and you can
type it in using the PythonAnywhere editor just fine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver
browser = webdriver.Firefox()
browser.get('http://localhost:8000')
assert 'Django' in browser.title</code></pre>
</div>
</div>
<div class="paragraph">
<p>But when you try to run it (in a <em>Bash console</em>), you&#8217;ll get an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(virtualenv)$ <strong>python functional_tests.py</strong>
Traceback (most recent call last):
File "tests.py", line 3, in &lt;module&gt;
browser = webdriver.Firefox()
[...]
selenium.common.exceptions.WebDriverException: Message: 'geckodriver' executable
needs to be in PATH.</pre>
</div>
</div>
<div class="paragraph">
<p>Because PythonAnywhere is pinned to an older version of Firefox, we don&#8217;t
actually need Geckodriver.  But we do need to switch back to Selenium 2
instead of Selenium 3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(virtualenv) $ <strong>pip install "selenium&lt;3"</strong>
Collecting selenium&lt;3
Installing collected packages: selenium
  Found existing installation: selenium 3.4.3
    Uninstalling selenium-3.4.3:
      Successfully uninstalled selenium-3.4.3
Successfully installed selenium-2.53.6</pre>
</div>
</div>
<div class="paragraph">
<p>Now we run into a second problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(virtualenv)$ <strong>python functional_tests.py</strong>
Traceback (most recent call last):
File "tests.py", line 3, in &lt;module&gt;
browser = webdriver.Firefox()
[...]
selenium.common.exceptions.WebDriverException: Message: The browser appears to
have exited before we could connect. If you specified a log_file in the
FirefoxBinary constructor, check it for details.</pre>
</div>
</div>
<div class="paragraph">
<p>Firefox can&#8217;t start because there&#8217;s no display for it to run on, because
PythonAnywhere is a server environment. The workaround is to use <em>Xvfb</em>, which
stands for X Virtual Framebuffer. It will start up a "virtual" display, which
Firefox can use even though the server doesn&#8217;t have a real one (we use the same
tool in <a href="#chapter_CI">Continuous Integration (CI)</a> to run tests on a CI server).</p>
</div>
<div class="paragraph">
<p>The command <code>xvfb-run</code> will run the next command in Xvfb. Using that will give
us our expected failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(virtualenv)$ <strong>xvfb-run -a python functional_tests.py</strong>
Traceback (most recent call last):
File "tests.py", line 11, in &lt;module&gt;
assert 'Django' in browser.title
AssertionError</pre>
</div>
</div>
<div class="paragraph">
<p>So the lesson is to use <code>xvfb-run -a</code> whenever you need to run the functional
tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_django_as_a_pythonanywhere_web_app">B.2. Setting Up Django as a PythonAnywhere Web App</h3>
<div class="paragraph">
<p>Shortly
after that, we set up Django, using the <code>django-admin.py startproject</code>
command.  But, instead of using <code>manage.py runserver</code> to run the local
development server, we&#8217;ll set up our site as a real PythonAnywhere web app.</p>
</div>
<div class="paragraph">
<p>Go to the Web tab and hit the button to add a new web app.  Choose "Manual
configuration" and then "Python 3.6".</p>
</div>
<div class="paragraph">
<p>On the next screen, enter your virtualenv path (e.g.,
<em>/home/yourusername/superlists/virtualenv</em>).</p>
</div>
<div class="paragraph">
<p>Finally, click through to the link to <em>edit your wsgi file</em> and find and
uncomment the section for Django.  Hit Save and then Reload to refresh your web app.</p>
</div>
<div class="paragraph">
<p>From now on, instead of running the test server from a console on
<code>localhost:8000</code>, you can use the real URL of your PythonAnywhere web app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    browser.get('http://my-username.pythonanywhere.com')</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You&#8217;ll need to remember to hit Reload whenever you make changes to the
    code, to update the site.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That should work better.<sup class="footnote">[<a id="_footnoteref_40" class="footnote" href="#_footnote_40" title="View footnote.">40</a>]</sup> You&#8217;ll need to keep using this pattern of pointing the FTs at
the PythonAnywhere version of the site, and hitting Reload before each FT run,
until <a href="#chapter_working_incrementally">Working Incrementally</a>, when we switch to using <code>LiveServerTestCase</code> and
<code>self.live_&#x200b;server_url</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cleaning_up_tmp">B.3. Cleaning Up /tmp</h3>
<div class="paragraph">
<p>Selenium and Xvfb tend to leave a lot of junk lying around in <em>/tmp</em>,
especially when they&#8217;re not shut down tidily (that&#8217;s why I included
a <code>try/finally</code> earlier).</p>
</div>
<div class="paragraph">
<p>In fact they leave so much stuff lying around that they might max out
your storage quota. So do a tidy-up in <em>/tmp</em> every so often:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>rm -rf /tmp/</strong>*</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_screenshots">B.4. Screenshots</h3>
<div class="paragraph">
<p>In <a href="#chapter_post_and_database">Saving User Input: Testing the Database</a>, I suggest using a <code>time.sleep</code> to pause the FT as
it runs, so that we can see what the Selenium browser is showing on screen.  We
can&#8217;t do that on PythonAnywhere, because the browser runs in a virtual display.
Instead, you can inspect the live site, or you could "take my word for it"
regarding what you should see.</p>
</div>
<div class="paragraph">
<p>The best way of doing visual inspections of tests that run in a virtual display
is to use screenshots.  Take a look at <a href="#chapter_CI">Continuous Integration (CI)</a> if you&#8217;re
curious&#8212;&#8203;there&#8217;s some example code in there.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_deployment_chapter">B.5. The Deployment Chapter</h3>
<div class="paragraph">
<p>When you hit <a href="#chapter_manual_deployment">Testing Deployment Using a Staging Site</a>, you&#8217;ll have the choice of continuing to
use PythonAnywhere, or of learning how to build a "real" server.  I recommend
the latter, because you&#8217;ll get the most out of it.</p>
</div>
<div class="paragraph">
<p>If you really want to stick with PythonAnywhere, which is cheating really,
you could sign up for a second PythonAnywhere account and use that as your
staging site.  Or you could add a second domain to your existing account. But
most of the instructions in the chapter will be irrelevant (there&#8217;s no need for
Nginx or Gunicorn or domain sockets on PythonAnywhere).</p>
</div>
<div class="paragraph">
<p>One way or another, at this point, you&#8217;ll probably need a paying account:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you want to run your staging site on a non-PythonAnywhere domain</p>
</li>
<li>
<p>If you want to be able to run the FTs against a non-PythonAnywhere domain
(because it won&#8217;t be on our whitelist)</p>
</li>
<li>
<p>Once you get to <a href="#chapter_automate_deployment_with_fabric">Automating Deployment with Fabric</a>, if you want to run Fabric against
a PythonAnywhere account (because you need SSH)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If
you want to just "cheat", you could try running the FTs in "staging" mode
against your existing web app, and just skip the Fabric stuff, although that&#8217;s
a big cop-out if you ask me.  Hey, you can always upgrade your account and then
cancel again straight away, and claim a refund under the 30-day guarantee. ;)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If
you are using PythonAnywhere to follow through with the book, I&#8217;d love
to hear how you get on!  Do send me an email at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_Django_Class-Based_Views">Appendix C: Django Class-Based Views</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This
appendix follows on from <a href="#chapter_advanced_forms">More Advanced Forms</a>, in which we
implemented Django forms for validation and refactored our views.  By the end
of that chapter, our views were still using functions.</p>
</div>
<div class="paragraph">
<p>The new shiny in the Django world, however, is class-based views. In this
appendix, we&#8217;ll refactor our application to use them instead of view functions.
More specifically, we&#8217;ll have a go at using class-based <em>generic</em> views.</p>
</div>
<div class="sect2">
<h3 id="_class_based_generic_views">C.1. Class-Based Generic Views</h3>
<div class="paragraph">
<p>There&#8217;s
a difference between class-based views and class-based <em>generic</em> views.
Class-based views (CBVs) are just another way of defining view functions.  They make
few assumptions about what your views will do, and they offer one main
advantage over view functions, which is that they can be subclassed.  This
comes, arguably, at the expense of being less readable than traditional
function-based views.  The main use case for <em>plain</em> class-based views is when
you have several views that reuse the same logic. We want to obey the DRY
principle. With function-based views, you would use helper functions or
decorators.  The theory is that using a class structure may give you a more
elegant solution.</p>
</div>
<div class="paragraph">
<p>Class-based <em>generic</em> views (CBGVs) are class-based views that attempt to provide
ready-made solutions to common use cases:  fetching an object from the
database and passing it to a template, fetching a list of objects, saving
user input from a POST request using a <code>ModelForm</code>, and so on.  These sound very
much like our use cases, but as we&#8217;ll soon see, the devil is in the details.</p>
</div>
<div class="paragraph">
<p>I should say at this point that I&#8217;ve not used either kind of class-based views
much. I can definitely see the sense in them, and there are potentially many
use cases in Django apps where CBGVs would fit in perfectly. However, as soon
as your use case is slightly outside the basics&#8212;&#8203;as soon as you have more
than one model you want to use, for example&#8212;&#8203;I find that using class-based views
can (again, debatably) lead to code that&#8217;s much harder to read than a classic
view function.</p>
</div>
<div class="paragraph">
<p>Still, because we&#8217;re forced to use several of the customisation options for
class-based views, implementing them in this case can teach us a lot about
how they work, and how we can unit test them.</p>
</div>
<div class="paragraph">
<p>My hope is that the same unit tests we use for function-based views should
work just as well for class-based views.  Let&#8217;s see how we get on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_home_page_as_a_formview">C.2. The Home Page as a FormView</h3>
<div class="paragraph">
<p>Our
home page just displays a form on a template:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def home_page(request):
    return render(request, 'home.html', {'form': ItemForm()})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/">Looking through
the options</a>, Django has a generic view called <code>FormView</code>&mdash;let&#8217;s see how
that goes:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l001)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.views.generic import FormView
[...]

class HomePageView(FormView):
    template_name = 'home.html'
    form_class = ItemForm</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We tell it what template we want to use, and which form. Then, we
just need to update <em>urls.py</em>, replacing the line that used to say
<code>lists.views.home_page</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch31l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
urlpatterns = [
    url(r'^$', list_views.HomePageView.as_view(), name='home'),
    url(r'^lists/', include(list_urls)),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the tests all check out! That was easy&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]

Ran 34 tests in 0.119s
OK</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests</strong>
[...]
Ran 5 tests in 15.160s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>So far, so good. We&#8217;ve replaced a one-line view function with a two-line class,
but it&#8217;s still very readable. This would be a good time for a commit&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_form_valid_to_customise_a_createview">C.3. Using form_valid to Customise a CreateView</h3>
<div class="paragraph">
<p>Next
we have a crack at the view we use to create a brand new list, currently
the <code>new_list</code> function. Here&#8217;s what it looks like now:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def new_list(request):
    form = ItemForm(data=request.POST)
    if form.is_valid():
        list_ = List.objects.create()
        form.save(for_list=list_)
        return redirect(list_)
    else:
        return render(request, 'home.html', {"form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Looking through the possible CBGVs, we probably want a <code>CreateView</code>, and we
know we&#8217;re using the <code>ItemForm</code> class, so let&#8217;s see how we get on with them,
and whether the tests will help us:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.views.generic import FormView, CreateView
[...]

class NewListView(CreateView):
    form_class = ItemForm

def new_list(request):
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m going to leave the old view function in <em>views.py</em>, so that we can copy
code across from it.  We can delete it once everything is working.  It&#8217;s
harmless as soon as we switch over the URL mappings, this time in:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py (ch31l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
urlpatterns = [
    url(r'^new$', views.NewListView.as_view(), name='new_list'),
    url(r'^(\d+)/$', views.view_list, name='view_list'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now running the tests gives six errors:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]

ERROR: test_can_save_a_POST_request (lists.tests.test_views.NewListTest)
TypeError: save() missing 1 required positional argument: 'for_list'

ERROR: test_for_invalid_input_passes_form_to_template
(lists.tests.test_views.NewListTest)
django.core.exceptions.ImproperlyConfigured: TemplateResponseMixin requires
either a definition of 'template_name' or an implementation of
'get_template_names()'

ERROR: test_for_invalid_input_renders_home_template
(lists.tests.test_views.NewListTest)
django.core.exceptions.ImproperlyConfigured: TemplateResponseMixin requires
either a definition of 'template_name' or an implementation of
'get_template_names()'

ERROR: test_invalid_list_items_arent_saved (lists.tests.test_views.NewListTest)
django.core.exceptions.ImproperlyConfigured: TemplateResponseMixin requires
either a definition of 'template_name' or an implementation of
'get_template_names()'

ERROR: test_redirects_after_POST (lists.tests.test_views.NewListTest)
TypeError: save() missing 1 required positional argument: 'for_list'

ERROR: test_validation_errors_are_shown_on_home_page
(lists.tests.test_views.NewListTest)
django.core.exceptions.ImproperlyConfigured: TemplateResponseMixin requires
either a definition of 'template_name' or an implementation of
'get_template_names()'


FAILED (errors=6)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the third&#8212;&#8203;maybe we can just add the template?</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListView(CreateView):
    form_class = ItemForm
    template_name = 'home.html'</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us down to just two failures: we can see they&#8217;re both happening
in the generic view&#8217;s <code>form_valid</code> function, and that&#8217;s one of the ones that
you can override to provide custom behaviour in a CBGV.  As its name implies,
it&#8217;s run when the view has detected a valid form.  We can just copy some of
the code from our old view function, that used to live after
<code>if form.is_valid():</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListView(CreateView):
    template_name = 'home.html'
    form_class = ItemForm

    def form_valid(self, form):
        list_ = List.objects.create()
        form.save(for_list=list_)
        return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets us a full pass!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
Ran 34 tests in 0.119s
OK
$ <strong>python manage.py test functional_tests</strong>
Ran 5 tests in 15.157s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>And we <em>could</em> even save two more lines, trying to obey "DRY", by using one of
the main advantages of CBVs: inheritance!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class NewListView(CreateView, HomePageView):

    def form_valid(self, form):
        list_ = List.objects.create()
        form.save(for_list=list_)
        return redirect(list_)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And all the tests would still pass:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OK</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is not really good object-oriented practice.  Inheritance implies
    an "is-a" relationship, and it&#8217;s probably not meaningful to say that our
    new list view "is-a" home page view&#8230;&#8203;so, probably best not to do this.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With or without that last step, how does it compare to the old version? I&#8217;d say
that&#8217;s not bad.   We save some boilerplate code, and the view is still fairly
legible.  So far, I&#8217;d say we&#8217;ve got one point for CBGVs, and one draw.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_more_complex_view_to_handle_both_viewing_and_adding_to_a_list">C.4. A More Complex View to Handle Both Viewing and Adding to a List</h3>
<div class="paragraph">
<p>This
took me <em>several</em> attempts.  And I have to say that, although the tests
told me when I got it right, they didn&#8217;t really help me to figure out the
steps to get there&#8230;&#8203;mostly it was just trial and error, hacking about
in functions like <code>get_context_data</code>, <code>get_form_kwargs</code>, and so on.</p>
</div>
<div class="paragraph">
<p>One thing it did made me realise was the value of having lots of individual
tests, each testing one thing.  I went back and rewrote some of Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_making_deployment_production_ready">#chapter_making_deployment_production_ready</a>–<a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_organising_test_files">#chapter_organising_test_files</a>
as a result.</p>
</div>
<div class="sect3">
<h4 id="_the_tests_guide_us_for_a_while">C.4.1. The Tests Guide Us, for a While</h4>
<div class="paragraph">
<p>Here&#8217;s how things might go.  Start by thinking we want a <code>DetailView</code>,
something that shows you the detail of an object:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch31l008">
<div class="title">lists/views.py (ch31l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.views.generic import FormView, CreateView, DetailView
[...]

class ViewAndAddToList(DetailView):
    model = List</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And wiring it up in <em>urls.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py (ch31l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    url(r'^(\d+)/$', views.ViewAndAddToList.as_view(), name='view_list'),</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
AttributeError: Generic detail view ViewAndAddToList must be called with either
an object pk or a slug.


FAILED (failures=5, errors=6)</pre>
</div>
</div>
<div class="paragraph">
<p>Not totally obvious, but a bit of Googling around led me to understand that
I needed to use a "named" regex capture group:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/urls.py (ch31l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -3,6 +3,6 @@ from lists import views

 urlpatterns = [
     url(r'^new$', views.NewListView.as_view(), name='new_list'),
-    url(r'^(\d+)/$', views.view_list, name='view_list'),
+    url(r'^(?P&lt;pk&gt;\d+)/$', views.ViewAndAddToList.as_view(), name='view_list')
 ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The next set of errors had one that was fairly helpful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
django.template.exceptions.TemplateDoesNotExist: lists/list_detail.html

FAILED (failures=5, errors=6)</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s easily solved:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ViewAndAddToList(DetailView):
    model = List
    template_name = 'list.html'</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That takes us down five and two:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
ERROR: test_displays_item_form (lists.tests.test_views.ListViewTest)
KeyError: 'form'

FAILED (failures=5, errors=2)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_until_we_re_left_with_trial_and_error">C.4.2. Until We&#8217;re Left with Trial and Error</h4>
<div class="paragraph">
<p>So I figured, our view doesn&#8217;t just show us the detail of an object,
it also allows us to create new ones.  Let&#8217;s make it both a
<code>DetailView</code> <em>and</em> a <code>CreateView</code>, and maybe add the <code>form_class</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ViewAndAddToList(DetailView, CreateView):
    model = List
    template_name = 'list.html'
    form_class = ExistingListItemForm</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But that gives us a lot of errors saying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[...]
TypeError: __init__() missing 1 required positional argument: 'for_list'</pre>
</div>
</div>
<div class="paragraph">
<p>And the <code>KeyError: 'form'</code> was still there too!</p>
</div>
<div class="paragraph">
<p>At this point the errors stopped being quite as helpful, and it was no longer
obvious what to do next.  I had to resort to trial and error.  Still, the
tests did at least tell me when I was getting things more right or more wrong.</p>
</div>
<div class="paragraph">
<p>My first attempts to use <code>get_form_kwargs</code> didn&#8217;t really work, but I found
that I could use <code>get_form</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/views.py (ch31l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def get_form(self):
        self.object = self.get_object()
        return self.form_class(for_list=self.object, data=self.request.POST)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But it would only work if I also assigned to <code>self.object</code>, as a side effect,
along the way, which was a bit upsetting.  Still, that takes us down
to just three errors, but we&#8217;re still apparently not quite there!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.core.exceptions.ImproperlyConfigured: No URL to redirect to.  Either
provide a url or define a get_absolute_url method on the Model.</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_back_on_track">C.4.3. Back on Track</h4>
<div class="paragraph">
<p>And for this final failure, the tests are being helpful again.
It&#8217;s quite easy to define a <code>get_absolute_url</code> on the <code>Item</code> class, such
that items point to their parent list&#8217;s page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/models.py (ch31l015)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class Item(models.Model):
    [...]

    def get_absolute_url(self):
        return reverse('view_list', args=[self.list.id])</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_is_that_your_final_answer">C.4.4. Is That Your Final Answer?</h4>
<div class="paragraph">
<p>We
end up with a view class that looks like this:</p>
</div>
<div class="exampleblock sourcecode currentcontens">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ViewAndAddToList(DetailView, CreateView):
    model = List
    template_name = 'list.html'
    form_class = ExistingListItemForm

    def get_form(self):
        self.object = self.get_object()
        return self.form_class(for_list=self.object, data=self.request.POST)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compare_old_and_new">C.5. Compare Old and New</h3>
<div class="paragraph">
<p>Let&#8217;s
see the old version for comparison?</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">lists/views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def view_list(request, list_id):
    list_ = List.objects.get(id=list_id)
    form = ExistingListItemForm(for_list=list_)
    if request.method == 'POST':
        form = ExistingListItemForm(for_list=list_, data=request.POST)
        if form.is_valid():
            form.save()
            return redirect(list_)
    return render(request, 'list.html', {'list': list_, "form": form})</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Well, it has reduced the number of lines of code from nine to seven.  Still, I find
the function-based version a little easier to understand, in that it has a
little bit less magic&mdash;"explicit is better than implicit", as the Zen of
Python would have it. I mean&#8230;&#8203;<span class="keep-together"><code>SingleObjectMixin</code></span>?  What?  And, more
offensively, the whole thing falls apart if we don&#8217;t assign to <code>self.object</code>
inside <code>get_form</code>?  Yuck.</p>
</div>
<div class="paragraph">
<p>Still, I guess some of it is in the eye of the beholder.</p>
</div>
</div>
<div class="sect2">
<h3 id="_best_practices_for_unit_testing_cbgvs">C.6. Best Practices for Unit Testing CBGVs?</h3>
<div class="paragraph">
<p>As
I was working through this, I felt like my "unit" tests were sometimes a
little too high-level.  This is no surprise, since tests for views that involve
the Django Test Client are probably more properly called integrated tests.</p>
</div>
<div class="paragraph">
<p>They told me whether I was getting things right or wrong, but they didn&#8217;t
always offer enough clues on exactly how to fix things.</p>
</div>
<div class="paragraph">
<p>I occasionally wondered whether there might be some mileage in a test that
was closer to the implementation&#8212;&#8203;something like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_cbv_gets_correct_object(self):
    our_list = List.objects.create()
    view = ViewAndAddToList()
    view.kwargs = dict(pk=our_list.id)
    self.assertEqual(view.get_object(), our_list)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But the problem is that it requires a lot of knowledge of the internals of
Django CBVs to be able to do the right test setup for these kinds of tests.
And you still end up getting very confused by the complex inheritance
hierarchy.</p>
</div>
<div class="sect3">
<h4 id="_take_home_having_multiple_isolated_view_tests_with_single_assertions_helps">C.6.1. Take-Home: Having Multiple, Isolated View Tests with Single Assertions Helps</h4>
<div class="paragraph">
<p>One thing I definitely did conclude from this appendix was that having many
short unit tests for views was much more helpful than having a few tests with
a narrative series of assertions.</p>
</div>
<div class="paragraph">
<p>Consider this monolithic test:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_validation_errors_sent_back_to_home_page_template(self):
    response = self.client.post('/lists/new', data={'text': ''})
    self.assertEqual(List.objects.all().count(), 0)
    self.assertEqual(Item.objects.all().count(), 0)
    self.assertTemplateUsed(response, 'home.html')
    expected_error = escape("You can't have an empty list item")
    self.assertContains(response, expected_error)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That is definitely less useful than having three individual tests, like this:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">lists/tests/test_views.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_invalid_input_means_nothing_saved_to_db(self):
        self.post_invalid_input()
        self.assertEqual(List.objects.all().count(), 0)
        self.assertEqual(Item.objects.all().count(), 0)

    def test_invalid_input_renders_list_template(self):
        response = self.post_invalid_input()
        self.assertTemplateUsed(response, 'list.html')

    def test_invalid_input_renders_form_with_errors(self):
        response = self.post_invalid_input()
        self.assertIsinstance(response.context['form'], ExistingListItemForm)
        self.assertContains(response, escape(empty_list_error))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The reason is that, in the first case, an early failure means not all the
assertions are checked.  So, if the view was accidentally saving to the
database on invalid POST, you would get an early fail, and so you wouldn&#8217;t
find out whether it was using the right template or rendering the form.  The
second formulation makes it much easier to pick out exactly what was or wasn&#8217;t
working.</p>
</div>
<div class="sidebarblock pagebreak-before">
<div class="content">
<div class="title">Lessons Learned from CBGVs</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Class-based generic views can do anything</dt>
<dd>
<p>It might not always be clear what&#8217;s going on, but you can do just about
anything with class-based generic views.</p>
</dd>
<dt class="hdlist1">Single-assertion unit tests help refactoring</dt>
<dd>
<p>    With
each unit test providing individual guidance on what works and what
    doesn&#8217;t, it&#8217;s much easier to change the implementation of our views to
    using this fundamentally different paradigm.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix3">Appendix D: Provisioning with Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We
used Fabric to automate deploying new versions of the source code to our
servers.  But provisioning a fresh server, and updating the Nginx and Gunicorn
config files, was all left as a manual process.</p>
</div>
<div class="paragraph">
<p>This is the kind of job that&#8217;s increasingly given to tools called
"Configuration Management" or "Continuous Deployment" tools.  Chef and Puppet
were the first popular ones, and in the Python world there&#8217;s Salt and Ansible.</p>
</div>
<div class="paragraph">
<p>Of all of these, Ansible is the easiest to get started with.  We
can get it working with just two files:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>pip2 install --user ansible  # Python 2 sadly</pre>
</div>
</div>
<div class="paragraph">
<p>An "inventory file" at <em>deploy_tools/inventory.ansible</em> defines what servers we
can run against:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/inventory.ansible</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="ini">[live]
superlists.ottg.eu ansible_become=yes ansible_ssh_user=elspeth

[staging]
superlists-staging.ottg.eu ansible_become=yes ansible_ssh_user=elspeth

[local]
localhost ansible_ssh_user=root ansible_ssh_port=6666 ansible_host=127.0.0.1</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(The local entry is just an example, in my case a Virtualbox VM, with port
forwarding for ports 22 and 80 set up.)</p>
</div>
<div class="sect2">
<h3 id="_installing_system_packages_and_nginx">D.1. Installing System Packages and Nginx</h3>
<div class="paragraph">
<p>Next the Ansible "playbook", which defines what to do on the server.  This
uses a syntax called YAML:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/provision.ansible.yaml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">---

- hosts: all

  vars:
      host: "{{ inventory_hostname }}"

  tasks:

    - name: Deadsnakes PPA to get Python 3.6
      apt_repository:
        repo='ppa:deadsnakes/ppa'
    - name: make sure required packages are installed
      apt: pkg=nginx,git,python3.6,python3.6-venv state=present

    - name: allow long hostnames in nginx
      lineinfile:
        dest=/etc/nginx/nginx.conf
        regexp='(\s+)#? ?server_names_hash_bucket_size'
        backrefs=yes
        line='\1server_names_hash_bucket_size 64;'

    - name: add nginx config to sites-available
      template: src=./nginx.conf.j2 dest=/etc/nginx/sites-available/{{ host }}
      notify:
          - restart nginx

    - name: add symlink in nginx sites-enabled
      file:
          src=/etc/nginx/sites-available/{{ host }}
          dest=/etc/nginx/sites-enabled/{{ host }}
          state=link
      notify:
          - restart nginx</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>inventory_hostname</code> variable is the domain name of the server we&#8217;re running against.
I&#8217;m using the <code>vars</code> section to rename it to "host", just for convenience.</p>
</div>
<div class="paragraph">
<p>In this section, we install our required software using <code>apt</code>, tweak the Nginx
config to allow long hostnames using a regular expression replacer, and then write the Nginx config file using a template.  This is a modified version
of the template file we saved into <em>deploy_tools/nginx.template.conf</em> in
<a href="#chapter_manual_deployment">Testing Deployment Using a Staging Site</a>, but it now uses a specific templating syntax&#8212;&#8203;Jinja2, which is
actually a lot like the Django template syntax:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/nginx.conf.j2</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>server {
    listen 80;
    server_name {{ host }};

    location /static {
        alias /home/{{ ansible_ssh_user }}/sites/{{ host }}/static;
    }

    location / {
        proxy_set_header Host {{ host }};
        proxy_pass http://unix:/tmp/{{ host }}.socket;
    }
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_gunicorn_and_using_handlers_to_restart_services">D.2. Configuring Gunicorn, and Using Handlers to Restart Services</h3>
<div class="paragraph">
<p>Here&#8217;s the second half of our playbook:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/provision.ansible.yaml</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml">    - name: write gunicorn service script
      template:
          src=./gunicorn.service.j2
          dest=/etc/systemd/system/gunicorn-{{ host }}.service
      notify:
          - restart gunicorn

  handlers:
    - name: restart nginx
      service:  name=nginx state=restarted

    - name: restart gunicorn
      systemd:
          name=gunicorn-{{ host }}
          daemon_reload=yes
          enabled=yes
          state=restarted</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once again we use a template for our Gunicorn config:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">deploy_tools/gunicorn.service.j2</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[Unit]
Description=Gunicorn server for {{ host }}

[Service]
User={{ ansible_ssh_user }}
WorkingDirectory=/home/{{ ansible_ssh_user }}/sites/{{ host }}
EnvironmentFile=/home/{{ ansible_ssh_user }}/sites/{{ host }}/.env
Restart=on-failure
ExecStart=/home/{{ ansible_ssh_user }}/sites/{{ host }}/virtualenv/bin/gunicorn \
    --bind unix:/tmp/{{ host }}.socket \
    --access-logfile ../access.log \
    --error-logfile ../error.log \
    superlists.wsgi:application

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we have two "handlers" to restart Nginx and Gunicorn.  Ansible is
clever, so if it sees multiple steps all call the same handlers, it
waits until the last one before calling it.</p>
</div>
<div class="paragraph">
<p>And that&#8217;s it!  The command to kick all these off is:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>ansible-playbook -i inventory.ansible provision.ansible.yaml --limit=staging --ask-become-pass</pre>
</div>
</div>
<div class="paragraph">
<p>Lots more info in the <a href="https://docs.ansible.com/">Ansible docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_to_do_next">D.3. What to Do Next</h3>
<div class="paragraph">
<p>I&#8217;ve just given a little taster of what&#8217;s possible with Ansible.  But the more
you automate about your deployments, the more confidence you will have in
them.  Here are a few more things to look into.</p>
</div>
<div class="sect3">
<h4 id="_move_deployment_out_of_fabric_and_into_ansible">D.3.1. Move Deployment out of Fabric and into Ansible</h4>
<div class="paragraph">
<p>We&#8217;ve
seen that Ansible can help with some aspects of provisioning, but it can
also do pretty much all of our deployment for us.  See if you can extend the
playbook to do everything that we currently do in our Fabric deploy script,
including notifying the restarts as required.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_vagrant_to_spin_up_a_local_vm">D.3.2. Use Vagrant to Spin Up a Local VM</h4>
<div class="paragraph">
<p>Running tests against the staging site gives us the ultimate confidence that
things are going to work when we go live, but we can also use a VM on our
local machine.</p>
</div>
<div class="paragraph">
<p>Download Vagrant and Virtualbox, and see if you can get Vagrant to build a
dev server on your own PC, using our Ansible playbook to deploy code to it.
Rewire the FT runner to be able to test against the local VM.</p>
</div>
<div class="paragraph">
<p>Having a Vagrant config file is particularly helpful when working
in a team&#8212;&#8203;it helps new developers to spin up servers that look exactly
like yours.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-migrations-appendix">Appendix E: Testing Database Migrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Django-migrations and its predecessor South have been around for ages,
so it&#8217;s not usually necessary to test database migrations.  But it just
so happens that we&#8217;re introducing a dangerous type of migration&#8212;&#8203;that is, one
that introduces a new integrity constraint on our data.  When I first ran
the migration script against staging, I saw an error.</p>
</div>
<div class="paragraph">
<p>On larger projects, where you have sensitive data, you may want the additional
confidence that comes from testing your migrations in a safe environment
before applying them to production data, so this toy example will hopefully
be a useful rehearsal.</p>
</div>
<div class="paragraph">
<p>Another common reason to want to test migrations is for speed&#8212;&#8203;migrations
often involve downtime, and sometimes, when they&#8217;re applied to very large
datasets, they can take time.  It&#8217;s good to know in advance how long that
might be.</p>
</div>
<div class="sect2">
<h3 id="_an_attempted_deploy_to_staging">E.1. An Attempted Deploy to Staging</h3>
<div class="paragraph">
<p>Here&#8217;s what happened to me when I first tried to deploy our new validation
constraints in <a href="#chapter_deploying_validation">Deploying Our New Code</a>:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy:host=elspeth@superlists-staging.ottg.eu</strong>
[...]
Running migrations:
  Applying lists.0005_list_item_unique_together...Traceback (most recent call
last):
  File "/usr/local/lib/python3.6/dist-packages/django/db/backends/utils.py",
line 61, in execute
    return self.cursor.execute(sql, params)
  File
"/usr/local/lib/python3.6/dist-packages/django/db/backends/sqlite3/base.py",
line 475, in execute
    return Database.Cursor.execute(self, query, params)
sqlite3.IntegrityError: columns list_id, text are not unique
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>What happened was that some of the existing data in the database violated
the integrity constraint, so the database was complaining when I tried to
apply it.</p>
</div>
<div class="paragraph">
<p>In order to deal with this sort of problem, we&#8217;ll need to build a "data
migration".  Let&#8217;s first set up a local environment to test against.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_a_test_migration_locally">E.2. Running a Test Migration Locally</h3>
<div class="paragraph">
<p>We&#8217;ll use a copy of the live database to test our migration against.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Be very, very, very careful when using real data for testing.  For
    example, you may have real customer email addresses in there, and you don&#8217;t
    want to accidentally send them a bunch of test emails.  Ask me how I know
    this.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_entering_problematic_data">E.2.1. Entering Problematic Data</h4>
<div class="paragraph">
<p>Start a list with some duplicate items on your live site, as shown in
<a href="#dupe-data">A list with duplicate items</a>.</p>
</div>
<div id="dupe-data" class="imageblock">
<div class="content">
<img src="images/twp2_ad01.png" alt="This list has 3 identical items">
</div>
<div class="title">Figure 48. A list with duplicate items</div>
</div>
</div>
<div class="sect3">
<h4 id="_copying_test_data_from_the_live_site">E.2.2. Copying Test Data from the Live Site</h4>
<div class="paragraph">
<p>Copy the database down from live:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>scp elspeth@superlists.ottg.eu:\
/home/elspeth/sites/superlists.ottg.eu/database/db.sqlite3 .</strong>
$ <strong>mv ../database/db.sqlite3 ../database/db.sqlite3.bak</strong>
$ <strong>mv db.sqlite3 ../database/db.sqlite3</strong></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_confirming_the_error">E.2.3. Confirming the Error</h4>
<div class="paragraph">
<p>We now have a local database that has not been migrated, and that contains
some problematic data.  We should see an error if we try to run <code>migrate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py migrate --migrate</strong>
python manage.py migrate
Operations to perform:
[...]
Running migrations:
[...]
  Applying lists.0005_list_item_unique_together...Traceback (most recent call
last):
[...]
    return Database.Cursor.execute(self, query, params)
sqlite3.IntegrityError: columns list_id, text are not unique</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inserting_a_data_migration">E.3. Inserting a Data Migration</h3>
<div class="paragraph">
<p><a href="https://docs.djangoproject.com/en/1.11/topics/migrations/#data-migrations">Data
migrations</a> are a special type of migration that modifies data in the database
rather than changing the schema.  We need to create one that will run before
we apply the integrity constraint, to preventively remove any duplicates.
Here&#8217;s how we can do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>git rm lists/migrations/0005_list_item_unique_together.py</strong>
$ <strong>python manage.py makemigrations lists --empty</strong>
Migrations for 'lists':
  0005_auto_20140414_2325.py:
$ <strong>mv lists/migrations/0005_*.py lists/migrations/0005_remove_duplicates.py</strong></pre>
</div>
</div>
<div class="paragraph">
<p>Check out <a href="https://docs.djangoproject.com/en/1.11/topics/migrations/#data-migrations">the
Django docs on data migrations</a> for more info, but here&#8217;s how we add some
instructions to change existing data:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/migrations/0005_remove_duplicates.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"># encoding: utf8
from django.db import models, migrations

def find_dupes(apps, schema_editor):
    List = apps.get_model("lists", "List")
    for list_ in List.objects.all():
        items = list_.item_set.all()
        texts = set()
        for ix, item in enumerate(items):
            if item.text in texts:
                item.text = '{} ({})'.format(item.text, ix)
                item.save()
            texts.add(item.text)


class Migration(migrations.Migration):

    dependencies = [
        ('lists', '0004_item_list'),
    ]

    operations = [
        migrations.RunPython(find_dupes),
    ]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_re_creating_the_old_migration">E.3.1. Re-creating the Old Migration</h4>
<div class="paragraph">
<p>We re-create the old migration using <code>makemigrations</code>, which will ensure it
is now the sixth migration and has an explicit dependency on <code>0005</code>, the
data migration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py makemigrations</strong>
Migrations for 'lists':
  0006_auto_20140415_0018.py:
    - Alter unique_together for item (1 constraints)
$ <strong>mv lists/migrations/0006_* lists/migrations/0006_unique_together.py</strong></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_new_migrations_together">E.4. Testing the New Migrations Together</h3>
<div class="paragraph">
<p>We&#8217;re now ready to run our test against the live data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>cd deploy_tools</strong>
$ <strong>fab deploy:host=elspeth@superlists-staging.ottg.eu</strong>
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll need to restart the live Gunicorn job too:</p>
</div>
<div class="listingblock server-commands skipme">
<div class="content">
<pre>elspeth@server:$ <strong>sudo systemctl restart gunicorn-superlists.ottg.eu</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we can now run our FTs against staging:</p>
</div>
<div class="listingblock skipme small-code">
<div class="content">
<pre>$ <strong>STAGING_SERVER=superlists-staging.ottg.eu python manage.py test functional_tests</strong>
[...]
....
 ---------------------------------------------------------------------
Ran 4 tests in 17.308s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>Everything seems in order!  Let&#8217;s do it against live:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>$ <strong>fab deploy --host=superlists.ottg.eu</strong>
[superlists.ottg.eu] Executing task 'deploy'
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s a wrap.  <code>git add lists/migrations</code>, <code>git commit</code>, and so on.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusions">E.5. Conclusions</h3>
<div class="paragraph">
<p>This exercise was primarily aimed at building a data migration and testing it
against some real data.  Inevitably, this is only a drop in the ocean of the
possible testing you could do for a migration.  You could imagine building
automated tests to check that all your data was preserved, comparing the
database contents before and after.  You could write individual unit tests
for the helper functions in a data migration.  You could spend more time
measuring the time taken for migrations, and experiment with ways to speed
it up by, for example, breaking up migrations into more or fewer component steps.</p>
</div>
<div class="paragraph">
<p>Remember that this should be a relatively rare case. In my experience, I
haven&#8217;t felt the need to test 99% of the migrations I&#8217;ve worked on.  But,
should you ever feel the need on your project, I hope you&#8217;ve found a few
pointers here to get started with.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">On Testing Database Migrations</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Be wary of migrations which introduce constraints</dt>
<dd>
<p>99% of migrations happen without a hitch, but be wary of any situations,
like this one, where you are introducing a new constraint on columns that
already exist.</p>
</dd>
<dt class="hdlist1">Test migrations for speed</dt>
<dd>
<p>Once you have a larger project, you should think about testing how long
your migrations are going to take. Database migrations typically involve
downtime, as, depending on your database, the schema update operation may
lock the table it&#8217;s working on until it completes.  It&#8217;s a good idea to use
your staging site to find out how long a migration will take.</p>
</dd>
<dt class="hdlist1">Be extremely careful if using a dump of production data</dt>
<dd>
<p>In order to do so, you&#8217;ll want fill your staging site&#8217;s database with an
amount of data that&#8217;s commensurate to the size of your production data.
Explaining how to do that is outside of the scope of this book, but I will
say this:  if you&#8217;re tempted to just take a dump of your production
database and load it into staging, be <em>very</em> careful.  Production data
contains real customer details, and I&#8217;ve personally been responsible for
accidentally sending out a few hundred incorrect invoices after an
automated process on my staging server started processing the copied
production data I&#8217;d just loaded into it. Not a fun afternoon.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_bdd">Appendix F: Behaviour-Driven Development (BDD)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now I haven&#8217;t used BDD "in anger," so I can&#8217;t claim any sort of expertise, but I
really like what I have seen of it, and I thought that you deserved at least a
whirlwind tour.  In this appendix, we&#8217;ll take some of the tests we wrote in a
"normal" FT, and convert them to using BDD tools.</p>
</div>
<div class="sect2">
<h3 id="_what_is_bdd">F.1. What Is BDD?</h3>
<div class="paragraph">
<p>BDD, <em>strictly</em> speaking, is a methodology rather than a toolset&#8212;&#8203;it&#8217;s the
approach of testing your application by testing the behaviour that we expect it
to display to a user (the
<a href="https://en.wikipedia.org/wiki/Behavior-driven_development">Wikipedia entry</a>
has quite a good overview). So, in some ways, the Selenium-based FTs that I&#8217;ve
shown in the rest of the book <em>could</em> be called BDD.</p>
</div>
<div class="paragraph">
<p>But
the term has become closely associated with a particular set of tools for
doing BDD, most importantly the
<a href="https://github.com/cucumber/cucumber/wiki/Gherkin">Gherkin syntax</a>, which is a
human-readable DSL for writing functional (or acceptance) tests. Gherkin
originally came out of the Ruby world, where it&#8217;s associated with a test runner
called <a href="http://cukes.info/">Cucumber</a>.</p>
</div>
<div class="paragraph">
<p>In
the Python world, we have a couple of equivalent test running tools,
<a href="http://lettuce.it/">Lettuce</a> and <a href="http://pythonhosted.org/behave/">Behave</a>.
Of these, only Behave was compatible with Python 3 at the time of writing, so
that&#8217;s what we&#8217;ll use. We&#8217;ll also use a plugin called
<a href="https://pythonhosted.org/behave-django/">behave-django</a>.</p>
</div>
<div class="sidebarblock pagebreak-before">
<div class="content">
<div class="title">Getting the Code for These Examples</div>
<div class="paragraph">
<p>I&#8217;m
going to use the example from <a href="#chapter_outside_in">Finishing "My Lists": Outside-In TDD</a>.
We have a basic to-do lists site, and we want to add a new feature:
logged-in users should be able to view the lists they&#8217;ve authored in one place.
Up until this point, all lists are effectively anonymous.</p>
</div>
<div class="paragraph">
<p>If you&#8217;ve been following along with the book, I&#8217;m going to assume you can skip
back to the code for that point.  If you want to pull it from my repo, the
place to go is the
<a href="https://github.com/hjwp/book-example/tree/chapter_17">chapter_17 branch</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_housekeeping">F.2. Basic Housekeeping</h3>
<div class="paragraph">
<p>We
make a directory for our BDD "features," add a <em>steps</em> directory (we&#8217;ll find
out what these are shortly!), and placeholder for our first feature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>mkdir -p features/steps</strong>
$ <strong>touch features/my_lists.feature</strong>
$ <strong>touch features/steps/my_lists.py</strong>
$ <strong>tree features</strong>
features
├── my_lists.feature
└── steps
    └── my_lists.py</pre>
</div>
</div>
<div class="paragraph">
<p>We install <code>behave-django</code>, and add it to <em>settings.py</em>:</p>
</div>
<div class="listingblock dofirst-ch35l000">
<div class="content">
<pre>$ <strong>pip install behave-django</strong></pre>
</div>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">--- a/superlists/settings.py
+++ b/superlists/settings.py
@@ -40,6 +40,7 @@ INSTALLED_APPS = [
     'lists',
     'accounts',
     'functional_tests',
+    'behave_django',
 ]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And then run <code>python manage.py behave</code> as a sanity check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py behave</strong>
Creating test database for alias 'default'...
0 features passed, 0 failed, 0 skipped
0 scenarios passed, 0 failed, 0 skipped
0 steps passed, 0 failed, 0 skipped, 0 undefined
Took 0m0.000s
Destroying test database for alias 'default'...</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_an_ft_as_a_feature_using_gherkin_syntax">F.3. Writing an FT as a "Feature" Using Gherkin Syntax</h3>
<div class="paragraph">
<p>Up
until now, we&#8217;ve been writing our FTs using human-readable comments
that describe the new feature in terms of a user story, interspersed
with the Selenium code required to execute each step in the story.</p>
</div>
<div class="paragraph">
<p>BDD enforces a distinction between those two&#8212;&#8203;we write our human-readable
story using a human-readable (if occasionally somewhat awkward) syntax
called "Gherkin", and that is called the "Feature".  Later, we&#8217;ll map
each line of Gherkin to a function that contains the Selenium code necessary
to implement that "step."</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what a Feature for our new "My lists" page could look like:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">features/my_lists.feature</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="gherkin">Feature: My Lists
    As a logged-in user
    I want to be able to see all my lists in one page
    So that I can find them all after I've written them

    Scenario: Create two lists and see them on the My Lists page

        Given I am a logged-in user

        When I create a list with first item "Reticulate Splines"
            And I add an item "Immanentize Eschaton"
            And I create a list with first item "Buy milk"

        Then I will see a link to "My lists"

        When I click the link to "My lists"
        Then I will see a link to "Reticulate Splines"
        And I will see a link to "Buy milk"

        When I click the link to "Reticulate Splines"
        Then I will be on the "Reticulate Splines" list page</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_as_a_i_want_to_so_that">F.3.1. As-a /I want to/So that</h4>
<div class="paragraph">
<p>At the top you&#8217;ll notice the As-a/I want to/So that clause.  This is
optional, and it has no executable counterpart&#8212;&#8203;it&#8217;s just a slightly
formalised way of capturing the "who and why?" aspects of a user story,
gently encouraging the team to think about the justifications for each
feature.</p>
</div>
</div>
<div class="sect3">
<h4 id="_given_when_then">F.3.2. Given/When/Then</h4>
<div class="paragraph">
<p>Given/When/Then is the real core of a BDD test.  This trilobite formulation
matches the setup/exercise/assert pattern we&#8217;ve seen in our unit tests, and
it represents the setup and assumptions phase, an exercise/action phase, and
a subsequent assertion/observation phase.  There&#8217;s more info on the
<a href="https://github.com/cucumber/cucumber/wiki/Given-When-Then">Cucumber wiki</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_not_always_a_perfect_fit">F.3.3. Not Always a Perfect Fit!</h4>
<div class="paragraph">
<p>As you can see, it&#8217;s not always easy to shoe-horn a user story into exactly
three steps!  We can use the <code>And</code> clause to expand on a step, and I&#8217;ve
added multiple <code>When</code> steps and subsequent <code>Then</code>'s to illustrate further
aspects of our "My lists" page.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coding_the_step_functions">F.4. Coding the Step Functions</h3>
<div class="paragraph">
<p>We
now build the counterpart to our Gherkin-syntax feature, which are the
"step" functions that will actually implement them in code.</p>
</div>
<div class="sect3 pagebreak-before">
<h4 id="_generating_placeholder_steps">F.4.1. Generating Placeholder Steps</h4>
<div class="paragraph">
<p>When we run <code>behave</code>, it helpfully tells us about all the steps we need to
implement:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>python manage.py behave</strong>
Feature: My Lists # features/my_lists.feature:1
  As a logged-in user
  I want to be able to see all my lists in one page
  So that I can find them all after I've written them
  Scenario: Create two lists and see them on the My Lists page  #
features/my_lists.feature:6
    Given I am a logged-in user                                 # None
    Given I am a logged-in user                                 # None
    When I create a list with first item "Reticulate Splines"   # None
    And I add an item "Immanentize Eschaton"                    # None
    And I create a list with first item "Buy milk"              # None
    Then I will see a link to "My lists"                        # None
    When I click the link to "My lists"                         # None
    Then I will see a link to "Reticulate Splines"              # None
    And I will see a link to "Buy milk"                         # None
    When I click the link to "Reticulate Splines"               # None
    Then I will be on the "Reticulate Splines" list page        # None


Failing scenarios:
  features/my_lists.feature:6  Create two lists and see them on the My Lists
page


0 features passed, 1 failed, 0 skipped
0 scenarios passed, 1 failed, 0 skipped
0 steps passed, 0 failed, 0 skipped, 10 undefined
Took 0m0.000s

You can implement step definitions for undefined steps with these snippets:

@given(u'I am a logged-in user')
def step_impl(context):
    raise NotImplementedError(u'STEP: Given I am a logged-in user')

@when(u'I create a list with first item "Reticulate Splines"')
def step_impl(context):
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>And you&#8217;ll notice all this output is nicely coloured, as shown in
<a href="#behave-output">Behave with coloured console ouptut</a>.</p>
</div>
<div id="behave-output" class="imageblock">
<div class="content">
<img src="images/twp2_ae01.png" alt="Colourful console output">
</div>
<div class="title">Figure 49. Behave with coloured console ouptut</div>
</div>
<div class="paragraph">
<p>It&#8217;s encouraging us to copy and paste these snippets, and use them as
starting points to build our steps.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_first_step_definition">F.5. First Step Definition</h3>
<div class="paragraph">
<p>Here&#8217;s a first stab at making a step for our "Given I am a logged-in user"
step. I started by stealing the code for <code>self.create_pre_authenticated_session</code>
from <em>functional_tests/test_my_lists.py</em>, and adapting it slightly (removing
the server-side version, for example, although it would be easy to re-add
later).</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">features/steps/my_lists.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from behave import given, when, then
from functional_tests.management.commands.create_session import \
    create_pre_authenticated_session
from django.conf import settings


@given('I am a logged-in user')
def given_i_am_logged_in(context):
    session_key = create_pre_authenticated_session(email='edith@example.com')
    ## to set a cookie we need to first visit the domain.
    ## 404 pages load the quickest!
    context.browser.get(context.get_url("/404_no_such_url/"))
    context.browser.add_cookie(dict(
        name=settings.SESSION_COOKIE_NAME,
        value=session_key,
        path='/',
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <em>context</em> variable needs a little explaining—it&#8217;s a sort of global
variable, in the sense that it&#8217;s passed to each step that&#8217;s executed, and it
can be used to store information that we need to share between steps. Here
we&#8217;ve assumed we&#8217;ll be storing a browser object on it, and the <code>server_url</code>.
We end up using it a lot like we used <code>self</code> when we were writing <code>unittest</code>
FTs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_and_teardown_equivalents_in_environment_py">F.6. setUp and tearDown Equivalents in environment.py</h3>
<div class="paragraph">
<p>Steps can make changes to state in the <code>context</code>, but the place to do
preliminary set-up, the equivalent of <code>setUp</code>, is in a file called
<em>environment.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">features/environment.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium import webdriver

def before_all(context):
    context.browser = webdriver.Firefox()

def after_all(context):
    context.browser.quit()

def before_feature(context, feature):
    pass</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_another_run">F.7. Another Run</h3>
<div class="paragraph">
<p>As a sanity check, we can do another run, to see if the new step works and
that we really can start a browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py behave</strong>
[...]
1 step passed, 0 failed, 0 skipped, 9 undefined</pre>
</div>
</div>
<div class="paragraph">
<p>The usual reams of output, but we can see that it seems to have made it through
the first step; let&#8217;s define the rest of them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_capturing_parameters_in_steps">F.8. Capturing Parameters in Steps</h3>
<div class="paragraph">
<p>We&#8217;ll
see how Behave allows you to capture parameters from step descriptions.
Our next step says:</p>
</div>
<div class="exampleblock sourcecode currentcontents">
<div class="title">features/my_lists.feature</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="gherkin">    When I create a list with first item "Reticulate Splines"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the autogenerated step definition looked like this:</p>
</div>
<div class="exampleblock sourcecode small-code skipme">
<div class="title">features/steps/my_lists.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@given('I create a list with first item "Reticulate Splines"')
def step_impl(context):
    raise NotImplementedError(
        u'STEP: When I create a list with first item "Reticulate Splines"'
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We want to be able to create lists with arbitrary first items, so it would be
nice to somehow capture whatever is between those quotes, and pass them in as
an argument to a more generic function.  That&#8217;s a common requirement in BDD,
and Behave has a nice syntax for it, reminiscent of the new-style Python string
formatting syntax:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">features/steps/my_lists.py (ch35l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]

@when('I create a list with first item "{first_item_text}"')
def create_a_list(context, first_item_text):
    context.browser.get(context.get_url('/'))
    context.browser.find_element_by_id('id_text').send_keys(first_item_text)
    context.browser.find_element_by_id('id_text').send_keys(Keys.ENTER)
    wait_for_list_item(context, first_item_text)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Neat, huh?</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Capturing parameters for steps is one of the most powerful features
    of the BDD syntax.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As usual with Selenium tests, we will need an explicit wait.  Let&#8217;s re-use
our <code>@wait</code> decorator from <em>base.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">features/steps/my_lists.py (ch35l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from functional_tests.base import wait
[...]


@wait
def wait_for_list_item(context, item_text):
    context.test.assertIn(
        item_text,
        context.browser.find_element_by_css_selector('#id_list_table').text
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Similarly, we can add to an existing list, and see or click on links:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">features/steps/my_lists.py (ch35l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from selenium.webdriver.common.keys import Keys
[...]


@when('I add an item "{item_text}"')
def add_an_item(context, item_text):
    context.browser.find_element_by_id('id_text').send_keys(item_text)
    context.browser.find_element_by_id('id_text').send_keys(Keys.ENTER)
    wait_for_list_item(context, item_text)


@then('I will see a link to "{link_text}"')
@wait
def see_a_link(context, link_text):
    context.browser.find_element_by_link_text(link_text)


@when('I click the link to "{link_text}"')
def click_link(context, link_text):
    context.browser.find_element_by_link_text(link_text).click()</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice we can even use our <code>@wait</code> decorator on steps themselves.</p>
</div>
<div class="paragraph">
<p>And finally the slightly more complex step that says I am on the
page for a particular list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">features/steps/my_lists.py (ch35l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@then('I will be on the "{first_item_text}" list page')
@wait
def on_list_page(context, first_item_text):
    first_row = context.browser.find_element_by_css_selector(
        '#id_list_table tr:first-child'
    )
    expected_row_text = '1: ' + first_item_text
    context.test.assertEqual(first_row.text, expected_row_text)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph pagebreak-before">
<p>Now we can run it and see our first expected failure:</p>
</div>
<div class="listingblock small-code">
<div class="content">
<pre>$ <strong>python manage.py behave</strong>

Feature: My Lists # features/my_lists.feature:1
  As a logged-in user
  I want to be able to see all my lists in one page
  So that I can find them all after I've written them
  Scenario: Create two lists and see them on the My Lists page  #
features/my_lists.feature:6
    Given I am a logged-in user                                 #
features/steps/my_lists.py:19
    When I create a list with first item "Reticulate Splines"   #
features/steps/my_lists.py:31
    And I add an item "Immanentize Eschaton"                    #
features/steps/my_lists.py:39
    And I create a list with first item "Buy milk"              #
features/steps/my_lists.py:31
    Then I will see a link to "My lists"                        #
functional_tests/base.py:12
      Traceback (most recent call last):
[...]
        File "features/steps/my_lists.py", line 49, in see_a_link
          context.browser.find_element_by_link_text(link_text)
[...]
      selenium.common.exceptions.NoSuchElementException: Message: Unable to
locate element: My lists

[...]

Failing scenarios:
  features/my_lists.feature:6  Create two lists and see them on the My Lists
page

0 features passed, 1 failed, 0 skipped
0 scenarios passed, 1 failed, 0 skipped
4 steps passed, 1 failed, 5 skipped, 0 undefined</pre>
</div>
</div>
<div class="paragraph">
<p>You can see how the output really gives you a sense of how far through the
"story" of the test we got: we manage to create our two lists successfully, but
the "My lists" link does not appear.</p>
</div>
</div>
<div class="sect2">
<h3 id="_comparing_the_inline_style_ft">F.9. Comparing the Inline-Style FT</h3>
<div class="paragraph">
<p>I&#8217;m
not going to run through the implementation of the feature, but you can
see how the test will drive development just as well as the inline-style FT
would have.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at it, for comparison:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">functional_tests/test_my_lists.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def test_logged_in_users_lists_are_saved_as_my_lists(self):
    # Edith is a logged-in user
    self.create_pre_authenticated_session('edith@example.com')

    # She goes to the home page and starts a list
    self.browser.get(self.live_server_url)
    self.add_list_item('Reticulate splines')
    self.add_list_item('Immanentize eschaton')
    first_list_url = self.browser.current_url

    # She notices a "My lists" link, for the first time.
    self.browser.find_element_by_link_text('My lists').click()

    # She sees that her list is in there, named according to its
    # first list item
    self.wait_for(
        lambda: self.browser.find_element_by_link_text('Reticulate splines')
    )
    self.browser.find_element_by_link_text('Reticulate splines').click()
    self.wait_for(
        lambda: self.assertEqual(self.browser.current_url, first_list_url)
    )

    # She decides to start another list, just to see
    self.browser.get(self.live_server_url)
    self.add_list_item('Click cows')
    second_list_url = self.browser.current_url

    # Under "my lists", her new list appears
    self.browser.find_element_by_link_text('My lists').click()
    self.wait_for(
        lambda: self.browser.find_element_by_link_text('Click cows')
    )
    self.browser.find_element_by_link_text('Click cows').click()
    self.wait_for(
        lambda: self.assertEqual(self.browser.current_url, second_list_url)
    )

    # She logs out.  The "My lists" option disappears
    self.browser.find_element_by_link_text('Log out').click()
    self.wait_for(lambda: self.assertEqual(
        self.browser.find_elements_by_link_text('My lists'),
        []
    ))</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s not entirely an apples-to-apples comparison, but we can look at the
number of lines of code in <a href="#table-code-compare">Lines of code comparison</a>.</p>
</div>
<table id="table-code-compare" class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Lines of code comparison</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">BDD</th>
<th class="tableblock halign-left valign-top">Standard FT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Feature file: 20 (3 optional)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">test function body: 45</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steps file: 56 lines</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">helper functions: 23</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The comparison isn&#8217;t perfect, but you might say that the feature file and the
body of a "standard FT" test function are equivalent in that they present the
main "story" of a test, while the steps and helper functions represent the
"hidden" implementation details.  If you add them up, the total numbers are
pretty similar, but notice that they&#8217;re spread out differently: the BDD tests
have made the story more concise, and pushed more work out into the hidden
implementation details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bdd_encourages_structured_test_code">F.10. BDD Encourages Structured Test Code</h3>
<div class="paragraph">
<p>This
is the real appeal, for me: the BDD tool has <em>forced</em> us to structure our
test code.  In the inline-style FT, we&#8217;re free to use as many lines as we want
to implement a step, as described by its comment line.  It&#8217;s very hard to
resist the urge to just copy-and-paste code from elsewhere, or just from
earlier on in the test.   You can see that, by this point in the book, I&#8217;ve
built just a couple of helper functions (like <code>get_item_input_box</code>).</p>
</div>
<div class="paragraph">
<p>In contrast, the BDD syntax has immediately forced me to have a separate
function for each step, so I&#8217;ve already built some very reusable code to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start a new list</p>
</li>
<li>
<p>Add an item to an existing list</p>
</li>
<li>
<p>Click on a link with particular text</p>
</li>
<li>
<p>Assert that I&#8217;m looking at a particular list&#8217;s page</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>BDD really encourages you to write test code that seems to match well with
the business domain, and to use a layer of abstraction between the story of
your FT and its implementation in code.</p>
</div>
<div class="paragraph">
<p>The ultimate expression of this is that, theoretically, if you wanted to
change programming languages, you could keep all your features in Gherkin
syntax exactly as they are, and throw away the Python steps and replace them
with steps implemented in another language.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_page_pattern_as_an_alternative">F.11. The Page Pattern as an Alternative</h3>
<div class="paragraph">
<p>In
<a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a> of the book, I present an example of the "Page
pattern", which is an object-oriented approach to structuring your Selenium
tests.  Here&#8217;s a reminder of what it looks like:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">functional_tests/test_sharing.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from .my_lists_page import MyListsPage
[...]

class SharingTest(FunctionalTest):

    def test_can_share_a_list_with_another_user(self):
        # [...]
        self.browser.get(self.live_server_url)
        list_page = ListPage(self).add_list_item('Get help')

        # She notices a "Share this list" option
        share_box = list_page.get_share_box()
        self.assertEqual(
            share_box.get_attribute('placeholder'),
            'your-friend@example.com'
        )

        # She shares her list.
        # The page updates to say that it's shared with Oniciferous:
        list_page.share_list_with('oniciferous@example.com')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the <code>Page</code> class looks like this:</p>
</div>
<div class="exampleblock sourcecode small-code skipme">
<div class="title">functional_tests/lists_pages.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListPage(object):

    def __init__(self, test):
        self.test = test


    def get_table_rows(self):
        return self.test.browser.find_elements_by_css_selector('#id_list_table tr')


    @wait
    def wait_for_row_in_list_table(self, item_text, item_number):
        row_text = '{}: {}'.format(item_number, item_text)
        rows = self.get_table_rows()
        self.test.assertIn(row_text, [row.text for row in rows])


    def get_item_input_box(self):
        return self.test.browser.find_element_by_id('id_text')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So it&#8217;s definitely possible to implement a similar layer of abstraction,
and a sort of DSL, in inline-style FTs, whether it&#8217;s by using the Page
pattern or whatever structure you prefer&#8212;&#8203;but now it&#8217;s a matter of
self-discipline, rather than having a framework that pushes you towards
it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In fact, you can actually use the Page pattern with BDD as well, as
    a resource for your steps to use when navigating the pages of your site.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_bdd_might_be_less_expressive_than_inline_comments">F.12. BDD Might Be Less Expressive than Inline Comments</h3>
<div class="paragraph">
<p>On
the other hand, I can also see potential for the Gherkin syntax to
feel somewhat restrictive.  Compare how expressive and readable the
inline-style comments are, with the slightly awkward BDD feature:</p>
</div>
<div class="exampleblock sourcecode skipme">
<div class="title">functional_tests/test_my_lists.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    # Edith is a logged-in user
    # She goes to the home page and starts a list
    # She notices a "My lists" link, for the first time.
    # She sees that her list is in there, named according to its
    # first list item
    # She decides to start another list, just to see
    # Under "my lists", her new list appears
    # She logs out.  The "My lists" option disappears
[...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s much more readable and natural than our slightly forced Given/Then/When
incantations, and, in a way, might encourage more user-centric thinking. (There
is a syntax in Gherkin for including "comments" in a feature file, which would
mitigate this somewhat, but I gather that it&#8217;s not widely used.)</p>
</div>
</div>
<div class="sect2">
<h3 id="_will_nonprogrammers_write_tests">F.13. Will Nonprogrammers Write Tests?</h3>
<div class="paragraph">
<p>I
haven&#8217;t touched on one of the original promises of BDD, which is that
nonprogrammers&#8212;&#8203;business or client representatives perhaps&#8212;&#8203;might actually
write the Gherkin syntax.  I&#8217;m quite skeptical about whether this would
actually work in the real world, but I don&#8217;t think that detracts from the other
potential benefits of BDD.</p>
</div>
</div>
<div class="sect2">
<h3 id="_some_tentative_conclusions">F.14. Some Tentative Conclusions</h3>
<div class="paragraph">
<p>I&#8217;ve only dipped my toes into the BDD world, so I&#8217;m hesitant to draw any firm
conclusions. I find the "forced" structuring of FTs into steps very appealing
though&#8212;&#8203;in that it looks like it has the potential to encourage a lot of reuse in your
FT code, and that it neatly separates concerns between describing the story
and implementing it, and that it forces us to think about things in terms of
the business domain, rather than in terms of "what we need to do with
Selenium."</p>
</div>
<div class="paragraph">
<p>But there&#8217;s no free lunch. The Gherkin syntax is restrictive, compared to
the total freedom offered by inline FT comments.</p>
</div>
<div class="paragraph">
<p>I also would like to see how BDD scales once you have not just one or two
features, and four or five steps, but several dozen features and hundreds of
lines of steps code.</p>
</div>
<div class="paragraph">
<p>Overall, I would say it&#8217;s definitely worth investigating, and I will probably
use BDD for my next personal project.</p>
</div>
<div class="paragraph">
<p>My thanks to Daniel Pope, Rachel Willmer, and Jared Contrascere for their
feedback on this chapter.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">BDD Conclusions</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Encourages structured, reusable test code</dt>
<dd>
<p>By separating concerns, breaking your FTs out into the human-readable,
Gherkin syntax "feature" file and a separate implementation of steps
functions, BDD has the potential to encourage more reusable and manageable
test code.</p>
</dd>
<dt class="hdlist1">It may come at the expense of readability</dt>
<dd>
<p>The Gherkin syntax, for all its attempt to be human-readable, is ultimately
a constraint on human language, and so it may not capture nuance and
intention as well as inline comments do.</p>
</dd>
<dt class="hdlist1">Try it! I will</dt>
<dd>
<p>As I keep saying, I haven&#8217;t used BDD on a real project, so you should take
my words with a heavy pinch of salt, but I&#8217;d like to give it a hearty
endorsement.  I&#8217;m going to try it out on the next project I can, and I&#8217;d
encourage you to do so as well.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_rest_api">Appendix G: Building a REST API: JSON, Ajax, and Mocking with JavaScript</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Representational
State Transfer (REST) is an approach to designing a web
service to allow a user to retrieve and update information about "resources". It&#8217;s
become the dominant approach when designing APIs for use over the web.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve built a working web app without needing an API so far.  Why might we want
one?  One motivation might be to improve the user experience by making the site
more dynamic.  Rather than waiting for the page to refresh after each addition
to a list, we can use JavaScript to fire off those requests asynchronously to our
API, and give the user a more interactive feeling.</p>
</div>
<div class="paragraph">
<p>Perhaps more interestingly, once we&#8217;ve built an API, we can interact with our
back-end application via other mechanisms than the browser.  A mobile app might
be one new candidate client application, another might be some sort of
command-line application, or other developers might be able to build libraries
and tools around your backend.</p>
</div>
<div class="paragraph">
<p>In this chapter we&#8217;ll see how to build an API "by hand".  In the next, I&#8217;ll
give an overview of how to use a popular tool from the Django ecosystem called
Django-Rest-Framework.</p>
</div>
<div class="sect2">
<h3 id="_our_approach_for_this_appendix">G.1. Our Approach for This Appendix</h3>
<div class="paragraph">
<p>I won&#8217;t convert the entirety of the app for now; we&#8217;ll start by assuming we
have an existing list.  REST defines a relationship between URLs and the
HTTP methods (GET and POST, but also the more funky ones like PUT and DELETE)
which will guide us in our design.</p>
</div>
<div class="paragraph">
<p><a href="http://bit.ly/2u6qeYw">The
Wikipedia entry on REST</a>
has a good overview.  In brief:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Our new URL structure will be <em>/api/lists/{id}/</em></p>
</li>
<li>
<p>GET will give you details of a list (including all its items) in JSON format</p>
</li>
<li>
<p>POST lets you add an item</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;ll take the code from its state at the end of <a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_choosing_our_test_approach">G.2. Choosing Our Test Approach</h3>
<div class="paragraph">
<p>If we were
building an API that was entirely agnostic about its clients, we might
want to think about what levels to test it at.  The equivalent of functional
tests would perhaps spin up a real server (maybe using <code>LiveServerTestCase</code>)
and interact with it using the <code>requests</code> library. We&#8217;d have to think carefully
about how to set up fixtures (if we use the API itself, that introduces a lot
of dependencies between tests) and what additional layer of lower-level/unit
tests might be most useful to us.  Or we might decide that a single layer of
tests using the Django Test Client would be enough.</p>
</div>
<div class="paragraph">
<p>As it is, we&#8217;re building an API in the context of a browser-based client side.
We want to start using it on our production site, and have the app continue to
provide the same functionality as it did before.  So our functional tests will
continue to serve the role of being the highest-level tests, and of checking
the integration between our JavaScript and our API.</p>
</div>
<div class="paragraph">
<p>That leaves the Django Test Client as a natural place to site our lower-level
tests.  Let&#8217;s start there.</p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_piping">G.3. Basic Piping</h3>
<div class="paragraph">
<p>We start with a unit test that just checks that our new URL structure returns
a 200 response to GET requests, and that it uses the JSON format (instead of HTML):</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import json
from django.test import TestCase

from lists.models import List, Item


class ListAPITest(TestCase):
    base_url = '/api/lists/{}/'  <i class="conum" data-value="1"></i><b>(1)</b>

    def test_get_returns_json_200(self):
        list_ = List.objects.create()
        response = self.client.get(self.base_url.format(list_.id))
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response['content-type'], 'application/json')</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using a class-level constant for the URL under test is a new pattern we&#8217;ll
introduce for this appendix. It&#8217;ll help us to remove duplication of
hardcoded URLs.  You could even use a call to <code>reverse</code> to reduce
duplication even further.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we wire up a couple of <em>urls</em> files:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import include, url
from accounts import urls as accounts_urls
from lists import views as list_views
from lists import api_urls
from lists import urls as list_urls

urlpatterns = [
    url(r'^$', list_views.home_page, name='home'),
    url(r'^lists/', include(list_urls)),
    url(r'^accounts/', include(accounts_urls)),
    url(r'^api/', include(api_urls)),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>and:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api_urls.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.conf.urls import url
from lists import api

urlpatterns = [
    url(r'^lists/(\d+)/$', api.list, name='api_list'),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the actual core of our API can live in a file called <em>api.py</em>.  Just
three lines should be enough:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from django.http import HttpResponse

def list(request, list_id):
    return HttpResponse(content_type='application/json')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The tests should pass, and we have the basic piping together:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
..................................................
 ---------------------------------------------------------------------
Ran 50 tests in 0.177s

OK</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_actually_responding_with_something">G.4. Actually Responding with Something</h3>
<div class="paragraph">
<p>Our next step is to get our API to actually respond with some content&#8212;&#8203;specifically, a JSON representation of our list items:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch36l002)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_get_returns_items_for_correct_list(self):
        other_list = List.objects.create()
        Item.objects.create(list=other_list, text='item 1')
        our_list = List.objects.create()
        item1 = Item.objects.create(list=our_list, text='item 1')
        item2 = Item.objects.create(list=our_list, text='item 2')
        response = self.client.get(self.base_url.format(our_list.id))
        self.assertEqual(
            json.loads(response.content.decode('utf8')),  <i class="conum" data-value="1"></i><b>(1)</b>
            [
                {'id': item1.id, 'text': item1.text},
                {'id': item2.id, 'text': item2.text},
            ]
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the main thing to notice about this test. We expect our
response to be in JSON format; we use <code>json.loads()</code> because testing
Python objects is easier than messing about with raw JSON strings.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the implementation, conversely, uses <code>json.dumps()</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">import json
from django.http import HttpResponse
from lists.models import List, Item


def list(request, list_id):
    list_ = List.objects.get(id=list_id)
    item_dicts = [
        {'id': item.id, 'text': item.text}
        for item in list_.item_set.all()
    ]
    return HttpResponse(
        json.dumps(item_dicts),
        content_type='application/json'
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A nice opportunity to use a list comprehension!</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_post">G.5. Adding POST</h3>
<div class="paragraph">
<p>The second thing we need from our API is the ability to add new items
to our list by using a POST request. We&#8217;ll start with the "happy path":</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch36l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">    def test_POSTing_a_new_item(self):
        list_ = List.objects.create()
        response = self.client.post(
            self.base_url.format(list_.id),
            {'text': 'new item'},
        )
        self.assertEqual(response.status_code, 201)
        new_item = list_.item_set.get()
        self.assertEqual(new_item.text, 'new item')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the implementation is similarly simple&#8212;&#8203;basically the same as what we do
in our normal view, but we return a 201 rather than a redirect:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py (ch36l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def list(request, list_id):
    list_ = List.objects.get(id=list_id)
    if request.method == 'POST':
        Item.objects.create(list=list_, text=request.POST['text'])
        return HttpResponse(status=201)
    item_dicts = [
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that should get us started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]

Ran 52 tests in 0.177s

OK</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of the fun things about building a REST API is that you get
    to use a few more of the full range of
    <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP status codes</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_client_side_ajax_with_sinon_js">G.6. Testing the Client-Side Ajax with Sinon.js</h3>
<div class="paragraph">
<p>Don&#8217;t even <em>think</em> of doing Ajax testing without a mocking library.  Different
test frameworks and tools have their own; <em>Sinon</em> is generic.  It also provides
JavaScript mocks, as we&#8217;ll see&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Start by downloading it from its site, <a href="http://sinonjs.org/" class="bare">http://sinonjs.org/</a>, and putting it into
our <em>lists/static/tests/</em> folder.</p>
</div>
<div class="paragraph">
<p>Then we can write our first Ajax test:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l006">
<div class="title">lists/static/tests/tests.html (ch36l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;div id="qunit-fixture"&gt;
    &lt;form&gt;
      &lt;input name="text" /&gt;
      &lt;div class="has-error"&gt;Error text&lt;/div&gt;
    &lt;/form&gt;
    &lt;table id="id_list_table"&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
    &lt;/table&gt;
  &lt;/div&gt;

  &lt;script src="../jquery-3.1.1.min.js"&gt;&lt;/script&gt;
  &lt;script src="../list.js"&gt;&lt;/script&gt;
  &lt;script src="qunit-2.0.1.js"&gt;&lt;/script&gt;
  &lt;script src="sinon-1.17.6.js"&gt;&lt;/script&gt;  <i class="conum" data-value="2"></i><b>(2)</b>

  &lt;script&gt;
/* global sinon */

var server;
QUnit.testStart(function () {
  server = sinon.fakeServer.create();  <i class="conum" data-value="3"></i><b>(3)</b>
});
QUnit.testDone(function () {
  server.restore();  <i class="conum" data-value="3"></i><b>(3)</b>
});

QUnit.test("errors should be hidden on keypress", function (assert) {
[...]


QUnit.test("should get items by ajax on initialize", function (assert) {
  var url = '/getitems/';
  window.Superlists.initialize(url);

  assert.equal(server.requests.length, 1); <i class="conum" data-value="4"></i><b>(4)</b>
  var request = server.requests[0];
  assert.equal(request.url, url);
  assert.equal(request.method, 'GET');
});

  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add a new item to the fixture <code>div</code> to represent our list table.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We import <em>sinon.js</em> (you&#8217;ll need to download it and put it in the
right folder).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>testStart</code> and <code>testDone</code> are the QUnit equivalents of <code>setUp</code> and
<code>tearDown</code>.  We use them to tell Sinon to start up its Ajax testing
tool, the <code>fakeServer</code>, and make it available via a globally scoped
variable called <code>server</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>That lets us make assertions about any Ajax requests that were made
by our code.  In this case, we test what URL the request went to,
and what HTTP method it used.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To actually make our Ajax request, we&#8217;ll use the
<a href="https://api.jquery.com/jQuery.get/">jQuery Ajax helpers</a>, which are <em>much</em>
easier than trying to use the low-level browser standard <code>XMLHttpRequest</code> objects:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -1,6 +1,10 @@
 window.Superlists = {};
-window.Superlists.initialize = function () {
+window.Superlists.initialize = function (url) {
   $('input[name="text"]').on('keypress', function () {
     $('.has-error').hide();
   });
+
+  $.get(url);
+
 };
+</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That should get our test passing:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>5 assertions of 5 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should get items by ajax on initialize (3)</pre>
</div>
</div>
<div class="paragraph">
<p>Well, we might be pinging out a GET request to the server, but what about
actually <em>doing</em> something?  How do we test the actual "async" part, where we
deal with the (eventual) response?</p>
</div>
<div class="sect3">
<h4 id="_sinon_and_testing_the_asynchronous_part_of_ajax">G.6.1. Sinon and Testing the Asynchronous Part of Ajax</h4>
<div class="paragraph">
<p>This is a major reason to love Sinon.  <code>server.respond()</code> allows us to exactly
control the flow of the asynchronous code.</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test("should fill in lists table from ajax response", function (assert) {
  var url = '/getitems/';
  var responseData = [
    {'id': 101, 'text': 'item 1 text'},
    {'id': 102, 'text': 'item 2 text'},
  ];
  server.respondWith('GET', url, [
    200, {"Content-Type": "application/json"}, JSON.stringify(responseData) <i class="conum" data-value="1"></i><b>(1)</b>
  ]);
  window.Superlists.initialize(url); <i class="conum" data-value="2"></i><b>(2)</b>

  server.respond(); <i class="conum" data-value="3"></i><b>(3)</b>

  var rows = $('#id_list_table tr');  <i class="conum" data-value="4"></i><b>(4)</b>
  assert.equal(rows.length, 2);
  var row1 = $('#id_list_table tr:first-child td');
  assert.equal(row1.text(), '1: item 1 text');
  var row2 = $('#id_list_table tr:last-child td');
  assert.equal(row2.text(), '2: item 2 text');
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We set up some response data for Sinon to use, telling it what status code, headers,
and importantly what kind of response JSON we want to simulate coming from the
server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we call the function under test.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here&#8217;s the magic.  <em>Then</em> we can call <code>server.respond()</code>, whenever we like, and that
will kick off all the async part of the Ajax loop—that is, any callback we&#8217;ve assigned
to deal with the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Now we can quietly check whether our Ajax callback has actually populated our table
with the new list rows&#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The implementation might look something like this:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js (ch36l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">  if (url) {
    $.get(url).done(function (response) {  <i class="conum" data-value="1"></i><b>(1)</b>
      var rows = '';
      for (var i=0; i&lt;response.length; i++) {  <i class="conum" data-value="2"></i><b>(2)</b>
        var item = response[i];
        rows += '\n&lt;tr&gt;&lt;td&gt;' + (i+1) + ': ' + item.text + '&lt;/td&gt;&lt;/tr&gt;';
      }
      $('#id_list_table').html(rows);
    });
  }</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We&#8217;re lucky because of the way jQuery registers its callbacks for Ajax when we use
    the <code>.done()</code> function.  If you want to switch to the more standard JavaScript Promise
    <code>.then()</code> callback, we get one more "level" of async.  QUnit does have a
    way of dealing with that.  Check out the docs for the
    <a href="http://api.qunitjs.com/async/">async</a> function.
    Other test frameworks have something similar.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wiring_it_all_up_in_the_template_to_see_if_it_really_works">G.7. Wiring It All Up in the Template to See If It Really Works</h3>
<div class="paragraph">
<p>We break it first, by removing the list table <code>{% for %}</code> loop from the
<em>lists.html</em> <span class="keep-together">template</span>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -6,9 +6,6 @@

 {% block table %}
   &lt;table id="id_list_table" class="table"&gt;
-    {% for item in list.item_set.all %}
-      &lt;tr&gt;&lt;td&gt;{{ forloop.counter }}: {{ item.text }}&lt;/td&gt;&lt;/tr&gt;
-    {% endfor %}
   &lt;/table&gt;

   {% if list.owner %}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will cause one of the unit tests to fail.  It&#8217;s OK to delete that
    test at this point.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Graceful Degradation and Progressive Enhancement</div>
<div class="paragraph">
<p>By removing the non-Ajax version of the lists page, I&#8217;ve removed the option of
<a href="https://www.w3.org/wiki/Graceful_degradation_versus_progressive_enhancement">graceful
degradation</a>—that is, keeping a version of the site that will still work without
<span class="keep-together">JavaScript</span>.</p>
</div>
<div class="paragraph">
<p>This used to be an accessibility issue: "screen reader" browsers for visually
impaired people used not to have JavaScript, so relying entirely on JS would
exclude those users.  That&#8217;s not so much of an issue any more, as I understand
it.  But some users will block JavaScript for security reasons.</p>
</div>
<div class="paragraph">
<p>Another common problem is differing levels of JavaScript support in different
browsers.  This is a particular issue if you start adventuring off in the
direction of "modern" frontend development and ES2015.</p>
</div>
<div class="paragraph pagebreak-before">
<p>In short, it&#8217;s always nice to have a non-JavaScript "backup".  Particularly
if you&#8217;ve built a site that works fine without it, don&#8217;t throw away your
working "plain old" HTML version too hastily. I&#8217;m just doing it because it&#8217;s
convenient for what I want to <span class="keep-together">demonstrate</span>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>That causes our basic FT to fail:</p>
</div>
<div class="listingblock dofirst-ch36l015">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
FAIL: test_can_start_a_list_for_one_user
[...]
  File "...python-tdd-book/functional_tests/test_simple_list_creation.py", line
32, in test_can_start_a_list_for_one_user
    self.wait_for_row_in_list_table('1: Buy peacock feathers')
[...]
AssertionError: '1: Buy peacock feathers' not found in []
[...]
FAIL: test_multiple_users_can_start_lists_at_different_urls

FAILED (failures=2)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add a block called <code>{% scripts %}</code> to the base template, which we
can selectively override later in our lists page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">    &lt;script src="/static/list.js"&gt;&lt;/script&gt;

    {% block scripts %}
      &lt;script&gt;
$(document).ready(function () {
  window.Superlists.initialize();
});
      &lt;/script&gt;
    {% endblock scripts %}

  &lt;/body&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now in <em>list.html</em> we add a slightly different call to <code>initialize</code>, with
the correct URL:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch36l016)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">{% block scripts %}
  &lt;script&gt;
$(document).ready(function () {
  var url = "{% url 'api_list' list.id %}";
  window.Superlists.initialize(url);
});
  &lt;/script&gt;
{% endblock scripts %}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And guess what? The test passes!</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
Ran 2 test in 11.730s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s a pretty good start!</p>
</div>
<div class="paragraph">
<p>Now if you run all the FTs you&#8217;ll see we&#8217;ve got some failures in
other FTs, so we&#8217;ll have to deal with them. Also, we&#8217;re using an old-fashioned
POST from the form, with page refresh, so we&#8217;re not at our trendy hipster
single-page app yet.  But we&#8217;ll get there!</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_ajax_post_including_the_csrf_token">G.8. Implementing Ajax POST, Including the CSRF Token</h3>
<div class="paragraph">
<p>First we give our list form an <code>id</code> so we can pick it up easily in our JS:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/templates/base.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
  {% block list_form %}
    &lt;form id="id_item_form" method="POST" action="{% block form_action %}{% endblock %}"&gt;
      {{ form.text }}
      [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next tweak the fixture in our JS test to reflect that ID, as well as the
CSRF token that&#8217;s currently on the page:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -9,9 +9,14 @@
 &lt;body&gt;
   &lt;div id="qunit"&gt;&lt;/div&gt;
   &lt;div id="qunit-fixture"&gt;
-    &lt;form&gt;
+    &lt;form id="id_item_form"&gt;
       &lt;input name="text" /&gt;
-      &lt;div class="has-error"&gt;Error text&lt;/div&gt;
+      &lt;input type="hidden" name="csrfmiddlewaretoken" value="tokey" /&gt;
+      &lt;div class="has-error"&gt;
+        &lt;div class="help-block"&gt;
+          Error text
+        &lt;/div&gt;
+      &lt;/div&gt;
     &lt;/form&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s our test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l019)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">QUnit.test("should intercept form submit and do ajax post", function (assert) {
  var url = '/listitemsapi/';
  window.Superlists.initialize(url);

  $('#id_item_form input[name="text"]').val('user input');  <i class="conum" data-value="1"></i><b>(1)</b>
  $('#id_item_form input[name="csrfmiddlewaretoken"]').val('tokeney');  <i class="conum" data-value="1"></i><b>(1)</b>
  $('#id_item_form').submit();  <i class="conum" data-value="1"></i><b>(1)</b>

  assert.equal(server.requests.length, 2);  <i class="conum" data-value="2"></i><b>(2)</b>
  var request = server.requests[1];
  assert.equal(request.url, url);
  assert.equal(request.method, "POST");
  assert.equal(
    request.requestBody,
    'text=user+input&amp;csrfmiddlewaretoken=tokeney'  <i class="conum" data-value="3"></i><b>(3)</b>
  );
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We simulate the user filling in the form and hitting Submit.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We now expect that there should be a second Ajax request (the
first one is the GET for the list items table).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We check our POST <code>requestBody</code>.  As you can see, it&#8217;s
URL-encoded, which isn&#8217;t the most easy value to test, but it&#8217;s still just
about readable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And here&#8217;s how we implement it:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">[...]
  $('#id_list_table').html(rows);
});

var form = $('#id_item_form');
form.on('submit', function(event) {
  event.preventDefault();
  $.post(url, {
    'text': form.find('input[name="text"]').val(),
    'csrfmiddlewaretoken': form.find('input[name="csrfmiddlewaretoken"]').val(),
  });
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That gets our JS tests passing but it breaks our FTs, because, although we&#8217;re
doing our POST all right, we&#8217;re not updating the page after the POST to show
the new list item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mocking_in_javascript">G.9. Mocking in JavaScript</h3>
<div class="paragraph">
<p>We want our client side to update the table of items after the Ajax POST
completes. Essentially it&#8217;ll do the same work as we do as soon as the page
loads, retrieving the current list of items from the server, and filling in the
item table.</p>
</div>
<div class="paragraph">
<p>Sounds like a helper function is in order!</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">window.Superlists = {};

window.Superlists.updateItems = function (url) {
  $.get(url).done(function (response) {
    var rows = '';
    for (var i=0; i&lt;response.length; i++) {
      var item = response[i];
      rows += '\n&lt;tr&gt;&lt;td&gt;' + (i+1) + ': ' + item.text + '&lt;/td&gt;&lt;/tr&gt;';
    }
    $('#id_list_table').html(rows);
  });
};

window.Superlists.initialize = function (url) {
  $('input[name="text"]').on('keypress', function () {
    $('.has-error').hide();
  });

  if (url) {
    window.Superlists.updateItems(url);

    var form = $('#id_item_form');
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That was just a refactor; now we check that the JS tests all still pass:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>12 assertions of 12 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should get items by ajax on initialize (3)
4. should fill in lists table from ajax response (3)
5. should intercept form submit and do ajax post (4)</pre>
</div>
</div>
<div class="paragraph">
<p>Now how to test that our Ajax POST calls <code>updateItems</code> on POST success?  We
don&#8217;t want to dumbly duplicate the code that simulates a server response
and checks the items table manually&#8230;&#8203;how about a mock?</p>
</div>
<div class="paragraph">
<p>First we set up a thing called a "sandbox".  It will keep track of all
the mocks we create, and make sure to un-monkeypatch all the things that
have been mocked after each test:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l023)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">var server, sandbox;
QUnit.testStart(function () {
  server = sinon.fakeServer.create();
  sandbox = sinon.sandbox.create();
});
QUnit.testDone(function () {
  server.restore();
  sandbox.restore(); <i class="conum" data-value="1"></i><b>(1)</b>
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This <code>.restore()</code> is the important part; it undoes all the
mocking we&#8217;ve done in each test.</td>
</tr>
</table>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/tests/tests.html (ch36l024)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">QUnit.test("should call updateItems after successful post", function (assert) {
  var url = '/listitemsapi/';
  window.Superlists.initialize(url); <i class="conum" data-value="1"></i><b>(1)</b>
  var response = [
    201,
    {"Content-Type": "application/json"},
    JSON.stringify({}),
  ];
  server.respondWith('POST', url, response); <i class="conum" data-value="1"></i><b>(1)</b>
  $('#id_item_form input[name="text"]').val('user input');
  $('#id_item_form input[name="csrfmiddlewaretoken"]').val('tokeney');
  $('#id_item_form').submit();

  sandbox.spy(window.Superlists, 'updateItems');  <i class="conum" data-value="2"></i><b>(2)</b>
  server.respond();  <i class="conum" data-value="2"></i><b>(2)</b>

  assert.equal(
    window.Superlists.updateItems.lastCall.args,  <i class="conum" data-value="3"></i><b>(3)</b>
    url
  );
});</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First important thing to notice:  We only set up our server response
<em>after</em> we do the initialize.  We want this to be the response to the
POST request that happens on form submit, not the response to the
initial GET request. (Remember our lesson from <a href="#chapter_javascript">Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></a>?
One of the most challenging things about JS testing is controlling the
order of execution.)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Similarly, we only start mocking our helper function <em>after</em> we know the
first call for the initial GET has already happened.  The <code>sandbox.spy</code>
call is what does the job that <code>patch</code> does in Python tests.  It replaces
the given object with a mock <span class="keep-together">version</span>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Our <code>updateItems</code> function has now grown some mocky extra attributes, like
<code>lastCall</code> and <code>lastCall.args</code>, which are like the Python mock&#8217;s <code>call_args</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get it passing, we first make a deliberate mistake, to check that our tests really
do test what we think they do:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">$.post(url, {
  'text': form.find('input[name="text"]').val(),
  'csrfmiddlewaretoken': form.find('input[name="csrfmiddlewaretoken"]').val(),
}).done(function () {
  window.Superlists.updateItems();
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Yep, we&#8217;re almost there but not quite:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>12 assertions of 13 passed, 1 failed.
[...]
6. should call updateItems after successful post (1, 0, 1)
    1. failed
        Expected: "/listitemsapi/"
        Result: []
        Diff: "/listitemsapi/"[]
        Source: file://...python-tdd-book/lists/static/tests/tests.html:124:15</pre>
</div>
</div>
<div class="paragraph">
<p>And we fix it thusly:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">      }).done(function () {
        window.Superlists.updateItems(url);
      });</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our FT passes!  Or at least one of them does. The others have problems, and we&#8217;ll come back to them shortly.</p>
</div>
<div class="sect3">
<h4 id="_finishing_the_refactor_getting_the_tests_to_match_the_code">G.9.1. Finishing the Refactor: Getting the Tests to Match the Code</h4>
<div class="paragraph">
<p>First, I&#8217;m not happy until we&#8217;ve seen through this refactor, and made
our unit tests match the code a little more:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/static/tests/tests.html</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -50,9 +50,19 @@ QUnit.testDone(function () {
 });


-QUnit.test("should get items by ajax on initialize", function (assert) {
+QUnit.test("should call updateItems on initialize", function (assert) {
   var url = '/getitems/';
+  sandbox.spy(window.Superlists, 'updateItems');
   window.Superlists.initialize(url);
+  assert.equal(
+    window.Superlists.updateItems.lastCall.args,
+    url
+  );
+});
+
+QUnit.test("updateItems should get correct url by ajax", function (assert) {
+  var url = '/getitems/';
+  window.Superlists.updateItems(url);

   assert.equal(server.requests.length, 1);
   var request = server.requests[0];
@@ -60,7 +70,7 @@ QUnit.test("should get items by ajax on initialize", function (assert) {
   assert.equal(request.method, 'GET');
 });

-QUnit.test("should fill in lists table from ajax response", function (assert) {
+QUnit.test("updateItems should fill in lists table from ajax response", function (assert) {
   var url = '/getitems/';
   var responseData = [
     {'id': 101, 'text': 'item 1 text'},
@@ -69,7 +79,7 @@ QUnit.test("should fill in lists table from ajax response", function [...]
   server.respondWith('GET', url, [
     200, {"Content-Type": "application/json"}, JSON.stringify(responseData)
   ]);
-  window.Superlists.initialize(url);
+  window.Superlists.updateItems(url);

   server.respond();</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that should give us a test run that looks like this instead:</p>
</div>
<div class="listingblock qunit-output">
<div class="content">
<pre>14 assertions of 14 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should call updateItems on initialize (1)
4. updateItems should get correct url by ajax (3)
5. updateItems should fill in lists table from ajax response (3)
6. should intercept form submit and do ajax post (4)
7. should call updateItems after successful post (1)</pre>
</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_data_validation_an_exercise_for_the_reader">G.10. Data Validation:  An Exercise for the Reader?</h3>
<div class="paragraph">
<p>If you do a full test run, you should find two of the validation FTs are failing:</p>
</div>
<div class="listingblock dofirst-ch36l017">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
ERROR: test_cannot_add_duplicate_items
(functional_tests.test_list_item_validation.ItemValidationTest)
[...]
ERROR: test_error_messages_are_cleared_on_input
(functional_tests.test_list_item_validation.ItemValidationTest)
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: .has-error</pre>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t spell this all out for you, but here&#8217;s at least the unit
tests you&#8217;ll need:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l028 small-code">
<div class="title">lists/tests/test_api.py (ch36l027)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.forms import DUPLICATE_ITEM_ERROR, EMPTY_ITEM_ERROR
[...]
    def post_empty_input(self):
        list_ = List.objects.create()
        return self.client.post(
            self.base_url.format(list_.id),
            data={'text': ''}
        )


    def test_for_invalid_input_nothing_saved_to_db(self):
        self.post_empty_input()
        self.assertEqual(Item.objects.count(), 0)


    def test_for_invalid_input_returns_error_code(self):
        response = self.post_empty_input()
        self.assertEqual(response.status_code, 400)
        self.assertEqual(
            json.loads(response.content.decode('utf8')),
            {'error': EMPTY_ITEM_ERROR}
        )


    def test_duplicate_items_error(self):
        list_ = List.objects.create()
        self.client.post(
            self.base_url.format(list_.id), data={'text': 'thing'}
        )
        response = self.client.post(
            self.base_url.format(list_.id), data={'text': 'thing'}
        )
        self.assertEqual(response.status_code, 400)
        self.assertEqual(
            json.loads(response.content.decode('utf8')),
            {'error': DUPLICATE_ITEM_ERROR}
        )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And on the JS side:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l029-1">
<div class="title">lists/static/tests/tests.html (ch36l029-2)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">QUnit.test("should display errors on post failure", function (assert) {
  var url = '/listitemsapi/';
  window.Superlists.initialize(url);
  server.respondWith('POST', url, [
    400,
    {"Content-Type": "application/json"},
    JSON.stringify({'error': 'something is amiss'})
  ]);
  $('.has-error').hide();

  $('#id_item_form').submit();
  server.respond(); // post

  assert.equal($('.has-error').is(':visible'), true);
  assert.equal($('.has-error .help-block').text(), 'something is amiss');
});

QUnit.test("should hide errors on post success", function (assert) {
    [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll also want some modifications to <em>base.html</em> to make it compatible with
both displaying Django errors (which the home page still uses for now) and
errors from <span class="keep-together">JavaScript</span>:</p>
</div>
<div class="exampleblock sourcecode dofirst-ch36l030">
<div class="title">lists/templates/base.html (ch36l031)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -51,17 +51,21 @@
         &lt;div class="col-md-6 col-md-offset-3 jumbotron"&gt;
           &lt;div class="text-center"&gt;
             &lt;h1&gt;{% block header_text %}{% endblock %}&lt;/h1&gt;
+
             {% block list_form %}
               &lt;form id="id_item_form" method="POST" action="{% block [...]
                 {{ form.text }}
                 {% csrf_token %}
-                {% if form.errors %}
-                  &lt;div class="form-group has-error"&gt;
-                    &lt;div class="help-block"&gt;{{ form.text.errors }}&lt;/div&gt;
+                &lt;div class="form-group has-error"&gt;
+                  &lt;div class="help-block"&gt;
+                    {% if form.errors %}
+                      {{ form.text.errors }}
+                    {% endif %}
                   &lt;/div&gt;
-                {% endif %}
+                &lt;/div&gt;
               &lt;/form&gt;
             {% endblock %}
+
           &lt;/div&gt;
         &lt;/div&gt;
       &lt;/div&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By the end you should get to a JS test run a bit like this:</p>
</div>
<div class="listingblock qunit-output dofirst-ch36l033">
<div class="content">
<pre>20 assertions of 20 passed, 0 failed.
1. errors should be hidden on keypress (1)
2. errors aren't hidden if there is no keypress (1)
3. should call updateItems on initialize (1)
4. updateItems should get correct url by ajax (3)
5. updateItems should fill in lists table from ajax response (3)
6. should intercept form submit and do ajax post (4)
7. should call updateItems after successful post (1)
8. should not intercept form submit if no api url passed in (1)
9. should display errors on post failure (2)
10. should hide errors on post success (1)
11. should display generic error if no error json (2)</pre>
</div>
</div>
<div class="paragraph">
<p>And a full test run should pass, including all the FTs:</p>
</div>
<div class="listingblock dofirst-ch36l032">
<div class="content">
<pre>$ <strong>python manage.py test</strong>
[...]
Ran 81 tests in 62.029s
OK</pre>
</div>
</div>
<div class="paragraph">
<p>Laaaaaahvely.<sup class="footnote">[<a id="_footnoteref_41" class="footnote" href="#_footnote_41" title="View footnote.">41</a>]</sup></p>
</div>
<div class="paragraph">
<p>And there&#8217;s your hand-rolled REST API with Django. If you need a hint finishing
it off yourself, check out
<a href="https://github.com/hjwp/book-example/tree/appendix_rest_api">the repo</a>.</p>
</div>
<div class="paragraph">
<p>But I would never suggest building a REST API in Django without at least
checking out <em>Django-Rest-Framework</em>.  Which is the topic of the next appendix!
Read on, <span class="keep-together">Macduff</span>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">REST API Tips</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Dedupe URLs</dt>
<dd>
<p>URLs
are more important, in a way, to an API than they are to a
browser-facing app.  Try to reduce the amount of times you hardcode them
in your tests.</p>
</dd>
<dt class="hdlist1">Don&#8217;t work with raw JSON strings</dt>
<dd>
<p><code>json.loads</code> and <code>json.dumps</code> are your friend.</p>
</dd>
<dt class="hdlist1">Always use an Ajax mocking library for your JS tests</dt>
<dd>
<p>Sinon is fine.  Jasmine has its own, as does Angular.</p>
</dd>
<dt class="hdlist1">Bear graceful degradation and progressive enhancement in mind</dt>
<dd>
<p>Especially if you&#8217;re moving from a static site to a more JavaScript-driven
one, consider keeping at least the core of your site&#8217;s functionality
working without JavaScript.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_DjangoRestFramework">Appendix H: Django-Rest-Framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having
"rolled our own" REST API in the last appendix, it&#8217;s time to take
a look at <a href="http://www.django-rest-framework.org/">Django-Rest-Framework</a>,
which is a go-to choice for many Python/Django developers building APIs.
Just as Django aims to give you all the basic tools that you&#8217;ll need to
build a database-driven website (an ORM, templates, and so on), so DRF
aims to give you all the tools you need to build an API, and thus avoid
you having to write boilerplate code over and over again.</p>
</div>
<div class="paragraph">
<p>Writing this appendix, one of the main things I struggled with was getting the
exact same API that I&#8217;d just implemented manually to be replicated by DRF.
Getting the same URL layout and the same JSON data structures I&#8217;d defined
proved to be quite a challenge, and I felt like I was fighting the framework.</p>
</div>
<div class="paragraph">
<p>That&#8217;s always a warning sign.  The people who built Django-Rest-Framework
are a lot smarter than I am, and they&#8217;ve seen a lot more REST APIs than I
have, and if they&#8217;re opinionated about the way that things "should" look,
then maybe my time would be better spent seeing if I can adapt and work
with their view of the world, rather than forcing my own preconceptions
onto it.</p>
</div>
<div class="paragraph">
<p>"Don&#8217;t fight the framework" is one of the great pieces of advice I&#8217;ve heard.
Either go with the flow, or perhaps reassess whether you want to be using
a framework at all.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll work from the API we had at the end of the <a href="#appendix_rest_api">last
appendix</a>, and see if we can rewrite it to use DRF.</p>
</div>
<div class="sect2">
<h3 id="_installation_2">H.1. Installation</h3>
<div class="paragraph">
<p>A
quick <code>pip install</code> gets us DRF.  I&#8217;m just using the latest version, which
was 3.5.4 at the time of writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>pip install djangorestframework</strong></pre>
</div>
</div>
<div class="paragraph">
<p>And we add <code>rest_framework</code> to <code>INSTALLED_APPS</code> in <em>settings.py</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">INSTALLED_APPS = [
    #'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'lists',
    'accounts',
    'functional_tests',
    'rest_framework',
]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_serializers_well_modelserializers_really">H.2. Serializers (Well, ModelSerializers, Really)</h3>
<div class="paragraph">
<p>The
<a href="http://bit.ly/2t6T6eX">Django-Rest-Framework tutorial</a>
is a pretty good resource to learn DRF.  The first thing you&#8217;ll come across
is serializers, and specifically in our case, "ModelSerializers". They are
DRF&#8217;s way of converting from Django database models to JSON (or possibly other
formats) that you can send over the wire:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py (ch37l003)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">from lists.models import List, Item
[...]
from rest_framework import routers, serializers, viewsets


class ItemSerializer(serializers.ModelSerializer):

    class Meta:
        model = Item
        fields = ('id', 'text')


class ListSerializer(serializers.ModelSerializer):
    items = ItemSerializer(many=True, source='item_set')

    class Meta:
        model = List
        fields = ('id', 'items',)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before">
<h3 id="_viewsets_well_modelviewsets_really_and_routers">H.3. Viewsets (Well, ModelViewsets, Really) and Routers</h3>
<div class="paragraph">
<p>A
ModelViewSet is DRF&#8217;s way of defining all the different ways you can interact
with the objects for a particular model via your API. Once you tell it which
models you&#8217;re interested in (via the <code>queryset</code> attribute) and how to serialize
them (<code>serializer_class</code>), it will then do the rest&#8212;&#8203;automatically building
views for you that will let you list, retrieve, update, and even delete objects.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s all we need to do for a ViewSet that&#8217;ll be able to retrieve items for
a particular list:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py (ch37l004)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ListViewSet(viewsets.ModelViewSet):
    queryset = List.objects.all()
    serializer_class = ListSerializer


router = routers.SimpleRouter()
router.register(r'lists', ListViewSet)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A <em>router</em> is DRF&#8217;s way of building URL configuration automatically, and
mapping them to the functionality provided by the ViewSet.</p>
</div>
<div class="paragraph">
<p>At this point we can start pointing our <em>urls.py</em> at our new router,
bypassing the old API code and seeing how our tests do with the new stuff:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">superlists/urls.py (ch37l005)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
# from lists.api import urls as api_urls
from lists.api import router

urlpatterns = [
    url(r'^$', list_views.home_page, name='home'),
    url(r'^lists/', include(list_urls)),
    url(r'^accounts/', include(accounts_urls)),
    # url(r'^api/', include(api_urls)),
    url(r'^api/', include(router.urls)),
]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That makes loads of our tests fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
django.urls.exceptions.NoReverseMatch: Reverse for 'api_list' not found.
'api_list' is not a valid view function or pattern name.
[...]
AssertionError: 405 != 400
[...]
AssertionError: {'id': 2, 'items': [{'id': 2, 'text': 'item 1'}, {'id': 3,
'text': 'item 2'}]} != [{'id': 2, 'text': 'item 1'}, {'id': 3, 'text': 'item
2'}]

 ---------------------------------------------------------------------
Ran 54 tests in 0.243s

FAILED (failures=4, errors=10)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at those 10 errors first, all saying they cannot reverse
<code>api_list</code>.  It&#8217;s because the DRF router uses a different naming convention
for URLs than the one we used when we coded it manually. You&#8217;ll see from the
tracebacks that they&#8217;re happening when we render a template.  It&#8217;s <em>list.html</em>.
We can fix that in just one place; <code>api_list</code> becomes <code>list-detail</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch37l006)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">  &lt;script&gt;
$(document).ready(function () {
  var url = "{% url 'list-detail' list.id %}";
});
  &lt;/script&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That will get us down to just four failures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test lists</strong>
[...]
FAIL: test_POSTing_a_new_item (lists.tests.test_api.ListAPITest)
[...]
FAIL: test_duplicate_items_error (lists.tests.test_api.ListAPITest)
[...]
FAIL: test_for_invalid_input_returns_error_code
(lists.tests.test_api.ListAPITest)
[...]
FAIL: test_get_returns_items_for_correct_list
(lists.tests.test_api.ListAPITest)
[...]
FAILED (failures=4)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s DONT-ify all the validation tests for now, and save that complexity
for later:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch37l007)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">[...]
    def DONTtest_for_invalid_input_nothing_saved_to_db(self):
        [...]
    def DONTtest_for_invalid_input_returns_error_code(self):
        [...]
    def DONTtest_duplicate_items_error(self):
        [...]</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now we have just two failures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FAIL: test_POSTing_a_new_item (lists.tests.test_api.ListAPITest)
[...]
    self.assertEqual(response.status_code, 201)
AssertionError: 405 != 201
[...]
FAIL: test_get_returns_items_for_correct_list
(lists.tests.test_api.ListAPITest)
[...]
AssertionError: {'id': 2, 'items': [{'id': 2, 'text': 'item 1'}, {'id': 3,
'text': 'item 2'}]} != [{'id': 2, 'text': 'item 1'}, {'id': 3, 'text': 'item
2'}]
[...]
FAILED (failures=2)</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at that last one first.</p>
</div>
<div class="paragraph">
<p>DRF&#8217;s default configuration does provide a slightly different data structure
to the one we built by hand&#8212;&#8203;doing a GET for a list gives you its ID, and
then the list items are inside a key called "items".  That means a slight
modification to our unit test, before it gets back to passing:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch37l008)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -23,10 +23,10 @@ class ListAPITest(TestCase):
         response = self.client.get(self.base_url.format(our_list.id))
         self.assertEqual(
             json.loads(response.content.decode('utf8')),
-            [
+            {'id': our_list.id, 'items': [
                 {'id': item1.id, 'text': item1.text},
                 {'id': item2.id, 'text': item2.text},
-            ]
+            ]}
         )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s the GET for retrieving list items sorted (and, as we&#8217;ll see later, we&#8217;ve
got a bunch of other stuff for free too).  How about adding new ones, using
POST?</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_different_url_for_post_item">H.4. A Different URL for POST Item</h3>
<div class="paragraph">
<p>This
is the point at which I gave up on fighting the framework and just saw
where DRF wanted to take me.  Although it&#8217;s possible, it&#8217;s quite torturous to
do a POST to the "lists" ViewSet in order to add an item to a list.</p>
</div>
<div class="paragraph">
<p>Instead, the simplest thing is to post to an item view, not a list view:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py (ch37l009)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemViewSet(viewsets.ModelViewSet):
    serializer_class = ItemSerializer
    queryset = Item.objects.all()


[...]
router.register(r'items', ItemViewSet)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So that means we change the test slightly, moving all the POST tests
out of the <span class="keep-together"><code>ListAPITest</code></span> and into a new test class, <code>ItemsAPITest</code>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch37l010)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@@ -1,3 +1,4 @@
 import json
+from django.core.urlresolvers import reverse
 from django.test import TestCase
 from lists.models import List, Item
@@ -31,9 +32,13 @@ class ListAPITest(TestCase):


+
+class ItemsAPITest(TestCase):
+    base_url = reverse('item-list')
+
     def test_POSTing_a_new_item(self):
         list_ = List.objects.create()
         response = self.client.post(
-            self.base_url.format(list_.id),
-            {'text': 'new item'},
+            self.base_url,
+            {'list': list_.id, 'text': 'new item'},
         )
         self.assertEqual(response.status_code, 201)</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That will give us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id</pre>
</div>
</div>
<div class="paragraph">
<p>Until we add the list ID to our serialization of items; otherwise, we don&#8217;t know
what list it&#8217;s for:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/api.py (ch37l011)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemSerializer(serializers.ModelSerializer):

    class Meta:
        model = Item
        fields = ('id', 'list', 'text')</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that causes another small associated test change:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/tests/test_api.py (ch37l012)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">@@ -25,8 +25,8 @@ class ListAPITest(TestCase):
         self.assertEqual(
             json.loads(response.content.decode('utf8')),
             {'id': our_list.id, 'items': [
-                {'id': item1.id, 'text': item1.text},
-                {'id': item2.id, 'text': item2.text},
+                {'id': item1.id, 'list': our_list.id, 'text': item1.text},
+                {'id': item2.id, 'list': our_list.id, 'text': item2.text},
             ]}
         )</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adapting_the_client_side">H.5. Adapting the Client Side</h3>
<div class="paragraph">
<p>Our
API no longer returns a flat array of the items in a list.  It returns an
object, with a <code>.items</code> attribute that represents the items.  That means a
small tweak to our <code>update&#x200b;Items</code> function:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/static/list.js (ch37l013)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -3,8 +3,8 @@ window.Superlists = {};
 window.Superlists.updateItems = function (url) {
   $.get(url).done(function (response) {
     var rows = '';
-    for (var i=0; i&lt;response.length; i++) {
-      var item = response[i];
+    for (var i=0; i&lt;response.items.length; i++) {
+      var item = response.items[i];
       rows += '\n&lt;tr&gt;&lt;td&gt;' + (i+1) + ': ' + item.text + '&lt;/td&gt;&lt;/tr&gt;';
     }
     $('#id_list_table').html(rows);</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And because we&#8217;re using different URLs for GETing lists and POSTing items,
we tweak the <code>initialize</code> function slightly too.  Rather than multiple
arguments, we&#8217;ll switch to using a <code>params</code> object containing the required
config:</p>
</div>
<div class="exampleblock sourcecode small-code">
<div class="title">lists/static/list.js</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="diff">@@ -11,23 +11,24 @@ window.Superlists.updateItems = function (url) {
   });
 };

-window.Superlists.initialize = function (url) {
+window.Superlists.initialize = function (params) {
   $('input[name="text"]').on('keypress', function () {
     $('.has-error').hide();
   });

-  if (url) {
-    window.Superlists.updateItems(url);
+  if (params) {
+    window.Superlists.updateItems(params.listApiUrl);

     var form = $('#id_item_form');
     form.on('submit', function(event) {
       event.preventDefault();
-      $.post(url, {
+      $.post(params.itemsApiUrl, {
+        'list': params.listId,
         'text': form.find('input[name="text"]').val(),
         'csrfmiddlewaretoken': form.find('input[name="csrfmiddlewaretoken"]').val(),
       }).done(function () {
         $('.has-error').hide();
-        window.Superlists.updateItems(url);
+        window.Superlists.updateItems(params.listApiUrl);
       }).fail(function (xhr) {
         $('.has-error').show();
         if (xhr.responseJSON &amp;&amp; xhr.responseJSON.error) {</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We reflect that in <em>list.html</em>:</p>
</div>
<div class="exampleblock sourcecode">
<div class="title">lists/templates/list.html (ch37l014)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html">$(document).ready(function () {
  window.Superlists.initialize({
    listApiUrl: "{% url 'list-detail' list.id %}",
    itemsApiUrl: "{% url 'item-list' %}",
    listId: {{ list.id }},
  });
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s actually enough to get the basic FT working again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ <strong>python manage.py test functional_tests.test_simple_list_creation</strong>
[...]
Ran 2 tests in 15.635s

OK</pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s a few more changes to do with error handling, which you can explore in
the
<a href="https://github.com/hjwp/book-example/blob/appendix_DjangoRestFramework/lists/api.py">repo
for this appendix</a> if you&#8217;re curious.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_django_rest_framework_gives_you">H.6. What Django-Rest-Framework Gives You</h3>
<div class="paragraph">
<p>You
may be wondering what the point of using this framework was.</p>
</div>
<div class="sect3">
<h4 id="_configuration_instead_of_code">H.6.1. Configuration Instead of Code</h4>
<div class="paragraph">
<p>Well, the first advantage is that I&#8217;ve transformed my old procedural view
function into a more declarative syntax:</p>
</div>
<div class="exampleblock sourcecode currentcontents dofirst-ch37l016">
<div class="title">lists/api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">def list(request, list_id):
    list_ = List.objects.get(id=list_id)
    if request.method == 'POST':
        form = ExistingListItemForm(for_list=list_, data=request.POST)
        if form.is_valid():
            form.save()
            return HttpResponse(status=201)
        else:
            return HttpResponse(
                json.dumps({'error': form.errors['text'][0]}),
                content_type='application/json',
                status=400
            )
    item_dicts = [
        {'id': item.id, 'text': item.text}
        for item in list_.item_set.all()
    ]
    return HttpResponse(
        json.dumps(item_dicts),
        content_type='application/json'
    )</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you compare this to the final DRF version, you&#8217;ll notice that we are
actually now entirely configured:</p>
</div>
<div class="exampleblock sourcecode currentcontents dofirst-ch37l019">
<div class="title">lists/api.py</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python">class ItemSerializer(serializers.ModelSerializer):
    text = serializers.CharField(
        allow_blank=False, error_messages={'blank': EMPTY_ITEM_ERROR}
    )

    class Meta:
        model = Item
        fields = ('id', 'list', 'text')
        validators = [
            UniqueTogetherValidator(
                queryset=Item.objects.all(),
                fields=('list', 'text'),
                message=DUPLICATE_ITEM_ERROR
            )
        ]


class ListSerializer(serializers.ModelSerializer):
    items = ItemSerializer(many=True, source='item_set')

    class Meta:
        model = List
        fields = ('id', 'items',)


class ListViewSet(viewsets.ModelViewSet):
    queryset = List.objects.all()
    serializer_class = ListSerializer


class ItemViewSet(viewsets.ModelViewSet):
    serializer_class = ItemSerializer
    queryset = Item.objects.all()


router = routers.SimpleRouter()
router.register(r'lists', ListViewSet)
router.register(r'items', ItemViewSet)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_free_functionality">H.6.2. Free Functionality</h4>
<div class="paragraph">
<p>The second advantage is that, by using DRF&#8217;s ModelSerializer, ViewSet, and
routers, I&#8217;ve actually ended up with a much more extensive API than the one I&#8217;d
rolled by hand.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All the HTTP methods, GET, POST, PUT, PATCH, DELETE, and OPTIONS, now work,
out of the box, for all list and items URLs.</p>
</li>
<li>
<p>And a browsable/self-documenting version of the API is available at
<em>http://localhost:8000/api/lists/</em> and <em>http://localhost:8000/api/items</em>. (<a href="#figag01">A free browsable API for your users</a>; try it!)</p>
</li>
</ul>
</div>
<div id="figag01" class="imageblock">
<div class="content">
<img src="images/twp2_ag01.png" alt="Screenshot of DRF browsable api page at http://localhost:8000/api/items/">
</div>
<div class="title">Figure 50. A free browsable API for your users</div>
</div>
<div class="paragraph">
<p>There&#8217;s more information in
<a href="http://www.django-rest-framework.org/topics/documenting-your-api/#self-describing-apis">the
DRF docs</a>, but those are both seriously neat features to be able to offer the
end users of your API.</p>
</div>
<div class="paragraph">
<p>In short, DRF is a great way of generating APIs, almost automatically, based on
your existing models structure.  If you&#8217;re using Django, definitely check it
out before you start hand-rolling your own API code.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Django-Rest-Framework Tips</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Don&#8217;t fight the framework</dt>
<dd>
<p>Going with the flow is often the best way to stay productive.  That, or
maybe don&#8217;t use the framework.  Or use it at a lower level.</p>
</dd>
<dt class="hdlist1">Routers and ViewSets for the principle of least surprise</dt>
<dd>
<p>One of the advantages of DRF is that its generic tools like routers and
ViewSets will give you a very predictable API, with sensible defaults
for its endpoints, URL structure, and responses for different HTTP methods.</p>
</dd>
<dt class="hdlist1">Check out the self-documenting, browsable version</dt>
<dd>
<p>Check out your API endpoints in a browser. DRF responds differently when it
detects your API is being accessed by a "normal" web browser, and displays
a very nice, self-documenting version of itself, which you can share with
your users.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cheat-sheet">Appendix I: Cheat Sheet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By popular demand, this "cheat sheet" is loosely based on the little
recap/summary boxes from the end of each chapter.  The idea is to provide a few
reminders, and links to the chapters where you can find out more to jog your
memory. I hope you find it useful!</p>
</div>
<div class="sect2">
<h3 id="_initial_project_setup">I.1. Initial Project Setup</h3>
<div class="ulist">
<ul>
<li>
<p>Start
with a <em>User Story</em> and map it to a first <em>functional test</em>.</p>
</li>
<li>
<p>Pick a test framework&mdash;<code>unittest</code> is fine, and options like <code>py.test</code>,
<code>nose</code>, or <code>Green</code> can also offer some advantages.</p>
</li>
<li>
<p>Run the functional test and see your first <em>expected failure</em>.</p>
</li>
<li>
<p>Pick a web framework such as Django, and find out how to run
<em>unit tests</em> against it.</p>
</li>
<li>
<p>Create your first <em>unit test</em> to address the current FT failure,
and see it fail.</p>
</li>
<li>
<p>Do  your <em>first commit</em> to a VCS like <em>Git</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Relevant chapters: <a href="#chapter_01">Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a>, <a href="#chapter_02_unittest">Extending Our Functional Test Using <span class="keep-together">the unittest Module</span></a>, <a href="#chapter_unit_test_first_view">Testing a Simple Home Page with <span class="keep-together">Unit Tests</span></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_basic_tdd_workflow">I.2. The Basic TDD Workflow</h3>
<div class="ulist">
<ul>
<li>
<p>Double-loop TDD (<a href="#Double-Loop-TDD-diagram2">The TDD process with functional and unit tests</a>)</p>
</li>
<li>
<p>Red, Green, Refactor</p>
</li>
<li>
<p>Triangulation</p>
</li>
<li>
<p>The scratchpad</p>
</li>
<li>
<p>"3 Strikes and Refactor"</p>
</li>
<li>
<p>"Working State to Working State"</p>
</li>
<li>
<p>"YAGNI"</p>
</li>
</ul>
</div>
<div id="Double-Loop-TDD-diagram2" class="imageblock">
<div class="content">
<img src="images/twp2_0404.png" alt="A flowchart showing functional tests as the overall cycle, and unit tests helping to code">
</div>
<div class="title">Figure 51. The TDD process with functional and unit tests</div>
</div>
<div class="paragraph">
<p>Relevant chapters: <a href="#chapter_philosophy_and_refactoring">What Are We Doing with All These Tests? (And, Refactoring)</a>, <a href="#chapter_post_and_database">Saving User Input: Testing the Database</a>, <a href="#chapter_working_incrementally">Working Incrementally</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_moving_beyond_dev_only_testing">I.3. Moving Beyond Dev-Only Testing</h3>
<div class="ulist">
<ul>
<li>
<p>Start
system testing early. Ensure your components work together: web server,
  static content, database.</p>
</li>
<li>
<p>Build a staging environment to match your production environment, and run
your FT suite against it.</p>
</li>
<li>
<p>Automate your staging and production environments:</p>
<div class="ulist">
<ul>
<li>
<p>PaaS vs. VPS</p>
</li>
<li>
<p>Fabric</p>
</li>
<li>
<p>Configuration management (Chef, Puppet, Salt, Ansible)</p>
</li>
<li>
<p>Vagrant</p>
</li>
</ul>
</div>
</li>
<li>
<p>Think through deployment pain points: the database, static files,
dependencies, how to customise settings, and so on.</p>
</li>
<li>
<p>Build a CI server as soon as possible, so that you don&#8217;t have to rely
on self-discipline to see the tests run.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Relevant chapters: <a href="#chapter_manual_deployment">Testing Deployment Using a Staging Site</a>, <a href="#chapter_automate_deployment_with_fabric">Automating Deployment with Fabric</a>, <a href="#chapter_CI">Continuous Integration (CI)</a>,
<a href="#appendix3">Provisioning with Ansible</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_general_testing_best_practices">I.4. General Testing Best Practices</h3>
<div class="ulist">
<ul>
<li>
<p>Each
test should test one thing.</p>
</li>
<li>
<p>One test file per application code source file.</p>
</li>
<li>
<p>Consider at least a placeholder test for every function and class,
no matter how simple.</p>
</li>
<li>
<p>"Don&#8217;t test constants".</p>
</li>
<li>
<p>Try to test behaviour rather than implementation.</p>
</li>
<li>
<p>Try to think beyond the charmed path through the code, and think
through edge cases and error cases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Relevant chapters: <a href="#chapter_philosophy_and_refactoring">What Are We Doing with All These Tests? (And, Refactoring)</a>, <a href="#chapter_database_layer_validation">Validation at the Database Layer</a>,
<a href="#chapter_simple_form">A Simple Form</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_selenium_functional_testing_best_practices">I.5. Selenium/Functional Testing Best Practices</h3>
<div class="ulist">
<ul>
<li>
<p>Use explicit rather than implicit waits, and the interaction/wait pattern.</p>
</li>
<li>
<p>Avoid duplication of test code&#8212;&#8203;helper methods in a base class and the
Page pattern are possible solutions.</p>
</li>
<li>
<p>Avoid double-testing functionality. If you have a test that covers a
time-consuming process (e.g., login), consider ways of skipping it in
other tests (but be aware of unexpected interactions between seemingly
unrelated bits of functionality).</p>
</li>
<li>
<p>Look into BDD tools as another way of structuring your FTs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Relevant chapters: <a href="#chapter_server_side_debugging">Server-Side Debugging</a>, <a href="#chapter_CI">Continuous Integration (CI)</a>,
<a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_outside_in_test_isolation_versus_integrated_tests_and_mocking">I.6. Outside-In, Test Isolation Versus Integrated Tests, and Mocking</h3>
<div class="paragraph">
<p>Remember
the reasons we write tests in the first place:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To ensure correctness and prevent regressions</p>
</li>
<li>
<p>To help us to write clean, maintainable code</p>
</li>
<li>
<p>To enable a fast, productive workflow</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And with those objectives in mind, think of different types of tests,
and the trade-offs between them:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Functional tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Provide the best guarantee that your application really works correctly, from the point of view of the user</p>
</li>
<li>
<p>But: it&#8217;s a slower feedback cycle</p>
</li>
<li>
<p>And they don&#8217;t necessarily help you write clean code</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Integrated tests (reliant on, for example, the ORM or the Django Test Client)</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Are quick to write</p>
</li>
<li>
<p>Are easy to understand</p>
</li>
<li>
<p>Will warn you of any integration issues</p>
</li>
<li>
<p>But: may not always drive good design (that&#8217;s up to you!)</p>
</li>
<li>
<p>And are usually slower than isolated tests</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Isolated ("mocky") tests</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Involve the most hard work</p>
</li>
<li>
<p>Can be harder to read and understand</p>
</li>
<li>
<p>But: are the best ones for guiding you towards better design</p>
</li>
<li>
<p>And run the fastest</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you do find yourself writing tests with lots of mocks, and they feel
painful, remember &#x201c;<em>listen to your tests</em>&#x201d;—ugly, mocky tests may be
trying to tell you that your code could be simplified.</p>
</div>
<div class="paragraph">
<p>Relevant chapters: <a href="#chapter_outside_in">Finishing "My Lists": Outside-In TDD</a>, <a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a>,
<a href="#chapter_hot_lava">Fast Tests, Slow Tests, and Hot Lava</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix4">Appendix J: What to Do Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here
I offer a few suggestions for things to investigate next, to develop your
testing skills, and to apply them to some of the cool new technologies in web
development (at the time of writing!).</p>
</div>
<div class="paragraph">
<p>I hope to turn each one of these into at least some sort of blog post,
if not a future appendix to the book. I hope to also produce code examples for
all of them, as time goes by. So do check out
<a href="http://www.obeythetestinggoat.com" class="bare">http://www.obeythetestinggoat.com</a>, and see if there
are any updates.</p>
</div>
<div class="paragraph">
<p>Or, why not try to beat me to it, and write your own blog post chronicling
your attempt at any one of these?</p>
</div>
<div class="paragraph">
<p>I&#8217;m
very happy to answer questions and provide tips and guidance on all
these topics, so if you find yourself attempting one and getting stuck,
please don&#8217;t hesitate to get in touch at <a href="mailto:obeythetestinggoat@gmail.com">obeythetestinggoat@gmail.com</a>!</p>
</div>
<div class="sect2">
<h3 id="_notifications_both_on_the_site_and_by_email">J.1. Notifications&#8212;&#8203;Both on the Site and by Email</h3>
<div class="paragraph">
<p>It would be nice if users were notified when someone shares a list with
them.</p>
</div>
<div class="paragraph">
<p>You can use django-notifications to show a message to users the next
time they refresh the screen. You&#8217;ll need two browsers in your FT for this.</p>
</div>
<div class="paragraph">
<p>And/or, you could send notifications by email.  Investigate Django&#8217;s
email test capabilities.  Then, decide this is so critical that you need
real tests with real emails.  Use the IMAPClient library to fetch actual
emails from a test webmail account.</p>
</div>
</div>
<div class="sect2">
<h3 id="_switch_to_postgres">J.2. Switch to Postgres</h3>
<div class="paragraph">
<p>SQLite is a wonderful little database, but it won&#8217;t deal well once you
have more than one web worker process fielding your site&#8217;s requests.
Postgres is everyone&#8217;s favourite database these days, so find out how
to install and configure it.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll need to figure out a place to store the usernames and passwords for your
local, staging, and production Postgres servers.  Since, for security, you
probably don&#8217;t want them in your code repository, look into ways of modifying
your deploy scripts to pass them in at the command line.  Environment variables
are one popular solution for where to keep them&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Experiment with keeping your unit tests running with SQLite, and compare how
much faster they are than running against Postgres.  Set it up so that your
local machine uses SQLite for testing, but your CI server uses Postgres.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_your_tests_against_different_browsers">J.3. Run Your Tests Against Different Browsers</h3>
<div class="paragraph">
<p>Selenium supports all sorts of different browsers, including Chrome and
Internet Exploder.  Try them both out and see if your FT suite behaves
any differently.</p>
</div>
<div class="paragraph">
<p>You should also check out a "headless" browser like PhantomJS.</p>
</div>
<div class="paragraph">
<p>In my experience, switching browsers tends to expose all sorts of race
conditions in Selenium tests, and you will probably need to use the
interaction/wait pattern a lot more (particularly for PhantomJS).</p>
</div>
</div>
<div class="sect2">
<h3 id="_404_and_500_tests">J.4. 404 and 500 Tests</h3>
<div class="paragraph">
<p>A professional site needs good-looking error pages.  Testing a 404 page is
easy, but you&#8217;ll probably need a custom "raise an exception on purpose" view
to test the 500 page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_django_admin_site">J.5. The Django Admin Site</h3>
<div class="paragraph">
<p>Imagine a story where a user emails you wanting to "claim" an anonymous
list.  Let&#8217;s say we implement a manual solution to this, involving the site
administrator manually changing the record using the Django admin site.</p>
</div>
<div class="paragraph">
<p>Find out how to switch on the admin site, and have a play with it. Write an FT
that shows a normal, non–logged-in user creating a list, then have an admin
user log in, go to the admin site, and assign the list to the user.  The user
can then see it in their "My Lists" page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_write_some_security_tests">J.6. Write Some Security Tests</h3>
<div class="paragraph">
<p>Expand on the login, my lists, and sharing tests&#8212;&#8203;what do you need to write to
assure yourself that users can only do what they&#8217;re authorized to?</p>
</div>
</div>
<div class="sect2">
<h3 id="_test_for_graceful_degradation">J.7. Test for Graceful Degradation</h3>
<div class="paragraph">
<p>What would happen if our email server goes down?  Can we at least show an apologetic
error message to our users?</p>
</div>
</div>
<div class="sect2">
<h3 id="_caching_and_performance_testing">J.8. Caching and Performance Testing</h3>
<div class="paragraph">
<p>Find out how to install and configure <code>memcached</code>.  Find out how to use
Apache&#8217;s <code>ab</code> to run a performance test.  How does it perform with and without
caching? Can you write an automated test that will fail if caching is not
enabled? What about the dreaded problem of cache invalidation?  Can tests
help you to make sure your cache invalidation logic is solid?</p>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_mvc_frameworks">J.9. JavaScript MVC Frameworks</h3>
<div class="paragraph">
<p>JavaScript libraries that let you implement a Model-View-Controller
pattern on the client side are all the rage these days.  To-do lists are
one of the favourite demo applications for them, so it should be pretty easy
to convert the site to being a single-page site, where all list additions
happen in JavaScript.</p>
</div>
<div class="paragraph">
<p>Pick a framework&#8212;&#8203;perhaps Backbone.js or Angular.js&#8212;&#8203;and spike in an
implementation.  Each framework has its own preferences for how to write
unit tests, so learn the one that goes along with it, and see how you like
it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_async_and_websockets">J.10. Async and Websockets</h3>
<div class="paragraph">
<p>Supposing two users are working on the same list at the same time. Wouldn&#8217;t
it be nice to see real-time updates, so if the other person adds an item to
the list, you see it immediately?  A persistent connection between client and
server using websockets is the way to get this to work.</p>
</div>
<div class="paragraph">
<p>Check out one of the Python async web servers&#8212;&#8203;Tornado, gevent, Twisted&#8212;&#8203;and
see if you can use it to implement dynamic notifications.</p>
</div>
<div class="paragraph">
<p>To test it, you&#8217;ll need two browser instances (like we used for the list
sharing tests), and check that notifications of the actions from one
appear in the other, without needing to refresh the page&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_switch_to_using_py_test">J.11. Switch to Using py.test</h3>
<div class="paragraph">
<p><em>py.test</em> lets you write unit tests with less boilerplate.  Try converting some
of your unit tests to using <em>py.test</em>.  You may need to use a plugin to get it
to play nicely with Django.</p>
</div>
</div>
<div class="sect2">
<h3 id="_check_out_coverage_py">J.12. Check Out coverage.py</h3>
<div class="paragraph">
<p>Ned Batchelder&#8217;s <code>coverage.py</code> will tell you what your <em>test coverage</em> is—what percentage of your code is covered by tests.  Now, in theory, because
we&#8217;ve been using rigorous TDD, we should always have 100% coverage.  But it&#8217;s
nice to know for sure, and it&#8217;s also a very useful tool for working on projects
that didn&#8217;t have tests from the beginning.</p>
</div>
</div>
<div class="sect2">
<h3 id="_client_side_encryption">J.13. Client-Side Encryption</h3>
<div class="paragraph">
<p>Here&#8217;s a fun one: what if our users are paranoid about the NSA, and decide they
no longer want to trust their lists to The Cloud?  Can you build a JavaScript
encryption system, where the user can enter a password to encypher their list
item text before it gets sent to the server?</p>
</div>
<div class="paragraph">
<p>One way of testing it might be to have an "administrator" user that goes to
the Django admin view to inspect users' lists, and checks that they are stored
encrypted in the database.</p>
</div>
</div>
<div class="sect2">
<h3 id="_your_suggestion_here">J.14. Your Suggestion Here</h3>
<div class="paragraph">
<p>What do you think I should put here?  Suggestions, please!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_github_links">Appendix K: Source Code Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All
of the code examples I&#8217;ve used in
the book are available in <a href="https://github.com/hjwp/book-example/">my repo</a> on
GitHub.  So, if you ever want to compare your code against mine, you can take a
look at it there.</p>
</div>
<div class="paragraph">
<p>Each chapter has its own branch named after it, like so:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#chapter_01">Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_01" class="bare">https://github.com/hjwp/book-example/tree/chapter_01</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Be aware that each branch contains all of the commits for that chapter,
so its state represents the code at the <em>end</em> of the chapter.</p>
</div>
<div class="sect2">
<h3 id="_full_list_of_links_for_each_chapter">K.1. Full List of Links for Each Chapter</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="#chapter_01">Getting Django Set Up Using a <span class="keep-together">Functional Test</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_01" class="bare">https://github.com/hjwp/book-example/tree/chapter_01</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_02_unittest">Extending Our Functional Test Using <span class="keep-together">the unittest Module</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_02_unittest" class="bare">https://github.com/hjwp/book-example/tree/chapter_02_unittest</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_unit_test_first_view">Testing a Simple Home Page with <span class="keep-together">Unit Tests</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_unit_test_first_view" class="bare">https://github.com/hjwp/book-example/tree/chapter_unit_test_first_view</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_philosophy_and_refactoring">What Are We Doing with All These Tests? (And, Refactoring)</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_philosophy_and_refactoring" class="bare">https://github.com/hjwp/book-example/tree/chapter_philosophy_and_refactoring</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_post_and_database">Saving User Input: Testing the Database</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_post_and_database" class="bare">https://github.com/hjwp/book-example/tree/chapter_post_and_database</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_explicit_waits_1">Improving Functional Tests: Ensuring Isolation and Removing Voodoo Sleeps</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_explicit_waits_1" class="bare">https://github.com/hjwp/book-example/tree/chapter_explicit_waits_1</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_working_incrementally">Working Incrementally</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_working_incrementally" class="bare">https://github.com/hjwp/book-example/tree/chapter_working_incrementally</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_prettification">Prettification: Layout and Styling, and What to Test About It</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_prettification" class="bare">https://github.com/hjwp/book-example/tree/chapter_prettification</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_manual_deployment">Testing Deployment Using a Staging Site</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_manual_deployment" class="bare">https://github.com/hjwp/book-example/tree/chapter_manual_deployment</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_making_deployment_production_ready">Getting to a Production-Ready Deployment</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_making_deployment_production_ready" class="bare">https://github.com/hjwp/book-example/tree/chapter_making_deployment_production_ready</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_automate_deployment_with_fabric">Automating Deployment with Fabric</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_automate_deployment_with_fabric" class="bare">https://github.com/hjwp/book-example/tree/chapter_automate_deployment_with_fabric</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_organising_test_files">Splitting Our Tests into Multiple Files, and a Generic Wait Helper</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_organising_test_files" class="bare">https://github.com/hjwp/book-example/tree/chapter_organising_test_files</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_database_layer_validation">Validation at the Database Layer</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_database_layer_validation" class="bare">https://github.com/hjwp/book-example/tree/chapter_database_layer_validation</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_simple_form">A Simple Form</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_simple_form" class="bare">https://github.com/hjwp/book-example/tree/chapter_simple_form</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_advanced_forms">More Advanced Forms</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_advanced_forms" class="bare">https://github.com/hjwp/book-example/tree/chapter_advanced_forms</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_javascript">Dipping Our Toes, Very Tentatively, <span class="keep-together">into JavaScript</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_javascript" class="bare">https://github.com/hjwp/book-example/tree/chapter_javascript</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_deploying_validation">Deploying Our New Code</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_deploying_validation" class="bare">https://github.com/hjwp/book-example/tree/chapter_deploying_validation</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_spiking_custom_auth">User Authentication, Spiking, and <span class="keep-together">De-Spiking</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_spiking_custom_auth" class="bare">https://github.com/hjwp/book-example/tree/chapter_spiking_custom_auth</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_mocking">Using Mocks to Test External Dependencies or Reduce Duplication</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_mocking" class="bare">https://github.com/hjwp/book-example/tree/chapter_mocking</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_fixtures_and_wait_decorator">Test Fixtures and a Decorator for <span class="keep-together">Explicit Waits</span></a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_fixtures_and_wait_decorator" class="bare">https://github.com/hjwp/book-example/tree/chapter_fixtures_and_wait_decorator</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_server_side_debugging">Server-Side Debugging</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_server_side_debugging" class="bare">https://github.com/hjwp/book-example/tree/chapter_server_side_debugging</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_outside_in">Finishing "My Lists": Outside-In TDD</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_outside_in" class="bare">https://github.com/hjwp/book-example/tree/chapter_outside_in</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_purist_unit_tests">Test Isolation, and "Listening to Your Tests"</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_purist_unit_tests" class="bare">https://github.com/hjwp/book-example/tree/chapter_purist_unit_tests</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_CI">Continuous Integration (CI)</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_CI" class="bare">https://github.com/hjwp/book-example/tree/chapter_CI</a></p>
</dd>
<dt class="hdlist1"><a href="#chapter_page_pattern">The Token Social Bit, the Page Pattern, and an Exercise for the Reader</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/chapter_page_pattern" class="bare">https://github.com/hjwp/book-example/tree/chapter_page_pattern</a></p>
</dd>
<dt class="hdlist1"><a href="#appendix_Django_Class-Based_Views">Django Class-Based Views</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/appendix_Django_Class-Based_Views" class="bare">https://github.com/hjwp/book-example/tree/appendix_Django_Class-Based_Views</a></p>
</dd>
<dt class="hdlist1"><a href="#appendix_bdd">Behaviour-Driven Development (BDD)</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/appendix_bdd" class="bare">https://github.com/hjwp/book-example/tree/appendix_bdd</a></p>
</dd>
<dt class="hdlist1"><a href="#appendix_rest_api">Building a REST API: JSON, Ajax, and Mocking with JavaScript</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/appendix_rest_api" class="bare">https://github.com/hjwp/book-example/tree/appendix_rest_api</a></p>
</dd>
<dt class="hdlist1"><a href="#appendix_DjangoRestFramework">Django-Rest-Framework</a></dt>
<dd>
<p><a href="https://github.com/hjwp/book-example/tree/appendix_DjangoRestFramework" class="bare">https://github.com/hjwp/book-example/tree/appendix_DjangoRestFramework</a></p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_using_git_to_check_your_progress">K.2. Using Git to Check Your Progress</h3>
<div class="paragraph">
<p>If you feel like developing your Git-Fu a little further, you can add
my repo as a <em>remote</em>:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>git remote add harry https://github.com/hjwp/book-example.git
git fetch harry</pre>
</div>
</div>
<div class="paragraph">
<p>And then, to check your difference from the <em>end</em> of <a href="#chapter_philosophy_and_refactoring">What Are We Doing with All These Tests? (And, Refactoring)</a>:</p>
</div>
<div class="listingblock skipme">
<div class="content">
<pre>git diff harry/chapter_philosophy_and_refactoring</pre>
</div>
</div>
<div class="paragraph">
<p>Git can handle multiple remotes, so you can still do this even if you&#8217;re
already pushing your code up to GitHub or Bitbucket.</p>
</div>
<div class="paragraph">
<p>Be aware that the precise order of, say, methods in a class may differ
between your version and mine.  It may make diffs hard to read.</p>
</div>
</div>
<div class="sect2">
<h3 id="_downloading_a_zip_file_for_a_chapter">K.3. Downloading a ZIP File for a Chapter</h3>
<div class="paragraph">
<p>If, for whatever reason, you want to "start from scratch" for a chapter, or
skip ahead,<sup class="footnote">[<a id="_footnoteref_42" class="footnote" href="#_footnote_42" title="View footnote.">42</a>]</sup>
and/or you&#8217;re just not comfortable with Git, you can download a version of my
code as a ZIP file, from URLs following this pattern:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/hjwp/book-example/archive/chapter_01.zip" class="bare">https://github.com/hjwp/book-example/archive/chapter_01.zip</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/hjwp/book-example/archive/chapter_philosophy_and_refactoring.zip" class="bare">https://github.com/hjwp/book-example/archive/chapter_philosophy_and_refactoring.zip</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_don_t_let_it_become_a_crutch">K.4. Don&#8217;t Let it Become a Crutch!</h3>
<div class="paragraph">
<p>Try not to sneak a peek at the answers unless you&#8217;re really, really stuck.
Like I said at the beginning of the last chapter, there&#8217;s a lot of value in
debugging errors all by yourself, and in real life, there&#8217;s no "harrys repo" to
check against and find all the answers.</p>
</div>
</div>
</div>
</div>
<div class="sect1 bibliography">
<h2 id="_bibliography">Appendix L: Bibliography</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a id="dip"></a>[dip] Mark Pilgrim, <em>Dive Into Python</em>: <a href="http://www.diveintopython.net/" class="bare">http://www.diveintopython.net/</a></p>
</li>
<li>
<p><a id="lpthw"></a>[lpthw] Zed A. Shaw, <em>Learn Python the Hard Way</em>: <a href="http://learnpythonthehardway.org/" class="bare">http://learnpythonthehardway.org/</a></p>
</li>
<li>
<p><a id="iwp"></a>[iwp] Al Sweigart, <em>Invent Your Own Computer Games with Python</em>: <a href="http://inventwithpython.com" class="bare">http://inventwithpython.com</a></p>
</li>
<li>
<p><a id="tddbe"></a>[tddbe] Kent Beck, <em>Test Driven Development: By Example</em>, Addison-Wesley</p>
</li>
<li>
<p><a id="refactoring"></a>[refactoring] Martin Fowler, <em>Refactoring</em>, Addison-Wesley</p>
</li>
<li>
<p><a id="seceng"></a>[seceng] Ross Anderson, <em>Security Engineering, Second Edition</em>,
Addison-Wesley: <a href="http://www.cl.cam.ac.uk/~rja14/book.html" class="bare">http://www.cl.cam.ac.uk/~rja14/book.html</a></p>
</li>
<li>
<p><a id="jsgoodparts"></a>[jsgoodparts] Douglas Crockford,
<a href="http://oreil.ly/SuXjXq"><em>JavaScript: The Good Parts</em></a>, O&#8217;Reilly</p>
</li>
<li>
<p><a id="twoscoops"></a>[twoscoops] Daniel Greenfeld and Audrey Roy, <em>Two Scoops of Django</em>, <a href="http://twoscoopspress.com/products/two-scoops-of-django-1-6" class="bare">http://twoscoopspress.com/products/two-scoops-of-django-1-6</a></p>
</li>
<li>
<p><a id="mockfakestub"></a>[mockfakestub] Emily Bache, <em>Mocks, Fakes and Stubs</em>, <a href="https://leanpub.com/mocks-fakes-stubs" class="bare">https://leanpub.com/mocks-fakes-stubs</a></p>
</li>
<li>
<p><a id="GOOSGBT"></a>[GOOSGBT] Steve Freeman and Nat Pryce, <em>Growing
Object-Oriented Software Guided by Tests</em>, Addison-Wesley</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. I wouldn&#8217;t recommend installing Firefox via Homebrew     though: <code>brew</code> puts the Firefox binary in a strange location, and it     confuses Selenium. You can work around it, but it&#8217;s simpler to just install     Firefox in the normal way.
</div>
<div class="footnote" id="_footnote_2">
<a href="#_footnoteref_2">2</a>. The video has not been updated for the second edition, but the content is all mostly the same.
</div>
<div class="footnote" id="_footnote_3">
<a href="#_footnoteref_3">3</a>. Did vi pop up and you had no idea what to do? Or did you see a message about account identity and <code>git config --global
user.username</code>? Go and take another look at &#x201c;<a href="#pre-requisites">Prerequisites and Assumptions</a>&#x201d;; there are some brief instructions.
</div>
<div class="footnote" id="_footnote_4">
<a href="#_footnoteref_4">4</a>. The only exception is if you have an exception inside <code>setUp</code>, then <code>tearDown</code> doesn&#8217;t run.
</div>
<div class="footnote" id="_footnote_5">
<a href="#_footnoteref_5">5</a>. You could also just use the string <code>"\n"</code>, but <code>Keys</code> also lets you send special keys like Ctrl so I thought I&#8217;d show it.
</div>
<div class="footnote" id="_footnote_6">
<a href="#_footnoteref_6">6</a>. Some people like to use another subfolder named after the app (i.e., <em>lists/templates/lists</em>) and then refer to the template as <em>lists/home.html</em>.  This is called "template namespacing". I figured it was overcomplicated for this small project, but it may be worth it on larger projects.  There&#8217;s more in the <a href="https://docs.djangoproject.com/en/1.11/intro/tutorial03/#write-views-that-actually-do-something">Django tutorial</a>.
</div>
<div class="footnote" id="_footnote_7">
<a href="#_footnoteref_7">7</a>. Are you unable to move on because you&#8217;re wondering what those <em>ch04l0xx</em> things are, next to some of the code listings?  They refer to specific <a href="https://github.com/hjwp/book-example/commits/chapter_philosophy_and_refactoring">commits</a> in the book&#8217;s example repo.  It&#8217;s all to do with my book&#8217;s own <a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/tree/master/tests">tests</a>.  You know, the tests for the tests in the book about testing. They have tests of their own, naturally.
</div>
<div class="footnote" id="_footnote_8">
<a href="#_footnoteref_8">8</a>. Lots of people also swear by using <code>pdb.set_trace()</code> to be able to drop into a debugger, particularly for unit tests. I&#8217;m not enough of a pdb user to be able to give a good intro to it, but you should definitely check it out at some point in your testing career.
</div>
<div class="footnote" id="_footnote_9">
<a href="#_footnoteref_9">9</a>. If you&#8217;ve not come across the concept, a "code smell" is something about a piece of code that makes you want to rewrite it. Jeff Atwood has <a href="http://www.codinghorror.com/blog/2006/05/code-smells.html">a compilation on his blog Coding Horror</a>. The more experience you gain as a programmer, the more fine-tuned your nose becomes to code smells&#8230;&#8203;
</div>
<div class="footnote" id="_footnote_10">
<a href="#_footnoteref_10">10</a>. Are you wondering about when we&#8217;re going to run "migrate" as well as "makemigrations"?  Read on; that&#8217;s coming up later in the chapter.
</div>
<div class="footnote" id="_footnote_11">
<a href="#_footnoteref_11">11</a>. If you get a different error at this point, try restarting your dev server&#8212;&#8203;it may have gotten confused by the changes to the database happening under its feet.
</div>
<div class="footnote" id="_footnote_12">
<a href="#_footnoteref_12">12</a>. What? Delete the database?  Are you crazy?  Not completely.     The local dev database often gets out of sync with its migrations as we     go back and forth in our development, and it doesn&#8217;t have any important     data in it, so it&#8217;s OK to blow it away now and again.  We&#8217;ll be much more     careful once we have a "production" database on the server.  More on this     in <a href="#data-migrations-appendix">Testing Database Migrations</a>.
</div>
<div class="footnote" id="_footnote_13">
<a href="#_footnoteref_13">13</a>. On Windows, you may not have <code>wget</code> and <code>unzip</code>, but I&#8217;m sure you can figure out how to download Bootstrap, unzip it, and put the contents of the <em>dist</em> folder into the <em>lists/static/bootstrap</em> folder.
</div>
<div class="footnote" id="_footnote_14">
<a href="#_footnoteref_14">14</a>. Notice in the <code>os.path</code> wrangling of <code>BASE_DIR</code> that the <code>abspath</code> gets done first (i.e., innermost).  Always follow this pattern when chaining <code>os.path</code> operations, otherwise you can see unpredictable behaviours depending on how the file is imported.  Thanks to <a href="https://github.com/CleanCut/green">Green Nathan</a> for that tip!
</div>
<div class="footnote" id="_footnote_15">
<a href="#_footnoteref_15">15</a>. What I&#8217;m calling a "staging" server, some people would call a "development" server, and some others would also like to distinguish "preproduction" servers.  Whatever we call it, the point is to have somewhere we can try our code out in an environment that&#8217;s as similar as possible to the real production server.
</div>
<div class="footnote" id="_footnote_16">
<a href="#_footnoteref_16">16</a>. If you&#8217;re using Fedora/CentOS, you may run into an issue with private <em>tmp</em> directories. <a href="https://github.com/hjwp/Book-TDD-Web-Dev-Python/issues/93">more info here</a>
</div>
<div class="footnote" id="_footnote_17">
<a href="#_footnoteref_17">17</a>. Another common way of handling this is to have different versions of <em>settings.py</em> for dev and prod.  That can work fine too, but it can get confusing to manage.  Environment variables also have the advantage of working for non-Django stuff too&#8230;&#8203;
</div>
<div class="footnote" id="_footnote_18">
<a href="#_footnoteref_18">18</a>. If you&#8217;re wondering why we&#8217;re building up paths manually with f-strings instead of the <code>os.path.join</code> command we saw earlier, it&#8217;s because <code>path.join</code> will use backslashes if you run the script from Windows, but we definitely want forward slashes on the server. That&#8217;s a common gotcha!
</div>
<div class="footnote" id="_footnote_19">
<a href="#_footnoteref_19">19</a>. You may be wondering why we didn&#8217;t just use <code>run</code> to do the <code>cd</code>. It&#8217;s because Fabric doesn&#8217;t store any state from one command to the next&#8212;&#8203;each <code>run</code> command runs in a separate shell session on the server.
</div>
<div class="footnote" id="_footnote_20">
<a href="#_footnoteref_20">20</a>. You might have seen nerdy people using this strange s/change-this/to-this/ notation on the internet.  Now you know why!
</div>
<div class="footnote" id="_footnote_21">
<a href="#_footnoteref_21">21</a>. "Dunder" is shorthand for double-underscore, so "dunderinit" means <i>__init__.py</i>.
</div>
<div class="footnote" id="_footnote_22">
<a href="#_footnoteref_22">22</a>. If you really want a "clean" test run, you could add a     skip or an early return to the current FT, but you&#8217;d need to make sure you     didn&#8217;t accidentally forget it.
</div>
<div class="footnote" id="_footnote_23">
<a href="#_footnoteref_23">23</a>. This is a new feature in Django 1.11.
</div>
<div class="footnote" id="_footnote_24">
<a href="#_footnoteref_24">24</a>. You could also check out <code>assertSequenceEqual</code> from <code>unittest</code>, and <code>assertQuerysetEqual</code> from Django&#8217;s test tools, although I confess when I last looked at <code>assertQuerysetEqual</code> I was quite baffled&#8230;&#8203;
</div>
<div class="footnote" id="_footnote_25">
<a href="#_footnoteref_25">25</a>. It&#8217;s showing a server error, code 500.  Gotta get with the jargon!
</div>
<div class="footnote" id="_footnote_26">
<a href="#_footnoteref_26">26</a>. Admittedly once you start looking for Python BDD tools, things are a little more confusing.
</div>
<div class="footnote" id="_footnote_27">
<a href="#_footnoteref_27">27</a>. Purely because it features the <a href="https://mochajs.org/#nyan">NyanCat</a> test runner.
</div>
<div class="footnote" id="_footnote_28">
<a href="#_footnoteref_28">28</a>. Didn&#8217;t I just spend a whole intro banging on about the privacy implications of using Google for login, only to go on and use Gmail?  Yes, it&#8217;s a contradiction (honest, I will move off Gmail one day!). But in this case I&#8217;m just using it for testing,  and the important thing is that I&#8217;m not forcing Google on my users.
</div>
<div class="footnote" id="_footnote_29">
<a href="#_footnoteref_29">29</a>. A decision which you&#8217;ll find prominent Django maintainers saying they now regret.  Not everyone has a first name and a last name.
</div>
<div class="footnote" id="_footnote_30">
<a href="#_footnoteref_30">30</a>. You might ask, if I think Django is so silly, why don&#8217;t I submit a pull request to fix it?  Should be quite a simple fix.  Well, I promise I will, as soon as I&#8217;ve finished writing the book.  For now, snarky comments will have to suffice.
</div>
<div class="footnote" id="_footnote_31">
<a href="#_footnoteref_31">31</a>. Emails may not be the perfect primary key IRL. One reader, clearly deeply emotionally scarred, wrote me a tearful email about how much they&#8217;ve suffered for over a decade from trying to deal with the effects of email primary keys, due to their making multiuser account management impossible. So, as ever, YMMV.
</div>
<div class="footnote" id="_footnote_32">
<a href="#_footnoteref_32">32</a>. I&#8217;m using the generic term "mock", but testing enthusiasts like to distinguish other types of a general class of test tools called "Test Doubles", including spies, fakes, and stubs.  The differences don&#8217;t really matter for this book, but if you want to get into the nitty-gritty, check out this <a href="https://github.com/testdouble/contributing-tests/wiki/Test-Double">amazing wiki by Justin Searls</a>. Warning: absolutely chock full of great testing content.
</div>
<div class="footnote" id="_footnote_33">
<a href="#_footnoteref_33">33</a>. Yes, I know Django already mocks out emails using <code>mail.outbox</code> for us, but, again, let&#8217;s pretend it doesn&#8217;t. What if you were using Flask?  Or what if this was an API call, not an email?
</div>
<div class="footnote" id="_footnote_34">
<a href="#_footnoteref_34">34</a>. In Python 2, you can install it with <code>pip install mock</code>.
</div>
<div class="footnote" id="_footnote_35">
<a href="#_footnoteref_35">35</a>. I&#8217;ve split the form tag across three lines so it fits nicely in the book. If you&#8217;ve not seen it before, it may look a little weird to you, but it is valid HTML.  You don&#8217;t have to use it if you don&#8217;t like it though. :)
</div>
<div class="footnote" id="_footnote_36">
<a href="#_footnoteref_36">36</a>. It could easily just be a standalone function, but hanging it on the model class is a nice way to keep track of where it lives, and gives a bit more of a hint as to what it will do.
</div>
<div class="footnote" id="_footnote_37">
<a href="#_footnoteref_37">37</a>. Check out <a href="https://pypi.python.org/pypi/PyVirtualDisplay">pyvirtualdisplay</a> as a way of controlling virtual displays from Python.
</div>
<div class="footnote" id="_footnote_38">
<a href="#_footnoteref_38">38</a>. Make sure you get the latest version. On Ubuntu, use the PPA rather than the default package.
</div>
<div class="footnote" id="_footnote_39">
<a href="#_footnoteref_39">39</a>. See this reader&#8217;s <a href="https://blog.longearsfor.life/blog/2018/07/30/jenkins-and-github-integration-testinggoat-book/">blog post on the topic for example</a>
</div>
<div class="footnote" id="_footnote_40">
<a href="#_footnoteref_40">40</a>. You <em>could</em> run the Django dev server from a console instead, but the problem is that PythonAnywhere consoles don&#8217;t always run on the same server, so there&#8217;s no guarantee that the console you&#8217;re running your tests in is the same as the one you&#8217;re running the server in. Plus, when it&#8217;s running in the console, there&#8217;s no easy way of visually inspecting how the site looks.
</div>
<div class="footnote" id="_footnote_41">
<a href="#_footnoteref_41">41</a>. Put on your best cockney accent for this one.
</div>
<div class="footnote" id="_footnote_42">
<a href="#_footnoteref_42">42</a>. I don&#8217;t recommend skipping ahead. I haven&#8217;t designed the chapters to stand on their own; each relies on the previous ones, so it may be more confusing than anything else&#8230;&#8203;
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-11-14 11:35:22 CST
</div>
</div>
</body>
</html>